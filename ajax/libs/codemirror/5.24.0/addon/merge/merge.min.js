!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],e):e(CodeMirror)}(function(e){"use strict";function t(e,t){this.mv=e,this.type=t,this.classes="left"==t?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function r(t){t.diffOutOfDate&&(t.diff=F(t.orig.getValue(),t.edit.getValue()),t.chunks=M(t.diff),t.diffOutOfDate=!1,e.signal(t.edit,"updateDiff",t.diff))}function i(e){function t(t){Q=!0,u=!1,"full"==t&&(e.svg&&x(e.svg),e.copyButtons&&x(e.copyButtons),a(e.edit,h.marked,e.classes),a(e.orig,d.marked,e.classes),h.from=h.to=d.from=d.to=0),r(e),e.showDifferences&&(f(e.edit,e.diff,h,DIFF_INSERT,e.classes),f(e.orig,e.diff,d,DIFF_DELETE,e.classes)),"align"==e.mv.options.connect&&m(e),g(e),null!=e.needsScrollSync&&n(e,e.needsScrollSync),Q=!1}function i(t){Q||(e.dealigned=!0,o(t))}function o(e){Q||u||(clearTimeout(s),e===!0&&(u=!0),s=setTimeout(t,e===!0?20:250))}function l(t,r){e.diffOutOfDate||(e.diffOutOfDate=!0,h.from=h.to=d.from=d.to=0),i(r.text.length-1!=r.to.line-r.from.line)}function c(){e.diffOutOfDate=!0,t("full")}var s,h={from:0,to:0,marked:[]},d={from:0,to:0,marked:[]},u=!1;e.edit.on("change",l),e.orig.on("change",l),e.edit.on("swapDoc",c),e.orig.on("swapDoc",c);for(var v=["markerAdded","markerCleared","lineWidgetAdded","lineWidgetCleared"],p=0;p<v.length;p++)e.edit.on(v[p],i),e.orig.on(v[p],i);return e.edit.on("viewportChange",function(){o(!1)}),e.orig.on("viewportChange",function(){o(!1)}),t(),t}function o(e){e.edit.on("scroll",function(){n(e,!0)&&g(e)}),e.orig.on("scroll",function(){n(e,!1)&&g(e)})}function n(e,t){if(e.diffOutOfDate)return e.lockScroll&&null==e.needsScrollSync&&(e.needsScrollSync=t),!1;if(e.needsScrollSync=null,!e.lockScroll)return!0;var r,i,o=+new Date;if(t?(r=e.edit,i=e.orig):(r=e.orig,i=e.edit),r.state.scrollSetBy==e&&(r.state.scrollSetAt||0)+250>o)return!1;var n=r.getScrollInfo();if("align"==e.mv.options.connect)m=n.top;else{var c,s,a=.5*n.clientHeight,f=n.top+a,h=r.lineAtHeight(f,"local"),d=D(e.chunks,h,t),g=l(r,t?d.edit:d.orig),u=l(i,t?d.orig:d.edit),v=(f-g.top)/(g.bot-g.top),m=u.top-a+v*(u.bot-u.top);if(m>n.top&&(s=n.top/a)<1)m=m*s+n.top*(1-s);else if((c=n.height-n.clientHeight-n.top)<a){var p=i.getScrollInfo(),k=p.height-p.clientHeight-m;k>c&&(s=c/a)<1&&(m=m*s+(p.height-p.clientHeight-c)*(1-s))}}return i.scrollTo(n.left,m),i.state.scrollSetAt=o,i.state.scrollSetBy=e,!0}function l(e,t){var r=t.after;return null==r&&(r=e.lastLine()+1),{top:e.heightAtLine(t.before||0,"local"),bot:e.heightAtLine(r,"local")}}function c(e,t,r){e.lockScroll=t,t&&0!=r&&n(e,DIFF_INSERT)&&g(e),e.lockButton.innerHTML=t?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function s(e,t,r){for(var i=r.classLocation,o=0;o<i.length;o++)e.removeLineClass(t,i[o],r.chunk),e.removeLineClass(t,i[o],r.start),e.removeLineClass(t,i[o],r.end)}function a(t,r,i){for(var o=0;o<r.length;++o){var n=r[o];n instanceof e.TextMarker?n.clear():n.parent&&s(t,n,i)}r.length=0}function f(e,t,r,i,o){var n=e.getViewport();e.operation(function(){r.from==r.to||n.from-r.to>20||r.from-n.to>20?(a(e,r.marked,o),d(e,t,i,r.marked,n.from,n.to,o),r.from=n.from,r.to=n.to):(n.from<r.from&&(d(e,t,i,r.marked,n.from,r.from,o),r.from=n.from),n.to>r.to&&(d(e,t,i,r.marked,r.to,n.to,o),r.to=n.to))})}function h(e,t,r,i,o,n){for(var l=r.classLocation,c=e.getLineHandle(t),s=0;s<l.length;s++)i&&e.addLineClass(c,l[s],r.chunk),o&&e.addLineClass(c,l[s],r.start),n&&e.addLineClass(c,l[s],r.end);return c}function d(e,t,r,i,o,n,l){function c(t,r){for(var c=Math.max(o,t),s=Math.min(n,r),a=c;a<s;++a)i.push(h(e,a,l,!0,a==t,a==r-1));t==r&&c==r&&s==r&&(c?i.push(h(e,c-1,l,!1,!1,!0)):i.push(h(e,c,l,!1,!0,!1)))}for(var s=U(0,0),a=U(o,0),f=e.clipPos(U(n-1)),d=r==DIFF_DELETE?l.del:l.insert,g=0,u=!1,v=0;v<t.length;++v){var m=t[v],p=m[0],k=m[1];if(p==DIFF_EQUAL){var C=s.line+(L(t,v)?0:1);R(s,k);var T=s.line+(S(t,v)?1:0);T>C&&(u&&(c(g,C),u=!1),g=T)}else if(u=!0,p==r){var y=R(s,k,!0),w=_(a,s),F=V(f,y);H(w,F)||i.push(e.markText(w,F,{className:d})),s=y}}u&&c(g,s.line+1)}function g(e){if(e.showDifferences){if(e.svg){x(e.svg);var t=e.gap.offsetWidth;B(e.svg,"width",t,"height",e.gap.offsetHeight)}e.copyButtons&&x(e.copyButtons);for(var r=e.edit.getViewport(),i=e.orig.getViewport(),o=e.mv.wrap.getBoundingClientRect().top,n=o-e.edit.getScrollerElement().getBoundingClientRect().top+e.edit.getScrollInfo().top,l=o-e.orig.getScrollerElement().getBoundingClientRect().top+e.orig.getScrollInfo().top,c=0;c<e.chunks.length;c++){var s=e.chunks[c];s.editFrom<=r.to&&s.editTo>=r.from&&s.origFrom<=i.to&&s.origTo>=i.from&&C(e,s,l,n,t)}}}function u(e,t){for(var r=0,i=0,o=0;o<t.length;o++){var n=t[o];if(n.editTo>e&&n.editFrom<=e)return null;if(n.editFrom>e)break;r=n.editTo,i=n.origTo}return i+(e-r)}function v(e,t){for(var r=[],i=0;i<e.chunks.length;i++){var o=e.chunks[i];r.push([o.origTo,o.editTo,t?u(o.editTo,t.chunks):null])}if(t)e:for(var i=0;i<t.chunks.length;i++){for(var o=t.chunks[i],n=0;n<r.length;n++){var l=r[n][1]-o.editTo;if(0==l)continue e;if(l>0)break}r.splice(n,0,[u(o.editTo,e.chunks),o.editTo,o.origTo])}return r}function m(e,t){if(e.dealigned||t){if(!e.orig.curOp)return e.orig.operation(function(){m(e,t)});e.dealigned=!1;var i=e.mv.left==e?e.mv.right:e.mv.left;i&&(r(i),i.dealigned=!1);for(var o=v(e,i),n=e.mv.aligners,l=0;l<n.length;l++)n[l].clear();n.length=0;var c=[e.orig,e.edit],s=[];i&&c.push(i.orig);for(var l=0;l<c.length;l++)s.push(c[l].getScrollInfo().top);for(var a=0;a<o.length;a++)p(c,o[a],n);for(var l=0;l<c.length;l++)c[l].scrollTo(null,s[l])}}function p(e,t,r){for(var i=0,o=[],n=0;n<e.length;n++)if(null!=t[n]){var l=e[n].heightAtLine(t[n],"local");o[n]=l,i=Math.max(i,l)}for(var n=0;n<e.length;n++)if(null!=t[n]){var c=i-o[n];c>1&&r.push(k(e[n],t[n],c))}}function k(e,t,r){var i=!0;t>e.lastLine()&&(t--,i=!1);var o=document.createElement("div");return o.className="CodeMirror-merge-spacer",o.style.height=r+"px",o.style.minWidth="1px",e.addLineWidget(t,o,{height:r,above:i})}function C(e,t,r,i,o){var n="left"==e.type,l=e.orig.heightAtLine(t.origFrom,"local",!0)-r;if(e.svg){var c=l,s=e.edit.heightAtLine(t.editFrom,"local",!0)-i;if(n){var a=c;c=s,s=a}var f=e.orig.heightAtLine(t.origTo,"local",!0)-r,h=e.edit.heightAtLine(t.editTo,"local",!0)-i;if(n){var a=f;f=h,h=a}var d=" C "+o/2+" "+s+" "+o/2+" "+c+" "+(o+2)+" "+c,g=" C "+o/2+" "+f+" "+o/2+" "+h+" -1 "+h;B(e.svg.appendChild(document.createElementNS(z,"path")),"d","M -1 "+s+d+" L "+(o+2)+" "+f+g+" z","class",e.classes.connect)}if(e.copyButtons){var u=e.copyButtons.appendChild(I("div","left"==e.type?"⇝":"⇜","CodeMirror-merge-copy")),v=e.mv.options.allowEditingOriginals;if(u.title=v?"Push to left":"Revert chunk",u.chunk=t,u.style.top=(t.origTo>t.origFrom?l:e.edit.heightAtLine(t.editFrom,"local")-i)+"px",v){var m=e.edit.heightAtLine(t.editFrom,"local")-i,p=e.copyButtons.appendChild(I("div","right"==e.type?"⇝":"⇜","CodeMirror-merge-copy-reverse"));p.title="Push to right",p.chunk={editFrom:t.origFrom,editTo:t.origTo,origFrom:t.editFrom,origTo:t.editTo},p.style.top=m+"px","right"==e.type?p.style.left="2px":p.style.right="2px"}}}function T(e,t,r,i){if(!e.diffOutOfDate){var o=i.origTo>r.lastLine()?U(i.origFrom-1):U(i.origFrom,0),n=U(i.origTo,0),l=i.editTo>t.lastLine()?U(i.editFrom-1):U(i.editFrom,0),c=U(i.editTo,0),s=e.mv.options.revertChunk;s?s(e.mv,r,o,n,t,l,c):t.replaceRange(r.getRange(o,n),l,c)}}function y(t){var r=t.lockButton=I("div",null,"CodeMirror-merge-scrolllock");r.title="Toggle locked scrolling";var i=I("div",[r],"CodeMirror-merge-scrolllock-wrap");e.on(r,"click",function(){c(t,!t.lockScroll)});var o=[i];if(t.mv.options.revertButtons!==!1&&(t.copyButtons=I("div",null,"CodeMirror-merge-copybuttons-"+t.type),e.on(t.copyButtons,"click",function(e){var r=e.target||e.srcElement;if(r.chunk)return"CodeMirror-merge-copy-reverse"==r.className?void T(t,t.orig,t.edit,r.chunk):void T(t,t.edit,t.orig,r.chunk)}),o.unshift(t.copyButtons)),"align"!=t.mv.options.connect){var n=document.createElementNS&&document.createElementNS(z,"svg");n&&!n.createSVGRect&&(n=null),t.svg=n,n&&o.push(n)}return t.gap=I("div",o,"CodeMirror-merge-gap")}function w(e){return"string"==typeof e?e:e.getValue()}function F(e,t){for(var r=G.diff_main(e,t),i=0;i<r.length;++i){var o=r[i];o[1]?i&&r[i-1][0]==o[0]&&(r.splice(i--,1),r[i][1]+=o[1]):r.splice(i--,1)}return r}function M(e){for(var t=[],r=0,i=0,o=U(0,0),n=U(0,0),l=0;l<e.length;++l){var c=e[l],s=c[0];if(s==DIFF_EQUAL){var a=L(e,l)?0:1,f=o.line+a,h=n.line+a;R(o,c[1],null,n);var d=S(e,l)?1:0,g=o.line+d,u=n.line+d;g>f&&(l&&t.push({origFrom:i,origTo:h,editFrom:r,editTo:f}),r=g,i=u)}else R(s==DIFF_INSERT?o:n,c[1])}return(r<=o.line||i<=n.line)&&t.push({origFrom:i,origTo:n.line+1,editFrom:r,editTo:o.line+1}),t}function S(e,t){if(t==e.length-1)return!0;var r=e[t+1][1];return!(1==r.length&&t<e.length-2||10!=r.charCodeAt(0))&&(t==e.length-2||(r=e[t+2][1],(r.length>1||t==e.length-3)&&10==r.charCodeAt(0)))}function L(e,t){if(0==t)return!0;var r=e[t-1][1];return 10==r.charCodeAt(r.length-1)&&(1==t||(r=e[t-2][1],10==r.charCodeAt(r.length-1)))}function D(e,t,r){for(var i,o,n,l,c=0;c<e.length;c++){var s=e[c],a=r?s.editFrom:s.origFrom,f=r?s.editTo:s.origTo;null==o&&(a>t?(o=s.editFrom,l=s.origFrom):f>t&&(o=s.editTo,l=s.origTo)),f<=t?(i=s.editTo,n=s.origTo):a<=t&&(i=s.editFrom,n=s.origFrom)}return{edit:{before:i,after:o},orig:{before:n,after:l}}}function E(t,r,i){function o(){l.clear(),t.removeLineClass(r,"wrap","CodeMirror-merge-collapsed-line")}t.addLineClass(r,"wrap","CodeMirror-merge-collapsed-line");var n=document.createElement("span");n.className="CodeMirror-merge-collapsed-widget",n.title="Identical text collapsed. Click to expand.";var l=t.markText(U(r,0),U(i-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:n,clearOnEnter:!0});return e.on(n,"click",o),{mark:l,clear:o}}function O(e,t){function r(){for(var e=0;e<i.length;e++)i[e].clear()}for(var i=[],o=0;o<t.length;o++){var n=t[o],l=E(n.cm,n.line,n.line+e);i.push(l),l.mark.on("clear",r)}return i[0].mark}function b(e,t,r,i){for(var o=0;o<e.chunks.length;o++)for(var n=e.chunks[o],l=n.editFrom-t;l<n.editTo+t;l++){var c=l+r;c>=0&&c<i.length&&(i[c]=!1)}}function A(e,t){"number"!=typeof t&&(t=2);for(var r=[],i=e.editor(),o=i.firstLine(),n=o,l=i.lastLine();n<=l;n++)r.push(!0);e.left&&b(e.left,t,o,r),e.right&&b(e.right,t,o,r);for(var c=0;c<r.length;c++)if(r[c]){for(var s=c+o,a=1;c<r.length-1&&r[c+1];c++,a++);if(a>t){var f=[{line:s,cm:i}];e.left&&f.push({line:u(s,e.left.chunks),cm:e.left.orig}),e.right&&f.push({line:u(s,e.right.chunks),cm:e.right.orig});var h=O(a,f);e.options.onCollapse&&e.options.onCollapse(e,s,a,h)}}}function I(e,t,r,i){var o=document.createElement(e);if(r&&(o.className=r),i&&(o.style.cssText=i),"string"==typeof t)o.appendChild(document.createTextNode(t));else if(t)for(var n=0;n<t.length;++n)o.appendChild(t[n]);return o}function x(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild)}function B(e){for(var t=1;t<arguments.length;t+=2)e.setAttribute(arguments[t],arguments[t+1])}function N(e,t){t||(t={});for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function R(e,t,r,i){for(var o=r?U(e.line,e.ch):e,n=0;;){var l=t.indexOf("\n",n);if(l==-1)break;++o.line,i&&++i.line,n=l+1}return o.ch=(n?0:o.ch)+(t.length-n),i&&(i.ch=(n?0:i.ch)+(t.length-n)),o}function V(e,t){return(e.line-t.line||e.ch-t.ch)<0?e:t}function _(e,t){return(e.line-t.line||e.ch-t.ch)>0?e:t}function H(e,t){return e.line==t.line&&e.ch==t.ch}function P(e,t,r){for(var i=e.length-1;i>=0;i--){var o=e[i],n=(r?o.origTo:o.editTo)-1;if(n<t)return n}}function W(e,t,r){for(var i=0;i<e.length;i++){var o=e[i],n=r?o.origFrom:o.editFrom;if(n>t)return n}}function j(t,i){var o=null,n=t.state.diffViews,l=t.getCursor().line;if(n)for(var c=0;c<n.length;c++){var s=n[c],a=t==s.orig;r(s);var f=i<0?P(s.chunks,l,a):W(s.chunks,l,a);null==f||null!=o&&!(i<0?f>o:f<o)||(o=f)}return null==o?e.Pass:void t.setCursor(o,0)}var U=e.Pos,z="http://www.w3.org/2000/svg";t.prototype={constructor:t,init:function(t,r,i){this.edit=this.mv.edit,(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this),this.orig=e(t,N({value:r,readOnly:!this.mv.options.allowEditingOriginals},N(i))),this.orig.state.diffViews=[this];var o=i.chunkClassLocation||"background";"[object Array]"!=Object.prototype.toString.call(o)&&(o=[o]),this.classes.classLocation=o,this.diff=F(w(r),w(i.value)),this.chunks=M(this.diff),this.diffOutOfDate=this.dealigned=!1,this.needsScrollSync=null,this.showDifferences=i.showDifferences!==!1},registerEvents:function(){this.forceUpdate=i(this),c(this,!0,!1),o(this)},setShowDifferences:function(e){e=e!==!1,e!=this.showDifferences&&(this.showDifferences=e,this.forceUpdate("full"))}};var Q=!1,q=e.MergeView=function(r,i){if(!(this instanceof q))return new q(r,i);this.options=i;var o=i.origLeft,n=null==i.origRight?i.orig:i.origRight,l=null!=o,c=null!=n,s=1+(l?1:0)+(c?1:0),a=[],f=this.left=null,h=this.right=null,d=this;if(l){f=this.left=new t(this,"left");var u=I("div",null,"CodeMirror-merge-pane CodeMirror-merge-left");a.push(u),a.push(y(f))}var v=I("div",null,"CodeMirror-merge-pane CodeMirror-merge-editor");if(a.push(v),c){h=this.right=new t(this,"right"),a.push(y(h));var p=I("div",null,"CodeMirror-merge-pane CodeMirror-merge-right");a.push(p)}(c?p:v).className+=" CodeMirror-merge-pane-rightmost",a.push(I("div",null,null,"height: 0; clear: both;"));var k=this.wrap=r.appendChild(I("div",a,"CodeMirror-merge CodeMirror-merge-"+s+"pane"));this.edit=e(v,N(i)),f&&f.init(u,o,i),h&&h.init(p,n,i),i.collapseIdentical&&this.editor().operation(function(){A(d,i.collapseIdentical)}),"align"==i.connect&&(this.aligners=[],m(this.left||this.right,!0)),f&&f.registerEvents(),h&&h.registerEvents();var C=function(){f&&g(f),h&&g(h)};e.on(window,"resize",C);var T=setInterval(function(){for(var t=k.parentNode;t&&t!=document.body;t=t.parentNode);t||(clearInterval(T),e.off(window,"resize",C))},5e3)};q.prototype={constructor:q,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(e){this.right&&this.right.setShowDifferences(e),this.left&&this.left.setShowDifferences(e)},rightChunks:function(){if(this.right)return r(this.right),this.right.chunks},leftChunks:function(){if(this.left)return r(this.left),this.left.chunks}};var G=new diff_match_patch;e.commands.goNextDiff=function(e){return j(e,1)},e.commands.goPrevDiff=function(e){return j(e,-1)}});
//# sourceMappingURL=merge.min.js.map