(function(){var t,e,n,r,o,i,l,s,u=[].slice,a={}.hasOwnProperty,c=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};t={},o=function(){var t,e,n,r,o,i,l;if(t=arguments[0],n=2<=arguments.length?u.call(arguments,1):[])for(i=0,l=n.length;i<l;i++)if(r=n[i])for(e in r)a.call(r,e)&&(o=r[e],t[e]=o);return t},t.DefaultQueryBuilderOptions={autoQuoteTableNames:!1,autoQuoteFieldNames:!1,autoQuoteAliasNames:!0,nameQuoteCharacter:"`",tableAliasQuoteCharacter:"`",fieldAliasQuoteCharacter:'"',usingValuePlaceholders:!1,valueHandlers:[]},t.globalValueHandlers=[],n=function(t,e,n){var r,o,i;if("function"!=typeof e)throw new Error("type must be a class constructor");if("function"!=typeof n)throw new Error("handler must be a function");for(o=0,i=t.length;o<i;o++)if(r=t[o],r.type===e)return void(r.handler=n);return t.push({type:e,handler:n})},e=function(){var t,e,n,r,o,i,l,s;for(r=arguments[0],t=2<=arguments.length?u.call(arguments,1):[],o=0,l=t.length;o<l;o++)for(e=t[o],i=0,s=e.length;i<s;i++)if(n=e[i],r instanceof n.type)return n.handler},t.registerValueHandler=function(e,r){return n(t.globalValueHandlers,e,r)},t.Cloneable=function(){function t(){}return t.prototype.clone=function(){var t;return t=new this.constructor,o(t,JSON.parse(JSON.stringify(this)))},t}(),t.BaseBuilder=function(r){function i(e){var n;n=JSON.parse(JSON.stringify(t.DefaultQueryBuilderOptions)),this.options=o({},n,e)}return c(i,r),i.prototype.registerValueHandler=function(t,e){return n(this.options.valueHandlers,t,e),this},i.prototype._getObjectClassName=function(t){var e;if(t&&t.constructor&&t.constructor.toString&&(e=t.constructor.toString().match(/function\s*(\w+)/),e&&2===e.length))return e[1]},i.prototype._sanitizeCondition=function(e){if(e instanceof t.Expression&&(e=e.toString()),"string"!=typeof e)throw new Error("condition must be a string or Expression instance");return e},i.prototype._sanitizeName=function(t,e){if("string"!=typeof t)throw new Error(""+e+" must be a string");return t},i.prototype._sanitizeField=function(t){var e;return e=this._sanitizeName(t,"field name"),this.options.autoQuoteFieldNames?""+this.options.nameQuoteCharacter+e+this.options.nameQuoteCharacter:e},i.prototype._sanitizeTable=function(e,n){var r;if(null==n&&(n=!1),n){if("string"!=typeof e){if(e instanceof t.QueryBuilder&&e.isNestable())return e;throw new Error("table name must be a string or a nestable query instance")}r=e}else r=this._sanitizeName(e,"table name");return this.options.autoQuoteTableNames?""+this.options.nameQuoteCharacter+r+this.options.nameQuoteCharacter:r},i.prototype._sanitizeTableAlias=function(t){var e;return e=this._sanitizeName(t,"table alias"),this.options.autoQuoteAliasNames?""+this.options.tableAliasQuoteCharacter+e+this.options.tableAliasQuoteCharacter:e},i.prototype._sanitizeFieldAlias=function(t){var e;return e=this._sanitizeName(t,"field alias"),this.options.autoQuoteAliasNames?""+this.options.fieldAliasQuoteCharacter+e+this.options.fieldAliasQuoteCharacter:e},i.prototype._sanitizeLimitOffset=function(t){if(t=parseInt(t),0>t||isNaN(t))throw new Error("limit/offset must be >= 0");return t},i.prototype._sanitizeValue=function(n){var r,o;if(r=typeof n,null===n);else if("string"===r||"number"===r||"boolean"===r);else if(o=void 0!==e(n,this.options.valueHandlers,t.globalValueHandlers),!o)throw new Error("field value must be a string, number, boolean, null or one of the registered custom value types");return n},i.prototype._formatValue=function(n){var r;return r=e(n,this.options.valueHandlers,t.globalValueHandlers),r&&(n=r(n)),null===n?n="NULL":"boolean"==typeof n?n=n?"TRUE":"FALSE":"number"!=typeof n&&!1===this.options.usingValuePlaceholders&&(n="'"+n+"'"),n},i}(t.Cloneable),t.Expression=function(t){function e(){var t=this;this.tree={parent:null,nodes:[]},this.current=this.tree,this._begin=function(e){var n;return n={type:e,parent:t.current,nodes:[]},t.current.nodes.push(n),t.current=t.current.nodes[t.current.nodes.length-1],t}}var n;return c(e,t),e.prototype.tree=null,e.prototype.current=null,e.prototype.and_begin=function(){return this._begin("AND")},e.prototype.or_begin=function(){return this._begin("OR")},e.prototype.end=function(){if(!this.current.parent)throw new Error("begin() needs to be called");return this.current=this.current.parent,this},e.prototype.and=function(t){if(!t||"string"!=typeof t)throw new Error("expr must be a string");return this.current.nodes.push({type:"AND",expr:t}),this},e.prototype.or=function(t){if(!t||"string"!=typeof t)throw new Error("expr must be a string");return this.current.nodes.push({type:"OR",expr:t}),this},e.prototype.toString=function(){if(null!==this.current.parent)throw new Error("end() needs to be called");return n(this.tree)},n=function(t){var e,r,o,i,l,s;for(o="",s=t.nodes,i=0,l=s.length;i<l;i++)e=s[i],null!=e.expr?r=e.expr:(r=n(e),""!==r&&(r="("+r+")")),""!==r&&(""!==o&&(o+=" "+e.type+" "),o+=r);return o},e.prototype.clone=function(){var t,e;return t=new this.constructor,(e=function(n){var r,o,i,l,s;for(l=n.nodes,s=[],o=0,i=l.length;o<i;o++)r=l[o],null!=r.expr?s.push(t.current.nodes.push(JSON.parse(JSON.stringify(r)))):(t._begin(r.type),e(r),!this.current===r?s.push(t.end()):s.push(void 0));return s})(this.tree),t},e}(t.Cloneable),t.Block=function(e){function n(){return i=n.__super__.constructor.apply(this,arguments)}return c(n,e),n.prototype.exposedMethods=function(){var e,n,r;n={};for(e in this)r=this[e],"function"!=typeof r||"_"===e.charAt(0)||t.Block.prototype[e]||(n[e]=r);return n},n.prototype.buildStr=function(t){return""},n}(t.BaseBuilder),t.StringBlock=function(t){function e(t,n){e.__super__.constructor.call(this,t),this.str=n}return c(e,t),e.prototype.buildStr=function(t){return this.str},e}(t.Block),t.AbstractTableBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.tables=[]}return c(e,t),e.prototype._table=function(t,e){return null==e&&(e=null),e&&(e=this._sanitizeTableAlias(e)),t=this._sanitizeTable(t,this.options.allowNested||!1),this.options.singleTable&&(this.tables=[]),this.tables.push({table:t,alias:e})},e.prototype.buildStr=function(t){var e,n,r,o,i;if(0>=this.tables.length)throw new Error("_table() needs to be called");for(n="",i=this.tables,r=0,o=i.length;r<o;r++)e=i[r],""!==n&&(n+=", "),n+="string"==typeof e.table?e.table:"("+e.table+")",e.alias&&(n+=" "+e.alias);return n},e}(t.Block),t.UpdateTableBlock=function(t){function e(){return l=e.__super__.constructor.apply(this,arguments)}return c(e,t),e.prototype.table=function(t,e){return null==e&&(e=null),this._table(t,e)},e}(t.AbstractTableBlock),t.FromTableBlock=function(t){function e(){return s=e.__super__.constructor.apply(this,arguments)}return c(e,t),e.prototype.from=function(t,e){return null==e&&(e=null),this._table(t,e)},e.prototype.buildStr=function(t){var n;if(0>=this.tables.length)throw new Error("from() needs to be called");return n=e.__super__.buildStr.call(this,t),"FROM "+n},e}(t.AbstractTableBlock),t.IntoTableBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.table=null}return c(e,t),e.prototype.into=function(t){return this.table=this._sanitizeTable(t,!1)},e.prototype.buildStr=function(t){if(!this.table)throw new Error("into() needs to be called");return"INTO "+this.table},e}(t.Block),t.GetFieldBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this._fields=[]}return c(e,t),e.prototype.fields=function(t){var e,n,r;r=[];for(n in t)e=t[n],r.push(this.field(n,e));return r},e.prototype.field=function(t,e){return null==e&&(e=null),t=this._sanitizeField(t),e&&(e=this._sanitizeFieldAlias(e)),this._fields.push({name:t,alias:e})},e.prototype.buildStr=function(t){var e,n,r,o,i;for(n="",i=this._fields,r=0,o=i.length;r<o;r++)e=i[r],""!==n&&(n+=", "),n+=e.name,e.alias&&(n+=" AS "+e.alias);return""===n?"*":n},e}(t.Block),t.SetFieldBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.fields={}}return c(e,t),e.prototype.set=function(t,e){return t=this._sanitizeField(t),e=this._sanitizeValue(e),this.fields[t]=e,this},e.prototype.buildStr=function(t){var e,n,r,o,i;if(n=function(){var t,n;t=this.fields,n=[];for(e in t)a.call(t,e)&&n.push(e);return n}.call(this),0>=n.length)throw new Error("set() needs to be called");for(r="",o=0,i=n.length;o<i;o++)e=n[o],""!==r&&(r+=", "),r+=""+e+" = "+this._formatValue(this.fields[e]);return"SET "+r},e}(t.Block),t.InsertFieldValueBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.fields={}}return c(e,t),e.prototype.buildStr=function(t){var e,n,r,o,i,l,s;if(n=function(){var t,e;t=this.fields,e=[];for(o in t)a.call(t,o)&&e.push(o);return e}.call(this),0>=n.length)throw new Error("set() needs to be called");for(r="",i="",l=0,s=n.length;l<s;l++)e=n[l],""!==r&&(r+=", "),r+=e,""!==i&&(i+=", "),i+=this._formatValue(this.fields[e]);return"("+r+") VALUES ("+i+")"},e}(t.SetFieldBlock),t.DistinctBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.useDistinct=!1}return c(e,t),e.prototype.distinct=function(){return this.useDistinct=!0},e.prototype.buildStr=function(t){return this.useDistinct?"DISTINCT":""},e}(t.Block),t.GroupByBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.groups=[]}return c(e,t),e.prototype.group=function(t){return t=this._sanitizeField(t),this.groups.push(t)},e.prototype.buildStr=function(t){var e,n,r,o,i;if(n="",0<this.groups.length){for(i=this.groups,r=0,o=i.length;r<o;r++)e=i[r],""!==n&&(n+=", "),n+=e;n="GROUP BY "+n}return n},e}(t.Block),t.OffsetBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.offsets=null}return c(e,t),e.prototype.offset=function(t){return t=this._sanitizeLimitOffset(t),this.offsets=t},e.prototype.buildStr=function(t){return this.offsets?"OFFSET "+this.offsets:""},e}(t.Block),t.WhereBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.wheres=[]}return c(e,t),e.prototype.where=function(){var t,e,n,r,o,i,l,s,a;for(t=arguments[0],o=2<=arguments.length?u.call(arguments,1):[],t=this._sanitizeCondition(t),i=0,s=o.length;i<s;i++){if(r=o[i],Array.isArray(r)){for(e=[],l=0,a=r.length;l<a;l++)n=r[l],e.push(this._formatValue(this._sanitizeValue(n)));r="("+e.join(", ")+")"}else r=this._formatValue(this._sanitizeValue(r));t=t.replace("?",r)}if(""!==t)return this.wheres.push(t)},e.prototype.buildStr=function(t){return 0<this.wheres.length?"WHERE ("+this.wheres.join(") AND (")+")":""},e}(t.Block),t.OrderByBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.orders=[]}return c(e,t),e.prototype.order=function(t,e){return null==e&&(e=!0),t=this._sanitizeField(t),this.orders.push({field:t,dir:!!e})},e.prototype.buildStr=function(t){var e,n,r,o,i;if(0<this.orders.length){for(n="",i=this.orders,r=0,o=i.length;r<o;r++)e=i[r],""!==n&&(n+=", "),n+=""+e.field+" "+(e.dir?"ASC":"DESC");return"ORDER BY "+n}return""},e}(t.Block),t.LimitBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.limits=null}return c(e,t),e.prototype.limit=function(t){return t=this._sanitizeLimitOffset(t),this.limits=t},e.prototype.buildStr=function(t){return this.limits?"LIMIT "+this.limits:""},e}(t.Block),t.JoinBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this.joins=[]}return c(e,t),e.prototype.join=function(t,e,n,r){return null==e&&(e=null),null==n&&(n=null),null==r&&(r="INNER"),t=this._sanitizeTable(t,!0),e&&(e=this._sanitizeTableAlias(e)),n&&(n=this._sanitizeCondition(n)),this.joins.push({type:r,table:t,alias:e,condition:n}),this},e.prototype.left_join=function(t,e,n){return null==e&&(e=null),null==n&&(n=null),this.join(t,e,n,"LEFT")},e.prototype.right_join=function(t,e,n){return null==e&&(e=null),null==n&&(n=null),this.join(t,e,n,"RIGHT")},e.prototype.outer_join=function(t,e,n){return null==e&&(e=null),null==n&&(n=null),this.join(t,e,n,"OUTER")},e.prototype.buildStr=function(t){var e,n,r,o,i;for(n="",i=this.joins||[],r=0,o=i.length;r<o;r++)e=i[r],""!==n&&(n+=" "),n+=""+e.type+" JOIN ",n+="string"==typeof e.table?e.table:"("+e.table+")",e.alias&&(n+=" "+e.alias),e.condition&&(n+=" ON ("+e.condition+")");return n},e}(t.Block),t.QueryBuilder=function(t){function e(t,n){var r,o,i,l,s,u,a,c,f=this;for(e.__super__.constructor.call(this,t),this.blocks=n||[],a=this.blocks,s=0,u=a.length;s<u;s++){r=a[s],c=r.exposedMethods(),l=function(t,e,n){return f[e]=function(){return n.apply(t,arguments),f}};for(i in c){if(o=c[i],null!=this[i])throw new Error(""+this._getObjectClassName(this)+" already has a builder method called: "+i);l(r,i,o)}}}return c(e,t),e.prototype.registerValueHandler=function(t,n){var r,o,i,l;for(l=this.blocks,o=0,i=l.length;o<i;o++)r=l[o],r.registerValueHandler(t,n);return e.__super__.registerValueHandler.call(this,t,n),this},e.prototype.updateOptions=function(t){var e,n,r,i,l;for(this.options=o({},this.options,t),i=this.blocks,l=[],n=0,r=i.length;n<r;n++)e=i[n],l.push(e.options=o({},e.options,t));return l},e.prototype.toString=function(){var t;return function(){var e,n,r,o;for(r=this.blocks,o=[],e=0,n=r.length;e<n;e++)t=r[e],o.push(t.buildStr(this));return o}.call(this).filter(function(t){return 0<t.length}).join(" ")},e.prototype.clone=function(){var t;return new this.constructor(this.options,function(){var e,n,r,o;for(r=this.blocks,o=[],e=0,n=r.length;e<n;e++)t=r[e],o.push(t.clone());return o}.call(this))},e.prototype.isNestable=function(){return!1},e}(t.BaseBuilder),t.Select=function(e){function n(e,r){null==r&&(r=null),r||(r=[new t.StringBlock(e,"SELECT"),new t.DistinctBlock(e),new t.GetFieldBlock(e),new t.FromTableBlock(o({},e,{allowNested:!0})),new t.JoinBlock(o({},e,{allowNested:!0})),new t.WhereBlock(e),new t.GroupByBlock(e),new t.OrderByBlock(e),new t.LimitBlock(e),new t.OffsetBlock(e)]),n.__super__.constructor.call(this,e,r)}return c(n,e),n.prototype.isNestable=function(){return!0},n}(t.QueryBuilder),t.Update=function(e){function n(e,r){null==r&&(r=null),r||(r=[new t.StringBlock(e,"UPDATE"),new t.UpdateTableBlock(e),new t.SetFieldBlock(e),new t.WhereBlock(e),new t.OrderByBlock(e),new t.LimitBlock(e)]),n.__super__.constructor.call(this,e,r)}return c(n,e),n}(t.QueryBuilder),t.Delete=function(e){function n(e,r){null==r&&(r=null),r||(r=[new t.StringBlock(e,"DELETE"),new t.FromTableBlock(o({},e,{singleTable:!0})),new t.JoinBlock(e),new t.WhereBlock(e),new t.OrderByBlock(e),new t.LimitBlock(e)]),n.__super__.constructor.call(this,e,r)}return c(n,e),n}(t.QueryBuilder),t.Insert=function(e){function n(e,r){null==r&&(r=null),r||(r=[new t.StringBlock(e,"INSERT"),new t.IntoTableBlock(e),new t.InsertFieldValueBlock(e)]),n.__super__.constructor.call(this,e,r)}return c(n,e),n}(t.QueryBuilder),r={expr:function(){return new t.Expression},select:function(e,n){return new t.Select(e,n)},update:function(e,n){return new t.Update(e,n)},insert:function(e,n){return new t.Insert(e,n)},delete:function(e,n){return new t.Delete(e,n)},registerValueHandler:t.registerValueHandler},r.remove=r.delete,r.cls=t,("undefined"!=typeof define&&null!==define?define.amd:void 0)?define(function(){return r}):("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=r:"undefined"!=typeof window&&null!==window&&(window.squel=r),r.flavours={},r.useFlavour=function(t){if(!(r.flavours[t]instanceof Function))throw new Error("Flavour not available: "+t);return r.flavours[t].call(null,r),r},r.flavours.postgres=function(){return t=r.cls,t.ReturningBlock=function(t){function e(t){e.__super__.constructor.call(this,t),this._str=null}return c(e,t),e.prototype.returning=function(t){return this._str=this._sanitizeField(t)},e.prototype.buildStr=function(){return this._str?"RETURNING "+this._str:""},e}(t.Block),t.Insert=function(e){function n(e,r){null==r&&(r=null),r||(r=[new t.StringBlock(e,"INSERT"),new t.IntoTableBlock(e),new t.InsertFieldValueBlock(e),new t.ReturningBlock(e)]),n.__super__.constructor.call(this,e,r)}return c(n,e),n}(t.QueryBuilder)}}).call(this);