"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),i=n.length>>>0,r=arguments[1],o=0;o<i;o++)if(t=n[o],e.call(r,t,o,n))return t}),!function(){var e=function(){function e(o){var u=this,l=o.values,a=void 0===l?null:l,s=o.iframe,c=void 0===s?null:s,d=o.selectClass,h=void 0===d?"highlight":d,f=o.trigger,v=void 0===f?"@":f,g=o.selectTemplate,m=void 0===g?null:g,p=o.menuItemTemplate,b=void 0===p?null:p,y=o.lookup,k=void 0===y?"key":y,w=o.fillAttr,C=void 0===w?"value":w,T=o.collection,E=void 0===T?null:T,S=o.menuContainer,x=void 0===S?null:S;if(_classCallCheck(this,e),this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=x,a)this.collection=[{trigger:v,iframe:c,selectClass:h,selectTemplate:(m||e.defaultSelectTemplate).bind(this),menuItemTemplate:(b||e.defaultMenuItemTemplate).bind(this),lookup:k,fillAttr:C,values:a}];else{if(!E)throw new Error("[Tribute] No collection specified.");this.collection=E.map(function(t){return{trigger:t.trigger||v,iframe:t.iframe||c,selectClass:t.selectClass||h,selectTemplate:(t.selectTemplate||e.defaultSelectTemplate).bind(u),menuItemTemplate:(t.menuItemTemplate||e.defaultMenuItemTemplate).bind(u),lookup:t.lookup||k,fillAttr:t.fillAttr||C,values:t.values}})}new i(this),new n(this),new t(this),new r(this)}return _createClass(e,[{key:"triggers",value:function(){return this.collection.map(function(e){return e.trigger})}},{key:"attach",value:function(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&e instanceof jQuery&&(e=e.get()),e.constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array)for(var t=e.length,n=0;n<t;++n)this._attach(e[n]);else this._attach(e)}},{key:"_attach",value:function(e){e.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+e.nodeName),this.ensureEditable(e),this.events.bind(e),e.setAttribute("data-tribute",!0)}},{key:"ensureEditable",value:function(t){if(e.inputTypes().indexOf(t.nodeName)===-1){if(!t.contentEditable)throw new Error("[Tribute] Cannot bind to "+t.nodeName);t.contentEditable=!0}}},{key:"createMenu",value:function(){var e=this.range.getDocument().createElement("div"),t=this.range.getDocument().createElement("ul");return e.className="tribute-container",e.appendChild(t),this.menuContainer?this.menuContainer.appendChild(e):this.range.getDocument().body.appendChild(e)}},{key:"showMenuFor",value:function(e,t){var n=this,i=void 0;if(this.menu||(this.menu=this.createMenu(),this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText=""),i=this.search.filter(this.current.mentionText,this.current.collection.values,{pre:"<span>",post:"</span>",extract:function(e){return e[n.current.collection.lookup]}}),this.current.filteredItems=i,!i.length)return void this.hideMenu();var r=this.menu.querySelector("ul");r.innerHTML="",i.forEach(function(e,t){var i=n.range.getDocument().createElement("li");i.setAttribute("data-index",t),n.menuSelected===t&&(i.className=n.current.collection.selectClass),i.innerHTML=n.current.collection.menuItemTemplate(e),r.appendChild(i)}),this.range.positionMenuAtCaret()}},{key:"hideMenu",value:function(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}},{key:"selectItemAtIndex",value:function(e){var t=this.current.filteredItems[e],n=this.current.collection.selectTemplate(t);this.replaceText(n)}},{key:"replaceText",value:function(e){this.range.replaceTriggerText(e,!0,!0)}}],[{key:"defaultSelectTemplate",value:function(e){return"@"+e.original[this.current.collection.fillAttr]}},{key:"defaultMenuItemTemplate",value:function(e){return e.string}},{key:"inputTypes",value:function(){return["TEXTAREA","INPUT"]}}]),e}(),t=function(){function e(t){_classCallCheck(this,e),this.tribute=t,this.tribute.menuEvents=this,this.menu=this.tribute.menu}return _createClass(e,[{key:"bind",value:function(e){var t=this;e.addEventListener("keydown",this.tribute.events.keydown.bind(this.menu,this),!1),this.tribute.range.getDocument().addEventListener("click",this.tribute.events.click.bind(null,this),!1),window.addEventListener("resize",this.debounce(function(){t.tribute.isActive&&t.tribute.showMenuFor(t.tribute.current.element)},300,!1))}},{key:"debounce",value:function(e,t,n){var i,r=this,o=arguments;return function(){var u=r,l=o,a=function(){i=null,n||e.apply(u,l)},s=n&&!i;clearTimeout(i),i=setTimeout(a,t),s&&e.apply(u,l)}}}]),e}(),n=function(){function e(t){_classCallCheck(this,e),this.tribute=t,this.tribute.events=this}return _createClass(e,[{key:"bind",value:function(e){e.addEventListener("keydown",this.keydown.bind(e,this),!1),e.addEventListener("keyup",this.keyup.bind(e,this),!1),e.addEventListener("input",this.input.bind(e,this),!1)}},{key:"keydown",value:function(t,n){t.shouldDeactivate(n)&&(t.tribute.isActive=!1);var i=this;t.commandEvent=!1,e.keys().forEach(function(e){e.key===n.keyCode&&(t.commandEvent=!0,t.callbacks()[e.value.toLowerCase()](n,i))})}},{key:"input",value:function(e,t){e.inputEvent=!0,e.keyup.call(this,e,t)}},{key:"click",value:function(e,t){var n=e.tribute;if(n.menu&&n.menu.contains(t.target)){var i=t.target;n.selectItemAtIndex(i.getAttribute("data-index")),n.hideMenu()}else n.current.element&&n.hideMenu()}},{key:"keyup",value:function(e,t){var n=this;if(e.inputEvent&&(e.inputEvent=!1),e.updateSelection(this),27!==t.keyCode){if(!e.tribute.isActive){var i=function(){var i=e.getKeyCode(e,n,t);if(isNaN(i))return{v:void 0};var r=e.tribute.triggers().find(function(e){return e.charCodeAt(0)===i});"undefined"!=typeof r&&e.callbacks().triggerChar(t,n,r)}();if("object"===("undefined"==typeof i?"undefined":_typeof(i)))return i.v}e.tribute.current.trigger&&e.commandEvent===!1&&e.tribute.showMenuFor(this)}}},{key:"shouldDeactivate",value:function(t){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){var n=!1;return e.keys().forEach(function(e){t.keyCode===e.key&&(n=!0)}),!n}return!1}},{key:"getKeyCode",value:function(e,t,n){var i=e.tribute,r=i.range.getTriggerInfo(!1,!1,!0);return!!r&&r.mentionTriggerChar.charCodeAt(0)}},{key:"updateSelection",value:function(e){this.tribute.current.element=e;var t=this.tribute.range.getTriggerInfo(!1,!1,!0);t&&(this.tribute.current.selectedPath=t.mentionSelectedPath,this.tribute.current.mentionText=t.mentionText,this.tribute.current.selectedOffset=t.mentionSelectedOffset)}},{key:"callbacks",value:function(){var e=this;return{triggerChar:function(t,n,i){var r=e.tribute;r.current.trigger=i;var o=r.collection.find(function(e){return e.trigger===i});r.current.collection=o,r.showMenuFor(n)},enter:function(t,n){e.tribute.isActive&&(t.preventDefault(),setTimeout(function(){e.tribute.selectItemAtIndex(e.tribute.menuSelected),e.tribute.hideMenu()},0))},escape:function(t,n){e.tribute.isActive&&(t.preventDefault(),e.tribute.hideMenu())},tab:function(t,n){e.callbacks().enter(t,n)},up:function(t,n){if(e.tribute.isActive){t.preventDefault();var i=e.tribute.current.filteredItems.length,r=e.tribute.menuSelected;i>r&&r>0&&(e.tribute.menuSelected--,e.setActiveLi())}},down:function(t,n){if(e.tribute.isActive){t.preventDefault();var i=e.tribute.current.filteredItems.length-1,r=e.tribute.menuSelected;i>r&&(e.tribute.menuSelected++,e.setActiveLi())}}}}},{key:"setActiveLi",value:function(e){for(var t=this.tribute.menu.querySelectorAll("li"),n=t.length>>>0,i=0;i<n;i++){var r=t[i];i===this.tribute.menuSelected?r.className=this.tribute.current.collection.selectClass:r.className=""}}}],[{key:"keys",value:function(){return[{key:9,value:"TAB"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}}]),e}(),i=function(){function e(t){_classCallCheck(this,e),this.tribute=t,this.tribute.range=this}return _createClass(e,[{key:"getDocument",value:function(){var e=void 0;return this.tribute.current.collection&&(e=this.tribute.current.collection.iframe),e?e.contentWindow.document:document}},{key:"positionMenuAtCaret",value:function(){var e=this,t=this.tribute.current,n=void 0,i=this.getTriggerInfo(!1,!1,!0);void 0!==i?(n=this.isContentEditable(t.element)?this.getContentEditableCaretPosition(i.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.getDocument().activeElement,i.mentionPosition),this.tribute.menu.style.cssText="top: "+n.top+"px;\n                                           left: "+n.left+"px;\n                                           position: absolute;\n                                           zIndex: 10000;\n                                           display: block;",setTimeout(function(){e.scrollIntoView(e.getDocument().activeElement)},0)):this.tribute.menu.style.cssText="display: none"}},{key:"selectElement",value:function(e,t,n){var i=void 0,r=e;if(t)for(var o=0;o<t.length;o++){if(r=r.childNodes[t[o]],void 0===r)return;for(;r.length<n;)n-=r.length,r=r.nextSibling;0!==r.childNodes.length||r.length||(r=r.previousSibling)}var u=this.getWindowSelection();i=this.getDocument().createRange(),i.setStart(r,n),i.setEnd(r,n),i.collapse(!0);try{u.removeAllRanges()}catch(e){}u.addRange(i),e.focus()}},{key:"resetSelection",value:function(e,t,n){this.isContentEditable(e)?this.selectElement(e,t,n):e!==this.getDocument().activeElement&&e.focus()}},{key:"replaceTriggerText",value:function(e,t,n){var i=this.tribute.current;this.resetSelection(i.element,i.selectedPath,i.selectedOffset);var r=this.getTriggerInfo(t,!0,n);if(void 0!==r)if(this.isContentEditable(i.element))e+=" ",this.pasteHtml(e,r.mentionPosition,r.mentionPosition+r.mentionText.length+1);else{var o=this.getDocument().activeElement;e+=" ";var u=r.mentionPosition,l=r.mentionPosition+r.mentionText.length+1;o.value=o.value.substring(0,u)+e+o.value.substring(l,o.value.length),o.selectionStart=u+e.length,o.selectionEnd=u+e.length}}},{key:"pasteHtml",value:function(e,t,n){var i=void 0,r=void 0;r=this.getWindowSelection(),i=this.getDocument().createRange(),i.setStart(r.anchorNode,t),i.setEnd(r.anchorNode,n),i.deleteContents();var o=this.getDocument().createElement("div");o.innerHTML=e;for(var u=this.getDocument().createDocumentFragment(),l=void 0,a=void 0;l=o.firstChild;)a=u.appendChild(l);i.insertNode(u),a&&(i=i.cloneRange(),i.setStartAfter(a),i.collapse(!0),r.removeAllRanges(),r.addRange(i))}},{key:"getWindowSelection",value:function(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}},{key:"getNodePositionInParent",value:function(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++){var n=e.parentNode.childNodes[t];if(n===e)return t}}},{key:"getContentEditableSelectedPath",value:function(){var e=this.getWindowSelection(),t=e.anchorNode,n=[],i=void 0;if(null!=t){for(var r=void 0,o=t.contentEditable;null!==t&&"true"!==o;)r=this.getNodePositionInParent(t),n.push(r),t=t.parentNode,null!==t&&(o=t.contentEditable);return n.reverse(),i=e.getRangeAt(0).startOffset,{selected:t,path:n,offset:i}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var e=this.tribute.current,t=void 0;if(this.isContentEditable(e.element)){var n=this.getWindowSelection().anchorNode;if(null!=n){var i=n.textContent,r=this.getWindowSelection().getRangeAt(0).startOffset;r>=0&&(t=i.substring(0,r))}}else{var o=this.getDocument().activeElement,u=o.selectionStart;t=o.value.substring(0,u)}return t}},{key:"getTriggerInfo",value:function(e,t,n){var i=this,r=this.tribute.current,o=void 0,u=void 0,l=void 0;if(this.isContentEditable(r.element)){var a=this.getContentEditableSelectedPath();a&&(o=a.selected,u=a.path,l=a.offset)}else o=this.getDocument().activeElement;var s=this.getTextPrecedingCurrentSelection();if(void 0!==s&&null!==s){var c=function(){var r=-1,a=void 0;if(i.tribute.triggers().forEach(function(e){var t=s.lastIndexOf(e);t>r&&(r=t,a=e)}),r>=0&&(0===r||!n||/[\xA0\s]/g.test(s.substring(r-1,r)))){var c=s.substring(r+1,s.length);a=s.substring(r,r+1);var d=c.substring(0,1),h=c.length>0&&(" "===d||" "===d);if(t&&(c=c.trim()),!h&&(e||!/[\xA0\s]/g.test(c)))return{v:{mentionPosition:r,mentionText:c,mentionSelectedElement:o,mentionSelectedPath:u,mentionSelectedOffset:l,mentionTriggerChar:a}}}}();if("object"===("undefined"==typeof c?"undefined":_typeof(c)))return c.v}}},{key:"isContentEditable",value:function(e){return"INPUT"!==e.nodeName&&"TEXTAREA"!==e.nodeName}},{key:"getTextAreaOrInputUnderlinePosition",value:function(e,t){var n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],i=null!==window.mozInnerScreenX,r=this.getDocument().createElement("div");r.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(r);var o=r.style,u=window.getComputedStyle?getComputedStyle(e):e.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",n.forEach(function(e){o[e]=u[e]}),i?(o.width=parseInt(u.width)-2+"px",e.scrollHeight>parseInt(u.height)&&(o.overflowY="scroll")):o.overflow="hidden",r.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(r.textContent=r.textContent.replace(/\s/g," "));var l=this.getDocument().createElement("span");l.textContent=e.value.substring(t)||".",r.appendChild(l);var a=e.getBoundingClientRect(),s=document.documentElement,c=(window.pageXOffset||s.scrollLeft)-(s.clientLeft||0),d=(window.pageYOffset||s.scrollTop)-(s.clientTop||0),h={top:a.top+d+l.offsetTop+parseInt(u.borderTopWidth)+parseInt(u.fontSize),left:a.left+c+l.offsetLeft+parseInt(u.borderLeftWidth)};return this.getDocument().body.removeChild(r),h}},{key:"getContentEditableCaretPosition",value:function(e){var t="\ufeff",n=void 0,i="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),r=void 0,o=this.getWindowSelection(),u=o.getRangeAt(0);r=this.getDocument().createRange(),r.setStart(o.anchorNode,e),r.setEnd(o.anchorNode,e),r.collapse(!1),n=this.getDocument().createElement("span"),n.id=i,n.appendChild(this.getDocument().createTextNode(t)),r.insertNode(n),o.removeAllRanges(),o.addRange(u);var l=n.getBoundingClientRect(),a={left:l.left,top:l.top+n.offsetHeight};return n.parentNode.removeChild(n),a}},{key:"scrollIntoView",value:function(e){for(var t=20,n=void 0,i=100,r=e;void 0===n||0===n.height;)if(n=r.getBoundingClientRect(),0===n.height&&(r=r.childNodes[0],void 0===r||!r.getBoundingClientRect))return;var o=n.top,u=o+n.height;if(o<0)window.scrollTo(0,window.pageYOffset+n.top-t);else if(u>window.innerHeight){var l=window.pageYOffset+n.top-t;l-window.pageYOffset>i&&(l=window.pageYOffset+i);var a=window.pageYOffset-(window.innerHeight-u);a>l&&(a=l),window.scrollTo(0,a)}}}]),e}(),r=function(){function e(t){_classCallCheck(this,e),this.tribute=t,this.tribute.search=this}return _createClass(e,[{key:"simpleFilter",value:function(e,t){var n=this;return t.filter(function(t){return n.test(e,t)})}},{key:"test",value:function(e,t){return null!==this.match(e,t)}},{key:"match",value:function(e,t,n){n=n||{};var i=(t.length,n.pre||""),r=n.post||"",o=n.caseSensitive&&t||t.toLowerCase();e=n.caseSensitive&&e||e.toLowerCase();var u=this.traverse(o,e,0,0,[]);return u?{rendered:this.render(t,u.cache,i,r),score:u.score}:null}},{key:"traverse",value:function(e,t,n,i,r){if(t.length===i)return{score:this.calculateScore(r),cache:r.slice()};if(!(e.length===n||t.length-i>e.length-n)){for(var o=t[i],u=e.indexOf(o,n),l=void 0,a=void 0;u>-1;){if(r.push(u),a=this.traverse(e,t,u+1,i+1,r),r.pop(),!a)return l;(!l||l.score<a.score)&&(l=a),u=e.indexOf(o,u+1)}return l}}},{key:"calculateScore",value:function(e){var t=0,n=1;return e.forEach(function(i,r){r>0&&(e[r-1]+1===i?n+=n+1:n=1),t+=n}),t}},{key:"render",value:function(e,t,n,i){var r=e.substring(0,t[0]);return t.forEach(function(o,u){r+=n+e[o]+i+e.substring(o+1,t[u+1]?t[u+1]:e.length)}),r}},{key:"filter",value:function(e,t,n){var i=this;return n=n||{},t.reduce(function(t,r,o,u){var l=r;n.extract&&(l=n.extract(r),l||(l=""));var a=i.match(e,l,n);return null!=a&&(t[t.length]={string:a.rendered,score:a.score,index:o,original:r}),t},[]).sort(function(e,t){var n=t.score-e.score;return n?n:e.index-t.index})}}]),e}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=e:window.Tribute=e}();
//# sourceMappingURL=tribute.min.js.map