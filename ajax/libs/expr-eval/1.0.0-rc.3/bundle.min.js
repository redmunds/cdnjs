!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.exprEval=e()}(this,function(){"use strict";function t(t,e,s){for(var n=s||0;n<t.length;n++)if(t[n]===e)return n;return-1}function e(t){function e(){}return Object.create?Object.create(t):(e.prototype=t,new e)}function s(t,e){this.type=t,this.value=void 0!==e&&null!==e?e:0}function n(t,s){this.tokens=t,this.parser=s,this.unaryOps=e(s.unaryOps),this.binaryOps=e(s.binaryOps),this.ternaryOps=e(s.ternaryOps),this.functions=e(s.functions)}function r(t){return"string"==typeof t?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function i(t,e,n,r,o){for(var h,a,p,u,c=[],l=[],f=0,v=t.length;f<v;f++){var x=t[f],y=x.type;if(y===D)c.push(x);else if(y===Y&&o.hasOwnProperty(x.value))x=new s(D,o[x.value]),c.push(x);else if(y===K&&c.length>1)a=c.pop(),h=c.pop(),u=n[x.value],x=new s(D,u(h.value,a.value)),c.push(x);else if(y===Q&&c.length>2)p=c.pop(),a=c.pop(),h=c.pop(),"?"===x.value?c.push(h.value?a.value:p.value):(u=r[x.value],x=new s(D,u(h.value,a.value,p.value)),c.push(x));else if(y===H&&c.length>0)h=c.pop(),u=e[x.value],x=new s(D,u(h.value)),c.push(x);else if(y===tt){for(;c.length>0;)l.push(c.shift());l.push(new s(tt,i(x.value,e,n,r,o)))}else if(y===et&&c.length>0)h=c.pop(),c.push(new s(D,h.value[x.value]));else{for(;c.length>0;)l.push(c.shift());l.push(x)}}for(;c.length>0;)l.push(c.shift());return l}function o(t,e,n){for(var r=[],i=0,h=t.length;i<h;i++){var a=t[i],p=a.type;if(p===Y&&a.value===e)for(var u=0;u<n.tokens.length;u++){var c,l=n.tokens[u];c=l.type===H?W(l.value):l.type===K?V(l.value):l.type===Q?X(l.value):new s(l.type,l.value),r.push(c)}else p===tt?r.push(new s(tt,o(a.value,e,n))):r.push(a)}return r}function h(t,e,s){for(var n,r,i,o,a=[],p=0,u=t.length;p<u;p++){var c=t[p],l=c.type;if(l===D)a.push(c.value);else if(l===K)r=a.pop(),n=a.pop(),o=e.binaryOps[c.value],a.push(o(n,r));else if(l===Q)i=a.pop(),r=a.pop(),n=a.pop(),"?"===c.value?a.push(h(n?r:i,e,s)):(o=e.ternaryOps[c.value],a.push(o(n,r,i)));else if(l===Y)if(c.value in e.functions)a.push(e.functions[c.value]);else{var f=s[c.value];if(void 0===f)throw new Error("undefined variable: "+c.value);a.push(f)}else if(l===H)n=a.pop(),o=e.unaryOps[c.value],a.push(o(n));else if(l===Z){for(var v=c.value,x=[];v-- >0;)x.unshift(a.pop());if(o=a.pop(),!o.apply||!o.call)throw new Error(o+" is not a function");a.push(o.apply(void 0,x))}else if(l===tt)a.push(c.value);else{if(l!==et)throw new Error("invalid Expression");n=a.pop(),a.push(n[c.value])}}if(a.length>1)throw new Error("invalid Expression (parity)");return a[0]}function a(t,e){for(var s,n,i,o,h=[],p=0,u=t.length;p<u;p++){var c=t[p],l=c.type;if(l===D)"number"==typeof c.value&&c.value<0?h.push("("+c.value+")"):h.push(r(c.value));else if(l===K)n=h.pop(),s=h.pop(),o=c.value,e?"^"===o?h.push("Math.pow("+s+", "+n+")"):"and"===o?h.push("("+s+" && "+n+")"):"or"===o?h.push("("+s+" || "+n+")"):"||"===o?h.push("(String("+s+") + String("+n+"))"):"=="===o?h.push("("+s+" === "+n+")"):"!="===o?h.push("("+s+" !== "+n+")"):h.push("("+s+" "+o+" "+n+")"):h.push("("+s+" "+o+" "+n+")");else if(l===Q){if(i=h.pop(),n=h.pop(),s=h.pop(),o=c.value,"?"!==o)throw new Error("invalid Expression");h.push("("+s+" ? "+n+" : "+i+")")}else if(l===Y)h.push(c.value);else if(l===H)s=h.pop(),o=c.value,"-"===o||"+"===o?h.push("("+o+s+")"):e?"not"===o?h.push("(!"+s+")"):"!"===o?h.push("fac("+s+")"):h.push(o+"("+s+")"):"!"===o?h.push("("+s+"!)"):h.push("("+o+" "+s+")");else if(l===Z){for(var f=c.value,v=[];f-- >0;)v.unshift(h.pop());o=h.pop(),h.push(o+"("+v.join(", ")+")")}else if(l===et)s=h.pop(),h.push(s+"."+c.value);else{if(l!==tt)throw new Error("invalid Expression");h.push("("+a(c.value,e)+")")}}if(h.length>1)throw new Error("invalid Expression (parity)");return h[0]}function p(e,s){for(var n=0,r=e.length;n<r;n++){var i=e[n];i.type===Y&&t(s,i.value)===-1?s.push(i.value):i.type===tt&&p(i.value,s)}}function u(t,e){return Number(t)+Number(e)}function c(t,e){return t-e}function l(t,e){return t*e}function f(t,e){return t/e}function v(t,e){return t%e}function x(t,e){return""+t+e}function y(t,e){return t===e}function w(t,e){return t!==e}function d(t,e){return t>e}function g(t,e){return t<e}function m(t,e){return t>=e}function M(t,e){return t<=e}function k(t,e){return Boolean(t&&e)}function b(t,e){return Boolean(t||e)}function E(t){return(Math.exp(t)-Math.exp(-t))/2}function O(t){return(Math.exp(t)+Math.exp(-t))/2}function T(t){return t===1/0?1:t===-(1/0)?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function A(t){return t===-(1/0)?t:Math.log(t+Math.sqrt(t*t+1))}function C(t){return Math.log(t+Math.sqrt(t*t-1))}function N(t){return Math.log((1+t)/(1-t))/2}function P(t){return Math.log(t)*Math.LOG10E}function I(t){return-t}function S(t){return!t}function F(t){return t<0?Math.ceil(t):Math.floor(t)}function L(t){return Math.random()*(t||1)}function q(t){return _(t+1)}function R(t){return String(t).length}function U(){for(var t=0,e=0,s=0,n=arguments.length;s<n;s++){var r,i=Math.abs(arguments[s]);e<i?(r=e/i,t=t*r*r+1,e=i):i>0?(r=i/e,t+=r*r):t+=i}return e===1/0?1/0:e*Math.sqrt(t)}function j(t,e,s){return t?e:s}function B(t){return isFinite(t)&&t===Math.round(t)}function _(t){var e,s;if(B(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var n=t-2,r=t-1;n>1;)r*=n,n--;return 0===r&&(r=1),r}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*_(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,o=i*t,h=o*t,a=h*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*o)-571/(2488320*h)+163879/(209018880*a)+5246819/(75246796800*a*t))}--t,s=nt[0];for(var p=1;p<nt.length;++p)s+=nt[p]/(t+p);return e=t+st+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*s}function G(t,e,s,n){this.type=t,this.value=e,this.line=s,this.column=n}function J(t,e,s,n,r){this.pos=0,this.line=0,this.column=0,this.current=null,this.unaryOps=e,this.binaryOps=s,this.ternaryOps=n,this.consts=r,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.savedLine=0,this.savedColumn=0}function W(t){var e=lt[t];return e||(e=lt[t]=new s(H,t)),e}function V(t){var e=ft[t];return e||(e=ft[t]=new s(K,t)),e}function X(t){var e=vt[t];return e||(e=vt[t]=new s(Q,t)),e}function $(t,e){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null}function z(){this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||E,cosh:Math.cosh||O,tanh:Math.tanh||T,asinh:Math.asinh||A,acosh:Math.acosh||C,atanh:Math.atanh||N,sqrt:Math.sqrt,log:Math.log,ln:Math.log,lg:Math.log10||P,log10:Math.log10||P,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||F,"-":I,"+":Number,exp:Math.exp,not:S,length:R,"!":q},this.binaryOps={"+":u,"-":c,"*":l,"/":f,"%":v,"^":Math.pow,"||":x,"==":y,"!=":w,">":d,"<":g,">=":m,"<=":M,and:k,or:b},this.ternaryOps={"?":j},this.functions={random:L,fac:q,min:Math.min,max:Math.max,hypot:Math.hypot||U,pyt:Math.hypot||U,pow:Math.pow,atan2:Math.atan2,if:j,gamma:_},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}var D="INUMBER",H="IOP1",K="IOP2",Q="IOP3",Y="IVAR",Z="IFUNCALL",tt="IEXPR",et="IMEMBER";s.prototype.toString=function(){switch(this.type){case D:case H:case K:case Q:case Y:return this.value;case Z:return"CALL "+this.value;case et:return"."+this.value;default:return"Invalid Instruction"}},n.prototype.simplify=function(t){return t=t||{},new n(i(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)},n.prototype.substitute=function(t,e){return e instanceof n||(e=this.parser.parse(String(e))),new n(o(this.tokens,t,e),this.parser)},n.prototype.evaluate=function(t){return t=t||{},h(this.tokens,this,t)},n.prototype.toString=function(t){return a(this.tokens,t)},n.prototype.symbols=function(){var t=[];return p(this.tokens,t),t},n.prototype.variables=function(){var t=[];p(this.tokens,t);var e=this.functions;return t.filter(function(t){return!(t in e)})},n.prototype.toJSFunction=function(t,e){var s=this,n=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+this.simplify(e).toString(!0)+"; }");return function(){return n.apply(s,arguments)}};var st=4.7421875,nt=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22],rt="TEOF",it="TOP",ot="TNUMBER",ht="TSTRING",at="TPAREN",pt="TCOMMA",ut="TNAME";G.prototype.toString=function(){return this.type+": "+this.value},J.prototype.newToken=function(t,e,s,n){return new G(t,e,null!=s?s:this.line,null!=n?n:this.column)},J.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current,this.savedLine=this.line,this.savedColumn=this.column},J.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent,this.line=this.savedLine,this.column=this.savedColumn},J.prototype.next=function(){return this.pos>=this.expression.length?this.newToken(rt,"EOF"):this.isWhitespace()||this.isComment()?this.next():this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isComma()||this.isNamedOp()||this.isConst()||this.isName()?this.current:void this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')},J.prototype.isString=function(){var t=!1,e=this.line,s=this.column,n=this.pos,r=this.expression.charAt(n);if("'"===r||'"'===r){this.pos++,this.column++;for(var i=this.expression.indexOf(r,n+1);i>=0&&this.pos<this.expression.length;){if(this.pos=i+1,"\\"!==this.expression.charAt(i-1)){var o=this.expression.substring(n+1,i);this.current=this.newToken(ht,this.unescape(o),e,s);for(var h=o.indexOf("\n"),a=-1;h>=0;)this.line++,this.column=0,a=h,h=o.indexOf("\n",h+1);this.column+=o.length-a,t=!0;break}i=this.expression.indexOf(r,i+1)}}return t},J.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return("("===t||")"===t)&&(this.current=this.newToken(at,t),this.pos++,this.column++,!0)},J.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return","===t&&(this.current=this.newToken(pt,","),this.pos++,this.column++,!0)},J.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()&&(e===this.pos||"_"!==s&&"."!==s&&(s<"0"||s>"9")))break}if(e>t){var n=this.expression.substring(t,e);if(n in this.consts)return this.current=this.newToken(ot,this.consts[n]),this.pos+=n.length,this.column+=n.length,!0}return!1},J.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()&&(e===this.pos||"_"!==s&&(s<"0"||s>"9")))break}if(e>t){var n=this.expression.substring(t,e);if(n in this.binaryOps||n in this.unaryOps||n in this.ternaryOps)return this.current=this.newToken(it,n),this.pos+=n.length,this.column+=n.length,!0}return!1},J.prototype.isName=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var s=this.expression.charAt(e);if(s.toUpperCase()===s.toLowerCase()&&(e===this.pos||"_"!==s&&(s<"0"||s>"9")))break}if(e>t){var n=this.expression.substring(t,e);return this.current=this.newToken(ut,n),this.pos+=n.length,this.column+=n.length,!0}return!1},J.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);!(" "!==e&&"\t"!==e&&"\n"!==e&&"\r"!==e||(t=!0,this.pos++,this.column++,"\n"===e&&(this.line++,this.column=0),this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var ct=/^[0-9a-f]{4}$/i;J.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var s=t.substring(0,e);e>=0;){var n=t.charAt(++e);switch(n){case"'":s+="'";break;case'"':s+='"';break;case"\\":s+="\\";break;case"/":s+="/";break;case"b":s+="\b";break;case"f":s+="\f";break;case"n":s+="\n";break;case"r":s+="\r";break;case"t":s+="\t";break;case"u":var r=t.substring(e+1,e+5);ct.test(r)||this.parseError("Illegal escape sequence: \\u"+r),s+=String.fromCharCode(parseInt(r,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+n+'"')}++e;var i=t.indexOf("\\",e);s+=t.substring(e,i<0?t.length:i),e=i}return s},J.prototype.isComment=function(){var t=this.expression.charAt(this.pos);if("/"===t&&"*"===this.expression.charAt(this.pos+1)){var e=this.pos;this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length);for(var s=this.expression.substring(e,this.pos),n=s.indexOf("\n");n>=0;)this.line++,this.column=s.length-n,n=s.indexOf("\n",n+1);return!0}return!1},J.prototype.isNumber=function(){for(var t,e=!1,s=this.pos,n=s,r=s,i=this.column,o=i,h=!1,a=!1;s<this.expression.length&&(t=this.expression.charAt(s),t>="0"&&t<="9"||!h&&"."===t);)"."===t?h=!0:a=!0,s++,i++,e=a;if(e&&(r=s,o=i),"e"===t||"E"===t){s++,i++;for(var p=!0,u=!1;s<this.expression.length;){if(t=this.expression.charAt(s),!p||"+"!==t&&"-"!==t){if(!(t>="0"&&t<="9"))break;u=!0,p=!1}else p=!1;s++,i++}u||(s=r,i=o)}return e?(this.current=this.newToken(ot,parseFloat(this.expression.substring(n,s))),this.pos=s,this.column=i):(this.pos=r,this.column=o),e},J.prototype.isOperator=function(){var t=this.expression.charAt(this.pos);if("+"===t||"-"===t||"*"===t||"/"===t||"%"===t||"^"===t||"?"===t||":"===t||"."===t)this.current=this.newToken(it,t);else if("∙"===t||"•"===t)this.current=this.newToken(it,"*");else if(">"===t)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(it,">="),this.pos++,this.column++):this.current=this.newToken(it,">");else if("<"===t)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(it,"<="),this.pos++,this.column++):this.current=this.newToken(it,"<");else if("|"===t){if("|"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(it,"||"),this.pos++,this.column++}else if("="===t){if("="!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(it,"=="),this.pos++,this.column++}else if("!"===t)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(it,"!="),this.pos++,this.column++):this.current=this.newToken(it,t);else if("a"===t){if("n"!==this.expression.charAt(this.pos+1)||"d"!==this.expression.charAt(this.pos+2))return!1;this.current=this.newToken(it,"and"),this.pos+=2,this.column+=2}else{if("o"!==t)return!1;if("r"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(it,"or"),this.pos++,this.column++}return this.pos++,this.column++,!0},J.prototype.parseError=function(t){throw new Error("parse error ["+(this.line+1)+":"+(this.column+1)+"]: "+t)};var lt={},ft={},vt={};$.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()},$.prototype.tokenMatches=function(e,s){return"undefined"==typeof s||("[object Array]"===Object.prototype.toString.call(s)?t(s,e.value)>=0:"function"==typeof s?s(e):e.value===s)},$.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()},$.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken},$.prototype.accept=function(t,e){return!(this.nextToken.type!==t||!this.tokenMatches(this.nextToken,e))&&(this.next(),!0)},$.prototype.expect=function(t,e){if(!this.accept(t,e))throw new Error("parse error ["+this.tokens.line+":"+this.tokens.column+"]: Expected "+(e||t))},$.prototype.parseAtom=function(t){if(this.accept(ut))t.push(new s(Y,this.current.value));else if(this.accept(ot))t.push(new s(D,this.current.value));else if(this.accept(ht))t.push(new s(D,this.current.value));else{if(!this.accept(at,"("))throw new Error("unexpected "+this.nextToken);this.parseExpression(t),this.expect(at,")")}},$.prototype.parseExpression=function(t){this.parseConditionalExpression(t)},$.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(it,"?");){var e=[],n=[];this.parseConditionalExpression(e),this.expect(it,":"),this.parseConditionalExpression(n),t.push(new s(tt,e)),t.push(new s(tt,n)),t.push(X("?"))}},$.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(it,"or");)this.parseAndExpression(t),t.push(V("or"))},$.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(it,"and");)this.parseComparison(t),t.push(V("and"))},$.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(it,["==","!=","<","<=",">=",">"]);){var e=this.current;this.parseAddSub(t),t.push(V(e.value))}},$.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(it,["+","-","||"]);){var e=this.current;this.parseTerm(t),t.push(V(e.value))}},$.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(it,["*","/","%"]);){var e=this.current;this.parseFactor(t),t.push(V(e.value))}},$.prototype.parseFactor=function(t){function e(t){return t.value in s}var s=this.tokens.unaryOps;if(this.save(),this.accept(it,e))if("-"!==this.current.value&&"+"!==this.current.value&&this.nextToken.type===at&&"("===this.nextToken.value)this.restore(),this.parseExponential(t);else{var n=this.current;this.parseFactor(t),t.push(W(n.value))}else this.parseExponential(t)},$.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(it,"^");)this.parseFactor(t),t.push(V("^"))},$.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(it,"!");)t.push(W("!"))},$.prototype.parseFunctionCall=function(t){function e(t){return t.value in n}var n=this.tokens.unaryOps;if(this.accept(it,e)){var r=this.current;this.parseAtom(t),t.push(W(r.value))}else for(this.parseMemberExpression(t);this.accept(at,"(");)if(this.accept(at,")"))t.push(new s(Z,0));else{var i=this.parseArgumentList(t);t.push(new s(Z,i))}},$.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(at,")");)for(this.parseExpression(t),++e;this.accept(pt);)this.parseExpression(t),++e;return e},$.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(it,".");)this.expect(ut),t.push(new s(et,this.current.value))},z.parse=function(t){return(new z).parse(t)},z.evaluate=function(t,e){return z.parse(t).evaluate(e)},z.prototype={parse:function(t){var e=[],s=new $(this,new J(t,this.unaryOps,this.binaryOps,this.ternaryOps,this.consts));return s.parseExpression(e),s.expect(rt,"EOF"),new n(e,this)},evaluate:function(t,e){return this.parse(t).evaluate(e)}};var xt={Parser:z,Expression:n};return xt});
