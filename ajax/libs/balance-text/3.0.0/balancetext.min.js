"use strict";(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof module==="object"&&module.exports){module.exports=factory()}else{root.balanceText=factory()}})(this,function(){function isArray(arg){if(Array.isArray){return Array.isArray(arg)}return Object.prototype.toString.call(arg)==="[object Array]"}function ready(fn){if(document.readyState!=="loading"){fn()}else if(document.addEventListener){document.addEventListener("DOMContentLoaded",fn)}else{document.attachEvent("onreadystatechange",function(){if(document.readyState!=="loading"){fn()}})}}function trigger(el,eventName,data){var event;if(window.CustomEvent){event=new CustomEvent(eventName,{detail:data})}else{event=document.createEvent("CustomEvent");event.initCustomEvent(eventName,true,true,data)}el.dispatchEvent(event)}function debounce(func,threshold,execAsap){var timeout;return function debounced(){var obj=this,args=arguments;function delayed(){if(!execAsap){func.apply(obj,args)}timeout=null}if(timeout){clearTimeout(timeout)}else if(execAsap){func.apply(obj,args)}timeout=setTimeout(delayed,threshold||100)}}function smartresize(fn){if(fn){window.addEventListener("resize",debounce(fn))}else{trigger(window,"smartresize")}}function nodeListAsArray(nodeList){return nodeList?Array.prototype.slice.call(nodeList):[]}function hasTextWrap(){var style=document.documentElement.style;return style.textWrap||style.WebkitTextWrap||style.MozTextWrap||style.MsTextWrap||style.OTextWrap}var wsMatches;function NextWS_params(){this.reset()}NextWS_params.prototype.reset=function(){this.index=0;this.width=0};var isWS=function(txt,index){var re=/\s(?![^<]*>)/g,match;if(!wsMatches){wsMatches=[];match=re.exec(txt);while(match!==null){wsMatches.push(match.index);match=re.exec(txt)}}return wsMatches.indexOf(index)!==-1};var removeTags=function(el){var brs=nodeListAsArray(el.querySelectorAll('br[data-owner="balance-text"]'));brs.forEach(function(br){br.outerHTML=" "});var spans=nodeListAsArray(el.querySelectorAll('span[data-owner="balance-text"]'));if(spans.length>0){var txt="";spans.forEach(function(span){txt+=span.textContent;span.parentNode.removeChild(span)});el.innerHTML=txt}};var isJustified=function(el){var style=el.currentStyle||window.getComputedStyle(el,null);return style.textAlign==="justify"};var justify=function(el,txt,conWidth){txt=txt.trim();var words=txt.split(" ").length;txt=txt+" ";if(words<2){return txt}var tmp=document.createElement("span");tmp.innerHTML=txt;el.appendChild(tmp);var size=tmp.offsetWidth;tmp.parentNode.removeChild(tmp);var wordSpacing=Math.floor((conWidth-size)/(words-1));tmp.style.wordSpacing=wordSpacing+"px";tmp.setAttribute("data-owner","balance-text");var div=document.createElement("div");div.appendChild(tmp);return div.innerHTML};var isBreakOpportunity=function(txt,index){return index===0||index===txt.length||isWS(txt,index-1)&&!isWS(txt,index)};var findBreakOpportunity=function(el,txt,conWidth,desWidth,dir,c,ret){var w;if(txt&&typeof txt==="string"){for(;;){while(!isBreakOpportunity(txt,c)){c+=dir}el.innerHTML=txt.substr(0,c);w=el.offsetWidth;if(dir<0){if(w<=desWidth||w<=0||c===0){break}}else{if(desWidth<=w||conWidth<=w||c===txt.length){break}}c+=dir}}ret.index=c;ret.width=w};var getSpaceWidth=function(el,h){var container=document.createElement("div");container.style.display="block";container.style.position="absolute";container.style.bottom=0;container.style.right=0;container.style.width=0;container.style.height=0;container.style.margin=0;container.style.padding=0;container.style.visibility="hidden";container.style.overflow="hidden";var space=document.createElement("span");space.style.fontSize="2000px";space.innerHTML="&nbsp;";container.appendChild(space);el.appendChild(container);var dims=space.getBoundingClientRect();container.parentNode.removeChild(container);var spaceRatio=dims.height/dims.width;return h/spaceRatio};var watching={sel:[],el:[]};function ensureElementArray(elements){if(NodeList.prototype.isPrototypeOf(elements)){elements=nodeListAsArray(elements)}if(!isArray(elements)){elements=[elements]}return elements}function balanceText(elements){if(hasTextWrap()){return this}if(typeof elements==="string"){elements=document.querySelectorAll(elements)}elements=ensureElementArray(elements);return elements.forEach(function(el){var maxTextWidth=5e3;removeTags(el);var oldWS=el.style.whiteSpace;var oldFloat=el.style.float;var oldDisplay=el.style.display;var oldPosition=el.style.position;var oldLH=el.style.lineHeight;el.style.lineHeight="normal";var containerWidth=el.offsetWidth;var containerHeight=el.offsetHeight;el.style.whiteSpace="nowrap";el.style.float="none";el.style.display="inline";el.style.position="static";var nowrapWidth=el.offsetWidth;var nowrapHeight=el.offsetHeight;var spaceWidth=oldWS==="pre-wrap"?0:getSpaceWidth(el,nowrapHeight);if(containerWidth>0&&nowrapWidth>containerWidth&&nowrapWidth<maxTextWidth){var remainingText=el.innerHTML;var newText="";var lineText="";var shouldJustify=isJustified(el);var totLines=Math.round(containerHeight/nowrapHeight);var remLines=totLines;var desiredWidth,guessIndex,le,ge,splitIndex;while(remLines>1){wsMatches=null;desiredWidth=Math.round((nowrapWidth+spaceWidth)/remLines-spaceWidth);guessIndex=Math.round((remainingText.length+1)/remLines)-1;le=new NextWS_params;findBreakOpportunity(el,remainingText,containerWidth,desiredWidth,-1,guessIndex,le);ge=new NextWS_params;guessIndex=le.index;findBreakOpportunity(el,remainingText,containerWidth,desiredWidth,+1,guessIndex,ge);le.reset();guessIndex=ge.index;findBreakOpportunity(el,remainingText,containerWidth,desiredWidth,-1,guessIndex,le);if(le.index===0){splitIndex=ge.index}else if(containerWidth<ge.width||le.index===ge.index){splitIndex=le.index}else{splitIndex=Math.abs(desiredWidth-le.width)<Math.abs(ge.width-desiredWidth)?le.index:ge.index}lineText=remainingText.substr(0,splitIndex);if(shouldJustify){newText+=justify(el,lineText,containerWidth)}else{newText+=lineText.replace(/\s$/,"");newText+='<br data-owner="balance-text" />'}remainingText=remainingText.substr(splitIndex);remLines--;el.innerHTML=remainingText;nowrapWidth=el.offsetWidth}if(shouldJustify){el.innerHTML=newText+justify(el,remainingText,containerWidth)}else{el.innerHTML=newText+remainingText}}el.style.whiteSpace=oldWS;el.style.float=oldFloat;el.style.display=oldDisplay;el.style.position=oldPosition;el.style.lineHeight=oldLH})}function applyBalanceText(){var selectors=watching.sel.join(",");var selectedElements=selectors?document.querySelectorAll(selectors):[];var elements=watching.el.concat(nodeListAsArray(selectedElements));balanceText(elements)}var handlersInitialized=false;function initHandlers(){if(handlersInitialized){return}ready(applyBalanceText);smartresize(applyBalanceText);handlersInitialized=true}function balanceTextAndWatch(elements){if(typeof elements==="string"){watching.sel.push(elements)}else{elements=ensureElementArray(elements);elements.forEach(function(el){watching.el.push(el)})}initHandlers();applyBalanceText()}var polyfilled=false;function polyfill(){if(polyfilled){return}watching.sel.push(".balance-text");initHandlers();polyfilled=true}function publicInterface(elements,options){if(!elements){polyfill();return}if(typeof elements!=="string"&&elements.length!==undefined){elements=nodeListAsArray(elements)}if(options&&options.watch){balanceTextAndWatch(elements);return}balanceText(elements)}publicInterface.updateWatched=function(){applyBalanceText()};return publicInterface});
