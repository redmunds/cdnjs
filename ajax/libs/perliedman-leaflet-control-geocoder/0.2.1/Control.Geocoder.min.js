!function(e){var t;if("function"==typeof define&&define.amd)define(["leaflet"],e);else if("undefined"!=typeof module)t=require("leaflet"),module.exports=e(t);else{if("undefined"==typeof window.L)throw"Leaflet must be loaded first";e(window.L)}}(function(e){"use strict";return e.Control.Geocoder=e.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found."},_callbackId:0,initialize:function(t){e.Util.setOptions(this,t),this.options.geocoder||(this.options.geocoder=new e.Control.Geocoder.Nominatim)},onAdd:function(t){var o,n="leaflet-control-geocoder",i=e.DomUtil.create("div",n),r=e.DomUtil.create("div","leaflet-control-geocoder-icon",i),s=this._form=e.DomUtil.create("form",n+"-form",i);return this._map=t,this._container=i,o=this._input=e.DomUtil.create("input"),o.type="text",e.DomEvent.addListener(o,"keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=n+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=e.DomUtil.create("ul",n+"-alternatives leaflet-control-geocoder-alternatives-minimized"),s.appendChild(o),s.appendChild(this._errorElement),i.appendChild(this._alts),e.DomEvent.addListener(s,"submit",this._geocode,this),this.options.collapsed?"click"===this.options.expand?e.DomEvent.addListener(r,"click",function(e){0===e.button&&1===e.detail&&this._toggle()},this):(e.DomEvent.addListener(r,"mouseover",this._expand,this),e.DomEvent.addListener(r,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),e.DomEvent.disableClickPropagation(i),i},_geocodeResult:function(t){if(e.DomUtil.removeClass(this._container,"leaflet-control-geocoder-throbber"),1===t.length)this._geocodeResultSelected(t[0]);else if(t.length>0){this._alts.innerHTML="",this._results=t,e.DomUtil.removeClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");for(var o=0;o<t.length;o++)this._alts.appendChild(this._createAlt(t[o],o))}else e.DomUtil.addClass(this._errorElement,"leaflet-control-geocoder-error")},markGeocode:function(t){return this._map.fitBounds(t.bbox),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new e.Marker(t.center).bindPopup(t.name).addTo(this._map).openPopup(),this},_geocode:function(t){return e.DomEvent.preventDefault(t),e.DomUtil.addClass(this._container,"leaflet-control-geocoder-throbber"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1},_geocodeResultSelected:function(e){this.options.collapsed?this._collapse():this._clearResults(),this.markGeocode(e)},_toggle:function(){this._container.className.indexOf("leaflet-control-geocoder-expanded")>=0?this._collapse():this._expand()},_expand:function(){e.DomUtil.addClass(this._container,"leaflet-control-geocoder-expanded"),this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-geocoder-expanded",""),e.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized"),e.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_clearResults:function(){e.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized"),this._selection=null,e.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_createAlt:function(t,o){var n=document.createElement("li");return n.innerHTML='<a href="#" data-result-index="'+o+'">'+(this.options.showResultIcons&&t.icon?'<img src="'+t.icon+'"/>':"")+t.name+"</a>",e.DomEvent.addListener(n,"click",function(){this._geocodeResultSelected(t)},this),n},_keydown:function(t){var o=this,n=function(t){o._selection&&(e.DomUtil.removeClass(o._selection.firstChild,"leaflet-control-geocoder-selected"),o._selection=o._selection[t>0?"nextSibling":"previousSibling"]),o._selection||(o._selection=o._alts[t>0?"firstChild":"lastChild"]),o._selection&&e.DomUtil.addClass(o._selection.firstChild,"leaflet-control-geocoder-selected")};switch(t.keyCode){case 38:n(-1),e.DomEvent.preventDefault(t);break;case 40:n(1),e.DomEvent.preventDefault(t);break;case 13:if(this._selection){var i=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[i]),this._clearResults(),e.DomEvent.preventDefault(t)}}return!0}}),e.Control.geocoder=function(t,o){return new e.Control.Geocoder(t,o)},e.Control.Geocoder.callbackId=0,e.Control.Geocoder.jsonp=function(t,o,n,i,r){var s="_l_geocoder_"+e.Control.Geocoder.callbackId++;o[r||"callback"]=s,window[s]=e.Util.bind(n,i);var l=document.createElement("script");l.type="text/javascript",l.src=t+e.Util.getParamString(o),l.id=s,document.getElementsByTagName("head")[0].appendChild(l)},e.Control.Geocoder.Nominatim=e.Class.extend({options:{serviceUrl:"http://nominatim.openstreetmap.org/"},initialize:function(t){e.Util.setOptions(this,t)},geocode:function(t,o,n){e.Control.Geocoder.jsonp(this.options.serviceUrl+"search/",{q:t,limit:5,format:"json"},function(t){for(var i=[],r=t.length-1;r>=0;r--){for(var s=t[r].boundingbox,l=0;l<4;l++)s[l]=parseFloat(s[l]);i[r]={icon:t[r].icon,name:t[r].display_name,bbox:e.latLngBounds([s[0],s[2]],[s[1],s[3]]),center:e.latLng((s[0]+s[1])/2,(s[2]+s[3])/2)}}o.call(n,i)},this,"json_callback")},reverse:function(t,o,n,i){e.Control.Geocoder.jsonp(this.options.serviceUrl+"reverse/",{lat:t.lat,lon:t.lng,zoom:Math.round(Math.log(o/256)/Math.log(2)),format:"json"},function(t){var o=e.latLng(t.lat,t.lon);n.call(i,[{name:t.display_name,center:o,bounds:e.latLngBounds(o,o)}])},this,"json_callback")}}),e.Control.Geocoder.nominatim=function(t){return new e.Control.Geocoder.Nominatim(t)},e.Control.Geocoder.Bing=e.Class.extend({initialize:function(e){this.key=e},geocode:function(t,o,n){e.Control.Geocoder.jsonp("http://dev.virtualearth.net/REST/v1/Locations",{query:t,key:this.key},function(t){for(var i=[],r=t.resourceSets[0].resources.length-1;r>=0;r--){var s=t.resourceSets[0].resources[r],l=s.bbox;i[r]={name:s.name,bbox:e.latLngBounds([l[0],l[1]],[l[2],l[3]]),center:e.latLng(s.point.coordinates)}}o.call(n,i)},this,"jsonp")},reverse:function(t,o,n,i){e.Control.Geocoder.jsonp("http://dev.virtualearth.net/REST/v1/Locations/"+t.lat+","+t.lng,{key:this.key},function(t){for(var o=[],r=t.resourceSets[0].resources.length-1;r>=0;r--){var s=t.resourceSets[0].resources[r],l=s.bbox;o[r]={name:s.name,bbox:e.latLngBounds([l[0],l[1]],[l[2],l[3]]),center:e.latLng(s.point.coordinates)}}n.call(i,o)},this,"jsonp")}}),e.Control.Geocoder.bing=function(t){return new e.Control.Geocoder.Bing(t)},e.Control.Geocoder.RaveGeo=e.Class.extend({options:{querySuffix:"",deepSearch:!0,wordBased:!1},jsonp:function(t,o,n){var i="_l_geocoder_"+e.Control.Geocoder.callbackId++,r=[];t.prepend=i+"(",t.append=")";for(var s in t)r.push(s+"="+escape(t[s]));window[i]=e.Util.bind(o,n);var l=document.createElement("script");l.type="text/javascript",l.src=this._serviceUrl+"?"+r.join("&"),l.id=i,document.getElementsByTagName("head")[0].appendChild(l)},initialize:function(t,o,n){e.Util.setOptions(this,n),this._serviceUrl=t,this._scheme=o},geocode:function(t,o,n){e.Control.Geocoder.jsonp(this._serviceUrl,{address:t+this.options.querySuffix,scheme:this._scheme,outputFormat:"jsonp",deepSearch:this.options.deepSearch,wordBased:this.options.wordBased},function(t){for(var i=[],r=t.length-1;r>=0;r--){var s=t[r],l=e.latLng(s.y,s.x);i[r]={name:s.address,bbox:e.latLngBounds([l]),center:l}}o.call(n,i)},this)}}),e.Control.Geocoder.raveGeo=function(t,o,n){return new e.Control.Geocoder.RaveGeo(t,o,n)},e.Control.Geocoder.MapQuest=e.Class.extend({initialize:function(e){this._key=decodeURIComponent(e)},_formatName:function(){var e,t=[];for(e=0;e<arguments.length;e++)arguments[e]&&t.push(arguments[e]);return t.join(", ")},geocode:function(t,o,n){e.Control.Geocoder.jsonp("http://www.mapquestapi.com/geocoding/v1/address",{key:this._key,location:t,limit:5,outFormat:"json"},function(t){var i,r,s=[];if(t.results&&t.results[0].locations)for(var l=t.results[0].locations.length-1;l>=0;l--)i=t.results[0].locations[l],r=e.latLng(i.latLng),s[l]={name:this._formatName(i.street,i.adminArea4,i.adminArea3,i.adminArea1),bbox:e.latLngBounds(r,r),center:r};o.call(n,s)},this)},reverse:function(t,o,n,i){e.Control.Geocoder.jsonp("http://www.mapquestapi.com/geocoding/v1/reverse",{key:this._key,location:t.lat+","+t.lng,outputFormat:"json"},function(t){var o,r,s=[];if(t.results&&t.results[0].locations)for(var l=t.results[0].locations.length-1;l>=0;l--)o=t.results[0].locations[l],r=e.latLng(o.latLng),s[l]={name:this._formatName(o.street,o.adminArea4,o.adminArea3,o.adminArea1),bbox:e.latLngBounds(r,r),center:r};n.call(i,s)},this)}}),e.Control.Geocoder.mapQuest=function(t){return new e.Control.Geocoder.MapQuest(t)},e.Control.Geocoder});