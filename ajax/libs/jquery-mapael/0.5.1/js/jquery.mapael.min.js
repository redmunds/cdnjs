!function(e){"use strict";e.fn.mapael=function(t){return t=e.extend(!0,{},e.fn.mapael.defaultOptions,t),this.each(function(){var a=e("<div>").addClass(t.map.tooltip.cssClass).css("display","none"),i=e("."+t.map.cssClass,this).empty().append(a),n=e.fn.mapael.maps[t.map.name],o=new Raphael(i[0],n.width,n.height),s={},l={},r=0,m={},p={},c={},f={},d=0;t.map.tooltip.css&&a.css(t.map.tooltip.css),o.setViewBox(0,0,n.width,n.height,!1);for(d in n.elems)s=e.fn.mapael.getElemOptions(t.map.defaultArea,t.areas[d]?t.areas[d]:{},t.legend.area),m[d]={mapElem:o.path(n.elems[d]).attr(s.attrs)},e.fn.mapael.initElem(o,m[d],s,a);for(d in t.plots)s=e.fn.mapael.getElemOptions(t.map.defaultPlot,t.plots[d]?t.plots[d]:{},t.legend.plot),l=s.x&&s.y?{x:s.x,y:s.y}:n.getCoords(s.latitude,s.longitude),"square"==s.type?p[d]={mapElem:o.rect(l.x-s.size/2,l.y-s.size/2,s.size,s.size).attr(s.attrs)}:p[d]={mapElem:o.circle(l.x,l.y,s.size/2).attr(s.attrs)},e.fn.mapael.initElem(o,p[d],s,a);t.legend.area.slices&&t.legend.area.display&&(c=e.fn.mapael.createLegend(e(this),t,"area",m)),t.legend.plot.slices&&t.legend.plot.display&&(f=e.fn.mapael.createLegend(e(this),t,"plot",p)),t.map.zoom.enabled&&e.fn.mapael.initZoom(i,o,n.width,n.height,t.map.zoom),e(this).on("update",function(a,i,n,o,s,l){var r={},d=0,u={},g={},x=0,h=function(t){"undefined"!=typeof t.hidden&&1==t.hidden&&e(t.node).trigger("click")};s||(s=300),l||(l="linear"),n&&(t.areas={}),o&&(t.plots={}),e.extend(!0,t,i),c.forEach&&c.forEach(h),f.forEach&&f.forEach(h);for(d in m)r=e.fn.mapael.getElemOptions(t.map.defaultArea,t.areas[d]?t.areas[d]:{},t.legend.area),"undefined"!=typeof r.value&&(m[d].value=r.value),e.fn.mapael.setHoverOptions(m[d].mapElem,r.attrs,m[d].mapElem.attrsHover),m[d].mapElem.animate(r.attrs,s,l),r.tooltip&&r.tooltip.content&&(m[d].mapElem.tooltipContent=r.tooltip.content,m[d].textElem&&(m[d].textElem.tooltipContent=r.tooltip.content));for(d in p)r=e.fn.mapael.getElemOptions(t.map.defaultPlot,t.plots[d]?t.plots[d]:{},t.legend.plot),"undefined"!=typeof r.value&&(p[d].value=r.value),p[d].textElem&&(u=p[d].mapElem.getBBox(),x=(r.size-u.height)/2,u.x-=x,u.x2+=x,u.y-=x,u.y2+=x,g=e.fn.mapael.getTextPosition(u,r.textPosition),p[d].textElem.animate({x:g.x,y:g.y},s,l)),"square"==r.type?(r.attrs.width=r.size,r.attrs.height=r.size):r.attrs.r=r.size/2,e.fn.mapael.setHoverOptions(p[d].mapElem,r.attrs,p[d].mapElem.attrsHover),p[d].mapElem.animate(r.attrs,s,l),r.tooltip&&r.tooltip.content&&(p[d].mapElem.tooltipContent=r.tooltip.content,p[d].textElem&&(p[d].textElem.tooltipContent=r.tooltip.content))}),t.map.width?o.setSize(t.map.width,n.height*(t.map.width/n.width)):(e(window).on("resize",function(){clearTimeout(r),r=setTimeout(function(){i.trigger("resizeEnd")},150)}),e(document).on("ready",function(){i.trigger("resizeEnd")}),i.on("resizeEnd",function(e){var t=i.width();o.width!=t&&o.setSize(t,n.height*(t/n.width))}),i.trigger("resizeEnd")),e(o.desc).append(" and Mapael (http://neveldo.fr/mapael)")})},e.fn.mapael.initElem=function(t,a,i,n){var o={},s={};e.fn.mapael.setHoverOptions(a.mapElem,i.attrs,i.attrsHover),i.href&&e.fn.mapael.setHref(a.mapElem,i.href),i.text?(o=a.mapElem.getBBox(),s=e.fn.mapael.getTextPosition(o,i.textPosition),i.textAttrs["text-anchor"]=s.textAnchor,a.textElem=t.text(s.x,s.y,i.text).attr(i.textAttrs),i.href&&e.fn.mapael.setHref(a.textElem,i.href),e.fn.mapael.setHoverOptions(a.textElem,i.textAttrs,i.textAttrsHover),e.fn.mapael.setHover(t,a.mapElem,a.textElem),e.fn.mapael.setCallbacks(i,a.mapElem,a.textElem)):(e.fn.mapael.setHover(t,a.mapElem),e.fn.mapael.setCallbacks(i,a.mapElem)),i.tooltip&&i.tooltip.content&&(a.mapElem.tooltipContent=i.tooltip.content,e.fn.mapael.setTooltip(a.mapElem,n),i.text&&(a.textElem.tooltipContent=i.tooltip.content,e.fn.mapael.setTooltip(a.textElem,n))),"undefined"!=typeof i.value&&(a.value=i.value)},e.fn.mapael.setHref=function(t,a){t.attr({cursor:"pointer"}),e(t.node).bind("click",function(){e.fn.mapael.panning||(window.location=a)})},e.fn.mapael.setTooltip=function(t,a){var i=0;e(t.node).on("mouseover",function(){i=setTimeout(function(){a.html(t.tooltipContent).css("display","block")},120)}).on("mouseout",function(){clearTimeout(i),a.css("display","none")}).on("mousemove",function(t){a.css("left",t.pageX+15).css("top",t.pageY+15-e(window).scrollTop())})},e.fn.mapael.setCallbacks=function(t,a,i){for(var n=["click","mouseover","mouseout"],o={},s=0,l=n.length;l>s;++s)t["on"+n[s]]&&(o=t["on"+n[s]],e(a.node).on(n[s],function(){!e.fn.mapael.panning&&o(t,a,i)}),i&&e(i.node).on(n[s],function(){!e.fn.mapael.panning&&o(t,a,i)}))},e.fn.mapael.panning=!1,e.fn.mapael.initZoom=function(t,a,i,n,o){var s=e("<div>").addClass(o.zoomInCssClass).html("+"),l=e("<div>").addClass(o.zoomOutCssClass).html("&#x2212;"),r=0,m=i/2,p=n/2,c=!1,f=0,d=0,u=function(e){r=Math.min(Math.max(r+e.data.offset,0),o.maxLevel),0==r?(m=i/2,p=n/2,a.setViewBox(0,0,i,n)):a.setViewBox(Math.min(Math.max(0,m-i/(1+r*o.step)/2),i-i/(1+r*o.step)),Math.min(Math.max(0,p-n/(1+r*o.step)/2),n-n/(1+r*o.step)),i/(1+r*o.step),n/(1+r*o.step))};t.append(s).append(l),s.on("click",null,{offset:1},u),l.on("click",null,{offset:-1},u),e("body").on("mouseup",function(t){c=!1,setTimeout(function(){e.fn.mapael.panning=!1},50)}),t.on("mousedown",function(e){return c=!0,f=e.pageX,d=e.pageY,!1}).on("mousemove",function(t){if(c&&0!=r){var s=(f-t.pageX)/(1+r*o.step)*(i/a.width),l=(d-t.pageY)/(1+r*o.step)*(n/a.height);if(Math.abs(s)>5||Math.abs(l)>5){var u=Math.min(Math.max(0,a._viewBox[0]+s),i-a._viewBox[2]),g=Math.min(Math.max(0,a._viewBox[1]+l),n-a._viewBox[3]);m=u+a._viewBox[2]/2,p=g+a._viewBox[3]/2,a.setViewBox(u,g,a._viewBox[2],a._viewBox[3]),f=t.pageX,d=t.pageY,e.fn.mapael.panning=!0}}return!1})},e.fn.mapael.createLegend=function(t,a,i,n){var o=a.legend[i],s="plot"==i?e("."+a.legend.plot.cssClass,t).empty():e("."+a.legend.area.cssClass,t).empty(),l=new Raphael(s.get(0)),r=5,m=5,p={},c={},f={},d={};o.title&&(p=l.text(o.marginLeftTitle,o.marginBottom,o.title).attr(o.titleAttrs),r=o.marginLeftTitle+p.getBBox().width,m+=o.marginBottom+p.getBBox().height);for(var u=0,g=o.slices.length;g>u;++u)c="plot"==i?a.map.defaultPlot:a.map.defaultArea,o.slices[u].attrs=e.extend({},c.attrs,o.slices[u].attrs),o.slices[u].attrsHover=e.extend({},c.attrsHover,o.slices[u].attrsHover),"area"==i||"square"==o.slices[u].type?(!o.slices[u].size&&(o.slices[u].size=20),f=l.rect(o.marginLeft,m,o.slices[u].size,o.slices[u].size).attr(o.slices[u].attrs)):f=l.circle(o.marginLeft+o.slices[u].size/2,m+o.slices[u].size/2,o.slices[u].size/2).attr(o.slices[u].attrs),d=l.text(o.marginLeft+o.slices[u].size+o.marginLeftLabel,m+o.slices[u].size/2,o.slices[u].label).attr(o.labelAttrs),m+=o.marginBottom+o.slices[u].size,r=Math.max(r,o.marginLeft+o.slices[u].size+o.marginLeftLabel+d.getBBox().width),o.hideElemsOnClick.enabled&&(d.attr({cursor:"pointer"}),e.fn.mapael.setHoverOptions(f,o.slices[u].attrs,o.slices[u].attrsHover),e.fn.mapael.setHoverOptions(d,o.labelAttrs,o.labelAttrs),e.fn.mapael.setHover(l,f,d),d.hidden=!1,function(t,a,i){e(i.node).on("click",function(){i.hidden?(i.animate({opacity:"undefined"!=typeof i.originalAttrs.opacity?i.originalAttrs.opacity:1},300),a.animate({opacity:"undefined"!=typeof a.originalAttrs.opacity?a.originalAttrs.opacity:1},300)):(i.animate({opacity:o.hideElemsOnClick.opacity},300),a.animate({opacity:o.hideElemsOnClick.opacity},300));for(var e in n)(!o.slices[t].min||n[e].value>=o.slices[t].min)&&(!o.slices[t].max||n[e].value<o.slices[t].max)&&(i.hidden?(n[e].mapElem.animate({opacity:"undefined"!=typeof n[e].mapElem.originalAttrs.opacity?n[e].mapElem.originalAttrs.opacity:1},300),n[e].textElem&&n[e].textElem.animate({opacity:"undefined"!=typeof n[e].textElem.originalAttrs.opacity?n[e].textElem.originalAttrs.opacity:1},300)):(n[e].mapElem.animate({opacity:o.hideElemsOnClick.opacity},300),n[e].textElem&&n[e].textElem.animate({opacity:o.hideElemsOnClick.opacity},300)));i.hidden=!i.hidden})}(u,f,d));return"SVG"!=Raphael.type&&o.VMLWidth&&(r=o.VMLWidth),l.setSize(r,m),l},e.fn.mapael.setHoverOptions=function(t,a,i){"SVG"!=Raphael.type&&delete i.transform,t.attrsHover=i,t.attrsHover.transform?t.originalAttrs=e.extend({transform:"s1"},a):t.originalAttrs=a},e.fn.mapael.setHover=function(t,a,i){var n={},o={},s=0,l=function(){s=setTimeout(function(){e.fn.mapael.elemHover(t,a,i)},120)},r=function(){clearTimeout(s),e.fn.mapael.elemOut(t,a,i)};n=e(a.node),n.on("mouseover",l),n.on("mouseout",r),i&&(o=e(i.node),o.on("mouseover",l),e(i.node).on("mouseout",r))},e.fn.mapael.elemHover=function(e,t,a){t.animate(t.attrsHover,t.attrsHover.animDuration),a&&a.animate(a.attrsHover,a.attrsHover.animDuration),e.safari()},e.fn.mapael.elemOut=function(e,t,a){t.animate(t.originalAttrs,t.attrsHover.animDuration),a&&a.animate(a.originalAttrs,a.attrsHover.animDuration),e.safari()},e.fn.mapael.getElemOptions=function(t,a,i){var n=e.extend(!0,{},t,a);return"undefined"!=typeof n.value&&e.extend(!0,n,e.fn.mapael.getLegendSlice(n.value,i)),n},e.fn.mapael.getTextPosition=function(e,t){var a=0,i=0,n="";switch(t){case"bottom":a=(e.x+e.x2)/2,i=e.y2+15,n="middle";break;case"top":a=(e.x+e.x2)/2,i=e.y-15,n="middle";break;case"left":a=e.x-10,i=(e.y+e.y2)/2,n="end";break;case"right":a=e.x2+10,i=(e.y+e.y2)/2,n="start";break;default:a=(e.x+e.x2)/2,i=(e.y+e.y2)/2,n="middle"}return{x:a,y:i,textAnchor:n}},e.fn.mapael.getLegendSlice=function(e,t){for(var a=0,i=t.slices.length;i>a;++a)if((!t.slices[a].min||e>=t.slices[a].min)&&(!t.slices[a].max||e<t.slices[a].max))return t.slices[a];return{}},e.fn.mapael.defaultOptions={map:{cssClass:"map",tooltip:{cssClass:"mapTooltip"},defaultArea:{attrs:{fill:"#343434",stroke:"#5d5d5d","stroke-width":1,"stroke-linejoin":"round"},attrsHover:{fill:"#f38a03",animDuration:300},textPosition:"inner",textAttrs:{"font-size":15,fill:"#c7c7c7"},textAttrsHover:{fill:"#eaeaea",animDuration:300}},defaultPlot:{type:"circle",size:15,attrs:{fill:"#0088db",stroke:"#fff","stroke-width":0,"stroke-linejoin":"round"},attrsHover:{"stroke-width":3,animDuration:300},textPosition:"right",textAttrs:{"font-size":15,fill:"#c7c7c7"},textAttrsHover:{fill:"#eaeaea",animDuration:300}},zoom:{enabled:!1,maxLevel:5,step:.25,zoomInCssClass:"zoomIn",zoomOutCssClass:"zoomOut"}},legend:{area:{cssClass:"areaLegend",display:!1,marginLeft:15,marginLeftTitle:5,marginLeftLabel:10,marginBottom:15,titleAttrs:{"font-size":18,fill:"#343434","text-anchor":"start"},labelAttrs:{"font-size":15,fill:"#343434","text-anchor":"start"},hideElemsOnClick:{enabled:!0,opacity:.2},slices:[]},plot:{cssClass:"plotLegend",display:!1,marginLeft:15,marginLeftTitle:5,marginLeftLabel:10,marginBottom:15,titleAttrs:{"font-size":18,fill:"#343434","text-anchor":"start"},labelAttrs:{"font-size":15,fill:"#343434","text-anchor":"start"},hideElemsOnClick:{enabled:!0,opacity:.2},slices:[]}},areas:{},plots:{}}}(jQuery);