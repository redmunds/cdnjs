/*
 *  cropit - v0.0.1
 *  Easy crop and zoom
 *  https://github.com/scottcheng/cropit
 *
 *  Made by Scott Cheng
 *  Based on https://github.com/yufeiliu/simple_image_uploader
 *  Under MIT License
 */
!function(a){var b;b=function(){function a(){}return a.prototype.setup=function(a,b,c,d){var e,f;return null==c&&(c=1),f=b.w/a.w,e=b.h/a.h,this.minZoom=(null!=d?d.fitWidth:void 0)&&!(null!=d?d.fitHeight:void 0)?f:(null!=d?d.fitHeight:void 0)&&!(null!=d?d.fitWidth:void 0)?e:(null!=d?d.fitWidth:void 0)&&(null!=d?d.fitHeight:void 0)?e>f?f:e:e>f?e:f,this.maxZoom=this.minZoom<1/c?1/c:this.minZoom},a.prototype.getZoom=function(a){return this.minZoom&&this.maxZoom?a*(this.maxZoom-this.minZoom)+this.minZoom:null},a.prototype.isZoomable=function(){return this.minZoom&&this.maxZoom?this.minZoom!==this.maxZoom:null},a}();var c,d;d={exportZoom:1,imageBackground:!1,imageBackgroundBorderSize:0,imageState:null},c=function(){function c(b,c){var e;this.element=b,this.$el=a(this.element),e={$fileInput:this.$('input[name="image"]'),$preview:this.$(".image-preview"),$imageZoomInput:this.$(".image-zoom-level"),$previewContainer:this.$(".image-preview-container")},this.options=a.extend({},d,e,c),this._defaults=d,this.init()}return c.prototype.init=function(){var c,d,e,f,g,h,i,j;return this.$fileInput=this.options.$fileInput,this.$preview=this.options.$preview,this.$imageZoomInput=this.options.$imageZoomInput,this.$hiddenImage=a("<img />").addClass("image-hidden-preview").attr({alt:"",style:"display: none;"}).appendTo(this.$el),this.options.width&&this.$preview.width(this.options.width),this.options.height&&this.$preview.height(this.options.height),this.previewSize={w:this.options.width||this.$preview.width(),h:this.options.height||this.$preview.height()},this.options.imageBackground&&(e=this.options.imageBackgroundBorderSize,d=this.options.$previewContainer,this.$imageBg=a("<img />").addClass("image-background").attr("alt","").css("position","absolute"),c=a("<div />").addClass("image-background-container").css({position:"absolute",zIndex:0,top:-e,left:-e,width:this.previewSize.w+2*e,height:this.previewSize.h+2*e}).append(this.$imageBg),d.css("position","relative").prepend(c),this.$preview.css("position","relative"),this.imageBgPreviewOffset={x:e+window.parseInt(this.$preview.css("border-left-width")),y:e+window.parseInt(this.$preview.css("border-top-width"))}),this.initialZoomSliderPos=0,this.disabled=!0,this.imageSrc=(null!=(f=this.options.imageState)?f.src:void 0)||null,this.offset=(null!=(g=this.options.imageState)?g.offset:void 0)||{x:0,y:0},this.zoom=(null!=(h=this.options.imageState)?h.zoom:void 0)||null,this.sliderPos=(null!=(i=this.options.imageState)?i.sliderPos:void 0)||this.initialZoomSliderPos,this.$imageZoomInput.val(this.sliderPos),this.moveContinue=!1,this.zoomer=new b,this.$preview.on("mousedown mouseup mouseleave",this.handlePreviewEvent.bind(this)),this.$fileInput.on("change",this.onFileChange.bind(this)),this.$imageZoomInput.on("change mousemove",this.updateImageZoom.bind(this)),(null!=(j=this.options.imageState)?j.src:void 0)?this.loadImage():void 0},c.prototype.onFileChange=function(){var a,b,c;return"function"==typeof(c=this.options).onFileChange&&c.onFileChange(),b=new FileReader,a=this.$fileInput.get(0).files[0],b.readAsDataURL(a),b.onload=this.onFileReaderLoaded.bind(this)},c.prototype.onFileReaderLoaded=function(a){return this.imageSrc=a.target.result,this.sliderPos=this.initialZoomSliderPos,this.offset={x:0,y:0},this.loadImage()},c.prototype.loadImage=function(){var a;return this.$hiddenImage.attr("src",this.imageSrc),this.$preview.css("background-image","url("+this.imageSrc+")"),"function"==typeof(a=this.options).onImageLoading&&a.onImageLoading(),this.$hiddenImage.load(this.onImageLoaded.bind(this))},c.prototype.onImageLoaded=function(){var a;return this.options.imageBackground&&this.$imageBg.attr("src",this.imageSrc),this.imageSize={w:this.$hiddenImage.width(),h:this.$hiddenImage.height()},this.zoomer.setup(this.imageSize,this.previewSize,this.options.exportZoom,this.options),this.$imageZoomInput.val(this.sliderPos),this.zoom=this.zoomer.getZoom(this.sliderPos),this.updateImageZoom(),this.disabled=!1,"function"==typeof(a=this.options).onImageLoaded?a.onImageLoaded():void 0},c.prototype.handlePreviewEvent=function(b){return this.disabled?void 0:(this.moveContinue=!1,this.$preview.off("mousemove"),"mousedown"===b.type?(this.origin={x:b.clientX,y:b.clientY},this.moveContinue=!0,this.$preview.on("mousemove",this.onMove.bind(this))):a(document.body).focus(),b.stopPropagation(),!1)},c.prototype.onMove=function(a){return this.moveContinue&&this.updateImageOffset({x:this.offset.x+a.clientX-this.origin.x,y:this.offset.y+a.clientY-this.origin.y}),this.origin={x:a.clientX,y:a.clientY},a.stopPropagation(),!1},c.prototype.updateImageOffset=function(a){var b,c;if((null!=(b=this.imageSize)?b.w:void 0)&&(null!=(c=this.imageSize)?c.h:void 0))return this.offset=this.fixOffset(a),this.$preview.css("background-position",""+this.offset.x+"px "+this.offset.y+"px"),this.options.imageBackground?this.$imageBg.css({left:this.offset.x+this.imageBgPreviewOffset.x,top:this.offset.y+this.imageBgPreviewOffset.y}):void 0},c.prototype.fixOffset=function(a){var b;return b={x:a.x,y:a.y},this.imageSize.w*this.zoom<=this.previewSize.w?b.x=0:b.x>0?b.x=0:b.x+this.imageSize.w*this.zoom<this.previewSize.w&&(b.x=this.previewSize.w-this.imageSize.w*this.zoom),this.imageSize.h*this.zoom<=this.previewSize.h?b.y=0:b.y>0?b.y=0:b.y+this.imageSize.h*this.zoom<this.previewSize.h&&(b.y=this.previewSize.h-this.imageSize.h*this.zoom),b.x=Math.round(b.x),b.y=Math.round(b.y),b},c.prototype.updateImageZoom=function(){var a,b,c,d,e,f,g,h;if((null!=(g=this.imageSize)?g.w:void 0)&&(null!=(h=this.imageSize)?h.h:void 0))return this.sliderPos=Number(this.$imageZoomInput.val()),c=this.zoomer.getZoom(this.sliderPos),f=Math.round(this.imageSize.w*c),e=Math.round(this.imageSize.h*c),d=this.zoom,a=this.imageSize.w*d/2+this.offset.x-f/2,b=this.imageSize.h*d/2+this.offset.y-e/2,this.zoom=c,this.updateImageOffset({x:a,y:b}),this.$preview.css("background-size",""+f+"px "+e+"px"),this.options.imageBackground?this.$imageBg.css({width:f,height:e}):void 0},c.prototype.isZoomable=function(){return this.zoomer.isZoomable()},c.prototype.getCroppedImageData=function(){var b,c,d;return this.imageSrc?(d={w:this.previewSize.w,h:this.previewSize.h},this.options.fitHeight&&!this.options.fitWidth&&this.imageSize.w*this.zoom<this.previewSize.w?d.w=this.imageSize.w*this.zoom:this.options.fitWidth&&!this.options.fitHeight&&this.imageSize.h*this.zoom<this.previewSize.h&&(d.h=this.imageSize.h*this.zoom),b=a("<canvas />").attr({style:"display: none;",width:d.w*this.options.exportZoom,height:d.h*this.options.exportZoom}).appendTo(this.$el),c=b[0].getContext("2d"),c.drawImage(this.$hiddenImage[0],this.offset.x*this.options.exportZoom,this.offset.y*this.options.exportZoom,this.zoom*this.options.exportZoom*this.imageSize.w,this.zoom*this.options.exportZoom*this.imageSize.h),b[0].toDataURL()):null},c.prototype.getImageState=function(){return{src:this.imageSrc,offset:this.offset,zoom:this.zoom,sliderPos:this.sliderPos}},c.prototype.getImageSize=function(){return this.imageSize?{width:this.imageSize.w,height:this.imageSize.h}:null},c.prototype.$=function(a){return this.$el?this.$el.find(a):null},c}()}(window.jQuery);