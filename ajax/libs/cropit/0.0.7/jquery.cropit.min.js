/*
 *  cropit - v0.0.7
 *  Customizable crop and zoom.
 *  https://github.com/scottcheng/cropit
 *
 *  Made by Scott Cheng
 *  Based on https://github.com/yufeiliu/simple_image_uploader
 *  Under MIT License
 */
!function(a){var b;b=function(){function a(){}return a.prototype.setup=function(a,b,c,d){var e,f;return null==c&&(c=1),f=b.w/a.w,e=b.h/a.h,this.minZoom=(null!=d?d.fitWidth:void 0)&&!(null!=d?d.fitHeight:void 0)?f:(null!=d?d.fitHeight:void 0)&&!(null!=d?d.fitWidth:void 0)?e:(null!=d?d.fitWidth:void 0)&&(null!=d?d.fitHeight:void 0)?e>f?f:e:e>f?e:f,this.maxZoom=this.minZoom<1/c?1/c:this.minZoom},a.prototype.getZoom=function(a){return this.minZoom&&this.maxZoom?a*(this.maxZoom-this.minZoom)+this.minZoom:null},a.prototype.getSliderPos=function(a){return this.minZoom&&this.maxZoom?this.minZoom===this.maxZoom?0:(a-this.minZoom)/(this.maxZoom-this.minZoom):null},a.prototype.isZoomable=function(){return this.minZoom&&this.maxZoom?this.minZoom!==this.maxZoom:null},a.prototype.fixZoom=function(a){return a<this.minZoom?this.minZoom:a>this.maxZoom?this.maxZoom:a},a}();var c,d;d={exportZoom:1,imageBackground:!1,imageBackgroundBorderWidth:0,imageState:null},c=function(){function c(b,c){var e;this.element=b,this.$el=a(this.element),e={$fileInput:this.$("input.cropit-image-input"),$preview:this.$(".cropit-image-preview"),$imageZoomInput:this.$("input.cropit-image-zoom-input"),$previewContainer:this.$(".cropit-image-preview-container")},this.options=a.extend({},d,e,c),this._defaults=d,this.init()}return c.prototype.init=function(){var c,d,e,f,g,h;return this.$fileInput=this.options.$fileInput.attr({accept:"image/*"}),this.$preview=this.options.$preview.css({backgroundRepeat:"no-repeat"}),this.$imageZoomInput=this.options.$imageZoomInput.attr({min:0,max:1,step:.01}),this.$hiddenImage=a("<img />").addClass("cropit-image-hidden-preview").attr({alt:"",style:"display: none;"}).appendTo(this.$el),this.previewSize={w:this.options.width||this.$preview.width(),h:this.options.height||this.$preview.height()},this.options.width&&this.$preview.width(this.previewSize.w),this.options.height&&this.$preview.height(this.previewSize.h),this.options.imageBackground&&(d=this.options.imageBackgroundBorderWidth,c=this.options.$previewContainer,this.$imageBg=a("<img />").addClass("cropit-image-background").attr("alt","").css("position","absolute"),this.$imageBgContainer=a("<div />").addClass("cropit-image-background-container").css({position:"absolute",zIndex:0,top:-d,left:-d,width:this.previewSize.w+2*d,height:this.previewSize.h+2*d}).append(this.$imageBg),d>0&&this.$imageBgContainer.css({overflow:"hidden"}),c.css("position","relative").prepend(this.$imageBgContainer),this.$preview.css("position","relative"),this.imageBgPreviewOffset={x:d+window.parseInt(this.$preview.css("border-left-width")),y:d+window.parseInt(this.$preview.css("border-top-width"))}),this.initialOffset={x:0,y:0},this.initialZoom=0,this.initialSliderPos=0,this.imageLoaded=!1,this.imageSrc=(null!=(e=this.options.imageState)?e.src:void 0)||null,this.setOffset((null!=(f=this.options.imageState)?f.offset:void 0)||this.initialOffset),this.zoom=(null!=(g=this.options.imageState)?g.zoom:void 0)||this.initialZoom,this.$imageZoomInput.val(this.initialSliderPos),this.moveContinue=!1,this.zoomer=new b,this.$preview.on("mousedown mouseup mouseleave",this.handlePreviewEvent.bind(this)),this.$fileInput.on("change",this.onFileChange.bind(this)),this.$imageZoomInput.on("mousedown mouseup mousemove",this.updateSliderPos.bind(this)),(null!=(h=this.options.imageState)?h.src:void 0)?this.loadImage():void 0},c.prototype.onFileChange=function(){var a,b,c;return"function"==typeof(c=this.options).onFileChange&&c.onFileChange(),b=new FileReader,a=this.$fileInput.get(0).files[0],(null!=a?a.type.match("image"):void 0)?(this.setImageLoadingClass(),b.readAsDataURL(a),b.onload=this.onFileReaderLoaded.bind(this)):void 0},c.prototype.onFileReaderLoaded=function(a){return this.imageSrc=a.target.result,this.zoom=this.initialZoom,this.setOffset(this.initialOffset),this.loadImage()},c.prototype.loadImage=function(){var a;return this.$hiddenImage.attr("src",this.imageSrc),"function"==typeof(a=this.options).onImageLoading&&a.onImageLoading(),this.setImageLoadingClass(),this.$hiddenImage.load(this.onImageLoaded.bind(this))},c.prototype.onImageLoaded=function(){var a;return this.setImageLoadedClass(),this.$preview.css("background-image","url("+this.imageSrc+")"),this.options.imageBackground&&this.$imageBg.attr("src",this.imageSrc),this.imageSize={w:this.$hiddenImage.width(),h:this.$hiddenImage.height()},this.setupZoomer(),this.imageLoaded=!0,"function"==typeof(a=this.options).onImageLoaded?a.onImageLoaded():void 0},c.prototype.setImageLoadingClass=function(){return this.$preview.removeClass("cropit-image-loaded").addClass("cropit-image-loading")},c.prototype.setImageLoadedClass=function(){return this.$preview.removeClass("cropit-image-loading").addClass("cropit-image-loaded")},c.prototype.handlePreviewEvent=function(b){return this.imageLoaded?(this.moveContinue=!1,this.$preview.off("mousemove"),"mousedown"===b.type?(this.origin={x:b.clientX,y:b.clientY},this.moveContinue=!0,this.$preview.on("mousemove",this.onMove.bind(this))):a(document.body).focus(),b.stopPropagation(),!1):void 0},c.prototype.onMove=function(a){return this.moveContinue&&this.setOffset({x:this.offset.x+a.clientX-this.origin.x,y:this.offset.y+a.clientY-this.origin.y}),this.origin={x:a.clientX,y:a.clientY},a.stopPropagation(),!1},c.prototype.setOffset=function(a){return this.offset=this.fixOffset(a),this.$preview.css("background-position",""+this.offset.x+"px "+this.offset.y+"px"),this.options.imageBackground?this.$imageBg.css({left:this.offset.x+this.imageBgPreviewOffset.x,top:this.offset.y+this.imageBgPreviewOffset.y}):void 0},c.prototype.fixOffset=function(a){var b;return this.imageLoaded?(b={x:a.x,y:a.y},this.imageSize.w*this.zoom<=this.previewSize.w?b.x=0:b.x>0?b.x=0:b.x+this.imageSize.w*this.zoom<this.previewSize.w&&(b.x=this.previewSize.w-this.imageSize.w*this.zoom),this.imageSize.h*this.zoom<=this.previewSize.h?b.y=0:b.y>0?b.y=0:b.y+this.imageSize.h*this.zoom<this.previewSize.h&&(b.y=this.previewSize.h-this.imageSize.h*this.zoom),b.x=Math.round(b.x),b.y=Math.round(b.y),b):a},c.prototype.updateSliderPos=function(){var a;if(this.imageLoaded)return this.sliderPos=Number(this.$imageZoomInput.val()),a=this.zoomer.getZoom(this.sliderPos),this.setZoom(a)},c.prototype.setupZoomer=function(){var a,b;return this.zoomer.setup(this.imageSize,this.previewSize,this.options.exportZoom,this.options),this.zoom=this.fixZoom(this.zoom),this.setZoom(this.zoom),this.isZoomable()?(this.$imageZoomInput.removeAttr("disabled"),"function"==typeof(a=this.options).onZoomEnabled?a.onZoomEnabled():void 0):(this.$imageZoomInput.attr("disabled",!0),"function"==typeof(b=this.options).onZoomDisabled?b.onZoomDisabled():void 0)},c.prototype.setZoom=function(a){var b,c,d,e,f;return a=this.fixZoom(a),f=Math.round(this.imageSize.w*a),e=Math.round(this.imageSize.h*a),d=this.zoom,b=this.imageSize.w*d/2+this.offset.x-f/2,c=this.imageSize.h*d/2+this.offset.y-e/2,this.zoom=a,this.setOffset({x:b,y:c}),this.sliderPos=this.zoomer.getSliderPos(this.zoom),this.$imageZoomInput.val(this.sliderPos),this.$preview.css("background-size",""+f+"px "+e+"px"),this.options.imageBackground?this.$imageBg.css({width:f,height:e}):void 0},c.prototype.fixZoom=function(a){return this.zoomer.fixZoom(a)},c.prototype.isZoomable=function(){return this.zoomer.isZoomable()},c.prototype.getCroppedImageData=function(){var b,c,d;return this.imageSrc?(d={w:this.previewSize.w,h:this.previewSize.h},this.options.fitHeight&&!this.options.fitWidth&&this.imageSize.w*this.zoom<this.previewSize.w?d.w=this.imageSize.w*this.zoom:this.options.fitWidth&&!this.options.fitHeight&&this.imageSize.h*this.zoom<this.previewSize.h&&(d.h=this.imageSize.h*this.zoom),b=a("<canvas />").attr({style:"display: none;",width:d.w*this.options.exportZoom,height:d.h*this.options.exportZoom}).appendTo(this.$el),c=b[0].getContext("2d"),c.drawImage(this.$hiddenImage[0],this.offset.x*this.options.exportZoom,this.offset.y*this.options.exportZoom,this.zoom*this.options.exportZoom*this.imageSize.w,this.zoom*this.options.exportZoom*this.imageSize.h),b[0].toDataURL()):null},c.prototype.getImageState=function(){return{src:this.imageSrc,offset:this.offset,zoom:this.zoom}},c.prototype.getImageSrc=function(){return this.imageSrc},c.prototype.getOffset=function(){return this.offset},c.prototype.getZoom=function(){return this.zoom},c.prototype.getImageSize=function(){return this.imageSize?{width:this.imageSize.w,height:this.imageSize.h}:null},c.prototype.getPreviewSize=function(){return{width:this.previewSize.w,height:this.previewSize.h}},c.prototype.setPreviewSize=function(a){return(null!=a?a.width:void 0)>0&&(null!=a?a.height:void 0)>0?(this.previewSize={w:a.width,h:a.height},this.$preview.css({width:this.previewSize.w,height:this.previewSize.h}),this.options.imageBackground&&this.$imageBgContainer.css({width:this.previewSize.w+2*this.options.imageBackgroundBorderWidth,height:this.previewSize.h+2*this.options.imageBackgroundBorderWidth}),this.imageLoaded?this.setupZoomer():void 0):void 0},c.prototype.$=function(a){return this.$el?this.$el.find(a):null},c}()}(window.jQuery);