var Proxy,fermata={};"undefined"==typeof window&&(fermata._node={url:require("url"),https:require("https"),http:require("http")},Proxy||(fermata._node.Proxy=require("node-proxy"))),fermata._extend=function(e,t){return Object.keys(t).forEach(function(r){e[r]=t[r]}),e},fermata._typeof2=function(e){return Array.isArray(e)?"array":typeof e},fermata._wrapTheWrapper=function(e){return Proxy||fermata._node?Proxy?Proxy.createFunction({getOwnPropertyDescriptor:function(e){},getPropertyDescriptor:function(e){},getPropertyNames:function(){return[]},enumerate:function(){return[]},defineProperty:function(){return!1},delete:function(){return!1},fix:function(){},get:function(t,r){return e(r)}},e):fermata._node.Proxy.createFunction({getOwnPropertyDescriptor:function(e){},enumerate:function(){return[]},delete:function(){return!1},fix:function(){},set:function(e,t,r){},get:function(t,r){return e(r)}},e):fermata._extend(e,{get:function(){e("get").apply(null,arguments)},put:function(){e("put").apply(null,arguments)},post:function(){e("post").apply(null,arguments)},delete:function(){e("delete").apply(null,arguments)}})},fermata._makeWrapper=function(e,t,r,n){return fermata._wrapTheWrapper(function(){var a=[].splice.call(arguments,0),o=fermata._typeof2(a[a.length-1]);if("undefined"===o)return e.url(r,n);if("function"===o){var i=a.pop(),u=a.pop(),s=a.pop()||{},p=r.pop();return e.request({method:p,path:r,query:n,headers:s,data:u,args:a},t,i)}var f="object"===o?e.combine(n,a.pop()):n,c=a.length?e.join(r,a):r;return fermata._makeWrapper(e,t,c,f)})},fermata.Site=function(e){this.base=e.url,"/"!==this.base.slice(-1)&&(this.base+="/"),e.user&&(this.basicAuth=e.user+":"+(e.password||""))},fermata.Site.prototype.combine=function(e,t){return fermata._extend(fermata._extend({},e),t)},fermata.Site.prototype.join=function(e,t){return e.concat(t)},fermata.Site.prototype.url=function(e,t){var r=e.map(function(e){return e.join?e.join("/"):encodeURIComponent(e)}).join("/"),n=Object.keys(t).map(function(e){var r=t[e];return"$"===e[0]&&(e=e.slice(1),"$"!==e[0]&&(r=JSON.stringify(r))),[].concat(r).map(function(t){return encodeURIComponent(e)+(null!==t?"="+encodeURIComponent(t):"")}).join("&")}).join("&");return this.base+r+(n?"?"+n:"")},fermata.Site.prototype.request=function(e,t,r){var n=JSON.stringify(e.data),a={responseType:"text",method:e.method,url:this.url(e.path,e.query),headers:{}};fermata._extend(a.headers,{"Content-Type":"application/json",Accept:"application/json"}),fermata._extend(a.headers,e.headers),a.basicAuth=this.basicAuth,t.send(a,n,function(e,t,n){if(null===e)return r(t);var a,o;try{o=JSON.parse(n)}catch(e){a=e,o=n}return"2"!==e.toFixed()[0]&&(a=Error("Bad status code from server: "+e)),r(a,o)})},fermata.Transport=function(){this.send=fermata._node?this.constructor._nodeSend:this.constructor._xhrSend},fermata.Transport.normalize=function(e){var t={};return Object.keys(e).forEach(function(r){var n=r.split("-").map(function(e){return e&&e[0].toUpperCase()+e.slice(1).toLowerCase()}).join("-");t[n]=e[r]}),t},fermata.Transport._xhrSend=function(e,t,r){var n=new XMLHttpRequest,a=[e.method,e.url,!0],o=fermata.Transport.normalize(e.headers);e.basicAuth&&(a=a.concat(e.basicAuth.split(":"))),n.open.apply(n,a),Object.keys(o).forEach(function(e){n.setRequestHeader(e,o[e])}),n.send(t),n.onreadystatechange=function(){if(this.readyState===(n.DONE||4))if(this.status){var e={};this.getAllResponseHeaders().split("\r\n").forEach(function(t){t&&(t=t.split(": "),e[t[0]]=t.slice(1).join(": "))}),r(this.status,fermata.Transport.normalize(e),this.responseText)}else r(null,Error("XHR request failed"))}},fermata.Transport._nodeSend=function(e,t,r){var n=fermata._node.url.parse(e.url),a="http:"!==n.protocol,o={host:n.hostname,port:n.port,method:e.method.toUpperCase(),path:n.pathname+(n.search||""),headers:{}};n.auth&&(o.headers.Authorization="Basic "+new Buffer(n.auth).toString("base64")),e.basicAuth&&(o.headers.Authorization="Basic "+new Buffer(e.basicAuth).toString("base64")),fermata._extend(o.headers,fermata.Transport.normalize(e.headers)),(t&&"GET"===o.method||"HEAD"===o.method)&&(console.warn("Ignoring data passed to GET or HEAD request."),t=null),"string"==typeof t&&(t=new Buffer(t,"utf8"),o.headers["Content-Type"]||(o.headers["Content-Type"]="text/plain;charset=UTF-8")),o=(a?fermata._node.https:fermata._node.http).request(o),t?(o.setHeader("Content-Length",t.length),o.write(t)):o.setHeader("Content-Length",0),o.end(),o.on("error",function(e){r(null,e)}),o.on("response",function(t){var n=new Buffer(0);t.on("data",function(e){var t=n;n=new Buffer(t.length+e.length),t.copy(n),e.copy(n,t.length)}),t.on("end",function(){"text"===e.responseType&&(n=n.toString("utf8")),r(t.statusCode,fermata.Transport.normalize(t.headers),n)})})},fermata.api=function(e){return fermata._makeWrapper(new fermata.Site(e),new fermata.Transport,[],{})},fermata._node&&(exports.api=fermata.api);
//# sourceMappingURL=fermata.min.js.map