!(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.cellx=e()})(this,(function(){"use strict";function t(){return String(++g)}function e(t,e){for(var i=Object.getOwnPropertyNames(e),n=0,s=i.length;n<s;n++){var r=i[n];Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r))}return t}function i(t){var i;t.Extends?(i=t.Extends,delete t.Extends):i=Object;var n;w.call(t,"constructor")?(n=t.constructor,delete t.constructor):n=i==Object?function(){}:function(){return i.apply(this,arguments)};var s=n.prototype=Object.create(i.prototype);return t.Implements&&(t.Implements.forEach((function(t){"function"==typeof t?(Object.keys(t).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})),e(s,t.prototype)):e(s,t)})),delete t.Implements),Object.keys(i).forEach((function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(i,t))})),t.Static&&(e(n,t.Static),delete t.Static),void 0===n.extend&&(n.extend=p),e(s,t),Object.defineProperty(s,"constructor",{configurable:!0,writable:!0,value:n}),n}function n(t,e){return t<e?-1:t>e?1:0}function s(){}function r(){if(B){B=!1,Q=!0;for(var t=J.get(X);;){var e=t&&t.shift();if(e){var i=e._level,n=e._changeEvent;if(!n){if(i>X||e._levelInRelease==-1){if(!t.length){if(X==q)break;t=J.get(++X)}continue}if(e.pull(),i=e._level,n=e._changeEvent,i>X){t.length||(t=J.get(++X));continue}}if(e._levelInRelease=-1,n){var s=X;e._fixedValue=e._value,e._changeEvent=null,e._handleEvent(n);for(var r=e._pushingIndex,h=e._slaves,l=0,a=h.length;l<a;l++){var o=h[l];o._level<=i&&(o._level=i+1),r>=o._pushingIndex&&(o._pushingIndex=r,o._changeEvent=null,o._addToRelease())}if(X!=s){t=J.get(X);continue}}if(!t.length){if(X==q)break;t=J.get(++X)}}else{if(X==q)break;t=J.get(++X)}}if(X=U,q=-1,Q=!1,$++,N){var u=N;N=null;for(var c=0,f=u.length;c<f;c++)u[c]()}}}function h(t,e){e(t)}function l(){var t=x.console;(t&&t.error||s).call(t||x,L.call(arguments,(function(t){return t===Object(t)&&t.stack||t})).join(" "))}function a(t,e){function i(t){var s=this;s&&s!=x||(s=i),w.call(s,E)||Object.defineProperty(s,E,{value:new S});var r=s[E].get(i);if(!r){if("dispose"===t&&arguments.length>=2)return;e=Object.create(e),e.owner=s,r=new nt(n,e),s[E].set(i,r)}switch(arguments.length){case 0:return r.get();case 1:return r.set(t),t;default:var h=t;switch(h){case"bind":return i=i.bind(s),i.constructor=a,i;case"unwrap":return r;default:var l=nt.prototype[h].apply(r,k.call(arguments,1));return l===r?i:l}}}e||(e={});var n=t;return i.constructor=a,(e.onChange||e.onError)&&i.call(e.owner||x),i}function o(t,e){return new R(t,"boolean"==typeof e?{adoptsValueChanges:e}:e)}function u(t,e){return new A(t,"boolean"==typeof e?{adoptsValueChanges:e}:e)}function c(t,e,i){var n="_"+e;return t[n]=i instanceof nt?i:new nt(i,{owner:t}),Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get:function(){return this[n].get()},set:function(t){this[n].set(t)}}),t}function f(t,e){return Object.keys(e).forEach((function(i){c(t,i,e[i])})),t}function _(t,e,i){return 3==arguments.length?c(t,e,i):f(t,e),t}var v={_handler:null,setHandler:function(t){this._handler=t},log:function(){this._handler.apply(this,arguments)}},g=0,d=Function("return this;")().Symbol;d||(d=function(e){return"__"+e+"_"+Math.floor(1e9*Math.random())+"_"+t()+"__"},d.iterator=d("Symbol.iterator"));var p,m=d,y=m("cellx.uid"),E=m("cellx.cells"),x=Function("return this;")(),b=Object.is||function(t,e){return 0===t&&0===e?1/t==1/e:t===e||t!=t&&e!=e},w=Object.prototype.hasOwnProperty;p=function(t){return t.Extends=this,i(t)};var C=x.Map;if(!C){var V={value:void 0};C=i({constructor:function(t){if(this._entries=Object.create(null),this._objectStamps={},this._first=null,this._last=null,this.size=0,t)for(var e=0,i=t.length;e<i;e++)this.set(t[e][0],t[e][1])},has:function(t){return!!this._entries[this._getValueStamp(t)]},get:function(t){return(this._entries[this._getValueStamp(t)]||V).value},set:function(t,e){var i=this._entries,n=this._getValueStamp(t);if(i[n])i[n].value=e;else{var s=i[n]={key:t,keyStamp:n,value:e,prev:this._last,next:null};this.size++?this._last.next=s:this._first=s,this._last=s}return this},delete:function(t){var e=this._getValueStamp(t),i=this._entries[e];if(!i)return!1;if(--this.size){var n=i.prev,s=i.next;n?n.next=s:this._first=s,s?s.prev=n:this._last=n}else this._first=null,this._last=null;return delete this._entries[e],delete this._objectStamps[e],!0},clear:function(){var t=this._entries;for(var e in t)delete t[e];this._objectStamps={},this._first=null,this._last=null,this.size=0},_getValueStamp:function(t){switch(typeof t){case"undefined":return"undefined";case"object":if(null===t)return"null";break;case"boolean":return"?"+t;case"number":return"+"+t;case"string":return","+t}return this._getObjectStamp(t)},_getObjectStamp:function(e){if(!w.call(e,y)){if(!Object.isExtensible(e)){var i,n=this._objectStamps;for(i in n)if(w.call(n,i)&&n[i]==e)return i;return i=t(),n[i]=e,i}Object.defineProperty(e,y,{value:t()})}return e[y]},forEach:function(t,e){for(var i=this._first;i;){t.call(e,i.value,i.key,this);do i=i.next;while(i&&!this._entries[i.keyStamp])}},toString:function(){return"[object Map]"}}),[["keys",function(t){return t.key}],["values",function(t){return t.value}],["entries",function(t){return[t.key,t.value]}]].forEach((function(t){var e=t[1];C.prototype[t[0]]=function(){var t,i=this._entries,n=!1,s=this;return{next:function(){if(!n){if(t){do t=t.next;while(t&&!i[t.keyStamp])}else t=s._first;if(t)return{value:e(t),done:!1};n=!0}return{value:void 0,done:!0}}}}}))}C.prototype[m.iterator]||(C.prototype[m.iterator]=C.prototype.entries);var S=C,j=m("cellx.EventEmitter~isEmitterEvent"),I=m("cellx.EventEmitter.inner"),O=i({Static:{KEY_INNER:I},constructor:function(){this._events=new S},getEvents:function(t){if(t){var e=this._events&&this._events.get(t);return e?e._isEmitterEvent===j?[e]:e:[]}var i=Object.create(null);return this._events.forEach((function(t,e){i[e]=t._isEmitterEvent===j?[t]:t})),i},on:function(t,e,i){if("object"==typeof t){i=arguments.length>=2?e:this;var n=t;for(t in n)this._on(t,n[t],i)}else this._on(t,e,arguments.length>=3?i:this);return this},off:function(t,e,i){var n=arguments.length;if(n)if("object"==typeof t){i=n>=2?e:this;var s=t;for(t in s)this._off(t,s[t],i)}else this._off(t,e,n>=3?i:this);else this._events&&this._events.clear();return this},_on:function(t,e,i){var n=t.indexOf(":");if(n!=-1)this["_"+t.slice(n+1)].on(t.slice(0,n),e,i);else{var s=(this._events||(this._events=new S)).get(t),r={_isEmitterEvent:j,listener:e,context:i};s?s._isEmitterEvent===j?this._events.set(t,[s,r]):s.push(r):this._events.set(t,r)}},_off:function(t,e,i){var n=t.indexOf(":");if(n!=-1)this["_"+t.slice(n+1)].off(t.slice(0,n),e,i);else{var s=this._events&&this._events.get(t);if(!s)return;if(s._isEmitterEvent===j)s.listener!=e&&s.listener[I]!==e||s.context!==i||this._events.delete(t);else{var r=s.length;if(1==r){var h=s[0];h.listener!=e&&h.listener[I]!==e||h.context!==i||this._events.delete(t)}else for(var l=r;l;){var a=s[--l];if((a.listener==e||a.listener[I]===e)&&a.context===i){s.splice(l,1);break}}}}},once:function(t,e,i){function n(){return this._off(t,n,i),e.apply(this,arguments)}return arguments.length<3&&(i=this),n[I]=e,this._on(t,n,i),this},emit:function(t){if("string"==typeof t)t={target:this,type:t};else if(t.target){if(t.target!=this)throw new TypeError("Event cannot be emitted on this object")}else t.target=this;return this._handleEvent(t),t},_handleEvent:function(t){var e=this._events&&this._events.get(t.type);if(e)if(e._isEmitterEvent===j)this._tryEventListener(e,t)===!1&&(t.isPropagationStopped=!0);else{var i=e.length;if(1==i)this._tryEventListener(e[0],t)===!1&&(t.isPropagationStopped=!0);else{e=e.slice();for(var n=0;n<i;n++)this._tryEventListener(e[n],t)===!1&&(t.isPropagationStopped=!0)}}},_tryEventListener:function(t,e){try{return t.listener.call(t.context,e)}catch(t){this._logError(t)}},_logError:function(){v.log.apply(v,arguments)}}),P=O.extend({constructor:function(){this._valueCounts=new S},_onItemChange:function(t){this._handleEvent(t)},_registerValue:function(t){var e=this._valueCounts,i=e.get(t);i?e.set(t,i+1):(e.set(t,1),this.adoptsValueChanges&&t instanceof O&&t.on("change",this._onItemChange,this))},_unregisterValue:function(t){var e=this._valueCounts,i=e.get(t);i>1?e.set(t,i-1):(e.delete(t),this.adoptsValueChanges&&t instanceof O&&t.off("change",this._onItemChange,this))}}),R=O.extend({Implements:[P],constructor:function t(e,i){if(O.call(this),P.call(this),this._entries=new S,this.size=0,this.adoptsValueChanges=!(!i||!i.adoptsValueChanges),e){var n=this._entries;if(e instanceof t||e instanceof S)e._entries.forEach((function(t,e){this._registerValue(t),n.set(e,t)}),this);else if(Array.isArray(e))for(var s=0,r=e.length;s<r;s++){var h=e[s];this._registerValue(h[1]),n.set(h[0],h[1])}else for(var l in e)this._registerValue(e[l]),n.set(l,e[l]);this.size=n.size}},has:function(t){return this._entries.has(t)},contains:function(t){return this._valueCounts.has(t)},get:function(t){return this._entries.get(t)},set:function(t,e){var i,n=this._entries,s=n.has(t);if(s){if(i=n.get(t),b(e,i))return this;this._unregisterValue(i)}return this._registerValue(e),n.set(t,e),s||this.size++,this.emit({type:"change",subtype:s?"update":"add",key:t,oldValue:i,value:e}),this},delete:function(t){var e=this._entries;if(!e.has(t))return!1;var i=e.get(t);return this._unregisterValue(i),e.delete(t),this.size--,this.emit({type:"change",subtype:"delete",key:t,oldValue:i,value:void 0}),!0},clear:function(){return this.size?(this.adoptsValueChanges&&this._valueCounts.forEach((function(t){t instanceof O&&t.off("change",this._onItemChange,this)}),this),this._entries.clear(),this._valueCounts.clear(),this.size=0,this.emit({type:"change",subtype:"clear"}),this):this},forEach:function(t,e){this._entries.forEach((function(i,n){t.call(e,i,n,this)}),this)},keys:function(){return this._entries.keys()},values:function(){return this._entries.values()},entries:function(){return this._entries.entries()},clone:function(){return new this.constructor(this,{adoptsValueChanges:this.adoptsValueChanges})}});R.prototype[m.iterator]=R.prototype.entries;var k=Array.prototype.slice,F=Array.prototype.push,T=Array.prototype.splice,L=Array.prototype.map,A=O.extend({Implements:[P],constructor:function(t,e){O.call(this),P.call(this),e||(e={}),this._items=[],this.length=0,this.adoptsValueChanges=!!e.adoptsValueChanges,this.comparator=null,this.sorted=!1,(e.sorted||e.comparator&&e.sorted!==!1)&&(this.comparator=e.comparator||n,this.sorted=!0),t&&this._addRange(t)},_validateIndex:function(t,e){if(void 0===t)return t;if(t<0){if(t+=this.length,t<0)throw new RangeError("Index out of valid range")}else if(t>=this.length+(e?1:0))throw new RangeError("Index out of valid range");return t},contains:function(t){return this._valueCounts.has(t)},indexOf:function(t,e){return this._items.indexOf(t,this._validateIndex(e))},lastIndexOf:function(t,e){return this._items.lastIndexOf(t,void 0===e?-1:this._validateIndex(e))},get:function(t){return this._items[this._validateIndex(t,!0)]},getRange:function(t,e){t=this._validateIndex(t,!0);var i=this._items;if(void 0===e)return i.slice(t);if(t+e>i.length)throw new RangeError('Sum of "index" and "count" out of valid range');return i.slice(t,t+e)},set:function(t,e){if(this.sorted)throw new TypeError("Cannot set to sorted list");t=this._validateIndex(t);var i=this._items;return b(e,i[t])?this:(this._unregisterValue(i[t]),this._registerValue(e),i[t]=e,this.emit("change"),this)},setRange:function(t,e){if(this.sorted)throw new TypeError("Cannot set to sorted list");t=this._validateIndex(t),e instanceof A&&(e=e._items);var i=e.length;if(!i)return this;if(t+i>this.length)throw new RangeError('Sum of "index" and "values.length" out of valid range');for(var n=this._items,s=!1,r=t+i;r>t;){var h=e[--r-t];b(h,n[r])||(this._unregisterValue(n[r]),this._registerValue(h),n[r]=h,s=!0)}return s&&this.emit("change"),this},add:function(t){return this.sorted?this._insertValue(t):(this._registerValue(t),this._items.push(t)),this.length++,this.emit("change"),this},addRange:function(t){return t.length&&(this._addRange(t),this.emit("change")),this},_addRange:function(t){if(t instanceof A&&(t=t._items),this.sorted){for(var e=0,i=t.length;e<i;e++)this._insertValue(t[e]);this.length+=t.length}else{for(var n=t.length;n;)this._registerValue(t[--n]);this.length=F.apply(this._items,t)}},_insertValue:function(t){this._registerValue(t);for(var e=this._items,i=this.comparator,n=0,s=e.length;n!=s;){var r=n+s>>1;i(t,e[r])<0?s=r:n=r+1}e.splice(n,0,t)},insert:function(t,e){if(this.sorted)throw new TypeError("Cannot insert to sorted list");return t=this._validateIndex(t,!0),this._registerValue(e),this._items.splice(t,0,e),this.length++,this.emit("change"),this},insertRange:function(t,e){if(this.sorted)throw new TypeError("Cannot insert to sorted list");t=this._validateIndex(t,!0),e instanceof A&&(e=e._items);var i=e.length;if(!i)return this;for(var n=i;n;)this._registerValue(e[--n]);return T.apply(this._items,[t,0].concat(e)),this.length+=i,this.emit("change"),this},remove:function(t,e){var i=this._items.indexOf(t,this._validateIndex(e));return i!=-1&&(this._unregisterValue(t),this._items.splice(i,1),this.length--,this.emit("change"),!0)},removeAll:function(t,e){for(var i=this._validateIndex(e),n=this._items,s=!1;(i=n.indexOf(t,i))!=-1;)this._unregisterValue(t),n.splice(i,1),s=!0;return s&&(this.length=n.length,this.emit("change")),s},removeEach:function(t,e){e=this._validateIndex(e),t instanceof A&&(t=t._items);for(var i=this._items,n=!1,s=0,r=t.length;s<r;s++){var h=t[s],l=i.indexOf(h,e);l!=-1&&(this._unregisterValue(h),i.splice(l,1),n=!0)}return n&&(this.length=i.length,this.emit("change")),n},removeAllEach:function(t,e){e=this._validateIndex(e),t instanceof A&&(t=t._items);for(var i=this._items,n=!1,s=0,r=t.length;s<r;s++)for(var h=t[s],l=e;(l=i.indexOf(h,l))!=-1;)this._unregisterValue(h),i.splice(l,1),n=!0;return n&&(this.length=i.length,this.emit("change")),n},removeAt:function(t){var e=this._items.splice(this._validateIndex(t),1)[0];return this._unregisterValue(e),this.length--,this.emit("change"),e},removeRange:function(t,e){t=this._validateIndex(t,!0);var i=this._items;if(void 0===e)e=i.length-t;else if(t+e>i.length)throw new RangeError('Sum of "index" and "count" out of valid range');if(!e)return[];for(var n=t+e;n>t;)this._unregisterValue(i[--n]);var s=i.splice(t,e);return this.length-=e,this.emit("change"),s},clear:function(){return this.length?(this.adoptsValueChanges&&this._valueCounts.forEach((function(t){t instanceof O&&t.off("change",this._onItemChange,this)}),this),this._items.length=0,this._valueCounts.clear(),this.length=0,this.emit("change"),this):this},join:function(t){return this._items.join(t)},forEach:null,map:null,filter:null,find:function(t,e){for(var i=this._items,n=0,s=i.length;n<s;n++){var r=i[n];if(t.call(e,r,n,this))return r}},findIndex:function(t,e){for(var i=this._items,n=0,s=i.length;n<s;n++)if(t.call(e,i[n],n,this))return n;return-1},every:null,some:null,reduce:null,reduceRight:null,clone:function(){return new this.constructor(this,{adoptsValueChanges:this.adoptsValueChanges,comparator:this.comparator,sorted:this.sorted})},toArray:function(){return this._items.slice()},toString:function(){return this._items.join()}});["forEach","map","filter","every","some"].forEach((function(t){A.prototype[t]=function(e,i){return this._items[t]((function(t,n){return e.call(i,t,n,this)}),this)}})),["reduce","reduceRight"].forEach((function(t){A.prototype[t]=function(e,i){function n(t,i,n){return e(t,i,n,r)}var s=this._items,r=this;return arguments.length>=2?s[t](n,i):s[t](n)}})),[["keys",function(t){return t}],["values",function(t,e){return e}],["entries",function(t,e){return[t,e]}]].forEach((function(t){var e=t[1];A.prototype[t[0]]=function(){var t=this._items,i=0,n=!1;return{next:function(){if(!n){if(i<t.length)return{value:e(i,t[i++]),done:!1};n=!0}return{value:void 0,done:!0}}}}})),A.prototype[m.iterator]=A.prototype.values;var z;if(x.process&&"[object process]"==process.toString()&&process.nextTick)z=process.nextTick;else if(x.setImmediate)z=function(t){setImmediate(t)};else if(x.Promise&&Promise.toString().indexOf("[native code]")!=-1){var K=Promise.resolve();z=function(t){K.then((function(){t()}))}}else{var M;x.addEventListener("message",(function(){if(M){var t=M;M=null;for(var e=0,i=t.length;e<i;e++)try{t[e]()}catch(t){v.log(t)}}})),z=function(t){M?M.push(t):(M=[t],postMessage("__tic__","*"))}}var N,D=z,Y=O.prototype,U=Number.MAX_SAFE_INTEGER||9007199254740991,H=O.KEY_INNER,G=0,J=new S,X=U,q=-1,B=!1,Q=!1,W=null,Z={original:null},$=1,tt=0,et=[],it={asynchronous:!0},nt=O.extend({Static:{_nextTick:D,configure:function(t){void 0!==t.asynchronous&&(B&&r(),it.asynchronous=t.asynchronous)},autorun:function(t,e){var i=new nt(function(){if(tt){var i=et.indexOf(this);i>-1&&et.splice(i,1),et.push(this)}else t.call(e)},{onChange:s});return function(){i.dispose()}},forceRelease:function(){B&&r()},transaction:function(t){!tt++&&B&&r();var e;try{t(),e=!0}catch(t){v.log(t);for(var i,n=J.values();!(i=n.next()).done;)for(var s=i.value,h=s.length;h;){var l=s[--h];l._value=l._fixedValue,l._levelInRelease=-1,l._changeEvent=null}J.clear(),X=U,q=-1,B=!1,et.length=0,e=!1}if(!--tt&&e){for(var h=0,a=et.length;h<a;h++){var o=et[h];o instanceof nt?o.pull():Y._handleEvent.call(o[1],o[0])}et.length=0,B&&r()}},afterRelease:function(t){(N||(N=[])).push(t)}},constructor:function(t,e){O.call(this),e||(e={});var i=this;this.debugKey=e.debugKey,this.owner=e.owner||this,this._pull="function"==typeof t?t:null,this._get=e.get||null,this._validate=e.validate||null,this._merge=e.merge||null,this._put=e.put||h;var n=this.push,s=this.fail;this.push=function(t){n.call(i,t)},this.fail=function(t){s.call(i,t)},this._onFulfilled=this._onRejected=null,this._reap=e.reap||null,this._pull?this._fixedValue=this._value=void 0:(this._validate&&this._validate(t,void 0),this._merge&&(t=this._merge(t,void 0)),this._fixedValue=this._value=t,t instanceof O&&t.on("change",this._onValueChange,this)),this._error=null,this._errorCell=null,this._pushingIndex=0,this._version=0,this._inited=!1,this._currentlyPulling=!1,this._active=!1,this._hasFollowers=!1,this._masters=null,this._slaves=[],this._level=0,this._levelInRelease=-1,this._pending=!1,this._selfPendingStatusCell=null,this._pendingStatusCell=null,this._fulfilled=!1,this._rejected=!1,this._changeEvent=null,this._canCancelChange=!0,this._lastErrorEvent=null,e.onChange&&this.on("change",e.onChange),e.onError&&this.on("error",e.onError)},_handleEvent:function(t){tt?et.push([t,this]):Y._handleEvent.call(this,t)},on:function(t,e,i){return B&&r(),this._activate(),"object"==typeof t?Y.on.call(this,t,arguments.length>=2?e:this.owner):Y.on.call(this,t,e,arguments.length>=3?i:this.owner),this._hasFollowers=!0,this},off:function(t,e,i){B&&r();var n=arguments.length;return n?"object"==typeof t?Y.off.call(this,t,n>=2?e:this.owner):Y.off.call(this,t,e,n>=3?i:this.owner):Y.off.call(this),this._slaves.length||this._events.has("change")||this._events.has("error")||!this._hasFollowers||(this._hasFollowers=!1,this._deactivate(),this._reap&&this._reap.call(this.owner)),this},addChangeListener:function(t,e){return this.on("change",t,arguments.length>=2?e:this.owner)},removeChangeListener:function(t,e){return this.off("change",t,arguments.length>=2?e:this.owner)},addErrorListener:function(t,e){return this.on("error",t,arguments.length>=2?e:this.owner)},removeErrorListener:function(t,e){return this.off("error",t,arguments.length>=2?e:this.owner)},subscribe:function(t,e){function i(e){return t.call(this,e.error||null,e)}return i[H]=t,arguments.length<2&&(e=this.owner),this.on("change",i,e).on("error",i,e)},unsubscribe:function(t,e){return arguments.length<2&&(e=this.owner),this.off("change",t,e).off("error",t,e)},_registerSlave:function(t){this._activate(),this._slaves.push(t),this._hasFollowers=!0},_unregisterSlave:function(t){this._slaves.splice(this._slaves.indexOf(t),1),this._slaves.length||this._events.has("change")||this._events.has("error")||(this._hasFollowers=!1,this._deactivate(),this._reap&&this._reap.call(this.owner))},_activate:function(){if(this._pull&&!this._active&&(!this._inited||this._masters)){if(this._version<$){var t=this._tryPull();t===Z?this._fail(Z.original,!1):this._push(t,!1)}var e=this._masters;if(e){for(var i=e.length;i;)e[--i]._registerSlave(this);this._active=!0}}},_deactivate:function(){if(this._active){for(var t=this._masters,e=t.length;e;)t[--e]._unregisterSlave(this);this._levelInRelease==-1||this._changeEvent||(this._levelInRelease=-1),this._active=!1}},_addToRelease:function(){var t=this._level;if(!(t<=this._levelInRelease)){var e;(J.get(t)||(J.set(t,e=[]),e)).push(this),X>t&&(X=t),q<t&&(q=t),this._levelInRelease=t,B||Q||(B=!0,tt||it.asynchronous?nt._nextTick(r):r())}},_onValueChange:function(t){this._pushingIndex=++G,this._changeEvent?(t.prev=this._changeEvent,this._changeEvent=t,this._value===this._fixedValue&&(this._canCancelChange=!1)):(t.prev=null,this._changeEvent=t,this._canCancelChange=!1,this._addToRelease())},get:function(){if(B&&this._pull&&r(),this._pull&&!this._active&&this._version<$&&(!this._inited||this._masters)){var t=this._tryPull();if(this._hasFollowers){var e=this._masters;if(e){for(var i=e.length;i;)e[--i]._registerSlave(this);this._active=!0}}t===Z?this._fail(Z.original,!1):this._push(t,!1)}if(W){var n=W._masters,s=this._level;n?n.indexOf(this)==-1&&(n.push(this),W._level<=s&&(W._level=s+1)):(W._masters=[this],W._level=s+1)}return this._get?this._get(this._value):this._value},pull:function(){if(!this._pull)return!1;B&&r();var t,e,i=this._hasFollowers;i&&(t=this._masters,e=this._level);var n=this._tryPull();if(i){var s=this._masters,h=0;if(s)for(var l=s.length;l;){var a=s[--l];t&&t.indexOf(a)!=-1||(a._registerSlave(this),h++)}if(t&&(s?s.length-h:0)<t.length)for(var o=t.length;o;){var u=t[--o];s&&s.indexOf(u)!=-1||u._unregisterSlave(this)}if(this._active=!(!s||!s.length),Q&&this._level>e)return this._addToRelease(),!1}return n===Z?(this._fail(Z.original,!1),!0):this._push(n,!1)},_tryPull:function(){if(this._currentlyPulling)throw new TypeError("Circular pulling detected");this._pending=!0,this._fulfilled=this._rejected=!1,this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!0);var t=W;W=this,this._currentlyPulling=!0,this._masters=null,this._level=0;try{return this._pull.call(this.owner,this.push,this.fail,this._value)}catch(t){return Z.original=t,Z}finally{W=t,this._version=$+Q,this._inited=!0,this._currentlyPulling=!1}},getError:function(){return W?(this._errorCell||(this._errorCell=new nt(this._error))).get():this._error},set:function(t){var e=this._value;return this._validate&&this._validate(t,e),this._merge&&(t=this._merge(t,e)),this._put.call(this.owner,t,this.push,this.fail,e),this},push:function(t){return this._push(t,!0),this},_push:function(t,e){var i=this._value;if(e){if(Q){if(b(t,i))return this._setError(null),this._fulfill(t),!1;var n=this;return(N||(N=[])).push((function(){n._push(t,!0)})),!0}this._pushingIndex=++G}return this._setError(null),b(t,i)?(e&&this._fulfill(t),!1):(this._value=t,i instanceof O&&i.off("change",this._onValueChange,this),t instanceof O&&t.on("change",this._onValueChange,this),this._hasFollowers||tt?this._changeEvent?b(t,this._fixedValue)&&this._canCancelChange?(this._levelInRelease=-1,this._changeEvent=null):this._changeEvent={target:this,type:"change",oldValue:i,value:t,prev:this._changeEvent}:(this._changeEvent={target:this,type:"change",oldValue:i,value:t,prev:null},this._canCancelChange=!0,this._addToRelease()):(!Q&&e&&$++,this._fixedValue=t,this._version=$+Q),e&&this._fulfill(t),!0)},_fulfill:function(t){this._pending&&(this._pending=!1,this._fulfilled=!0,this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!1),this._onFulfilled&&this._onFulfilled(t))},fail:function(t){return this._fail(t,!0),this},_fail:function(t,e){this._logError(t),t instanceof Error||(t=new Error(String(t))),e&&this._reject(t),this._handleErrorEvent({type:"error",error:t})},_reject:function(t){this._pending&&(this._pending=!1,this._rejected=!0,this._selfPendingStatusCell&&this._selfPendingStatusCell.set(!1),this._onRejected&&this._onRejected(t))},_handleErrorEvent:function(t){if(this._lastErrorEvent!==t){this._setError(t.error),this._lastErrorEvent=t,this._handleEvent(t);for(var e=this._slaves,i=0,n=e.length;i<n;i++)e[i]._handleErrorEvent(t)}},_setError:function(t){if(this._error!==t&&(this._error=t,this._errorCell&&this._errorCell.set(t),!t))for(var e=this._slaves,i=0,n=e.length;i<n;i++)e[i]._setError(t)},isPending:function(){if(!this._selfPendingStatusCell){var t=this.debugKey,e=this._selfPendingStatusCell=new nt(this._pending,t?{debugKey:t+"._selfPendingStatusCell"}:null),i=this;this._pendingStatusCell=new nt(function(){if(e.get())return!0;i.get();var t=i._masters;if(t)for(var n=t.length;n;)if(t[--n].isPending())return!0;return!1},t?{debugKey:t+"._pendingStatusCell"}:null)}return this._pendingStatusCell.get()},then:function(t,e){if(B&&r(),!this._pull||this._fulfilled)return Promise.resolve(this._get?this._get(this._value):this._value).then(t);if(this._rejected)return Promise.reject(this._error).catch(e);var i=this,n=new Promise(function(t,e){i._onFulfilled=function(e){i._onFulfilled=i._onRejected=null,t(i._get?i._get(e):e)},i._onRejected=function(t){i._onFulfilled=i._onRejected=null,e(t)}}).then(t,e);return this._pending||this.pull(),n},catch:function(t){return this.then(null,t)},_logError:function(){var t=k.call(arguments);this.debugKey&&t.unshift("["+this.debugKey+"]"),Y._logError.apply(this,t)},dispose:function(){for(var t=this._slaves,e=0,i=t.length;e<i;e++)t[e].dispose();return this.off()}});return nt.prototype[m.iterator]=function(){return this._value[m.iterator]()},v.setHandler(l),a.configure=function(t){nt.configure(t)},a.ErrorLogger=v,a.EventEmitter=O,a.ObservableCollectionMixin=P,a.ObservableMap=R,a.ObservableList=A,a.Cell=nt,a.autorun=nt.autorun,a.transact=a.transaction=nt.transaction,a.KEY_UID=y,a.KEY_CELLS=E,a.map=o,a.list=u,a.defineObservableProperty=c,a.defineObservableProperties=f,a.define=_,a.JS=a.js={is:b,Symbol:m,Map:S},a.Utils=a.utils={logError:l,nextUID:t,mixin:e,createClass:i,nextTick:D,noop:s},a.cellx=a,a}));