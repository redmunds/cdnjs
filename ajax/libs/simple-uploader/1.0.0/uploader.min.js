(function(){var e,t={}.hasOwnProperty,r=function(e,r){function o(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return o.prototype=r.prototype,e.prototype=new o,e.__super__=r.prototype,e};e=function(e){function t(e){var r=this;null==e&&(e={}),$.extend(this.opts,e),this.id=++t.count,this.on("uploadcomplete",function(e,t){return r.files.splice($.inArray(t,r.files),1),r.queue.length>0&&r.files.length<r.opts.connectionCount?r.upload(r.queue.shift()):r.uploading=!1}),$(window).on("beforeunload.uploader-"+this.id,function(e){return r.uploading?(e.originalEvent.returnValue=r.opts.leaveConfirm,r.opts.leaveConfirm):void 0})}return r(t,e),t.count=0,t.prototype.opts={url:"",params:null,connectionCount:3,leaveConfirm:"正在上传文件，如果离开上传会自动取消"},t.prototype.files=[],t.prototype.queue=[],t.prototype.html5=!(!window.File||!window.FileList),t.prototype.generateId=function(){var e;return e=0,function(){return e+=1}}(),t.prototype.upload=function(e,t){var r,o,n;if(null==t&&(t={}),null!=e){if($.isArray(e))for(o=0,n=e.length;n>o;o++)r=e[o],this.upload(r,t);else $(e).is("input:file")&&this.html5?this.upload($.makeArray($(e)[0].files),t):e.id&&e.obj||(e=this.getFile(e));if(e&&e.obj){if($.extend(e,t),this.files.length>=this.opts.connectionCount)return void this.queue.push(e);if(this.triggerHandler("beforeupload",[e])!==!1)return this.files.push(e),this.html5?this.xhrUpload(e):this.iframeUpload(e),this.uploading=!0}}},t.prototype.getFile=function(e){var t,r,o;if(e instanceof window.File||e instanceof window.Blob)t=null!=(r=e.fileName)?r:e.name;else{if(!$(e).is("input:file"))return null;t=$input.val().replace(/.*(\/|\\)/,""),e=$(e).clone()}return{id:this.generateId(),url:this.opts.url,params:this.opts.params,name:t,size:null!=(o=e.fileSize)?o:e.size,ext:t?t.split(".").pop().toLowerCase():"",obj:e}},t.prototype.xhrUpload=function(e){var t,r,o,n,i=this;if(t=new FormData,t.append("upload_file",e.obj),t.append("original_filename",e.name),e.params){n=e.params;for(r in n)o=n[r],t.append(r,o)}return e.xhr=$.ajax({url:e.url,data:t,processData:!1,contentType:!1,type:"POST",headers:{"X-File-Name":encodeURIComponent(e.name)},xhr:function(){var e,t=this;return e=$.ajaxSettings.xhr(),e&&(e.upload.onprogress=function(e){return t.progress(e)}),e},progress:function(t){return t.lengthComputable?i.trigger("uploadprogress",[e,t.loaded,t.total]):void 0},error:function(t,r,o){return i.trigger("uploaderror",[e,t,r])},success:function(t){return i.trigger("uploadprogress",[e,e.size,e.size]),i.trigger("uploadsuccess",[e,t])},complete:function(t,r){return i.trigger("uploadcomplete",[e,t.responseText])}})},t.prototype.iframeUpload=function(e){var t,r,o,n=this;if(e.iframe=$("iframe",{src:"javascript:false;",name:"uploader-"+e.id}).hide().appendTo(document.body),e.form=$("<form/>",{method:"post",enctype:"multipart/form-data",action:e.url,target:e.iframe[0].name}).hide().append(e.obj).appendTo(document.body),e.params){o=e.params;for(t in o)r=o[t],$("<input/>",{type:"hidden",name:t,value:r}).appendTo(form)}return e.iframe.on("load",function(){var t,r,o,i,a;if(iframe.parent().length>0&&(r=iframe[0].contentDocument,!r||!r.body||"false"!==r.body.innerHTML)){i=r.getElementById("json-response"),o=i?i.innerHTML:r.body.innerHTML;try{a=$.parseJSON(o)}catch(l){t=l,n.trigger("uploaderror",[e,null,"parsererror"]),a={}}return a.success&&n.trigger("uploadsuccess",[e,a]),n.trigger("uploadcomplete",[e,a]),e.iframe.remove()}}),e.form.submit().remove()},t.prototype.cancel=function(e){var t,r,o,n;if(!e.id)for(n=this.files,r=0,o=n.length;o>r;r++)if(t=n[r],t.id===e){e=t;break}return this.trigger("uploadcancel",[e]),this.html5?(e.xhr&&e.xhr.abort(),e.xhr=null):(e.iframe.attr("src","javascript:false;").remove(),this.trigger("uploadcomplete",[e]))},t.prototype.readImageFile=function(e,t){var r,o;if($.isFunction(t))return o=new Image,o.onload=function(){return t(o)},o.onerror=function(){return t()},window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(e.type)?(r=new FileReader,r.onload=function(e){return o.src=e.target.result},r.readAsDataURL(e)):t()},t.prototype.destroy=function(){var e,t,r,o;for(this.queue.length=0,o=this.files,t=0,r=o.length;r>t;t++)e=o[t],this.cancel(e);return $(window).off(".uploader-"+this.id),$(document).off(".uploader-"+this.id)},t}(Module),this.simple||(this.simple={}),this.simple.uploader=function(t){return new e(t)}}).call(this);
