!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.reglInit=e()}}(function(){return function e(t,r,n){function a(o,f){if(!r[o]){if(!t[o]){var u="function"==typeof require&&require;if(!f&&u)return u(o,!0);if(i)return i(o,!0);var s=new Error("Cannot find module '"+o+"'");throw s.code="MODULE_NOT_FOUND",s}var c=r[o]={exports:{}};t[o][0].call(c.exports,function(e){var r=t[o][1][e];return a(r?r:e)},c,c.exports,e,t,r,n)}return r[o].exports}for(var i="function"==typeof require&&require,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(e,t,r){function n(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=a,this.offset=0,this.stride=0,this.divisor=0}var a=5126;t.exports=function(e,t,r,a,i){for(var o=r.maxAttributes,f=new Array(o),u=0;u<o;++u)f[u]=new n;return{Record:n,scope:{},state:f}}},{}],2:[function(e,t,r){function n(e){return 0|p[Object.prototype.toString.call(e)]}function a(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function i(e,t,r,n,a,i,o){for(var f=0,u=0;u<r;++u)for(var s=0;s<n;++s)e[f++]=t[a*u+i*s+o]}function o(e,t,r){for(var n=0,a=0;a<t.length;++a)for(var i=t[a],o=0;o<r;++o)e[n++]=i[o]}var f=e("./util/check"),u=e("./util/is-typed-array"),s=e("./util/is-ndarray"),c=e("./util/values"),l=e("./util/pool"),p=e("./constants/arraytypes.json"),d=e("./constants/dtypes.json"),m=e("./constants/usage.json"),h=35044,b=35040,y=5121,g=5126;t.exports=function(e){function t(t){this.id=A++,this.buffer=e.createBuffer(),this.type=t,this.usage=h,this.byteLength=0,this.dimension=1,this.dtype=y}function r(r,n){var a=j.pop();return a||(a=new t(r),a.buffer=e.createBuffer()),a.bind(),x(a,n,b,0,1),a}function p(e){j.push(e)}function v(t,r,n){t.byteLength=r.byteLength,e.bufferData(t.type,r,n)}function x(e,t,r,c,p){if(e.usage=r,Array.isArray(t)){if(e.dtype=c||g,t.length>0){var d;if(Array.isArray(t[0]))e.dimension=t[0].length,d=l.allocType(e.dtype,t.length*e.dimension),o(d,t,e.dimension),v(e,d,r),l.freeType(d);else if("number"==typeof t[0]){e.dimension=p;var m=l.allocType(e.dtype,t.length);a(m,t),v(e,m,r),l.freeType(m)}else u(t[0])?(e.dimension=t[0].length,e.dtype=c||n(t[0])||g,d=l.allocType(e.dtype,t.length*e.dimension),o(d,t,e.dimension),v(e,d,r),l.freeType(d)):f.raise("invalid buffer data")}}else if(u(t))e.dtype=c||n(t),e.dimension=p,v(e,t,r);else if(s(t)){var h=t.shape,b=t.stride,y=t.offset,x=0,w=0,k=0,A=0;1===h.length?(x=h[0],w=1,k=b[0],A=0):2===h.length?(x=h[0],w=h[1],k=b[0],A=b[1]):f.raise("invalid shape"),e.dtype=c||n(t.data)||g,e.dimension=w;var _=l.allocType(e.dtype,x*w);i(_,t.data,x,w,k,A,y),v(e,_,r),l.freeType(_)}else f.raise("invalid buffer data")}function w(t){var r=t.buffer;f(r,"buffer must not be deleted already"),e.isBuffer(r)&&e.deleteBuffer(r),t.buffer=null,delete _[t.id]}function k(r,c,p){function b(t){var r=h,n=null,a=0,i=0,o=1;return Array.isArray(t)||u(t)||s(t)?n=t:"number"==typeof t?a=0|t:t&&(f.type(t,"object","buffer arguments must be an object, a number or an array"),"data"in t&&(f(null===n||Array.isArray(n)||u(n)||s(n),"invalid data for buffer"),n=t.data),"usage"in t&&(f.parameter(t.usage,m,"invalid buffer usage"),r=m[t.usage]),"type"in t&&(f.parameter(t.type,d,"invalid buffer type"),i=d[t.type]),"dimension"in t&&(f.type(t.dimension,"number","invalid dimension"),o=0|t.dimension),"length"in t&&(f.nni(a,"buffer length must be a nonnegative integer"),a=0|t.length)),k.bind(),n?x(k,n,r,i,o):(e.bufferData(k.type,a,r),k.dtype=i||y,k.usage=r,k.dimension=o,k.byteLength=a),b}function g(t,r){f(r+t.byteLength<=k.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+t.byteLength+" starting from offset "+r+" to a buffer of size "+k.byteLength),e.bufferSubData(k.type,r,t)}function v(e,t){var r=0|(t||0);if(k.bind(),Array.isArray(e)){if(e.length>0)if("number"==typeof e[0]){var c=l.allocType(k.dtype,e.length);a(c,e),g(c,r),l.freeType(c)}else if(Array.isArray(e[0])||u(e[0])){var p=e[0].length,d=l.allocType(k.dtype,e.length*p);o(d,e,p),g(d,r),l.freeType(d)}else f.raise("invalid buffer data")}else if(u(e))g(e,r);else if(s(e)){var m=e.shape,h=e.stride,y=0,v=0,x=0,w=0;1===m.length?(y=m[0],v=1,x=h[0],w=0):2===m.length?(y=m[0],v=m[1],x=h[0],w=h[1]):f.raise("invalid shape");var A=Array.isArray(e.data)?k.dtype:n(e.data),_=l.allocType(A,y*v);i(_,e.data,y,v,x,w,e.offset),g(_,r),l.freeType(_)}else f.raise("invalid data for buffer subdata");return b}var k=new t(c);return _[k.id]=k,p||b(r),b._reglType="buffer",b._buffer=k,b.subdata=v,b.destroy=function(){w(k)},b}var A=0,_={};t.prototype.bind=function(){e.bindBuffer(this.type,this.buffer)};var j=[];return{create:k,createStream:r,destroyStream:p,clear:function(){c(_).forEach(w)},getBuffer:function(e){return e&&e._buffer instanceof t?e._buffer:null},_initBuffer:x}}},{"./constants/arraytypes.json":3,"./constants/dtypes.json":4,"./constants/usage.json":6,"./util/check":18,"./util/is-ndarray":22,"./util/is-typed-array":23,"./util/pool":25,"./util/values":28}],3:[function(e,t,r){t.exports={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121}},{}],4:[function(e,t,r){t.exports={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126}},{}],5:[function(e,t,r){t.exports={points:0,point:0,lines:1,line:1,"line loop":2,"line strip":3,triangles:4,triangle:4,"triangle strip":5,"triangle fan":6}},{}],6:[function(e,t,r){t.exports={static:35044,dynamic:35048,stream:35040}},{}],7:[function(e,t,r){function n(e){return Array.isArray(e)||p(e)||d(e)}function a(e){return e.sort(function(e,t){return e===K?-1:t===K?1:e<t?-1:1})}function i(e,t,r,n){this.thisDep=e,this.contextDep=t,this.propDep=r,this.append=n}function o(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function f(e){return new i(!1,!1,!1,e)}function u(e,t){var r=e.type;if(r===x){var n=e.data.length;return new i(!0,n>=1,n>=2,t)}return new i(r===A,r===k,r===w,t)}var s=e("./util/check"),c=e("./util/codegen"),l=e("./util/loop"),p=e("./util/is-typed-array"),d=e("./util/is-ndarray"),m=e("./constants/primitives.json"),h=e("./constants/dtypes.json"),b="xyzw".split(""),y=5121,g=1,v=2,x=0,w=1,k=2,A=3,_="dither",j="blend.enable",E="blend.color",T="blend.equation",S="blend.func",D="depth.enable",O="depth.func",C="depth.range",B="depth.mask",F="colorMask",P="cull.enable",L="cull.face",M="frontFace",z="lineWidth",R="polygonOffset.enable",I="polygonOffset.offset",W="sample.alpha",H="sample.enable",N="sample.coverage",U="stencil.enable",G="stencil.mask",q="stencil.func",V="stencil.opFront",Y="stencil.opBack",$="scissor.enable",J="scissor.box",K="viewport",Q="framebuffer",X="vert",Z="frag",ee="elements",te="primitive",re="count",ne="offset",ae="instances",ie="Width",oe="Height",fe=Q+ie,ue=Q+oe,se=K+ie,ce=K+oe,le="drawingBuffer",pe=le+ie,de=le+oe,me=34962,he=34963,be=35632,ye=35633,ge=3553,ve=34067,xe=2884,we=3042,ke=3024,Ae=2960,_e=2929,je=3089,Ee=32823,Te=32926,Se=32928,De=5126,Oe=35664,Ce=35665,Be=35666,Fe=5124,Pe=35667,Le=35668,Me=35669,ze=35670,Re=35671,Ie=35672,We=35673,He=35674,Ne=35675,Ue=35676,Ge=35678,qe=35680,Ve=4,Ye=1028,$e=1029,Je=2304,Ke=2305,Qe=32775,Xe=32776,Ze=519,et=7680,tt=0,rt=1,nt=32774,at=513,it=36160,ot=36064,ft={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},ut={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},st={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},ct={frag:be,vert:ye},lt={cw:Je,ccw:Ke},pt=new i(!1,!1,!1,function(){});t.exports=function(e,t,r,d,ie,oe,le,be,ye,dt,mt,ht,bt){function yt(e){return e.replace(".","_")}function gt(e,t,r){var n=yt(e);Zt.push(e),Xt[n]=Qt[n]=!!r,er[n]=t}function vt(e,t,r){var n=yt(e);Zt.push(e),Array.isArray(r)?(Qt[n]=r.slice(),Xt[n]=r.slice()):Qt[n]=Xt[n]=r,tr[n]=t}function xt(){var e=c(),r=e.link,n=e.global;e.id=ar++,e.batchId="0";var a=r(rr),i=e.shared={props:"a0"};Object.keys(rr).forEach(function(e){i[e]=n.def(a,".",e)}),s.optional(function(){var t=r(s),n=r(s.guessCommand());e.command=n,e.assert=function(e,a,i){e("if(!(",a,"))",t,".commandRaise(",r(i),",",n,");")}});var o=e.next={},f=e.current={};Object.keys(tr).forEach(function(e){Array.isArray(Qt[e])&&(o[e]=n.def(i.next,".",e),f[e]=n.def(i.current,".",e))});var u=e.constants={};Object.keys(nr).forEach(function(e){u[e]=n.def(JSON.stringify(nr[e]))}),e.invoke=function(t,n){switch(n.type){case x:var a=["this",i.context,i.props,e.batchId];return t.def(r(n.data),".call(",a.slice(0,Math.max(n.data.length+1,4)),")");case w:return t.def(i.props,n.data);case k:return t.def(i.context,n.data);case A:return t.def("this",n.data)}},e.attribCache={};var l={};return e.scopeAttrib=function(e){var n=t.id(e);if(n in l)return l[n];var a=dt.scope[n];a||(a=dt.scope[n]=new Yt);var i=l[n]=r(a);return i},e}function wt(e){var t=e.static,r=e.dynamic;if(Q in t){var n=t[Q];return n?(n=be.getFramebuffer(n),s.command(n,"invalid framebuffer object"),f(function(e,t){var r=e.link(n),a=e.shared;t.set(a.framebuffer,".next",r);var i=a.context;return t.set(i,"."+fe,r+".width"),t.set(i,"."+ue,r+".height"),r})):f(function(e,t){var r=e.shared;t.set(r.framebuffer,".next","null");var n=r.context;return t.set(n,"."+fe,n+"."+pe),t.set(n,"."+ue,n+"."+de),null})}if(Q in r){var a=r[Q];return u(a,function(e,t){var r=e.invoke(t,a),n=e.shared,i=n.framebuffer,o=t.def(i,".getFramebuffer(",r,")");s.optional(function(){e.assert(t,"!"+r+"||"+o,"invalid framebuffer object")}),t.set(i,".next",o);var f=n.context;return t.set(f,"."+fe,o+"?"+o+".width:"+f+"."+pe),t.set(f,"."+ue,o+"?"+o+".height:"+f+"."+de),o})}return null}function kt(e,t){function r(e){if(e in n){var r=n[e];s.commandType(r,"object","invalid "+e);var o,f,c=!0,l=0|r.x,p=0|r.y;return"w"in r?(o=0|r.w,s.command(o>0,"invalid "+e)):c=!1,"h"in r?(f=0|r.h,s.command(f>0,"invalid "+e)):c=!1,new i(c&&t&&t.thisDep,c&&t&&t.contextDep,c&&t&&t.propDep,function(e,t){var n=e.shared.context,a=o;"w"in r||(a=t.def(n,".",fe,"-",l));var i=f;return"h"in r||(i=t.def(n,".",ue,"-",p)),[l,p,a,i]})}if(e in a){var d=a[e],m=u(d,function(t,r){var n=t.invoke(r,d);s.optional(function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid "+e)});var a=t.shared.context,i=r.def(n,".x|0"),o=r.def(n,".y|0"),f=r.def('"w" in ',n,"?",n,".w|0:","(",a,".",fe,"-",i,")"),u=r.def('"h" in ',n,"?",n,".h|0:","(",a,".",ue,"-",o,")");return s.optional(function(){t.assert(r,i+">=0&&"+o+">=0&&"+f+">0&&"+u+">0","invalid "+e)}),[i,o,f,u]});return t&&(m.thisDep=m.thisDep||t.thisDep,m.contextDep=m.contextDep||t.contextDep,m.propDep=m.propDep||t.prpoDep),m}return t?new i(t.thisDep,t.contextDep,t.propDep,function(e,t){var r=e.shared.context;return[0,0,t.def(r,".",fe),t.def(r,".",ue)]}):null}var n=e.static,a=e.dynamic,o=r(K);if(o){var f=o;o=new i(o.thisDep,o.contextDep,o.propDep,function(e,t){var r=f.append(e,t),n=e.shared.context;return t.set(n,"."+se,r[2]),t.set(n,"."+ce,r[3]),r})}return{viewport:o,scissor_box:r(J)}}function At(e){function r(e){if(e in a){var r=t.id(a[e]);s.optional(function(){mt.shader(ct[e],r)});var n=f(function(){return r});return n.id=r,n}if(e in c){var i=c[e];return u(i,function(t,r){var n=t.invoke(r,i),a=r.def(t.shared.strings,".id(",n,")");return s.optional(function(){r(t.shared.shader,".shader(",ct[e],",",a,",",t.command,");")}),a})}return null}var n,a=e.static,c=e.dynamic,l=r(Z),p=r(X),d=null;return o(l)&&o(p)?(d=mt.program(p.id,l.id),n=f(function(e,t){return e.link(d)})):n=new i(l&&l.thisDep||p&&p.thisDep,l&&l.contextDep||p&&p.contextDep,l&&l.propDep||p&&p.propDep,function(e,t){var r,n=e.shared.shader;r=l?l.append(e,t):t.def(n,".",Z);var a;a=p?p.append(e,t):t.def(n,".",X);var i=n+".program("+a+","+r;return s.optional(function(){i+=","+e.command}),t.def(i+")")}),{frag:l,vert:p,progVar:n,program:d}}function _t(e){function t(){if(ee in l){var e=l[ee];n(e)?e=oe.getElements(oe.create(e)):e&&(e=oe.getElements(e),s.command(e,"invalid elements"));var t=f(function(t,r){if(e){var n=t.link(e);return t.ELEMENTS=n,n}return t.ELEMENTS=null,null});return t.value=e,t}if(ee in p){var r=p[ee];return u(r,function(e,t){var n=e.shared,a=n.isBufferArgs,i=n.elements,o=e.invoke(t,r),f=t.def("null"),u=t.def(a,"(",o,")"),c=e.cond(u).then(f,"=",i,".createStream(",o,");").else(f,"=",i,".getElements(",o,");");return s.optional(function(){e.assert(c.else,"!"+o+"||"+f,"invalid elements")}),t.entry(c),t.exit(e.cond(u).then(i,".destroyStream(",f,");")),e.ELEMENTS=f,f})}return null}function r(){if(te in l){var e=l[te];return s.commandParameter(e,m,"invalid primitve"),f(function(t,r){return m[e]})}if(te in p){var t=p[te];return u(t,function(e,r){var n=e.constants.primTypes,a=e.invoke(r,t);return s.optional(function(){e.assert(r,a+" in "+n,"invalid primitive, must be one of "+Object.keys(m))}),r.def(n,"[",a,"]")})}return d?o(d)?f(d.value?function(e,t){return t.def(e.ELEMENTS,".primType")}:function(){return Ve}):new i(d.thisDep,d.contextDep,d.propDep,function(e,t){var r=e.ELEMENTS;return t.def(r,"?",r,".primType:",Ve)}):null}function a(e,t){if(e in l){var r=0|l[e];return s.command(!t||r>=0,"invalid "+e),f(function(e,n){return t&&(e.OFFSET=r),r})}if(e in p){var n=p[e];return u(n,function(r,a){var i=r.invoke(a,n);return t&&(r.OFFSET=i,s.optional(function(){r.assert(a,i+">=0","invalid "+e)})),i})}return t&&d?f(function(e,t){return e.OFFSET="0",0}):null}function c(){if(re in l){var e=0|l[re];return s.command("number"==typeof e&&e>=0,"invalid vertex count"),f(function(){return e})}if(re in p){var t=p[re];return u(t,function(e,r){var n=e.invoke(r,t);return s.optional(function(){e.assert(r,"typeof "+n+'==="number"&&'+n+">=0&&"+n+"===("+n+"|0)","invalid vertex count")}),n})}if(d){if(o(d)){if(d)return h?new i(h.thisDep,h.contextDep,h.propDep,function(e,t){var r=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return s.optional(function(){e.assert(t,r+">=0","invalid vertex offset/element buffer too small")}),r}):f(function(e,t){return t.def(e.ELEMENTS,".vertCount")});var r=f(function(){return-1});return s.optional(function(){r.MISSING=!0}),r}var n=new i(d.thisDep||h.thisDep,d.contextDep||h.contextDep,d.propDep||h.propDep,function(e,t){var r=e.ELEMENTS;return e.OFFSET?t.def(r,"?",r,".vertCount-",e.OFFSET,":-1"):t.def(r,"?",r,".vertCount:-1")});return s.optional(function(){n.DYNAMIC=!0}),n}return null}var l=e.static,p=e.dynamic,d=t(),h=a(ne,!0);return{elements:d,primitive:r(),count:c(),instances:a(ae,!1),offset:h}}function jt(e){var t=e.static,r=e.dynamic,n={};return Zt.forEach(function(e){function a(a,o){if(e in t){var s=a(t[e]);n[i]=f(function(){return s})}else if(e in r){var c=r[e];n[i]=u(c,function(e,t){return o(e,t,e.invoke(t,c))})}}var i=yt(e);switch(e){case P:case j:case _:case U:case D:case $:case R:case W:case H:case B:return a(function(t){return s.commandType(t,"boolean",e),t},function(t,r,n){return s.optional(function(){t.assert(r,"typeof "+n+'==="boolean"',"invalid flag "+e)}),n});case O:return a(function(t){return s.commandParameter(t,ut,"invalid "+e),ut[t]},function(t,r,n){var a=t.constants.compareFuncs;return s.optional(function(){t.assert(r,n+" in "+a,"invalid "+e+", must be one of "+Object.keys(ut))}),r.def(a,"[",n,"]")});case C:return a(function(e){return s.command(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]<=e[1],"depth range is 2d array"),e},function(e,t,r){s.optional(function(){e.assert(t,"Array.isArray("+r+")&&"+r+".length===2&&typeof "+r+'[0]==="number"&&typeof '+r+'[1]==="number"&&'+r+"[0]<="+r+"[1]","depth range must be a 2d array")});var n=t.def("+",r,"[0]"),a=t.def("+",r,"[1]");return[n,a]});case S:return a(function(e){s.commandType(e,"object","blend.func");var t="srcRGB"in e?e.srcRGB:e.src,r="srcAlpha"in e?e.srcAlpha:e.src,n="dstRGB"in e?e.dstRGB:e.dst,a="dstAlpha"in e?e.dstAlpha:e.dst;return s.commandParameter(t,ft,i+".srcRGB"),s.commandParameter(r,ft,i+".srcAlpha"),s.commandParameter(n,ft,i+".dstRGB"),s.commandParameter(a,ft,i+".dstAlpha"),[ft[t],ft[n],ft[r],ft[a]]},function(t,r,n){function a(a,o){var f=r.def('"',a,o,'" in ',n,"?",n,".",a,o,":",n,".",a);return s.optional(function(){t.assert(r,f+" in "+i,"invalid "+e+"."+a+o+", must be one of "+Object.keys(ft))}),r.def(i,"[",f,"]")}var i=t.constants.blendFuncs;s.optional(function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid blend func, must be an object")});var o=a("src","RGB"),f=a("src","Alpha"),u=a("dst","RGB"),c=a("dst","Alpha");return[o,u,f,c]});case T:return a(function(t){return"string"==typeof t?(s.commandParameter(t,$t,"invalid "+e),[$t[t],$t[t]]):"object"==typeof t?(s.commandParameter(t.rgb,$t,e+".rgb"),s.commandParameter(t.alpha,$t,e+".alpha"),[$t[t.rgb],$t[t.alpha]]):void s.commandRaise("invalid blend.equation")},function(t,r,n){var a=t.constants.blendEquations,i=r.def(),o=r.def(),f=t.cond("typeof ",n,'==="string"');return s.optional(function(){function r(e,r,n){t.assert(e,n+" in "+a,"invalid "+r+", must be one of "+Object.keys($t))}r(f.then,e,n),t.assert(f.else,n+"&&typeof "+n+'==="object"',"invalid "+e),r(f.else,e+".rgb",n+".rgb"),r(f.else,e+".alpha",n+".alpha")}),f.then(i,"=",o,"=",a,"[",n,"];"),f.else(i,"=",a,"[",n,".rgb];",o,"=",a,"[",n,".alpha];"),r(f),[i,o]});case E:return a(function(e){return s.command(Array.isArray(e)&&4===e.length,"blend.color must be a 4d array"),l(4,function(t){return+e[t]})},function(e,t,r){return s.optional(function(){e.assert(t,"Array.isArray("+r+")&&"+r+".length===4","blend.color must be a 4d array")}),l(4,function(e){return t.def("+",r,"[",e,"]")})});case G:return a(function(e){return s.commandType(e,"number",i),0|e},function(e,t,r){return s.optional(function(){e.assert(t,"typeof "+r+'==="number"',"invalid stencil.mask")}),t.def(r,"|0")});case q:return a(function(t){s.commandType(t,"object",i);var r=t.cmp||"keep",n=t.ref||0,a="mask"in t?t.mask:-1;return s.commandParameter(r,ut,e+".cmp"),s.commandType(n,"number",e+".ref"),s.commandType(a,"number",e+".mask"),[ut[r],n,a]},function(e,t,r){var n=e.constants.compareFuncs;s.optional(function(){function a(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}a(r+"&&typeof ",r,'==="object"'),a('!("cmp" in ',r,")||(",r,".cmp in ",n,")")});var a=t.def('"cmp" in ',r,"?",n,"[",r,".cmp]",":",et),i=t.def(r,".ref|0"),o=t.def('"mask" in ',r,"?",r,".mask|0:-1");return[a,i,o]});case V:case Y:return a(function(t){s.commandType(t,"object",i);var r=t.fail||"keep",n=t.zfail||"keep",a=t.pass||"keep";return s.commandParameter(r,st,e+".fail"),s.commandParameter(n,st,e+".zfail"),s.commandParameter(a,st,e+".pass"),[e===Y?$e:Ye,st[r],st[n],st[a]]},function(t,r,n){function a(a){return s.optional(function(){t.assert(r,'!("'+a+'" in '+n+")||("+n+"."+a+" in "+i+")","invalid "+e+"."+a+", must be one of "+Object.keys(st))}),r.def('"',a,'" in ',n,"?",i,"[",n,".",a,"]:",et)}var i=t.constants.stencilOps;return s.optional(function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid "+e)}),[e===Y?$e:Ye,a("fail"),a("zfail"),a("pass")]});case I:return a(function(e){s.commandType(e,"object",i);var t=0|e.factor,r=0|e.units;return s.commandType(t,"number",i+".factor"),s.commandType(r,"number",i+".units"),[t,r]},function(t,r,n){s.optional(function(){t.assert(r,n+"&&typeof "+n+'==="object"',"invalid "+e)});var a=r.def(n,".factor|0"),i=r.def(n,".units|0");return[a,i]});case L:return a(function(e){var t=0;return"front"===e?t=Ye:"back"===e&&(t=$e),s.command(!!t,i),t},function(e,t,r){return s.optional(function(){e.assert(t,r+'==="front"||'+r+'==="back"',"invalid cull.face")}),t.def(r,'==="front"?',Ye,":",$e)});case z:return a(function(e){return s.command("number"==typeof e&&e>=d.lineWidthDims[0]&&e<=d.lineWidthDims[1],"invalid line width, must positive number between "+d.lineWidthDims[0]+" and "+d.lineWidthDims[1]),e},function(e,t,r){return s.optional(function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">="+d.lineWidthDims[0]+"&&"+r+"<="+d.lineWidthDims[1],"invalid line width")}),r});case M:return a(function(e){return s.commandParameter(e,lt,i),lt[e]},function(e,t,r){return s.optional(function(){e.assert(t,r+'==="cw"||'+r+'==="ccw"',"invalid frontFace, must be one of cw,ccw")}),t.def(r+'==="cw"?'+Je+":"+Ke)});case F:return a(function(e){return s.command(Array.isArray(e)&&4===e.length,"color.mask must be length 4 array"),e.map(function(e){return!!e})},function(e,t,r){return s.optional(function(){e.assert(t,"Array.isArray("+r+")&&"+r+".length===4","invalid color.mask")}),l(4,function(e){return"!!"+r+"["+e+"]"})});case N:return a(function(e){s.command("object"==typeof e&&e,i);var t="value"in e?e.value:1,r=!!e.invert;return s.command("number"==typeof t&&t>=0&&t<=1,"sample.coverage.value must be a number between 0 and 1"),[t,r]},function(e,t,r){s.optional(function(){e.assert(t,r+"&&typeof "+r+'==="object"',"invalid sample.coverage")});var n=t.def('"value" in ',r,"?+",r,".value:1"),a=t.def("!!",r,".invert");return[n,a]})}}),n}function Et(e){function t(e){var t=i[e];t&&(f[e]=t)}var r=e.static,n=e.dynamic;s.optional(function(){function e(e){Object.keys(e).forEach(function(e){s.command(a.indexOf(e)>=0,'unknown parameter "'+e+'"',t)})}var t=s.guessCommand(),a=[Q,X,Z,ee,te,ne,re,ae].concat(Zt);e(r),e(n)});var a=wt(e),i=kt(e,a),o=_t(e),f=jt(e),u=At(e);t(K),t(yt(J));var c=Object.keys(f).length>0;return{framebuffer:a,draw:o,shader:u,state:f,dirty:c}}function Tt(e){var t=e.static,r=e.dynamic,n={};return Object.keys(t).forEach(function(e){var r,a=t[e];"number"==typeof a||"boolean"==typeof a?r=f(function(){return a}):"function"!=typeof a||"texture2d"!==a._reglType&&"textureCube"!==a._reglTYpe?Array.isArray(a)||p(a)?r=f(function(t){var r=t.global.def("[",l(a.length,function(t){return s.command("number"==typeof a[t]||"boolean"==typeof a[t],"invalid uniform "+e),a[t]}),"]");return r}):s.commandRaise("invalid uniform "+e):r=f(function(e){return e.link(a)}),r.value=a,n[e]=r}),Object.keys(r).forEach(function(e){var t=r[e];n[e]=u(t,function(e,r){return e.invoke(r,t)})}),n}function St(e){var r=e.static,a=e.dynamic,i={};return Object.keys(r).forEach(function(e){var a=r[e],o=t.id(e),u=new Yt;if(n(a))u.state=g,u.buffer=ie.getBuffer(ie.create(a,me,!1)),u.type=u.buffer.dtype;else{var c=ie.getBuffer(a);if(c)u.state=g,u.buffer=c,u.type=c.dtype;else if(s.command("object"==typeof a&&a,"invalid data for attribute "+e),a.constant){var l=a.constant;u.state=v,"number"==typeof l?u.x=l:(s.command(Array.isArray(l)&&l.length>0&&l.length<=4,"invalid constant for attribute "+e),b.forEach(function(e,t){t<l.length&&(u[e]=l[t])}))}else{c=ie.getBuffer(a.buffer),s.command(!!c,'missing buffer for attribute "'+e+'"');var p=0|a.offset;s.command(p>=0,'invalid offset for attribute "'+e+'"');var d=0|a.stride;s.command(d>=0&&d<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]');var m=0|a.size;s.command(!("size"in a)||m>0&&m<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4');var y=!!a.normalized,x=0;"type"in a&&(s.commandParameter(a.type,h,"invalid type for attribute "+e),x=h[a.type]);var w=0|a.divisor;"divisor"in a&&(s.command(0===w||Jt,'cannot specify divisor for attribute "'+e+'", instancing not supported'),s.command(w>=0,'invalid divisor for attribute "'+e+'"')),s.optional(function(){var t=s.guessCommand(),r=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(a).forEach(function(n){s.command(r.indexOf(n)>=0,'unknown parameter "'+n+'" for attribute pointer "'+e+'" (valid parameters are '+r+")",t)})}),u.buffer=c,u.state=g,u.size=m,u.normalized=y,u.type=x||c.dtype,u.offset=p,u.stride=d,u.divisor=w}}i[e]=f(function(e,t){var r=e.attribCache;if(o in r)return r[o];var n={isStream:!1};return Object.keys(u).forEach(function(e){n[e]=u[e]}),u.buffer&&(n.buffer=e.link(u.buffer)),r[o]=n,n})}),Object.keys(a).forEach(function(e){function t(t,n){function a(e){n(c[e],"=",i,".",e,"|0;")}var i=t.invoke(n,r),o=t.shared,f=o.isBufferArgs,u=o.buffer;s.optional(function(){t.assert(n,i+"&&(typeof "+i+'==="object"||typeof '+i+'==="function")&&('+f+"("+i+")||"+u+".getBuffer("+i+")||"+u+".getBuffer("+i+'.buffer)||("constant" in '+i+"&&(typeof "+i+'.constant==="number"||Array.isArray('+i+"))))",'invalid dynamic attribute "'+e+'"')});var c={isStream:n.def(!1)},l=new Yt;l.state=g,Object.keys(l).forEach(function(e){c[e]=n.def(""+l[e])});var p=c.buffer,d=c.type;return n("if(",f,"(",i,")){",c.isStream,"=true;",p,"=",u,".createStream(",me,",",i,");",d,"=",p,".dtype;","}else{",p,"=",u,".getBuffer(",i,");","if(",p,"){",d,"=",p,".dtype;","}else if(",i,".constant){",c.state,"=",v,";",b.map(function(e,t){return c[e]+"="+i+".length>="+t+"?"+i+"["+t+"]:0;"}).join(""),"}else{",p,"=",u,".getBuffer(",i,".buffer);",d,'="type" in ',i,"?",o.glTypes,"[",i,".type]:",p,".dtype;",c.normalized,"=!!",i,".normalized;"),a("size"),a("offset"),a("stride"),a("divisor"),n("}}"),c}var r=a[e];i[e]=u(r,t)}),i}function Dt(e){var t=e.static,r=e.dynamic,n={};return Object.keys(t).forEach(function(e){var r=t[e];n[e]=f(function(e,t){return"number"==typeof r||"boolean"==typeof r?""+r:e.link(r)})}),Object.keys(r).forEach(function(e){var t=r[e];n[e]=u(t,function(e,r){return e.invoke(r,t)})}),n}function Ot(e,t,r,n){var a=Et(e);return a.uniforms=Tt(r),a.attributes=St(t),a.context=Dt(n),a}function Ct(e,t,r){var n=e.shared,a=n.context,i=e.scope();Object.keys(r).forEach(function(n){t.save(a,"."+n);var o=r[n];i(a,".",n,"=",o.append(e,t),";")}),t(i)}function Bt(e,t,r){var n,a=e.shared,i=a.gl,o=a.framebuffer;Kt&&(n=t.def(a.extensions,".webgl_draw_buffers"));var f,u=e.constants,s=u.drawBuffer,c=u.backBuffer;f=r?r.append(e,t):t.def(o,".next"),t("if(",o,".dirty||",f,"!==",o,".cur){","if(",f,"){",i,".bindFramebuffer(",it,",",f,".framebuffer);"),Kt&&t(n,".drawBuffersWEBGL(",s,"[",f,".colorAttachments.length]);"),t("}else{",i,".bindFramebuffer(",it,",null);"),Kt&&t(n,".drawBuffersWEBGL(",c,");"),t("}",o,".cur=",f,";",o,".dirty=false;","}")}function Ft(e,t,r){var n=e.shared,a=n.gl,i=e.current,o=e.next,f=n.current,u=n.next,s=e.cond(f,".dirty");Zt.forEach(function(t){var n=yt(t);if(!(n in r.state)){var c,p;if(n in o){c=o[n],p=i[n];var d=l(Qt[n].length,function(e){return s.def(c,"[",e,"]")});s(e.cond(d.map(function(e,t){return e+"==="+p+"["+t+"]"}).join("&&")).then(a,".",tr[n],"(",d,");",d.map(function(e,t){return p+"["+t+"]="+e}).join(";"),";"))}else{c=s.def(u,".",n);var m=e.cond(c,"!==",f,".",n);s(m),n in er?m(e.cond(c).then(a,".enable(",er[n],");").else(a,".disable(",er[n],");"),f,".",n,"=",c,";"):m(a,".",tr[n],"(",c,");",f,".",n,"=",c,";")}}}),0===Object.keys(r.state).length&&s(f,".dirty=false;"),t(s)}function Pt(e,t,r,n){var i=e.shared,f=e.current,u=i.current,s=i.gl;a(Object.keys(r)).forEach(function(a){var i=r[a];if(!n||n(i)){var c=i.append(e,t);if(er[a]){var l=er[a];o(i)?c?t(s,".enable(",l,");"):t(s,".disable(",l,");"):t(e.cond(c).then(s,".enable(",l,");").else(s,".disable(",l,");")),t(u,".",a,"=",c,";")}else if(Array.isArray(c)){var p=f[a];t(s,".",tr[a],"(",c,");",c.map(function(e,t){return p+"["+t+"]="+e}).join(";"),";")}else t(s,".",tr[a],"(",c,");",u,".",a,"=",c,";")}})}function Lt(e,t){Jt&&!e.instancing&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function Mt(e,t,r,n,a){function i(e){switch(e){case Oe:case Pe:case Re:return 2;case Ce:case Le:case Ie:return 3;case Be:case Me:case We:return 4;default:return 1}}function o(r,n,a){function i(){t("if(!",c,".pointer){",u,".enableVertexAttribArray(",s,");",c,".pointer=true;}");var r,i=a.type;if(r=a.size?t.def(a.size,"||",n):n,t("if(",c,".type!==",i,"||",c,".size!==",r,"||",m.map(function(e){return c+"."+e+"!=="+a[e]}).join("||"),"){",u,".bindBuffer(",me,",",p,".buffer);",u,".vertexAttribPointer(",[s,r,i,a.normalized,a.stride,a.offset],");",c,".type=",i,";",c,".size=",r,";",m.map(function(e){return c+"."+e+"="+a[e]+";"}).join(""),"}"),Jt){var o=a.divisor;t("if(",c,".divisor!==",o,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,o],");",c,".divisor=",o,";}")}}function o(){t("if(",c,".pointer){",u,".disableVertexAttribArray(",s,");",c,".pointer=false;","}if(",b.map(function(e,t){return c+"."+e+"!=="+d[t]}).join("||"),"){",u,".vertexAttrib4f(",s,",",d,");",b.map(function(e,t){return c+"."+e+"="+d[t]+";"}).join(""),"}")}var u=f.gl,s=t.def(r,".location"),c=t.def(f.attributes,"[",s,"]"),l=a.state,p=a.buffer,d=[a.x,a.y,a.z,a.w],m=["buffer","normalized","offset","stride"];l===g?i():l===v?o():(t("if(",l,"===",g,"){"),i(),t("}else{"),o(),t("}"))}var f=e.shared;n.forEach(function(n){var f,u=n.name,c=r.attributes[u];if(c){if(!a(c))return;f=c.append(e,t)}else{if(!a(pt))return;var l=e.scopeAttrib(u);s.optional(function(){e.assert(t,l,".state","missing attribute "+u)}),f={},Object.keys(new Yt).forEach(function(e){f[e]=t.def(l,".",e)})}o(e.link(n),i(n.info.type),f)})}function zt(e,r,n,a,i){for(var o,f=e.shared,u=f.gl,c=0;c<a.length;++c){var l,d=a[c],m=d.name,h=d.info.type,b=n.uniforms[m],y=e.link(d),g=y+".location";if(b){if(!i(b))continue;if(b.static){var v=b.value;if(h===Ge||h===qe){s.command("function"==typeof v&&"texture"===v._reglType&&(h===qe&&v._texture.target===ve||h===Ge&&v._texutre.target===ge),"invalid texture for uniform "+m);var x=e.link(v._texture);r(u,".uniform1i(",g,x+".bind());"),r.exit(x,".unbind()")}else if(h===He||h===Ne||h===Ue){s.optional(function(){s.command(p(v)||Array.isArray(v),"invalid matrix for uniform "+m),s.command(h===He&&4===v.length||h===Ne&&9===v.length||h===Ue&&16===v.length,"invalid length for matrix uniform "+m)});var w=e.global.def("["+v+"]"),k=2;h===Ne?k=3:h===Ue&&(k=4),r(u,".uniformMatrix",k,"fv(",g,",false,",w,");")}else{switch(h){case De:s.commandType(v,"number","uniform "+m),o="1f";break;case Oe:s.command((Array.isArray(v)||p(v))&&2===v.length&&"number"==typeof v[0]&&"number"==typeof v[1],"uniform "+m),o="2f";break;case Ce:s.command((Array.isArray(v)||p(v))&&3===v.length&&"number"==typeof v[0]&&"number"==typeof v[1]&&"number"==typeof v[2],"uniform "+m),o="3f";break;case Be:s.command((Array.isArray(v)||p(v))&&4===v.length&&"number"==typeof v[0]&&"number"==typeof v[1]&&"number"==typeof v[2]&&"number"==typeof v[3],"uniform "+m),o="4f";break;case ze:s.commandType(v,"boolean","uniform "+m),o="1i";break;case Fe:s.command("number"==typeof v&&v===(0|v),"uniform "+m),o="1i";break;case Re:s.command(Array.isArray(v)&&2===v.length&&"boolean"==typeof v[0]&&"boolean"==typeof v[1],"uniform "+m),o="2i";break;case Pe:s.command((Array.isArray(v)||p(v))&&2===v.length&&"number"==typeof v[0]&&v[0]===(0|v[0])&&"number"==typeof v[1]&&v[1]===(0|v[1]),"uniform "+m),o="2i";break;case Ie:s.command(Array.isArray(v)&&3===v.length&&"boolean"==typeof v[0]&&"boolean"==typeof v[1]&&"boolean"==typeof v[2],"uniform "+m),o="3i";break;case Le:s.command((Array.isArray(v)||p(v))&&3===v.length&&"number"==typeof v[0]&&v[0]===(0|v[0])&&"number"==typeof v[1]&&v[1]===(0|v[1])&&"number"==typeof v[2]&&v[2]===(0|v[2]),"uniform "+m),o="3i";break;case We:s.command(Array.isArray(v)&&4===v.length&&"boolean"==typeof v[0]&&"boolean"==typeof v[1]&&"boolean"==typeof v[2]&&"boolean"==typeof v[3],"uniform "+m),o="4i";break;case Me:s.command((Array.isArray(v)||p(v))&&4===v.length&&"number"==typeof v[0]&&v[0]===(0|v[0])&&"number"==typeof v[1]&&v[1]===(0|v[1])&&"number"==typeof v[2]&&v[2]===(0|v[2])&&"number"==typeof v[3]&&v[3]===(0|v[3]),"uniform "+m),o="4i";break;default:s.raise("unsupported uniform type")}r(u,".uniform",o,"(",g,",",v,");")}continue}l=b.append(e,r)}else{if(!i(pt))continue;l=r.def(f.uniforms,"[",t.id(m),"]")}s.optional(function(){
function t(t){e.assert(r,t,'invalid or missing uniform "'+m+'"')}function n(e){t("typeof "+l+'==="'+e+'"')}function a(e,r){t("Array.isArray("+l+")&&"+l+".length==="+e)}function i(e){t("typeof "+l+'==="function"&&'+l+'._reglType==="texture'+(e===ge?"2d":"Cube")+'"')}switch(h){case Fe:n("number");break;case Pe:a(2,"number");break;case Le:a(3,"number");break;case Me:a(4,"number");break;case De:n("number");break;case Oe:a(2,"number");break;case Ce:a(3,"number");break;case Be:a(4,"number");break;case ze:n("boolean");break;case Re:a(2,"boolean");break;case Ie:a(3,"boolean");break;case We:a(4,"boolean");break;case He:a(4,"number");break;case Ne:a(9,"number");break;case Ue:a(16,"number");break;case Ge:i(ge);break;case qe:i(ve)}});var A=",";switch(h){case Ge:case qe:var _=r.def(l,"._texture");r(u,".uniform1i(",g,",",_,".bind());"),r.exit(_,".unbind();");continue;case Fe:case ze:o="1i";break;case Pe:case Re:o="2iv";break;case Le:case Ie:o="3iv";break;case Me:case We:o="4iv";break;case De:o="1f";break;case Oe:o="2fv";break;case Ce:o="3fv";break;case Be:o="4fv";break;case He:o="Matrix2fv",A=",false,";break;case Ne:o="Matrix3fv",A=",false,";break;case Ue:o="Matrix4fv",A=",false,"}r(u,".uniform",o,"(",g,A,l,");")}}function Rt(e,t,r,n){function a(){var n,a=m.elements,i=t;return a?(a.batchStatic||(i=r),n=a.append(e,i)):n=i.def(d,".",ee),n&&i("if("+n+")"+p+".bindBuffer("+he+","+n+".buffer.buffer);"),n}function i(){var n,a=m.count,i=t;return a?(a.batchStatic||(i=r),n=a.append(e,i),s.optional(function(){a.MISSING&&e.assert(t,"false","missing vertex count"),a.DYNAMIC&&e.assert(i,n+">=0","missing vertex count")})):n=i.def(d,".",re),n}function f(n){var a=m[n];return a?a.batchStatic?a.append(e,t):a.append(e,r):t.def(d,".",n)}function u(){function e(){r(w,".drawElementsInstancedANGLE(",[b,v,k,g+"<<(("+k+"-"+y+")>>1)",x],");")}function t(){r(w,".drawArraysInstancedANGLE(",[b,g,v,x],");")}h?A?e():(r("if(",h,"){"),e(),r("}else{"),t(),r("}")):t()}function c(){function e(){r(p+".drawElements("+[b,v,k,g+"<<(("+k+"-"+y+")>>1)"]+");")}function t(){r(p+".drawArrays("+[b,g,v]+");")}h?A?e():(r("if(",h,"){"),e(),r("}else{"),t(),r("}")):t()}var l=e.shared,p=l.gl,d=l.draw,m=n.draw,h=a(),b=f(te),g=f(ne),v=i();if("number"==typeof v){if(0===v)return}else r("if(",v,"){"),r.exit("}");var x,w;Jt&&(x=f(ae),w=e.instancing);var k=h+".type",A=m.elements&&o(m.elements);Jt&&("number"!=typeof x||x>=0)?"string"==typeof x?(r("if(",x,">0){"),u(),r("}else if(",x,"<0){"),c(),r("}")):u():c()}function It(e,t,r,n,a){var i=xt(),o=i.proc("body",a);return s.optional(function(){i.command=t.command,i.assert=t.assert}),Jt&&(i.instancing=o.def(i.shared.extensions,".angle_instanced_arrays")),e(i,o,r,n),i.compile().body}function Wt(e,t,r,n){Lt(e,t),Mt(e,t,r,n.attributes,function(){return!0}),zt(e,t,r,n.uniforms,function(){return!0}),Rt(e,t,t,r)}function Ht(e,t){var r=e.proc("draw",1);Lt(e,r),Ct(e,r,t.context),Bt(e,r,t.framebuffer),Ft(e,r,t),Pt(e,r,t.state);var n=t.shader.progVar.append(e,r);if(r(e.shared.gl,".useProgram(",n,".program);"),t.shader.program)Wt(e,r,t,t.shader.program);else{var a=e.global.def("{}"),i=r.def(n,".id"),o=r.def(a,"[",i,"]");r(e.cond(o).then(o,".call(this,a0);").else(o,"=",a,"[",i,"]=",e.link(function(r){return It(Wt,e,t,r,1)}),"(",n,");",o,".call(this,a0);"))}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;")}function Nt(e,t,r,n){function a(){return!0}e.batchId="a1",Lt(e,t),Mt(e,t,r,n.attributes,a),zt(e,t,r,n.uniforms,a),Rt(e,t,t,r)}function Ut(e,t,r,n){function a(e){return e.contextDep&&o||e.propDep}function i(e){return!a(e)}Lt(e,t);var o=r.contextDynamic,f=t.def(),u="a0",s="a1",c=t.def();e.shared.props=c,e.batchId=f;var l=e.scope(),p=e.scope();if(t(l.entry,"for(",f,"=0;",f,"<",s,";++",f,"){",c,"=",u,"[",f,"];",p,"}",l.exit),r.needsContext&&Ct(e,p,r.context),r.needsFramebuffer&&Bt(e,p,r.framebuffer),Pt(e,p,r.state,a),n)Mt(e,l,r,n.attributes,i),Mt(e,p,r,n.attributes,a),zt(e,l,r,n.uniforms,i),zt(e,p,r,n.uniforms,a),Rt(e,l,p,r);else{var d=e.global.def("{}"),m=r.shader.progVar.append(e,p),h=p.def(m,".id"),b=p.def(d,"[",h,"]");p(e.shared.gl,".useProgram(",m,".program);","if(!",b,"){",b,"=",d,"[",h,"]=",e.link(function(t){return It(Nt,e,r,t,2)}),"(",m,");}",b,".call(this,a0[",f,"],",f,");")}}function Gt(e,t){var r=e.proc("batch",2);e.batchId="0",Lt(e,r);var n=!1,a=!0;Object.keys(t.context).forEach(function(e){n=n||t.context[e].propDep}),n||(Ct(e,r,t.context),a=!1);var i=t.framebuffer,o=!1;i&&(i.propDep?n=o=!0:i.contextDep&&n&&(o=!0),o||Bt(e,r,i)),t.state.viewport&&t.state.viewport.propDynamic&&(n=!0),Ft(e,r,t),Pt(e,r,t.state,function(e){return!(e.contextDep&&n||e.propDep)}),t.contextDep=n,t.needsContext=a,t.needsFramebuffer=o;var f=t.shader.progVar;if(f.contextDep&&n||f.propDep)Ut(e,r,t,null);else{var u=f.append(e,r);if(r(e.shared.gl,".useProgram(",u,".program);"),t.shader.program)Ut(e,r,t,t.shader.program);else{var s=e.global.def("{}"),c=r.def(u,".id"),l=r.def(s,"[",c,"]");r(e.cond(l).then(l,".call(this,a0,a1);").else(l,"=",s,"[",c,"]=",e.link(function(r){return It(Ut,e,t,r,2)}),"(",u,");",l,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;")}function qt(e,r){function n(t){var n=r.shader[t];n&&i.set(o.shader,"."+t,n.append(e,i))}var i=e.proc("scope",3);e.batchId="a2";var o=e.shared,f=o.current;Ct(e,i,r.context),r.framebuffer&&r.framebuffer.append(e,i),a(Object.keys(r.state)).forEach(function(t){var n=r.state[t],a=n.append(e,i);Array.isArray(a)?a.forEach(function(r,n){i.set(e.next[t],"["+n+"]",r)}):i.set(o.next,"."+t,a)}),[ee,ne,re,ae,te].forEach(function(t){var n=r.draw[t];n&&i.set(o.draw,"."+t,""+n.append(e,i))}),Object.keys(r.uniforms).forEach(function(n){i.set(o.uniforms,"["+t.id(n)+"]",r.uniforms[n].append(e,i))}),Object.keys(r.attributes).forEach(function(t){var n=r.attributes[t].append(e,i),a=e.scopeAttrib(t);Object.keys(new Yt).forEach(function(e){i.set(a,"."+e,n[e])})}),n(X),n(Z),Object.keys(r.state).length>0&&(i(f,".dirty=true;"),i.exit(f,".dirty=true;")),i("a1(",e.shared.context,",a0,0);")}function Vt(e,t,r,n){var a=xt(),i=Ot(e,t,r,n);return Ht(a,i),qt(a,i),Gt(a,i),a.compile()}var Yt=dt.Record,$t={add:32774,subtract:32778,"reverse subtract":32779};r.ext_blend_minmax&&($t.min=Qe,$t.max=Xe);var Jt=r.angle_instanced_arrays,Kt=r.webgl_draw_buffers,Qt={dirty:!0},Xt={},Zt=[],er={},tr={};gt(_,ke),gt(j,we),vt(E,"blendColor",[0,0,0,0]),vt(T,"blendEquationSeparate",[nt,nt]),vt(S,"blendFuncSeparate",[rt,tt,rt,tt]),gt(D,_e,!0),vt(O,"depthFunc",at),vt(C,"depthRange",[0,1]),vt(B,"depthMask",!0),vt(F,F,[!0,!0,!0,!0]),gt(P,xe),vt(L,"cullFace",$e),vt(M,M,Ke),vt(z,z,1),gt(R,Ee),vt(I,"polygonOffset",[0,0]),gt(W,Te),gt(H,Se),vt(N,"sampleCoverage",[1,!1]),gt(U,Ae),vt(G,"stencilMask",-1),vt(q,"stencilFunc",[Ze,0,-1]),vt(V,"stencilOpSeparate",[Ye,et,et,et]),vt(Y,"stencilOpSeparate",[$e,et,et,et]),gt($,je),vt(J,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),vt(K,K,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var rr={gl:e,context:bt,strings:t,next:Xt,current:Qt,draw:ht,elements:oe,buffer:ie,shader:mt,attributes:dt.state,uniforms:ye,framebuffer:be,extensions:r,isBufferArgs:n},nr={primTypes:m,compareFuncs:ut,blendFuncs:ft,blendEquations:$t,stencilOps:st,glTypes:h,orientationType:lt};Kt&&(nr.backBuffer=[$e],nr.drawBuffer=l(d.maxDrawbuffers,function(e){return 0===e?[0]:l(e,function(e){return ot+e})}));var ar=0;return{next:Xt,current:Qt,procs:function(){var e=xt(),t=e.proc("poll"),r=e.proc("refresh"),n=e.block();t(n),r(n);var a=e.shared,i=a.gl,o=a.next,f=a.current;return n(f,".dirty=false;"),Bt(e,t),r(a.framebuffer,".dirty=true;"),Bt(e,r),Object.keys(er).forEach(function(a){var u=er[a],s=n.def(o,".",a),c=e.block();c("if(",s,"){",i,".enable(",u,")}else{",i,".disable(",u,")}",f,".",a,"=",s,";"),r(c),t("if(",s,"!==",f,".",a,"){",c,"}")}),Object.keys(tr).forEach(function(a){var u,s,c=tr[a],p=Qt[a],d=e.block();if(d(i,".",c,"("),Array.isArray(p)){var m=p.length;u=e.global.def(o,".",a),s=e.global.def(f,".",a),d(l(m,function(e){return u+"["+e+"]"}),");",l(m,function(e){return s+"["+e+"]="+u+"["+e+"];"}).join("")),t("if(",l(m,function(e){return u+"["+e+"]!=="+s+"["+e+"]"}).join("||"),"){",d,"}")}else u=n.def(o,".",a),s=n.def(f,".",a),d(u,");",f,".",a,"=",u,";"),t("if(",u,"!==",s,"){",d,"}");r(d)}),e.compile()}(),compile:Vt}}},{"./constants/dtypes.json":4,"./constants/primitives.json":5,"./util/check":18,"./util/codegen":20,"./util/is-ndarray":22,"./util/is-typed-array":23,"./util/loop":24}],8:[function(e,t,r){function n(e,t){this.id=l++,this.type=e,this.data=t}function a(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function i(e){if(0===e.length)return[];var t=e.charAt(0),r=e.charAt(e.length-1);if(e.length>1&&t===r&&('"'===t||"'"===t))return['"'+a(e.substr(1,e.length-2))+'"'];var n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(n)return i(e.substr(0,n.index)).concat(i(n[1])).concat(i(e.substr(n.index+n[0].length)));var o=e.split(".");if(1===o.length)return['"'+a(e)+'"'];for(var f=[],u=0;u<o.length;++u)f=f.concat(i(o[u]));return f}function o(e){return"["+i(e).join("][")+"]"}function f(e,t){switch(typeof t){case"boolean":case"number":case"string":return new n(e,o(t+""));case"undefined":return new n(e|d,null);default:c.raise("invalid property type")}}function u(e){return"function"==typeof e&&!e._reglType||e instanceof n}function s(e,t){if(e instanceof n){if(e.type&d)return new n(e.type&~d,o(t))}else if("function"==typeof e)return new n(p,e);return e}var c=e("./util/check"),l=0,p=0,d=128;t.exports={define:f,isDynamic:u,unbox:s,accessor:o}},{"./util/check":18}],9:[function(e,t,r){var n=e("./util/check"),a=e("./util/is-typed-array"),i=e("./util/is-ndarray"),o=e("./constants/primitives.json"),f=e("./constants/usage.json"),u=0,s=1,c=4,l=5120,p=5121,d=5122,m=5123,h=5124,b=5125,y=34963,g=35040,v=35044;t.exports=function(e,t,r){function x(e){this.buffer=e,this.primType=c,this.vertCount=0,this.type=0}function w(e){var t=E.pop();return t||(t=new x(r.create(null,y,!0)._buffer)),A(t,e,g,-1,-1,0,0),t}function k(e){E.push(e)}function A(e,o,f,y,g,v,x){var w=x;x||a(o)&&(!i(o)||a(o.data))||(w=t.oes_element_index_uint?b:m),e.buffer.bind(),r._initBuffer(e.buffer,o,f,w,3);var k=x;if(!x){switch(e.buffer.dtype){case p:case l:k=p;break;case m:case d:k=m;break;case b:case h:k=b;break;default:n.raise("unsupported type for element array")}e.buffer.dtype=k}e.type=k,n(k!==b||!!t.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var A=g;A<0&&(A=e.buffer.byteLength,k===m?A>>=1:k===b&&(A>>=2)),e.vertCount=A;var _=y;if(y<0){_=c;var j=e.buffer.dimension;1===j&&(_=u),2===j&&(_=s),3===j&&(_=c)}e.primType=_}function _(t){function u(t){if(t)if("number"==typeof t)s(t),l.primType=c,l.vertCount=0|t,l.type=p;else{var r=null,d=v,m=-1,h=-1,b=0,g=0;if(Array.isArray(t)||a(t)||i(t)?r=t:(n.type(t,"object","invalid arguments for elements"),"data"in t&&(r=t.data,n(Array.isArray(r)||a(r)||i(r),"invalid data for element buffer")),"usage"in t&&(n.parameter(t.usage,f,"invalid element buffer usage"),d=f[t.usage]),"primitive"in t&&(n.parameter(t.primitive,o,"invalid element buffer primitive"),m=o[t.primitive]),"count"in t&&(n("number"==typeof t.count&&t.count>=0,"invalid vertex count for elements"),h=0|t.count),"length"in t&&(b=0|t.length),"type"in t&&(n.parameter(t.type,j,"invalid buffer type"),g=j[t.type])),r)A(l,r,d,m,h,b,g);else{var x=l.buffer;x.bind(),e.bufferData(y,b,d),x.dtype=g||p,x.usage=d,x.dimension=3,x.byteLength=b,l.primType=m<0?c:m,l.vertCount=h<0?0:h,l.type=x.dtype}}else s(),l.primType=c,l.vertCount=0,l.type=p;return u}var s=r.create(null,y,!0),l=new x(s._buffer);return u(t),u._reglType="elements",u._elements=l,u.subdata=function(e,t){return s.subdata(e,t),u},u.destroy=function(){n(null!==l.buffer,"must not double destroy elements"),s.destroy(),l.buffer=null},u}var j={uint8:p,uint16:m};t.oes_element_index_uint&&(j.uint32=b),x.prototype.bind=function(){this.buffer.bind()};var E=[];return{create:_,createStream:w,destroyStream:k,getElements:function(e){return"function"==typeof e&&e._elements instanceof x?e._elements:null}}}},{"./constants/primitives.json":5,"./constants/usage.json":6,"./util/check":18,"./util/is-ndarray":22,"./util/is-typed-array":23}],10:[function(e,t,r){t.exports=function(e){function t(){["oes_texture_float","oes_texture_float_linear","oes_texture_half_float","oes_texture_half_float_linear","oes_standard_derivatives","oes_element_index_uint","oes_fbo_render_mipmap","webgl_depth_texture","webgl_draw_buffers","webgl_color_buffer_float","ext_texture_filter_anisotropic","ext_frag_depth","ext_blend_minmax","ext_shader_texture_lod","ext_color_buffer_half_float","ext_srgb","angle_instanced_arrays","webgl_compressed_texture_s3tc","webgl_compressed_texture_atc","webgl_compressed_texture_pvrtc","webgl_compressed_texture_etc1"].forEach(function(t){try{r[t]=e.getExtension(t)}catch(e){}})}var r={};return t(),{extensions:r,refresh:t}}},{}],11:[function(e,t,r){var n=e("./util/check"),a=e("./util/values"),i=e("./util/extend"),o=36160,f=36161,u=3553,s=34067,c=34069,l=36064,p=36096,d=36128,m=33306,h=5121,b=5126,y=36193,g=6408,v=32854,x=32855,w=36194,k=33189,A=36168,_=6402,j=34041,E=35907,T=34836,S=34842,D=34843,O=36053,C=36054,B=36055,F=36057,P=36061;t.exports=function(e,t,r,L,M){function z(e,t,r,n){this.target=e,this.level=t,this.texture=r,this.renderbuffer=n}function R(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function I(e,t){var r=t.width,a=t.height;if(e.texture){var i=e.texture._texture,o=Math.max(1,i.params.width>>e.level),f=Math.max(1,i.params.height>>e.level);r=r||o,a=a||f,n(o===r&&f===a,"inconsistent width/height for supplied texture"),n(i.pollId<0,"polling fbo textures not supported"),i.refCount+=1}else{var u=e.renderbuffer._renderbuffer;r=r||u.width,a=a||u.height,n(u.width===r&&u.height===a,"inconsistent width/height for renderbuffer"),n(se.indexOf(u.format)>=0,"renderbuffer format not compatible with color channels"),u.refCount+=1}t.width=r,t.height=a}function W(t,r){r?r.texture?e.framebufferTexture2D(o,t,r.target,r.texture._texture.texture,r.level):e.framebufferRenderbuffer(o,t,f,r.renderbuffer._renderbuffer.renderbuffer):e.framebufferTexture2D(o,t,u,null,0)}function H(e,t,r,n,a,i){if(e.texture){var o=e.texture;if(t)return o({format:r,type:n,width:a,height:i}),o._texture.refCount+=1,!0}else{var f=e.renderbuffer;if(!t)return f({format:r,width:a,height:i}),f._renderbuffer.refCount+=1,!0}return R(e),!1}function N(e){var t=u,r=0,a=null,i=null,o=e;"object"==typeof e&&(o=e.data,"level"in e&&(r=0|e.level),"target"in e&&(t=0|e.target)),n.type(o,"function","invalid attachment data");var l=e._reglType;return"texture"===l?(a=e,a._texture.target===s?n(t>=c&&t<c+6,"invalid cube map target"):n(t===u)):"renderbuffer"===l?(i=e,t=f,r=0):n.raise("invalid regl object for attachment"),new z(t,r,a,i)}function U(e){return e&&(e.texture||e.renderbuffer)}function G(){this.id=de++,me[this.id]=this,this.framebuffer=null,this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null,this.ownsColor=!1,this.ownsDepthStencil=!1}function q(a){e.isFramebuffer(a.framebuffer)||(a.framebuffer=e.createFramebuffer()),Q.dirty=!0,e.bindFramebuffer(o,a.framebuffer);for(var i=a.colorAttachments,f=0;f<i.length;++f)W(l+f,i[f]);for(f=i.length;f<r.maxColorAttachments;++f)W(l+f,null);W(p,a.depthAttachment),W(d,a.stencilAttachment),W(m,a.depthStencilAttachment),t.webgl_draw_buffers&&t.webgl_draw_buffers.drawBuffersWEBGL(pe[i.length]);var u=e.checkFramebufferStatus(o);u!==O&&n.raise("framebuffer configuration not supported, status = "+X[u])}function V(e){e.colorAttachments.forEach(R),R(e.depthAttachment),R(e.stencilAttachment),R(e.depthStencilAttachment)}function Y(t){var r=t.framebuffer;n(r,"must not double destroy framebuffer"),e.isFramebuffer(r)&&e.deleteFramebuffer(r)}function $(r){function a(r){var o,s=r||{},c=t.webgl_draw_buffers,l=0,p=0;if("shape"in s){var d=s.shape;n(Array.isArray(d)&&d.length>=2,"invalid shape for framebuffer"),l=d[0],p=d[1]}else"radius"in s&&(l=p=s.radius),"width"in s&&(l=s.width),"height"in s&&(p=s.height);var m=null,h=!1;if("colorBuffers"in s||"colorBuffer"in s){var b=s.colorBuffers||s.colorBuffer;for(Array.isArray(b)||(b=[b]),i.width=l,i.height=p,b.length>1&&n(c,"multiple render targets not supported"),n(b.length>=0,"must specify at least one color attachment"),m=b.map(N),o=0;o<m.length;++o){var y=m[o];n.framebufferFormat(y,ue,se),I(y,i)}l=i.width,p=i.height}else{var g=!0,v="rgba",x="uint8",w=1;if(h=!0,i.width=l=l||e.drawingBufferWidth,i.height=p=p||e.drawingBufferHeight,"format"in s&&(v=s.format,n.parameter(v,fe,"invalid color format"),g=v in Z),"type"in s&&(n(g,"colorType can not be set for renderbuffer targets"),x=s.type,n.parameter(x,le,"invalid color type")),"colorCount"in s&&(w=0|s.colorCount,n(w>=0,"color count must be positive")),i.ownsColor)for(m=i.colorAttachments;m.length>w;)R(m.pop());else m=[];for(o=0;o<m.length;++o)H(m[o],g,v,x,l,p)||(m[o--]=m[m.length-1],m.pop());for(;m.length<w;)g?m.push(new z(u,0,L.create2D({format:v,type:x,width:l,height:p},u),null)):m.push(new z(f,0,null,M.create({format:v,width:l,height:p})))}n(m.length>0,"must specify at least one color buffer"),i.width=l,i.height=p;var k=null,A=null,_=null,j=!1,E=0;if("depthBuffer"in s&&(k=N(s.depthBuffer),n.framebufferFormat(k,ae,te),E+=1),"stencilBuffer"in s&&(A=N(s.stencilBuffer),n.framebufferFormat(A,ie,re),E+=1),"depthStencilBuffer"in s&&(_=N(s.depthStencilBuffer),n.framebufferFormat(_,oe,ne),E+=1),k||A||_)n(1===E,"can specify only one of depth, stencil or depthStencil attachment"),I(k||A||_,i);else{var T=!0,S=!1,D=!1;"depth"in s&&(T=!!s.depth),"stencil"in s&&(S=!!s.stencil),"depthTexture"in s&&(D=!!s.depthTexture);var O=i.depthAttachment||i.stencilAttachment||i.depthStencilAttachment,C=null;if(T||S){if(j=!0,D){n(t.webgl_depth_texture,"depth texture extension not supported");var B;n(T,"stencil only textures not supported"),B=S?"depth stencil":"depth",i.ownsDepthStencil&&O.texture?(O.texture({format:B,width:l,height:p}),O.texture._texture.refCount+=1,C=O):C=new z(u,0,L.create({format:B,width:l,height:p},u),null)}else{var F;F=T?S?"depth stencil":"depth":"stencil",i.ownsDepthStencil&&O.renderbuffer?(O.renderbuffer({format:F,width:l,height:p}),O.renderbuffer._renderbuffer.refCount+=1,C=O):C=new z(f,0,null,M.create({format:F,width:l,height:p}))}T?S?_=C:k=C:A=C}}return V(i),i.colorAttachments=m,i.depthAttachment=k,i.stencilAttachment=A,i.depthStencilAttachment=_,i.ownsColor=h,i.ownsDepthStencil=j,a.color=m.map(U),a.depth=U(k),a.stencil=U(A),a.depthStencil=U(_),q(i),a.width=i.width,a.height=i.height,a}var i=new G;return a(r),a._reglType="framebuffer",a._framebuffer=i,a._destroy=function(){Y(i)},a}function J(){a(me).forEach(q)}function K(){a(me).forEach(Y)}var Q={current:null,next:null,dirty:!1},X={};X[O]="complete",X[C]="incomplete attachment",X[F]="incomplete dimensions",X[B]="incomplete, missing attachment",X[P]="unsupported";var Z={rgba:g},ee={rgba4:v,rgb565:w,"rgb5 a1":x};t.ext_srgb&&(ee.srgba=E),t.ext_color_buffer_half_float&&(ee.rgba16f=S,ee.rgb16f=D),t.webgl_color_buffer_float&&(ee.rgba32f=T);var te=[k],re=[A],ne=[j],ae=[],ie=[],oe=[];t.webgl_depth_texture&&(ae.push(_),oe.push(j));var fe=i(i({},Z),ee),ue=a(Z),se=a(ee),ce=h,le={uint8:h};t.oes_texture_half_float&&(ce=le["half float"]=y),t.oes_texture_float&&(ce=le.float=b),le.best=ce;var pe=function(){for(var e=new Array(r.maxDrawbuffers),t=0;t<=r.maxDrawbuffers;++t)for(var n=e[t]=new Array(t),a=0;a<t;++a)n[a]=l+a;return e}(),de=0,me={};return i(Q,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof G)return t}return null},create:$,clear:K,refresh:J})}},{"./util/check":18,"./util/extend":21,"./util/values":28}],12:[function(e,t,r){var n=3408,a=3410,i=3411,o=3412,f=3413,u=3414,s=3415,c=33901,l=33902,p=3379,d=3386,m=34921,h=36347,b=36348,y=35661,g=35660,v=34930,x=36349,w=34076,k=34024,A=7936,_=7937,j=7938,E=35724,T=34047,S=36063,D=34852;t.exports=function(e,t){var r=1;t.ext_texture_filter_anisotropic&&(r=e.getParameter(T));var O=1,C=1;return t.webgl_draw_buffers&&(O=e.getParameter(D),C=e.getParameter(S)),{colorBits:[e.getParameter(a),e.getParameter(i),e.getParameter(o),e.getParameter(f)],depthBits:e.getParameter(u),stencilBits:e.getParameter(s),subpixelBits:e.getParameter(n),extensions:Object.keys(t).filter(function(e){return!!t[e]}),maxAnisotropic:r,maxDrawbuffers:O,maxColorAttachments:C,pointSizeDims:e.getParameter(c),lineWidthDims:e.getParameter(l),maxViewportDims:e.getParameter(d),maxCombinedTextureUnits:e.getParameter(y),maxCubeMapSize:e.getParameter(w),maxRenderbufferSize:e.getParameter(k),maxTextureUnits:e.getParameter(v),maxTextureSize:e.getParameter(p),maxAttributes:e.getParameter(m),maxVertexUniforms:e.getParameter(h),maxVertexTextureUnits:e.getParameter(g),maxVaryingVectors:e.getParameter(b),maxFragmentUniforms:e.getParameter(x),glsl:e.getParameter(E),renderer:e.getParameter(_),vendor:e.getParameter(A),version:e.getParameter(j)}}},{}],13:[function(e,t,r){var n=e("./util/check"),a=e("./util/is-typed-array"),i=6408,o=5121,f=3333;t.exports=function(e,t,r){function u(u){var s=u||{};a(u)?s={data:s}:2===arguments.length?s={width:0|arguments[0],height:0|arguments[1]}:"object"!=typeof u&&(s={}),t();var c=s.x||0,l=s.y||0,p=s.width||r.viewportWidth,d=s.height||r.viewportHeight,m=p*d*4,h=s.data||new Uint8Array(m);return n.isTypedArray(h,"data buffer for regl.read() must be a typedarray"),n(h.byteLength>=m,"data buffer for regl.read() too small"),e.pixelStorei(f,4),e.readPixels(c,l,p,d,i,o,h),h}return u}},{"./util/check":18,"./util/is-typed-array":23}],14:[function(e,t,r){var n=e("./util/check"),a=e("./util/values"),i=36161,o=32854,f=32855,u=36194,s=33189,c=36168,l=34041,p=35907,d=34836,m=34842,h=34843;t.exports=function(e,t,r){function b(){this.id=A++,this.refCount=1,this.renderbuffer=null,this.format=o,this.width=0,this.height=0}function y(t){e.isRenderbuffer(t.renderbuffer)||(t.renderbuffer=e.createRenderbuffer()),e.bindRenderbuffer(i,t.renderbuffer),e.renderbufferStorage(i,t.format,t.width,t.height)}function g(t){var r=t.renderbuffer;n(r,"must not double destroy renderbuffer"),e.bindRenderbuffer(i,null),e.isRenderbuffer(r)&&e.deleteRenderbuffer(r),t.renderbuffer=null,t.refCount=0,delete _[t.id]}function v(e){function t(e){var i=e||{},f=0,u=0;if("shape"in i){var s=i.shape;n(Array.isArray(s)&&s.length>=2,"invalid renderbuffer shape"),f=0|s[0],u=0|s[1]}else"radius"in i&&(f=u=0|i.radius),"width"in i&&(f=0|i.width),"height"in i&&(u=0|i.height);var c=r.maxRenderbufferSize;if(n(f>=0&&u>=0&&f<=c&&u<=c,"invalid renderbuffer size"),t.width=a.width=Math.max(f,1),t.height=a.height=Math.max(u,1),a.format=o,"format"in i){var l=i.format;n.parameter(l,k,"invalid render buffer format"),a.format=k[l]}return y(a),t}var a=new b;return _[a.id]=a,t(e),t._reglType="renderbuffer",t._renderbuffer=a,t.destroy=function(){a.decRef()},t}function x(){a(_).forEach(y)}function w(){a(_).forEach(g)}var k={rgba4:o,rgb565:u,"rgb5 a1":f,depth:s,stencil:c,"depth stencil":l};t.ext_srgb&&(k.srgba=p),t.ext_color_buffer_half_float&&(k.rgba16f=m,k.rgb16f=h),t.webgl_color_buffer_float&&(k.rgba32f=d);var A=0,_={};return b.prototype.decRef=function(){0===--this.refCount&&g(this)},{create:v,refresh:x,clear:w}}},{"./util/check":18,"./util/values":28}],15:[function(e,t,r){var n=e("./util/check"),a=e("./util/values"),i=35632,o=35633,f=35718,u=35721;t.exports=function(e,t){function r(e,t,r,n){this.name=e,this.id=t,this.location=r,this.info=n}function s(e,t){for(var r=0;r<e.length;++r)if(e[r].id===t.id)return void(e[r].location=t.location);e.push(t)}function c(r,a,o){var f=r===i?d:m,u=f[a];if(!u){var s=t.str(a);u=e.createShader(r),e.shaderSource(u,s),e.compileShader(u),n.shaderError(e,u,s,r,o),f[a]=u}return u}function l(e,t){this.id=y++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[]}function p(a,l){var p,d,m=c(i,a.fragId),h=c(o,a.vertId),b=a.program=e.createProgram();e.attachShader(b,m),e.attachShader(b,h),e.linkProgram(b),n.linkError(e,b,t.str(a.fragId),t.str(a.vertId),l);var y=e.getProgramParameter(b,f),g=a.uniforms;for(p=0;p<y;++p)if(d=e.getActiveUniform(b,p))if(d.size>1)for(var v=0;v<d.size;++v){var x=d.name.replace("[0]","["+v+"]");s(g,new r(x,t.id(x),e.getUniformLocation(b,x),d))}else s(g,new r(d.name,t.id(d.name),e.getUniformLocation(b,d.name),d));var w=e.getProgramParameter(b,u),k=a.attributes;for(p=0;p<w;++p)d=e.getActiveAttrib(b,p),d&&s(k,new r(d.name,t.id(d.name),e.getAttribLocation(b,d.name),d))}var d={},m={},h={},b=[],y=0;return{clear:function(){var t=e.deleteShader.bind(e);a(d).forEach(t),d={},a(m).forEach(t),m={},b.forEach(function(t){e.deleteProgram(t.program)}),b.length=0,h={}},refresh:function(){d={},m={},b.forEach(p)},program:function(e,t,r){n(e>=0,"missing vertex shader"),n(t>=0,"missing fragment shader");var a=h[t];a||(a=h[t]={});var i=a[e];return i||(i=new l(t,e),p(i,r),a[e]=i,b.push(i)),i},shader:c,frag:null,vert:null}}},{"./util/check":18,"./util/values":28}],16:[function(e,t,r){t.exports=function(){var e={"":0},t=[""];return{id:function(r){var n=e[r];return n?n:(n=e[r]=t.length,t.push(r),n)},str:function(e){return t[e]}}}},{}],17:[function(e,t,r){function n(e){return"[object "+e+"]"}function a(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function i(e){if(!Array.isArray(e))return!1;var t=e.length;if(0===t||!Array.isArray(e[0]))return!1;for(var r=e[0].length,n=1;n<t;++n)if(!Array.isArray(e[n])||e[n].length!==r)return!1;return!0}function o(e){return Object.prototype.toString.call(e)}function f(e){return o(e)===Ie}function u(e){return o(e)===We}function s(e){return o(e)===He}function c(e){return o(e)===Ne}function l(e){if(!e)return!1;var t=o(e);return Ue.indexOf(t)>=0||(a(e)||i(e)||A(e))}function p(e){return 0|T[Object.prototype.toString.call(e)]}function d(e,t){var r=e.width*e.height*e.channels;switch(v(t.length===r,"inconsistent array length for texture"),e.type){case fe:case ue:case se:case ce:var n=_.allocType(e.type,r);n.set(t),e.data=n;break;case $:e.data=j(t);break;default:v.raise("unsupported texture type, must specify a typed array")}}function m(e,t){return _.allocType(e.type===$?ce:e.type,t)}function h(e,t){e.type===$?(e.data=j(t),_.freeType(t)):e.data=t}function b(e,t,r,n,a,i){for(var o=e.width,f=e.height,u=e.channels,s=o*f*u,c=m(e,s),l=0,p=0;p<f;++p)for(var d=0;d<o;++d)for(var b=0;b<u;++b)c[l++]=t[r*d+n*p+a*b+i];h(e,c)}function y(e,t,r,n){for(var a=r*n,i=m(e,a),o=0,f=0;f<n;++f)for(var u=t[f],s=0;s<r;++s)i[o++]=u[s];h(e,i)}function g(e,t,r,n,a){for(var i=r*n*a,o=m(e,i),f=0,u=0;u<n;++u)for(var s=t[u],c=0;c<r;++c)for(var l=s[c],p=0;p<a;++p)o[f++]=l[p];h(e,o)}var v=e("./util/check"),x=e("./util/extend"),w=e("./util/values"),k=e("./util/is-typed-array"),A=e("./util/is-ndarray"),_=e("./util/pool"),j=e("./util/to-half-float"),E=e("./constants/arraytypes.json"),T=e("./constants/arraytypes.json"),S=34467,D=3553,O=34067,C=34069,B=6408,F=6406,P=6407,L=6409,M=6410,z=32854,R=32855,I=36194,W=32819,H=32820,N=33635,U=34042,G=6402,q=34041,V=35904,Y=35906,$=36193,J=33776,K=33777,Q=33778,X=33779,Z=35986,ee=35987,te=34798,re=35840,ne=35841,ae=35842,ie=35843,oe=36196,fe=5121,ue=5123,se=5125,ce=5126,le=10242,pe=10243,de=10497,me=33071,he=33648,be=10240,ye=10241,ge=9728,ve=9729,xe=9984,we=9985,ke=9986,Ae=9987,_e=33170,je=4352,Ee=4353,Te=4354,Se=34046,De=3317,Oe=37440,Ce=37441,Be=37443,Fe=37444,Pe=33984,Le=[xe,ke,we,Ae],Me=[0,L,M,P,B],ze={};ze[L]=ze[F]=ze[G]=1,ze[q]=ze[M]=2,ze[P]=3,ze[B]=4;var Re={};Re[z]=W,Re[I]=N,Re[R]=H,Re[G]=se,Re[q]=U;var Ie=n("HTMLCanvasElement"),We=n("CanvasRenderingContext2D"),He=n("HTMLImageElement"),Ne=n("HTMLVideoElement"),Ue=Object.keys(E).concat([Ie,We,He,Ne]);t.exports=function(e,t,r,n,o){function m(){this.internalformat=B,this.format=B,this.type=fe,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=0,this.width=0,this.height=0,this.channels=4}function h(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function j(e,t){if("object"==typeof t&&t){if("premultiplyAlpha"in t&&(v.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(v.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(v.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(v.parameter(t.colorSpace,lt,"invalid colorSpace"),e.colorSpace=lt[t.colorSpace]),"type"in t){var n=t.type;v.parameter(n,pt,"invalid texture type"),e.type=pt[n]}var a=e.width,i=e.height,o=e.channels,f=!1;"shape"in t?(v(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),a=t.shape[0],i=t.shape[1],3===t.shape.length&&(o=t.shape[2],v(o>0&&o<=4,"invalid number of channels"),f=!0),v(a>0&&a<=r.maxTextureSize,"invalid width"),v(i>0&&i<=r.maxTextureSize,"invalid height")):("radius"in t&&(a=i=t.radius,v(a>0&&a<=r.maxTextureSize,"invalid radius")),"width"in t&&(a=t.width,v(a>0&&a<=r.maxTextureSize,"invalid width")),"height"in t&&(i=t.height,v(i>0&&i<=r.maxTextureSize,"invalid height")),"channels"in t&&(o=t.channels,v(o>0&&o<=4,"invalid number of channels"),f=!0)),e.width=0|a,e.height=0|i,e.channels=0|o;var u=!1;if("format"in t){var s=t.format;v.parameter(s,dt,"invalid texture format");var c=e.internalformat=dt[s];e.format=yt[c],s in pt&&("type"in t||(e.type=pt[s])),s in mt&&(e.compressed=!0),u=!0}!f&&u?e.channels=ze[e.format]:f&&!u?e.channels!==Me[e.format]&&(e.format=e.internalformat=Me[e.channels]):u&&f&&v(e.channels===ze[e.format],"number of channels inconsistent with specified format")}}function E(t){e.pixelStorei(Oe,t.flipY),e.pixelStorei(Ce,t.premultiplyAlpha),e.pixelStorei(Be,t.colorSpace),e.pixelStorei(De,t.unpackAlignment)}function T(){m.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function Re(e,t){var n=null;if(l(t)?n=t:t&&(v.type(t,"object","invalid pixel data type"),j(e,t),"x"in t&&(e.xOffset=0|t.x),"y"in t&&(e.yOffset=0|t.y),l(t.data)&&(n=t.data)),v(!e.compressed||n instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),t.copy){v(!n,"can not specify copy and data field for the same texture");var m=o.viewportWidth,h=o.viewportHeight;e.width=e.width||m-e.xOffset,e.height=e.height||h-e.yOffset,e.needsCopy=!0,v(e.xOffset>=0&&e.xOffset<m&&e.yOffset>=0&&e.yOffset<h&&e.width>0&&e.width<=m&&e.height>0&&e.height<=h,"copy texture read out of bounds")}else if(n){if(k(n))e.data=n,"type"in t||e.type!==fe||(e.type=p(n));else if(a(n))d(e,n),e.alignment=1,e.needsFree=!0;else if(A(n)){var x=n.data;Array.isArray(x)||e.type!==fe||(e.type=p(x));var w,_,E,T,S,D,O=n.shape,C=n.stride;3===O.length?(E=O[2],D=C[2]):(v(2===O.length,"invalid ndarray pixel data, must be 2 or 3D"),E=1,D=1),w=O[0],_=O[1],T=C[0],S=C[1],e.alignment=1,e.width=w,e.height=_,e.channels=E,e.format=e.internalformat=Me[E],e.needsFree=!0,b(e,x,T,S,D,n.offset)}else if(f(n)||u(n))f(n)?e.element=n:e.element=n.canvas,e.width=e.element.width,e.height=e.element.height;else if(s(n))e.element=n,e.width=n.naturalWidth,e.height=n.naturalHeight;else if(c(n))e.element=n,e.width=n.videoWidth,e.height=n.videoHeight,e.needsPoll=!0;else if(i(n)){var B=n[0].length,F=n.length,P=1;Array.isArray(n[0][0])?(P=n[0][0].length,g(e,n,B,F,P)):y(e,n,B,F),e.alignment=1,e.width=B,e.height=F,e.channels=P,e.format=e.internalformat=Me[P],e.needsFree=!0}}else e.width=e.width||1,e.height=e.height||1;e.type===ce?v(r.extenstions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):e.type===$&&v(r.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function Ie(t,r,a){var i=t.element,o=t.data,f=t.internalformat,u=t.format,s=t.type,c=t.width,l=t.height;
E(t),i?e.texImage2D(r,a,u,u,s,i):t.compressed?e.compressedTexImage2D(r,a,f,c,l,0,o):t.needsCopy?(n(),e.copyTexImage2D(r,a,u,t.xOffset,t.yOffset,c,l,0)):e.texImage2D(r,a,u,c,l,0,u,s,o)}function We(t,r,a,i,o){var f=t.element,u=t.data,s=t.internalformat,c=t.format,l=t.type,p=t.width,d=t.height;E(t),f?e.texSubImage2D(r,o,a,i,c,l,f):t.compressed?e.compressedTexSubImage2D(r,o,a,i,s,p,d,u):t.needsCopy?(n(),e.copyTexSubImage2D(r,o,a,i,t.xOffset,t.yOffset,p,d)):e.texSubImage2D(r,o,a,i,p,d,c,l,u)}function He(){return gt.pop()||new T}function Ne(e){e.needsFree&&_.freeType(e.data),T.call(e),gt.push(e)}function Ue(){m.call(this),this.genMipmaps=!1,this.mipmapHint=je,this.mipmask=0,this.images=Array(16)}function Ge(e,t,r){var n=e.images[0]=He();e.mipmask=1,n.width=e.width=t,n.height=e.height=r}function qe(e,t){var r=null;if(l(t))r=e.images[0]=He(),Re(r,t),e.mipmask=1;else if(j(e,t),Array.isArray(t.mipmap))for(var n=t.mipmap,a=0;a<n.length;++a)r=e.images[a]=He(),h(r,e),r.width>>=a,r.height>>=a,Re(r,n[a]),e.mipmask|=1<<a;else r=e.images[0]=He(),h(r,e),Re(r,t),e.mipmask=1;h(e,e.images[0])}function Ve(e,t){for(var r=e.images,n=0;n<r.length;++n){if(!r[n])return;Ie(r[n],t,n)}}function Ye(){var e=vt.pop()||new Ue;m.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function $e(e){for(var t=e.images,r=0;r<t.length;++r)t[r]&&Ne(t[r]),t[r]=null;vt.push(e)}function Je(){this.minFilter=ge,this.magFilter=ge,this.wrapS=me,this.wrapT=me,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=je}function Ke(e,t){if("min"in t){var n=t.min;v.parameter(n,ct),e.minFilter=ct[n],Le.indexOf(e.minFilter)>=0&&(e.genMipmaps=!0)}if("mag"in t){var a=t.mag;v.parameter(a,st),e.magFilter=st[a]}var i=e.wrapS,o=e.wrapT;if("wrap"in t){var f=t.wrap;"string"==typeof f?(v.parameter(f,ut),i=o=ut[f]):Array.isArray(f)&&(v.parameter(f[0],ut),v.parameter(f[1],ut),i=ut[f[0]],o=ut[f[1]])}else{if("wrapS"in t){var u=t.wrapS;v.parameter(u,ut),i=ut[u]}if("wrapT"in t){var s=t.wrapT;v.parameter(s,ut),o=ut[s]}}if(e.wrapS=i,e.wrapT=o,"anisotropic"in t){var c=t.anisotropic;v("number"==typeof c&&c>=1&&c<=r.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var l=!1;switch(typeof t.mipmap){case"string":v.parameter(t.mipmap,ft,"invalid mipmap hint"),e.mipmapHint=ft[t.mipmap],e.genMipmaps=!0,l=!0;break;case"boolean":l=e.genMipmaps=t.mipmap;break;case"object":v(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,l=!0;break;default:v.raise("invalid mipmap type")}!l||"min"in t||(e.minFilter=xe)}}function Qe(r,n){e.texParameteri(n,ye,r.minFilter),e.texParameteri(n,be,r.magFilter),e.texParameteri(n,le,r.wrapS),e.texParameteri(n,pe,r.wrapT),t.ext_texture_filter_anisotropic&&e.texParameteri(n,Se,r.anisotropic),r.genMipmaps&&(e.hint(_e,r.mipmapHint),e.generateMipmap(n))}function Xe(){var e=xt.pop()||new Je;return Je.call(e),e}function Ze(e){xt.push(e)}function et(t){m.call(this),this.mipmask=0,this.id=wt++,this.refCount=1,this.target=t,this.texture=e.createTexture(),this.unit=-1,this.bindCount=0}function tt(t){e.activeTexture(Pe),e.bindTexture(t.target,t.texture)}function rt(){var t=_t[0];t?e.bindTexture(t.target,t.texture):e.bindTexture(D,null)}function nt(t){var r=t.texture;v(r,"must not double destroy texture");var n=t.unit,a=t.target;n>=0&&(e.activeTexture(Pe+n),e.bindTexture(a,null),_t[n]=null),e.deleteTexture(r),t.texture=null,t.params=null,t.pixels=null,t.refCount=0,delete kt[t.id]}function at(e,t){function n(e,t){var a=Xe(),o=Ye();return"number"==typeof e?"number"==typeof t?Ge(o,0|e,0|t):Ge(o,0|e,0|e):e?(v.type(e,"object","invalid arguments to regl.texture"),Ke(a,e),qe(o,e)):Ge(o,1,1),a.genMipmaps&&(o.mipmask=(o.width<<1)-1),i.mipmask=o.mipmask,h(i,o),v.texture2D(a,o,r),n.width=o.width,n.height=o.height,tt(i),Ve(o,D),Qe(a,D),rt(),Ze(a),$e(o),n}function a(e,t,r,a){v(!!e,"must specify image data");var o=0|t,f=0|r,u=0|a,s=He();return h(s,i),s.width>>=u,s.height>>=u,s.width-=o,s.height-=f,Re(s,e),v(i.type===s.type&&i.format===s.format&&i.internalformat===s.internalformat,"incompatible format for texture.subimage"),v(o>=0&&f>=0&&o+s.width<=i.width&&f+s.height<=i.height,"texture.subimage write out of bounds"),v(i.mipmask&1<<u,"missing mipmap data"),v(s.data||s.element||s.needsCopy,"missing image data"),tt(i),We(s,D,o,f,u),rt(),Ne(s),n}var i=new et(D);return kt[i.id]=i,n(e,t),n.subimage=a,n._reglType="texture2d",n._texture=i,n.destroy=function(){i.decRef()},n}function it(e,t,n,a,i,o){function f(e,t,n,a,i,o){var u,l=Xe();for(u=0;u<6;++u)c[u]=Ye();if("number"!=typeof e&&e)if("object"==typeof e)if(t)qe(c[0],e),qe(c[1],t),qe(c[2],n),qe(c[3],a),qe(c[4],i),qe(c[5],o);else if(Ke(l,e),j(s,e),"faces"in e){var p=e.faces;for(v(Array.isArray(p)&&6===p.length,"cube faces must be a length 6 array"),u=0;u<6;++u)v("object"==typeof p[u]&&!!p[u],"invalid input for cube map face"),h(c[u],s),qe(c[u],p[u])}else for(u=0;u<6;++u)qe(c[u],e);else v.raise("invalid arguments to cube map");else{var d=0|e||1;for(u=0;u<6;++u)Ge(c[u],d,d)}for(h(s,c[0]),l.genMipmaps?s.mipmask=(c[0].width<<1)-1:s.mipmask=c[0].mipmask,v.textureCube(s,l,c,r),f.width=c[0].width,f.height=c[0].height,tt(s),u=0;u<6;++u)Ve(c[u],C+u);for(Qe(l,O),rt(),Ze(l),u=0;u<6;++u)$e(c[u]);return f}function u(e,t,r,n,a){v(!!t,"must specify image data"),v("number"==typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var i=0|r,o=0|n,u=0|a,c=He();return h(c,s),c.width>>=u,c.height>>=u,c.width-=i,c.height-=o,Re(c,t),v(s.type===c.type&&s.format===c.format&&s.internalformat===c.internalformat,"incompatible format for texture.subimage"),v(i>=0&&o>=0&&i+c.width<=s.width&&o+c.height<=s.height,"texture.subimage write out of bounds"),v(s.mipmask&1<<u,"missing mipmap data"),v(c.data||c.element||c.needsCopy,"missing image data"),tt(s),We(c,C+e,i,o,u),rt(),Ne(c),f}var s=new et(O);kt[s.id]=s;var c=new Array(6);return f(e,t,n,a,i,o),f.subimage=u,f._reglType="textureCube",f._texture=s,f.destroy=function(){s.decRef()},f}function ot(){for(var t=0;t<At;++t)e.activeTexture(Pe+t),e.bindTexture(D,null),_t[t]=null;w(kt).forEach(nt)}var ft={"don't care":je,"dont care":je,nice:Te,fast:Ee},ut={repeat:de,clamp:me,mirror:he},st={nearest:ge,linear:ve},ct=x({"nearest mipmap nearest":xe,"linear mipmap nearest":we,"nearest mipmap linear":ke,"linear mipmap linear":Ae,mipmap:Ae},st),lt={none:0,browser:Fe},pt={uint8:fe,rgba4:W,rgb565:N,"rgb5 a1":H},dt={alpha:F,luminance:L,"luminance alpha":M,rgb:P,rgba:B,rgba4:z,"rgb5 a1":R,rgb565:I},mt={};t.ext_srgb&&(dt.srgb=V,dt.srgba=Y),t.oes_texture_float&&(pt.float=ce),t.oes_texture_half_float&&(pt.float16=pt["half float"]=$),t.webgl_depth_texture&&(x(dt,{depth:G,"depth stencil":q}),x(pt,{uint16:ue,uint32:se,"depth stencil":U})),t.webgl_compressed_texture_s3tc&&x(mt,{"rgb s3tc dxt1":J,"rgba s3tc dxt1":K,"rgba s3tc dxt3":Q,"rgba s3tc dxt5":X}),t.webgl_compressed_texture_atc&&x(mt,{"rgb arc":Z,"rgba atc explicit alpha":ee,"rgba atc interpolated alpha":te}),t.webgl_compressed_texture_pvrtc&&x(mt,{"rgb pvrtc 4bppv1":re,"rgb pvrtc 2bppv1":ne,"rgba pvrtc 4bppv1":ae,"rgba pvrtc 2bppv1":ie}),t.webgl_compressed_texture_etc1&&(mt["rgb etc1"]=oe);var ht=Array.prototype.slice.call(e.getParameter(S));Object.keys(mt).forEach(function(e){var t=mt[e];ht.indexOf(t)>=0&&(dt[e]=t)});var bt=Object.keys(dt);r.textureFormats=bt;var yt=bt.reduce(function(e,t){var r=dt[t];return r===L||r===F||r===L||r===M||r===G||r===q?e[r]=r:r===R||t.indexOf("rgba")>=0?e[r]=B:e[r]=P,e},{}),gt=[],vt=[],xt=[],wt=0,kt={},At=r.maxTextureUnits,_t=Array(At).map(function(){return null});return x(et.prototype,{bind:function(){var t=this;t.bindCount+=1;var r=t.unit;if(r<0){for(var n=0;n<At;++n){var a=_t[n];if(a){if(a.bindCount>0)continue;a.unit=-1}_t[n]=t,r=n;break}r>=At&&v.raise("insufficient number of texture units"),t.unit=r,e.activeTexture(Pe+r),e.bindTexture(t.target,t.texture)}return r},unbind:function(){this.bindCount-=1},decRef:function(){0===--this.refCount&&nt(this)}}),{create2D:at,createCube:it,clear:ot,getTexture:function(e){return null}}}},{"./constants/arraytypes.json":3,"./util/check":18,"./util/extend":21,"./util/is-ndarray":22,"./util/is-typed-array":23,"./util/pool":25,"./util/to-half-float":27,"./util/values":28}],18:[function(e,t,r){function n(e){return"undefined"!=typeof btoa?btoa(e):"base64:"+e}function a(e){var t=new Error("(regl) "+e);throw console.error(t),t}function i(e,t){e||a(t)}function o(e){return e?": "+e:""}function f(e,t,r){e in t||a("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join())}function u(e,t){L(e)||a("invalid parameter type"+o(t)+". must be a typed array")}function s(e,t,r){typeof e!==t&&a("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e)}function c(e,t){e>=0&&(0|e)===e||a("invalid parameter type, ("+e+")"+o(t)+". must be a nonnegative integer")}function l(e,t,r){t.indexOf(e)<0&&a("invalid value"+o(r)+". must be one of: "+t)}function p(e,t){for(e+="";e.length<t;)e=" "+e;return e}function d(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function m(e,t){this.number=e,this.line=t,this.errors=[]}function h(e,t,r){this.file=e,this.line=t,this.message=r}function b(){var e=new Error,t=e.stack.toString(),r=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(r)return r[1];var n=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return n?n[1]:"unknown"}function y(){var e=new Error,t=e.stack,r=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(r)return r[1];var n=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return n?n[1]:"unknown"}function g(e,t){var r=e.split("\n"),a=1,i=0,o={unknown:new d,0:new d};o.unknown.name=o[0].name=t||b(),o.unknown.lines.push(new m(0,""));for(var f=0;f<r.length;++f){var u=r[f],s=/^\s*\#\s*(\w+)\s+(.+)\s*$/.exec(u);if(s)switch(s[1]){case"line":var c=/(\d+)(\s+\d+)?/.exec(s[2]);c&&(a=0|c[1],c[2]&&(i=0|c[2],i in o||(o[i]=new d)));break;case"define":var l=/SHADER_NAME(_B64)?\s+(.*)$/.exec(s[2]);l&&(o[i].name=l[1]?n(l[2]):l[2])}o[i].lines.push(new m(a++,u))}return Object.keys(o).forEach(function(e){var t=o[e];t.lines.forEach(function(e){t.index[e.number]=e})}),o}function v(e){var t=[];return e.split("\n").forEach(function(e){var r=/^ERROR\:\s+(\d+)\:(\d+)\:\s*(.*)$/.exec(e);r?t.push(new h(0|r[1],0|r[2],r[3].trim())):e.length>0&&t.push(new h("unknown",0,e))}),t}function x(e,t){t.forEach(function(t){var r=e[t.file];if(r){var n=r.index[t.line];if(n)return n.errors.push(t),void(r.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)})}function w(e,t,r,n,a){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var o=e.getShaderInfoLog(t),f=n===e.FRAGMENT_SHADER?"fragment":"vertex",u=g(r,a),s=v(o);x(u,s),Object.keys(u).forEach(function(e){function t(e,t){n.push(e),a.push(t||"")}var r=u[e];if(r.hasErrors){var n=[""],a=[""];t("file number "+e+": "+r.name+"\n","color:red;text-decoration:underline;font-weight:bold"),r.lines.forEach(function(e){if(e.errors.length>0){t(p(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),t(e.line+"\n","color:red; background-color:yellow; font-weight:bold");var r=0;e.errors.forEach(function(n){var a=n.message,i=/^\s*\'(.*)\'\s*\:\s*(.*)$/.exec(a);if(i){var o=i[1];switch(a=i[2],o){case"assign":o="="}r=Math.max(e.line.indexOf(o,r),0)}else r=0;t(p("| ",6)),t(p("^^^",r+3)+"\n","font-weight:bold"),t(p("| ",6)),t(a+"\n","font-weight:bold")}),t(p("| ",6)+"\n")}else t(p(e.number,4)+"|  "),t(e.line+"\n","color:red")}),"undefined"!=typeof document?(a[0]=n.join("%c"),console.log.apply(console,a)):console.log(n.join(""))}}),i.raise("Error compiling "+f+" shader, "+u[0].name)}}function k(e,t,r,n,a){if(!e.getProgramParameter(t,e.LINK_STATUS)){var o=e.getProgramInfoLog(t),f=g(r,a),u=g(n,a),s='Error linking program with vertex shader, "'+u[0].name+'", and fragment shader "'+f[0].name+'"';"undefined"!=typeof document?console.log("%c"+s+"\n%c"+o,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(s+"\n"+o),i.raise(s)}}function A(e){e._commandRef=b()}function _(e,t,r,n){function a(e){return e?n.id(e):0}function i(e,t){Object.keys(t).forEach(function(t){e[n.id(t)]=!0})}A(e),e._fragId=a(e.static.frag),e._vertId=a(e.static.vert);var o=e._uniformSet={};i(o,t.static),i(o,t.dynamic);var f=e._attributeSet={};i(f,r.static),i(f,r.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic}function j(e,t){var r=y();a(e+" in command "+(t||b())+("unknown"===r?"":" called from "+r))}function E(e,t,r){e||j(t,r||b())}function T(e,t,r,n){e in t||j("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join(),n||b())}function S(e,t,r,n){typeof e!==t&&j("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e,n||b())}function D(e){e()}function O(e,t,r){e.texture?l(e.texture._texture.params.internalformat,t,"unsupported texture format for attachment"):l(e.renderbuffer._renderbuffer.format,r,"unsupported renderbuffer format for attachment")}function C(e,t){return e===Q||e===K||e===X?2:e===Z?4:te[e]*t}function B(e){return!(e&e-1||!e)}function F(e,t,r){var n,a=t.width,o=t.height,f=t.channels;i(a>0&&a<=r.maxTextureSize&&o>0&&o<=r.maxTextureSize,"invalid texture shape"),e.wrapS===z&&e.wrapT===z||i(B(a)&&B(o),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==a&&1!==o&&i(e.minFilter!==I&&e.minFilter!==H&&e.minFilter!==W&&e.minFilter!==N,"min filter requires mipmap"):(i(B(a)&&B(o),"texture must be a square power of 2 to support mipmapping"),i(t.mipmask===(a<<1)-1,"missing or incomplete mipmap data")),t.type===J&&(r.extensions.indexOf("oes_texture_float_linear")<0&&i(e.minFilter===R&&e.magFilter===R,"filter not supported, must enable oes_texture_float_linear"),i(!e.genMipmaps,"mipmap generation not supported with float textures"));var u=t.images;for(n=0;n<16;++n)if(u[n]){var s=a>>n,c=o>>n;i(t.mipmask&1<<n,"missing mipmap data");var l=u[n];i(l.width===s&&l.height===c,"invalid shape for mip images"),i(l.format===t.format&&l.internalformat===t.internalformat&&l.type===t.type,"incompatible type for mip image"),l.compressed||(l.data?i(l.data.byteLength===s*c*Math.max(C(l.type,f),l.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):l.element||l.copy)}else e.genMipmaps||i(0===(t.mipmask&1<<n),"extra mipmap data");t.compressed&&i(!e.genMipmaps,"mipmap generation for compressed images not supported")}function P(e,t,r,n){var a=e.width,o=e.height,f=e.channels;i(a>0&&a<=n.maxTextureSize&&o>0&&o<=n.maxTextureSize,"invalid texture shape"),i(a===o,"cube map must be square"),i(t.wrapS===z&&t.wrapT===z,"wrap mode not supported by cube map");for(var u=0;u<r.length;++u){var s=r[u];i(s.width===a&&s.height===o,"inconsistent cube map face shape"),t.genMipmaps&&(i(!s.compressed,"can not generate mipmap for compressed textures"),i(1===s.mipmask,"can not specify mipmaps and generate mipmaps"));for(var c=s.images,l=0;l<16;++l){var p=c[l];if(p){var d=a>>l,m=o>>l;i(s.mipmask&1<<l,"missing mipmap data"),i(p.width===d&&p.height===m,"invalid shape for mip images"),i(p.format===e.format&&p.internalformat===e.internalformat&&p.type===e.type,"incompatible type for mip image"),p.compressed||(p.data?i(p.data.byteLength===d*m*Math.max(C(p.type,f),p.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):p.element||p.copy)}}}}var L=e("./is-typed-array"),M=e("./extend"),z=33071,R=9728,I=9984,W=9985,H=9986,N=9987,U=5120,G=5121,q=5122,V=5123,Y=5124,$=5125,J=5126,K=32819,Q=32820,X=33635,Z=34042,ee=36193,te={};te[U]=te[G]=1,te[q]=te[V]=te[ee]=te[X]=te[K]=te[Q]=2,te[Y]=te[$]=te[J]=te[Z]=4,t.exports=M(i,{optional:D,raise:a,commandRaise:j,command:E,parameter:f,commandParameter:T,type:s,commandType:S,isTypedArray:u,nni:c,oneOf:l,shaderError:w,linkError:k,callSite:y,saveCommandRef:A,saveDrawInfo:_,framebufferFormat:O,guessCommand:b,texture2D:F,textureCube:P})},{"./extend":21,"./is-typed-array":23}],19:[function(e,t,r){t.exports="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date}},{}],20:[function(e,t,r){function n(e){return Array.prototype.slice.call(e)}function a(e){return n(e).join("")}var i=e("./extend");t.exports=function(){function e(e){for(var t=0;t<l.length;++t)if(l[t]===e)return c[t];var r="g"+s++;return c.push(r),l.push(e),r}function t(){function e(){r.push.apply(r,n(arguments))}function t(){var e="v"+s++;return o.push(e),arguments.length>0&&(r.push(e,"="),r.push.apply(r,n(arguments)),r.push(";")),e}var r=[],o=[];return i(e,{def:t,toString:function(){return a([o.length>0?"var "+o+";":"",a(r)])}})}function r(){function e(e,t){n(e,t,"=",r.def(e,t),";")}var r=t(),n=t(),a=r.toString,o=n.toString;return i(r,{entry:r,exit:n,save:e,set:function(t,n,a){e(t,n),r(t,n,"=",a,";")},toString:function(){return a()+o()}})}function o(){var e=a(arguments),t=r(),o=r(),f=t.toString,u=o.toString;return i(t,{then:function(){return t.apply(t,n(arguments)),this},else:function(){return o.apply(o,n(arguments)),this},toString:function(){var t=u();return t&&(t="else{"+t+"}"),a(["if(",e,"){",f(),"}",t])}})}function f(e,t){function n(){var e="a"+o.length;return o.push(e),e}var o=[];t=t||0;for(var f=0;f<t;++f)n();var u=r(),s=u.toString,c=d[e]=i(u,{arg:n,toString:function(){return a(["function(",o.join(),"){",s(),"}"])}});return c}function u(){var e=['"use strict";',p,"return {"];Object.keys(d).forEach(function(t){e.push('"',t,'":',d[t].toString(),",")}),e.push("}");var t=a(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n"),r=Function.apply(null,c.concat(t));return r.apply(null,l)}var s=0,c=[],l=[],p=t(),d={};return{global:p,link:e,block:t,proc:f,scope:r,cond:o,compile:u}}},{"./extend":21}],21:[function(e,t,r){t.exports=function(e,t){for(var r=Object.keys(t),n=0;n<r.length;++n)e[r[n]]=t[r[n]];return e}},{}],22:[function(e,t,r){var n=e("./is-typed-array");t.exports=function(e){return!!e&&"object"==typeof e&&Array.isArray(e.shape)&&Array.isArray(e.stride)&&"number"==typeof e.offset&&e.shape.length===e.stride.length&&(Array.isArray(e.data)||n(e.data))}},{"./is-typed-array":23}],23:[function(e,t,r){var n=e("../constants/arraytypes.json");t.exports=function(e){return Object.prototype.toString.call(e)in n}},{"../constants/arraytypes.json":3}],24:[function(e,t,r){t.exports=function(e,t){for(var r=Array(e),n=0;n<e;++n)r[n]=t(n);return r}},{}],25:[function(e,t,r){function n(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function a(e){var t,r;return t=(e>65535)<<4,e>>>=t,r=(e>255)<<3,e>>>=r,t|=r,r=(e>15)<<2,e>>>=r,t|=r,r=(e>3)<<1,e>>>=r,t|=r,t|e>>1}function i(e){var t=n(e),r=y[a(t)>>2];return r.length>0?r.pop():new ArrayBuffer(t)}function o(e){y[a(e.byteLength)>>2].push(e)}function f(e,t){var r=null;switch(e){case c:r=new Int8Array(i(t),0,t);break;case l:r=new Uint8Array(i(t),0,t);break;case p:r=new Int16Array(i(2*t),0,t);break;case d:r=new Uint16Array(i(2*t),0,t);break;case m:r=new Int32Array(i(4*t),0,t);break;case h:r=new Uint32Array(i(4*t),0,t);break;case b:r=new Float32Array(i(4*t),0,t);break;default:return null}return r.length!==t?r.subarray(0,t):r}function u(e){o(e.buffer)}var s=e("./loop"),c=5120,l=5121,p=5122,d=5123,m=5124,h=5125,b=5126,y=s(8,function(){return[]});t.exports={alloc:i,free:o,allocType:f,freeType:u}},{"./loop":24}],26:[function(e,t,r){"function"==typeof requestAnimationFrame&&"function"==typeof cancelAnimationFrame?t.exports={next:function(e){return requestAnimationFrame(e)},cancel:function(e){return cancelAnimationFrame(e)}}:t.exports={next:function(e){setTimeout(e,30)},cancel:clearTimeout}},{}],27:[function(e,t,r){var n=e("./pool"),a=new Float32Array(1),i=new Uint32Array(a.buffer),o=5123;t.exports=function(e){for(var t=n.allocType(o,e.length),r=0;r<e.length;++r)if(isNaN(e[r]))t[r]=65535;else if(e[r]===1/0)t[r]=31744;else if(e[r]===-(1/0))t[r]=64512;else{a[0]=e[r];var f=i[0],u=f>>>31<<15,s=(f<<1>>>24)-127,c=f>>13&1023;if(s<-24)t[r]=u;else if(s<-14){var l=-14-s;t[r]=u+(c+1024>>l)}else s>15?t[r]=u+31744:t[r]=u+(s+15<<10)+c}return t}},{"./pool":25}],28:[function(e,t,r){t.exports=function(e){return Object.keys(e).map(function(t){return e[t]})}},{}],29:[function(e,t,r){function n(e,t){function r(){var t=window.innerWidth,r=window.innerHeight;if(e!==document.body){var a=e.getBoundingClientRect();t=a.right-a.left,r=a.top-a.bottom}n.width=f*t,n.height=f*r,o(n.style,{width:t+"px",height:r+"px"})}var n=document.createElement("canvas"),i=a(n,t);o(n.style,{border:0,margin:0,padding:0,top:0,left:0}),e.appendChild(n),e===document.body&&(n.style.position="absolute",o(e.style,{margin:0,padding:0}));var f=+i.options.pixelRatio;window.addEventListener("resize",r,!1);var u=i.options.onDestroy;return i.options=o(o({},i.options),{onDestroy:function(){window.removeEventListener("resize",r),e.removeChild(n),u&&u()}}),r(),i}function a(e,t){function r(t){try{return e.getContext(t,n)}catch(e){return null}}var n=t.glOptions||{},a=r("webgl")||r("experimental-webgl")||r("webgl-experimental");return i(a,"webgl not supported"),{gl:a,options:o({pixelRatio:window.devicePixelRatio},t)}}var i=e("./util/check"),o=e("./util/extend");t.exports=function(e){if("undefined"==typeof document||"undefined"==typeof HTMLElement)return{gl:e[0],options:e[1]||{}};var t=document.body,r=e[1]||{};if("string"==typeof e[0])t=document.querySelector(e[0])||document.body;else if("object"==typeof e[0])if(e[0]instanceof HTMLElement)t=e[0];else{if(e[0]instanceof WebGLRenderingContext)return{gl:e[0],options:o({pixelRatio:1},r)};r=e[0]}return t.nodeName&&"CANVAS"===t.nodeName.toUpperCase()?a(t,r):n(t,r)}},{"./util/check":18,"./util/extend":21}],30:[function(e,t,r){var n=e("./lib/util/check"),a=e("./lib/util/extend"),i=e("./lib/dynamic"),o=e("./lib/util/raf"),f=e("./lib/util/clock"),u=e("./lib/strings"),s=e("./lib/webgl"),c=e("./lib/extension"),l=e("./lib/limits"),p=e("./lib/buffer"),d=e("./lib/elements"),m=e("./lib/texture"),h=e("./lib/renderbuffer"),b=e("./lib/framebuffer"),y=e("./lib/attribute"),g=e("./lib/shader"),v=e("./lib/read"),x=e("./lib/core"),w=16384,k=256,A=1024,_=34962,j="webglcontextlost",E="webglcontextrestored",T=1,S=2,D=3;t.exports=function(){function e(){ce=o.next(e),$.count+=1;var t=f();$.deltaTime=(t-q)/1e3,$.time=(t-G)/1e3,q=t,z();for(var r=0;r<se.length;++r){var n=se[r];n($,null,0)}}function t(){!ce&&se.length>0&&e()}function r(){ce&&(o.cancel(e),ce=0)}function O(e){}function C(e){}function B(){r(),ue&&(ue.removeEventListener(j,O),ue.removeEventListener(E,C)),te.clear(),ae.clear(),ne.clear(),re.clear(),X.clear(),W.onDestroy&&W.onDestroy()}function F(e){function t(e){function t(e){if(e in r){var t=r[e];delete r[e],Object.keys(t).forEach(function(n){r[e+"."+n]=t[n]})}}var r=a({},e);return delete r.uniforms,delete r.attributes,delete r.context,t("blend"),t("depth"),t("cull"),t("stencil"),t("polygonOffset"),t("scissor"),t("sample"),r}function r(e){var t={},r={};return Object.keys(e).forEach(function(n){var a=e[n];i.isDynamic(a)?r[n]=i.unbox(a,n):t[n]=a}),{dynamic:r,static:t}}function o(e){for(;b.length<e;)b.push(null);return b}function f(e,t){var r;if("function"==typeof e)return h.call(this,null,e,0);if("function"==typeof t){if("number"==typeof e){for(r=0;r<e;++r)h.call(this,null,t,r);return}if(Array.isArray(e)){for(r=0;r<e.length;++r)h.call(this,e[r],t,r);return}return h.call(this,e,t,0)}if("number"==typeof e){if(e>0)return m.call(this,o(0|e),0|e)}else{if(!Array.isArray(e))return d.call(this,e);if(e.length)return m.call(this,e,e.length)}}n(!!e,"invalid args to regl({...})"),n.type(e,"object","invalid args to regl({...})");var u=r(e.context||{}),s=r(e.uniforms||{}),c=r(e.attributes||{}),l=r(t(e)),p=oe.compile(l,c,s,u),d=p.draw,m=p.batch,h=p.scope,b=[];return f}function P(){oe.procs.poll()}function L(e){n("object"==typeof e&&e,"regl.clear() takes an object as input");var t=0;P();var r=e.color;r&&(I.clearColor(+r[0]||0,+r[1]||0,+r[2]||0,+r[3]||0),t|=w),"depth"in e&&(I.clearDepth(+e.depth),t|=k),"stencil"in e&&(I.clearStencil(0|e.stencil),t|=A),n(!!t,"called regl.clear with no buffer specified"),I.clear(t)}function M(e){function a(){var t=se.find(function(t){return t===e});t<0||(se.splice(t,1),se.length<=0&&r())}return n.type(e,"function","regl.frame() callback must be a function"),se.push(e),t(),{cancel:a}}function z(){var e=fe.viewport,t=fe.scissor_box;e[0]=e[1]=t[0]=t[1]=0,$.viewportWidth=$.frameBufferWidth=$.drawingBufferWidth=e[2]=t[2]=I.drawingBufferWidth,$.viewportHeight=$.frameBufferWidth=$.drawingBufferHeight=e[3]=t[3]=I.drawingBufferHeight,oe.procs.refresh()}var R=s(Array.prototype.slice.call(arguments)),I=R.gl,W=R.options,H=u(),N=c(I),U=N.extensions,G=f(),q=G,V=I.drawingBufferWidth,Y=I.drawingBufferHeight,$={count:0,deltaTime:0,time:0,viewportWidth:V,viewportHeight:Y,framebufferWidth:V,framebufferHeight:Y,drawingBufferWidth:V,drawingBufferHeight:Y,pixelRatio:W.pixelRatio},J={},K={elements:null,primitive:4,count:-1,offset:0,instances:-1},Q=l(I,U),X=p(I),Z=d(I,U,X),ee=y(I,U,Q,X,H),te=g(I,H),re=m(I,U,Q,P,$),ne=h(I,U,Q),ae=b(I,U,Q,re,ne),ie=v(I,P,$),oe=x(I,H,U,Q,X,Z,re,ae,J,ee,te,K,$),fe=oe.next,ue=I.canvas,se=[],ce=0;return ue&&(ue.addEventListener(j,O,!1),ue.addEventListener(E,C,!1)),z(),a(F,{clear:L,prop:i.define.bind(null,T),context:i.define.bind(null,S),this:i.define.bind(null,D),draw:F({}),buffer:function(e){return X.create(e,_)},elements:Z.create,texture:re.create2D,cube:re.createCube,renderbuffer:ne.create,framebuffer:ae.create,framebufferCube:function(e){n.raise("framebuffer cube not yet implemented")},attributes:I.getContextAttributes(),frame:M,limits:Q,hasExtension:function(e){return Q.extensions.indexOf(e.toLowerCase())>=0},read:ie,destroy:B,_gl:I,_refresh:z})}},{"./lib/attribute":1,"./lib/buffer":2,"./lib/core":7,"./lib/dynamic":8,"./lib/elements":9,"./lib/extension":10,"./lib/framebuffer":11,"./lib/limits":12,"./lib/read":13,"./lib/renderbuffer":14,"./lib/shader":15,"./lib/strings":16,"./lib/texture":17,"./lib/util/check":18,"./lib/util/clock":19,"./lib/util/extend":21,"./lib/util/raf":26,"./lib/webgl":29}]},{},[30])(30)});
//# sourceMappingURL=regl.min.js.map