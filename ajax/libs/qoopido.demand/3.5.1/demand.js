/*! Qoopido.demand 3.5.1 | https://github.com/dlueth/qoopido.demand | (c) 2016 Dirk Lueth */
!function(e,t,r,n,o,i,c,a,s,u,f){"use strict";function l(e){var t,r,n,o=ve[e];if(o)for(t=X.call(arguments,1),r=0;n=o[r];r++)n.apply(ie,t)}function p(e){P(console,"undefined")||console.error(e.toString())}function h(e,t){H(e,function(){return t})}function d(){for(var e,t,r,n=[],o=0;e=arguments[o];o++)r=e.match(fe),e=e.replace(fe,""),t=(ge[e]||(ge[e]=S.defer())).pledge,arguments[o]=(r?"mock:"+r.slice(1).join(""):"mock:")+"!"+e,n.push(t);return A.apply(ie,arguments),S.all(n)}function m(e){return e.replace(le,"\\$&")}function g(e,t){return new RegExp(e,t)}function v(){return+new Date}function y(e){return de.href=e,de.href}function w(e,t){return e=e.replace(fe,""),ae.test(e)||se.test(e)||(e="/"+y((t&&y(t+"/../")||"/")+e).replace($,"")),e}function k(e,t){var r,n,o;if(P(e,re)){if(r=w(e,t),t&&(e===_||e===B||e===F)){switch(e){case _:r=K+r,n=function(){var e,r=A.bind(t);for(e in A)r[e]=A[e];return r};break;case B:r=K+r,n=function(){return H.bind(t)};break;case F:r=V+t,n=function(){return t}}!me[r]&&H(r,n)}return(me[r]||(me[r]=new O(r,R(e,t)))).pledge}return q(e,S)?e:(o=S.defer(),o.resolve(e),o.pledge)}function R(e,t){var r,n,o=e.match(fe),i=he.pattern;if(e=w(e,t),!se.test(e))for(r in i)i[r].matches(e)&&(!n||n.weight<i[r].weight)&&(n=i[r]);return{mock:!(!o||!o[1]),cache:o&&o[2]?"+"===o[2]:ie,handler:o&&o[3]||he.handler,version:o&&o[4]||he.version,lifetime:o&&o[5]&&1e3*o[5]||he.lifetime,url:n?y(n.process(e)):e}}function b(e){var t=e.handler;l("preProcess",e),e.deferred.pledge.state===Z&&(t.onPreProcess&&t.onPreProcess.call(e),t.process&&D.add(e))}function j(e){return"[object Array]"===N.call(e)}function x(e){return e&&P(e,"object")}function P(e,t){return typeof e===t}function q(e,t){return e instanceof t}function C(e){return P(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function E(){for(var e,t,r,n,o,i=arguments[0],c=1;(e=arguments[c])!==f;c++)for(t in e)r=i[t],o=e[t],o!==f&&(x(o)?(n=x(r),r=o.length!==f?n&&r.length!==f?r:[]:n&&r.length===f?r:{},i[t]=E(r,o)):i[t]=o);return i}function T(e,t){var r=this;r.weight=e.length,r.url=y(t).replace(ue,"$1"),r.matchPattern=g("^"+m(e)),r.matchUrl=g("^"+m(t))}function O(e,t){var r,n,c=this,a=S.defer(),s=a.pledge,f=t.handler;return c.deferred=a,c.path=e,c.url=t.url,c.cache=t.cache,c.version=t.version,c.lifetime=t.lifetime,A(Q+f).then(function(e){c.handler=e,c.mock=t.mock?ge[c.path]:ie,e.onPreRequest&&e.onPreRequest.call(c),c.mock?c.mock.dependencies?c.mock.dependencies.then(function(){c.mock.resolve(c)},c.mock.reject):c.mock.resolve(c):c.cache!==!1&&U.get(c)?o(function(){b(c)}):(l("preRequest",c),s.state===Z&&(r=$.test(c.url)?new u:new ce,r.onprogress=function(){},r.ontimeout=r.onerror=r.onabort=function(){a.reject(new I("timeout requesting",c.path))},r.onload=function(){var t=r.getResponseHeader&&r.getResponseHeader("content-type");n=i(n),"status"in r&&200!==r.status||t&&e.matchType&&!e.matchType.test(t)?a.reject(new I("error requesting",c.path)):(c.source=r.responseText,l("postRequest",c),s.state===Z&&(e.onPostRequest&&e.onPostRequest.call(c),b(c),c.cache!==!1&&s.then(function(){U.set(c)})))},r.open("GET",c.url,!0),r.send(),n=o(function(){r.readyState<4&&r.abort()},he.timeout)))},a.reject),a}function S(e){function t(){n(ee,arguments)}function r(){n(te,arguments)}function n(e,t){var r,n;if(o.state===Z){for(o.state=e,o.value=t;r=i[e].shift();)n=r.handler.apply(ie,t),n&&"function"==typeof n.then?n.then(r.deferred.resolve,r.deferred.reject):r.deferred.resolve(n);i=ie}}var o=this,i={resolved:[],rejected:[]};o.then=function(e,t){var r=S.defer();if(o.state===Z)e&&i[ee].push({handler:e,deferred:r}),t&&i[te].push({handler:t,deferred:r});else switch(o.state){case ee:r.resolve(e&&e.apply(ie,o.value));break;case te:r.reject(t&&t.apply(ie,o.value))}return o},e(t,r)}function I(e,t,r){this.message=e,t&&(this.module=t),r&&(this.stack=X.call(r))}function M(){this.items=0,this.stack=[]}function A(){var e,t=X.call(arguments),r=this!==window?this:ie,n=0;for(l("preResolve",t,r);e=t[n];n++)t[n]=k(e,r);return l("postResolve",t,r),S.all(t)}function H(){var e,t,r,n=arguments,o=P(n[0],re)?n[0]:ie,i=j(n[o?1:0])?n[o?1:0]:ie,c=i?n[o?2:1]:n[o?1:0];if(!o&&D.current&&(o=D.current.path,D.current=ie,D.items>0&&D.process()),!o)throw"unspecified anonymous provide";o=w(o,this),e=me[o]||(me[o]=S.defer()),t=e.pledge,r=P(c,oe),t.state===Z&&(i?A.apply(o,i).then(function(){e.resolve(r?c.apply(ie,arguments):c)},function(){p(new I("error providing",o,arguments))}):e.resolve(r?c():c))}var $,D,U,X=a.slice,L=a.concat,N=s.toString,_="demand",B="provide",F="path",G="/"+_+"/",J=G+"storage/",Q=G+"handler/",z=G+"plugin/",K=G+"local",V=G+"paths",W=G+"function/",Y=G+"validator/",Z="pending",ee="resolved",te="rejected",re="string",ne="boolean",oe="function",ie=null,ce="XDomainRequest"in e&&e.XDomainRequest||u,ae=/^\//,se=/^(http(s?):)?\/\//i,ue=/(.+)\/$/,fe=/^(mock:)?([+-])?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,le=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,pe=/^cache(Miss|Hit|Clear|Exceed)|(pre|post)(Configure.*|Resolve|Request|Process|Cache)$/,he={cache:{},timeout:8e3,pattern:{},modules:{},handler:"module"},de=t.createElement("a"),me={},ge={},ve={};T.prototype={matches:function(e){return this.matchPattern.test(e)},remove:function(e){return e.replace(this.matchUrl,"")},process:function(e){return e.replace(this.matchPattern,this.url)}},S.prototype={state:Z},S.defer=function(){var e={};return e.pledge=new S(function(t,r){e.resolve=t,e.reject=r}),e},S.all=function(e){function t(e,t){t.then(function(){i[e]=X.call(arguments),s++,r()},function(){c.push(X.call(arguments)),r()})}function r(){s===a?o.resolve.apply(ie,L.apply([],i)):c.length+s===a&&o.reject.apply(ie,L.apply([],c))}for(var n,o=S.defer(),i=[],c=[],a=e.length,s=0,u=0;n=e[u];u++)t(u,n);return o.pledge},S.race=function(e){for(var t,r=S.defer(),n=0;t=e[n];n++)t.then(r.resolve,r.reject);return r.pledge},I.prototype={toString:function(){var e=this,t=_+": "+e.message+" "+(e.module?'"'+e.module+'"':"");return e.stack&&(t=I.traverse(e.stack,t,1)),t}},I.traverse=function(e,t,r){for(var n,o=new Array(r+1).join(" "),i=0;n=e[i];i++)t+="\n"+o+"> "+n.message+" "+(n.module?'"'+n.module+'"':""),n.stack&&(t=I.traverse(n.stack,t,r+1));return t},M.prototype={add:function(){D.stack=D.stack.concat(X.call(arguments)),D.items+=arguments.length,!D.current&&D.process()},process:function(){var e;D.items&&(D.items--,e=D.current=D.stack.shift(),e.handler.process.call(e),l("postProcess",e))}},A.configure=function(e){var t,r,n=e.cache,o=e.version,i=e.timeout,c=e.lifetime,a=e.base,s=e.pattern,u=e.modules,f=he.modules;if(P(n,ne))he.cache[""]={weight:0,state:n};else if(x(n))for(t in n)he.cache[t]={weight:t.length,state:n[t]};if(P(o,re)&&(he.version=o),C(i)&&(he.timeout=1e3*Math.min(Math.max(i,2),12)),C(c)&&c>0&&(he.lifetime=1e3*c),P(a,re)&&""!==a&&(he.pattern.base=new T("",a)),x(s))for(t in s)"base"!==t&&(he.pattern[t]=new T(t,s[t]));if(x(u))for(t in u)t!==J&&(r=f[t]=f[t]||{},l("preConfigure:"+t,r),E(r,u[t]),l("postConfigure:"+t,r));return A},A.remove=function(e){return me[e]&&(!!me[e].cache&&U.clean.path(e),delete me[e],delete ge[e]),A},A.on=function(e,t){var r,n;if(P(e,re)&&P(t,oe))for(e=e.split(" ");r=e.shift();)pe.test(r)&&((ve[r]||(ve[r]=[])).push(t),0===r.indexOf("postConfigure:")&&(n=he.modules[r.substr(14)],n!==f&&t(n)));return A},A.list=function(e){var t,r,n;if(e){t=[];for(r in me)n=me[r].pledge,n.state!==e&&n.cache!==e||t.push(r)}else t=Object.keys(me);return t},function(){function t(){function t(e){var t,r,n;if(e.cache!==ie)return e.cache;for(t in he.cache)r=he.cache[t],0===e.path.indexOf(t)&&(!n||r.weight>n.weight)&&(n=r);return n?n.state:!1}function n(){this.clear.expired()}var o="["+_+"]",i="[state]",c="[value]",a=g("^"+m(o)+"\\[(.+?)\\]"+m(i)+"$"),s=function(){try{return"localStorage"in e&&e.localStorage}catch(t){return!1}}(),u=s&&"remainingSpace"in s;return n.prototype={get:function(e){var n,a,u,f=e.path;if(s&&t(e)){if(n=o+"["+f+"]",a=r.parse(s.getItem(n+i)),u=e.deferred.pledge,a&&a.version===e.version&&a.url===e.url&&(!a.expires&&!e.lifetime||a.expires>v()))return u.cache="hit",e.source=s.getItem(n+c),l("cacheHit",e),e.source;u.cache="miss",l("cacheMiss",e),this.clear.path(f)}},set:function(e){var n,a,f,p=e.path;if(s&&t(e)){l("preCache",e),n=e.lifetime,a=o+"["+p+"]",e.state={version:e.version,expires:n?v()+n:n,url:e.url};try{if(f=u?s.remainingSpace:ie,s.setItem(a+c,e.source),s.setItem(a+i,r.stringify(e.state)),f!==ie&&s.remainingSpace===f)throw"QUOTA_EXCEEDED_ERR";l("postCache",e)}catch(h){l("cacheExceed",e)}}},clear:{path:function(e){var t;s&&(t=o+"["+e+"]",s.removeItem(t+i),s.removeItem(t+c),l("cacheClear",e))},all:function(){var e,t;if(s)for(e in s)t=e.match(a),t&&this.path(t[1])},expired:function(){var e,t,n;if(s)for(e in s)t=e.match(a),t&&(n=r.parse(s.getItem(o+"["+t[1]+"]"+i)),n&&n.expires>0&&n.expires<=v()&&this.path(t[1]))}}},A.clear=(U=new n).clear,U}H(J,t)}(),function(){function e(){var e=t.getElementsByTagName("head")[0],r=/\/\/#\s+sourceMappingURL\s*=\s*(?!(?:http[s]?:)?\/\/)(.+?)\.map/g;return{matchType:/^(application|text)\/(x-)?javascript/,onPreRequest:function(){var e=this.url;this.url=".js"!==e.slice(-3)?e+".js":e},onPostRequest:function(){var e,t,n=this,o=n.source;if(o){for(;e=r.exec(o);)ae.test(e[1])?(de.href=n.url,t=de.protocol+"//"+de.host+e[1]):t=y(n.url+"/../"+e[1]),o=o.replace(e[0],"//# sourceMappingURL="+t+".map");n.source=o}},process:function(){var r,n=this.source;n&&(r=t.createElement("script"),r.async=!0,r.text=n,r.setAttribute("demand-path",this.path),e.appendChild(r))}}}H(Q+"module",e)}(),function(){function e(e){function n(e){t=x(e)?e:{}}return A.on("postConfigure:"+r,n),{matchType:e.matchType,onPostRequest:e.onPostRequest,onPreProcess:function(){var r=this,n=r.deferred,o=t[r.path];d.apply(ie,o).then(function(){D.add.apply(ie,arguments),e.process.call(r),A.apply(ie,o).then(n.resolve,function(){n.reject(new I("error resolving",r.path,arguments))})},function(){n.reject(new I("error mocking",ie,arguments))})}}}var t,r=Q+"bundle";H(r,["/demand/handler/module"],e)}(),function(){function e(){function e(e){if(x(e)){s.length=0;for(a in e)s.push({prefix:a,weight:a.length,fn:e[a]})}}function n(e){for(var t,r,n=0;t=s[n];n++)0===e.indexOf(t.prefix)&&(!r||t.weight>r.weight)&&(r=t);return r}function o(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return t>>>0}function i(e){var t,r,n=e.matches,o={pattern:{},modules:{"/demand/handler/bundle":{}}},i=0;for(o.pattern[e.id]=e.fn(n),o.modules["/demand/handler/bundle"][e.id]=t=[];r=n[i];i++)t.push(r.id);return o}function c(e){return me[e]&&me[e].pledge||ge[e]&&ge[e].pledge}var a,s=[];return A.on("postConfigure:"+t,e),A.on("preResolve",function(e,t){var a,s,u,f,l,p,h,m,g,v={};for(a=0;s=e[a];a++)P(s,"string")&&(u=w(s,t),!c(u)&&(f=R(s,t))&&"module"===f.handler&&(l=n(u))&&(v[l.prefix]||(v[l.prefix]={fn:l.fn,matches:[]})).matches.push({id:u,path:s,index:a,deferred:ie}));if(p=Object.keys(v),p.length)for(h in v)if(m=v[h],g=m.matches,g.length>1){for(m.id="/genie/"+o(r.stringify(m.matches)),a=0;s=g[a];a++)s.deferred=S.defer(),e[s.index]=s.deferred.pledge,d(s.id);A.configure(i(m)),A("bundle!"+m.id).then(function(){for(a=0;s=g[a];a++)s.deferred.resolve(arguments[a])},function(){for(a=0;s=g[a];a++)s.deferred.reject(new I("error resolving",s.path))})}}),!0}var t=z+"genie";H(t,e)}(),$=g("^"+m(y("/"))),A.configure({cache:!0,base:"/",pattern:{"/demand":y((c&&c.url||location.href)+"/../").slice(0,-1)}}),c&&c.settings&&A.configure(c.settings),h(Y+"isArray",j),h(Y+"isObject",x),h(Y+"isTypeOf",P),h(Y+"isInstanceOf",q),h(Y+"isPositiveInteger",C),h(W+"merge",E),h(G+"pledge",S),h(G+"reason",I),D=new M,e.demand=A,e.provide=H,c&&c.main&&A(c.main)}(this,document,JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand,Array.prototype,Object.prototype,XMLHttpRequest);
//# sourceMappingURL=demand.js.map
