/*! Qoopido.demand 2.0.4 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e,t,r,n,a,c,o){"use strict";function i(){for(var e,t=this!==window?this:te,r=D.call(arguments),n=0;e=r[n];n++)r[n]=M.dependency(e,t);return q.all(r)}function s(e){var t,r=e.cache,n=e.debug,a=e.version,c=e.timeout,o=e.lifetime,i=e.base,s=e.pattern,u=e.modules;if(pe.cache=R(r,Z)?r:pe.cache,pe.debug=R(n,Z)?n:pe.debug,R(a,Y)&&(pe.version=a),E(c)&&(pe.timeout=1e3*Math.min(Math.max(c,2),12)),E(o)&&o>0&&(pe.lifetime=1e3*o),R(i,Y)&&(pe.pattern.base=new x("",M.url(i.replace(oe,"")))),j(s))for(t in s)"base"!==t&&(pe.pattern[t]=new x(t,s[t]));if(j(u))for(t in u)pe.modules[t]=u[t]}function u(e,t){var r;if(R(e,Y)&&R(t,ee))for(e=e.split(" ");r=e.shift();)le.test(r)&&(me[r]||(me[r]=[])).push(t);return i}function l(e){var t,r,n=me[e],a=0;if(n)for(;r=n[a];a++)t=D.call(arguments,1),r.apply(te,t)}function p(e){var t,r,n;if(e){t=[];for(r in fe)n=fe[r].pledge,(n.state===e||n.cache===e)&&t.push(r)}else t=Object.keys(fe);return t}function f(){var e,t,r,n=arguments,a=R(n[0],Y)?n[0]:te,c=b(n[a?1:0])?n[a?1:0]:te,o=c?n[a?2:1]:n[a?1:0];if(!a&&O.current&&(a=O.current.path,O.current=te,O.items>0&&O.process()),!a)throw"unspecified anonymous provide";a=M.path(a,this),e=fe[a]||(fe[a]=q.defer()),t=e.pledge,r=R(o,ee),t.state===K&&(c?i.apply(a,c).then(function(){e.resolve(r?o.apply(te,arguments):o)},function(){h(new S("error providing",a,arguments))}):e.resolve(r?o():o))}function h(e){var t=P(e,S)?"error":"warn";R(console,"undefined")||!pe.debug&&"warn"===t||console[t](e.toString())}function m(e){for(var t,r,n=[],a=0;t=e[a];a++)r=t.match(ie),t=t.replace(ie,""),e[a]=(r?"mock:"+r.slice(1).join(""):"mock:")+"!"+t,n.push((he[t]=q.defer()).pledge);return i.apply(te,e),q.all(n)}function d(e,t){f(e,function(){return t})}function v(e){return e.replace(ue,"\\$&")}function g(e,t){return new RegExp(e,t)}function y(){return+new Date}function k(e){L.href=e;var t=L.search,r=N+"[time]="+y();return L.search+=t&&"?"!==t?"&"+r:"?"+r,L.href}function w(e){return e.replace(se,"")}function b(e){return"[object Array]"===X.call(e)}function j(e){return e&&R(e,"object")}function R(e,t){return typeof e===t}function P(e,t){return e instanceof t}function E(e){return R(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function q(e){function t(){n(V,arguments)}function r(){n(W,arguments)}function n(e,t){a.state===K&&(a.state=e,a.value=t,c[e].forEach(function(e){e.apply(te,t)}))}var a=this,c={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===K)e&&c[V].push(e),t&&c[W].push(t);else switch(a.state){case V:e&&e.apply(te,a.value);break;case W:t&&t.apply(te,a.value)}return a},e(t,r)}function x(e,t){var r=this;r.weight=e.length,r.url=M.url(t),r.matchPattern=g("^"+v(e)),r.matchUrl=g("^"+v(t))}function S(e,t,r){var n=this;n.message=e,t&&(n.module=t),r&&(n.stack=D.call(r))}function T(){var e=this;e.items=0,e.stack=[]}function I(e,t){var r,n,o=this,s=q.defer(),u=t.handler;return o.deferred=s,o.path=e,o.url=t.url,o.cache=t.cache,o.version=t.version,o.lifetime=t.lifetime,i(G+u).then(function(e){o.handler=e,o.mock=t.mock?he[o.path]:te,e.onPreRequest&&e.onPreRequest.call(o),o.mock?o.mock.dependencies?o.mock.dependencies.then(function(){o.mock.resolve(o)},o.mock.reject):o.mock.resolve(o):o.cache&&A.get(o)?a(function(){M.loader(o)}):(l("preRequest",o),r=C.test(o.url)?new re:new ne,r.onprogress=function(){},r.ontimeout=r.onerror=r.onabort=function(){s.reject(new S("timeout requesting",o.path))},r.onload=function(){var t=r.getResponseHeader&&r.getResponseHeader("content-type");n=c(n),"status"in r&&200!==r.status||t&&e.matchType&&!e.matchType.test(t)?s.reject(new S("error requesting",o.path)):(o.source=r.responseText,l("postRequest",o),e.onPostRequest&&e.onPostRequest.call(o),M.loader(o),o.cache&&s.pledge.then(function(){A.set(o)}))},r.open("GET",k(o.url),!0),r.send(),n=a(function(){r.readyState<4&&r.abort()},pe.timeout))},s.reject),s}var M,C,O,A,U=Array.prototype,D=U.slice,H=U.concat,$=Object.prototype,X=$.toString,L=t.createElement("a"),N="demand",_="provide",B="settings",F="/"+N+"/",G=F+"handler/",J=F+"local",Q=F+"settings",z=F+"validator/",K="pending",V="resolved",W="rejected",Y="string",Z="boolean",ee="function",te=null,re=n,ne="XDomainRequest"in e&&e.XDomainRequest||re,ae=/^\//,ce=/^(http(s?):)?\/\//i,oe=/\/$/,ie=/^(mock:)?(!)?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,se=/^http(s?):/i,ue=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,le=/^cache(Miss|Hit|Clear|Exceed)|(pre|post)(Request|Process|Cache)$/,pe={cache:!0,debug:!1,timeout:8e3,pattern:{},modules:{},handler:"module"},fe={},he={},me={};M={url:function(e){return L.href=e,L.href},path:function(e,t){return e=e.replace(ie,""),ae.test(e)||ce.test(e)||(e="/"+M.url((t&&M.url(t+"/../")||"/")+e).replace(C,"")),e},dependency:function(e,t){var r,n=M.path(e,t);if(t&&(e===N||e===_||e===B)){switch(e){case N:n=J+n,r=function(){var e,r=i.bind(t);for(e in i)r[e]=i[e];return r};break;case _:n=J+n,r=function(){return f.bind(t)};break;case B:n=Q+t,r=function(){return pe.modules[t]||te}}!fe[n]&&f(n,r)}return(fe[n]||(fe[n]=new I(n,M.parameter(e,t)))).pledge},parameter:function(e,t){var r,n,a=e.match(ie),c=pe.pattern;if(e=M.path(e,t),!ce.test(e))for(r in c)c[r].matches(e)&&(!n||n.weight<c[r].weight)&&(n=c[r]);return{mock:a&&a[1]?!0:!1,cache:a&&a[2]?!1:pe.cache,handler:a&&a[3]||pe.handler,version:a&&a[4]||pe.version,lifetime:a&&a[5]&&1e3*a[5]||pe.lifetime,url:n?w(M.url(n.process(e))):e}},loader:function(e){var t=e.handler;l("preProcess",e),t.onPreProcess&&t.onPreProcess.call(e),t.process&&O.add(e)}},q.prototype={state:K},q.defer=function(){var e={};return e.pledge=new q(function(t,r){e.resolve=t,e.reject=r}),e},q.all=function(e){function t(){o===c?r.resolve.apply(te,H.apply([],n)):a.length+o===c&&r.reject.apply(te,H.apply([],a))}var r=q.defer(),n=[],a=[],c=e.length,o=0;return e.forEach(function(e,r){e.then(function(){n[r]=D.call(arguments),o++,t()},function(){a.push(D.call(arguments)),t()})}),r.pledge},q.race=function(e){var t=q.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},x.prototype={matches:function(e){return this.matchPattern.test(e)},remove:function(e){return e.replace(this.matchUrl,"")},process:function(e){var t=this;return e.replace(t.matchPattern,t.url)}},S.prototype={toString:function(){var e=this,t=N+": "+e.message+" "+(e.module?'"'+e.module+'"':"");return e.stack&&(t=S.traverse(e.stack,t,1)),t}},S.traverse=function(e,t,r){var n=new Array(r+1).join(" ");return e.forEach(function(e){t+="\n"+n+"> "+e.message+" "+(e.module?'"'+e.module+'"':""),e.stack&&(t=S.traverse(e.stack,t,r+1))}),t},T.prototype={add:function(){O.stack=O.stack.concat(D.call(arguments)),O.items+=arguments.length,!O.current&&O.process()},process:function(){var e;O.items&&(O.items--,e=O.current=O.stack.shift(),e.handler.process.call(e),l("postProcess",e))}},function(){function e(){var e=t.getElementsByTagName("head")[0],r=/\/\/#\s+sourceMappingURL\s*=\s*(?!(?:http[s]?:)?\/\/)(.+?)\.map/g;return{matchType:/^(application|text)\/javascript/,onPreRequest:function(){var e=this,t=e.url;e.url=".js"!==t.slice(-3)?t+".js":t},onPostRequest:function(){var e,t,n=this,a=n.source;if(a){for(;e=r.exec(a);)ae.test(e[1])?(L.href=n.url,t="//"+L.host+e[1]):t=w(M.url(n.url+"/../"+e[1])),a=a.replace(e[0],"//# sourceMappingURL="+t+".map");n.source=a}},process:function(){var r,n=this,a=n.source;a&&(r=t.createElement("script"),r.async=!0,r.text=a,r.setAttribute("demand-path",n.path),e.appendChild(r))}}}f(G+"module",e)}(),function(){function t(){function t(){}var n="["+N+"]",a="[state]",c="[value]",o=g("^"+v(n)+"\\[(.+?)\\]"+v(a)+"$"),s=function(){try{return"localStorage"in e&&e.localStorage}catch(t){return!1}}(),u=s&&"remainingSpace"in s;return t.prototype={get:function(e){var t,o,i;if(s){if(t=e.path,o=n+"["+t+"]",i=r.parse(s.getItem(o+a)),i&&i.version===e.version&&i.url===e.url&&(!i.expires&&!e.lifetime||i.expires>y()))return e.deferred.pledge.cache="hit",e.source=s.getItem(o+c),l("cacheHit",e),e.source;e.deferred.pledge.cache="miss",l("cacheMiss",e),this.clear.path(t)}},set:function(e){var t,o,i,p,f;if(s){l("preCache",e),t=e.path,o=e.lifetime,i=n+"["+t+"]",p=e.state=r.stringify({version:e.version,expires:o?y()+o:o,url:e.url});try{if(f=u?s.remainingSpace:te,s.setItem(i+c,e.source),s.setItem(i+a,p),f!==te&&s.remainingSpace===f)throw"QUOTA_EXCEEDED_ERR";l("postCache",e)}catch(m){l("cacheExceed",e),h('error caching "'+t+'"')}}},clear:{path:function(e){var t;s&&(t=n+"["+e+"]",s.removeItem(t+a),s.removeItem(t+c),l("cacheClear",e))},all:function(){var e,t;if(s)for(e in s)t=e.match(o),t&&this.path(t[1])},expired:function(){var e,t,c;if(s)for(e in s)t=e.match(o),t&&(c=r.parse(s.getItem(n+"["+t[1]+"]"+a)),c&&c.expires>0&&c.expires<=y()&&this.path(t[1]))}}},A=new t,A.clear.expired(),i.clear=A.clear,A}f(F+"storage",t)}(),C=g("^"+v(M.url("/"))),s({base:"/",pattern:{"/demand":M.url((o&&o.url||location.href)+"/../").slice(0,-1)}}),o&&o.settings&&s(o.settings),d(F+"queue",(O=new T).add),d(F+"mock",m),d(F+"pledge",q),d(F+"reason",S),d(F+"function/resolveUrl",M.url),d(F+"modifier/removeProtocol",w),d(z+"isArray",b),d(z+"isObject",j),d(z+"isTypeOf",R),d(z+"isInstanceOf",P),d(z+"isPositiveInteger",E),i.configure=s,i.on=u,i.list=p,e.demand=i,e.provide=f,o&&o.main&&i(o.main)}(this,document,JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand);
//# sourceMappingURL=demand.js.map
