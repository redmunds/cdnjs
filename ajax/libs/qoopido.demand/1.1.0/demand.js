/*! Qoopido.demand 1.1.0 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e,t,r,n,a,o,u,i){"use strict";function s(){var e=this,t=w(e,S)||w(e,k)?e:le,r=H.call(arguments);return r.forEach(p,t),q.all(r)}function c(){var e,t,r,n,a,i,s=this,c=w(s,S)||w(s,k)?s:le,l=x(arguments[0],ae)?arguments[0]:le,p=l?arguments[1]:arguments[0];if(!T.current||l&&l!==T.current.path||(e=T.current,l=e.type+"!"+e.path),l)return r=A.path(l,c),n=r.type,l=r.path,a=je[n]||(je[n]={}),i=xe[n]||(xe[n]={}),!i[l]||e?(e||(a[l]=q.defer(),i[l]=a[l].pledge),o(function(){new S(n+"!"+l,p,t),e&&(e.timeout=u(e.timeout),!e.cached&&e.store(),T.length>0&&T.process())}),{when:function(){t=arguments}}):(g("duplicate found for module "+r.path),{when:ce});throw new R("unspecified anonymous provide")}function l(e){var t,r=e.cache,n=e.storage,a=e.debug,o=e.version,u=e.timeout,i=e.lifetime,s=e.base,c=e.pattern,l=e.probes;if(C=x(r,oe)?r:C,L=x(n,ae)?n:L,N=x(a,oe)?a:N,F=x(o,ae)?o:F,E(u)&&(_=1e3*Math.min(Math.max(u,2),10),B=Math.min(Math.max(_/5,1e3),5e3)),E(i)&&(G=1e3*i),x(s,ae)&&($=Ee.base=new P("",A.url(s))),j(c))for(t in c)"base"!==t&&(Ee[t]=new P(t,c[t]));if(j(l))for(t in l)qe[t]=l[t];return!0}function p(e,t,r){var n,a=this,o=A.path(e,a),u=o.type,i=o.path,l=xe[u]||(xe[u]={});if(je[u]||(je[u]={}),a&&(e===V||e===K)&&!l[i]){switch(e){case V:n=function(){var e=s.bind(a);return e.configure=s.configure,e.clear=s.clear,e.list=s.list,e};break;case K:n=function(){return c.bind(a)}}c(i,n)}r[t]=l[i]||(l[i]=new k(e,a).pledge)}function f(e,t){c(e,function(){return t})}function h(){return+new Date}function d(e){z.href=e;var t=z.search,r="demand[timestamp]="+h();return z.search+=t&&"?"!==t?"&"+r:"?"+r,z.href}function g(e){var t=w(e,R)?"error":"warn";x(console,ne)||!N&&"warn"===t||console[t](e.toString())}function m(e,t){return new RegExp(e,t)}function v(e){return e.replace(ge,"\\$&")}function y(e){return e.replace(ve,"")}function b(e){return he.test(e)}function w(e,t){return e instanceof t}function x(e,t){return typeof e===t}function j(e){return e&&x(e,"object")}function E(e){return x(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function q(e){function t(){n(ie,arguments)}function r(){n(se,arguments)}function n(e,t){a.state===ue&&(a.state=e,a.value=t,o[e].forEach(function(e){e.apply(le,t)}))}var a=this,o={resolved:[],rejected:[]};a.then=q.prototype.then.bind(a,o),e(t,r)}function R(e,t,r){var n=this;n.message=e,t&&(n.module=t),r&&(n.stack=H.call(r))}function P(e,t){var r=this;r.weight=e.length,r.url=A.url(t),r.regexPattern=m("^"+v(e)),r.regexUrl=m("^"+v(t))}function I(){var e=this;e.current=le,e.queue=[]}function k(e,t){var r,n,a=this;A.path.call(a,e,t),r=a.defered=je[a.type][a.path]||(je[a.type][a.path]=q.defer()),n=a.pledge=r.pledge,t||n.then(le,g),s(ee+a.type).then(a.process.bind(a),r.reject)}function S(e,t,r){var n,a,o,u=this;A.path.call(u,e),n=u.path,a=je[u.type][n],o=u.pledge=a.pledge,o.then(le,function(){g(new R("unable to resolve module",n,arguments))}),r&&r.length>0?s.apply(u,r).then(function(){a.resolve(t.apply(le,arguments))},function(){a.reject(new R("unable to resolve dependencies for",n,arguments))}):a.resolve(t())}var M,O,T,A,D,U,X,$,C,L,N,_,B,F,G,H=Array.prototype.slice,J=Array.prototype.concat,Q=t.getElementsByTagName("head")[0],z=t.createElement("a"),K="provide",V="demand",W="["+V+"]",Y="[state]",Z="[value]",ee="/"+V+"/handler/",te="/"+V+"/storage/",re="/validator/",ne="undefined",ae="string",oe="boolean",ue="pending",ie="resolved",se="rejected",ce=function(){},le=null,pe=a,fe="XDomainRequest"in e&&e.XDomainRequest||pe,he=/^\//i,de=/^([-\w]+\/?)+!/,ge=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,me=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,ve=/^http(s?):/,ye=/^(http(s?):|)\/\//,be=r&&"remainingSpace"in r,we={cache:!0,storage:"localstorage",handler:"js",debug:!1,version:"1.0.0",lifetime:0,timeout:5,base:"/"},xe={},je={},Ee={},qe={};A={url:function(e){return z.href=e,z.href},path:function(e,t){var r,n,a=this,o=e.match(de)||we.handler,u=w(a,k);if(x(o,ae)||(e=e.replace(m("^"+v(o[0])),""),o=o[1]),!ye.test(e)){b(e)||(e="/"+A.url((t&&t.path&&A.url(t.path+"/../")||"/")+e).replace(M,""));for(r in Ee)Ee[r].matches(e)&&(!n||n.weight<Ee[r].weight)&&(n=Ee[r])}return u||w(a,S)?(a.type=o,a.path=e,u&&(a.url=n?y(A.url(n.process(e))):e),void 0):{type:o,path:e}}},X={get:function(e,t){var a,o;if(r){if(a=W+"["+e+"]",o=n.parse(r.getItem(a+Y)),o&&o.version===F&&o.url===t&&(0===o.expires||o.expires>h()))return r.getItem(a+Z);X.clear.path(e)}},set:function(e,t,a){var o,u;if(r){o=W+"["+e+"]";try{if(u=be?r.remainingSpace:le,r.setItem(o+Z,t),r.setItem(o+Y,n.stringify({version:F,expires:G>0?h()+G:0,url:a})),u!==le&&r.remainingSpace===u)throw"QUOTA_EXCEEDED_ERR"}catch(i){g("unable to cache module "+e)}}},clear:{path:function(e){var t;r&&(t=W+"["+e+"]",r.removeItem(t+Y),r.removeItem(t+Z))},all:function(){var e;if(r)for(e in r)0===e.indexOf(W)&&r.removeItem(e)},expired:function(){var e,t,a;if(r)for(e in r)t=e.match(O),t&&(a=n.parse(r.getItem(W+"["+t[1]+"]"+Y)),a&&a.expires>0&&a.expires<=h()&&X.clear.path(t[1]))}}},U={onPreRequest:function(){var e=this,t=e.url;e.url=".js"!==t.slice(-3)?t+".js":t},onPostRequest:function(){for(var e,t,r=this,n=r.url,a=r.source;e=me.exec(a);)t=y(A.url(n+"/../"+e[1])),a=a.replace(e[0],"//# sourcemap="+t+".map");r.source=a},process:function(){var e,r=this,n=r.source;e=t.createElement("script"),e.async=!0,e.text=n,e.setAttribute("demand-path",r.path),Q.appendChild(e)}},q.prototype={state:ue,value:le,then:function(e,t,r){var n=this;if(n.state===ue)t&&e[ie].push(t),r&&e[se].push(r);else switch(n.state){case ie:t&&t.apply(le,n.value);break;case se:r&&r.apply(le,n.value)}}},q.defer=function(){var e={};return e.pledge=new q(function(t,r){e.resolve=t,e.reject=r}),e},q.all=function(e){function t(){i===u?r.resolve.apply(le,J.apply([],a)):o.length+i===u&&r.reject.apply(le,J.apply([],o))}var r=q.defer(),n=r.pledge,a=[],o=[],u=e.length,i=0;return e.forEach(function(e,r){e.then(function(){a[r]=H.call(arguments),i++,t()},function(){o.push(H.call(arguments)),t()})}),n},q.race=function(e){var t=q.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},R.prototype={message:le,module:le,stack:le,toString:function(){var e=this,t=W+" "+e.message+" "+(e.module||"");return e.stack&&(t=R.traverse(e.stack,t,1)),t}},R.traverse=function(e,t,r){var n=new Array(r+1).join(" ");return e.forEach(function(e){t+="\n"+n+"> "+e.message+" "+e.module,e.stack&&(t=R.traverse(e.stack,t,r+1))}),t},P.prototype={weight:0,url:le,regexPattern:le,regexUrl:le,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},I.prototype={current:le,queue:le,length:0,add:function(e){var t=this,r=t.queue;r.push(e),t.length++,1===r.length&&t.process()},process:function(){var e,t,r,n,a=this,o=a.current,u=a.queue;o&&(a.current=le,u.shift(),a.length--),u.length&&(o=a.current=a.queue[0],e=o.defered,t=o.path,r=o.handler,!o.cached&&r.onPostRequest&&r.onPostRequest.call(o),r.process.call(o),o.probe&&o.pledge.state===ue&&((n=o.probe())?c(function(){return n}):e.reject(new R("probe failed for module",t))))}},k.prototype={handler:le,url:le,defered:le,pledge:le,cached:le,source:le,timeout:le,probe:le,process:function(e){var t,r=this,n=r.defered;e.onPreRequest&&e.onPreRequest.call(r),r.retrieve(),r.handler=e,r.probe=qe[r.path],r.cached?T.add(r):(t=M.test(r.url)?new pe:new fe,t.onprogress=ce,t.ontimeout=t.onerror=t.onabort=function(){n.reject(new R("unable to load module",r.path))},t.onload=function(){r.timeout=u(r.timeout),"status"in t&&200!==t.status?n.reject(new R("unable to load module",r.path)):(r.source=t.responseText,T.add(r))},t.open("GET",d(r.url),!0),t.send(),r.timeout=o(function(){t.readyState<4&&t.abort()},_))},store:function(){var e=this;C&&D.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=C&&D.get(e.path,e.url),r=e.cached=!!t;r&&(e.source=t)}},S.prototype={type:le,path:le,pledge:le},M=m("^"+v(A.url("/"))),O=m("^"+v(W+"[(.+?)]"+Y+"$")),T=new I,Ee["/"+V]=new P("/"+V,A.url((i&&i.url||location.href)+"/../").slice(0,-1)),l(we)&&i&&i.settings&&l(i.settings),s.configure=l,s.list=function(e){var t,r,n,a,o={};for(t in xe)if(e){r=o[t]=[],n=xe[t];for(a in n)n[a].state===e&&r.push(a)}else o[t]=Object.keys(xe[t]);return o},e.demand=s,e.provide=c,f("/"+V,s),f("/provide",c),f("/pledge",q),f("/resolve/url",A.url),f(re+"isObject",j),f(re+"isTypeOf",x),f(re+"isInstanceOf",w),f(re+"isPositiveInteger",E),f(te+we.storage,X),f(ee+we.handler,U),s(te+L).then(function(e){D=e,s.clear=D.clear,D.clear.expired(),i&&i.main&&s(i.main)})}(this,document,function(){try{return"localStorage"in this&&localStorage}catch(e){return!1}}(),JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand);
//# sourceMappingURL=demand.js.map