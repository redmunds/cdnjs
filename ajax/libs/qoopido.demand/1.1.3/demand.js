/*! Qoopido.demand 1.1.3 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e,t,r,n,a,o,i,s){"use strict";function c(){var e=this,t=w(e,T)||w(e,I)?e:oe,r=H.call(arguments);return r.forEach(p,t),E.all(r)}function u(){var e,t,r,n,a,s,c=this,u=w(c,T)||w(c,I)?c:oe,l=P(arguments[0],Z)?arguments[0]:oe,p=l?arguments[1]:arguments[0];if(!A.current||l&&l!==A.current.path||(e=A.current,l=e.type+"!"+e.path),l)return r=D.path(l,u),n=r.type,l=r.path,a=ve[n]||(ve[n]={}),s=ge[n]||(ge[n]={}),!s[l]||e?(e||(a[l]=E.defer(),s[l]=a[l].pledge),o(function(){new T(n+"!"+l,p,t),e&&(e.timeout=i(e.timeout),e.cache&&P(e.cached,ee)&&(e.pledge.cache=e.cached?"hit":"miss"),!e.cached&&e.store(),A.items>0&&A.process())}),{when:function(){t=arguments}}):(m("duplicate found for module "+r.path),{when:ae});throw new R("unspecified anonymous provide")}function l(e){var t,r=e.cache,n=e.storage,a=e.debug,o=e.version,i=e.timeout,s=e.lifetime,c=e.base,u=e.pattern,l=e.probes,p=e.modules;if(we.cache=P(r,ee)?r:we.cache,we.storage=P(n,Z)?n:we.storage,we.debug=P(a,ee)?a:we.debug,P(o,Z)&&(we.version=o),j(i)&&(we.timeout=1e3*Math.min(Math.max(i,2),10)),j(s)&&s>0&&(we.lifetime=1e3*s),P(c,Z)&&(ye.base=new q("",D.url(c))),x(u))for(t in u)"base"!==t&&(ye[t]=new q(t,u[t]));if(x(l))for(t in l)be[t]=l[t];if(x(p))for(t in p)we.modules[t]=p[t];return!0}function p(e,t,r){var n,a=this,o=D.path(e,a),i=o.type,s=o.path,l=ge[i]||(ge[i]={});if(ve[i]||(ve[i]={}),a&&(e===_||e===N||e===B)&&!l[s]){switch(e){case _:s=G+_+s,n=function(){var e=c.bind(a);return e.configure=c.configure,e.clear=c.clear,e.list=c.list,e};break;case N:s=G+N+s,n=function(){return u.bind(a)};break;case B:s=G+B+a.path,n=function(){return we.modules[a.path]||oe}}u(s,n)}r[t]=l[s]||(l[s]=new I(e,a).pledge)}function f(e,t){u(e,function(){return t})}function h(){return+new Date}function d(e){L.href=e;var t=L.search,r="demand[timestamp]="+h();return L.search+=t&&"?"!==t?"&"+r:"?"+r,L.href}function m(e){var t=w(e,R)?"error":"warn";P(console,Y)||!we.debug&&"warn"===t||console[t](e.toString())}function g(e,t){return new RegExp(e,t)}function v(e){return e.replace(le,"\\$&")}function y(e){return e.replace(fe,"")}function b(e){return ce.test(e)}function w(e,t){return e instanceof t}function P(e,t){return typeof e===t}function x(e){return e&&P(e,"object")}function j(e){return P(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function E(e){function t(){n(re,arguments)}function r(){n(ne,arguments)}function n(e,t){a.state===te&&(a.state=e,a.value=t,o[e].forEach(function(e){e.apply(oe,t)}))}var a=this,o={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===te)e&&o[re].push(e),t&&o[ne].push(t);else switch(a.state){case re:e&&e.apply(oe,a.value);break;case ne:t&&t.apply(oe,a.value)}},e(t,r)}function R(e,t,r){var n=this;n.message=e,t&&(n.module=t),r&&(n.stack=H.call(r))}function q(e,t){var r=this;r.weight=e.length,r.url=D.url(t),r.regexPattern=g("^"+v(e)),r.regexUrl=g("^"+v(t))}function k(){var e=this;e.current=oe,e.queue=[]}function I(e,t){var r,n,a=this;D.path.call(a,e,t),r=a.defered=ve[a.type][a.path]||(ve[a.type][a.path]=E.defer()),n=a.pledge=r.pledge,t&&n.then(oe,m),c(J+a.type).then(a.process.bind(a),r.reject)}function T(e,t,r){var n,a,o,i=this;D.path.call(i,e),n=i.path,a=ve[i.type][n],o=i.pledge=a.pledge,o.then(oe,function(){m(new R("unable to resolve module",n,arguments))}),r&&r.length>0?c.apply(i,r).then(function(){a.resolve(t.apply(oe,arguments))},function(){a.reject(new R("unable to resolve dependencies for",n,arguments))}):a.resolve(t())}var S,O,A,D,M,U,X,H=Array.prototype.slice,$=Array.prototype.concat,C=t.getElementsByTagName("head")[0],L=t.createElement("a"),N="provide",_="demand",B="settings",F="/"+_+"/",G=F+"scoped/",J=F+"handler/",Q=F+"storage/",z=F+"validator/",K="["+_+"]",V="[state]",W="[value]",Y="undefined",Z="string",ee="boolean",te="pending",re="resolved",ne="rejected",ae=function(){},oe=null,ie=a,se="XDomainRequest"in e&&e.XDomainRequest||ie,ce=/^\//i,ue=/^(!)?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,le=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,pe=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,fe=/^http(s?):/,he=/^(http(s?):|)\/\//,de=r&&"remainingSpace"in r,me={cache:!0,storage:"localstorage",handler:"js",debug:!1,timeout:5,base:"/"},ge={},ve={},ye={},be={},we={modules:{}};D={url:function(e){return L.href=e,L.href},path:function(e,t){var r,n,a=this,o=e.match(ue),i=o&&o[1]?!1:we.cache,s=o&&o[2]||me.handler,c=o&&o[3]||we.version,u=o&&o[4]&&1e3*o[4]||we.lifetime,l=w(a,I);if(o&&(e=e.replace(ue,"")),!he.test(e)){b(e)||(e="/"+D.url((t&&t.path&&D.url(t.path+"/../")||"/")+e).replace(S,""));for(r in ye)ye[r].matches(e)&&(!n||n.weight<ye[r].weight)&&(n=ye[r])}return l||w(a,T)?(a.type=s,a.path=e,l&&(a.cache=i,a.version=c,a.lifetime=u,a.url=n?y(D.url(n.process(e))):e),void 0):{type:s,path:e}}},X={get:function(e){var t,a,o;if(r){if(t=e.path,a=K+"["+t+"]",o=n.parse(r.getItem(a+V)),o&&o.version===e.version&&o.url===e.url&&(!o.expires&&!e.lifetime||o.expires>h()))return r.getItem(a+W);X.clear.path(t)}},set:function(e){var t,a,o,i;if(r){t=e.path,a=e.lifetime,o=K+"["+t+"]";try{if(i=de?r.remainingSpace:oe,r.setItem(o+W,e.source),r.setItem(o+V,n.stringify({version:e.version,expires:a?h()+a:a,url:e.url})),i!==oe&&r.remainingSpace===i)throw"QUOTA_EXCEEDED_ERR"}catch(s){m("unable to cache module "+t)}}},clear:{path:function(e){var t;r&&(t=K+"["+e+"]",r.removeItem(t+V),r.removeItem(t+W))},all:function(){var e;if(r)for(e in r)0===e.indexOf(K)&&r.removeItem(e)},expired:function(){var e,t,a;if(r)for(e in r)t=e.match(O),t&&(a=n.parse(r.getItem(K+"["+t[1]+"]"+V)),a&&a.expires>0&&a.expires<=h()&&X.clear.path(t[1]))}}},U={matchType:/^(application|text)\/javascript/,onPreRequest:function(){var e=this,t=e.url;e.url=".js"!==t.slice(-3)?t+".js":t},onPostRequest:function(){for(var e,t,r=this,n=r.url,a=r.source;e=pe.exec(a);)t=y(D.url(n+"/../"+e[1])),a=a.replace(e[0],"//# sourcemap="+t+".map");r.source=a},onPostProcess:function(){var e,r=this,n=r.source;e=t.createElement("script"),e.async=!0,e.text=n,e.setAttribute("demand-type",r.type),e.setAttribute("demand-path",r.path),C.appendChild(e)}},E.prototype={state:te,value:oe,then:oe},E.defer=function(){var e={};return e.pledge=new E(function(t,r){e.resolve=t,e.reject=r}),e},E.all=function(e){function t(){s===i?r.resolve.apply(oe,$.apply([],a)):o.length+s===i&&r.reject.apply(oe,$.apply([],o))}var r=E.defer(),n=r.pledge,a=[],o=[],i=e.length,s=0;return e.forEach(function(e,r){e.then(function(){a[r]=H.call(arguments),s++,t()},function(){o.push(H.call(arguments)),t()})}),n},E.race=function(e){var t=E.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},R.prototype={message:oe,module:oe,stack:oe,toString:function(){var e=this,t=K+" "+e.message+" "+(e.module||"");return e.stack&&(t=R.traverse(e.stack,t,1)),t}},R.traverse=function(e,t,r){var n=new Array(r+1).join(" ");return e.forEach(function(e){t+="\n"+n+"> "+e.message+" "+e.module,e.stack&&(t=R.traverse(e.stack,t,r+1))}),t},q.prototype={weight:0,url:oe,regexPattern:oe,regexUrl:oe,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},k.prototype={current:oe,queue:oe,items:0,add:function(e){var t=this,r=t.queue,n=e.handler;n.onPreProcess&&n.onPreProcess(e),r.push(e),t.items++,1===t.items&&t.process()},process:function(){var e,t,r,n,a=this,o=a.current,i=a.queue;o&&(a.current=oe,i.shift(),a.items--),a.items&&(o=a.current=a.queue[0],e=o.defered,t=o.path,r=o.handler,r.onPostProcess&&r.onPostProcess.call(o),o.probe&&o.pledge.state===te&&((n=o.probe())?u(function(){return n}):e.reject(new R("probe failed for module",t))))}},I.prototype={type:oe,cache:oe,version:oe,lifetime:oe,path:oe,pledge:oe,handler:oe,url:oe,defered:oe,cached:oe,source:oe,timeout:oe,probe:oe,process:function(e){var t,r=this,n=r.defered;e.onPreRequest&&e.onPreRequest.call(r),r.retrieve(),r.handler=e,r.probe=be[r.path],r.cached||!r.url?A.add(r):(t=S.test(r.url)?new ie:new se,t.onprogress=ae,t.ontimeout=t.onerror=t.onabort=function(){n.reject(new R("unable to load module",r.path))},t.onload=function(){var a=t.getResponseHeader&&t.getResponseHeader("content-type");r.timeout=i(r.timeout),"status"in t&&200!==t.status||a&&e.matchType&&!e.matchType.test(a)?n.reject(new R("unable to load module",r.path)):(r.source=t.responseText,e.onPostRequest&&e.onPostRequest.call(r),A.add(r))},t.open("GET",d(r.url),!0),t.send(),r.timeout=o(function(){t.readyState<4&&t.abort()},we.timeout))},store:function(){var e=this;e.cache&&e.source&&M.set(e)},retrieve:function(){var e,t,r=this;r.url&&(e=r.cache&&M.get(r),t=r.cached=!!e,t&&(r.source=e))}},T.prototype={type:oe,path:oe,pledge:oe},S=g("^"+v(D.url("/"))),O=g("^"+v(K+"[(.+?)]"+V+"$")),A=new k,ye["/"+_]=new q("/"+_,D.url((s&&s.url||location.href)+"/../").slice(0,-1)),l(me)&&s&&s.settings&&l(s.settings),c.configure=l,c.list=function(e){var t,r,n,a,o,i={};for(t in ge)if(e){r=i[t]=[],n=ge[t];for(a in n)o=n[a],(o.state===e||o.cache&&o.cache===e)&&r.push(a)}else i[t]=Object.keys(ge[t]);return i},e.demand=c,e.provide=u,f(F+"pledge",E),f(F+"function/resolve/url",D.url),f(F+"modifier/removeProtocol",y),f(z+"isObject",x),f(z+"isTypeOf",P),f(z+"isInstanceOf",w),f(z+"isPositiveInteger",j),f(Q+me.storage,X),f(J+me.handler,U),c(Q+we.storage).then(function(e){M=e,c.clear=M.clear,M.clear.expired(),s&&s.main&&c(s.main)})}(this,document,function(){try{return"localStorage"in this&&localStorage}catch(e){return!1}}(),JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand);
//# sourceMappingURL=demand.js.map