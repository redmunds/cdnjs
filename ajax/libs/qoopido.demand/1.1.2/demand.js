/*! Qoopido.demand 1.1.2 | https://github.com/dlueth/qoopido.demand | (c) 2015 Dirk Lueth */
!function(e,t,r,n,a,o,i,u){"use strict";function s(){var e=this,t=w(e,S)||w(e,I)?e:oe,r=$.call(arguments);return r.forEach(p,t),E.all(r)}function c(){var e,t,r,n,a,u,s=this,c=w(s,S)||w(s,I)?s:oe,l=P(arguments[0],Z)?arguments[0]:oe,p=l?arguments[1]:arguments[0];if(!A.current||l&&l!==A.current.path||(e=A.current,l=e.type+"!"+e.path),l)return r=D.path(l,c),n=r.type,l=r.path,a=ve[n]||(ve[n]={}),u=ge[n]||(ge[n]={}),!u[l]||e?(e||(a[l]=E.defer(),u[l]=a[l].pledge),o(function(){new S(n+"!"+l,p,t),e&&(e.timeout=i(e.timeout),e.cache&&P(e.cached,ee)&&(e.pledge.cache=e.cached?"hit":"miss"),!e.cached&&e.store(),A.items>0&&A.process())}),{when:function(){t=arguments}}):(m("duplicate found for module "+r.path),{when:ae});throw new q("unspecified anonymous provide")}function l(e){var t,r=e.cache,n=e.storage,a=e.debug,o=e.version,i=e.timeout,u=e.lifetime,s=e.base,c=e.pattern,l=e.probes,p=e.modules;if(we.cache=P(r,ee)?r:we.cache,we.storage=P(n,Z)?n:we.storage,we.debug=P(a,ee)?a:we.debug,P(o,Z)&&(we.version=o),j(i)&&(we.timeout=1e3*Math.min(Math.max(i,2),10)),j(u)&&u>0&&(we.lifetime=1e3*u),P(s,Z)&&(ye.base=new R("",D.url(s))),x(c))for(t in c)"base"!==t&&(ye[t]=new R(t,c[t]));if(x(l))for(t in l)be[t]=l[t];if(x(p))for(t in p)we.modules[t]=p[t];return!0}function p(e,t,r){var n,a=this,o=D.path(e,a),i=o.type,u=o.path,l=ge[i]||(ge[i]={});if(ve[i]||(ve[i]={}),a&&(e===B||e===_||e===F)&&!l[u]){switch(e){case B:u=H+B+u,n=function(){var e=s.bind(a);return e.configure=s.configure,e.clear=s.clear,e.list=s.list,e};break;case _:u=H+_+u,n=function(){return c.bind(a)};break;case F:u=H+F+a.path,n=function(){return we.modules[a.path]||oe}}c(u,n)}r[t]=l[u]||(l[u]=new I(e,a).pledge)}function f(e,t){c(e,function(){return t})}function h(){return+new Date}function d(e){N.href=e;var t=N.search,r="demand[timestamp]="+h();return N.search+=t&&"?"!==t?"&"+r:"?"+r,N.href}function m(e){var t=w(e,q)?"error":"warn";P(console,Y)||!we.debug&&"warn"===t||console[t](e.toString())}function g(e,t){return new RegExp(e,t)}function v(e){return e.replace(le,"\\$&")}function y(e){return e.replace(fe,"")}function b(e){return se.test(e)}function w(e,t){return e instanceof t}function P(e,t){return typeof e===t}function x(e){return e&&P(e,"object")}function j(e){return P(e,"number")&&isFinite(e)&&Math.floor(e)===e&&e>=0}function E(e){function t(){n(re,arguments)}function r(){n(ne,arguments)}function n(e,t){a.state===te&&(a.state=e,a.value=t,o[e].forEach(function(e){e.apply(oe,t)}))}var a=this,o={resolved:[],rejected:[]};a.then=function(e,t){if(a.state===te)e&&o[re].push(e),t&&o[ne].push(t);else switch(a.state){case re:e&&e.apply(oe,a.value);break;case ne:t&&t.apply(oe,a.value)}},e(t,r)}function q(e,t,r){var n=this;n.message=e,t&&(n.module=t),r&&(n.stack=$.call(r))}function R(e,t){var r=this;r.weight=e.length,r.url=D.url(t),r.regexPattern=g("^"+v(e)),r.regexUrl=g("^"+v(t))}function k(){var e=this;e.current=oe,e.queue=[]}function I(e,t){var r,n,a=this;D.path.call(a,e,t),r=a.defered=ve[a.type][a.path]||(ve[a.type][a.path]=E.defer()),n=a.pledge=r.pledge,t&&n.then(oe,m),s(J+a.type).then(a.process.bind(a),r.reject)}function S(e,t,r){var n,a,o,i=this;D.path.call(i,e),n=i.path,a=ve[i.type][n],o=i.pledge=a.pledge,o.then(oe,function(){m(new q("unable to resolve module",n,arguments))}),r&&r.length>0?s.apply(i,r).then(function(){a.resolve(t.apply(oe,arguments))},function(){a.reject(new q("unable to resolve dependencies for",n,arguments))}):a.resolve(t())}var O,T,A,D,M,U,X,$=Array.prototype.slice,C=Array.prototype.concat,L=t.getElementsByTagName("head")[0],N=t.createElement("a"),_="provide",B="demand",F="settings",G="/"+B+"/",H=G+"scoped/",J=G+"handler/",Q=G+"storage/",z=G+"validator/",K="["+B+"]",V="[state]",W="[value]",Y="undefined",Z="string",ee="boolean",te="pending",re="resolved",ne="rejected",ae=function(){},oe=null,ie=a,ue="XDomainRequest"in e&&e.XDomainRequest||ie,se=/^\//i,ce=/^(!)?((?:[-\w]+\/?)+)?(?:@(\d+\.\d+.\d+))?(?:#(\d+))?!/,le=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,pe=/\/\/#\s+sourceMappingURL\s*=\s*(.+?)\.map/g,fe=/^http(s?):/,he=/^(http(s?):|)\/\//,de=r&&"remainingSpace"in r,me={cache:!0,storage:"localstorage",handler:"js",debug:!1,timeout:5,base:"/"},ge={},ve={},ye={},be={},we={modules:{}};D={url:function(e){return N.href=e,N.href},path:function(e,t){var r,n,a=this,o=e.match(ce),i=o&&o[1]?!1:we.cache,u=o&&o[2]||me.handler,s=o&&o[3]||we.version,c=o&&o[4]&&1e3*o[4]||we.lifetime,l=w(a,I);if(o&&(e=e.replace(ce,"")),!he.test(e)){b(e)||(e="/"+D.url((t&&t.path&&D.url(t.path+"/../")||"/")+e).replace(O,""));for(r in ye)ye[r].matches(e)&&(!n||n.weight<ye[r].weight)&&(n=ye[r])}return l||w(a,S)?(a.type=u,a.path=e,l&&(a.cache=i,a.version=s,a.lifetime=c,a.url=n?y(D.url(n.process(e))):e),void 0):{type:u,path:e}}},X={get:function(e){var t,a,o;if(r){if(t=e.path,a=K+"["+t+"]",o=n.parse(r.getItem(a+V)),o&&o.version===e.version&&o.url===e.url&&(!o.expires&&!e.lifetime||o.expires>h()))return r.getItem(a+W);X.clear.path(t)}},set:function(e){var t,a,o,i;if(r){t=e.path,a=e.lifetime,o=K+"["+t+"]";try{if(i=de?r.remainingSpace:oe,r.setItem(o+W,e.source),r.setItem(o+V,n.stringify({version:e.version,expires:a?h()+a:a,url:e.url})),i!==oe&&r.remainingSpace===i)throw"QUOTA_EXCEEDED_ERR"}catch(u){m("unable to cache module "+t)}}},clear:{path:function(e){var t;r&&(t=K+"["+e+"]",r.removeItem(t+V),r.removeItem(t+W))},all:function(){var e;if(r)for(e in r)0===e.indexOf(K)&&r.removeItem(e)},expired:function(){var e,t,a;if(r)for(e in r)t=e.match(T),t&&(a=n.parse(r.getItem(K+"["+t[1]+"]"+V)),a&&a.expires>0&&a.expires<=h()&&X.clear.path(t[1]))}}},U={onPreRequest:function(){var e=this,t=e.url;e.url=".js"!==t.slice(-3)?t+".js":t},onPostRequest:function(){for(var e,t,r=this,n=r.url,a=r.source;e=pe.exec(a);)t=y(D.url(n+"/../"+e[1])),a=a.replace(e[0],"//# sourcemap="+t+".map");r.source=a},onPostProcess:function(){var e,r=this,n=r.source;e=t.createElement("script"),e.async=!0,e.text=n,e.setAttribute("demand-type",r.type),e.setAttribute("demand-path",r.path),L.appendChild(e)}},E.prototype={state:te,value:oe,then:oe},E.defer=function(){var e={};return e.pledge=new E(function(t,r){e.resolve=t,e.reject=r}),e},E.all=function(e){function t(){u===i?r.resolve.apply(oe,C.apply([],a)):o.length+u===i&&r.reject.apply(oe,C.apply([],o))}var r=E.defer(),n=r.pledge,a=[],o=[],i=e.length,u=0;return e.forEach(function(e,r){e.then(function(){a[r]=$.call(arguments),u++,t()},function(){o.push($.call(arguments)),t()})}),n},E.race=function(e){var t=E.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},q.prototype={message:oe,module:oe,stack:oe,toString:function(){var e=this,t=K+" "+e.message+" "+(e.module||"");return e.stack&&(t=q.traverse(e.stack,t,1)),t}},q.traverse=function(e,t,r){var n=new Array(r+1).join(" ");return e.forEach(function(e){t+="\n"+n+"> "+e.message+" "+e.module,e.stack&&(t=q.traverse(e.stack,t,r+1))}),t},R.prototype={weight:0,url:oe,regexPattern:oe,regexUrl:oe,matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},k.prototype={current:oe,queue:oe,items:0,add:function(e){var t=this,r=t.queue,n=e.handler;n.onPreProcess&&n.onPreProcess(e),r.push(e),t.items++,1===t.items&&t.process()},process:function(){var e,t,r,n,a=this,o=a.current,i=a.queue;o&&(a.current=oe,i.shift(),a.items--),a.items&&(o=a.current=a.queue[0],e=o.defered,t=o.path,r=o.handler,r.onPostProcess&&r.onPostProcess.call(o),o.probe&&o.pledge.state===te&&((n=o.probe())?c(function(){return n}):e.reject(new q("probe failed for module",t))))}},I.prototype={type:oe,cache:oe,version:oe,lifetime:oe,path:oe,pledge:oe,handler:oe,url:oe,defered:oe,cached:oe,source:oe,timeout:oe,probe:oe,process:function(e){var t,r=this,n=r.defered;e.onPreRequest&&e.onPreRequest.call(r),r.retrieve(),r.handler=e,r.probe=be[r.path],r.cached||!r.url?A.add(r):(t=O.test(r.url)?new ie:new ue,t.onprogress=ae,t.ontimeout=t.onerror=t.onabort=function(){n.reject(new q("unable to load module",r.path))},t.onload=function(){r.timeout=i(r.timeout),"status"in t&&200!==t.status?n.reject(new q("unable to load module",r.path)):(r.source=t.responseText,e.onPostRequest&&e.onPostRequest.call(r),A.add(r))},t.open("GET",d(r.url),!0),t.send(),r.timeout=o(function(){t.readyState<4&&t.abort()},we.timeout))},store:function(){var e=this;e.cache&&e.source&&M.set(e)},retrieve:function(){var e,t,r=this;r.url&&(e=r.cache&&M.get(r),t=r.cached=!!e,t&&(r.source=e))}},S.prototype={type:oe,path:oe,pledge:oe},O=g("^"+v(D.url("/"))),T=g("^"+v(K+"[(.+?)]"+V+"$")),A=new k,ye["/"+B]=new R("/"+B,D.url((u&&u.url||location.href)+"/../").slice(0,-1)),l(me)&&u&&u.settings&&l(u.settings),s.configure=l,s.list=function(e){var t,r,n,a,o,i={};for(t in ge)if(e){r=i[t]=[],n=ge[t];for(a in n)o=n[a],(o.state===e||o.cache&&o.cache===e)&&r.push(a)}else i[t]=Object.keys(ge[t]);return i},e.demand=s,e.provide=c,f(G+"pledge",E),f(G+"function/resolve/url",D.url),f(G+"modifier/removeProtocol",y),f(z+"isObject",x),f(z+"isTypeOf",P),f(z+"isInstanceOf",w),f(z+"isPositiveInteger",j),f(Q+me.storage,X),f(J+me.handler,U),s(Q+we.storage).then(function(e){M=e,s.clear=M.clear,M.clear.expired(),u&&u.main&&s(u.main)})}(this,document,function(){try{return"localStorage"in this&&localStorage}catch(e){return!1}}(),JSON,XMLHttpRequest,setTimeout,clearTimeout,"demand"in this&&demand);
//# sourceMappingURL=demand.js.map