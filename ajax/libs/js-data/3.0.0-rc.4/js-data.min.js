/*!
* js-data
* @version 3.0.0-rc.4 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t(e.JSData=e.JSData||{})}(this,function(e){"use strict";function Settable(){var e={};Object.defineProperties(this,{_get:{value:function value(t){return O.get(e,t)}},_set:{value:function value(t,n){return O.set(e,t,n)}},_unset:{value:function value(t){return O.unset(e,t)}}})}function Component(e){Settable.call(this),e||(e={}),this.debug=!!e.hasOwnProperty("debug")&&!!e.debug,Object.defineProperty(this,"_listeners",{value:{},writable:!0})}function Query(e){O.classCallCheck(this,Query),this.collection=e,this.data=null}function sort(e,t,n){return e===t?0:(n&&(e=n(e),t=n(t)),null===e&&null===t||void 0===e&&void 0===t?-1:null===e||void 0===e?-1:null===t||void 0===t?1:e<t?-1:e>t?1:0)}function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var i=0,r=e.length,o=void 0,a=void 0;i<r;){if(a=(i+r)/2|0,o=sort(t,e[a],n),0===o)return{found:!0,index:a};o<0?r=a:i=a+1}return{found:!1,index:r}}function Index(e,t){if(O.classCallCheck(this,Index),e||(e=[]),!O.isArray(e))throw new Error("fieldList must be an array.");t||(t={}),this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}function Collection(e,t){O.classCallCheck(this,Collection),w.call(this,t),e&&!O.isArray(e)&&(t=e,e=[]),O.isString(t)&&(t={idAttribute:t}),e||(e=[]),t||(t={}),Object.defineProperties(this,{mapper:{value:void 0,writable:!0},queryClass:{value:void 0,writable:!0}}),O.fillIn(this,t),O.fillIn(this,O.copy(M)),this.queryClass||(this.queryClass=S);var n=this.recordId();Object.defineProperties(this,{index:{value:new Index([n],{hashCode:function hashCode(e){return O.get(e,n)}})},indexes:{value:{}}}),(O.isObject(e)||O.isArray(e)&&e.length)&&this.add(e)}function Relation(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];O.classCallCheck(this,Relation),n.type=this.constructor.TYPE_NAME,this.validateOptions(e,n),"object"===("undefined"==typeof e?"undefined":t(e))&&Object.defineProperty(this,"relatedMapper",{value:e}),Object.defineProperty(this,"inverse",{writable:!0}),O.fillIn(this,n)}function Record(e,t){O.classCallCheck(this,Record),Settable.call(this),e||(e={}),t||(t={});var n=this._set;n("creating",!0),t.noValidate&&n("noValidate",!0);var i=this.constructor.mapper,r=i?O.get(e,i.idAttribute):void 0;void 0!==r&&O.set(this,i.idAttribute,r),O.fillIn(this,e),n("creating",!1),n("noValidate",!1),n("previous",O.plainCopy(e))}function Schema(e){var t=this;e||(e={}),O.fillIn(this,e),"object"===this.type&&this.properties&&O.forOwn(this.properties,function(e,n){e instanceof Schema||(t.properties[n]=new Schema(e))}),"array"!==this.type||!this.items||this.items instanceof Schema||(this.items=new Schema(this.items)),["allOf","anyOf","oneOf"].forEach(function(e){t[e]&&t[e].forEach(function(n,i){n instanceof Schema||(t[e][i]=new Schema(n))})})}function Mapper(e){var t=this;if(O.classCallCheck(this,Mapper),w.call(this),e||(e={}),Object.defineProperties(this,{_adapters:{value:void 0,writable:!0},datastore:{value:void 0,writable:!0},lifecycleMethods:{value:Ie},recordClass:{value:void 0,writable:!0},schema:{value:void 0,writable:!0}}),O.fillIn(this,e),O.fillIn(this,O.copy(je)),!this.name)throw O.err("new "+we,"opts.name")(400,"string",this.name);this.schema&&(this.schema.type||(this.schema.type="object")),this.schema instanceof _e||(this.schema=new _e(this.schema||{type:"object"})),void 0===this.recordClass&&!function(){var e=H;t.recordClass=e.extend({constructor:function Record(){var t=function Record(n,i){O.classCallCheck(this,t),e.call(this,n,i)};return t}()})}(),this.recordClass&&(this.recordClass.mapper=this,O.isObject(this.methods)&&O.addHiddenPropsToTarget(this.recordClass.prototype,this.methods),H.prototype.isPrototypeOf(Object.create(this.recordClass.prototype))&&this.schema&&this.schema.apply&&this.applySchema&&this.schema.apply(this.recordClass.prototype))}function Container(e){O.classCallCheck(this,Container),w.call(this),e||(e={}),Object.defineProperties(this,{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),O.fillIn(this,e),this.mapperDefaults=this.mapperDefaults||{},this.mapperClass||(this.mapperClass=Se)}function LinkedCollection(e,t){if(O.classCallCheck(this,LinkedCollection),Object.defineProperties(this,{_added:{value:{}},datastore:{writable:!0,value:void 0}}),P.call(this,e,t),!this.datastore)throw O.err("new "+Ke,"opts.datastore")(400,"DataStore",this.datastore)}function DataStore(e){O.classCallCheck(this,DataStore),e||(e={}),O.fillIn(e,Qe),Container.call(this,e),this.collectionClass=this.collectionClass||Ne,this._collections={},this._pendingQueries={},this._completedQueries={}}var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},n=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},i=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},r="utils",o=1/0,a=1.7976931348623157e308,s="[object Boolean]",u="[object Date]",c="[object Function]",l="[object Number]",f="[object Object]",d="[object RegExp]",h="[object String]",p=Object.prototype.toString,v=/^(.+)\.(.+)$/,g={400:function _(){return"expected: "+arguments[0]+", found: "+(arguments[2]?arguments[1]:t(arguments[1]))},404:function _(){return arguments[0]+" not found"}},y=function toInteger(e){if(!e)return 0;if(e=+e,e===o||e===-o){var t=e<0?-1:1;return t*a}var n=e%1;return e===e?n?e-n:e:0},m=function toStr(e){return p.call(e)},b=function isPlainObject(e){return!!e&&"object"===("undefined"==typeof e?"undefined":t(e))&&e.constructor===Object},A=function mkdirP(e,t){if(!t)return e;var n=t.split(".");return n.forEach(function(t){e[t]||(e[t]={}),e=e[t]}),e},O={Promise:Promise,_:function _(e,t){O.forOwn(t,function(t,n){n&&void 0===e[n]&&!O.isFunction(t)&&0!==n.indexOf("_")&&(e[n]=t)})},_forRelation:function _forRelation(e,t,n,i){var r=t.relation,o=null,a=void 0;if(e||(e={}),e.with||(e.with=[]),(a=O._getIndex(e.with,r))>=0?o=r:(a=O._getIndex(e.with,t.localField))>=0&&(o=t.localField),e.withAll)return void n.call(i,t,{});if(o){var s={};O.fillIn(s,t.getRelation()),O.fillIn(s,e),s.with=e.with.slice(),s._activeWith=s.with.splice(a,1)[0],s.with.forEach(function(e,t){e&&0===e.indexOf(o)&&e.length>=o.length&&"."===e[o.length]?s.with[t]=e.substr(o.length+1):s.with[t]=""}),n.call(i,t,s)}},_getIndex:function _getIndex(e,t){var n=-1;return e.forEach(function(e,i){return e===t?(n=i,!1):O.isObject(e)&&e.relation===t?(n=i,!1):void 0}),n},addHiddenPropsToTarget:function addHiddenPropsToTarget(e,t){var n={};Object.keys(t).forEach(function(e){var i=Object.getOwnPropertyDescriptor(t,e);i.enumerable=!1,n[e]=i}),Object.defineProperties(e,n)},areDifferent:function areDifferent(e,t,n){n||(n={});var i=O.diffObjects(e,t,n),r=Object.keys(i.added).length+Object.keys(i.removed).length+Object.keys(i.changed).length;return r>0},classCallCheck:function classCallCheck(e,t){if(!(e instanceof t))throw O.err(""+t.name)(500,"Cannot call a class as a function")},copy:function copy(e,t,n,i,o,a){if(t){if(e===t)throw O.err(r+".copy")(500,"Cannot copy! Source and destination are identical.");if(n=n||[],i=i||[],O.isObject(e)){var s=n.indexOf(e);if(s!==-1)return i[s];n.push(e),i.push(t)}var u=void 0;if(O.isArray(e)){var c=void 0;for(t.length=0,c=0;c<e.length;c++)u=O.copy(e[c],null,n,i,o,a),O.isObject(e[c])&&(n.push(e[c]),i.push(u)),t.push(u)}else{O.isArray(t)?t.length=0:O.forOwn(t,function(e,n){delete t[n]});for(var l in e)if(e.hasOwnProperty(l)){if(O.isBlacklisted(l,o))continue;u=O.copy(e[l],null,n,i,o,a),O.isObject(e[l])&&(n.push(e[l]),i.push(u)),t[l]=u}}}else t=e,e&&(O.isArray(e)?t=O.copy(e,[],n,i,o,a):O.isDate(e)?t=new Date(e.getTime()):O.isRegExp(e)?(t=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]),t.lastIndex=e.lastIndex):O.isObject(e)&&(t=a?O.copy(e,{},n,i,o,a):O.copy(e,Object.create(Object.getPrototypeOf(e)),n,i,o,a)));return t},deepFillIn:function deepFillIn(e,t){return t&&O.forOwn(t,function(t,n){var i=e[n];b(t)&&b(i)?O.deepFillIn(i,t):e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)}),e},deepMixIn:function deepMixIn(e,t){if(t)for(var n in t){var i=t[n],r=e[n];b(i)&&b(r)?O.deepMixIn(r,i):e[n]=i}return e},diffObjects:function diffObjects(e,t,n){n||(n={});var i=n.equalsFn,r=n.ignore,o={added:{},changed:{},removed:{}};O.isFunction(i)||(i=O.deepEqual);var a=Object.keys(e).filter(function(e){return!O.isBlacklisted(e,r)}),s=Object.keys(t).filter(function(e){return!O.isBlacklisted(e,r)});return a.forEach(function(n){var r=t[n],a=e[n];i(r,a)||(void 0===r?o.added[n]=a:o.changed[n]=a)}),s.forEach(function(n){var i=t[n],r=e[n];void 0===r&&void 0!==i&&(o.removed[n]=void 0)}),o},equal:function equal(e,t){return e==t},err:function err(e,t){return function(n){var i="["+e+":"+t+"] ",r=g[n].apply(null,Array.prototype.slice.call(arguments,1));return r=""+i+r+"\nhttp://www.js-data.io/v3.0/docs/errors#"+n,new Error(r)}},eventify:function eventify(e,t,n){e=e||this;var i={};t||n||(t=function getter(){return i},n=function setter(e){i=e}),Object.defineProperties(e,{emit:{value:function value(){for(var e=t.call(this)||{},n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];var o=i.shift(),a=e[o]||[],s=void 0;for(s=0;s<a.length;s++)a[s].f.apply(a[s].c,i);for(a=e.all||[],i.unshift(o),s=0;s<a.length;s++)a[s].f.apply(a[s].c,i)}},off:{value:function value(e,i){var r=t.call(this),o=r[e];if(o)if(i){for(var a=0;a<o.length;a++)if(o[a].f===i){o.splice(a,1);break}}else o.splice(0,o.length);else n.call(this,{})}},on:{value:function value(e,i,r){t.call(this)||n.call(this,{});var o=t.call(this);o[e]=o[e]||[],o[e].push({c:r,f:i})}}})},extend:function extend(e,t){var n=this,i=void 0;e||(e={}),t||(t={}),e.hasOwnProperty("constructor")?(i=e.constructor,delete e.constructor):i=function subClass(){O.classCallCheck(this,i);for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];n.apply(this,t)},i.prototype=Object.create(n&&n.prototype,{constructor:{configurable:!0,enumerable:!1,value:i,writable:!0}});var r=Object;return r.setPrototypeOf?r.setPrototypeOf(i,n):t.strictEs6Class?i.__proto__=n:O.forOwn(n,function(e,t){i[t]=e}),i.hasOwnProperty("__super__")||Object.defineProperty(i,"__super__",{configurable:!0,value:n}),O.addHiddenPropsToTarget(i.prototype,e),O.fillIn(i,t),i},fillIn:function fillIn(e,t){O.forOwn(t,function(t,n){e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)})},findIndex:function findIndex(e,t){var n=-1;return e?(e.forEach(function(e,i){if(t(e))return n=i,!1}),n):n},forEachRelation:function forEachRelation(e,t,n,i){var r=e.relationList||[];r.length&&r.forEach(function(e){O._forRelation(t,e,n,i)})},forOwn:function forOwn(e,t,n){var i=Object.keys(e),r=i.length,o=void 0;for(o=0;o<r;o++)t.call(n,e[i[o]],i[o],e)},fromJson:function fromJson(e){return O.isString(e)?JSON.parse(e):e},get:function get(e,t){if(t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(e=e[t],null==e)return;return e[i]}},getSuper:function getSuper(e,t){var n=t?e:e.constructor;return n.hasOwnProperty("__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function intersection(e,t){if(!e||!t)return[];var n=[],i=void 0,r=void 0,o=e.length;for(r=0;r<o;r++)i=e[r],n.indexOf(i)===-1&&t.indexOf(i)!==-1&&n.push(i);return n},isArray:Array.isArray,isBlacklisted:function isBlacklisted(e,t){if(!t||!t.length)return!1;for(var n=void 0,i=0;i<t.length;i++)if(m(t[i])===d&&t[i].test(e)||t[i]===e)return n=e,!!n;return!!n},isBoolean:function isBoolean(e){return m(e)===s},isDate:function isDate(e){return e&&"object"===("undefined"==typeof e?"undefined":t(e))&&m(e)===u},isFunction:function isFunction(e){return"function"==typeof e||e&&m(e)===c},isInteger:function isInteger(e){return m(e)===l&&e==y(e)},isNull:function isNull(e){return null===e},isNumber:function isNumber(e){var n="undefined"==typeof e?"undefined":t(e);return"number"===n||e&&"object"===n&&m(e)===l},isObject:function isObject(e){return m(e)===f},isRegExp:function isRegExp(e){return m(e)===d},isSorN:function isSorN(e){return O.isString(e)||O.isNumber(e)},isString:function isString(e){return"string"==typeof e||e&&"object"===("undefined"==typeof e?"undefined":t(e))&&m(e)===h},isUndefined:function isUndefined(e){return void 0===e},logify:function logify(e){O.addHiddenPropsToTarget(e,{dbg:function dbg(){if(O.isFunction(this.log)){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))}},log:function log(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var r=e.toUpperCase()+": ("+(this.name||this.constructor.name)+")";if(O.isFunction(console[e])){var o;(o=console)[e].apply(o,[r].concat(n))}else{var a;(a=console).log.apply(a,[r].concat(n))}}}})},noDupeAdd:function noDupeAdd(e,t,n){if(e){var i=this.findIndex(e,n);i<0&&e.push(t)}},omit:function omit(e,t){var n={};return O.forOwn(e,function(e,i){t.indexOf(i)===-1&&(n[i]=e)}),n},pick:function pick(e,t){var n={};return O.forOwn(e,function(e,i){t.indexOf(i)!==-1&&(n[i]=e)}),n},plainCopy:function plainCopy(e){return O.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function reject(e){return O.Promise.reject(e)},remove:function remove(e,t){if(e&&e.length){var n=this.findIndex(e,t);n>=0&&e.splice(n,1)}},resolve:function resolve(e){return O.Promise.resolve(e)},set:function set(e,t,n){if(O.isObject(t))O.forOwn(t,function(t,n){O.set(e,n,t)});else{var i=v.exec(t);i?A(e,i[1])[i[2]]=n:e[t]=n}},deepEqual:function deepEqual(e,t){if(e===t)return!0;var n=!0;if(O.isObject(e)&&O.isObject(t)){if(O.forOwn(e,function(e,i){n=n&&O.deepEqual(e,t[i])}),!n)return n;O.forOwn(t,function(t,i){n=n&&O.deepEqual(t,e[i])})}else{if(!O.isArray(e)||!O.isArray(t))return!1;e.forEach(function(e,i){if(n=n&&O.deepEqual(e,t[i]),!n)return!1})}return n},toJson:JSON.stringify,unset:function unset(e,t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(e=e[t],null==e)return;e[i]=void 0}},x=function safeSetProp(e,t,n){e&&e._set?e._set("props."+t,n):O.set(e,t,n)},_=function safeSetLink(e,t,n){e&&e._set?e._set("links."+t,n):O.set(e,t,n)};Settable.extend=O.extend;var w=Settable.extend({constructor:Component});Component.extend=O.extend,O.logify(Component.prototype),O.eventify(Component.prototype,function(){return this._listeners},function(e){this._listeners=e});var C="Query",F="Index inaccessible after first operation",R={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},E=/([.*+?^=!:${}()|[\]\/\\])/g,k=/%/g,I=/_/g,j=function escape(e){return e.replace(E,"\\$1")},S=w.extend({constructor:Query,_applyWhereFromObject:function _applyWhereFromObject(e){var t=[],n=[],i=[];return O.forOwn(e,function(e,r){O.isObject(e)||(e={"==":e}),O.forOwn(e,function(e,o){t.push(r),n.push(o),i.push(e)})}),{fields:t,ops:n,predicates:i}},_applyWhereFromArray:function _applyWhereFromArray(e){var t=this,n=[];return e.forEach(function(i,r){if(!O.isString(i)){var o=e[r-1],a=O.isArray(i)?t._applyWhereFromArray:t._applyWhereFromObject,s=a.call(t,i);"or"===o&&(s.isOr=!0),n.push(s)}}),n.isArray=!0,n},_testObjectGroup:function _testObjectGroup(e,t,n,i){var r=void 0,o=n.fields,a=n.ops,s=n.predicates,u=a.length;for(r=0;r<u;r++){var c=a[r],l="|"===c.charAt(0);c=l?c.substr(1):c;var f=this.evaluate(O.get(i,o[r]),c,s[r]);void 0!==f&&(e=t?f:l?e||f:e&&f),t=!1}return{keep:e,first:t}},_testArrayGroup:function _testArrayGroup(e,t,n,i){var r=void 0,o=n.length;for(r=0;r<o;r++){var a=n[r],s=a.isArray?this._testArrayGroup:this._testObjectGroup,u=s.call(this,!0,!0,a,i);e=n[r-1]?a.isOr?e||u.keep:e&&u.keep:u.keep,t=u.first}return{keep:e,first:t}},between:function between(e,t,n){if(n||(n={}),this.data)throw O.err(C+"#between")(500,"Cannot access index");return this.data=this.collection.getIndex(n.index).between(e,t,n),this},compare:function compare(e,t,n,i){var r=e[t],o=O.get(n,r[0]),a=O.get(i,r[0]);if(o&&O.isString(o)&&(o=o.toUpperCase()),a&&O.isString(a)&&(a=a.toUpperCase()),void 0===n&&(n=null),void 0===i&&(i=null),"DESC"===r[1].toUpperCase()){var s=a;a=o,o=s}return o<a?-1:o>a?1:t<e.length-1?this.compare(e,t+1,n,i):0},evaluate:function evaluate(e,t,n){var i=this.constructor.ops;return i[t]?i[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0},filter:function filter(e,t){var n=this;return e||(e={}),this.getData(),O.isObject(e)?!function(){var t={};(O.isObject(e.where)||O.isArray(e.where))&&(t=e.where),O.forOwn(e,function(e,n){n in R||n in t||(t[n]={"==":e})});var i=void 0;O.isObject(t)&&0!==Object.keys(t).length?i=n._applyWhereFromArray([t]):O.isArray(t)&&(i=n._applyWhereFromArray(t)),i&&(n.data=n.data.filter(function(e,t){return n._testArrayGroup(!0,!0,i,e).keep}));var r=e.orderBy||e.sort;O.isString(r)&&(r=[[r,"ASC"]]),O.isArray(r)||(r=null),r&&!function(){var e=0;r.forEach(function(e,t){O.isString(e)&&(r[t]=[e,"ASC"])}),n.data.sort(function(t,i){return n.compare(r,e,t,i)})}(),O.isNumber(e.skip)?n.skip(e.skip):O.isNumber(e.offset)&&n.skip(e.offset),O.isNumber(e.limit)&&n.limit(e.limit)}():O.isFunction(e)&&(this.data=this.data.filter(e,t)),this},forEach:function forEach(e,t){return this.getData().forEach(e,t),this},get:function get(e,t){if(e||(e=[]),t||(t={}),this.data)throw O.err(C+"#get")(500,F);return e&&!O.isArray(e)&&(e=[e]),e.length?(this.data=this.collection.getIndex(t.index).get(e),this):(this.getData(),this)},getAll:function getAll(){var e=this,t={};if(this.data)throw O.err(C+"#getAll")(500,F);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];if(!i.length||1===i.length&&O.isObject(i[0]))return this.getData(),this;i.length&&O.isObject(i[i.length-1])&&(t=i[i.length-1],i.pop());var o=this.collection,a=o.getIndex(t.index);return this.data=[],i.forEach(function(t){e.data=e.data.concat(a.get(t))}),this},getData:function getData(){return this.data||(this.data=this.collection.index.getAll()),this.data},like:function like(e,t){return new RegExp("^"+j(e).replace(k,".*").replace(I,".")+"$",t)},limit:function limit(e){if(!O.isNumber(e))throw O.err(C+"#limit","num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},map:function map(e,t){return this.data=this.getData().map(e,t),this},mapCall:function mapCall(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.data=this.getData().map(function(t){return t[e].apply(t,n)}),this},run:function run(){var e=this.data;return this.data=null,e},skip:function skip(e){if(!O.isNumber(e))throw O.err(C+"#skip","num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}},{ops:{"=":function _(e,t){return e==t},"==":function _(e,t){return e==t},"===":function _(e,t){return e===t},"!=":function _(e,t){return e!=t},"!==":function _(e,t){return e!==t},">":function _(e,t){return e>t},">=":function _(e,t){return e>=t},"<":function _(e,t){return e<t},"<=":function _(e,t){return e<=t},isectEmpty:function isectEmpty(e,t){return!O.intersection(e||[],t||[]).length},isectNotEmpty:function isectNotEmpty(e,t){return O.intersection(e||[],t||[]).length},in:function _in(e,t){return t.indexOf(e)!==-1},notIn:function notIn(e,t){return t.indexOf(e)===-1},contains:function contains(e,t){return(e||[]).indexOf(t)!==-1},notContains:function notContains(e,t){return(e||[]).indexOf(t)===-1}}});O.addHiddenPropsToTarget(Index.prototype,{set:function set(e,t){O.isArray(e)||(e=[e]);var n=e.shift()||void 0,i=binarySearch(this.keys,n);if(0===e.length)if(i.found){var r=binarySearch(this.values[i.index],t,this.hashCode);r.found||insertAt(this.values[i.index],r.index,t)}else insertAt(this.keys,i.index,n),insertAt(this.values,i.index,[t]);else if(i.found)this.values[i.index].set(e,t);else{insertAt(this.keys,i.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,i.index,o)}},get:function get(e){O.isArray(e)||(e=[e]);var t=e.shift()||void 0,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index].slice():[]:n.found?this.values[n.index].get(e):[]},getAll:function getAll(e){e||(e={});var t=[],n=this.values;if("desc"===e.order)for(var i=n.length-1;i>=0;i--){var r=n[i];t=r.isIndex?t.concat(r.getAll(e)):t.concat(r)}else for(var o=0;o<n.length;o++){var a=n[o];t=a.isIndex?t.concat(a.getAll(e)):t.concat(a)}return t},visitAll:function visitAll(e,t){this.values.forEach(function(n){n.isIndex?n.visitAll(e,t):n.forEach(e,t)})},between:function between(e,t,n){n||(n={}),O.isArray(e)||(e=[e]),O.isArray(t)||(t=[t]),O.fillIn(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var i=this._between(e,t,n);return n.limit?i.slice(n.offset,n.limit+n.offset):i.slice(n.offset)},_between:function _between(e,t,n){var i=[],r=e.shift(),o=t.shift(),a=void 0;if(a=void 0!==r?binarySearch(this.keys,r):{found:!1,index:0},0===e.length){a.found&&n.leftInclusive===!1&&(a.index+=1);for(var s=a.index;s<this.keys.length;s+=1){if(void 0!==o)if(n.rightInclusive){if(this.keys[s]>o)break}else if(this.keys[s]>=o)break;if(i=this.values[s].isIndex?i.concat(this.values[s].getAll()):i.concat(this.values[s]),n.limit&&i.length>=n.limit+n.offset)break}}else for(var u=a.index;u<this.keys.length;u+=1){var c=this.keys[u];if(c>o)break;if(i=this.values[u].isIndex?c===r?i.concat(this.values[u]._between(O.copy(e),t.map(function(){}),n)):c===o?i.concat(this.values[u]._between(e.map(function(){}),O.copy(t),n)):i.concat(this.values[u].getAll()):i.concat(this.values[u]),n.limit&&i.length>=n.limit+n.offset)break}return n.limit?i.slice(0,n.limit+n.offset):i},peek:function peek(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},clear:function clear(){this.keys=[],this.values=[]},insertRecord:function insertRecord(e){var t=this.fieldList.map(function(t){return O.isFunction(t)?t(e)||void 0:e[t]||void 0});this.set(t,e)},removeRecord:function removeRecord(e){var t=this,n=void 0,i=void 0!==this.hashCode(e);return this.values.forEach(function(r,o){if(r.isIndex){if(r.removeRecord(e))return 0===r.keys.length&&(removeAt(t.keys,o),removeAt(t.values,o)),n=!0,!1}else{var a={};if(void 0!==t.keys[o]&&i)i&&(a=binarySearch(r,e,t.hashCode));else for(var s=r.length-1;s>=0;s--)if(r[s]===e){a={found:!0,index:s};break}if(a.found)return removeAt(r,a.index),0===r.length&&(removeAt(t.keys,o),removeAt(t.values,o)),n=!0,!1}}),n?e:void 0},updateRecord:function updateRecord(e){var t=this.removeRecord(e);void 0!==t&&this.insertRecord(e)}});var L="Collection",M={commitOnMerge:!0,idAttribute:"id",onConflict:"merge"},P=w.extend({constructor:Collection,_onRecordEvent:function _onRecordEvent(){this.emit.apply(this,arguments)},add:function add(e,t){var n=this;t||(t={}),O._(t,this),e=this.beforeAdd(e,t)||e;var i=!1,r=this.recordId();if(!O.isArray(e)){if(!O.isObject(e))throw O.err(L+"#add","records")(400,"object or array",e);e=[e],i=!0}e=e.map(function(e){var i=n.recordId(e),o=void 0===i?i:n.get(i);if(e===o)return o;if(o){var a=t.onConflict||n.onConflict;if("merge"===a)O.deepMixIn(o,e);else{if("replace"!==a)throw O.err(L+"#add","opts.onConflict")(400,"one of (merge, replace)",a,!0);O.forOwn(o,function(t,n){n!==r&&void 0===e[n]&&(o[n]=void 0)}),o.set(e)}e=o,t.commitOnMerge&&O.isFunction(e.commit)&&e.commit(),n.updateIndexes(e)}else e=n.mapper?n.mapper.createRecord(e,t):e,n.index.insertRecord(e),O.forOwn(n.indexes,function(t,n){t.insertRecord(e)}),e&&O.isFunction(e.on)&&e.on("all",n._onRecordEvent,n);return e});var o=i?e[0]:e;return this.emit("add",o),this.afterAdd(e,t,o)||o},afterAdd:function afterAdd(){},afterRemove:function afterRemove(){},afterRemoveAll:function afterRemoveAll(){},beforeAdd:function beforeAdd(){},beforeRemove:function beforeRemove(){},beforeRemoveAll:function beforeRemoveAll(){},between:function between(e,t,n){return this.query().between(e,t,n).run()},createIndex:function createIndex(e,t,n){var i=this;O.isString(e)&&void 0===t&&(t=[e]),n||(n={}),n.hashCode||(n.hashCode=function(e){return i.recordId(e)});var r=this.indexes[e]=new Index(t,n);this.index.visitAll(r.insertRecord,r)},filter:function filter(e,t){return this.query().filter(e,t).run()},forEach:function forEach(e,t){this.index.visitAll(e,t)},get:function get(e){var t=this.query().get(e).run();return t.length?t[0]:void 0},getAll:function getAll(){var e;return(e=this.query()).getAll.apply(e,arguments).run()},getIndex:function getIndex(e){var t=e?this.indexes[e]:this.index;if(!t)throw O.err(L+"#getIndex",e)(404,"index");return t},limit:function limit(e){return this.query().limit(e).run()},map:function map(e,t){var n=[];return this.index.visitAll(function(i){n.push(e.call(t,i))}),n},mapCall:function mapCall(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=[];return this.index.visitAll(function(t){r.push(t[e].apply(t,n))}),r},prune:function prune(e){return this.removeAll(this.unsaved(),e)},query:function query(){var e=this.queryClass;return new e(this)},recordId:function recordId(e){return e?O.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute},reduce:function reduce(e,t){var n=this.getAll();return n.reduce(e,t)},remove:function remove(e,t){t||(t={}),this.beforeRemove(e,t);var n=O.isSorN(e)?this.get(e):e;return O.isObject(n)&&(n=this.index.removeRecord(n),n&&(O.forOwn(this.indexes,function(e,t){e.removeRecord(n)}),O.isFunction(n.off)&&(n.off("all",this._onRecordEvent,this),t.silent||this.emit("remove",n)))),this.afterRemove(e,t,n)||n},removeAll:function removeAll(e,t){var n=this;t||(t={}),this.beforeRemoveAll(e,t);var i=O.isArray(e)?e.slice():this.filter(e),r=O.plainCopy(t);return r.silent=!0,i=i.map(function(e){return n.remove(e,r)}).filter(function(e){return e}),t.silent||this.emit("remove",i),this.afterRemoveAll(e,t,i)||i},skip:function skip(e){return this.query().skip(e).run()},toJSON:function toJSON(e){return this.mapCall("toJSON",e)},unsaved:function unsaved(e){return this.index.get()},updateIndex:function updateIndex(e,t){t||(t={}),this.getIndex(t.index).updateRecord(e)},updateIndexes:function updateIndexes(e){this.index.updateRecord(e),O.forOwn(this.indexes,function(t,n){t.updateRecord(e)})}}),K="belongsTo",N="hasMany",D="hasOne",T="Relation";Relation.extend=O.extend,O.addHiddenPropsToTarget(Relation.prototype,{get canAutoAddLinks(){return void 0===this.add||!!this.add},get relatedCollection(){return this.mapper.datastore.getCollection(this.relation)},validateOptions:function validateOptions(e,t){var n="new "+T,i=t.localField;if(!i)throw O.err(n,"opts.localField")(400,"string",i);var r=t.foreignKey=t.foreignKey||t.localKey;if(!r&&(t.type===K||t.type===D))throw O.err(n,"opts.foreignKey")(400,"string",r);if(O.isString(e)){if(t.relation=e,!O.isFunction(t.getRelation))throw O.err(n,"opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw O.err(n,"related")(400,"Mapper or string",e);t.relation=e.name}},assignTo:function assignTo(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)},canFindLinkFor:function canFindLinkFor(){return!(!this.foreignKey&&!this.localKey)},getRelation:function getRelation(){return this.relatedMapper},getForeignKey:function getForeignKey(e){return O.get(e,this.mapper.idAttribute)},setForeignKey:function setForeignKey(e,t){e&&t&&this._setForeignKey(e,t)},_setForeignKey:function _setForeignKey(e,t){var n=this,i=this.mapper.idAttribute;O.isArray(t)||(t=[t]),t.forEach(function(t){O.set(t,n.foreignKey,O.get(e,i))})},getLocalField:function getLocalField(e){return O.get(e,this.localField)},setLocalField:function setLocalField(e,t){return O.set(e,this.localField,t)},getInverse:function getInverse(e){return this.inverse||this.findInverseRelation(e),this.inverse},findInverseRelation:function findInverseRelation(e){var t=this;this.getRelation().relationList.forEach(function(n){if(n.getRelation()===e&&t.isInversedTo(n))return t.inverse=n,!0})},isInversedTo:function isInversedTo(e){return!e.foreignKey||e.foreignKey===this.foreignKey},addLinkedRecords:function addLinkedRecords(e){var t=this,n=this.mapper.datastore;e.forEach(function(e){var i=t.getLocalField(e);O.isFunction(t.add)?i=t.add(n,t,e):i&&(i=t.linkRecord(e,i));var r=!i||O.isArray(i)&&!i.length;r&&t.canFindLinkFor(e)&&(i=t.findExistingLinksFor(e)),i&&t.setLocalField(e,i)})},removeLinkedRecords:function removeLinkedRecords(e,t){var n=this.localField;t.forEach(function(e){O.set(e,n,void 0)})},linkRecord:function linkRecord(e,t){var n=O.get(t,this.mapper.idAttribute);if(void 0===n){var i=this.relatedCollection.unsaved();i.indexOf(t)===-1&&this.canAutoAddLinks&&(t=this.relatedCollection.add(t))}else t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t)));return t},findExistingLinksByForeignKey:function findExistingLinksByForeignKey(e){if(void 0!==e&&null!==e)return this.relatedCollection.filter(n({},this.foreignKey,e))}});var q=Relation.extend({getForeignKey:function getForeignKey(e){return O.get(e,this.foreignKey)},_setForeignKey:function _setForeignKey(e,t){O.set(e,this.foreignKey,O.get(t,this.getRelation().idAttribute))},findExistingLinksFor:function findExistingLinksFor(e){if(e){var t=O.get(e,this.foreignKey);return void 0!==t&&null!==t?this.relatedCollection.get(t):void 0}}},{TYPE_NAME:"belongsTo"}),J=Relation.extend({validateOptions:function validateOptions(e,t){Relation.prototype.validateOptions.call(this,e,t);var n=t.localKeys,i=t.foreignKeys,r=t.foreignKey;if(!r&&!n&&!i)throw O.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",r)},canFindLinkFor:function canFindLinkFor(e){var t=this.foreignKey||this.foreignKeys;return!!(t||this.localKeys&&O.get(e,this.localKeys))},linkRecord:function linkRecord(e,t){var n=this,i=this.relatedCollection,r=this.canAutoAddLinks,o=this.foreignKey,a=this.relatedCollection.unsaved();return t.map(function(t){var s=i.recordId(t);return(void 0===s&&a.indexOf(t)===-1||t!==i.get(s))&&(o&&n.setForeignKey(e,t),r&&(t=i.add(t))),t})},findExistingLinksFor:function findExistingLinksFor(e){var t=O.get(e,this.mapper.idAttribute),n=this.localKeys?O.get(e,this.localKeys):null,i=void 0;if(void 0!==t&&this.foreignKey?i=this.findExistingLinksByForeignKey(t):this.localKeys&&n?i=this.findExistingLinksByLocalKeys(n):void 0!==t&&this.foreignKeys&&(i=this.findExistingLinksByForeignKeys(t)),i&&i.length)return i},findExistingLinksByLocalKeys:function findExistingLinksByLocalKeys(e){return this.relatedCollection.filter({where:n({},this.mapper.idAttribute,{in:e})})},findExistingLinksByForeignKeys:function findExistingLinksByForeignKeys(e){return this.relatedCollection.filter({where:n({},this.foreignKeys,{contains:e})})}},{TYPE_NAME:"hasMany"}),Q=Relation.extend({findExistingLinksFor:function findExistingLinksFor(e,t){var n=O.get(t,e.idAttribute),i=this.findExistingLinksByForeignKey(n);if(i&&i.length)return i[0]}},{TYPE_NAME:"hasOne"});[q,J,Q].forEach(function(e){Relation[e.TYPE_NAME]=function(t,n){return new e(t,n)}});var B=function belongsTo(e,t){return function(n){Relation.belongsTo(e,t).assignTo(n)}},U=function hasMany(e,t){return function(n){Relation.hasMany(e,t).assignTo(n)}},$=function hasOne(e,t){return function(n){Relation.hasOne(e,t).assignTo(n)}},G="Record",V=function superMethod(e,t){var n=e.datastore;return n&&n[t]?function(){for(var i=arguments.length,r=Array(i),o=0;o<i;o++)r[o]=arguments[o];return n[t].apply(n,[e.name].concat(r))}:e[t].bind(e)},H=w.extend({constructor:Record,_mapper:function _mapper(){var e=this.constructor.mapper;if(!e)throw O.err(G+"#_mapper","")(404,"mapper");
return e},afterLoadRelations:function afterLoadRelations(){},beforeLoadRelations:function beforeLoadRelations(){},changeHistory:function changeHistory(){return(this._get("history")||[]).slice()},changes:function changes(e){return e||(e={}),O.diffObjects("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},commit:function commit(){this._set("changed"),this._set("history",[]),this._set("previous",O.plainCopy(this))},destroy:function destroy(e){e||(e={});var t=this._mapper();return V(t,"destroy")(O.get(this,t.idAttribute),e)},get:function get(e){return O.get(this,e)},hasChanges:function hasChanges(e){var t=!!(this._get("changed")||[]).length;return t||O.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},isNew:function isNew(e){return void 0===O.get(this,this._mapper().idAttribute)},isValid:function isValid(e){return!this._mapper().validate(this,e)},removeInverseRelation:function removeInverseRelation(e,t,n,i){var r=this;if(n.type===D)_(e,n.localField,void 0);else if(n.type===N){var o=O.get(e,n.localField);void 0===t?O.remove(o,function(e){return e===r}):O.remove(o,function(e){return e===r||t===O.get(e,i)})}},setupInverseRelation:function setupInverseRelation(e,t,n,i){var r=this;if(n.type===D)_(e,n.localField,this);else if(n.type===N){var o=O.get(e,n.localField);void 0===t?O.noDupeAdd(o,this,function(e){return e===r}):O.noDupeAdd(o,this,function(e){return e===r||t===O.get(e,i)})}},loadRelations:function loadRelations(e,t){var i=this,r=void 0,o=this._mapper();return e||(e=[]),O.isString(e)&&(e=[e]),t||(t={}),t.with=e,O._(t,o),t.adapter=o.getAdapterName(t),r=t.op="beforeLoadRelations",O.resolve(this[r](e,t)).then(function(){r=t.op="loadRelations",o.dbg(r,i,e,t);var a=[],s=void 0;return O.forEachRelation(o,t,function(e,r){var u=e.getRelation();if(r.raw=!1,O.isFunction(e.load))s=e.load(o,e,i,t);else if("hasMany"===e.type||"hasOne"===e.type)e.foreignKey?s=V(u,"findAll")(n({},e.foreignKey,O.get(i,o.idAttribute)),r).then(function(t){return"hasOne"===e.type?t.length?t[0]:void 0:t}):e.localKeys?s=V(u,"findAll")({where:n({},u.idAttribute,{in:O.get(i,e.localKeys)})}):e.foreignKeys&&(s=V(u,"findAll")({where:n({},e.foreignKeys,{contains:O.get(i,o.idAttribute)})},t));else if("belongsTo"===e.type){var c=O.get(i,e.foreignKey);O.isSorN(c)&&(s=V(u,"find")(c,r))}s&&(s=s.then(function(t){e.setLocalField(i,t)}),a.push(s))}),Promise.all(a)}).then(function(){return r=t.op="afterLoadRelations",O.resolve(i[r](e,t)).then(function(){return i})})},previous:function previous(e){return e?this._get("previous."+e):this._get("previous")},revert:function revert(e){var t=this,n=this._get("previous");e||(e={}),e.preserve||(e.preserve=[]),O.forOwn(this,function(i,r){r!==t._mapper().idAttribute&&!n.hasOwnProperty(r)&&t.hasOwnProperty(r)&&e.preserve.indexOf(r)===-1&&delete t[r]}),O.forOwn(n,function(n,i){e.preserve.indexOf(i)===-1&&(t[i]=n)}),this.commit()},save:function save(e){var t=this;e||(e={});var n=this._mapper(),i=O.get(this,n.idAttribute),r=this,o=function postProcess(n){var i=e.raw?n.data:n;return i&&(O.deepMixIn(t,i),t.commit()),n};if(void 0===i)return V(n,"create")(r,e).then(o);if(e.changesOnly){var a=this.changes(e);r={},O.fillIn(r,a.added),O.fillIn(r,a.changed)}return V(n,"update")(i,r,e).then(o)},set:function set(e,t,n){O.isObject(e)&&(n=t),n||(n={}),n.silent&&this._set("silent",!0),O.set(this,e,t),this._get("eventId")||this._set("silent")},toJSON:function toJSON(e){var n=this,i=this.constructor.mapper;if(i)return i.toJSON(this,e);var r=function(){var e={};return O.forOwn(n,function(t,n){e[n]=O.plainCopy(t)}),{v:e}}();return"object"===("undefined"==typeof r?"undefined":t(r))?r.v:void 0},unset:function unset(e,t){this.set(e,void 0,t)},validate:function validate(e){return this._mapper().validate(this,e)}});O.eventify(Record.prototype,function(){return this._get("events")},function(e){this._set("events",e)});var W="Schema",Y={array:O.isArray,boolean:O.isBoolean,integer:O.isInteger,null:O.isNull,number:O.isNumber,object:O.isObject,string:O.isString},z=function segmentToString(e,t){var n="";return e&&(n+=O.isNumber(e)?"["+e+"]":t?"."+e:""+e),n},X=function makePath(e){e||(e={});var t="",n=e.path||[];return n.forEach(function(e){t+=z(e,t)}),t+=z(e.prop,t)},Z=function makeError(e,t,n){return{expected:t,actual:""+e,path:X(n)}},ee=function addError(e,t,n,i){i.push(Z(e,t,n))},te=function maxLengthCommon(e,t,n,i){var r=n[e];if(t.length>r)return Z(t.length,"length no more than "+r,i)},ne=function minLengthCommon(e,t,n,i){var r=n[e];if(t.length<r)return Z(t.length,"length no less than "+r,i)},ie={allOf:function allOf(e,t,n){var i=[];return t.allOf.forEach(function(t){i=i.concat(de(e,t,n)||[])}),i.length?void 0:i},anyOf:function anyOf(e,t,n){var i=!1,r=[];return t.anyOf.forEach(function(t){var o=de(e,t,n);o?r=r.concat(o):i=!0}),i?void 0:r},dependencies:function dependencies(e,t,n){},enum:function _enum(e,t,n){var i=t.enum;if(O.findIndex(i,function(t){return O.deepEqual(t,e)})===-1)return Z(e,"one of ("+i.join(", ")+")",n)},items:function items(e,t,n){n||(n={});for(var items=t.items,i=[],r=O.isArray(items),o=e.length,a=0;a<o;a++)r&&(items=t.items[a]),n.prop=a,i=i.concat(de(e[a],items,n)||[]);return i.length?i:void 0},maximum:function maximum(e,n,i){var maximum=n.maximum,r=n.exclusiveMaximum;if(("undefined"==typeof e?"undefined":t(e))===("undefined"==typeof maximum?"undefined":t(maximum))&&!(r?maximum>e:maximum>=e))return r?Z(e,"no more than nor equal to "+maximum,i):Z(e,"no more than "+maximum,i)},maxItems:function maxItems(e,t,n){if(O.isArray(e))return te("maxItems",e,t,n)},maxLength:function maxLength(e,t,n){return te("maxLength",e,t,n)},maxProperties:function maxProperties(e,t,n){if(O.isObject(e)){var maxProperties=t.maxProperties,i=Object.keys(e).length;return i>maxProperties?Z(i,"no more than "+maxProperties+" properties",n):void 0}},minimum:function minimum(e,n,i){var minimum=n.minimum,r=n.exclusiveMinimum;if(("undefined"==typeof e?"undefined":t(e))===("undefined"==typeof minimum?"undefined":t(minimum))&&!(r?e>minimum:e>=minimum))return r?Z(e,"no less than nor equal to "+minimum,i):Z(e,"no less than "+minimum,i)},minItems:function minItems(e,t,n){if(O.isArray(e))return ne("minItems",e,t,n)},minLength:function minLength(e,t,n){return ne("minLength",e,t,n)},minProperties:function minProperties(e,t,n){if(O.isObject(e)){var minProperties=t.minProperties,i=Object.keys(e).length;return i<minProperties?Z(i,"no more than "+minProperties+" properties",n):void 0}},multipleOf:function multipleOf(e,t,n){var multipleOf=t.multipleOf;if(O.isNumber(e)&&e/multipleOf%1!==0)return Z(e,"multipleOf "+multipleOf,n)},not:function not(e,t,n){if(!de(e,t.not,n))return Z("succeeded","should have failed",n)},oneOf:function oneOf(e,t,n){var i=!1,r=[];return t.oneOf.forEach(function(t){var o=de(e,t,n);if(o)r=r.concat(o);else{if(i)return r=[Z("valid against more than one","valid against only one",n)],i=!1,!1;i=!0}}),i?void 0:r},pattern:function pattern(e,t,n){var pattern=t.pattern;if(O.isString(e)&&!e.match(pattern))return Z(e,pattern,n)},properties:function properties(e,t,n){n||(n={});var i=void 0===t.additionalProperties||t.additionalProperties,r={},properties=t.properties||{},o=t.patternProperties||{},a=[];O.forOwn(e,function(e,t){r[t]=void 0}),O.forOwn(properties||{},function(t,i){n.prop=i,a=a.concat(de(e[i],t,n)||[]),delete r[i]}),O.forOwn(o,function(t,i){O.forOwn(r,function(o,s){s.match(i)&&(n.prop=s,a=a.concat(de(e[s],t,n)||[]),delete r[s])})});var s=Object.keys(r);return i===!1?s.length&&ee("extra fields: "+s.join(", "),"no extra fields",n,a):O.isObject(i)&&s.forEach(function(t){n.prop=t,a=a.concat(de(e[t],i,n)||[])}),a.length?a:void 0},required:function required(e,t,n){n||(n={});var required=t.required,i=[];return n.existingOnly||required.forEach(function(t){if(void 0===O.get(e,t)){var r=n.prop;n.prop=t,ee(void 0,"a value",n,i),n.prop=r}}),i.length?i:void 0},type:function type(e,n,i){var type=n.type,r=void 0;if(O.isString(type)&&(type=[type]),type.forEach(function(t){if(Y[t](e,n,i))return r=t,!1}),!r)return Z(void 0!==e&&null!==e?"undefined"==typeof e?"undefined":t(e):""+e,"one of ("+type.join(", ")+")",i);var o=xe[r];return o?o(e,n,i):void 0},uniqueItems:function uniqueItems(e,t,n){if(e&&e.length&&t.uniqueItems){var i=e.length,r=void 0,o=void 0,a=void 0;for(o=i-1;o>0;o--)for(r=e[o],a=o-1;a>=0;a--)if(O.deepEqual(r,e[a]))return Z(r,"no duplicates",n)}}},re=function validateKeyword(e,t,n,i){return void 0!==n[e]&&ie[e](t,n,i)},oe=function runOps(e,t,n,i){var r=[];return e.forEach(function(e){r=r.concat(re(e,t,n,i)||[])}),r.length?r:void 0},ae=["enum","type","allOf","anyOf","oneOf","not"],se=["items","maxItems","minItems","uniqueItems"],ue=["multipleOf","maximum","minimum"],ce=["maxProperties","minProperties","required","properties","dependencies"],le=["maxLength","minLength","pattern"],fe=function validateAny(e,t,n){return oe(ae,e,t,n)},de=function _validate(e,t,n){var i=[];n||(n={}),n.ctx||(n.ctx={value:e,schema:t});var r=void 0,o=n.prop;if(void 0!==t){if(!O.isObject(t))throw O.err(W+"#validate")(500,'Invalid schema at path: "'+n.path+'"');return void 0===n.path&&(n.path=[]),void 0!==n.prop&&(r=!0,n.path.push(n.prop),n.prop=void 0),t.extends&&(i=O.isFunction(t.extends.validate)?i.concat(t.extends.validate(e,n)||[]):i.concat(_validate(e,t.extends,n)||[])),void 0===e?(t.required!==!0||n.existingOnly||ee(e,"a value",n,i),r&&(n.path.pop(),n.prop=o),i.length?i:void 0):(i=i.concat(fe(e,t,n)||[]),r&&(n.path.pop(),n.prop=o),i.length?i:void 0)}},he="changing",pe="changed",ve="history",ge="creating",ye="eventId",me="noValidate",be="silent",Ae="validation failed",Oe=function makeDescriptor(e,t,n){var i={configurable:!0,enumerable:void 0===t.enumerable||!!t.enumerable},r="props."+e,o="previous."+e,a=n.getter,s=n.setter,u=n.unsetter,c=O.isBoolean(n.track)?n.track:t.track;return i.get=function(){return this._get(r)},O.isFunction(t.get)&&!function(){var e=i.get;i.get=function(){return t.get.call(this,e)}}(),i.set=function(n){var i=this,l=this[a],f=this[s],d=this[u];if(!l(me)){var h=t.validate(n,{path:[e]});if(h){var p=new Error(Ae);throw p.errors=h,p}}return c&&!l(ge)&&!function(){var t=l(o),a=l(r),s=l(he),u=l(pe);s||(u=[]);var c=u.indexOf(e);a!==n&&c===-1&&u.push(e),t===n&&c>=0&&u.splice(c,1),u.length||(s=!1,d(he),d(pe),l(ye)&&(clearTimeout(l(ye)),d(ye))),!s&&u.length&&(f(pe,u),f(he,!0),f(ye,setTimeout(function(){if(d(pe),d(ye),d(he),!l(be)){var e=void 0;for(e=0;e<u.length;e++)i.emit("change:"+u[e],i,O.get(i,u[e]));var t=i.changes(),n=O.plainCopy(t);n.timestamp=(new Date).getTime();var r=l(ve)||[];f(ve,r),r.push(n),i.emit("change",i,t)}d(be)},0)))}(),f(r,n),n},O.isFunction(t.set)&&!function(){var e=i.set;i.set=function(n){return t.set.call(this,n,e)}}(),i},xe={array:function array(e,t,n){return oe(se,e,t,n)},integer:function integer(e,t,n){return xe.numeric(e,t,n)},number:function number(e,t,n){return xe.numeric(e,t,n)},numeric:function numeric(e,t,n){return oe(ue,e,t,n)},object:function object(e,t,n){return oe(ce,e,t,n)},string:function string(e,t,n){return oe(le,e,t,n)}},_e=w.extend({constructor:Schema,apply:function apply(e,t){t||(t={}),t.getter||(t.getter="_get"),t.setter||(t.setter="_set"),t.unsetter||(t.unsetter="_unset"),t.track||(t.track=this.track);var n=this.properties||{};O.forOwn(n,function(n,i){Object.defineProperty(e,i,Oe(i,n,t))})},applyDefaults:function applyDefaults(e){if(e){var t=this.properties||{},n=O.isFunction(e.set)||O.isFunction(e._set);O.forOwn(t,function(t,i){if(t.hasOwnProperty("default")&&void 0===O.get(e,i)&&(n?e.set(i,O.plainCopy(t.default),{silent:!0}):O.set(e,i,O.plainCopy(t.default))),"object"===t.type&&t.properties){if(n){var r=e._get("noValidate");e._set("noValidate",!0),O.set(e,i,O.get(e,i)||{},{silent:!0}),e._set("noValidate",r)}else O.set(e,i,O.get(e,i)||{});t.applyDefaults(O.get(e,i))}})}},validate:function validate(e,t){return de(e,this,t)}},{ANY_OPS:ae,ARRAY_OPS:se,NUMERIC_OPS:ue,OBJECT_OPS:ce,STRING_OPS:le,typeGroupValidators:xe,types:Y,validate:de,validationKeywords:ie}),we="Mapper",Ce=["beforeCreate","beforeCreateMany"],Fe=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"],Re=function makeNotify(e){return function(){for(var t=this,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];var o=i[i.length-e],a=o.op;if(this.dbg.apply(this,[a].concat(i)),Ce.indexOf(a)!==-1&&o.applyDefaults!==!1&&!function(){var e=t.getSchema();if(e&&e.applyDefaults){var n=i[0];O.isArray(n)||(n=[n]),n.forEach(function(t){e.applyDefaults(t)})}}(),Fe.indexOf(a)!==-1&&!o.noValidate){var s=o.existingOnly;0===a.indexOf("beforeUpdate")&&void 0===o.existingOnly&&(o.existingOnly=!0);var u=this.validate(i["beforeUpdate"===a?1:0],O.pick(o,["existingOnly"]));if(o.existingOnly=s,u)return O.reject(u)}(o.notify||void 0===o.notify&&this.notify)&&setTimeout(function(){t.emit.apply(t,[a].concat(i))})}},Ee=Re(1),ke=Re(2),Ie={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function adapterArgs(e,t,n,i){return[t,e.toJSON(n,i),i]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function adapterArgs(e,t,n,i){return[e.toJSON(t,i),n,i]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function adapterArgs(e,t,n){return[t.map(function(t){return e.toJSON(t,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},je={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",notify:!0,noValidate:!1,raw:!1},Se=w.extend({constructor:Mapper,afterCount:ke,afterCreate:ke,afterCreateMany:ke,afterDestroy:ke,afterDestroyAll:ke,afterFind:ke,afterFindAll:ke,afterSum:ke,afterUpdate:ke,afterUpdateAll:ke,afterUpdateMany:ke,beforeCreate:Ee,beforeCreateMany:Ee,beforeCount:Ee,beforeDestroy:Ee,beforeDestroyAll:Ee,beforeFind:Ee,beforeFindAll:Ee,beforeSum:Ee,beforeUpdate:Ee,beforeUpdateAll:Ee,beforeUpdateMany:Ee,_end:function _end(e,t,n){if(t.raw&&O._(e,t),n)return e;var i=t.raw?e.data:e;return i&&O.isFunction(this.wrap)&&(i=this.wrap(i,t),t.raw?e.data=i:e=i),e},belongsTo:function belongsTo$$(e,t){return B(e,t)(this)},count:function count(e,t){return this.crud("count",e,t)},create:function create(e,t){var n=this,i=void 0,r=void 0;e||(e={}),t||(t={});var o=e;return O._(t,this),r=t.adapter=this.getAdapterName(t),i=t.op="beforeCreate",O.resolve(this[i](e,t)).then(function(a){e=void 0===a?e:a;var s={};t.with||(t.with=[]);var u=[];return O.forEachRelation(n,t,function(t,n){var i=t.getLocalField(e),r=t.getRelation(),o=r.idAttribute;n.raw=!1,i&&(t.type===K?u.push(r.create(i,n).then(function(n){t.setLocalField(s,n),t.setForeignKey(e,n)})):t.type===N&&t.localKeys&&u.push(r.createMany(i,n).then(function(n){t.setLocalField(s,n),O.set(e,t.localKeys,n.map(function(e){return O.get(e,o)}))})))}),O.Promise.all(u).then(function(){return i=t.op="create",n.dbg(i,e,t),O.resolve(n.getAdapter(r)[i](n,n.toJSON(e,{with:t.pass||[]}),t))}).then(function(i){var r=t.raw?i.data:i;return u=[],O.forEachRelation(n,t,function(t,n){var i=t.getLocalField(e);if(i){n.raw=!1;var o=void 0;t.type===N&&t.foreignKey?(t.setForeignKey(r,i),o=t.getRelation().createMany(i,n).then(function(e){t.setLocalField(r,e)})):t.type===D?(t.setForeignKey(r,i),o=t.getRelation().create(i,n).then(function(e){t.setLocalField(r,e)})):t.type===K&&t.getLocalField(s)?t.setLocalField(r,t.getLocalField(s)):t.type===N&&t.localKeys&&t.getLocalField(s)&&t.setLocalField(r,t.getLocalField(s)),o&&u.push(o)}}),O.Promise.all(u).then(function(){return O.set(o,r,{silent:!0}),O.isFunction(o.commit)&&o.commit(),t.raw?i.data=o:i=o,i})})}).then(function(r){return r=n._end(r,t),i=t.op="afterCreate",O.resolve(n[i](e,t,r)).then(function(e){return void 0===e?r:e})})},createInstance:function createInstance(e,t){return this.createRecord(e,t)},createMany:function createMany(e,t){var n=this,i=void 0,r=void 0;e||(e=[]),t||(t={});var o=e;return O._(t,this),r=t.adapter=this.getAdapterName(t),i=t.op="beforeCreateMany",O.resolve(this[i](e,t)).then(function(a){e=void 0===a?e:a;var s={};t.with||(t.with=[]);var u=[];return O.forEachRelation(n,t,function(t,n){var i=e.map(function(e){return t.getLocalField(e)}).filter(function(e){return e});t.type===K&&i.length===e.length&&u.push(t.getRelation().createMany(i,n).then(function(i){var r=n.raw?i.data:i;t.setLocalField(s,r),e.forEach(function(e,n){t.setForeignKey(e,r[n])})}))}),O.Promise.all(u).then(function(){i=t.op="createMany";var o=e.map(function(e){return n.toJSON(e,{with:t.pass||[]})});return n.dbg(i,e,t),O.resolve(n.getAdapter(r)[i](n,o,t))}).then(function(i){var r=t.raw?i.data:i;return u=[],O.forEachRelation(n,t,function(i,o){var a=e.map(function(e){return i.getLocalField(e)}).filter(function(e){return e});if(a.length===e.length){var c=i.getLocalField(s),l=void 0;i.type===N?n.log("warn","deep createMany of hasMany type not supported!"):i.type===D?(r.forEach(function(e,t){i.setForeignKey(e,a[t])}),l=i.getRelation().createMany(a,o).then(function(e){var n=t.raw?e.data:e;r.forEach(function(e,t){i.setLocalField(e,n[t])})})):i.type===K&&c&&c.length===r.length&&r.forEach(function(e,t){i.setLocalField(e,c[t])}),l&&u.push(l)}}),O.Promise.all(u).then(function(){return r.forEach(function(e,t){var n=o[t];O.set(n,e,{silent:!0}),O.isFunction(n.commit)&&n.commit()}),t.raw?i.data=o:i=o,i})})}).then(function(r){return r=n._end(r,t),i=t.op="afterCreateMany",O.resolve(n[i](e,t,r)).then(function(e){return void 0===e?r:e})})},createRecord:function createRecord(e,t){var n=this;if(e||(e={}),O.isArray(e))return e.map(function(e){return n.createRecord(e,t)});if(!O.isObject(e))throw O.err(we+"#createRecord","props")(400,"array or object",e);var i=this.recordClass,r=this.relationList||[];return r.forEach(function(n){var i=n.getRelation(),r=n.getLocalField(e);if(r&&!i.is(r)){if(O.isArray(r)&&(!r.length||i.is(r[0])))return;O.set(e,n.localField,i.createRecord(r,t))}}),!i||e instanceof i?e:new i(e,t)},crud:function crud(e){for(var t=this,n=arguments.length,r=Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];var a=this.lifecycleMethods[e];if(!a)throw O.err(we+"#crud",e)(404,"method");var s=""+e.charAt(0).toUpperCase()+e.substr(1),u="before"+s,c="after"+s,l=void 0,f=void 0;a.defaults.forEach(function(e,t){void 0===r[t]&&(r[t]=O.copy(e))});var d=r[r.length-1];return O._(d,this),f=d.adapter=this.getAdapterName(d),l=d.op=u,O.resolve(this[l].apply(this,i(r))).then(function(n){var o;return void 0!==r[a.beforeAssign]&&(r[a.beforeAssign]=void 0===n?r[a.beforeAssign]:n),l=d.op=e,r=a.adapterArgs?a.adapterArgs.apply(a,[t].concat(i(r))):r,t.dbg.apply(t,[l].concat(i(r))),O.resolve((o=t.getAdapter(f))[l].apply(o,[t].concat(i(r))))}).then(function(e){return e=t._end(e,d,!!a.skip),r.push(e),l=d.op=c,O.resolve(t[l].apply(t,i(r))).then(function(t){return void 0===t?e:t})})},destroy:function destroy(e,t){return this.crud("destroy",e,t)},destroyAll:function destroyAll(e,t){return this.crud("destroyAll",e,t)},find:function find(e,t){return this.crud("find",e,t)},findAll:function findAll(e,t){return this.crud("findAll",e,t)},getAdapter:function getAdapter(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw O.err(we+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e||(e={}),O.isString(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getSchema:function getSchema(){return this.schema},hasMany:function hasMany$$(e,t){return U(e,t)(this)},hasOne:function hasOne$$(e,t){return $(e,t)(this)},is:function is(e){var t=this.recordClass;return!!t&&e instanceof t},registerAdapter:function registerAdapter(e,t,n){n||(n={}),this.getAdapters()[e]=t,(n===!0||n.default)&&(this.defaultAdapter=e)},sum:function sum(e,t,n){return this.crud("sum",e,t,n)},toJSON:function toJSON(e,t){var n=this,i=void 0;if(t||(t={}),O.isArray(e))return e.map(function(e){return n.toJSON(e,t)});i=e;var r=(this?this.relationFields:[])||[],o={},a=void 0;if(this&&this.schema&&(a=this.schema.properties||{},O.forOwn(a,function(e,t){o[t]=O.plainCopy(i[t])})),a||(a={}),!t.strict)for(var s in i)a[s]||r.indexOf(s)!==-1||(o[s]=O.plainCopy(i[s]));return this&&t.withAll&&(t.with=r.slice()),this&&t.with&&(O.isString(t.with)&&(t.with=[t.with]),O.forEachRelation(this,t,function(e,t){var n=e.getLocalField(i);n&&(O.isArray(n)?e.setLocalField(o,n.map(function(n){return e.getRelation().toJSON(n,t)})):e.setLocalField(o,e.getRelation().toJSON(n,t)))})),o},update:function update(e,t,n){return this.crud("update",e,t,n)},updateAll:function updateAll(e,t,n){return this.crud("updateAll",e,t,n)},updateMany:function updateMany(e,t){return this.crud("updateMany",e,t)},validate:function validate(e,t){t||(t={});var n=this.getSchema(),i=O.pick(t,["existingOnly"]);if(!O.isArray(e))return n.validate(e,i);var r=e.map(function(e){return n.validate(e,O.pick(i,["existingOnly"]))}),o=!1;return r.forEach(function(e){e&&(o=!0)}),o?r:void 0},wrap:function wrap(e,t){return this.createRecord(e,t)},defineRelations:function defineRelations(){var e=this;O.forOwn(this.relations,function(t,n){O.forOwn(t,function(t,i){O.isObject(t)&&(t=[t]),t.forEach(function(t){var r=e.datastore.getMapperByName(i)||i;if(t.getRelation=function(){return e.datastore.getMapper(i)},"function"!=typeof Relation[n])throw O.err(we,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",n,!0);e[n](r,t)})})})}}),Le="Container",Me=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"],Pe={constructor:Container,_onMapperEvent:function _onMapperEvent(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n.shift();this.emit.apply(this,[r,e].concat(n))},as:function as(e){var t={},n=this;return Me.forEach(function(i){t[i]={writable:!0,value:function value(){for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];return n[i].apply(n,[e].concat(r))}}}),t.getMapper={writable:!0,value:function value(){return n.getMapper(e)}},Object.create(this,t)},defineMapper:function defineMapper(e,t){var n=this;if(O.isObject(e)&&(t=e,e=t.name),!O.isString(e))throw O.err(Le+"#defineMapper","name")(400,"string",e);t||(t={}),t.name=e,t.relations||(t.relations={});var i=t.mapperClass||this.mapperClass;delete t.mapperClass,O.fillIn(t,this.mapperDefaults);var r=this._mappers[e]=new i(t);return r.relations||(r.relations={}),r.name=e,r._adapters=this.getAdapters(),r.datastore=this,r.on("all",function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return n._onMapperEvent.apply(n,[e].concat(i))}),r.defineRelations(),r},defineResource:function defineResource(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)},getAdapter:function getAdapter(e){var t=this.getAdapterName(e);if(!t)throw O.err(Le+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e||(e={}),O.isString(e)&&(e={adapter:e}),e.adapter||this.mapperDefaults.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getMapper:function getMapper(e){var t=this.getMapperByName(e);if(!t)throw O.err(Le+"#getMapper",e)(404,"mapper");return t},getMapperByName:function getMapperByName(e){return this._mappers[e]},registerAdapter:function registerAdapter(e,t,n){n||(n={}),this.getAdapters()[e]=t,(n===!0||n.default)&&(this.mapperDefaults.defaultAdapter=e,O.forOwn(this._mappers,function(t){t.defaultAdapter=e}))}};Me.forEach(function(e){Pe[e]=function(t){for(var n,i=arguments.length,r=Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return(n=this.getMapper(t))[e].apply(n,r)}}),w.extend(Pe);var Ke="LinkedCollection",Ne=P.extend({constructor:LinkedCollection,_addMeta:function _addMeta(e,t){this._added[this.recordId(e)]=t,O.isFunction(e._set)&&e._set("$",t)},_clearMeta:function _clearMeta(e){delete this._added[this.recordId(e)],O.isFunction(e._set)&&e._set("$")},_onRecordEvent:function _onRecordEvent(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];P.prototype._onRecordEvent.apply(this,t);var i=t[0];O.isString(i)&&0===i.indexOf("change")&&this.updateIndexes(t[1])},add:function add(e,t){var n=this,i=this.mapper,r=(new Date).getTime(),o=O.isObject(e)&&!O.isArray(e);return o&&(e=[e]),e=P.prototype.add.call(this,e,t),i.relationList.length&&e.length&&i.relationList.forEach(function(t){t.addLinkedRecords(e)}),e.forEach(function(e){return n._addMeta(e,r)}),o?e[0]:e},remove:function remove(e,t){var n=this.mapper,i=P.prototype.remove.call(this,e,t);return i&&this._clearMeta(i),n.relationList.length&&i&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,[i])}),i},removeAll:function removeAll(e,t){var n=this.mapper,i=P.prototype.removeAll.call(this,e,t);return i.forEach(this._clearMeta,this),n.relationList.length&&i.length&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,i)}),i}}),De="DataStore",Te=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],qe=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],Je=function cachedFn(e,t,n){var i=this._completedQueries[e][t];return O.isFunction(i)?i(e,t,n):i},Qe={unlinkOnDestroy:!0,usePendingFind:!0,usePendingFindAll:!0},Be={constructor:DataStore,_end:function _end(e,t,n){var i=n.raw?t.data:t;return i&&O.isFunction(this.addToCache)&&(i=this.addToCache(e,i,n),n.raw?t.data=i:t=i),t},_onCollectionEvent:function _onCollectionEvent(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n.shift();this.emit.apply(this,[r,e].concat(n))},addToCache:function addToCache(e,t,n){return this.getCollection(e).add(t,n)},as:function as(e){var t={},n=this,i=qe.concat(Me).concat(Te);return i.forEach(function(i){t[i]={writable:!0,value:function value(){for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];return n[i].apply(n,[e].concat(r))}}}),t.getMapper={writable:!0,value:function value(){return n.getMapper(e)}},t.getCollection={writable:!0,value:function value(){return n.getCollection(e)}},Object.create(this,t)},cachedFind:Je,cachedFindAll:Je,cacheFind:function cacheFind(e,t,n,i){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.get(e,t)}},cacheFindAll:function cacheFindAll(e,t,n,i){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.filter(e,O.fromJson(t))}},clear:function clear(){var e=this,t={};return O.forOwn(this._collections,function(n,i){t[i]=n.removeAll(),e._completedQueries[i]={}}),t},create:function create(e,t,n){var i=this;return n||(n={}),Container.prototype.create.call(this,e,t,n).then(function(t){return i._end(e,t,n)})},createMany:function createMany(e,t,n){var i=this;return n||(n={}),Container.prototype.createMany.call(this,e,t,n).then(function(t){return i._end(e,t,n)})},defineMapper:function defineMapper(e,t){var n=this,i=Container.prototype.defineMapper.call(n,e,t);n._pendingQueries[e]={},n._completedQueries[e]={},i.relationList||Object.defineProperty(i,"relationList",{value:[]});var r=n._collections[e]=new n.collectionClass(null,{_added:{},datastore:n,mapper:i}),o=i.schema||{},a=o.properties||{};O.forOwn(a,function(e,t){e.indexed&&r.createIndex(t)}),r.createIndex("addedTimestamps",["$"],{fieldGetter:function fieldGetter(e){return r._added[r.recordId(e)]}}),r.on("all",function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];n._onCollectionEvent.apply(n,[e].concat(i))});var s=i.idAttribute;return i.relationList.forEach(function(e){var t=e.relation,o=e.localField,a="links."+o,u=e.foreignKey,c=e.type,l={index:u},f=void 0,d=function getter(){return this._get(a)};c===K?!function(){r.indexes[u]||r.createIndex(u),f={get:d,set:function set(c){var f=this._get(a);if(c===f)return f;var d=O.get(this,s),h=e.getInverse(i);if(f&&h&&this.removeInverseRelation(f,d,h,s),c){var p=e.getRelation().idAttribute,v=O.get(c,p);void 0!==v&&this._get("$")&&(c=n.get(t,v)||c),_(this,o,c),x(this,u,v),r.updateIndex(this,l),h&&this.setupInverseRelation(c,d,h,s)}else _(this,o,void 0);return c}};var c=Object.getOwnPropertyDescriptor(i.recordClass.prototype,u);c||(c={enumerable:!0});var h=c.get;c.get=function(){return h?h.call(this):this._get("props."+u)};var p=c.set;c.set=function(a){var c=this;p&&p.call(this,a);var f=O.get(this,o),d=O.get(this,s),h=e.getInverse(i),v=f?O.get(f,e.getRelation().idAttribute):void 0;if(f&&void 0!==v&&v!==a)if(h.type===D)_(f,h.localField,void 0);else if(h.type===N){var g=O.get(f,h.localField);void 0===d?O.remove(g,function(e){return e===c}):O.remove(g,function(e){return e===c||d===O.get(e,s)})}if(x(this,u,a),r.updateIndex(this,l),void 0===a||null===a)void 0!==v&&O.set(this,o,void 0);else if(this._get("$")){var y=n.get(t,a);y&&O.set(this,o,y)}},Object.defineProperty(i.recordClass.prototype,u,c)}():c===N?!function(){var r=e.localKeys,c=e.foreignKeys;n._collections[t]&&u&&!n.getCollection(t).indexes[u]&&n.getCollection(t).createIndex(u),f={get:function get(){var e=d.call(this);return e||this._set(a,[]),d.call(this)},set:function set(f){var d=this;f&&!O.isArray(f)&&(f=[f]);var h=O.get(this,s),p=e.getRelation().idAttribute,v=e.getInverse(i),g=v.localField,y=this._get(a)||[],m=[],b={};if(f&&f.forEach(function(e){var i=O.get(e,p),r=O.get(e,g);if(r&&r!==d){var a=O.get(r,o);void 0===i?O.remove(a,function(t){return t===e}):O.remove(a,function(t){return t===e||i===O.get(t,p)})}void 0!==i&&(d._get("$")&&(e=n.get(t,i)||e),b[i]=e),m.push(e)}),u)y.forEach(function(e){var i=O.get(e,p);(void 0===i&&m.indexOf(e)===-1||void 0!==i&&!(i in b))&&(f&&(x(e,u,void 0),n.getCollection(t).updateIndex(e,l)),_(e,g,void 0))}),m.forEach(function(e){x(e,u,h),n.getCollection(t).updateIndex(e,l),_(e,g,d)});else if(r){var A=m.map(function(e){return O.get(e,p)}).filter(function(e){return void 0!==e});O.set(this,r,A),v.foreignKeys&&(y.forEach(function(e){var t=O.get(e,p);if(void 0===t&&m.indexOf(e)===-1||void 0!==t&&!(t in b)){var n=O.get(e,g)||[];void 0===h?O.remove(n,function(e){return e===d}):O.remove(n,function(e){return e===d||h===O.get(e,s)})}}),m.forEach(function(e){var t=O.get(e,g);void 0===h?O.noDupeAdd(t,d,function(e){return e===d}):O.noDupeAdd(t,d,function(e){return e===d||h===O.get(e,s)})}))}else c&&(y.forEach(function(e){var t=O.get(e,c)||[];O.remove(t,function(e){return h===e});var n=O.get(e,g);void 0===h?O.remove(n,function(e){return e===d}):O.remove(n,function(e){return e===d||h===O.get(e,s)})}),m.forEach(function(e){var t=O.get(e,c)||[];O.noDupeAdd(t,h,function(e){return h===e});var n=O.get(e,g);void 0===h?O.noDupeAdd(n,d,function(e){return e===d}):O.noDupeAdd(n,d,function(e){return e===d||h===O.get(e,s)})}));return this._set(a,m),m}}}():c===D&&(n._collections[t]&&u&&!n.getCollection(t).indexes[u]&&n.getCollection(t).createIndex(u),f={get:d,set:function set(r){var c=this._get(a);if(r===c)return c;var f=e.getInverse(i).localField;if(c&&(x(c,u,void 0),n.getCollection(t).updateIndex(c,l),_(c,f,void 0)),r){var d=O.get(r,e.getRelation().idAttribute);void 0!==d&&(r=n.get(t,d)||r),_(this,o,r),x(r,u,O.get(this,s)),n.getCollection(t).updateIndex(r,l),_(r,f,this)}else _(this,o,void 0);return r}}),f&&(f.enumerable=void 0!==e.enumerable&&e.enumerable,e.get&&!function(){var t=f.get;f.get=function(){var n=this;return e.get(e,this,function(){for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];return t.apply(n,i)})}}(),e.set&&!function(){var t=f.set;f.set=function(n){var i=this;return e.set(e,this,n,function(e){return t.call(i,void 0===e?n:e)})}}(),Object.defineProperty(i.recordClass.prototype,o,f))}),i},destroy:function destroy(e,t,n){var i=this;return n||(n={}),Container.prototype.destroy.call(this,e,t,n).then(function(r){var o=i.getCollection(e).remove(t,n);if(o&&i.unlinkOnDestroy){var a=O.plainCopy(n);a.withAll=!0,O.forEachRelation(i.getMapper(e),a,function(e){
O.set(o,e.localField,void 0)})}return n.raw?r.data=o:r=o,delete i._pendingQueries[e][t],delete i._completedQueries[e][t],r})},destroyAll:function destroyAll(e,t,n){var i=this;return n||(n={}),Container.prototype.destroyAll.call(this,e,t,n).then(function(r){var o=i.getCollection(e).removeAll(t,n);if(o&&o.length&&i.unlinkOnDestroy){var a=O.plainCopy(n);a.withAll=!0,O.forEachRelation(i.getMapper(e),a,function(e){o.forEach(function(t){O.set(t,e.localField,void 0)})})}n.raw?r.data=o:r=o;var s=i.hashQuery(e,t,n);return delete i._pendingQueries[e][s],delete i._completedQueries[e][s],r})},eject:function eject(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)},ejectAll:function ejectAll(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)},find:function find(e,t,n){var i=this;n||(n={});var r=this.getMapper(e),o=this._pendingQueries[e][t],a=void 0===n.usePendingFind?this.usePendingFind:n.usePendingFind;if(O._(n,r),o&&(O.isFunction(a)?a.call(this,e,t,n):a))return o;var s=this.cachedFind(e,t,n),u=void 0;return u=n.force||!s?this._pendingQueries[e][t]=Container.prototype.find.call(this,e,t,n).then(function(r){return delete i._pendingQueries[e][t],r=i._end(e,r,n),i.cacheFind(e,r,t,n),r},function(n){return delete i._pendingQueries[e][t],O.reject(n)}):O.resolve(s)},findAll:function findAll(e,t,n){var i=this;n||(n={});var r=this.getMapper(e),o=this.hashQuery(e,t,n),a=this._pendingQueries[e][o],s=void 0===n.usePendingFindAll?this.usePendingFindAll:n.usePendingFindAll;if(O._(n,r),a&&(O.isFunction(s)?s.call(this,e,t,n):s))return a;var u=this.cachedFindAll(e,o,n),c=void 0;return c=n.force||!u?this._pendingQueries[e][o]=Container.prototype.findAll.call(this,e,t,n).then(function(t){return delete i._pendingQueries[e][o],t=i._end(e,t,n),i.cacheFindAll(e,t,o,n),t},function(t){return delete i._pendingQueries[e][o],O.reject(t)}):O.resolve(u)},getCollection:function getCollection(e){var t=this._collections[e];if(!t)throw O.err(De+"#getCollection",e)(404,"collection");return t},hashQuery:function hashQuery(e,t,n){return O.toJson(t)},inject:function inject(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)},remove:function remove(e,t,n){var i=this.getCollection(e).remove(t,n);return i&&this.removeRelated(e,[i],n),i},removeAll:function removeAll(e,t,n){var i=this.getCollection(e).removeAll(t,n);return i.length&&this.removeRelated(e,i,n),i},removeRelated:function removeRelated(e,t,i){var r=this;O.isArray(t)||(t=[t]),O.forEachRelation(this.getMapper(e),i,function(e,i){t.forEach(function(t){var o=void 0,a=void 0;if(!e.foreignKey||e.type!==D&&e.type!==N?e.type===N&&e.localKeys?a={where:n({},e.getRelation().idAttribute,{in:O.get(t,e.localKeys)})}:e.type===N&&e.foreignKeys?a={where:n({},e.foreignKeys,{contains:e.getForeignKey(t)})}:e.type===K&&(o=r.remove(e.relation,e.getForeignKey(t),i)):a=n({},e.foreignKey,e.getForeignKey(t)),a&&(o=r.removeAll(e.relation,a,i)),o){if(O.isArray(o)&&!o.length)return;e.type===D&&(o=o[0]),e.setLocalField(t,o)}})})},update:function update(e,t,n,i){var r=this;return i||(i={}),Container.prototype.update.call(this,e,t,n,i).then(function(t){return r._end(e,t,i)})},updateAll:function updateAll(e,t,n,i){var r=this;return i||(i={}),Container.prototype.updateAll.call(this,e,n,t,i).then(function(t){return r._end(e,t,i)})},updateMany:function updateMany(e,t,n){var i=this;return n||(n={}),Container.prototype.updateMany.call(this,e,t,n).then(function(t){return i._end(e,t,n)})}};Te.forEach(function(e){Be[e]=function(t){for(var n,i=arguments.length,r=Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return(n=this.getCollection(t))[e].apply(n,r)}});var Ue=Container.extend(Be),$e={full:"3.0.0-rc.4",major:3,minor:0,patch:0};e.version=$e,e.Collection=P,e.Component=w,e.Container=Container,e.DataStore=Ue,e.Index=Index,e.LinkedCollection=Ne,e.Mapper=Se,e.Query=S,e.Record=H,e.Schema=_e,e.Settable=Settable,e.utils=O,e.belongsTo=B,e.hasMany=U,e.hasOne=$,e.belongsToType=K,e.hasManyType=N,e.hasOneType=D,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data.min.map