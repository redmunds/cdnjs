!function(){function e(e){return e?e.toISOString():""}function t(e,t,r){var n=e.slice?"slice":e.mozSlice?"mozSlice":"webkitSlice";return e[n](t,r)}var r=new Date("2060-10-22"),n=function(n){function o(){return{d:function(){},w:function(){},e:function(){}}}function a(e){var t=M.length;return M.push(new u(l({progress:function(){},complete:function(){},cancelled:function(){},info:function(){},warn:function(){},error:function(){}},e,{id:t,status:y,priority:0,onStatusChange:s,loadedBytes:0,sizeBytes:e.file.size,eTag:""}))),t}function s(){z.d("onFileUploadStatusChange"),d()}function i(){setTimeout(d,1)}function d(){z.d("processQueue   length: "+M.length);var e=-1,t=-1,r=!0;M.forEach(function(n,o){n.priority>t&&n.status===y&&(e=o,t=n.priority),n.status===v&&(r=!1)}),r&&e>=0&&M[e].start()}function u(n){function o(e){e!==w&&e!==T&&e!==S||(clearInterval(oe),clearInterval(ae)),se.status=e,se.onStatusChange()}function a(){z.d("cancelAllRequests()");for(var e=1;e<ie.length;e++)u(e,!0);U()}function s(){_.computeContentMd5&&se.file.size>0?R():(N(),G())}function i(e){var t,r={method:"POST",path:$()+"?uploads",step:"initiate",x_amz_headers:se.xAmzHeadersAtInitiate,not_signed_headers:se.notSignedHeadersAtInitiate},n=se.status;se.contentType&&(r.contentType=se.contentType),r.onErr=function(r){t||se.status===b||se.status===S||(t=!0,z.d("onInitiateError for FileUpload "+se.id),se.warn("Error initiating upload"),o(T),r.abort(),setTimeout(function(){se.status!==b&&se.status!==S&&(se.status=n,i(e))},j(le++)))},r.on200=function(t){var n=t.response.match(/<UploadId>(.+)<\/UploadId>/);n&&n[1]?(se.uploadId=n[1],se.awsKey=e,z.d("requester success. got uploadId "+se.uploadId),F(),s()):r.onErr()},K(r),Q(r),W()}function d(e){function r(e){var t=new DOMParser,r=t.parseFromString(e.responseText,"text/xml"),n=r.getElementsByTagName("Code"),o=r.getElementsByTagName("Message");return n=n.length?n[0].innerHTML:"",o=o.length?o[0].innerHTML:"",n.length?{code:n,msg:o}:{}}var n,o,a,s;s=ie[e],s.status=v,ue++,s.loadedBytesPrevious=null,n=j(s.attempts++),z.d("uploadPart #"+e+"     will wait "+n+"ms to try"),a={method:"PUT",path:$()+"?partNumber="+e+"&uploadId="+se.uploadId,step:"upload #"+e,x_amz_headers:se.xAmzHeadersAtUpload,md5_digest:s.md5_digest,attempts:s.attempts,part:s},a.onErr=function(t,n){if(se.status!==S&&se.status!==b){var a="problem uploading part #"+e+",   http status: "+t.status+",   hasErrored: "+!!o+",   part status: "+s.status+",   readyState: "+t.readyState+(n?",   isOnError":"");if(z.w(a),se.warn(a),!o){if(o=!0,404===t.status){var i="404 error resulted in abortion of both this part and the entire file.";z.w(i+" Server response: "+t.response),se.error(i),s.status=b,U()}else{s.status=T,s.loadedBytes=0;var d=r(t);d.code&&z.e('AWS Server response: code="'+d.code+'", message="'+d.msg+'"'),G()}t.abort()}}},a.on200=function(t){var r,n=t.getResponseHeader("ETag");z.d("uploadPart 200 response for part #"+e+"     ETag: "+n),s.isEmpty||n!==I?(s.eTag=n,s.status=w):(s.status=T,s.loadedBytes=0,r="eTag matches MD5 of 0 length blob for part #"+e+"   Retrying part.",z.w(r),se.warn(r)),G()},a.onProgress=function(e){s.loadedBytes=e.loaded},a.toSend=function(){var r=t(se.file,s.start,s.end);return z.d("part # "+e+" (bytes "+s.start+" -> "+s.end+")  reported length: "+r.size),s.isEmpty||0!==r.size||z.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),r},a.onFailedAuth=function(){var t="onFailedAuth for uploadPart #"+e+".   Will set status to ERROR";z.w(t),se.warn(t),s.status=T,s.loadedBytes=0,G()},K(a),setTimeout(function(){se.status!==b&&se.status!==S&&(Q(a),z.d("upload #",e,a))},n),s.uploader=a}function u(e,t){var r=ie[e];r.currentXhr&&(t&&(r.currentXhr.onreadystatechange=function(){}),r.currentXhr.abort())}function P(){z.d("completeUpload"),se.info("will attempt to complete upload");var e,t=[],r=se.status;t.push("<CompleteMultipartUpload>"),ie.forEach(function(e,r){e&&t.push(["<Part><PartNumber>",r,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].join(""))}),t.push("</CompleteMultipartUpload>");var n={method:"POST",contentType:"application/xml; charset=UTF-8",path:$()+"?uploadId="+se.uploadId,x_amz_headers:se.xAmzHeadersAtComplete,step:"complete"};n.onErr=function(t){if(!e&&se.status!==b&&se.status!==S){e=!0;var n="Error completing upload.";z.w(n),se.error(n),o(T),t.abort(),setTimeout(function(){se.status!==b&&se.status!==S&&(se.status=r,P(),W())},j(pe++))}},n.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("CompleteMultipartUploadResult")[0];se.eTag=h(r,"ETag"),se.complete(e,se.name),H()},n.toSend=function(){return t.join("")},K(n),Q(n)}function M(e){z.d("headObject"),se.info("will attempt to verify existence of the file");var t={method:"HEAD",path:$(),step:"head_object"};t.onErr=function(){var t="Error completing head object. Will re-upload file.";z.w(t),i(e)},t.on200=function(t){var r=t.getResponseHeader("Etag");r===se.eTag?(z.d("headObject found matching object on S3."),se.progress(1),se.complete(t,se.name),o(w)):(z.d("headObject not found on S3."),se.name=e,i(e))},K(t),Q(t)}function A(e){return function(){var t=se.status;if(t!==T&&t!==S&&t!==b){var r=_.cryptoMd5Method.call(this,this.result);z.d(["part #",e.part," MD5 digest is ",r].join("")),e.md5_digest=r,1===e.part&&N(),delete e.reader,fe+=1,G(),fe===ce&&z.d("All parts have MD5 digests"),setTimeout(R,1500)}}}function R(){for(var e=1;e<=ce;e++){var r=ie[e];if(r.status!==w&&null===r.md5_digest){if(e>1||"undefined"==typeof se.firstMd5Digest){r.reader=new FileReader,r.reader.onloadend=A(r),r.reader.readAsArrayBuffer(t(se.file,r.start,r.end));break}r.md5_digest=se.firstMd5Digest,N(),G()}}}function U(){z.d("abortUpload"),se.info("will attempt to abort the upload");var e={method:"DELETE",path:$()+"?uploadId="+se.uploadId,step:"abort",successStatus:204};e.onErr=function(){var e="Error aborting upload.";z.w(e),se.error(e)},e.on200=function(){o(b),O()},K(e),Q(e)}function O(){z.d("listParts"),se.info("list parts");var e={method:"GET",path:$()+"?uploadId="+se.uploadId,step:"list"};e.onErr=function(e){if(404===e.status)k(),se.info("upload canceled");else{var t="Error listing parts.";z.w(t),se.error(t)}},e.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("Part");r.length?(z.d("Parts still found after abort...waiting."),setTimeout(function(){U()},1e3)):se.info("upload canceled")},K(e),Q(e)}function D(e){z.d("getUploadParts() for uploadId starting at part # "+e),se.info("getUploadParts() for uploadId starting at part # "+e);var t={method:"GET",path:$()+"?uploadId="+se.uploadId,query_string:"&part-number-marker="+e,step:"get upload parts"};t.onErr=function(t){if(404===t.status)se.info(["uploadId ",se.uploadId," does not exist."].join("")),k(),W(),F(),G();else{var r="Error listing parts for getUploadParts() starting at part # "+e;z.w(r),se.error(r)}},t.on200=function(t){se.info(["uploadId ",se.uploadId," is not complete. Fetching parts from part marker=",e].join(""));for(var r,n,o=p(t.responseText),a=o.getElementsByTagName("ListPartsResult")[0],i="true"===h(a,"IsTruncated"),d=o.getElementsByTagName("Part"),u=d.length,l=0;l<u;l++)n=d[l],de.push({eTag:h(n,"ETag"),partNumber:parseInt(h(n,"PartNumber")),size:parseInt(h(n,"Size")),LastModified:h(n,"LastModified")});if(o=d=null,i){var f=h(a,"NextPartNumberMarker");D(f)}else F(),de.forEach(function(e){r=C(e.partNumber,w,e.size),r.eTag=e.eTag,r.attempts=1,r.loadedBytes=e.size,r.loadedBytesPrevious=e.size,r.finishedUploadingAt=e.LastModified,r.md5_digest="n/a",ie[e.partNumber]=r}),W(),s();a=null},K(t),Q(t)}function F(){ce=Math.ceil(se.file.size/_.partSize)||1;for(var e=1;e<=ce;e++){var t="undefined"==typeof ie[e]?y:ie[e].status;t!==w&&(ie[e]=C(e,y,se.file.size))}}function C(e,t,r){return{status:t,start:(e-1)*_.partSize,end:e*_.partSize,attempts:0,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,part:e}}function N(){var t=c(se),r={awsKey:se.name,uploadId:se.uploadId,fileSize:se.file.size,fileType:se.file.type,lastModifiedDate:e(se.file.lastModifiedDate),partSize:_.partSize,signParams:se.signParams,createdAt:(new Date).toISOString()};_.computeContentMd5&&ie.length&&"undefined"!=typeof ie[1].md5_digest&&(r.firstMd5Digest=ie[1].md5_digest),g(t,r)}function H(){var e=f(),t=e[c(se)];"undefined"!=typeof t&&(t.completedAt=(new Date).toISOString(),t.eTag=se.eTag,B.setItem("awsUploads",JSON.stringify(e))),o(w),se.progress(1)}function k(){"undefined"!=typeof se.file&&m(c(se))}function L(){var e=f(!0),t=e[c(se)];q(t)&&(se.uploadId=t.uploadId,se.name=t.awsKey,se.eTag=t.eTag,se.firstMd5Digest=t.firstMd5Digest,se.signParams=t.signParams)}function q(e){if("undefined"==typeof e)return!1;var t=new Date(e.completedAt||r);return _.partSize===e.partSize&&t>x}function j(e){return 1===e?0:1e3*Math.min(_.maxRetryBackoffSecs,Math.pow(_.retryBackoffPower,e-2))}function G(){var e,t=0,r=!0,n=!1,o=[],a=[];if(se.status!==v)return void se.info("will not process parts list, as not currently evaporating");for(var s=0;s<ie.length;s++){var i=ie[s];if(i){if(_.computeContentMd5&&null===i.md5_digest)return;var u=!1;switch(o.push(i.status),i.status){case v:r=!1,t++,a.push(i.loadedBytes);break;case T:n=!0,u=!0;break;case y:u=!0}u&&(r=!1,t<_.maxConcurrentParts&&(d(s),t++))}}e=o.toString()+" // bytesLoaded: "+a.toString(),z.d("processPartsList()  anyPartHasErrored: "+n,e),(ue>=ie.length-1||n)&&se.info("part stati: "+e),r&&P()}function X(){oe=setInterval(function(){var e=0;ie.forEach(function(t){e+=t.loadedBytes}),se.progress(e/se.sizeBytes)},_.progressIntervalMS)}function J(){ae=setInterval(function(){z.d("monitorPartsProgress() "+new Date),ie.forEach(function(e,t){var r;return e.status!==v?void z.d(t,"not evaporating "):null===e.loadedBytesPrevious?(z.d(t,"no previous "),void(e.loadedBytesPrevious=e.loadedBytes)):(r=e.loadedBytesPrevious<e.loadedBytes,_.simulateStalling&&4===t&&Math.random()<.25&&(r=!1),z.d(t,r?"moving. ":"stalled.",e.loadedBytesPrevious,e.loadedBytes),r||setTimeout(function(){se.info("part #"+t+" stalled. will abort. "+e.loadedBytesPrevious+" "+e.loadedBytes),u(t)},0),void(e.loadedBytesPrevious=e.loadedBytes))})},12e4)}function W(){X(),J()}function K(e){if(z.d("setupRequest()",e),_.timeUrl){var t=new XMLHttpRequest;t.open("GET",_.timeUrl+"?requestTime="+(new Date).getTime(),!1),t.send(),e.dateString=t.responseText}else e.dateString=(new Date).toUTCString();e.x_amz_headers=l(e.x_amz_headers,{"x-amz-date":e.dateString}),e.onGotAuth=function(){if(te(e))return void z.w("onGotAuth() step",e.step,"is already in progress. Returning.");var t=re(e),r=e.toSend?e.toSend():null,n=E+e.path;e.query_string&&(n+=e.query_string);var o={},a=e.successStatus||200;l(o,e.not_signed_headers),l(o,e.x_amz_headers),_.simulateErrors&&1===e.attempts&&"upload #3"===e.step&&(z.d("simulating error by POST part #3 to invalid url"),n="https:///foo"),t.open(e.method,n),t.setRequestHeader("Authorization","AWS "+_.aws_key+":"+e.auth);for(var s in o)o.hasOwnProperty(s)&&t.setRequestHeader(s,o[s]);e.contentType&&t.setRequestHeader("Content-Type",e.contentType),e.md5_digest&&t.setRequestHeader("Content-MD5",e.md5_digest),t.onreadystatechange=function(){4===t.readyState&&(r&&z.d("  ### "+r.size),ne(e),t.status===a?e.on200(t):e.onErr(t))},t.onerror=function(){ne(e),e.onErr(t,!0)},"function"==typeof e.onProgress&&(t.upload.onprogress=function(t){e.onProgress(t)}),t.send(r)},e.onFailedAuth=e.onFailedAuth||function(t){se.error("Error onFailedAuth for step: "+e.step),e.onErr(t)}}function Q(e){if(z.d("authorizedSend() "+e.step),te(e))return void z.w("authorizedSend() step",e.step,"is already in progress. Returning.");if(_.awsLambda)return V(e);var t,r=re(e),n=_.signerUrl+"?to_sign="+encodeURIComponent(Z(e)),o=Y(se.signParams);for(var a in o)o.hasOwnProperty(a)&&(n+="&"+encodeURIComponent(a)+"="+encodeURIComponent(o[a]));r.onreadystatechange=function(){4===r.readyState&&(200===r.status&&28===r.response.length?(z.d("authorizedSend got signature for step: '"+e.step+"'    sig: "+r.response),e.auth=r.response,ne(e),e.onGotAuth()):(t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,z.w(t),se.warn(t),ne(e),e.onFailedAuth(r)))},r.onerror=function(){t="failed to get authorization (onerror) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,z.w(t),se.warn(t),e.onFailedAuth(r)},r.open("GET",n);var s=Y(se.signHeaders);for(var i in s)s.hasOwnProperty(i)&&r.setRequestHeader(i,s[i]);"function"==typeof se.beforeSigner&&se.beforeSigner(r,n),r.send()}function V(e){_.awsLambda.invoke({FunctionName:_.awsLambdaFunction,InvocationType:"RequestResponse",Payload:JSON.stringify({to_sign:Z(e),sign_params:Y(se.signParams),sign_headers:Y(se.signHeaders)})},function(t,r){return t?(warnMsg="failed to get authorization with lambda "+t,z.w(warnMsg),se.warn(warnMsg),void e.onFailedAuth(t)):(e.auth=JSON.parse(r.Payload),void e.onGotAuth())})}function Y(e){var t;for(var r in e)e.hasOwnProperty(r)&&("function"==typeof e[r]?t[r]=e[r]():t[r]=e[r]);return t}function Z(e){var t,r="",n=[];for(var o in e.x_amz_headers)e.x_amz_headers.hasOwnProperty(o)&&n.push(o);return n.sort(),n.forEach(function(t){r+=t+":"+e.x_amz_headers[t]+"\n"}),t=e.method+"\n"+(e.md5_digest||"")+"\n"+(e.contentType||"")+"\n\n"+r+(_.cloudfront?"/"+_.bucket:"")+e.path}function $(){var e="/"+_.bucket+"/"+se.name;return(_.cloudfront||E.indexOf("cloudfront")>-1)&&(e="/"+se.name),e}function ee(e){return"undefined"==typeof e.part?e:e.part}function te(e){return!!ee(e).currentXhr}function re(e){return ee(e).currentXhr=new XMLHttpRequest}function ne(e){delete ee(e).currentXhr}var oe,ae,se=this,ie=[],de=[],ue=0,le=0,pe=0;l(se,n),se.start=function(){z.d("starting FileUpload "+se.id),o(v);var e=se.name;if(L(),"undefined"==typeof se.uploadId)i(e);else if("undefined"!=typeof se.eTag&&se.firstMd5Digest){var r=new FileReader;r.onloadend=function(){var t=_.cryptoMd5Method.call(this,this.result);_.allowS3ExistenceOptimization&&se.firstMd5Digest===t?M(e):(se.firstMd5Digest=t,i(e))},r.readAsArrayBuffer(t(se.file,0,_.partSize))}else D(0)},se.stop=function(){z.d("stopping FileUpload ",se.id),se.cancelled(),o(S),se.info("Canceling uploads..."),a()};var fe=0,ce=-1}function l(e,t,r){if(e="undefined"==typeof e?{}:e,"object"==typeof r)for(var n in r)t[n]=r[n];for(var o in t)e[o]=t[o];return e}function p(e){var t=new DOMParser;return t.parseFromString(e,"text/xml")}function f(e){var t=JSON.parse(B.getItem("awsUploads")||"{}");if(e)for(var n in t)if(t.hasOwnProperty(n)){var o=t[n],a=new Date(o.completedAt||r);a<x&&delete t[n]}return t}function c(t){return[t.file.name,t.file.type,e(t.file.lastModifiedDate),t.file.size].join("-")}function g(e,t){var r=f();r[e]=t,B.setItem("awsUploads",JSON.stringify(r))}function m(e){var t=f();delete t[e],B.setItem("awsUploads",JSON.stringify(t))}function h(e,t){return e.getElementsByTagName(t)[0].childNodes[0].nodeValue}var y=0,v=2,w=3,S=5,T=10,b=20,E=n.aws_url||"https://s3.amazonaws.com",I='"d41d8cd98f00b204e9800998ecf8427e"',P=this,M=[],z=o(),_=l({logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:500,cloudfront:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,timeUrl:null,cryptoMd5Method:null,s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},awsLambda:null,awsLambdaFunction:null,testUnsupported:!1,simulateStalling:!1,simulateErrors:!1},n);if(console&&console.log&&(z=console,z.d=z.log,z.w=console.warn?z.warn:z.d,z.e=console.error?z.error:z.d),this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)||n.testUnsupported),!this.supported)return void z.e("The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]");if(_.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return void z.e("The browser's FileReader object does not support readAsArrayBuffer");if("function"!=typeof _.cryptoMd5Method)return void z.e("Option computeContentMd5 has been set but cryptoMd5Method is not defined.")}_.logging||(z=o());var B={supported:function(){var e=!1;if("undefined"==typeof window)return e;if(!("localStorage"in window))return e;try{localStorage.setItem("___test","OK");var t=localStorage.getItem("___test");localStorage.removeItem("___test"),e="OK"===t}catch(t){return e}return e}(),getItem:function(e){if(this.supported)return localStorage.getItem(e)},setItem:function(e,t){if(this.supported)return localStorage.setItem(e,t)},clear:function(){if(this.supported)return localStorage.clear()},key:function(e){if(this.supported)return localStorage.key(e)},removeItem:function(e){if(this.supported)return localStorage.removeItem(e)}},A=new Date,x=new Date(A.setHours(A.getHours()-(_.s3FileCacheHoursAgo||-100)));P.add=function(e){z.d("add");var t;if("undefined"==typeof e)return"Missing file";if("undefined"==typeof e.name?t="Missing attribute: name  ":_.encodeFilename&&(e.name=encodeURIComponent(e.name)),t)return t;var r=a(e);return i(),r},P.cancel=function(e){return z.d("cancel ",e),!!M[e]&&(M[e].stop(),!0)},P.pause=function(e){},P.resume=function(e){},P.forceRetry=function(){}};"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof window&&(window.Evaporate=n)}();
//# sourceMappingURL=evaporate.min.js.map