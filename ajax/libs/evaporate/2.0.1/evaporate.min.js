!function(){"use strict";function t(t,e,o){this.fileTotalBytesUploaded=0,this.s3Parts=[],this.partsOnS3=[],this.partsInProcess=[],this.partsToUpload=[],this.numParts=-1,this.con=e,this.evaporate=o,this.localTimeOffset=o.localTimeOffset,this.deferredCompletion=v(),S(this,t),this.id=decodeURIComponent(this.con.bucket+"/"+this.name),this.signParams=e.signParams}function e(t,e){this.fileUpload=t,this.con=t.con,this.attempts=1,this.localTimeOffset=this.fileUpload.localTimeOffset,this.awsDeferred=v(),this.started=v(),this.awsUrl=h(this.con),this.awsHost=f(this.awsUrl).hostname,this.updateRequest(e)}function o(t,o){e.call(this,t,o)}function s(t,o,s){s>-1&&(this.maxRetries=s),e.call(this,t,o)}function r(t,e){var s={method:"POST",path:"?uploads",step:"initiate",x_amz_headers:t.xAmzHeadersAtInitiate,not_signed_headers:t.notSignedHeadersAtInitiate,response_match:"<UploadId>(.+)</UploadId>"};t.contentType&&(s.contentType=t.contentType),o.call(this,t,s),this.awsKey=e}function n(t){t.info("will attempt to complete upload");var e={method:"POST",contentType:"application/xml; charset=UTF-8",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtComplete,step:"complete"};o.call(this,t,e)}function i(t,e){this.awsKey=e,t.info("will attempt to verify existence of the file");var o={method:"HEAD",path:"",x_amz_headers:t.xAmzHeadersCommon,success404:!0,step:"head_object"};s.call(this,t,o)}function a(t){s.call(this,t),this.updateRequest(this.setupRequest(0))}function p(t,o){this.part=o,this.partNumber=o.part,this.start=(this.partNumber-1)*t.con.partSize,this.end=this.partNumber*t.con.partSize;var s={method:"PUT",path:"?partNumber="+this.partNumber+"&uploadId="+t.uploadId,step:"upload #"+this.partNumber,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtUpload,contentSha256:"UNSIGNED-PAYLOAD",onProgress:this.onProgress.bind(this)};e.call(this,t,s)}function u(t){t.info("will attempt to abort the upload"),t.abortParts();var o={method:"DELETE",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon,success404:!0,step:"abort"};e.call(this,t,o)}function d(t,e){function o(t){this.request=t}function s(t){o.call(this,t)}function r(t,e){this.payload=e,o.call(this,t)}var n=t.con;return o.prototype.request={},o.prototype.authorizationString=function(){},o.prototype.stringToSign=function(){},o.prototype.setHeaders=function(){},o.prototype.datetime=function(t){return new Date((new Date).getTime()+t)},o.prototype.dateString=function(t){return this.datetime(t).toISOString().slice(0,19).replace(/-|:/g,"")+"Z"},s.prototype=Object.create(o.prototype),s.prototype.constructor=s,s.prototype.authorizationString=function(){return["AWS ",n.aws_key,":",this.request.auth].join("")},s.prototype.stringToSign=function(){var o,s="",r=[];for(var i in this.request.x_amz_headers)this.request.x_amz_headers.hasOwnProperty(i)&&r.push(i);return r.sort(),r.forEach(function(t){s+=t+":"+this.request.x_amz_headers[t]+"\n"}.bind(this)),o=this.request.method+"\n"+(this.request.md5_digest||"")+"\n"+(this.request.contentType||"")+"\n\n"+s+(n.cloudfront?"/"+n.bucket:"")+t.getPath()+this.request.path,e.d("V2 stringToSign:",o),o},s.prototype.dateString=function(t){return this.datetime(t).toUTCString()},r.prototype=Object.create(o.prototype),r.prototype.constructor=r,r.prototype.payload=null,r.prototype.authorizationString=function(){var t=[],e=this.credentialString(),o=this.canonicalHeaders();return t.push(["AWS4-HMAC-SHA256 Credential=",n.aws_key,"/",e].join("")),t.push("SignedHeaders="+o.signedHeaders),t.push("Signature="+this.request.auth),t.join(", ")},r.prototype.stringToSign=function(){var t=[];t.push("AWS4-HMAC-SHA256"),t.push(this.request.dateString),t.push(this.credentialString()),t.push(n.cryptoHexEncodedHash256(this.canonicalRequest()));var o=t.join("\n");return e.d("V4 stringToSign:",o),o},r.prototype.credentialString=function(){var t=[];return t.push(this.request.dateString.slice(0,8)),t.push(n.awsRegion),t.push("s3"),t.push("aws4_request"),t.join("/")},r.prototype.canonicalQueryString=function(){var e,o,s=t.request.query_string||"",r=f([t.awsUrl,this.request.path,s].join("")).search,n=r.length?r.split("&"):[],i=[];for(o=0;o<n.length;o++)e=n[o].split("="),i.push({name:encodeURIComponent(e[0]),value:e.length>1?encodeURIComponent(e[1]):null});var a=i.sort(function(t,e){return t.name<e.name?-1:t.name>e.name?1:0}),p=[];for(o=0;o<a.length;o++)e=a[o].value?[a[o].name,a[o].value].join("="):a[o].name+"=",p.push(e);return p.join("&")},r.prototype.getPayloadSha256Content=function(){var t=this.request.contentSha256||n.cryptoHexEncodedHash256(this.payload||"");return e.d(this.request.step,"getPayloadSha256Content:",t),t},r.prototype.canonicalHeaders=function(){function e(t,e){var o=t.toLowerCase();r.push(o),s[o]=e.replace(/\s+/g," ")}var o,s=[],r=[];this.request.md5_digest&&e("Content-Md5",this.request.md5_digest),e("Host",t.awsHost),this.request.contentType&&e("Content-Type",this.request.contentType||"");var n=this.request.x_amz_headers||{};for(var i in n)n.hasOwnProperty(i)&&e(i,n[i]);var a=r.sort(function(t,e){return t<e?-1:t>e?1:0}),p=[],u=[],d=this.request.not_signed_headers||[],l=[];for(o=0;o<d.length;o++)u.push(d[o].toLowerCase());for(o=0;o<a.length;o++){var h=a[o];p.push([h,s[h]].join(":")),u.indexOf(h)===-1&&l.push(h)}return{canonicalHeaders:p.join("\n"),signedHeaders:l.join(";")}},r.prototype.canonicalRequest=function(){var o=[];o.push(this.request.method),o.push(f([t.awsUrl+t.getPath()+this.request.path].join("")).pathname),o.push(this.canonicalQueryString()||"");var s=this.canonicalHeaders();o.push(s.canonicalHeaders+"\n"),o.push(s.signedHeaders),o.push(this.getPayloadSha256Content());var r=o.join("\n");return e.d(this.request.step,"V4 CanonicalRequest:",r),r},r.prototype.setHeaders=function(t){t.setRequestHeader("x-amz-content-sha256",this.getPayloadSha256Content())},"4"===n.awsSignatureVersion?r:s}function l(t){function e(){this.request=n}function o(){e.call(this)}var s=t.fileUpload,r=s.con,n=t.request;return e.prototype=Object.create(e.prototype),e.prototype.request={},e.makeSignParamsObject=function(t){var e={};for(var o in t)t.hasOwnProperty(o)&&("function"==typeof t[o]?e[o]=t[o]():e[o]=t[o]);return e},e.prototype.authorize=function(){return new Promise(function(o,i){var a=new XMLHttpRequest;t.currentXhr=a;var p=t.stringToSign(),u=[r.signerUrl,"?to_sign=",p,"&datetime=",n.dateString].join(""),d=e.makeSignParamsObject(s.signParams);for(var l in d)d.hasOwnProperty(l)&&(u+="&"+encodeURIComponent(l)+"="+encodeURIComponent(d[l]));r.xhrWithCredentials&&(a.withCredentials=!0),a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status)t.signResponse(a.response,p,n.dateString).then(o);else{if([401,403].indexOf(a.status)>-1){var e="status:"+a.status;return s.deferredCompletion.reject("Permission denied "+e),i(e)}i("Signature fetch returned status: "+a.status)}},a.onerror=function(t){i("authorizedSend transport error: "+t.responseText)},a.open("GET",u);var h=e.makeSignParamsObject(r.signHeaders);for(var c in h)h.hasOwnProperty(c)&&a.setRequestHeader(c,h[c]);"function"==typeof s.beforeSigner&&s.beforeSigner(a,u),a.send()})},o.prototype=Object.create(e.prototype),o.prototype.authorize=function(){return r.customAuthMethod(e.makeSignParamsObject(s.signParams),e.makeSignParamsObject(r.signHeaders),t.stringToSign(),n.dateString).catch(function(t){throw s.deferredCompletion.reject(t),t})},"function"==typeof r.customAuthMethod?new o:new e}function h(t){var e;return t.aws_url?e=[t.aws_url]:(t.s3Acceleration?(e=["https://",t.bucket,".s3-accelerate"],t.cloudfront=!0):(e=["https://",t.cloudfront?t.bucket+".":"","s3"],"us-east-1"!==t.awsRegion&&e.push("-",t.awsRegion)),e.push(".amazonaws.com")),e.join("")}function c(t){var e=t.split("/"),o=[];return e.forEach(function(t){o.push(encodeURIComponent(t).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/'/,"%27"))}),o.join("/")}function f(t){var e=document.createElement("a");return e.href=t||"/",{protocol:e.protocol,hostname:e.hostname,pathname:e.pathname.replace(/(^\/?)/,"/"),port:e.port,search:"?"===e.search[0]?e.search.substr(1):e.search,hash:e.hash,host:e.host}}function m(t){return t?new Date(t).toISOString():""}function y(t,e,o){var s=t.slice?"slice":t.mozSlice?"mozSlice":"webkitSlice";return t[s](e,o)}function g(t){var e=new DOMParser,o=e.parseFromString(t.responseText,"text/html"),s=o.getElementsByTagName("Code"),r=o.getElementsByTagName("Message");return s=s&&s.length?s[0].innerHTML||s[0].textContent:"",r=r&&r.length?r[0].innerHTML||r[0].textContent:"",s.length?["AWS Code: ",s,", Message:",r].join(""):""}function v(){var t,e={};return t=new Promise(function(t,o){e={resolve:t,reject:o}}),{resolve:e.resolve,reject:e.reject,promise:t}}function S(t,e,o){function s(t,e){if("object"==typeof e)for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])}return t=t||{},s(e,o),s(t,e),t}function w(t){var e=new DOMParser;return e.parseFromString(t,"text/xml")}function P(t,e){return t.getElementsByTagName(e)[0].textContent}function U(t){var e=JSON.parse(V.getItem("awsUploads")||"{}");if(t){for(var o in e)if(e.hasOwnProperty(o)){var s=e[o],r=new Date(s.completedAt||z);r<C&&delete e[o]}V.setItem("awsUploads",JSON.stringify(e))}return e}function b(t){return[t.file.name,t.file.type,m(t.file.lastModified),t.sizeBytes].join("-")}function T(t,e){var o=U();o[t]=e,V.setItem("awsUploads",JSON.stringify(o))}function x(t){var e=U();delete e[t],V.setItem("awsUploads",JSON.stringify(e))}function O(t,e){var o=t.indexOf(e);if(o>-1)return t.splice(o,1),!0}function q(t){for(var e=["B","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"],o=0;t>=1024;)t/=1024,++o;return[t.toFixed(2).replace(".00",""),e[o]].join(" ")}function I(){return{d:function(){},w:function(){},e:function(){}}}var C,_,z=new Date("2060-10-22"),R=0,M=2,F=3,j=4,H=5,A=10,E=20,B=30,D=[j,B],k=[R,M,A],N='"d41d8cd98f00b204e9800998ecf8427e"',L=12e4,W=["maxConcurrentParts","logging","cloudfront","aws_url","encodeFilename","computeContentMd5","allowS3ExistenceOptimization","onlyRetryForSameFileName","timeUrl","cryptoMd5Method","cryptoHexEncodedHash256","aws_key","awsRegion","awsSignatureVersion","evaporateChanged"],K=function(t){if(this.config=S({bucket:null,logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:1e3,cloudfront:!1,s3Acceleration:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,onlyRetryForSameFileName:!1,timeUrl:null,cryptoMd5Method:null,cryptoHexEncodedHash256:null,aws_key:null,awsRegion:"us-east-1",awsSignatureVersion:"4",s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},customAuthMethod:void 0,maxFileSize:null,signResponseHandler:null,xhrWithCredentials:!1,localTimeOffset:void 0,evaporateChanged:function(){},abortCompletionThrottlingMs:1e3},t),"undefined"!=typeof window&&window.console&&(_=window.console,_.d=_.log,_.w=window.console.warn?_.warn:_.d,_.e=window.console.error?_.error:_.d),this._instantiationError=this.validateEvaporateOptions(),"string"==typeof this._instantiationError)return void(this.supported=!1);delete this._instantiationError,this.config.logging||(_=I());var e=new Date;if(C=new Date(e.setHours(e.getHours()-(this.config.s3FileCacheHoursAgo||-100))),"number"==typeof t.localTimeOffset)this.localTimeOffset=t.localTimeOffset;else{var o=this;K.getLocalTimeOffset(this.config).then(function(t){o.localTimeOffset=t})}this.pendingFiles={},this.queuedFiles=[],this.filesInProcess=[]};K.create=function(t){var e=Object.assign({},t);return K.getLocalTimeOffset(e).then(function(t){return e.localTimeOffset=t,new Promise(function(t,o){var s=new K(e);s.supported===!0?t(s):o(s._instantiationError)})})},K.getLocalTimeOffset=function(t){return new Promise(function(e,o){if("number"==typeof t.localTimeOffset)return e(t.localTimeOffset);if(t.timeUrl){var s=new XMLHttpRequest;s.open("GET",t.timeUrl+"?requestTime="+(new Date).getTime()),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var t=new Date(Date.parse(s.responseText)),o=new Date;e(t-o)}},s.onerror=function(t){_.e("xhr error timeUrl",t),o("Fetching offset time failed with status: "+t.status)},s.send()}else e(0)}).then(function(t){return _.d("localTimeOffset is",t,"ms"),new Promise(function(e){e(t)})})},K.prototype.config={},K.prototype.localTimeOffset=0,K.prototype.supported=!1,K.prototype._instantiationError=void 0,K.prototype.evaporatingCount=0,K.prototype.pendingFiles={},K.prototype.filesInProcess=[],K.prototype.queuedFiles=[],K.prototype.startNextFile=function(t){if(this.queuedFiles.length&&!(this.evaporatingCount>=this.config.maxConcurrentParts)){var e=this.queuedFiles.shift();e.status===R?(_.d("Starting",decodeURIComponent(e.name),"reason:",t),this.evaporatingCnt(1),e.start()):(_.d("Requeued",decodeURIComponent(e.name),"status:",e.status,"reason:",t),this.queuedFiles.push(e))}},K.prototype.fileCleanup=function(t){O(this.queuedFiles,t),O(this.filesInProcess,t)&&this.evaporatingCnt(-1),t.done(),this.consumeRemainingSlots()},K.prototype.queueFile=function(t){this.filesInProcess.push(t),this.queuedFiles.push(t),1===this.filesInProcess.length&&this.startNextFile("first file")},K.prototype.add=function(e,o){var s,r=this;return new Promise(function(n,i){var a=S(o,{});if(W.forEach(function(t){delete a[t]}),s=S(r.config,a),"undefined"==typeof e||"undefined"==typeof e.file)return i("Missing file");if(s.maxFileSize&&e.file.size>s.maxFileSize)return i("File size too large. Maximum size allowed is "+s.maxFileSize);if("undefined"==typeof e.name)return i("Missing attribute: name");s.encodeFilename&&(e.name=c(e.name));var p=new t(S({started:function(){},progress:function(){},complete:function(){},cancelled:function(){},paused:function(){},resumed:function(){},pausing:function(){},nameChanged:function(){},info:function(){},warn:function(){},error:function(){},beforeSigner:void 0,xAmzHeadersAtInitiate:{},notSignedHeadersAtInitiate:{},xAmzHeadersCommon:null,xAmzHeadersAtUpload:{},xAmzHeadersAtComplete:{}},e,{status:R,priority:0,loadedBytes:0,sizeBytes:e.file.size,eTag:""}),s,r),u=p.id;r.pendingFiles[u]=p,r.queueFile(p),p.deferredCompletion.promise.then(function(){r.fileCleanup(p),n(decodeURIComponent(p.name))},function(t){r.fileCleanup(p),i(t)})})},K.prototype.cancel=function(t){return"undefined"==typeof t?this._cancelAll():this._cancelOne(t)},K.prototype._cancelAll=function(){_.d("Canceling all file uploads");var t=[];for(var e in this.pendingFiles)if(this.pendingFiles.hasOwnProperty(e)){var o=this.pendingFiles[e];k.indexOf(o.status)>-1&&t.push(o.stop())}return t.length||t.push(Promise.reject("No files to cancel.")),Promise.all(t)},K.prototype._cancelOne=function(t){var e=[];return this.pendingFiles[t]?e.push(this.pendingFiles[t].stop()):e.push(Promise.reject("File does not exist")),Promise.all(e)},K.prototype.pause=function(t,e){e=e||{};var o="undefined"!=typeof e.force&&e.force;return"undefined"==typeof t?this._pauseAll(o):this._pauseOne(t,o)},K.prototype._pauseAll=function(t){_.d("Pausing all file uploads");var e=[];for(var o in this.pendingFiles)if(this.pendingFiles.hasOwnProperty(o)){var s=this.pendingFiles[o];k.indexOf(s.status)>-1&&this._pause(s,t,e)}return Promise.all(e)},K.prototype._pauseOne=function(t,e){var o=[],s=this.pendingFiles[t];return"undefined"==typeof s?o.push(Promise.reject("Cannot pause a file that has not been added.")):s.status===j&&o.push(Promise.reject("Cannot pause a file that is already paused.")),o.length||this._pause(s,e,o),Promise.all(o)},K.prototype._pause=function(t,e,o){o.push(t.pause(e)),O(this.filesInProcess,t),O(this.queuedFiles,t)},K.prototype.resume=function(t){return"undefined"==typeof t?this._resumeAll():this._resumeOne(t)},K.prototype._resumeAll=function(){_.d("Resuming all file uploads");for(var t in this.pendingFiles)if(this.pendingFiles.hasOwnProperty(t)){var e=this.pendingFiles[t];D.indexOf(e.status)>-1&&this.resumeFile(e)}return Promise.resolve()},K.prototype._resumeOne=function(t){var e=this.pendingFiles[t],o=[];return"undefined"==typeof e?o.push(Promise.reject("Cannot pause a file that does not exist.")):D.indexOf(e.status)===-1?o.push(Promise.reject("Cannot resume a file that has not been paused.")):this.resumeFile(e),Promise.all(o)},K.prototype.resumeFile=function(t){t.resume(),this.queueFile(t)},K.prototype.forceRetry=function(){},K.prototype.consumeRemainingSlots=function(){var t=this.config.maxConcurrentParts-this.evaporatingCount;if(t)for(var e=0;e<this.filesInProcess.length;e++){var o=this.filesInProcess[e],s=o.consumeSlots();if(!(s<0||(t-=s)))return}},K.prototype.validateEvaporateOptions=function(){if(this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof Promise||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)),!this.config.signerUrl&&"function"!=typeof this.config.customAuthMethod)return"Option signerUrl is required unless customAuthMethod is present.";if(!this.config.bucket)return"The AWS 'bucket' option must be present.";if(!this.supported)return"The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]";if(this.config.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return"The browser's FileReader object does not support readAsArrayBuffer";if("function"!=typeof this.config.cryptoMd5Method)return"Option computeContentMd5 has been set but cryptoMd5Method is not defined.";if("4"===this.config.awsSignatureVersion&&"function"!=typeof this.config.cryptoHexEncodedHash256)return"Option awsSignatureVersion is 4 but cryptoHexEncodedHash256 is not defined."}else if("4"===this.config.awsSignatureVersion)return"Option awsSignatureVersion is 4 but computeContentMd5 is not enabled.";return!0},K.prototype.evaporatingCnt=function(t){this.evaporatingCount=Math.max(0,this.evaporatingCount+t),this.config.evaporateChanged(this,this.evaporatingCount)},t.prototype.con=void 0,t.prototype.evaporate=void 0,t.prototype.localTimeOffset=0,t.prototype.id=void 0,t.prototype.status=R,t.prototype.numParts=-1,t.prototype.fileTotalBytesUploaded=0,t.prototype.partsInProcess=[],t.prototype.partsToUpload=[],t.prototype.s3Parts=[],t.prototype.partsOnS3=[],t.prototype.deferredCompletion=void 0,t.prototype.abortedByUser=!1,t.prototype.progressInterval=void 0,t.prototype.startTime=void 0,t.prototype.loaded=0,t.prototype.totalUpoaded=0,t.prototype.updateLoaded=function(t){this.loaded+=t,this.fileTotalBytesUploaded+=t},t.prototype.progessStats=function(){if(0===this.fileTotalBytesUploaded)return{};this.totalUpoaded+=this.loaded;var t=(new Date-this.startTime)/1e3,e=this.totalUpoaded/t,o={speed:e,readableSpeed:q(e),loaded:this.loaded},s=this.sizeBytes-this.fileTotalBytesUploaded;return e>0&&(o.secondsLeft=Math.round(s/e)),o},t.prototype.onProgress=function(){[E,j].indexOf(this.status)===-1&&(this.progress(this.fileTotalBytesUploaded/this.sizeBytes,this.progessStats()),this.loaded=0)},t.prototype.startMonitor=function(){clearInterval(this.progressInterval),this.startTime=new Date,this.loaded=0,this.totalUpoaded=0,this.onProgress(),this.progressInterval=setInterval(this.onProgress.bind(this),this.con.progressIntervalMS)},t.prototype.stopMonitor=function(){clearInterval(this.progressInterval)},t.prototype.startNextFile=function(t){this.evaporate.startNextFile(t)},t.prototype.evaporatingCnt=function(t){this.evaporate.evaporatingCnt(t)},t.prototype.consumeRemainingSlots=function(){this.evaporate.consumeRemainingSlots()},t.prototype.getRemainingSlots=function(){var t=this.evaporate.evaporatingCount;return!this.partsInProcess.length&&t>0&&(t-=1),this.con.maxConcurrentParts-t},t.prototype.lastPartSatisfied=Promise.resolve("onStart"),t.prototype.start=function(){if(this.status=M,this.startMonitor(),this.started(this.id),this.uploadId)return _.d("resuming FileUpload ",this.id),this.consumeSlots();var t=this.name;this.getUnfinishedFileUpload();var e=this.con.computeContentMd5&&this.con.allowS3ExistenceOptimization&&"undefined"!=typeof this.firstMd5Digest&&"undefined"!=typeof this.eTag,o=this,s=!1;new Promise(function(r,n){new Promise(function(r,n){if(!o.uploadId)throw"";return e?o.reuseS3Object(t).then(r,n):(s=!0,void o.resumeInterruptedUpload().then(r,n))}).then(r,function(e){k.indexOf(o.status)!==-1&&(_.d(e),o.uploadId=void 0,s=!0,o.uploadFile(t).then(r,n))})}).then(function(){var t=s?o.completeUpload():Promise.resolve();t.then(o.deferredCompletion.resolve.bind(o))},function(){o.abortedByUser||o.abortUpload().then(function(){o.deferredCompletion.reject("File upload aborted due to a part failing to upload")},o.deferredCompletion.reject.bind(o))})},t.prototype.stop=function(){_.d("stopping FileUpload ",this.id),this.setStatus(H),this.info("Canceling uploads..."),this.abortedByUser=!0;var t=this;return this.abortUpload().then(function(){throw"User aborted the upload"}).catch(function(e){t.deferredCompletion.reject(e)})},t.prototype.pause=function(t){_.d("pausing FileUpload, force:",!!t,this.id);var e=[];return this.info("Pausing uploads..."),this.status=B,t?this.abortParts(!0):(e=this.partsInProcess.map(function(t){return this.s3Parts[t].awsRequest.awsDeferred.promise},this),this.pausing()),Promise.all(e).then(function(){this.stopMonitor(),this.status=j,this.startNextFile("pause"),this.paused()}.bind(this))},t.prototype.resume=function(){this.status=R,this.resumed()},t.prototype.done=function(){clearInterval(this.progressInterval),this.startNextFile("file done"),this.partsOnS3=[],this.s3Parts=[]},t.prototype.startPartUpload=function(t){this.lastPartSatisfied.then(t.delaySend.bind(t)),this.lastPartSatisfied=t.getStartedPromise()},t.prototype.abortParts=function(t){var e=this,o=this.partsInProcess.slice(0);o.forEach(function(o){var s=e.s3Parts[o];s&&(s.awsRequest.abort(),t&&(s.status=R),O(e.partsInProcess,s.part),e.partsToUpload.length&&e.evaporatingCnt(-1))})},t.prototype.makeParts=function(t){function e(t){O(n.partsToUpload,t.part),O(n.partsInProcess,t.part),n.partsToUpload.length&&n.evaporatingCnt(-1)}function o(t){return function(){e(t),n.partsToUpload.length&&n.consumeRemainingSlots(),n.partsToUpload.length<n.con.maxConcurrentParts&&n.startNextFile("part resolve")}}function s(t){return function(){e(t)}}this.numParts=Math.ceil(this.sizeBytes/this.con.partSize)||1;for(var r=[],n=this,i=t?1:this.numParts,a=1;a<=i;a++){var u=this.s3Parts[a];if("undefined"!=typeof u){if(u.status===F)continue}else u=this.makePart(a,R,this.sizeBytes);u.awsRequest=new p(this,u),u.awsRequest.awsDeferred.promise.then(o(u),s(u)),this.partsToUpload.push(a),r.push(this.s3Parts[a].awsRequest.awsDeferred.promise)}return r},t.prototype.makePart=function(t,e,o){var s={status:e,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===o,md5_digest:null,part:t};return this.s3Parts[t]=s,s},t.prototype.setStatus=function(t){this.status=t},t.prototype.createUploadFile=function(){if(this.status!==E){var t=b(this),e={awsKey:this.name,bucket:this.con.bucket,uploadId:this.uploadId,fileSize:this.sizeBytes,fileType:this.file.type,lastModifiedDate:m(this.file.lastModified),partSize:this.con.partSize,signParams:this.con.signParams,createdAt:(new Date).toISOString()};T(t,e)}},t.prototype.updateUploadFile=function(t){var e=b(this),o=U(),s=Object.assign({},o[e],t);T(e,s)},t.prototype.completeUploadFile=function(t){var e=U(),o=e[b(this)];"undefined"!=typeof o&&(o.completedAt=(new Date).toISOString(),o.eTag=this.eTag,o.firstMd5Digest=this.firstMd5Digest,e[b(this)]=o,V.setItem("awsUploads",JSON.stringify(e))),this.complete(t,this.name,this.progessStats()),this.setStatus(F),this.onProgress()},t.prototype.removeUploadFile=function(){"undefined"!=typeof this.file&&x(b(this))},t.prototype.getUnfinishedFileUpload=function(){var t=U(!0),e=t[b(this)];this.canRetryUpload(e)&&(this.uploadId=e.uploadId,this.name=e.awsKey,this.eTag=e.eTag,this.firstMd5Digest=e.firstMd5Digest,this.signParams=e.signParams)},t.prototype.canRetryUpload=function(t){if("undefined"==typeof t)return!1;var e=new Date(t.completedAt||z);return this.con.partSize===t.partSize&&e>C&&this.con.bucket===t.bucket&&(!this.con.onlyRetryForSameFileName||this.name===t.awsKey)},t.prototype.partSuccess=function(t,e){var o=e.part;if(_.d(e.request.step,"ETag:",t),o.isEmpty||t!==N)return o.eTag=t,o.status=F,this.partsOnS3.push(o),!0;o.status=A,e.resetLoadedBytes();var s=["eTag matches MD5 of 0 length blob for part #",e.partNumber,"Retrying part."].join(" ");_.w(s),this.warn(s)},t.prototype.listPartsSuccess=function(t,e){this.info("uploadId",this.uploadId,"is not complete. Fetching parts from part marker",t.partNumberMarker);for(var o,s,r=w(e),n=r.getElementsByTagName("ListPartsResult")[0],i=r.getElementsByTagName("Part"),a=i.length,p=0;p<a;p++)o=i[p],s=parseInt(P(o,"Size"),10),this.fileTotalBytesUploaded+=s,this.partsOnS3.push({eTag:P(o,"ETag"),partNumber:parseInt(P(o,"PartNumber"),10),size:s,LastModified:P(o,"LastModified")});return n},t.prototype.makePartsfromPartsOnS3=function(){k.indexOf(this.status)!==-1&&(this.nameChanged(this.name),this.partsOnS3.forEach(function(t){var e=this.makePart(t.partNumber,F,t.size);e.eTag=t.eTag,e.loadedBytes=t.size,e.loadedBytesPrevious=t.size,e.finishedUploadingAt=t.LastModified}.bind(this)))},t.prototype.completeUpload=function(){var t=this;return new n(this).send().then(function(e){var o=w(e.responseText),s=o.getElementsByTagName("CompleteMultipartUploadResult")[0];t.eTag=P(s,"ETag"),t.completeUploadFile(e)})},t.prototype.getCompletedPayload=function(){var t=[];return t.push("<CompleteMultipartUpload>"),this.s3Parts.forEach(function(e,o){o>0&&["<Part><PartNumber>",o,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].forEach(function(e){t.push(e)})}),t.push("</CompleteMultipartUpload>"),t.join("")},t.prototype.consumeSlots=function(){if(0===this.partsToUpload.length)return-1;if(this.partsToUpload.length!==this.partsInProcess.length&&this.status===M){var t=Math.min(this.getRemainingSlots(),this.partsToUpload.length);if(!t)return-1;for(var e=0,o=0;o<this.partsToUpload.length;o++){var s=this.s3Parts[this.partsToUpload[o]];if(s.status!==M&&this.canStartPart(s)&&(this.partsInProcess.length&&this.partsToUpload.length>1&&this.evaporatingCnt(1),this.partsInProcess.push(s.part),this.startPartUpload(s.awsRequest),e+=1,e===t))break}var r=this.partsToUpload.length===this.partsInProcess.length,n=this.getRemainingSlots();return r&&n>0&&this.startNextFile("consume slots"),n}return 0},t.prototype.canStartPart=function(t){return this.partsInProcess.indexOf(t.part)===-1&&!t.awsRequest.errorExceptionStatus()},t.prototype.uploadFile=function(t){this.removeUploadFile();var e=this;return new r(e,t).send().then(function(){return e.partsToUpload=[],e.uploadParts().then(function(){},function(t){throw t})})},t.prototype.uploadParts=function(){if(this.loaded=0,this.totalUpoaded=0,k.indexOf(this.status)===-1)return Promise.reject("Part uploading stopped because the file was canceled");var t=this.makeParts();return this.setStatus(M),this.startTime=new Date,this.consumeSlots(),Promise.all(t)},t.prototype.abortUpload=function(){return new Promise(function(t,e){return"undefined"==typeof this.uploadId?void t():void new u(this).send().then(t,e)}.bind(this)).then(function(){this.setStatus(E),this.cancelled(),this.removeUploadFile()}.bind(this),this.deferredCompletion.reject.bind(this))},t.prototype.resumeInterruptedUpload=function(){return new a(this).send().then(this.uploadParts.bind(this))},t.prototype.reuseS3Object=function(t){function e(e){throw o.name=t,e}var o=this;this.makeParts(1),this.partsToUpload=[];var s=this.s3Parts[1];return s.awsRequest.getPartMd5Digest().then(function(){if(o.firstMd5Digest===o.s3Parts[1].md5_digest)return new i(o,t).send().then(function(t){_.d("headObject found matching object on S3."),o.completeUploadFile(t),o.nameChanged(o.name)}).catch(e);var s=o.con.allowS3ExistenceOptimization?"File's first part MD5 digest does not match what was stored.":"allowS3ExistenceOptimization is not enabled.";e(s)})},e.prototype.fileUpload=void 0,e.prototype.con=void 0,e.prototype.awsUrl=void 0,e.prototype.awsHost=void 0,e.prototype.authorize=function(){},e.prototype.localTimeOffset=0,e.prototype.awsDeferred=void 0,e.prototype.started=void 0,e.prototype.getPath=function(){var t="/"+this.con.bucket+"/"+this.fileUpload.name;return(this.con.cloudfront||this.awsUrl.indexOf("cloudfront")>-1)&&(t="/"+this.fileUpload.name),t},e.prototype.updateRequest=function(t){this.request=t;var e=d(this,_);this.signer=new e(t,this.getPayload())},e.prototype.success=function(){return!0},e.prototype.backOffWait=function(){return 1===this.attempts?0:1e3*Math.min(this.con.maxRetryBackoffSecs,Math.pow(this.con.retryBackoffPower,this.attempts-2))},e.prototype.error=function(t){if(!this.errorExceptionStatus()&&(_.d(this.request.step,"error:",this.fileUpload.id,t),"undefined"==typeof this.errorHandler(t))){this.fileUpload.warn("Error in ",this.request.step,t),this.fileUpload.setStatus(A);var e=this,o=this.backOffWait();this.attempts+=1,setTimeout(function(){e.errorExceptionStatus()||e.trySend()},o)}},e.prototype.errorHandler=function(){},e.prototype.errorExceptionStatus=function(){return!1},e.prototype.getPayload=function(){return null},e.prototype.success_status=function(t){return t.status>=200&&t.status<=299||this.request.success404&&404===t.status},e.prototype.stringToSign=function(){return encodeURIComponent(this.signer.stringToSign())},e.prototype.signResponse=function(t,e,o){var s=this;return new Promise(function(r){return"function"==typeof s.con.signResponseHandler?s.con.signResponseHandler(t,e,o).then(r):void r(t)})},e.prototype.sendRequestToAWS=function(){var t=this;return new Promise(function(e,o){var s=new XMLHttpRequest;t.currentXhr=s;var r=t.getPayload(),n=[t.awsUrl,t.getPath(),t.request.path].join(""),i={};t.request.query_string&&(n+=t.request.query_string),S(i,t.request.not_signed_headers),S(i,t.request.x_amz_headers),s.onreadystatechange=function(){if(4===s.readyState)if(r&&_.d("  ###",r.size),t.success_status(s))t.request.response_match&&void 0===s.response.match(new RegExp(t.request.response_match))?o("AWS response does not match set pattern: "+t.request.response_match):e(s);else{var n=s.responseText?g(s):" ";n+="status:"+s.status,o(n)}},s.open(t.request.method,n),s.setRequestHeader("Authorization",t.signer.authorizationString());for(var a in i)i.hasOwnProperty(a)&&s.setRequestHeader(a,i[a]);t.signer.setHeaders(s),t.request.contentType&&s.setRequestHeader("Content-Type",t.request.contentType),t.request.md5_digest&&s.setRequestHeader("Content-MD5",t.request.md5_digest),s.onerror=function(t){var e=t.responseText?g(t):"transport error";o(e)},"function"==typeof t.request.onProgress&&(s.upload.onprogress=t.request.onProgress),s.send(r),setTimeout(function(){t.started.resolve("request sent "+t.request.step)},20)})},e.prototype.authorize=function(){return this.request.dateString=this.signer.dateString(this.localTimeOffset),this.request.x_amz_headers=S(this.request.x_amz_headers,{"x-amz-date":this.request.dateString}),l(this).authorize()},e.prototype.authorizationSuccess=function(t){_.d(this.request.step,"signature:",t),this.request.auth=t},e.prototype.trySend=function(){var t=this;return this.authorize().then(function(e){t.authorizationSuccess(e),t.fileUpload.status!==E&&t.sendRequestToAWS().then(function(e){t.success(e)&&t.awsDeferred.resolve(e)},t.error.bind(t))},t.error.bind(t))},e.prototype.send=function(){return this.trySend(),this.awsDeferred.promise},o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.errorExceptionStatus=function(){return[E,H].indexOf(this.fileUpload.status)>-1},s.prototype=Object.create(o.prototype),s.prototype.constructor=s,s.prototype.maxRetries=1,s.prototype.errorHandler=function(t){if(this.attempts>this.maxRetries){var e=["MaxRetries exceeded. Will re-upload file id ",this.fileUpload.id,", ",t].join("");return _.w(e),this.awsDeferred.reject(e),!0}},s.prototype.rejectedSuccess=function(){var t=Array.prototype.slice.call(arguments,1).join("");return this.awsDeferred.reject(t),
!1},r.prototype=Object.create(o.prototype),r.prototype.constructor=r,r.prototype.success=function(t){var e=t.response.match(new RegExp(this.request.response_match));return this.fileUpload.uploadId=e[1],this.fileUpload.awsKey=this.awsKey,_.d("InitiateMultipartUpload ID is",this.fileUpload.uploadId),this.fileUpload.createUploadFile(),!0},n.prototype=Object.create(o.prototype),n.prototype.constructor=n,n.prototype.getPayload=function(){return this.fileUpload.getCompletedPayload()},i.prototype=Object.create(s.prototype),i.prototype.constructor=i,i.prototype.awsKey=void 0,i.prototype.success=function(t){var e=t.getResponseHeader("Etag");return e===this.fileUpload.eTag||this.rejectedSuccess("uploadId ",this.fileUpload.id," found on S3 but the Etag doesn't match.")},a.prototype=Object.create(s.prototype),a.prototype.constructor=a,a.prototype.awsKey=void 0,a.prototype.partNumberMarker=0,a.prototype.setupRequest=function(t){var e=["setupRequest() for uploadId:",this.fileUpload.uploadId,"for part marker:",t].join(" ");_.d(e),this.fileUpload.info(e),this.awsKey=this.fileUpload.name,this.partNumberMarker=t;var o={method:"GET",path:["?uploadId=",this.fileUpload.uploadId].join(""),query_string:"&part-number-marker="+t,x_amz_headers:this.fileUpload.xAmzHeadersCommon,step:"get upload parts",success404:!0};return this.request=o,o},a.prototype.success=function(t){if(404===t.status)return this.rejectedSuccess("uploadId ",this.fileUpload.id," not found on S3.");var e=this.fileUpload.listPartsSuccess(this,t.responseText),o="true"===P(e,"IsTruncated");if(!o)return this.fileUpload.makePartsfromPartsOnS3(),!0;var s=this.setupRequest(P(e,"NextPartNumberMarker"));this.updateRequest(s),this.trySend()},p.prototype=Object.create(e.prototype),p.prototype.constructor=p,p.prototype.part=1,p.prototype.start=0,p.prototype.end=0,p.prototype.partNumber=void 0,p.prototype.getPartMd5Digest=function(){var t=this,e=this.part,o=new FileReader;return new Promise(function(s){t.con.computeContentMd5&&!e.md5_digest?(o.onloadend=function(){o=void 0;var e=t.con.cryptoMd5Method(this.result);1===t.partNumber&&t.con.computeContentMd5&&"undefined"==typeof t.fileUpload.firstMd5Digest&&(t.fileUpload.firstMd5Digest=e,t.fileUpload.updateUploadFile({firstMd5Digest:e})),s(e)},o.readAsArrayBuffer(y(t.fileUpload.file,t.start,t.end))):s(e.md5_digest)}).then(function(e){e&&(_.d(t.request.step,"MD5 digest:",e),t.request.md5_digest=e,t.part.md5_digest=e)})},p.prototype.sendRequestToAWS=function(){return this.stalledInterval=setInterval(this.stalledPartMonitor(),L),this.stalledPartMonitor(),e.prototype.sendRequestToAWS.call(this)},p.prototype.send=function(){if(this.part.status!==F&&[E,j,H].indexOf(this.fileUpload.status)===-1){_.d("uploadPart #",this.partNumber,1===this.attempts?"submitting":"retrying"),this.part.status=M,this.attempts+=1,this.part.loadedBytesPrevious=null;var t=this;return this.getPartMd5Digest().then(function(){_.d("Sending",t.request.step),e.prototype.send.call(t)})}},p.prototype.success=function(t){clearInterval(this.stalledInterval);var e=t.getResponseHeader("ETag");return this.fileUpload.partSuccess(e,this)},p.prototype.onProgress=function(t){if(t.loaded>0){var e=t.loaded-this.part.loadedBytes;e&&(this.part.loadedBytes=t.loaded,this.fileUpload.updateLoaded(e))}},p.prototype.stalledPartMonitor=function(){var t=this.part.loadedBytes,e=this;return function(){clearInterval(e.stalledInterval),[M,A,B,j].indexOf(e.fileUpload.status)===-1&&e.part.status!==E&&e.part.loadedBytes<this.size&&(t===e.part.loadedBytes?(_.w("Part stalled. Will abort and retry:",e.partNumber,decodeURIComponent(e.fileUpload.name)),e.abort(),e.errorExceptionStatus()||e.delaySend()):e.stalledInterval=setInterval(e.stalledPartMonitor(),L))}},p.prototype.resetLoadedBytes=function(){this.fileUpload.updateLoaded(-this.part.loadedBytes),this.part.loadedBytes=0,this.fileUpload.onProgress()},p.prototype.errorExceptionStatus=function(){return[H,E,j,B].indexOf(this.fileUpload.status)>-1},p.prototype.delaySend=function(){var t;this.part.status===A?(t=this.backOffWait(),this.attempts+=1):t=0,setTimeout(this.send.bind(this),t)},p.prototype.errorHandler=function(t){if(clearInterval(this.stalledInterval),t.match(/status:404/)){var e="404 error on part PUT. The part and the file will abort. "+t;return _.w(e),this.fileUpload.error(e),this.part.status=E,this.awsDeferred.reject(e),!0}return this.resetLoadedBytes(),this.part.status=A,this.errorExceptionStatus()||this.delaySend(),!0},p.prototype.abort=function(){this.currentXhr&&this.currentXhr.abort(),this.resetLoadedBytes(),this.attempts=1},p.size=0,p.prototype.getPayload=function(){var t=y(this.fileUpload.file,this.start,this.end);return _.d(this.partNumber,"payload bytes:",this.start,"->",this.end,", size:",t.size),this.part.isEmpty||0!==t.size||_.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),this.size=t.size,t},p.prototype.stalledInterval=-1,p.prototype.getStartedPromise=function(){return this.started.promise},u.prototype=Object.create(e.prototype),u.prototype.constructor=u,u.prototype.maxRetries=1,u.prototype.success=function(){return this.fileUpload.setStatus(E),!0},u.prototype.errorHandler=function(t){if(this.attempts>this.maxRetries){var e="Error aborting upload, Exceeded retries deleting the file upload: "+t;return _.w(e),this.fileUpload.error(e),this.awsDeferred.reject(e),!0}};var V={supported:function(){var t=!1;if("undefined"==typeof window)return t;if(!("localStorage"in window))return t;try{localStorage.setItem("___test","OK");var e=localStorage.getItem("___test");localStorage.removeItem("___test"),t="OK"===e}catch(e){return t}return t},getItem:function(t){if(this.supported())return localStorage.getItem(t)},setItem:function(t,e){if(this.supported())return localStorage.setItem(t,e)},clear:function(){if(this.supported())return localStorage.clear()},key:function(t){if(this.supported())return localStorage.key(t)},removeItem:function(t){if(this.supported())return localStorage.removeItem(t)}};_=I(),"undefined"!=typeof module&&module.exports?module.exports=K:"undefined"!=typeof window&&(window.Evaporate=K)}();
//# sourceMappingURL=evaporate.min.js.map