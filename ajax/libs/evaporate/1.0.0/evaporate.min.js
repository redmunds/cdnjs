!function(){function e(e,t,n){var r=e.slice?"slice":e.mozSlice?"mozSlice":"webkitSlice";return e[r](t,n)}var t=new Date("2060-10-22"),n=function(n){function r(){return{d:function(){},w:function(){},e:function(){}}}function o(e){var t=P.length;return P.push(new d(u({progress:function(){},complete:function(){},cancelled:function(){},info:function(){},warn:function(){},error:function(){}},e,{id:t,status:h,priority:0,onStatusChange:a,loadedBytes:0,sizeBytes:e.file.size,eTag:""}))),t}function a(){I.d("onFileUploadStatusChange"),i()}function s(){setTimeout(i,1)}function i(){I.d("processQueue   length: "+P.length);var e=-1,t=-1,n=!0;P.forEach(function(r,o){r.priority>t&&r.status==h&&(e=o,t=r.priority),r.status==y&&(n=!1)}),n&&e>=0&&P[e].start()}function d(n){function r(e){e!==v&&e!==S&&e!==w||(clearInterval(ee),clearInterval(te)),ne.status=e,ne.onStatusChange()}function o(){I.d("cancelAllRequests()");for(var e=1;e<re.length;e++)d(e,!0);A()}function a(){M.computeContentMd5&&ne.file.size>0?x():(F(),j())}function s(e){var t,n={method:"POST",path:Q()+"?uploads",step:"initiate",x_amz_headers:ne.xAmzHeadersAtInitiate,not_signed_headers:ne.notSignedHeadersAtInitiate},o=ne.status;ne.contentType&&(n.contentType=ne.contentType),n.onErr=function(n){t||ne.status===T||ne.status===w||(t=!0,I.d("onInitiateError for FileUpload "+ne.id),ne.warn("Error initiating upload"),r(S),n.abort(),setTimeout(function(){ne.status!==T&&ne.status!==w&&(ne.status=o,s(e))},q(se++)))},n.on200=function(t){var r=t.response.match(/<UploadId\>(.+)<\/UploadId\>/);r&&r[1]?(ne.uploadId=r[1],ne.awsKey=e,I.d("requester success. got uploadId "+ne.uploadId),D(),a()):n.onErr()},W(n),J(n),G()}function i(t){function n(e){var t=new DOMParser,n=t.parseFromString(e.responseText,"text/xml"),r=n.getElementsByTagName("Code"),o=n.getElementsByTagName("Message");return r=r.length?r[0].innerHTML:"",o=o.length?o[0].innerHTML:"",r.length?{code:r,msg:o}:{}}var r,o,a,s;s=re[t],s.status=y,ae++,s.loadedBytesPrevious=null,r=q(s.attempts++),I.d("uploadPart #"+t+"     will wait "+r+"ms to try"),a={method:"PUT",path:Q()+"?partNumber="+t+"&uploadId="+ne.uploadId,step:"upload #"+t,x_amz_headers:ne.xAmzHeadersAtUpload,md5_digest:s.md5_digest,attempts:s.attempts,part:s},a.onErr=function(e,r){if(ne.status!==w&&ne.status!==T){var a="problem uploading part #"+t+",   http status: "+e.status+",   hasErrored: "+!!o+",   part status: "+s.status+",   readyState: "+e.readyState+(r?",   isOnError":"");if(I.w(a),ne.warn(a),!o){if(o=!0,404==e.status){var i="404 error resulted in abortion of both this part and the entire file.";I.w(i+" Server response: "+e.response),ne.error(i),s.status=T,A()}else s.status=S,s.loadedBytes=0,awsResponse=n(e),awsResponse.code&&I.e('AWS Server response: code="'+awsResponse.code+'", message="'+awsResponse.msg+'"'),j();e.abort()}}},a.on200=function(e){var n,r=e.getResponseHeader("ETag");I.d("uploadPart 200 response for part #"+t+"     ETag: "+r),s.isEmpty||r!=E?(s.eTag=r,s.status=v):(s.status=S,s.loadedBytes=0,n="eTag matches MD5 of 0 length blob for part #"+t+"   Retrying part.",I.w(n),ne.warn(n)),j()},a.onProgress=function(e){s.loadedBytes=e.loaded},a.toSend=function(){var n=e(ne.file,s.start,s.end);return I.d("part # "+t+" (bytes "+s.start+" -> "+s.end+")  reported length: "+n.size),s.isEmpty||0!==n.size||I.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),n},a.onFailedAuth=function(e){var n="onFailedAuth for uploadPart #"+t+".   Will set status to ERROR";I.w(n),ne.warn(n),s.status=S,s.loadedBytes=0,j()},W(a),setTimeout(function(){ne.status!==T&&ne.status!==w&&(J(a),I.d("upload #",t,a))},r),s.uploader=a}function d(e,t){var n=re[e];n.currentXhr&&(t&&(n.currentXhr.onreadystatechange=function(){}),n.currentXhr.abort())}function z(){I.d("completeUpload"),ne.info("will attempt to complete upload");var e,t="<CompleteMultipartUpload>",n=ne.status;re.forEach(function(e,n){e&&(t+="<Part><PartNumber>"+n+"</PartNumber><ETag>"+e.eTag+"</ETag></Part>")}),t+="</CompleteMultipartUpload>";var o={method:"POST",contentType:"application/xml; charset=UTF-8",path:Q()+"?uploadId="+ne.uploadId,x_amz_headers:ne.xAmzHeadersAtComplete,step:"complete"};o.onErr=function(t){if(!e&&ne.status!==T&&ne.status!==w){e=!0;var o="Error completing upload.";I.w(o),ne.error(o),r(S),t.abort(),setTimeout(function(){ne.status!==T&&ne.status!==w&&(ne.status=n,z(),G())},q(ie++))}},o.on200=function(e){var t=l(e.responseText),n=t.getElementsByTagName("CompleteMultipartUploadResult")[0];ne.eTag=m(n,"ETag"),ne.complete(e,ne.name),H()},o.toSend=function(){return t},W(o),J(o)}function P(e){I.d("headObject"),ne.info("will attempt to verify existence of the file");var t={method:"HEAD",path:Q(),step:"head_object"};t.onErr=function(){var t="Error completing head object. Will re-upload file.";I.w(t),s(e)},t.on200=function(t){var n=t.getResponseHeader("Etag");n===ne.eTag?(I.d("headObject found matching object on S3."),ne.complete(t,ne.name),r(v),ne.progress(1)):(I.d("headObject not found on S3."),ne.name=e,s(e))},W(t),J(t)}function B(e){return function(){var t=ne.status;if(t!==S&&t!==w&&t!==T){var n=M.cryptoMd5Method.call(this,this.result);I.d(["part #",e.part," MD5 digest is ",n].join("")),e.md5_digest=n,1===e.part&&F(),delete e.reader,de+=1,j(),de===ue&&I.d("All parts have MD5 digests"),setTimeout(x,1500)}}}function x(){for(var t=1;t<=ue;t++){var n=re[t];if(n.status!==v&&null===n.md5_digest){if(t>1||"undefined"==typeof ne.firstMd5Digest){n.reader=new FileReader,n.reader.onloadend=B(n),n.reader.readAsArrayBuffer(e(ne.file,n.start,n.end));break}n.md5_digest=ne.firstMd5Digest,F(),j()}}}function A(){I.d("abortUpload"),ne.info("will attempt to abort the upload");var e={method:"DELETE",path:Q()+"?uploadId="+ne.uploadId,step:"abort",successStatus:204};e.onErr=function(){var e="Error aborting upload.";I.w(e),ne.error(e)},e.on200=function(){r(T),R()},W(e),J(e)}function R(){I.d("listParts"),ne.info("list parts");var e={method:"GET",path:Q()+"?uploadId="+ne.uploadId,step:"list"};e.onErr=function(e){if(404==e.status)O(),ne.info("upload canceled");else{var t="Error listing parts.";I.w(t),ne.error(t)}},e.on200=function(e){var t=l(e.responseText),n=t.getElementsByTagName("Part");n.length?(I.d("Parts still found after abort...waiting."),setTimeout(function(){A()},1e3)):ne.info("upload canceled")},W(e),J(e)}function U(e){I.d("getUploadParts() for uploadId starting at part # "+e),ne.info("getUploadParts() for uploadId starting at part # "+e);var t={method:"GET",path:Q()+"?uploadId="+ne.uploadId,query_string:"&part-number-marker="+e,step:"get upload parts"};t.onErr=function(t){if(404===t.status)ne.info(["uploadId ",ne.uploadId," does not exist."].join("")),O(),G(),D(),j();else{var n="Error listing parts for getUploadParts() starting at part # "+e;I.w(n),ne.error(n)}},t.on200=function(t){ne.info(["uploadId ",ne.uploadId," is not complete. Fetching parts from part marker=",e].join(""));for(var n,r,o=l(t.responseText),s=o.getElementsByTagName("ListPartsResult")[0],i="true"===m(s,"IsTruncated"),d=o.getElementsByTagName("Part"),u=d.length,p=0;p<u;p++)r=d[p],oe.push({eTag:m(r,"ETag"),partNumber:parseInt(m(r,"PartNumber")),size:parseInt(m(r,"Size")),LastModified:m(r,"LastModified")});if(o=d=null,i){var f=m(s,"NextPartNumberMarker");U(f)}else D(),oe.forEach(function(e){n=C(e.partNumber,v,e.size),n.eTag=e.eTag,n.attempts=1,n.loadedBytes=e.size,n.loadedBytesPrevious=e.size,n.finishedUploadingAt=e.LastModified,n.md5_digest="n/a",re[e.partNumber]=n}),G(),a();s=null},W(t),J(t)}function D(){ue=Math.ceil(ne.file.size/M.partSize)||1;for(var e=1;e<=ue;e++){var t="undefined"==typeof re[e]?h:re[e].status;t!==v&&(re[e]=C(e,h,ne.file.size))}}function C(e,t,n){return{status:t,start:(e-1)*M.partSize,end:e*M.partSize,attempts:0,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===n,md5_digest:null,part:e}}function F(){var e=f(ne),t={awsKey:ne.name,uploadId:ne.uploadId,fileSize:ne.file.size,fileType:ne.file.type,lastModifiedDate:ne.file.lastModifiedDate.toISOString(),partSize:M.partSize,createdAt:(new Date).toISOString()};M.computeContentMd5&&re.length&&"undefined"!=typeof re[1].md5_digest&&(t.firstMd5Digest=re[1].md5_digest),c(e,t)}function H(){var e=p(),t=e[f(ne)];t.completedAt=(new Date).toISOString(),t.eTag=ne.eTag,localStorage.setItem("awsUploads",JSON.stringify(e)),r(v),ne.progress(1)}function O(){"undefined"!=typeof ne.file&&g(f(ne))}function N(){var e=p(!0),t=e[f(ne)];k(t)&&(ne.uploadId=t.uploadId,ne.name=t.awsKey,ne.eTag=t.eTag,ne.firstMd5Digest=t.firstMd5Digest)}function k(e){if("undefined"==typeof e)return!1;var n=new Date(e.completedAt||t);return M.partSize===e.partSize&&n>_}function q(e){return 1===e?0:1e3*Math.min(M.maxRetryBackoffSecs,Math.pow(M.retryBackoffPower,e-2))}function j(){var e,t=0,n=!0,r=!1,o=[],a=[];if(ne.status!=y)return void ne.info("will not process parts list, as not currently evaporating");for(var s=0;s<re.length;s++){var d=re[s];if(d){if(M.computeContentMd5&&null===d.md5_digest)return;var u=!1;switch(o.push(d.status),d.status){case y:n=!1,t++,a.push(d.loadedBytes);break;case S:r=!0,u=!0;break;case h:u=!0}u&&(n=!1,t<M.maxConcurrentParts&&(i(s),t++))}}e=o.toString()+" // bytesLoaded: "+a.toString(),I.d("processPartsList()  anyPartHasErrored: "+r,e),(ae>=re.length-1||r)&&ne.info("part stati: "+e),n&&z()}function L(){ee=setInterval(function(){var e=0;re.forEach(function(t,n){e+=t.loadedBytes}),ne.progress(e/ne.sizeBytes)},M.progressIntervalMS)}function X(){te=setInterval(function(){I.d("monitorPartsProgress() "+Date()),re.forEach(function(e,t){var n;return e.status!=y?void I.d(t,"not evaporating "):null===e.loadedBytesPrevious?(I.d(t,"no previous "),void(e.loadedBytesPrevious=e.loadedBytes)):(n=e.loadedBytesPrevious<e.loadedBytes,M.simulateStalling&&4==t&&Math.random()<.25&&(n=!1),I.d(t,n?"moving. ":"stalled.",e.loadedBytesPrevious,e.loadedBytes),n||setTimeout(function(){ne.info("part #"+t+" stalled. will abort. "+e.loadedBytesPrevious+" "+e.loadedBytes),d(t)},0),void(e.loadedBytesPrevious=e.loadedBytes))})},12e4)}function G(){L(),X()}function W(e){if(I.d("setupRequest()",e),M.timeUrl){var t=new XMLHttpRequest;t.open("GET",M.timeUrl+"?requestTime="+(new Date).getTime(),!1),t.send(),e.dateString=t.responseText}else e.dateString=(new Date).toUTCString();e.x_amz_headers=u(e.x_amz_headers,{"x-amz-date":e.dateString}),e.onGotAuth=function(){if(Y(e))return void I.w("onGotAuth() step",e.step,"is already in progress. Returning.");var t=Z(e),n=e.toSend?e.toSend():null,r=b+e.path;e.query_string&&(r+=e.query_string);var o={},a=e.successStatus||200;u(o,e.not_signed_headers),u(o,e.x_amz_headers),M.simulateErrors&&1==e.attempts&&"upload #3"==e.step&&(I.d("simulating error by POST part #3 to invalid url"),r="https:///foo"),t.open(e.method,r),t.setRequestHeader("Authorization","AWS "+M.aws_key+":"+e.auth);for(var s in o)o.hasOwnProperty(s)&&t.setRequestHeader(s,o[s]);e.contentType&&t.setRequestHeader("Content-Type",e.contentType),e.md5_digest&&t.setRequestHeader("Content-MD5",e.md5_digest),t.onreadystatechange=function(){4==t.readyState&&(n&&I.d("  ### "+n.size),$(e),t.status==a?e.on200(t):e.onErr(t))},t.onerror=function(){$(e),e.onErr(t,!0)},"function"==typeof e.onProgress&&(t.upload.onprogress=function(t){e.onProgress(t)}),t.send(n)},e.onFailedAuth=e.onFailedAuth||function(t){ne.error("Error onFailedAuth for step: "+e.step),e.onErr(t)}}function J(e){if(I.d("authorizedSend() "+e.step),Y(e))return void I.w("authorizedSend() step",e.step,"is already in progress. Returning.");var t,n=Z(e),r=M.signerUrl+"?to_sign="+K(e);for(var o in ne.signParams)ne.signParams.hasOwnProperty(o)&&(r+=ne.signParams[o]instanceof Function?"&"+encodeURIComponent(o)+"="+encodeURIComponent(ne.signParams[o]()):"&"+encodeURIComponent(o)+"="+encodeURIComponent(ne.signParams[o]));n.onreadystatechange=function(){4==n.readyState&&(200==n.status&&28==n.response.length?(I.d("authorizedSend got signature for step: '"+e.step+"'    sig: "+n.response),e.auth=n.response,$(e),e.onGotAuth()):(t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+n.status+".  xhr.response: "+n.response,I.w(t),ne.warn(t),$(e),e.onFailedAuth(n)))},n.onerror=function(){t="failed to get authorization (onerror) for "+e.step+".  xhr.status: "+n.status+".  xhr.response: "+n.response,I.w(t),ne.warn(t),e.onFailedAuth(n)},n.open("GET",r);for(var a in ne.signHeaders)ne.signHeaders.hasOwnProperty(a)&&(ne.signHeaders[a]instanceof Function?n.setRequestHeader(a,ne.signHeaders[a]()):n.setRequestHeader(a,ne.signHeaders[a]));ne.beforeSigner instanceof Function&&ne.beforeSigner(n),n.send()}function K(e){var t,n="",r=[];for(var o in e.x_amz_headers)e.x_amz_headers.hasOwnProperty(o)&&r.push(o);return r.sort(),r.forEach(function(t,r){n+=t+":"+e.x_amz_headers[t]+"\n"}),t=e.method+"\n"+(e.md5_digest||"")+"\n"+(e.contentType||"")+"\n\n"+n+(M.cloudfront?"/"+M.bucket:"")+e.path,encodeURIComponent(t)}function Q(){var e="/"+M.bucket+"/"+ne.name;return(M.cloudfront||b.indexOf("cloudfront")>-1)&&(e="/"+ne.name),e}function V(e){return"undefined"==typeof e.part?e:e.part}function Y(e){return!!V(e).currentXhr}function Z(e){return V(e).currentXhr=new XMLHttpRequest}function $(e){delete V(e).currentXhr}var ee,te,ne=this,re=[],oe=[],ae=0,se=0,ie=0;u(ne,n),ne.start=function(){I.d("starting FileUpload "+ne.id),r(y);var t=ne.name;if(N(),"undefined"==typeof ne.uploadId)s(t);else if("undefined"!=typeof ne.eTag&&ne.firstMd5Digest){var n=new FileReader;n.onloadend=function(){var e=M.cryptoMd5Method.call(this,this.result);M.allowS3ExistenceOptimization&&ne.firstMd5Digest===e?P(t):(ne.firstMd5Digest=e,s(t))},n.readAsArrayBuffer(e(ne.file,0,M.partSize))}else U(0)},ne.stop=function(){I.d("stopping FileUpload ",ne.id),ne.cancelled(),r(w),ne.info("Canceling uploads..."),o()};var de=0,ue=-1}function u(e,t,n){if("undefined"==typeof e&&(e={}),"object"==typeof n)for(var r in n)t[r]=n[r];for(var o in t)e[o]=t[o];return e}function l(e){var t=new DOMParser;return t.parseFromString(e,"text/xml")}function p(e){var n=JSON.parse(localStorage.getItem("awsUploads")||"{}");if(e)for(var r in n)if(n.hasOwnProperty(r)){var o=n[r],a=new Date(o.completedAt||t);a<_&&delete n[r]}return n}function f(e){return[e.file.name,e.file.type,e.file.lastModifiedDate.toISOString(),e.file.size].join("-")}function c(e,t){var n=p();n[e]=t,localStorage.setItem("awsUploads",JSON.stringify(n))}function g(e){var t=p();delete t[e],localStorage.setItem("awsUploads",JSON.stringify(t))}function m(e,t){return e.getElementsByTagName(t)[0].childNodes[0].nodeValue}var h=0,y=2,v=3,w=5,S=10,T=20,b=n.aws_url||"https://s3.amazonaws.com",E='"d41d8cd98f00b204e9800998ecf8427e"',z=this,P=[],I=r(),M=u({logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:500,cloudfront:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,s3FileCacheHoursAgo:null},n);if(console&&console.log&&(I=console,I.d=I.log,console.warn?I.w=I.warn:I.w=I.log,console.error?I.e=I.error:I.e=I.log),this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)||n.testUnsupported),!this.supported)return void I.e("The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]");if(M.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return void I.e("The browser's FileReader object does not support readAsArrayBuffer");if("function"!=typeof M.cryptoMd5Method)return void I.e("Option computeContentMd5 has been set but cryptoMd5Method is not defined.")}M.logging||(I=r());var B=new Date,_=new Date(B.setHours(B.getHours()-(M.s3FileCacheHoursAgo||-100)));z.add=function(e){I.d("add");var t;if("undefined"==typeof e)return"Missing file";if("undefined"==typeof e.name?t="Missing attribute: name  ":M.encodeFilename&&(e.name=encodeURIComponent(e.name)),t)return t;var n=o(e);return s(),n},z.cancel=function(e){return I.d("cancel ",e),!!P[e]&&(P[e].stop(),!0)},z.pause=function(e){},z.resume=function(e){},z.forceRetry=function(){}};"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof window&&(window.Evaporate=n)}();
//# sourceMappingURL=evaporate.min.js.map