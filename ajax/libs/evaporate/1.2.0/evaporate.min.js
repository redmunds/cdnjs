!function(){function e(e){return e?e.toISOString():""}function t(e,t,r){var n=e.slice?"slice":e.mozSlice?"mozSlice":"webkitSlice";return e[n](t,r)}var r=new Date("2060-10-22"),n=function(n){function o(){return{d:function(){},w:function(){},e:function(){}}}function a(e){var t=P.length;return P.push(new u(l({progress:function(){},complete:function(){},cancelled:function(){},info:function(){},warn:function(){},error:function(){}},e,{id:t,status:y,priority:0,onStatusChange:s,loadedBytes:0,sizeBytes:e.file.size,eTag:""}))),t}function s(){M.d("onFileUploadStatusChange"),d()}function i(){setTimeout(d,1)}function d(){M.d("processQueue   length: "+P.length);var e=-1,t=-1,r=!0;P.forEach(function(n,o){n.priority>t&&n.status===y&&(e=o,t=n.priority),n.status===v&&(r=!1)}),r&&e>=0&&P[e].start()}function u(n){function o(e){e!==w&&e!==T&&e!==S||(clearInterval(ae),clearInterval(se)),ie.status=e,ie.onStatusChange()}function a(){M.d("cancelAllRequests()");for(var e=1;e<de.length;e++)u(e,!0);R()}function s(){_.computeContentMd5&&ie.file.size>0?U():(H(),X())}function i(e){var t,r={method:"POST",path:ee()+"?uploads",step:"initiate",x_amz_headers:ie.xAmzHeadersAtInitiate,not_signed_headers:ie.notSignedHeadersAtInitiate},n=ie.status;ie.contentType&&(r.contentType=ie.contentType),r.onErr=function(r){t||ie.status===b||ie.status===S||(t=!0,M.d("onInitiateError for FileUpload "+ie.id),ie.warn("Error initiating upload"),o(T),r.abort(),setTimeout(function(){ie.status!==b&&ie.status!==S&&(ie.status=n,i(e))},G(pe++)))},r.on200=function(t){var n=t.response.match(/<UploadId>(.+)<\/UploadId>/);n&&n[1]?(ie.uploadId=n[1],ie.awsKey=e,M.d("requester success. got uploadId "+ie.uploadId),C(),s()):r.onErr()},Q(r),V(r),W()}function d(e){function r(e){var t=new DOMParser,r=t.parseFromString(e.responseText,"text/xml"),n=r.getElementsByTagName("Code"),o=r.getElementsByTagName("Message");return n=n.length?n[0].innerHTML:"",o=o.length?o[0].innerHTML:"",n.length?{code:n,msg:o}:{}}var n,o,a,s;s=de[e],s.status=v,le++,s.loadedBytesPrevious=null,n=G(s.attempts++),M.d("uploadPart #"+e+"     will wait "+n+"ms to try"),a={method:"PUT",path:ee()+"?partNumber="+e+"&uploadId="+ie.uploadId,step:"upload #"+e,x_amz_headers:ie.xAmzHeadersAtUpload,md5_digest:s.md5_digest,attempts:s.attempts,part:s},a.onErr=function(t,n){if(ie.status!==S&&ie.status!==b){var a="problem uploading part #"+e+",   http status: "+t.status+",   hasErrored: "+!!o+",   part status: "+s.status+",   readyState: "+t.readyState+(n?",   isOnError":"");if(M.w(a),ie.warn(a),!o){if(o=!0,404===t.status){var i="404 error resulted in abortion of both this part and the entire file.";M.w(i+" Server response: "+t.response),ie.error(i),s.status=b,R()}else{s.status=T,s.loadedBytes=0;var d=r(t);d.code&&M.e('AWS Server response: code="'+d.code+'", message="'+d.msg+'"'),X()}t.abort()}}},a.on200=function(t){var r,n=t.getResponseHeader("ETag");M.d("uploadPart 200 response for part #"+e+"     ETag: "+n),s.isEmpty||n!==E?(s.eTag=n,s.status=w):(s.status=T,s.loadedBytes=0,r="eTag matches MD5 of 0 length blob for part #"+e+"   Retrying part.",M.w(r),ie.warn(r)),X()},a.onProgress=function(e){s.loadedBytes=e.loaded},a.toSend=function(){var r=t(ie.file,s.start,s.end);return M.d("part # "+e+" (bytes "+s.start+" -> "+s.end+")  reported length: "+r.size),s.isEmpty||0!==r.size||M.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),r},a.onFailedAuth=function(){var t="onFailedAuth for uploadPart #"+e+".   Will set status to ERROR";M.w(t),ie.warn(t),s.status=T,s.loadedBytes=0,X()},Q(a),setTimeout(function(){ie.status!==b&&ie.status!==S&&(V(a),M.d("upload #",e,a))},n),s.uploader=a}function u(e,t){var r=de[e];r.currentXhr&&(t&&(r.currentXhr.onreadystatechange=function(){}),r.currentXhr.abort())}function I(){M.d("completeUpload"),ie.info("will attempt to complete upload");var e,t=[],r=ie.status;t.push("<CompleteMultipartUpload>"),de.forEach(function(e,r){e&&t.push(["<Part><PartNumber>",r,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].join(""))}),t.push("</CompleteMultipartUpload>");var n={method:"POST",contentType:"application/xml; charset=UTF-8",path:ee()+"?uploadId="+ie.uploadId,x_amz_headers:ie.xAmzHeadersAtComplete,step:"complete"};n.onErr=function(t){if(!e&&ie.status!==b&&ie.status!==S){e=!0;var n="Error completing upload.";M.w(n),ie.error(n),o(T),t.abort(),setTimeout(function(){ie.status!==b&&ie.status!==S&&(ie.status=r,I(),W())},G(fe++))}},n.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("CompleteMultipartUploadResult")[0];ie.eTag=h(r,"ETag"),ie.complete(e,ie.name),k()},n.toSend=function(){return t.join("")},Q(n),V(n)}function P(e){M.d("headObject"),ie.info("will attempt to verify existence of the file");var t={method:"HEAD",path:ee(),step:"head_object"};t.onErr=function(){var t="Error completing head object. Will re-upload file.";M.w(t),i(e)},t.on200=function(t){var r=t.getResponseHeader("Etag");r===ie.eTag?(M.d("headObject found matching object on S3."),ie.progress(1),ie.complete(t,ie.name),o(w)):(M.d("headObject not found on S3."),i(e))},Q(t),V(t)}function B(e){return function(){var t=ie.status;if(t!==T&&t!==S&&t!==b){var r=_.cryptoMd5Method.call(this,this.result);M.d(["part #",e.part," MD5 digest is ",r].join("")),e.md5_digest=r,1===e.part&&H(),delete e.reader,ce+=1,X(),ce===me&&M.d("All parts have MD5 digests"),setTimeout(U,1500)}}}function U(){for(var e=1;e<=me;e++){var r=de[e];if(r.status!==w&&null===r.md5_digest){if(e>1||"undefined"==typeof ie.firstMd5Digest){r.reader=new FileReader,r.reader.onloadend=B(r),r.reader.readAsArrayBuffer(t(ie.file,r.start,r.end));break}r.md5_digest=ie.firstMd5Digest,H(),X()}}}function R(){M.d("abortUpload"),ie.info("will attempt to abort the upload");var e={method:"DELETE",path:ee()+"?uploadId="+ie.uploadId,step:"abort",successStatus:204};e.onErr=function(){var e="Error aborting upload.";M.w(e),ie.error(e)},e.on200=function(){o(b),D()},Q(e),V(e)}function D(){M.d("listParts"),ie.info("list parts");var e={method:"GET",path:ee()+"?uploadId="+ie.uploadId,step:"list"};e.onErr=function(e){if(404===e.status)L(),ie.info("upload canceled");else{var t="Error listing parts.";M.w(t),ie.error(t)}},e.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("Part");r.length?(M.d("Parts still found after abort...waiting."),setTimeout(function(){R()},1e3)):ie.info("upload canceled")},Q(e),V(e)}function O(e){M.d("getUploadParts() for uploadId starting at part # "+e),ie.info("getUploadParts() for uploadId starting at part # "+e);var t={method:"GET",path:ee()+"?uploadId="+ie.uploadId,query_string:"&part-number-marker="+e,step:"get upload parts"};t.onErr=function(t){if(404===t.status)ie.info(["uploadId ",ie.uploadId," does not exist."].join("")),L(),W(),C(),X();else{var r="Error listing parts for getUploadParts() starting at part # "+e;M.w(r),ie.error(r)}},t.on200=function(t){ie.info(["uploadId ",ie.uploadId," is not complete. Fetching parts from part marker=",e].join(""));for(var r,n,o=p(t.responseText),a=o.getElementsByTagName("ListPartsResult")[0],i="true"===h(a,"IsTruncated"),d=o.getElementsByTagName("Part"),u=d.length,l=0;l<u;l++)n=d[l],ue.push({eTag:h(n,"ETag"),partNumber:parseInt(h(n,"PartNumber")),size:parseInt(h(n,"Size")),LastModified:h(n,"LastModified")});if(o=d=null,i){var f=h(a,"NextPartNumberMarker");O(f)}else C(),ue.forEach(function(e){r=N(e.partNumber,w,e.size),r.eTag=e.eTag,r.attempts=1,r.loadedBytes=e.size,r.loadedBytesPrevious=e.size,r.finishedUploadingAt=e.LastModified,r.md5_digest="n/a",de[e.partNumber]=r}),W(),s();a=null},Q(t),V(t)}function C(){me=Math.ceil(ie.file.size/_.partSize)||1;for(var e=1;e<=me;e++){var t="undefined"==typeof de[e]?y:de[e].status;t!==w&&(de[e]=N(e,y,ie.file.size))}}function N(e,t,r){return{status:t,start:(e-1)*_.partSize,end:e*_.partSize,attempts:0,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,part:e}}function H(){var t=c(ie),r={awsKey:ie.name,bucket:_.bucket,uploadId:ie.uploadId,fileSize:ie.file.size,fileType:ie.file.type,lastModifiedDate:e(ie.file.lastModifiedDate),partSize:_.partSize,signParams:ie.signParams,createdAt:(new Date).toISOString()};_.computeContentMd5&&de.length&&"undefined"!=typeof de[1].md5_digest&&(r.firstMd5Digest=de[1].md5_digest),m(t,r)}function k(){var e=f(),t=e[c(ie)];"undefined"!=typeof t&&(t.completedAt=(new Date).toISOString(),t.eTag=ie.eTag,x.setItem("awsUploads",JSON.stringify(e))),o(w),ie.progress(1)}function L(){"undefined"!=typeof ie.file&&g(c(ie))}function q(){var e=f(!0),t=e[c(ie)];j(t)&&(ie.uploadId=t.uploadId,ie.name=t.awsKey,ie.eTag=t.eTag,ie.firstMd5Digest=t.firstMd5Digest,ie.signParams=t.signParams)}function j(e){if("undefined"==typeof e)return!1;var t=new Date(e.completedAt||r);return _.partSize===e.partSize&&t>A&&_.bucket===e.bucket&&(!_.onlyRetryForSameFileName||ie.name===e.awsKey)}function G(e){return 1===e?0:1e3*Math.min(_.maxRetryBackoffSecs,Math.pow(_.retryBackoffPower,e-2))}function X(){var e,t=0,r=!0,n=!1,o=[],a=[];if(ie.status!==v)return void ie.info("will not process parts list, as not currently evaporating");for(var s=0;s<de.length;s++){var i=de[s];if(i){if(_.computeContentMd5&&null===i.md5_digest)return;var u=!1;switch(o.push(i.status),i.status){case v:r=!1,t++,a.push(i.loadedBytes);break;case T:n=!0,u=!0;break;case y:u=!0}u&&(r=!1,t<_.maxConcurrentParts&&(d(s),t++))}}e=o.toString()+" // bytesLoaded: "+a.toString(),M.d("processPartsList()  anyPartHasErrored: "+n,e),(le>=de.length-1||n)&&ie.info("part stati: "+e),r&&I()}function J(){ae=setInterval(function(){var e=0;de.forEach(function(t){e+=t.loadedBytes}),ie.progress(e/ie.sizeBytes)},_.progressIntervalMS)}function K(){se=setInterval(function(){M.d("monitorPartsProgress() "+new Date),de.forEach(function(e,t){var r;return e.status!==v?void M.d(t,"not evaporating "):null===e.loadedBytesPrevious?(M.d(t,"no previous "),void(e.loadedBytesPrevious=e.loadedBytes)):(r=e.loadedBytesPrevious<e.loadedBytes,_.simulateStalling&&4===t&&Math.random()<.25&&(r=!1),M.d(t,r?"moving. ":"stalled.",e.loadedBytesPrevious,e.loadedBytes),r||setTimeout(function(){ie.info("part #"+t+" stalled. will abort. "+e.loadedBytesPrevious+" "+e.loadedBytes),u(t)},0),void(e.loadedBytesPrevious=e.loadedBytes))})},12e4)}function W(){J(),K()}function Q(e){M.d("setupRequest()",e),_.timeUrl?e.dateString=new Date((new Date).getTime()+F).toUTCString():e.dateString=(new Date).toUTCString(),e.x_amz_headers=l(e.x_amz_headers,{"x-amz-date":e.dateString}),e.onGotAuth=function(){if(re(e))return void M.w("onGotAuth() step",e.step,"is already in progress. Returning.");var t=ne(e),r=e.toSend?e.toSend():null,n=z+e.path;e.query_string&&(n+=e.query_string);var o={},a=e.successStatus||200;l(o,e.not_signed_headers),l(o,e.x_amz_headers),_.simulateErrors&&1===e.attempts&&"upload #3"===e.step&&(M.d("simulating error by POST part #3 to invalid url"),n="https:///foo"),t.open(e.method,n),t.setRequestHeader("Authorization","AWS "+_.aws_key+":"+e.auth);for(var s in o)o.hasOwnProperty(s)&&t.setRequestHeader(s,o[s]);e.contentType&&t.setRequestHeader("Content-Type",e.contentType),e.md5_digest&&t.setRequestHeader("Content-MD5",e.md5_digest),t.onreadystatechange=function(){4===t.readyState&&(r&&M.d("  ### "+r.size),oe(e),t.status===a?e.on200(t):e.onErr(t))},t.onerror=function(){oe(e),e.onErr(t,!0)},"function"==typeof e.onProgress&&(t.upload.onprogress=function(t){e.onProgress(t)}),t.send(r)},e.onFailedAuth=e.onFailedAuth||function(t){ie.error("Error onFailedAuth for step: "+e.step),e.onErr(t)}}function V(e){if(M.d("authorizedSend() "+e.step),re(e))return void M.w("authorizedSend() step",e.step,"is already in progress. Returning.");if(_.awsLambda)return Y(e);var t,r=ne(e),n=_.signerUrl+"?to_sign="+encodeURIComponent($(e)),o=Z(ie.signParams);for(var a in o)o.hasOwnProperty(a)&&(n+="&"+encodeURIComponent(a)+"="+encodeURIComponent(o[a]));r.onreadystatechange=function(){4===r.readyState&&(200===r.status&&28===r.response.length?(M.d("authorizedSend got signature for step: '"+e.step+"'    sig: "+r.response),e.auth=r.response,oe(e),e.onGotAuth()):(t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,M.w(t),ie.warn(t),oe(e),e.onFailedAuth(r)))},r.onerror=function(){t="failed to get authorization (onerror) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,M.w(t),ie.warn(t),e.onFailedAuth(r)},r.open("GET",n);var s=Z(ie.signHeaders);for(var i in s)s.hasOwnProperty(i)&&r.setRequestHeader(i,s[i]);"function"==typeof ie.beforeSigner&&ie.beforeSigner(r,n),r.send()}function Y(e){_.awsLambda.invoke({FunctionName:_.awsLambdaFunction,InvocationType:"RequestResponse",Payload:JSON.stringify({to_sign:$(e),sign_params:Z(ie.signParams),sign_headers:Z(ie.signHeaders)})},function(t,r){if(t){var n="failed to get authorization with lambda "+t;return M.w(n),ie.warn(n),void e.onFailedAuth(t)}e.auth=JSON.parse(r.Payload),e.onGotAuth()})}function Z(e){var t={};for(var r in e)e.hasOwnProperty(r)&&("function"==typeof e[r]?t[r]=e[r]():t[r]=e[r]);return t}function $(e){var t,r="",n=[];for(var o in e.x_amz_headers)e.x_amz_headers.hasOwnProperty(o)&&n.push(o);return n.sort(),n.forEach(function(t){r+=t+":"+e.x_amz_headers[t]+"\n"}),t=e.method+"\n"+(e.md5_digest||"")+"\n"+(e.contentType||"")+"\n\n"+r+(_.cloudfront?"/"+_.bucket:"")+e.path}function ee(){var e="/"+_.bucket+"/"+ie.name;return(_.cloudfront||z.indexOf("cloudfront")>-1)&&(e="/"+ie.name),e}function te(e){return"undefined"==typeof e.part?e:e.part}function re(e){return!!te(e).currentXhr}function ne(e){return te(e).currentXhr=new XMLHttpRequest}function oe(e){delete te(e).currentXhr}var ae,se,ie=this,de=[],ue=[],le=0,pe=0,fe=0;l(ie,n),ie.start=function(){M.d("starting FileUpload "+ie.id),o(v);var e=ie.name;if(q(),"undefined"==typeof ie.uploadId)i(e);else if("undefined"!=typeof ie.eTag&&ie.firstMd5Digest){var r=new FileReader;r.onloadend=function(){var t=_.cryptoMd5Method.call(this,this.result);_.allowS3ExistenceOptimization&&ie.firstMd5Digest===t?P(e):(ie.firstMd5Digest=t,i(e))},r.readAsArrayBuffer(t(ie.file,0,_.partSize))}else O(0)},ie.stop=function(){M.d("stopping FileUpload ",ie.id),ie.cancelled(),o(S),ie.info("Canceling uploads..."),a()};var ce=0,me=-1}function l(e,t,r){if(e="undefined"==typeof e?{}:e,"object"==typeof r)for(var n in r)t[n]=r[n];for(var o in t)e[o]=t[o];return e}function p(e){var t=new DOMParser;return t.parseFromString(e,"text/xml")}function f(e){var t=JSON.parse(x.getItem("awsUploads")||"{}");if(e)for(var n in t)if(t.hasOwnProperty(n)){var o=t[n],a=new Date(o.completedAt||r);a<A&&delete t[n]}return t}function c(t){return[t.file.name,t.file.type,e(t.file.lastModifiedDate),t.file.size].join("-")}function m(e,t){var r=f();r[e]=t,x.setItem("awsUploads",JSON.stringify(r))}function g(e){var t=f();delete t[e],x.setItem("awsUploads",JSON.stringify(t))}function h(e,t){return e.getElementsByTagName(t)[0].textContent}var y=0,v=2,w=3,S=5,T=10,b=20,z=n.aws_url||"https://s3.amazonaws.com",E='"d41d8cd98f00b204e9800998ecf8427e"',I=this,P=[],M=o(),_=l({logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:500,cloudfront:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,onlyRetryForSameFileName:!1,timeUrl:null,cryptoMd5Method:null,s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},awsLambda:null,awsLambdaFunction:null,maxFileSize:null,testUnsupported:!1,simulateStalling:!1,simulateErrors:!1},n);if(console&&console.log&&(M=console,M.d=M.log,M.w=console.warn?M.warn:M.d,M.e=console.error?M.error:M.d),this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)||n.testUnsupported),!this.supported)return void M.e("The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]");if(_.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return void M.e("The browser's FileReader object does not support readAsArrayBuffer");if("function"!=typeof _.cryptoMd5Method)return void M.e("Option computeContentMd5 has been set but cryptoMd5Method is not defined.")}_.logging||(M=o());var x={supported:function(){var e=!1;if("undefined"==typeof window)return e;if(!("localStorage"in window))return e;try{localStorage.setItem("___test","OK");var t=localStorage.getItem("___test");localStorage.removeItem("___test"),e="OK"===t}catch(t){return e}return e}(),getItem:function(e){if(this.supported)return localStorage.getItem(e)},setItem:function(e,t){if(this.supported)return localStorage.setItem(e,t)},clear:function(){if(this.supported)return localStorage.clear()},key:function(e){if(this.supported)return localStorage.key(e)},removeItem:function(e){if(this.supported)return localStorage.removeItem(e)}},B=new Date,A=new Date(B.setHours(B.getHours()-(_.s3FileCacheHoursAgo||-100))),F=0;if(_.timeUrl){var U=new XMLHttpRequest;U.open("GET",_.timeUrl+"?requestTime="+(new Date).getTime()),U.onreadystatechange=function(){if(4===U.readyState&&200===U.status){var e=new Date(Date.parse(U.responseText)),t=new Date;F=t-e,M.d("localTimeOsset is",F,"ms")}},U.onerror=function(){M.e("xhr error timeUrl",U)},U.send()}I.add=function(e){M.d("add");var t;if("undefined"==typeof e)return"Missing file";if(_.maxFileSize&&e.size>_.maxFileSize)return"File size too large. Maximum size allowed is "+_.maxFileSize;if("undefined"==typeof e.name?t="Missing attribute: name  ":_.encodeFilename&&(e.name=encodeURIComponent(e.name)),t)return t;var r=a(e);return i(),r},I.cancel=function(e){return M.d("cancel ",e),!!P[e]&&(P[e].stop(),!0)},I.pause=function(e){},I.resume=function(e){},I.forceRetry=function(){}};"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof window&&(window.Evaporate=n)}();
//# sourceMappingURL=evaporate.min.js.map