!function(){function e(e){return e?e.toISOString():""}function t(e,t,r){var n=e.slice?"slice":e.mozSlice?"mozSlice":"webkitSlice";return e[n](t,r)}var r=new Date("2060-10-22"),n={supported:function(){var e=!1;if(!("localStorage"in window))return e;try{localStorage.setItem("___test","OK");var t=localStorage.getItem("___test");localStorage.removeItem("___test"),e="OK"===t}catch(t){return e}return e}(),getItem:function(e){if(this.supported)return localStorage.getItem(e)},setItem:function(e,t){if(this.supported)return localStorage.setItem(e,t)},clear:function(){if(this.supported)return localStorage.clear()},key:function(e){if(this.supported)return localStorage.key(e)},removeItem:function(e){if(this.supported)return localStorage.removeItem(e)}},o=function(o){function a(){return{d:function(){},w:function(){},e:function(){}}}function s(e){var t=M.length;return M.push(new l(p({progress:function(){},complete:function(){},cancelled:function(){},info:function(){},warn:function(){},error:function(){}},e,{id:t,status:v,priority:0,onStatusChange:i,loadedBytes:0,sizeBytes:e.file.size,eTag:""}))),t}function i(){_.d("onFileUploadStatusChange"),u()}function d(){setTimeout(u,1)}function u(){_.d("processQueue   length: "+M.length);var e=-1,t=-1,r=!0;M.forEach(function(n,o){n.priority>t&&n.status==v&&(e=o,t=n.priority),n.status==w&&(r=!1)}),r&&e>=0&&M[e].start()}function l(o){function a(e){e!==S&&e!==I&&e!==T||(clearInterval(re),clearInterval(ne)),oe.status=e,oe.onStatusChange()}function s(){_.d("cancelAllRequests()");for(var e=1;e<ae.length;e++)l(e,!0);U()}function i(){B.computeContentMd5&&oe.file.size>0?R():(H(),X())}function d(e){var t,r={method:"POST",path:Y()+"?uploads",step:"initiate",x_amz_headers:oe.xAmzHeadersAtInitiate,not_signed_headers:oe.notSignedHeadersAtInitiate},n=oe.status;oe.contentType&&(r.contentType=oe.contentType),r.onErr=function(r){t||oe.status===b||oe.status===T||(t=!0,_.d("onInitiateError for FileUpload "+oe.id),oe.warn("Error initiating upload"),a(I),r.abort(),setTimeout(function(){oe.status!==b&&oe.status!==T&&(oe.status=n,d(e))},L(de++)))},r.on200=function(t){var n=t.response.match(/<UploadId\>(.+)<\/UploadId\>/);n&&n[1]?(oe.uploadId=n[1],oe.awsKey=e,_.d("requester success. got uploadId "+oe.uploadId),F(),i()):r.onErr()},J(r),Q(r),K()}function u(e){function r(e){var t=new DOMParser,r=t.parseFromString(e.responseText,"text/xml"),n=r.getElementsByTagName("Code"),o=r.getElementsByTagName("Message");return n=n.length?n[0].innerHTML:"",o=o.length?o[0].innerHTML:"",n.length?{code:n,msg:o}:{}}var n,o,a,s;s=ae[e],s.status=w,ie++,s.loadedBytesPrevious=null,n=L(s.attempts++),_.d("uploadPart #"+e+"     will wait "+n+"ms to try"),a={method:"PUT",path:Y()+"?partNumber="+e+"&uploadId="+oe.uploadId,step:"upload #"+e,x_amz_headers:oe.xAmzHeadersAtUpload,md5_digest:s.md5_digest,attempts:s.attempts,part:s},a.onErr=function(t,n){if(oe.status!==T&&oe.status!==b){var a="problem uploading part #"+e+",   http status: "+t.status+",   hasErrored: "+!!o+",   part status: "+s.status+",   readyState: "+t.readyState+(n?",   isOnError":"");if(_.w(a),oe.warn(a),!o){if(o=!0,404==t.status){var i="404 error resulted in abortion of both this part and the entire file.";_.w(i+" Server response: "+t.response),oe.error(i),s.status=b,U()}else s.status=I,s.loadedBytes=0,awsResponse=r(t),awsResponse.code&&_.e('AWS Server response: code="'+awsResponse.code+'", message="'+awsResponse.msg+'"'),X();t.abort()}}},a.on200=function(t){var r,n=t.getResponseHeader("ETag");_.d("uploadPart 200 response for part #"+e+"     ETag: "+n),s.isEmpty||n!=P?(s.eTag=n,s.status=S):(s.status=I,s.loadedBytes=0,r="eTag matches MD5 of 0 length blob for part #"+e+"   Retrying part.",_.w(r),oe.warn(r)),X()},a.onProgress=function(e){s.loadedBytes=e.loaded},a.toSend=function(){var r=t(oe.file,s.start,s.end);return _.d("part # "+e+" (bytes "+s.start+" -> "+s.end+")  reported length: "+r.size),s.isEmpty||0!==r.size||_.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),r},a.onFailedAuth=function(t){var r="onFailedAuth for uploadPart #"+e+".   Will set status to ERROR";_.w(r),oe.warn(r),s.status=I,s.loadedBytes=0,X()},J(a),setTimeout(function(){oe.status!==b&&oe.status!==T&&(Q(a),_.d("upload #",e,a))},n),s.uploader=a}function l(e,t){var r=ae[e];r.currentXhr&&(t&&(r.currentXhr.onreadystatechange=function(){}),r.currentXhr.abort())}function z(){_.d("completeUpload"),oe.info("will attempt to complete upload");var e,t="<CompleteMultipartUpload>",r=oe.status;ae.forEach(function(e,r){e&&(t+="<Part><PartNumber>"+r+"</PartNumber><ETag>"+e.eTag+"</ETag></Part>")}),t+="</CompleteMultipartUpload>";var n={method:"POST",contentType:"application/xml; charset=UTF-8",path:Y()+"?uploadId="+oe.uploadId,x_amz_headers:oe.xAmzHeadersAtComplete,step:"complete"};n.onErr=function(t){if(!e&&oe.status!==b&&oe.status!==T){e=!0;var n="Error completing upload.";_.w(n),oe.error(n),a(I),t.abort(),setTimeout(function(){oe.status!==b&&oe.status!==T&&(oe.status=r,z(),K())},L(ue++))}},n.on200=function(e){var t=f(e.responseText),r=t.getElementsByTagName("CompleteMultipartUploadResult")[0];oe.eTag=y(r,"ETag"),oe.complete(e,oe.name),N()},n.toSend=function(){return t},J(n),Q(n)}function M(e){_.d("headObject"),oe.info("will attempt to verify existence of the file");var t={method:"HEAD",path:Y(),step:"head_object"};t.onErr=function(){var t="Error completing head object. Will re-upload file.";_.w(t),d(e)},t.on200=function(t){var r=t.getResponseHeader("Etag");r===oe.eTag?(_.d("headObject found matching object on S3."),oe.progress(1),oe.complete(t,oe.name),a(S)):(_.d("headObject not found on S3."),oe.name=e,d(e))},J(t),Q(t)}function x(e){return function(){var t=oe.status;if(t!==I&&t!==T&&t!==b){var r=B.cryptoMd5Method.call(this,this.result);_.d(["part #",e.part," MD5 digest is ",r].join("")),e.md5_digest=r,1===e.part&&H(),delete e.reader,le+=1,X(),le===pe&&_.d("All parts have MD5 digests"),setTimeout(R,1500)}}}function R(){for(var e=1;e<=pe;e++){var r=ae[e];if(r.status!==S&&null===r.md5_digest){if(e>1||"undefined"==typeof oe.firstMd5Digest){r.reader=new FileReader,r.reader.onloadend=x(r),r.reader.readAsArrayBuffer(t(oe.file,r.start,r.end));break}r.md5_digest=oe.firstMd5Digest,H(),X()}}}function U(){_.d("abortUpload"),oe.info("will attempt to abort the upload");var e={method:"DELETE",path:Y()+"?uploadId="+oe.uploadId,step:"abort",successStatus:204};e.onErr=function(){var e="Error aborting upload.";_.w(e),oe.error(e)},e.on200=function(){a(b),D()},J(e),Q(e)}function D(){_.d("listParts"),oe.info("list parts");var e={method:"GET",path:Y()+"?uploadId="+oe.uploadId,step:"list"};e.onErr=function(e){if(404==e.status)k(),oe.info("upload canceled");else{var t="Error listing parts.";_.w(t),oe.error(t)}},e.on200=function(e){var t=f(e.responseText),r=t.getElementsByTagName("Part");r.length?(_.d("Parts still found after abort...waiting."),setTimeout(function(){U()},1e3)):oe.info("upload canceled")},J(e),Q(e)}function C(e){_.d("getUploadParts() for uploadId starting at part # "+e),oe.info("getUploadParts() for uploadId starting at part # "+e);var t={method:"GET",path:Y()+"?uploadId="+oe.uploadId,query_string:"&part-number-marker="+e,step:"get upload parts"};t.onErr=function(t){if(404===t.status)oe.info(["uploadId ",oe.uploadId," does not exist."].join("")),k(),K(),F(),X();else{var r="Error listing parts for getUploadParts() starting at part # "+e;_.w(r),oe.error(r)}},t.on200=function(t){oe.info(["uploadId ",oe.uploadId," is not complete. Fetching parts from part marker=",e].join(""));for(var r,n,o=f(t.responseText),a=o.getElementsByTagName("ListPartsResult")[0],s="true"===y(a,"IsTruncated"),d=o.getElementsByTagName("Part"),u=d.length,l=0;l<u;l++)n=d[l],se.push({eTag:y(n,"ETag"),partNumber:parseInt(y(n,"PartNumber")),size:parseInt(y(n,"Size")),LastModified:y(n,"LastModified")});if(o=d=null,s){var p=y(a,"NextPartNumberMarker");C(p)}else F(),se.forEach(function(e){r=O(e.partNumber,S,e.size),r.eTag=e.eTag,r.attempts=1,r.loadedBytes=e.size,r.loadedBytesPrevious=e.size,r.finishedUploadingAt=e.LastModified,r.md5_digest="n/a",ae[e.partNumber]=r}),K(),i();a=null},J(t),Q(t)}function F(){pe=Math.ceil(oe.file.size/B.partSize)||1;for(var e=1;e<=pe;e++){var t="undefined"==typeof ae[e]?v:ae[e].status;t!==S&&(ae[e]=O(e,v,oe.file.size))}}function O(e,t,r){return{status:t,start:(e-1)*B.partSize,end:e*B.partSize,attempts:0,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,part:e}}function H(){var t=g(oe),r={awsKey:oe.name,uploadId:oe.uploadId,fileSize:oe.file.size,fileType:oe.file.type,lastModifiedDate:e(oe.file.lastModifiedDate),partSize:B.partSize,signParams:oe.signParams,createdAt:(new Date).toISOString()};B.computeContentMd5&&ae.length&&"undefined"!=typeof ae[1].md5_digest&&(r.firstMd5Digest=ae[1].md5_digest),m(t,r)}function N(){var e=c(),t=e[g(oe)];t.completedAt=(new Date).toISOString(),t.eTag=oe.eTag,n.setItem("awsUploads",JSON.stringify(e)),a(S),oe.progress(1)}function k(){"undefined"!=typeof oe.file&&h(g(oe))}function q(){var e=c(!0),t=e[g(oe)];j(t)&&(oe.uploadId=t.uploadId,oe.name=t.awsKey,oe.eTag=t.eTag,oe.firstMd5Digest=t.firstMd5Digest,oe.signParams=t.signParams)}function j(e){if("undefined"==typeof e)return!1;var t=new Date(e.completedAt||r);return B.partSize===e.partSize&&t>A}function L(e){return 1===e?0:1e3*Math.min(B.maxRetryBackoffSecs,Math.pow(B.retryBackoffPower,e-2))}function X(){var e,t=0,r=!0,n=!1,o=[],a=[];if(oe.status!=w)return void oe.info("will not process parts list, as not currently evaporating");for(var s=0;s<ae.length;s++){var i=ae[s];if(i){if(B.computeContentMd5&&null===i.md5_digest)return;var d=!1;switch(o.push(i.status),i.status){case w:r=!1,t++,a.push(i.loadedBytes);break;case I:n=!0,d=!0;break;case v:d=!0}d&&(r=!1,t<B.maxConcurrentParts&&(u(s),t++))}}e=o.toString()+" // bytesLoaded: "+a.toString(),_.d("processPartsList()  anyPartHasErrored: "+n,e),(ie>=ae.length-1||n)&&oe.info("part stati: "+e),r&&z()}function G(){re=setInterval(function(){var e=0;ae.forEach(function(t,r){e+=t.loadedBytes}),oe.progress(e/oe.sizeBytes)},B.progressIntervalMS)}function W(){ne=setInterval(function(){_.d("monitorPartsProgress() "+Date()),ae.forEach(function(e,t){var r;return e.status!=w?void _.d(t,"not evaporating "):null===e.loadedBytesPrevious?(_.d(t,"no previous "),void(e.loadedBytesPrevious=e.loadedBytes)):(r=e.loadedBytesPrevious<e.loadedBytes,B.simulateStalling&&4==t&&Math.random()<.25&&(r=!1),_.d(t,r?"moving. ":"stalled.",e.loadedBytesPrevious,e.loadedBytes),r||setTimeout(function(){oe.info("part #"+t+" stalled. will abort. "+e.loadedBytesPrevious+" "+e.loadedBytes),l(t)},0),void(e.loadedBytesPrevious=e.loadedBytes))})},12e4)}function K(){G(),W()}function J(e){if(_.d("setupRequest()",e),B.timeUrl){var t=new XMLHttpRequest;t.open("GET",B.timeUrl+"?requestTime="+(new Date).getTime(),!1),t.send(),e.dateString=t.responseText}else e.dateString=(new Date).toUTCString();e.x_amz_headers=p(e.x_amz_headers,{"x-amz-date":e.dateString}),e.onGotAuth=function(){if($(e))return void _.w("onGotAuth() step",e.step,"is already in progress. Returning.");var t=ee(e),r=e.toSend?e.toSend():null,n=E+e.path;e.query_string&&(n+=e.query_string);var o={},a=e.successStatus||200;p(o,e.not_signed_headers),p(o,e.x_amz_headers),B.simulateErrors&&1==e.attempts&&"upload #3"==e.step&&(_.d("simulating error by POST part #3 to invalid url"),n="https:///foo"),t.open(e.method,n),t.setRequestHeader("Authorization","AWS "+B.aws_key+":"+e.auth);for(var s in o)o.hasOwnProperty(s)&&t.setRequestHeader(s,o[s]);e.contentType&&t.setRequestHeader("Content-Type",e.contentType),e.md5_digest&&t.setRequestHeader("Content-MD5",e.md5_digest),t.onreadystatechange=function(){4==t.readyState&&(r&&_.d("  ### "+r.size),te(e),t.status==a?e.on200(t):e.onErr(t))},t.onerror=function(){te(e),e.onErr(t,!0)},"function"==typeof e.onProgress&&(t.upload.onprogress=function(t){e.onProgress(t)}),t.send(r)},e.onFailedAuth=e.onFailedAuth||function(t){oe.error("Error onFailedAuth for step: "+e.step),e.onErr(t)}}function Q(e){if(_.d("authorizedSend() "+e.step),$(e))return void _.w("authorizedSend() step",e.step,"is already in progress. Returning.");var t,r=ee(e),n=B.signerUrl+"?to_sign="+V(e);for(var o in oe.signParams)oe.signParams.hasOwnProperty(o)&&(n+=oe.signParams[o]instanceof Function?"&"+encodeURIComponent(o)+"="+encodeURIComponent(oe.signParams[o]()):"&"+encodeURIComponent(o)+"="+encodeURIComponent(oe.signParams[o]));r.onreadystatechange=function(){4==r.readyState&&(200==r.status&&28==r.response.length?(_.d("authorizedSend got signature for step: '"+e.step+"'    sig: "+r.response),e.auth=r.response,te(e),e.onGotAuth()):(t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,_.w(t),oe.warn(t),te(e),e.onFailedAuth(r)))},r.onerror=function(){t="failed to get authorization (onerror) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,_.w(t),oe.warn(t),e.onFailedAuth(r)},r.open("GET",n);for(var a in oe.signHeaders)oe.signHeaders.hasOwnProperty(a)&&(oe.signHeaders[a]instanceof Function?r.setRequestHeader(a,oe.signHeaders[a]()):r.setRequestHeader(a,oe.signHeaders[a]));oe.beforeSigner instanceof Function&&oe.beforeSigner(r),r.send()}function V(e){var t,r="",n=[];for(var o in e.x_amz_headers)e.x_amz_headers.hasOwnProperty(o)&&n.push(o);return n.sort(),n.forEach(function(t,n){r+=t+":"+e.x_amz_headers[t]+"\n"}),t=e.method+"\n"+(e.md5_digest||"")+"\n"+(e.contentType||"")+"\n\n"+r+(B.cloudfront?"/"+B.bucket:"")+e.path,encodeURIComponent(t)}function Y(){var e="/"+B.bucket+"/"+oe.name;return(B.cloudfront||E.indexOf("cloudfront")>-1)&&(e="/"+oe.name),e}function Z(e){return"undefined"==typeof e.part?e:e.part}function $(e){return!!Z(e).currentXhr}function ee(e){return Z(e).currentXhr=new XMLHttpRequest}function te(e){delete Z(e).currentXhr}var re,ne,oe=this,ae=[],se=[],ie=0,de=0,ue=0;p(oe,o),oe.start=function(){_.d("starting FileUpload "+oe.id),a(w);var e=oe.name;if(q(),"undefined"==typeof oe.uploadId)d(e);else if("undefined"!=typeof oe.eTag&&oe.firstMd5Digest){var r=new FileReader;r.onloadend=function(){var t=B.cryptoMd5Method.call(this,this.result);B.allowS3ExistenceOptimization&&oe.firstMd5Digest===t?M(e):(oe.firstMd5Digest=t,d(e))},r.readAsArrayBuffer(t(oe.file,0,B.partSize))}else C(0)},oe.stop=function(){_.d("stopping FileUpload ",oe.id),oe.cancelled(),a(T),oe.info("Canceling uploads..."),s()};var le=0,pe=-1}function p(e,t,r){if("undefined"==typeof e&&(e={}),"object"==typeof r)for(var n in r)t[n]=r[n];for(var o in t)e[o]=t[o];return e}function f(e){var t=new DOMParser;return t.parseFromString(e,"text/xml")}function c(e){var t=JSON.parse(n.getItem("awsUploads")||"{}");if(e)for(var o in t)if(t.hasOwnProperty(o)){var a=t[o],s=new Date(a.completedAt||r);s<A&&delete t[o]}return t}function g(t){return[t.file.name,t.file.type,e(t.file.lastModifiedDate),t.file.size].join("-")}function m(e,t){var r=c();r[e]=t,n.setItem("awsUploads",JSON.stringify(r))}function h(e){var t=c();delete t[e],n.setItem("awsUploads",JSON.stringify(t))}function y(e,t){return e.getElementsByTagName(t)[0].childNodes[0].nodeValue}var v=0,w=2,S=3,T=5,I=10,b=20,E=o.aws_url||"https://s3.amazonaws.com",P='"d41d8cd98f00b204e9800998ecf8427e"',z=this,M=[],_=a(),B=p({logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:500,cloudfront:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,s3FileCacheHoursAgo:null},o);if(console&&console.log&&(_=console,_.d=_.log,console.warn?_.w=_.warn:_.w=_.log,console.error?_.e=_.error:_.e=_.log),this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)||o.testUnsupported),!this.supported)return void _.e("The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]");if(B.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return void _.e("The browser's FileReader object does not support readAsArrayBuffer");if("function"!=typeof B.cryptoMd5Method)return void _.e("Option computeContentMd5 has been set but cryptoMd5Method is not defined.")}B.logging||(_=a());var x=new Date,A=new Date(x.setHours(x.getHours()-(B.s3FileCacheHoursAgo||-100)));z.add=function(e){_.d("add");var t;if("undefined"==typeof e)return"Missing file";if("undefined"==typeof e.name?t="Missing attribute: name  ":B.encodeFilename&&(e.name=encodeURIComponent(e.name)),t)return t;var r=s(e);return d(),r},z.cancel=function(e){return _.d("cancel ",e),!!M[e]&&(M[e].stop(),!0)},z.pause=function(e){},z.resume=function(e){},z.forceRetry=function(){}};"undefined"!=typeof module&&module.exports?module.exports=o:"undefined"!=typeof window&&(window.Evaporate=o)}();
//# sourceMappingURL=evaporate.min.js.map