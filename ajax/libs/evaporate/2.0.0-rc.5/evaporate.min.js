!function(){"use strict";function t(t,e,r){this.fileTotalBytesUploaded=0,this.s3Parts=[],this.partsOnS3=[],this.partsInProcess=[],this.partsToUpload=[],this.numParts=-1,this.con=e,this.evaporate=r,this.localTimeOffset=r.localTimeOffset,this.deferredCompletion=v(),this.partNeeds=v(),S(this,t),this.id=decodeURIComponent(this.con.bucket+"/"+this.name),this.signParams=e.signParams}function e(t,e){this.fileUpload=t,this.con=t.con,this.attempts=1,this.localTimeOffset=this.fileUpload.localTimeOffset,this.awsDeferred=v(),this.started=v(),this.awsUrl=c(this.con),this.awsHost=f(this.awsUrl).hostname,this.updateRequest(e)}function r(t,r){e.call(this,t,r)}function o(t,r,o){o>-1&&(this.maxRetries=o),e.call(this,t,r)}function s(t,e){var o={method:"POST",path:"?uploads",step:"initiate",x_amz_headers:t.xAmzHeadersAtInitiate,not_signed_headers:t.notSignedHeadersAtInitiate,response_match:"<UploadId>(.+)</UploadId>"};t.contentType&&(o.contentType=t.contentType),r.call(this,t,o),this.awsKey=e}function n(t){t.info("will attempt to complete upload");var e={method:"POST",contentType:"application/xml; charset=UTF-8",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtComplete,step:"complete"};r.call(this,t,e)}function i(t,e){this.awsKey=e,t.info("will attempt to verify existence of the file");var r={method:"HEAD",path:"",x_amz_headers:t.xAmzHeadersCommon,success404:!0,step:"head_object"};o.call(this,t,r)}function a(t){o.call(this,t),this.updateRequest(this.setupRequest(0))}function p(t,r){this.part=r,this.partNumber=r.part,this.start=(this.partNumber-1)*t.con.partSize,this.end=this.partNumber*t.con.partSize,this.progressTracker=0;var o={method:"PUT",path:"?partNumber="+this.partNumber+"&uploadId="+t.uploadId,step:"upload #"+this.partNumber,x_amz_headers:t.xAmzHeadersCommon||t.xAmzHeadersAtUpload,contentSha256:"UNSIGNED-PAYLOAD",onProgress:this.onProgress.bind(this)};e.call(this,t,o)}function u(t){t.info("will attempt to abort the upload"),t.abortParts();var r={method:"DELETE",path:"?uploadId="+t.uploadId,x_amz_headers:t.xAmzHeadersCommon,success404:!0,step:"abort"};e.call(this,t,r)}function d(t,e){function r(t){this.request=t}function o(t){r.call(this,t)}function s(t,e){this.payload=e,r.call(this,t)}var n=t.con;return r.prototype.request={},r.prototype.authorizationString=function(){},r.prototype.stringToSign=function(){},r.prototype.setHeaders=function(){},r.prototype.datetime=function(t){return new Date((new Date).getTime()+t)},r.prototype.dateString=function(t){return this.datetime(t).toISOString().slice(0,19).replace(/-|:/g,"")+"Z"},o.prototype=Object.create(r.prototype),o.prototype.constructor=o,o.prototype.authorizationString=function(){return["AWS ",n.aws_key,":",this.request.auth].join("")},o.prototype.stringToSign=function(){var r,o="",s=[];for(var i in this.request.x_amz_headers)this.request.x_amz_headers.hasOwnProperty(i)&&s.push(i);s.sort();var a=this;return s.forEach(function(t){o+=t+":"+a.request.x_amz_headers[t]+"\n"}),r=this.request.method+"\n"+(this.request.md5_digest||"")+"\n"+(this.request.contentType||"")+"\n\n"+o+(n.cloudfront?"/"+n.bucket:"")+t.getPath()+this.request.path,e.d("V2 stringToSign:",r),r},o.prototype.dateString=function(t){return this.datetime(t).toUTCString()},s.prototype=Object.create(r.prototype),s.prototype.constructor=s,s.prototype.payload=null,s.prototype.authorizationString=function(){var t=[],e=this.credentialString(),r=this.canonicalHeaders();return t.push(["AWS4-HMAC-SHA256 Credential=",n.aws_key,"/",e].join("")),t.push("SignedHeaders="+r.signedHeaders),t.push("Signature="+this.request.auth),t.join(", ")},s.prototype.stringToSign=function(){var t=[];t.push("AWS4-HMAC-SHA256"),t.push(this.request.dateString),t.push(this.credentialString()),t.push(n.cryptoHexEncodedHash256(this.canonicalRequest()));var r=t.join("\n");return e.d("V4 stringToSign:",r),r},s.prototype.credentialString=function(){var t=[];return t.push(this.request.dateString.slice(0,8)),t.push(n.awsRegion),t.push("s3"),t.push("aws4_request"),t.join("/")},s.prototype.canonicalQueryString=function(){var e,r,o=t.request.query_string||"",s=f([t.awsUrl,this.request.path,o].join("")).search,n=s.length?s.split("&"):[],i=[];for(r=0;r<n.length;r++)e=n[r].split("="),i.push({name:encodeURIComponent(e[0]),value:e.length>1?encodeURIComponent(e[1]):null});var a=i.sort(function(t,e){return t.name<e.name?-1:t.name>e.name?1:0}),p=[];for(r=0;r<a.length;r++)e=a[r].value?[a[r].name,a[r].value].join("="):a[r].name+"=",p.push(e);return p.join("&")},s.prototype.getPayloadSha256Content=function(){var t=this.request.contentSha256||n.cryptoHexEncodedHash256(this.payload||"");return e.d(this.request.step,"getPayloadSha256Content:",t),t},s.prototype.canonicalHeaders=function(){function e(t,e){var r=t.toLowerCase();s.push(r),o[r]=e.replace(/\s+/g," ")}var r,o=[],s=[];this.request.md5_digest&&e("Content-Md5",this.request.md5_digest),e("Host",t.awsHost),this.request.contentType&&e("Content-Type",this.request.contentType||"");var n=this.request.x_amz_headers||{};for(var i in n)n.hasOwnProperty(i)&&e(i,n[i]);var a=s.sort(function(t,e){return t<e?-1:t>e?1:0}),p=[],u=[],d=this.request.not_signed_headers||[],l=[];for(r=0;r<d.length;r++)u.push(d[r].toLowerCase());for(r=0;r<a.length;r++){var c=a[r];p.push([c,o[c]].join(":")),u.indexOf(c)===-1&&l.push(c)}return{canonicalHeaders:p.join("\n"),signedHeaders:l.join(";")}},s.prototype.canonicalRequest=function(){var r=[];r.push(this.request.method),r.push(f([t.awsUrl+t.getPath()+this.request.path].join("")).pathname),r.push(this.canonicalQueryString()||"");var o=this.canonicalHeaders();r.push(o.canonicalHeaders+"\n"),r.push(o.signedHeaders),r.push(this.getPayloadSha256Content());var s=r.join("\n");return e.d(this.request.step,"V4 CanonicalRequest:",s),s},s.prototype.setHeaders=function(t){t.setRequestHeader("x-amz-content-sha256",this.getPayloadSha256Content())},"4"===n.awsSignatureVersion?s:o}function l(t){function e(){this.request=n}function r(){e.call(this)}var o=t.fileUpload,s=o.con,n=t.request;return e.prototype=Object.create(e.prototype),e.prototype.request={},e.makeSignParamsObject=function(t){var e={};for(var r in t)t.hasOwnProperty(r)&&("function"==typeof t[r]?e[r]=t[r]():e[r]=t[r]);return e},e.prototype.authorize=function(){return new Promise(function(e,r){var i=new XMLHttpRequest;t.currentXhr=i;var a=t.stringToSign(),p=[s.signerUrl,"?to_sign=",a,"&datetime=",n.dateString].join(""),u=t.makeSignParamsObject(o.signParams);for(var d in u)u.hasOwnProperty(d)&&(p+="&"+encodeURIComponent(d)+"="+encodeURIComponent(u[d]));s.xhrWithCredentials&&(i.withCredentials=!0),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status)t.signResponse(i.response,a,n.dateString).then(e);else{if([401,403].indexOf(i.status)>-1){var s="status:"+i.status;return o.deferredCompletion.reject("Permission denied "+s),r(s)}r("Signature fetch returned status: "+i.status)}},i.onerror=function(t){r("authorizedSend transport error: "+t.responseText)},i.open("GET",p);var l=t.makeSignParamsObject(s.signHeaders);for(var c in l)l.hasOwnProperty(c)&&i.setRequestHeader(c,l[c]);"function"==typeof o.beforeSigner&&o.beforeSigner(i,p),i.send()})},r.prototype=Object.create(e.prototype),r.prototype.authorize=function(){return s.customAuthMethod(e.makeSignParamsObject(o.signParams),e.makeSignParamsObject(s.signHeaders),t.stringToSign(),n.dateString).catch(function(t){throw o.deferredCompletion.reject(t),t})},"function"==typeof s.customAuthMethod?new r:new e}function c(t){var e;return t.aws_url?e=[t.aws_url]:(t.s3Acceleration?(e=["https://",t.bucket,".s3-accelerate"],t.cloudfront=!0):(e=["https://",t.cloudfront?t.bucket+".":"","s3"],"us-east-1"!==t.awsRegion&&e.push("-",t.awsRegion)),e.push(".amazonaws.com")),e.join("")}function h(t){var e=t.split("/"),r=[];return e.forEach(function(t){r.push(encodeURIComponent(t).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/'/,"%27"))}),r.join("/")}function f(t){var e=document.createElement("a");return e.href=t||"/",{protocol:e.protocol,hostname:e.hostname,pathname:e.pathname.replace(/(^\/?)/,"/"),port:e.port,search:"?"===e.search[0]?e.search.substr(1):e.search,hash:e.hash,host:e.host}}function m(t){return t?t.toISOString():""}function y(t,e,r){var o=t.slice?"slice":t.mozSlice?"mozSlice":"webkitSlice";return t[o](e,r)}function g(t){var e=new DOMParser,r=e.parseFromString(t.responseText,"text/html"),o=r.getElementsByTagName("Code"),s=r.getElementsByTagName("Message");return o=o&&o.length?o[0].innerHTML||o[0].textContent:"",s=s&&s.length?s[0].innerHTML||s[0].textContent:"",o.length?["AWS Code: ",o,", Message:",s].join(""):""}function v(){var t,e={};return t=new Promise(function(t,r){e={resolve:t,reject:r}}),{resolve:e.resolve,reject:e.reject,promise:t}}function S(t,e,r){function o(t,e){if("object"==typeof e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}return t=t||{},o(e,r),o(t,e),t}function w(t){var e=new DOMParser;return e.parseFromString(t,"text/xml")}function P(t,e){return t.getElementsByTagName(e)[0].textContent}function U(t){var e=JSON.parse(W.getItem("awsUploads")||"{}");if(t){for(var r in e)if(e.hasOwnProperty(r)){var o=e[r],s=new Date(o.completedAt||z);s<q&&delete e[r]}W.setItem("awsUploads",JSON.stringify(e))}return e}function T(t){return[t.file.name,t.file.type,m(t.file.lastModifiedDate),t.file.size].join("-")}function b(t,e){var r=U();r[t]=e,W.setItem("awsUploads",JSON.stringify(r))}function x(t){var e=U();delete e[t],W.setItem("awsUploads",JSON.stringify(e))}function O(t,e){var r=t.indexOf(e);if(r>-1)return t.splice(r,1),!0}function C(){return{d:function(){},w:function(){},e:function(){}}}var q,I,z=new Date("2060-10-22"),R=0,M=2,_=3,H=4,F=5,j=10,E=20,A=30,N=40,k='"d41d8cd98f00b204e9800998ecf8427e"',D=12e4,B=["maxConcurrentParts","logging","cloudfront","aws_url","encodeFilename","computeContentMd5","allowS3ExistenceOptimization","onlyRetryForSameFileName","timeUrl","cryptoMd5Method","cryptoHexEncodedHash256","aws_key","awsRegion","awsSignatureVersion","evaporateChanged"],L=function(t){if(this.config=S({bucket:null,logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressMod:5,cloudfront:!1,s3Acceleration:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,onlyRetryForSameFileName:!1,timeUrl:null,cryptoMd5Method:null,cryptoHexEncodedHash256:null,aws_key:null,awsRegion:"us-east-1",awsSignatureVersion:"4",s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},customAuthMethod:void 0,maxFileSize:null,signResponseHandler:null,xhrWithCredentials:!1,localTimeOffset:void 0,evaporateChanged:function(){},abortCompletionThrottlingMs:1e3},t),"undefined"!=typeof window&&window.console&&(I=window.console,I.d=I.log,I.w=window.console.warn?I.warn:I.d,I.e=window.console.error?I.error:I.d),this._instantiationError=this.validateEvaporateOptions(),"string"==typeof this._instantiationError)return void(this.supported=!1);delete this._instantiationError,this.config.logging||(I=C());var e=new Date;if(q=new Date(e.setHours(e.getHours()-(this.config.s3FileCacheHoursAgo||-100))),"number"==typeof t.localTimeOffset)this.localTimeOffset=t.localTimeOffset;else{var r=this;L.getLocalTimeOffset(this.config).then(function(t){r.localTimeOffset=t})}this.pendingFiles={}};L.create=function(t){var e=Object.assign({},t);return L.getLocalTimeOffset(e).then(function(t){return e.localTimeOffset=t,new Promise(function(t,r){var o=new L(e);o.supported===!0?t(o):r(o._instantiationError)})})},L.getLocalTimeOffset=function(t){return new Promise(function(e,r){if("number"==typeof t.localTimeOffset)return e(t.localTimeOffset);if(t.timeUrl){var o=new XMLHttpRequest;o.open("GET",t.timeUrl+"?requestTime="+(new Date).getTime()),o.onreadystatechange=function(){if(4===o.readyState&&200===o.status){var t=new Date(Date.parse(o.responseText)),r=new Date;e(t-r)}},o.onerror=function(t){I.e("xhr error timeUrl",t),r("Fetching offset time failed with status: "+t.status)},o.send()}else e(0)}).then(function(t){return I.d("localTimeOffset is",t,"ms"),new Promise(function(e){e(t)})})},L.prototype.config={},L.prototype.localTimeOffset=0,L.prototype.supported=!1,L.prototype._instantiationError=void 0,L.prototype.evaporatingCount=0,L.prototype.lastFileSatisfied=Promise.resolve("onStart"),L.prototype.pendingFiles={},L.prototype.filesInProcess=[],L.prototype.fileCleanup=function(t){O(this.filesInProcess,t)&&this.evaporatingCnt(-1),t.done()},L.prototype.startUpload=function(t){t.partNeedsCalled=!1;var e=this;t.status===H&&(t.status=N,t.resumed()),this.lastFileSatisfied.then(function(){t.partNeedsCalled=!0,[R,N].indexOf(t.status)>-1&&e.evaporatingCount<e.config.maxConcurrentParts&&(e.filesInProcess.push(t),e.evaporatingCnt(1),t.status===N?(t.status=M,I.d("resuming FileUpload ",t.id),t.started(),t.consumeSlots()):t.start())}),this.lastFileSatisfied=t.getPartNeedsPromise()},L.prototype.add=function(e,r){var o,s=this;return new Promise(function(n,i){var a=S(r,{});if(B.forEach(function(t){delete a[t]}),o=S(s.config,a),"undefined"==typeof e||"undefined"==typeof e.file)return i("Missing file");if(o.maxFileSize&&e.file.size>o.maxFileSize)return i("File size too large. Maximum size allowed is "+o.maxFileSize);if("undefined"==typeof e.name)return i("Missing attribute: name");o.encodeFilename&&(e.name=h(e.name));var p=new t(S({started:function(){},progress:function(){},complete:function(){},cancelled:function(){},paused:function(){},resumed:function(){},pausing:function(){},nameChanged:function(){},info:function(){},warn:function(){},error:function(){},beforeSigner:void 0,xAmzHeadersAtInitiate:{},notSignedHeadersAtInitiate:{},xAmzHeadersCommon:null,xAmzHeadersAtUpload:{},xAmzHeadersAtComplete:{}},e,{status:R,priority:0,loadedBytes:0,sizeBytes:e.file.size,eTag:""}),o,s),u=p.id;s.pendingFiles[u]=p,s.startUpload(p),p.deferredCompletion.promise.then(function(){s.fileCleanup(p),n(decodeURIComponent(p.name))},function(t){s.fileCleanup(p),i(t)})})},L.prototype.cancel=function(t){var e=this;return new Promise(function(r,o){var s=typeof t;if("undefined"===s){I.d("Canceling all file uploads");var n=[];for(var i in e.pendingFiles)if(e.pendingFiles.hasOwnProperty(i)){var a=e.pendingFiles[i];n.push(a.stop())}return n.length?Promise.all(n).then(r,o):o("No files to cancel.")}e.pendingFiles[t]?e.pendingFiles[t].stop().then(r,o):o("File does not exist")})},L.prototype.pause=function(t,e){var r=this;return new Promise(function(o,s){e=e||{};var n="undefined"!==e.force&&e.force,i=typeof t;if("undefined"===i){I.d("Pausing all file uploads");var a=[];for(var p in r.pendingFiles)if(r.pendingFiles.hasOwnProperty(p)){var u=r.pendingFiles[p];[R,M,j].indexOf(u.status)>-1&&a.push(u.pause(n))}return Promise.all(a).then(o,s)}return"undefined"==typeof r.pendingFiles[t]?s("Cannot pause a file that has not been added."):r.pendingFiles[t].status===H?s("Cannot pause a file that is already paused."):r.pendingFiles[t].pause(n).then(o,s)})},L.prototype.resume=function(t){var e,r=this;return new Promise(function(o,s){var n=[H,A];if("undefined"==typeof t){I.d("Resuming all file uploads");for(var i in r.pendingFiles)r.pendingFiles.hasOwnProperty(i)&&(e=r.pendingFiles[i],n.indexOf(e.status)>-1&&r.startUpload(e));return o()}return e=r.pendingFiles[t],"undefined"==typeof e?s("Cannot pause a file that does not exist."):n.indexOf(e.status)===-1?e.status===N?void I.d("File already resumed."):s("Cannot resume a file that has not been paused."):(r.startUpload(e),void o())})},L.prototype.forceRetry=function(){},L.prototype.consumeRemainingSlots=function(){var t=this.config.maxConcurrentParts-this.evaporatingCount;if(t){for(var e,r=0;r<this.filesInProcess.length;r++){var o=this.filesInProcess[r];if(e=o.consumeSlots(),!(e<0||(t-=e)))return}for(var s in this.pendingFiles)if(this.pendingFiles.hasOwnProperty(s)){var n=this.pendingFiles[s];if([M,j].indexOf(n.status)>-1){if(e=n.consumeSlots(),e<0)continue;if(t-=e,!t)return}else n.status===R&&n.partNeedsCalled&&this.startUpload(n)}}},L.prototype.validateEvaporateOptions=function(){if(this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof Promise||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)),!this.config.signerUrl&&"function"!=typeof this.config.customAuthMethod)return"Option signerUrl is required unless customAuthMethod is present.";if(!this.config.bucket)return"The AWS 'bucket' option must be present.";if(!this.supported)return"The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]";if(this.config.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return"The browser's FileReader object does not support readAsArrayBuffer";if("function"!=typeof this.config.cryptoMd5Method)return"Option computeContentMd5 has been set but cryptoMd5Method is not defined.";if("4"===this.config.awsSignatureVersion&&"function"!=typeof this.config.cryptoHexEncodedHash256)return"Option awsSignatureVersion is 4 but cryptoHexEncodedHash256 is not defined."}else if("4"===this.config.awsSignatureVersion)return"Option awsSignatureVersion is 4 but computeContentMd5 is not enabled.";return!0},L.prototype.getRemainingSlots=function(t){var e=this.evaporatingCount;return t||(e-=1),this.config.maxConcurrentParts-e},L.prototype.evaporatingCnt=function(t){this.evaporatingCount=Math.max(0,this.evaporatingCount+t),this.config.evaporateChanged(this,this.evaporatingCount)},t.prototype.con=void 0,t.prototype.evaporate=void 0,t.prototype.localTimeOffset=0,t.prototype.id=void 0,t.prototype.status=R,t.prototype.numParts=-1,t.prototype.fileTotalBytesUploaded=0,t.prototype.lastPartSatisfied=Promise.resolve("onStart"),t.prototype.partsInProcess=[],t.prototype.partsToUpload=[],t.prototype.s3Parts=[],t.prototype.partsOnS3=[],t.prototype.deferredCompletion=void 0,t.prototype.partNeeds=void 0,t.prototype.partNeedsCalled=!1,t.prototype.abortedByUser=!1,t.prototype.start=function(){var t=this,e=!1;return new Promise(function(r,o){t.status=M,t.started(t.id);var s=t.name;t.getUnfinishedFileUpload(),new Promise(function(r,o){if(!t.uploadId)throw"";return t.con.computeContentMd5&&t.con.allowS3ExistenceOptimization&&"undefined"!=typeof t.firstMd5Digest&&"undefined"!=typeof t.eTag?t.reuseS3Object(s).then(r,o):(e=!0,void t.resumeInterruptedUpload().then(r,o))}).then(r,function(n){I.d(n),t.uploadId=void 0,e=!0,t.uploadFile(s).then(r,o)})}).then(function(){var r=e?t.completeUpload():Promise.resolve();r.then(t.deferredCompletion.resolve.bind(t))},function(){t.abortedByUser||t.abortUpload().then(function(){t.deferredCompletion.reject("File upload aborted due to a part failing to upload")},t.deferredCompletion.reject.bind(t))})},t.prototype.stop=function(){I.d("stopping FileUpload ",this.id),this.setStatus(F),this.info("Canceling uploads..."),this.abortedByUser=!0;var t=this;return this.abortUpload().then(function(){throw"User aborted the upload"}).catch(function(e){t.deferredCompletion.reject(e)})},t.prototype.pause=function(t){I.d("pausing FileUpload, force:",!!t,this.id);var e=[],r=this;return this.info("Pausing uploads..."),this.status=A,t?(this.abortParts(!0),this.status=H,this.paused()):(this.partsInProcess.forEach(function(t){e.push(r.s3Parts[t].awsRequest.awsDeferred.promise)}),this.pausing()),Promise.all(e).then(function(){r.status=H,r.partNeeds.resolve("add parts paused"),r.paused()})},t.prototype.resolveForNext=function(){var t=this.partsToUpload.length===this.partsInProcess.length,e=this.evaporate.getRemainingSlots(this.partsInProcess.length);return t&&e>0},t.prototype.getAvailablePartsToUpload=function(){return Math.min(this.evaporate.getRemainingSlots(this.partsInProcess.length),this.partsToUpload.length)},t.prototype.startPartUpload=function(t){this.lastPartSatisfied.then(t.delaySend.bind(t)),this.lastPartSatisfied=t.getStartedPromise()},t.prototype.abortParts=function(t){var e=this,r=this.partsInProcess.slice(0);r.forEach(function(r){var o=e.s3Parts[r];o&&(o.awsRequest.abort(),t&&(o.status=R),O(e.partsInProcess,o.part),e.partsToUpload.length&&e.evaporate.evaporatingCnt(-1))})},t.prototype.makeParts=function(t){function e(t){O(n.partsToUpload,t.part),O(n.partsInProcess,t.part),n.partsToUpload.length&&n.evaporate.evaporatingCnt(-1)}function r(t){return function(){e(t),n.evaporate.consumeRemainingSlots()}}function o(t){return function(){e(t)}}this.numParts=Math.ceil(this.file.size/this.con.partSize)||1;for(var s=[],n=this,i=t?1:this.numParts,a=1;a<=i;a++){var u=this.s3Parts[a];if("undefined"!=typeof u){if(u.status===_)continue}else u=this.makePart(a,R,this.file.size);u.awsRequest=new p(this,u),u.awsRequest.awsDeferred.promise.then(r(u),o(u)),this.partsToUpload.push(a),s.push(this.s3Parts[a].awsRequest.awsDeferred.promise)}return s},t.prototype.makePart=function(t,e,r){var o={status:e,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,part:t};return this.s3Parts[t]=o,o},t.prototype.setStatus=function(t){this.status=t},t.prototype.createUploadFile=function(){var t=T(this),e={awsKey:this.name,bucket:this.con.bucket,uploadId:this.uploadId,fileSize:this.file.size,fileType:this.file.type,lastModifiedDate:m(this.file.lastModifiedDate),partSize:this.con.partSize,signParams:this.con.signParams,createdAt:(new Date).toISOString()};b(t,e)},t.prototype.updateUploadFile=function(t){var e=T(this),r=U(),o=Object.assign({},r[e],t);b(e,o)},t.prototype.completeUploadFile=function(t){var e=U(),r=e[T(this)];"undefined"!=typeof r&&(r.completedAt=(new Date).toISOString(),r.eTag=this.eTag,r.firstMd5Digest=this.firstMd5Digest,e[T(this)]=r,W.setItem("awsUploads",JSON.stringify(e))),this.complete(t,this.name),this.setStatus(_),this.progress(1)},t.prototype.removeUploadFile=function(){"undefined"!=typeof this.file&&x(T(this))},t.prototype.getUnfinishedFileUpload=function(){var t=U(!0),e=t[T(this)];this.canRetryUpload(e)&&(this.uploadId=e.uploadId,this.name=e.awsKey,this.eTag=e.eTag,this.firstMd5Digest=e.firstMd5Digest,this.signParams=e.signParams)},t.prototype.canRetryUpload=function(t){if("undefined"==typeof t)return!1;var e=new Date(t.completedAt||z);return this.con.partSize===t.partSize&&e>q&&this.con.bucket===t.bucket&&(!this.con.onlyRetryForSameFileName||this.name===t.awsKey)},t.prototype.partSuccess=function(t,e){var r=e.part;if(I.d(e.request.step,"ETag:",t),r.isEmpty||t!==k)return r.eTag=t,r.status=_,this.partsOnS3.push(r),!0;r.status=j,e.resetLoadedBytes(0);var o=["eTag matches MD5 of 0 length blob for part #",e.partNumber,"Retrying part."].join(" ");I.w(o),this.warn(o)},t.prototype.listPartsSuccess=function(t,e){this.info("uploadId",this.uploadId,"is not complete. Fetching parts from part marker",t.partNumberMarker);for(var r,o,s=w(e),n=s.getElementsByTagName("ListPartsResult")[0],i=s.getElementsByTagName("Part"),a=i.length,p=0;p<a;p++)r=i[p],o=parseInt(P(r,"Size"),10),this.fileTotalBytesUploaded+=o,this.partsOnS3.push({eTag:P(r,"ETag"),partNumber:parseInt(P(r,"PartNumber"),10),size:o,LastModified:P(r,"LastModified")});return n},t.prototype.makePartsfromPartsOnS3=function(){var t=this;this.partsOnS3.forEach(function(e){var r=t.makePart(e.partNumber,_,e.size);r.eTag=e.eTag,r.loadedBytes=e.size,r.loadedBytesPrevious=e.size,r.finishedUploadingAt=e.LastModified})},t.prototype.completeUpload=function(){var t=this;return new n(this).send().then(function(e){var r=w(e.responseText),o=r.getElementsByTagName("CompleteMultipartUploadResult")[0];t.eTag=P(o,"ETag"),t.completeUploadFile(e)})},t.prototype.getCompletedPayload=function(){var t=[];return t.push("<CompleteMultipartUpload>"),this.s3Parts.forEach(function(e,r){r>0&&["<Part><PartNumber>",r,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].forEach(function(e){t.push(e)})}),t.push("</CompleteMultipartUpload>"),t.join("")},t.prototype.consumeSlots=function(){if(0===this.partsToUpload.length)return-1;if(this.partsToUpload.length!==this.partsInProcess.length&&[H,A,E,F,_].indexOf(this.status)===-1){if(this.status!==M)return void this.info("will not process parts list, as not currently evaporating");var t=this.getAvailablePartsToUpload();if(!t)return;for(var e=0,r=this.evaporate.getRemainingSlots(this.partsInProcess.length),o=0;o<this.partsToUpload.length;o++){var s=this.s3Parts[this.partsToUpload[o]];if(s.status!==M&&this.partsInProcess.indexOf(s.part)===-1&&(this.partsInProcess.length&&this.partsToUpload.length>1&&this.evaporate.evaporatingCnt(1),this.partsInProcess.push(s.part),s.awsRequest.errorExceptionStatus()||this.startPartUpload(s.awsRequest),e+=1,e===t))break}return r}return 0},t.prototype.resolvePartNeeds=function(t){this.partNeeds.resolve(t)},t.prototype.getPartNeedsPromise=function(){return this.partNeeds.promise},t.prototype.done=function(){this.partNeeds.resolve("file processing ended"),this.partsOnS3=[],this.s3Parts=[]},t.prototype.uploadFile=function(t){this.status=M,this.removeUploadFile();var e=this;return new s(e,t).send().then(function(){return e.partsToUpload=[],e.uploadParts().then(function(){},function(t){throw t})})},t.prototype.uploadParts=function(){var t=this.makeParts();return this.setStatus(M),this.consumeSlots(),Promise.all(t)},t.prototype.abortUpload=function(){var t=this;return new Promise(function(e,r){return"undefined"==typeof t.uploadId?void e():void new u(t).send().then(e,r)}).then(function(){t.setStatus(E),t.cancelled(),t.removeUploadFile()},t.deferredCompletion.reject.bind(t))},t.prototype.resumeInterruptedUpload=function(){var t=this;return new a(t).send().then(t.uploadParts.bind(t))},t.prototype.reuseS3Object=function(t){function e(e){throw r.name=t,e}var r=this;this.makeParts(1),this.partsToUpload=[];var o=this.s3Parts[1];return o.awsRequest.getPartMd5Digest().then(function(){if(r.firstMd5Digest===r.s3Parts[1].md5_digest)return new i(r,t).send().then(function(t){I.d("headObject found matching object on S3."),r.completeUploadFile(t),r.nameChanged(r.name)}).catch(e);var o=r.con.allowS3ExistenceOptimization?"File's first part MD5 digest does not match what was stored.":"allowS3ExistenceOptimization is not enabled.";e(o)})},e.prototype.fileUpload=void 0,e.prototype.con=void 0,e.prototype.awsUrl=void 0,e.prototype.awsHost=void 0,e.prototype.authorize=function(){},e.prototype.localTimeOffset=0,e.prototype.awsDeferred=void 0,e.prototype.started=void 0,e.prototype.getPath=function(){var t="/"+this.con.bucket+"/"+this.fileUpload.name;return(this.con.cloudfront||this.awsUrl.indexOf("cloudfront")>-1)&&(t="/"+this.fileUpload.name),t},e.prototype.updateRequest=function(t){this.request=t;var e=d(this,I);this.signer=new e(t,this.getPayload())},e.prototype.success=function(){return!0},e.prototype.error=function(t){if(!this.errorExceptionStatus()&&(I.d(this.request.step,"error:",this.fileUpload.id,t),"undefined"==typeof this.errorHandler(t))){this.fileUpload.warn("Error in ",this.request.step,t),this.fileUpload.setStatus(j);var e=this,r=1===this.attempts?0:1e3*Math.min(this.con.maxRetryBackoffSecs,Math.pow(this.con.retryBackoffPower,this.attempts-2));this.attempts+=1,setTimeout(function(){e.errorExceptionStatus()||e.trySend()},r)}},e.prototype.errorHandler=function(){},e.prototype.errorExceptionStatus=function(){return!1},e.prototype.getPayload=function(){return null},e.prototype.success_status=function(t){return t.status>=200&&t.status<=299||this.request.success404&&404===t.status},e.prototype.stringToSign=function(){return encodeURIComponent(this.signer.stringToSign())},e.prototype.makeSignParamsObject=function(t){var e={};for(var r in t)t.hasOwnProperty(r)&&("function"==typeof t[r]?e[r]=t[r]():e[r]=t[r]);return e},e.prototype.signResponse=function(t,e,r){var o=this;return new Promise(function(s){return"function"==typeof o.con.signResponseHandler?o.con.signResponseHandler(t,e,r).then(s):void s(t)})},e.prototype.sendRequestToAWS=function(){var t=this;return new Promise(function(e,r){var o=new XMLHttpRequest;t.currentXhr=o;var s=t.getPayload(),n=[t.awsUrl,t.getPath(),t.request.path].join(""),i={};t.request.query_string&&(n+=t.request.query_string),S(i,t.request.not_signed_headers),S(i,t.request.x_amz_headers),o.onreadystatechange=function(){if(4===o.readyState)if(s&&I.d("  ###",s.size),t.success_status(o))t.request.response_match&&void 0===o.response.match(new RegExp(t.request.response_match))?r("AWS response does not match set pattern: "+t.request.response_match):e(o);else{var n=o.responseText?g(o):" ";n+="status:"+o.status,r(n)}},o.open(t.request.method,n),o.setRequestHeader("Authorization",t.signer.authorizationString());for(var a in i)i.hasOwnProperty(a)&&o.setRequestHeader(a,i[a]);t.signer.setHeaders(o),t.request.contentType&&o.setRequestHeader("Content-Type",t.request.contentType),t.request.md5_digest&&o.setRequestHeader("Content-MD5",t.request.md5_digest),o.onerror=function(t){var e=t.responseText?g(t):"transport error";r(e)},"function"==typeof t.request.onProgress&&(o.upload.onprogress=t.request.onProgress),o.send(s),setTimeout(function(){t.started.resolve("request sent "+t.request.step)},20)})},e.prototype.authorize=function(){return this.request.dateString=this.signer.dateString(this.localTimeOffset),this.request.x_amz_headers=S(this.request.x_amz_headers,{"x-amz-date":this.request.dateString}),l(this).authorize()},e.prototype.authorizationSuccess=function(t){I.d(this.request.step,"signature:",t),this.request.auth=t},e.prototype.trySend=function(){var t=this;return this.authorize().then(function(e){t.authorizationSuccess(e),t.sendRequestToAWS().then(function(e){t.success(e)&&t.awsDeferred.resolve(e)},t.error.bind(t))},t.error.bind(t))},e.prototype.send=function(){return this.trySend(),this.awsDeferred.promise},r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.errorExceptionStatus=function(){return[E,F].indexOf(this.fileUpload.status)>-1},o.prototype=Object.create(r.prototype),o.prototype.constructor=o,o.prototype.maxRetries=1,o.prototype.errorHandler=function(t){if(this.attempts>this.maxRetries){var e=["MaxRetries exceeded. Will re-upload file id ",this.fileUpload.id,", ",t].join("");return I.w(e),this.awsDeferred.reject(e),!0}},s.prototype=Object.create(r.prototype),s.prototype.constructor=s,s.prototype.success=function(t){var e=t.response.match(new RegExp(this.request.response_match));return this.fileUpload.uploadId=e[1],this.fileUpload.awsKey=this.awsKey,I.d("InitiateMultipartUpload ID is",this.fileUpload.uploadId),this.fileUpload.createUploadFile(),!0},n.prototype=Object.create(r.prototype),n.prototype.constructor=n,n.prototype.getPayload=function(){return this.fileUpload.getCompletedPayload()},i.prototype=Object.create(o.prototype),i.prototype.constructor=i,i.prototype.awsKey=void 0,i.prototype.success=function(t){var e=t.getResponseHeader("Etag");if(e!==this.fileUpload.eTag){var r=["uploadId ",this.fileUpload.id," found on S3 but the Etag doesn't match."].join("");return this.awsDeferred.reject(r),!1}return!0},a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.prototype.awsKey=void 0,a.prototype.partNumberMarker=0,a.prototype.setupRequest=function(t){var e=["setupRequest() for uploadId:",this.fileUpload.uploadId,"for part marker:",t].join(" ");I.d(e),this.fileUpload.info(e),this.awsKey=this.fileUpload.name,this.partNumberMarker=t;var r={method:"GET",path:["?uploadId=",this.fileUpload.uploadId].join(""),query_string:"&part-number-marker="+t,x_amz_headers:this.fileUpload.xAmzHeadersCommon,step:"get upload parts",success404:!0};return this.request=r,r},a.prototype.success=function(t){if(404===t.status){var e=["uploadId ",this.fileUpload.id," not found on S3."].join("");return this.awsDeferred.reject(e),!1}var r=this.fileUpload.listPartsSuccess(this,t.responseText),o="true"===P(r,"IsTruncated");if(!o)return this.fileUpload.nameChanged(this.fileUpload.name),this.fileUpload.makePartsfromPartsOnS3(),!0;var s=this.setupRequest(P(r,"NextPartNumberMarker"));this.updateRequest(s),this.trySend()},p.prototype=Object.create(e.prototype),p.prototype.constructor=p,p.prototype.part=1,p.prototype.start=0,p.prototype.end=0,p.prototype.partNumber=void 0,
p.prototype.getPartMd5Digest=function(){var t=this,e=this.part,r=new FileReader;return new Promise(function(o){t.con.computeContentMd5&&!e.md5_digest?(r.onloadend=function(){var e=t.con.cryptoMd5Method.call(this,this.result);r=void 0,1===t.partNumber&&t.con.computeContentMd5&&"undefined"==typeof t.fileUpload.firstMd5Digest&&(t.fileUpload.firstMd5Digest=e,t.fileUpload.updateUploadFile({firstMd5Digest:e})),o(e)},r.readAsArrayBuffer(y(t.fileUpload.file,t.start,t.end))):o(e.md5_digest)}).then(function(e){e&&(I.d(t.request.step,"MD5 digest:",e),t.request.md5_digest=e,t.part.md5_digest=e)})},p.prototype.sendRequestToAWS=function(){return this.stalledInterval=setInterval(this.stalledPartMonitor(),D),this.stalledPartMonitor(),e.prototype.sendRequestToAWS.call(this)},p.prototype.send=function(){if(this.part.status!==_&&[E,H,F].indexOf(this.fileUpload.status)===-1){I.d("uploadPart #",this.partNumber,1===this.attempts?"submitting":"retrying"),this.part.status=M,this.attempts+=1,this.part.loadedBytesPrevious=null;var t=this;return this.getPartMd5Digest().then(function(){I.d("Sending",t.request.step),e.prototype.send.call(t)})}},p.prototype.success=function(t){clearInterval(this.stalledInterval);var e=t.getResponseHeader("ETag");return this.fileUpload.partSuccess(e,this)},p.prototype.onProgress=function(t){var e=t.loaded-this.part.loadedBytes;e&&(this.part.loadedBytes=t.loaded,this.fileUpload.fileTotalBytesUploaded+=e,this.progressTracker%this.con.progressMod===0&&this.fileUpload.progress(this.fileUpload.fileTotalBytesUploaded/this.fileUpload.sizeBytes),this.progressTracker++)},p.prototype.stalledPartMonitor=function(){var t=this.part.loadedBytes,e=this;return function(){clearInterval(e.stalledInterval),[M,j,A,H].indexOf(e.fileUpload.status)===-1&&e.part.status!==E&&e.part.loadedBytes<this.size&&(t===e.part.loadedBytes?(I.w("Part stalled. Will abort and retry:",e.partNumber,decodeURIComponent(e.fileUpload.name)),e.abort(),e.errorExceptionStatus()||e.delaySend()):this.stalledInterval=setInterval(e.stalledPartMonitor(),D))}},p.prototype.resetLoadedBytes=function(t){this.fileUpload.fileTotalBytesUploaded-=this.part.loadedBytes,this.part.loadedBytes=t,this.fileUpload.progress(this.fileUpload.fileTotalBytesUploaded/this.fileUpload.sizeBytes)},p.prototype.errorExceptionStatus=function(){return[F,E,H,A].indexOf(this.fileUpload.status)>-1},p.prototype.delaySend=function(){var t;this.part.status===j?(t=1===this.attempts?0:1e3*Math.min(this.con.maxRetryBackoffSecs,Math.pow(this.con.retryBackoffPower,this.attempts-2)),this.attempts+=1):t=0;var e=this,r=this.fileUpload.resolveForNext();setTimeout(function(){e.send(),r&&e.fileUpload.resolvePartNeeds("part needs satisfied")},t)},p.prototype.errorHandler=function(t){if(clearInterval(this.stalledInterval),t.match(/status:404/)){var e="404 error on part PUT. The part and the file will abort. "+t;return I.w(e),this.fileUpload.error(e),this.part.status=E,this.awsDeferred.reject(e),!0}return this.resetLoadedBytes(0),this.part.status=j,this.errorExceptionStatus()||this.delaySend(),!0},p.prototype.abort=function(){this.currentXhr&&this.currentXhr.abort(),this.resetLoadedBytes(0),this.attempts=1},p.size=0,p.prototype.getPayload=function(){var t=y(this.fileUpload.file,this.start,this.end);return I.d(this.partNumber,"payload bytes:",this.start,"->",this.end,", size:",t.size),this.part.isEmpty||0!==t.size||I.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),this.size=t.size,t},p.prototype.stalledInterval=-1,p.prototype.getStartedPromise=function(){return this.started.promise},u.prototype=Object.create(e.prototype),u.prototype.constructor=u,u.prototype.maxRetries=1,u.prototype.success=function(){return this.fileUpload.setStatus(E),!0},u.prototype.errorHandler=function(t){if(this.attempts>this.maxRetries){var e="Error aborting upload, Exceeded retries deleting the file upload: "+t;return I.w(e),this.fileUpload.error(e),this.awsDeferred.reject(e),!0}};var W={supported:function(){var t=!1;if("undefined"==typeof window)return t;if(!("localStorage"in window))return t;try{localStorage.setItem("___test","OK");var e=localStorage.getItem("___test");localStorage.removeItem("___test"),t="OK"===e}catch(e){return t}return t},getItem:function(t){if(this.supported())return localStorage.getItem(t)},setItem:function(t,e){if(this.supported())return localStorage.setItem(t,e)},clear:function(){if(this.supported())return localStorage.clear()},key:function(t){if(this.supported())return localStorage.key(t)},removeItem:function(t){if(this.supported())return localStorage.removeItem(t)}};I=C(),"undefined"!=typeof module&&module.exports?module.exports=L:"undefined"!=typeof window&&(window.Evaporate=L)}();
//# sourceMappingURL=evaporate.min.js.map