!function(){function e(e){return e?e.toISOString():""}function t(e,t,r){var n=e.slice?"slice":e.mozSlice?"mozSlice":"webkitSlice";return e[n](t,r)}var r=new Date("2060-10-22"),n=function(n){function o(){return{d:function(){},w:function(){},e:function(){}}}function a(e){var t=E.length;return E.push(new u(l({progress:function(){},complete:function(){},cancelled:function(){},info:function(){},warn:function(){},error:function(){}},e,{id:t,status:y,priority:0,onStatusChange:s,loadedBytes:0,sizeBytes:e.file.size,eTag:""}))),t}function s(){P.d("onFileUploadStatusChange"),d()}function i(){setTimeout(d,1)}function d(){P.d("processQueue   length: "+E.length);var e=-1,t=-1,r=!0;E.forEach(function(n,o){n.priority>t&&n.status===y&&(e=o,t=n.priority),n.status===v&&(r=!1)}),r&&e>=0&&E[e].start()}function u(n){function o(e){e!==w&&e!==b&&e!==S||(clearInterval(se),clearInterval(ie)),de.status=e,de.onStatusChange()}function a(){P.d("cancelAllRequests()");for(var e=1;e<ue.length;e++)u(e,!0);U()}function s(){M.computeContentMd5&&de.file.size>0?R():(N(),X())}function i(e){var t,r={method:"POST",path:te()+"?uploads",step:"initiate",x_amz_headers:de.xAmzHeadersAtInitiate,not_signed_headers:de.notSignedHeadersAtInitiate},n=de.status;de.contentType&&(r.contentType=de.contentType),r.onErr=function(r){t||de.status===T||de.status===S||(t=!0,P.d("onInitiateError for FileUpload "+de.id),de.warn("Error initiating upload"),o(b),r.abort(),setTimeout(function(){de.status!==T&&de.status!==S&&(de.status=n,i(e))},G(fe++)))},r.on200=function(t){var n=t.response.match(/<UploadId>(.+)<\/UploadId>/);n&&n[1]?(de.uploadId=n[1],de.awsKey=e,P.d("requester success. got uploadId "+de.uploadId),C(),s()):r.onErr()},Q(r),V(r),W()}function d(e){function r(e){var t=new DOMParser,r=t.parseFromString(e.responseText,"text/xml"),n=r.getElementsByTagName("Code"),o=r.getElementsByTagName("Message");return n=n.length?n[0].innerHTML:"",o=o.length?o[0].innerHTML:"",n.length?{code:n,msg:o}:{}}var n,o,a,s;s=ue[e],s.status=v,pe++,s.loadedBytesPrevious=null,n=G(s.attempts++),P.d("uploadPart #"+e+"     will wait "+n+"ms to try"),a={method:"PUT",path:te()+"?partNumber="+e+"&uploadId="+de.uploadId,step:"upload #"+e,x_amz_headers:de.xAmzHeadersAtUpload,md5_digest:s.md5_digest,attempts:s.attempts,part:s},a.onErr=function(t,n){if(de.status!==S&&de.status!==T){var a="problem uploading part #"+e+",   http status: "+t.status+",   hasErrored: "+!!o+",   part status: "+s.status+",   readyState: "+t.readyState+(n?",   isOnError":"");if(P.w(a),de.warn(a),!o){if(o=!0,404===t.status){var i="404 error resulted in abortion of both this part and the entire file.";P.w(i+" Server response: "+t.response),de.error(i),s.status=T,U()}else{s.status=b,s.loadedBytes=0;var d=r(t);d.code&&P.e('AWS Server response: code="'+d.code+'", message="'+d.msg+'"'),X()}t.abort()}}},a.on200=function(t){var r,n=t.getResponseHeader("ETag");P.d("uploadPart 200 response for part #"+e+"     ETag: "+n),s.isEmpty||n!==z?(s.eTag=n,s.status=w):(s.status=b,s.loadedBytes=0,r="eTag matches MD5 of 0 length blob for part #"+e+"   Retrying part.",P.w(r),de.warn(r)),X()},a.onProgress=function(e){s.loadedBytes=e.loaded},a.toSend=function(){var r=t(de.file,s.start,s.end);return P.d("part # "+e+" (bytes "+s.start+" -> "+s.end+")  reported length: "+r.size),s.isEmpty||0!==r.size||P.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),r},a.onFailedAuth=function(){var t="onFailedAuth for uploadPart #"+e+".   Will set status to ERROR";P.w(t),de.warn(t),s.status=b,s.loadedBytes=0,X()},Q(a),setTimeout(function(){de.status!==T&&de.status!==S&&(V(a),P.d("upload #",e,a))},n),s.uploader=a}function u(e,t){var r=ue[e];r.currentXhr&&(t&&(r.currentXhr.onreadystatechange=function(){}),r.currentXhr.abort())}function I(){P.d("completeUpload"),de.info("will attempt to complete upload");var e,t=[],r=de.status;t.push("<CompleteMultipartUpload>"),ue.forEach(function(e,r){e&&t.push(["<Part><PartNumber>",r,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].join(""))}),t.push("</CompleteMultipartUpload>");var n={method:"POST",contentType:"application/xml; charset=UTF-8",path:te()+"?uploadId="+de.uploadId,x_amz_headers:de.xAmzHeadersAtComplete,step:"complete"};n.onErr=function(t){if(!e&&de.status!==T&&de.status!==S){e=!0;var n="Error completing upload.";P.w(n),de.error(n),o(b),t.abort(),setTimeout(function(){de.status!==T&&de.status!==S&&(de.status=r,I(),W())},G(ce++))}},n.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("CompleteMultipartUploadResult")[0];de.eTag=h(r,"ETag"),de.complete(e,de.name),k()},n.toSend=function(){return t.join("")},Q(n),V(n)}function E(e){P.d("headObject"),de.info("will attempt to verify existence of the file");var t={method:"HEAD",path:te(),step:"head_object"};t.onErr=function(){var t="Error completing head object. Will re-upload file.";P.w(t),i(e)},t.on200=function(t){var r=t.getResponseHeader("Etag");r===de.eTag?(P.d("headObject found matching object on S3."),de.progress(1),de.complete(t,de.name),o(w)):(P.d("headObject not found on S3."),i(e))},Q(t),V(t)}function B(e){return function(){var t=de.status;if(t!==b&&t!==S&&t!==T){var r=M.cryptoMd5Method.call(this,this.result);P.d(["part #",e.part," MD5 digest is ",r].join("")),e.md5_digest=r,1===e.part&&N(),delete e.reader,me+=1,X(),me===ge&&P.d("All parts have MD5 digests"),setTimeout(R,1500)}}}function R(){for(var e=1;e<=ge;e++){var r=ue[e];if(r.status!==w&&null===r.md5_digest){if(e>1||"undefined"==typeof de.firstMd5Digest){r.reader=new FileReader,r.reader.onloadend=B(r),r.reader.readAsArrayBuffer(t(de.file,r.start,r.end));break}r.md5_digest=de.firstMd5Digest,N(),X()}}}function U(){if(P.d("abortUpload"),de.info("will attempt to abort the upload"),"undefined"==typeof de.uploadId)return void o(T);var e={method:"DELETE",path:te()+"?uploadId="+de.uploadId,step:"abort",successStatus:204};e.onErr=function(){var e="Error aborting upload.";P.w(e),de.error(e)},e.on200=function(){o(T),D()},Q(e),V(e)}function D(){P.d("listParts"),de.info("list parts");var e={method:"GET",path:te()+"?uploadId="+de.uploadId,step:"list"};e.onErr=function(e){if(404===e.status)L(),de.info("upload canceled");else{var t="Error listing parts.";P.w(t),de.error(t)}},e.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("Part");r.length?(P.d("Parts still found after abort...waiting."),setTimeout(function(){U()},1e3)):de.info("upload canceled")},Q(e),V(e)}function O(e){P.d("getUploadParts() for uploadId starting at part # "+e),de.info("getUploadParts() for uploadId starting at part # "+e);var t={method:"GET",path:te()+"?uploadId="+de.uploadId,query_string:"&part-number-marker="+e,step:"get upload parts"};t.onErr=function(t){if(404===t.status)de.info(["uploadId ",de.uploadId," does not exist."].join("")),L(),W(),C(),X();else{var r="Error listing parts for getUploadParts() starting at part # "+e;P.w(r),de.error(r)}},t.on200=function(t){de.info(["uploadId ",de.uploadId," is not complete. Fetching parts from part marker=",e].join(""));for(var r,n,o=p(t.responseText),a=o.getElementsByTagName("ListPartsResult")[0],i="true"===h(a,"IsTruncated"),d=o.getElementsByTagName("Part"),u=d.length,l=0;l<u;l++)n=d[l],le.push({eTag:h(n,"ETag"),partNumber:parseInt(h(n,"PartNumber")),size:parseInt(h(n,"Size")),LastModified:h(n,"LastModified")});if(o=d=null,i){var f=h(a,"NextPartNumberMarker");O(f)}else C(),le.forEach(function(e){r=H(e.partNumber,w,e.size),r.eTag=e.eTag,r.attempts=1,r.loadedBytes=e.size,r.loadedBytesPrevious=e.size,r.finishedUploadingAt=e.LastModified,r.md5_digest="n/a",ue[e.partNumber]=r}),W(),s();a=null},Q(t),V(t)}function C(){ge=Math.ceil(de.file.size/M.partSize)||1;for(var e=1;e<=ge;e++){var t="undefined"==typeof ue[e]?y:ue[e].status;t!==w&&(ue[e]=H(e,y,de.file.size))}}function H(e,t,r){return{status:t,start:(e-1)*M.partSize,end:e*M.partSize,attempts:0,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,part:e}}function N(){var t=c(de),r={awsKey:de.name,bucket:M.bucket,uploadId:de.uploadId,fileSize:de.file.size,fileType:de.file.type,lastModifiedDate:e(de.file.lastModifiedDate),partSize:M.partSize,signParams:de.signParams,createdAt:(new Date).toISOString()};M.computeContentMd5&&ue.length&&"undefined"!=typeof ue[1].md5_digest&&(r.firstMd5Digest=ue[1].md5_digest),m(t,r)}function k(){var e=f(),t=e[c(de)];"undefined"!=typeof t&&(t.completedAt=(new Date).toISOString(),t.eTag=de.eTag,x.setItem("awsUploads",JSON.stringify(e))),o(w),de.progress(1)}function L(){"undefined"!=typeof de.file&&g(c(de))}function j(){var e=f(!0),t=e[c(de)];q(t)&&(de.uploadId=t.uploadId,de.name=t.awsKey,de.eTag=t.eTag,de.firstMd5Digest=t.firstMd5Digest,de.signParams=t.signParams)}function q(e){if("undefined"==typeof e)return!1;var t=new Date(e.completedAt||r);return M.partSize===e.partSize&&t>A&&M.bucket===e.bucket&&(!M.onlyRetryForSameFileName||de.name===e.awsKey)}function G(e){return 1===e?0:1e3*Math.min(M.maxRetryBackoffSecs,Math.pow(M.retryBackoffPower,e-2))}function X(){var e,t=0,r=!0,n=!1,o=[],a=[];if(de.status!==v)return void de.info("will not process parts list, as not currently evaporating");for(var s=0;s<ue.length;s++){var i=ue[s];if(i){if(M.computeContentMd5&&null===i.md5_digest)return;var u=!1;switch(o.push(i.status),i.status){case v:r=!1,t++,a.push(i.loadedBytes);break;case b:n=!0,u=!0;break;case y:u=!0}u&&(r=!1,t<M.maxConcurrentParts&&(d(s),t++))}}e=o.toString()+" // bytesLoaded: "+a.toString(),P.d("processPartsList()  anyPartHasErrored: "+n,e),(pe>=ue.length-1||n)&&de.info("part stati: "+e),r&&I()}function J(){se=setInterval(function(){var e=0;ue.forEach(function(t){e+=t.loadedBytes}),de.progress(e/de.sizeBytes)},M.progressIntervalMS)}function K(){ie=setInterval(function(){P.d("monitorPartsProgress() "+new Date),ue.forEach(function(e,t){var r;return e.status!==v?void P.d(t,"not evaporating "):null===e.loadedBytesPrevious?(P.d(t,"no previous "),void(e.loadedBytesPrevious=e.loadedBytes)):(r=e.loadedBytesPrevious<e.loadedBytes,M.simulateStalling&&4===t&&Math.random()<.25&&(r=!1),P.d(t,r?"moving. ":"stalled.",e.loadedBytesPrevious,e.loadedBytes),r||setTimeout(function(){de.info("part #"+t+" stalled. will abort. "+e.loadedBytesPrevious+" "+e.loadedBytes),u(t)},0),void(e.loadedBytesPrevious=e.loadedBytes))})},12e4)}function W(){J(),K()}function Q(e){P.d("setupRequest()",e),M.timeUrl?e.dateString=new Date((new Date).getTime()+F).toUTCString():e.dateString=(new Date).toUTCString(),e.x_amz_headers=l(e.x_amz_headers,{"x-amz-date":e.dateString}),e.onGotAuth=function(){if(ne(e))return void P.w("onGotAuth() step",e.step,"is already in progress. Returning.");var t=oe(e),r=e.toSend?e.toSend():null,n=_+e.path;e.query_string&&(n+=e.query_string);var o={},a=e.successStatus||200;l(o,e.not_signed_headers),l(o,e.x_amz_headers),M.simulateErrors&&1===e.attempts&&"upload #3"===e.step&&(P.d("simulating error by POST part #3 to invalid url"),n="https:///foo"),t.open(e.method,n),t.setRequestHeader("Authorization","AWS "+M.aws_key+":"+e.auth);for(var s in o)o.hasOwnProperty(s)&&t.setRequestHeader(s,o[s]);e.contentType&&t.setRequestHeader("Content-Type",e.contentType),e.md5_digest&&t.setRequestHeader("Content-MD5",e.md5_digest),t.onreadystatechange=function(){4===t.readyState&&(r&&P.d("  ### "+r.size),ae(e),t.status===a?e.on200(t):e.onErr(t))},t.onerror=function(){ae(e),e.onErr(t,!0)},"function"==typeof e.onProgress&&(t.upload.onprogress=function(t){e.onProgress(t)}),t.send(r)},e.onFailedAuth=e.onFailedAuth||function(t){de.error("Error onFailedAuth for step: "+e.step),e.onErr(t)}}function V(e){if(P.d("authorizedSend() "+e.step),ne(e))return void P.w("authorizedSend() step",e.step,"is already in progress. Returning.");if(M.awsLambda)return Y(e);var t,r=oe(e),n=M.signerUrl+"?to_sign="+encodeURIComponent(ee(e)),o=$(de.signParams);for(var a in o)o.hasOwnProperty(a)&&(n+="&"+encodeURIComponent(a)+"="+encodeURIComponent(o[a]));r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status){var n=Z(r.response);28!==n.length?(t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,P.w(t),de.warn(t),ae(e),e.onFailedAuth(r)):(P.d("authorizedSend got signature for step: '"+e.step+"'    sig: "+n),e.auth=n,ae(e),e.onGotAuth())}else t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,P.w(t),de.warn(t),ae(e),e.onFailedAuth(r)},r.onerror=function(){t="failed to get authorization (onerror) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,P.w(t),de.warn(t),e.onFailedAuth(r)},r.open("GET",n);var s=$(de.signHeaders);for(var i in s)s.hasOwnProperty(i)&&r.setRequestHeader(i,s[i]);"function"==typeof de.beforeSigner&&de.beforeSigner(r,n),r.send()}function Y(e){M.awsLambda.invoke({FunctionName:M.awsLambdaFunction,InvocationType:"RequestResponse",Payload:JSON.stringify({to_sign:ee(e),sign_params:$(de.signParams),sign_headers:$(de.signHeaders)})},function(t,r){if(t){var n="failed to get authorization with lambda "+t;return P.w(n),de.warn(n),void e.onFailedAuth(t)}var o=Z(JSON.parse(r.Payload));e.auth=o,e.onGotAuth()})}function Z(e){return"function"==typeof M.signResponseHandler&&(e=M.signResponseHandler(e)||e),e}function $(e){var t={};for(var r in e)e.hasOwnProperty(r)&&("function"==typeof e[r]?t[r]=e[r]():t[r]=e[r]);return t}function ee(e){var t,r="",n=[];for(var o in e.x_amz_headers)e.x_amz_headers.hasOwnProperty(o)&&n.push(o);return n.sort(),n.forEach(function(t){r+=t+":"+e.x_amz_headers[t]+"\n"}),t=e.method+"\n"+(e.md5_digest||"")+"\n"+(e.contentType||"")+"\n\n"+r+(M.cloudfront?"/"+M.bucket:"")+e.path}function te(){var e="/"+M.bucket+"/"+de.name;return(M.cloudfront||_.indexOf("cloudfront")>-1)&&(e="/"+de.name),e}function re(e){return"undefined"==typeof e.part?e:e.part}function ne(e){return!!re(e).currentXhr}function oe(e){return re(e).currentXhr=new XMLHttpRequest}function ae(e){delete re(e).currentXhr}var se,ie,de=this,ue=[],le=[],pe=0,fe=0,ce=0;l(de,n),de.start=function(){P.d("starting FileUpload "+de.id),o(v);var e=de.name;if(j(),"undefined"==typeof de.uploadId)i(e);else if("undefined"!=typeof de.eTag&&de.firstMd5Digest){var r=new FileReader;r.onloadend=function(){var t=M.cryptoMd5Method.call(this,this.result);M.allowS3ExistenceOptimization&&de.firstMd5Digest===t?E(e):(de.firstMd5Digest=t,i(e))},r.readAsArrayBuffer(t(de.file,0,M.partSize))}else O(0)},de.stop=function(){P.d("stopping FileUpload ",de.id),de.cancelled(),o(S),de.info("Canceling uploads..."),a()};var me=0,ge=-1}function l(e,t,r){if(e="undefined"==typeof e?{}:e,"object"==typeof r)for(var n in r)t[n]=r[n];for(var o in t)e[o]=t[o];return e}function p(e){var t=new DOMParser;return t.parseFromString(e,"text/xml")}function f(e){var t=JSON.parse(x.getItem("awsUploads")||"{}");if(e)for(var n in t)if(t.hasOwnProperty(n)){var o=t[n],a=new Date(o.completedAt||r);a<A&&delete t[n]}return t}function c(t){return[t.file.name,t.file.type,e(t.file.lastModifiedDate),t.file.size].join("-")}function m(e,t){var r=f();r[e]=t,x.setItem("awsUploads",JSON.stringify(r))}function g(e){var t=f();delete t[e],x.setItem("awsUploads",JSON.stringify(t))}function h(e,t){return e.getElementsByTagName(t)[0].textContent}var y=0,v=2,w=3,S=5,b=10,T=20,z='"d41d8cd98f00b204e9800998ecf8427e"',I=this,E=[],P=o(),M=l({logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:500,cloudfront:!1,s3Acceleration:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,onlyRetryForSameFileName:!1,timeUrl:null,cryptoMd5Method:null,s3FileCacheHoursAgo:null,signParams:{},signHeaders:{},awsLambda:null,awsLambdaFunction:null,maxFileSize:null,signResponseHandler:null,testUnsupported:!1,simulateStalling:!1,simulateErrors:!1},n);if(console&&console.log&&(P=console,P.d=P.log,P.w=console.warn?P.warn:P.d,P.e=console.error?P.error:P.d),this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)||n.testUnsupported),!this.supported)return void P.e("The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]");if(M.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return void P.e("The browser's FileReader object does not support readAsArrayBuffer");if("function"!=typeof M.cryptoMd5Method)return void P.e("Option computeContentMd5 has been set but cryptoMd5Method is not defined.")}M.logging||(P=o());var _,x={supported:function(){var e=!1;if("undefined"==typeof window)return e;if(!("localStorage"in window))return e;try{localStorage.setItem("___test","OK");var t=localStorage.getItem("___test");localStorage.removeItem("___test"),e="OK"===t}catch(t){return e}return e}(),getItem:function(e){if(this.supported)return localStorage.getItem(e)},setItem:function(e,t){if(this.supported)return localStorage.setItem(e,t)},clear:function(){if(this.supported)return localStorage.clear()},key:function(e){if(this.supported)return localStorage.key(e)},removeItem:function(e){if(this.supported)return localStorage.removeItem(e)}};M.s3Acceleration?(_=["https://",M.bucket,".s3-accelerate.amazonaws.com"].join(""),M.cloudfront=!0):_=M.aws_url||"https://s3.amazonaws.com";var B=new Date,A=new Date(B.setHours(B.getHours()-(M.s3FileCacheHoursAgo||-100))),F=0;if(M.timeUrl){var R=new XMLHttpRequest;R.open("GET",M.timeUrl+"?requestTime="+(new Date).getTime()),R.onreadystatechange=function(){if(4===R.readyState&&200===R.status){var e=new Date(Date.parse(R.responseText)),t=new Date;F=t-e,P.d("localTimeOsset is",F,"ms")}},R.onerror=function(){P.e("xhr error timeUrl",R)},R.send()}I.add=function(e){P.d("add");var t;if("undefined"==typeof e)return"Missing file";if(M.maxFileSize&&e.size>M.maxFileSize)return"File size too large. Maximum size allowed is "+M.maxFileSize;if("undefined"==typeof e.name?t="Missing attribute: name  ":M.encodeFilename&&(e.name=encodeURIComponent(e.name)),t)return t;var r=a(e);return i(),r},I.cancel=function(e){return P.d("cancel ",e),!!E[e]&&(E[e].stop(),!0)},I.pause=function(e){},I.resume=function(e){},I.forceRetry=function(){}};"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof window&&(window.Evaporate=n)}();
//# sourceMappingURL=evaporate.min.js.map