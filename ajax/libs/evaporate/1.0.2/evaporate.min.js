!function(){function e(e){return e?e.toISOString():""}function t(e,t,r){var n=e.slice?"slice":e.mozSlice?"mozSlice":"webkitSlice";return e[n](t,r)}var r=new Date("2060-10-22"),n=function(n){function o(){return{d:function(){},w:function(){},e:function(){}}}function a(e){var t=z.length;return z.push(new u(l({progress:function(){},complete:function(){},cancelled:function(){},info:function(){},warn:function(){},error:function(){}},e,{id:t,status:y,priority:0,onStatusChange:s,loadedBytes:0,sizeBytes:e.file.size,eTag:""}))),t}function s(){M.d("onFileUploadStatusChange"),d()}function i(){setTimeout(d,1)}function d(){M.d("processQueue   length: "+z.length);var e=-1,t=-1,r=!0;z.forEach(function(n,o){n.priority>t&&n.status===y&&(e=o,t=n.priority),n.status===v&&(r=!1)}),r&&e>=0&&z[e].start()}function u(n){function o(e){e!==w&&e!==T&&e!==S||(clearInterval(re),clearInterval(ne)),oe.status=e,oe.onStatusChange()}function a(){M.d("cancelAllRequests()");for(var e=1;e<ae.length;e++)u(e,!0);R()}function s(){_.computeContentMd5&&oe.file.size>0?U():(F(),X())}function i(e){var t,r={method:"POST",path:Y()+"?uploads",step:"initiate",x_amz_headers:oe.xAmzHeadersAtInitiate,not_signed_headers:oe.notSignedHeadersAtInitiate},n=oe.status;oe.contentType&&(r.contentType=oe.contentType),r.onErr=function(r){t||oe.status===I||oe.status===S||(t=!0,M.d("onInitiateError for FileUpload "+oe.id),oe.warn("Error initiating upload"),o(T),r.abort(),setTimeout(function(){oe.status!==I&&oe.status!==S&&(oe.status=n,i(e))},L(de++)))},r.on200=function(t){var n=t.response.match(/<UploadId>(.+)<\/UploadId>/);n&&n[1]?(oe.uploadId=n[1],oe.awsKey=e,M.d("requester success. got uploadId "+oe.uploadId),O(),s()):r.onErr()},J(r),Q(r),K()}function d(e){function r(e){var t=new DOMParser,r=t.parseFromString(e.responseText,"text/xml"),n=r.getElementsByTagName("Code"),o=r.getElementsByTagName("Message");return n=n.length?n[0].innerHTML:"",o=o.length?o[0].innerHTML:"",n.length?{code:n,msg:o}:{}}var n,o,a,s;s=ae[e],s.status=v,ie++,s.loadedBytesPrevious=null,n=L(s.attempts++),M.d("uploadPart #"+e+"     will wait "+n+"ms to try"),a={method:"PUT",path:Y()+"?partNumber="+e+"&uploadId="+oe.uploadId,step:"upload #"+e,x_amz_headers:oe.xAmzHeadersAtUpload,md5_digest:s.md5_digest,attempts:s.attempts,part:s},a.onErr=function(t,n){if(oe.status!==S&&oe.status!==I){var a="problem uploading part #"+e+",   http status: "+t.status+",   hasErrored: "+!!o+",   part status: "+s.status+",   readyState: "+t.readyState+(n?",   isOnError":"");if(M.w(a),oe.warn(a),!o){if(o=!0,404===t.status){var i="404 error resulted in abortion of both this part and the entire file.";M.w(i+" Server response: "+t.response),oe.error(i),s.status=I,R()}else{s.status=T,s.loadedBytes=0;var d=r(t);d.code&&M.e('AWS Server response: code="'+d.code+'", message="'+d.msg+'"'),X()}t.abort()}}},a.on200=function(t){var r,n=t.getResponseHeader("ETag");M.d("uploadPart 200 response for part #"+e+"     ETag: "+n),s.isEmpty||n!==E?(s.eTag=n,s.status=w):(s.status=T,s.loadedBytes=0,r="eTag matches MD5 of 0 length blob for part #"+e+"   Retrying part.",M.w(r),oe.warn(r)),X()},a.onProgress=function(e){s.loadedBytes=e.loaded},a.toSend=function(){var r=t(oe.file,s.start,s.end);return M.d("part # "+e+" (bytes "+s.start+" -> "+s.end+")  reported length: "+r.size),s.isEmpty||0!==r.size||M.w("  *** WARN: blob reporting size of 0 bytes. Will try upload anyway.."),r},a.onFailedAuth=function(){var t="onFailedAuth for uploadPart #"+e+".   Will set status to ERROR";M.w(t),oe.warn(t),s.status=T,s.loadedBytes=0,X()},J(a),setTimeout(function(){oe.status!==I&&oe.status!==S&&(Q(a),M.d("upload #",e,a))},n),s.uploader=a}function u(e,t){var r=ae[e];r.currentXhr&&(t&&(r.currentXhr.onreadystatechange=function(){}),r.currentXhr.abort())}function P(){M.d("completeUpload"),oe.info("will attempt to complete upload");var e,t=[],r=oe.status;t.push("<CompleteMultipartUpload>"),ae.forEach(function(e,r){e&&t.push(["<Part><PartNumber>",r,"</PartNumber><ETag>",e.eTag,"</ETag></Part>"].join(""))}),t.push("</CompleteMultipartUpload>");var n={method:"POST",contentType:"application/xml; charset=UTF-8",path:Y()+"?uploadId="+oe.uploadId,x_amz_headers:oe.xAmzHeadersAtComplete,step:"complete"};n.onErr=function(t){if(!e&&oe.status!==I&&oe.status!==S){e=!0;var n="Error completing upload.";M.w(n),oe.error(n),o(T),t.abort(),setTimeout(function(){oe.status!==I&&oe.status!==S&&(oe.status=r,P(),K())},L(ue++))}},n.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("CompleteMultipartUploadResult")[0];oe.eTag=h(r,"ETag"),oe.complete(e,oe.name),N()},n.toSend=function(){return t.join("")},J(n),Q(n)}function z(e){M.d("headObject"),oe.info("will attempt to verify existence of the file");var t={method:"HEAD",path:Y(),step:"head_object"};t.onErr=function(){var t="Error completing head object. Will re-upload file.";M.w(t),i(e)},t.on200=function(t){var r=t.getResponseHeader("Etag");r===oe.eTag?(M.d("headObject found matching object on S3."),oe.progress(1),oe.complete(t,oe.name),o(w)):(M.d("headObject not found on S3."),oe.name=e,i(e))},J(t),Q(t)}function x(e){return function(){var t=oe.status;if(t!==T&&t!==S&&t!==I){var r=_.cryptoMd5Method.call(this,this.result);M.d(["part #",e.part," MD5 digest is ",r].join("")),e.md5_digest=r,1===e.part&&F(),delete e.reader,le+=1,X(),le===pe&&M.d("All parts have MD5 digests"),setTimeout(U,1500)}}}function U(){for(var e=1;e<=pe;e++){var r=ae[e];if(r.status!==w&&null===r.md5_digest){if(e>1||"undefined"==typeof oe.firstMd5Digest){r.reader=new FileReader,r.reader.onloadend=x(r),r.reader.readAsArrayBuffer(t(oe.file,r.start,r.end));break}r.md5_digest=oe.firstMd5Digest,F(),X()}}}function R(){M.d("abortUpload"),oe.info("will attempt to abort the upload");var e={method:"DELETE",path:Y()+"?uploadId="+oe.uploadId,step:"abort",successStatus:204};e.onErr=function(){var e="Error aborting upload.";M.w(e),oe.error(e)},e.on200=function(){o(I),D()},J(e),Q(e)}function D(){M.d("listParts"),oe.info("list parts");var e={method:"GET",path:Y()+"?uploadId="+oe.uploadId,step:"list"};e.onErr=function(e){if(404===e.status)k(),oe.info("upload canceled");else{var t="Error listing parts.";M.w(t),oe.error(t)}},e.on200=function(e){var t=p(e.responseText),r=t.getElementsByTagName("Part");r.length?(M.d("Parts still found after abort...waiting."),setTimeout(function(){R()},1e3)):oe.info("upload canceled")},J(e),Q(e)}function C(e){M.d("getUploadParts() for uploadId starting at part # "+e),oe.info("getUploadParts() for uploadId starting at part # "+e);var t={method:"GET",path:Y()+"?uploadId="+oe.uploadId,query_string:"&part-number-marker="+e,step:"get upload parts"};t.onErr=function(t){if(404===t.status)oe.info(["uploadId ",oe.uploadId," does not exist."].join("")),k(),K(),O(),X();else{var r="Error listing parts for getUploadParts() starting at part # "+e;M.w(r),oe.error(r)}},t.on200=function(t){oe.info(["uploadId ",oe.uploadId," is not complete. Fetching parts from part marker=",e].join(""));for(var r,n,o=p(t.responseText),a=o.getElementsByTagName("ListPartsResult")[0],i="true"===h(a,"IsTruncated"),d=o.getElementsByTagName("Part"),u=d.length,l=0;l<u;l++)n=d[l],se.push({eTag:h(n,"ETag"),partNumber:parseInt(h(n,"PartNumber")),size:parseInt(h(n,"Size")),LastModified:h(n,"LastModified")});if(o=d=null,i){var f=h(a,"NextPartNumberMarker");C(f)}else O(),se.forEach(function(e){r=H(e.partNumber,w,e.size),r.eTag=e.eTag,r.attempts=1,r.loadedBytes=e.size,r.loadedBytesPrevious=e.size,r.finishedUploadingAt=e.LastModified,r.md5_digest="n/a",ae[e.partNumber]=r}),K(),s();a=null},J(t),Q(t)}function O(){pe=Math.ceil(oe.file.size/_.partSize)||1;for(var e=1;e<=pe;e++){var t="undefined"==typeof ae[e]?y:ae[e].status;t!==w&&(ae[e]=H(e,y,oe.file.size))}}function H(e,t,r){return{status:t,start:(e-1)*_.partSize,end:e*_.partSize,attempts:0,loadedBytes:0,loadedBytesPrevious:null,isEmpty:0===r,md5_digest:null,part:e}}function F(){var t=c(oe),r={awsKey:oe.name,uploadId:oe.uploadId,fileSize:oe.file.size,fileType:oe.file.type,lastModifiedDate:e(oe.file.lastModifiedDate),partSize:_.partSize,signParams:oe.signParams,createdAt:(new Date).toISOString()};_.computeContentMd5&&ae.length&&"undefined"!=typeof ae[1].md5_digest&&(r.firstMd5Digest=ae[1].md5_digest),g(t,r)}function N(){var e=f(),t=e[c(oe)];"undefined"!=typeof t&&(t.completedAt=(new Date).toISOString(),t.eTag=oe.eTag,B.setItem("awsUploads",JSON.stringify(e))),o(w),oe.progress(1)}function k(){"undefined"!=typeof oe.file&&m(c(oe))}function q(){var e=f(!0),t=e[c(oe)];j(t)&&(oe.uploadId=t.uploadId,oe.name=t.awsKey,oe.eTag=t.eTag,oe.firstMd5Digest=t.firstMd5Digest,oe.signParams=t.signParams)}function j(e){if("undefined"==typeof e)return!1;var t=new Date(e.completedAt||r);return _.partSize===e.partSize&&t>A}function L(e){return 1===e?0:1e3*Math.min(_.maxRetryBackoffSecs,Math.pow(_.retryBackoffPower,e-2))}function X(){var e,t=0,r=!0,n=!1,o=[],a=[];if(oe.status!==v)return void oe.info("will not process parts list, as not currently evaporating");for(var s=0;s<ae.length;s++){var i=ae[s];if(i){if(_.computeContentMd5&&null===i.md5_digest)return;var u=!1;switch(o.push(i.status),i.status){case v:r=!1,t++,a.push(i.loadedBytes);break;case T:n=!0,u=!0;break;case y:u=!0}u&&(r=!1,t<_.maxConcurrentParts&&(d(s),t++))}}e=o.toString()+" // bytesLoaded: "+a.toString(),M.d("processPartsList()  anyPartHasErrored: "+n,e),(ie>=ae.length-1||n)&&oe.info("part stati: "+e),r&&P()}function G(){re=setInterval(function(){var e=0;ae.forEach(function(t){e+=t.loadedBytes}),oe.progress(e/oe.sizeBytes)},_.progressIntervalMS)}function W(){ne=setInterval(function(){M.d("monitorPartsProgress() "+new Date),ae.forEach(function(e,t){var r;return e.status!==v?void M.d(t,"not evaporating "):null===e.loadedBytesPrevious?(M.d(t,"no previous "),void(e.loadedBytesPrevious=e.loadedBytes)):(r=e.loadedBytesPrevious<e.loadedBytes,_.simulateStalling&&4===t&&Math.random()<.25&&(r=!1),M.d(t,r?"moving. ":"stalled.",e.loadedBytesPrevious,e.loadedBytes),r||setTimeout(function(){oe.info("part #"+t+" stalled. will abort. "+e.loadedBytesPrevious+" "+e.loadedBytes),u(t)},0),void(e.loadedBytesPrevious=e.loadedBytes))})},12e4)}function K(){G(),W()}function J(e){if(M.d("setupRequest()",e),_.timeUrl){var t=new XMLHttpRequest;t.open("GET",_.timeUrl+"?requestTime="+(new Date).getTime(),!1),t.send(),e.dateString=t.responseText}else e.dateString=(new Date).toUTCString();e.x_amz_headers=l(e.x_amz_headers,{"x-amz-date":e.dateString}),e.onGotAuth=function(){if($(e))return void M.w("onGotAuth() step",e.step,"is already in progress. Returning.");var t=ee(e),r=e.toSend?e.toSend():null,n=b+e.path;e.query_string&&(n+=e.query_string);var o={},a=e.successStatus||200;l(o,e.not_signed_headers),l(o,e.x_amz_headers),_.simulateErrors&&1===e.attempts&&"upload #3"===e.step&&(M.d("simulating error by POST part #3 to invalid url"),n="https:///foo"),t.open(e.method,n),t.setRequestHeader("Authorization","AWS "+_.aws_key+":"+e.auth);for(var s in o)o.hasOwnProperty(s)&&t.setRequestHeader(s,o[s]);e.contentType&&t.setRequestHeader("Content-Type",e.contentType),e.md5_digest&&t.setRequestHeader("Content-MD5",e.md5_digest),t.onreadystatechange=function(){4===t.readyState&&(r&&M.d("  ### "+r.size),te(e),t.status===a?e.on200(t):e.onErr(t))},t.onerror=function(){te(e),e.onErr(t,!0)},"function"==typeof e.onProgress&&(t.upload.onprogress=function(t){e.onProgress(t)}),t.send(r)},e.onFailedAuth=e.onFailedAuth||function(t){oe.error("Error onFailedAuth for step: "+e.step),e.onErr(t)}}function Q(e){if(M.d("authorizedSend() "+e.step),$(e))return void M.w("authorizedSend() step",e.step,"is already in progress. Returning.");var t,r=ee(e),n=_.signerUrl+"?to_sign="+V(e);for(var o in oe.signParams)oe.signParams.hasOwnProperty(o)&&(n+="function"==typeof oe.signParams[o]?"&"+encodeURIComponent(o)+"="+encodeURIComponent(oe.signParams[o]()):"&"+encodeURIComponent(o)+"="+encodeURIComponent(oe.signParams[o]));r.onreadystatechange=function(){4===r.readyState&&(200===r.status&&28===r.response.length?(M.d("authorizedSend got signature for step: '"+e.step+"'    sig: "+r.response),e.auth=r.response,te(e),e.onGotAuth()):(t="failed to get authorization (readyState=4) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,M.w(t),oe.warn(t),te(e),e.onFailedAuth(r)))},r.onerror=function(){t="failed to get authorization (onerror) for "+e.step+".  xhr.status: "+r.status+".  xhr.response: "+r.response,M.w(t),oe.warn(t),e.onFailedAuth(r)},r.open("GET",n);for(var a in oe.signHeaders)oe.signHeaders.hasOwnProperty(a)&&("function"==typeof oe.signHeaders[a]?r.setRequestHeader(a,oe.signHeaders[a]()):r.setRequestHeader(a,oe.signHeaders[a]));"function"==typeof oe.beforeSigner&&oe.beforeSigner(r),r.send()}function V(e){var t,r="",n=[];for(var o in e.x_amz_headers)e.x_amz_headers.hasOwnProperty(o)&&n.push(o);return n.sort(),n.forEach(function(t){r+=t+":"+e.x_amz_headers[t]+"\n"}),t=e.method+"\n"+(e.md5_digest||"")+"\n"+(e.contentType||"")+"\n\n"+r+(_.cloudfront?"/"+_.bucket:"")+e.path,encodeURIComponent(t)}function Y(){var e="/"+_.bucket+"/"+oe.name;return(_.cloudfront||b.indexOf("cloudfront")>-1)&&(e="/"+oe.name),e}function Z(e){return"undefined"==typeof e.part?e:e.part}function $(e){return!!Z(e).currentXhr}function ee(e){return Z(e).currentXhr=new XMLHttpRequest}function te(e){delete Z(e).currentXhr}var re,ne,oe=this,ae=[],se=[],ie=0,de=0,ue=0;l(oe,n),oe.start=function(){M.d("starting FileUpload "+oe.id),o(v);var e=oe.name;if(q(),"undefined"==typeof oe.uploadId)i(e);else if("undefined"!=typeof oe.eTag&&oe.firstMd5Digest){var r=new FileReader;r.onloadend=function(){var t=_.cryptoMd5Method.call(this,this.result);_.allowS3ExistenceOptimization&&oe.firstMd5Digest===t?z(e):(oe.firstMd5Digest=t,i(e))},r.readAsArrayBuffer(t(oe.file,0,_.partSize))}else C(0)},oe.stop=function(){M.d("stopping FileUpload ",oe.id),oe.cancelled(),o(S),oe.info("Canceling uploads..."),a()};var le=0,pe=-1}function l(e,t,r){if(e="undefined"==typeof e?{}:e,"object"==typeof r)for(var n in r)t[n]=r[n];for(var o in t)e[o]=t[o];return e}function p(e){var t=new DOMParser;return t.parseFromString(e,"text/xml")}function f(e){var t=JSON.parse(B.getItem("awsUploads")||"{}");if(e)for(var n in t)if(t.hasOwnProperty(n)){var o=t[n],a=new Date(o.completedAt||r);a<A&&delete t[n]}return t}function c(t){return[t.file.name,t.file.type,e(t.file.lastModifiedDate),t.file.size].join("-")}function g(e,t){var r=f();r[e]=t,B.setItem("awsUploads",JSON.stringify(r))}function m(e){var t=f();delete t[e],B.setItem("awsUploads",JSON.stringify(t))}function h(e,t){return e.getElementsByTagName(t)[0].childNodes[0].nodeValue}var y=0,v=2,w=3,S=5,T=10,I=20,b=n.aws_url||"https://s3.amazonaws.com",E='"d41d8cd98f00b204e9800998ecf8427e"',P=this,z=[],M=o(),_=l({logging:!0,maxConcurrentParts:5,partSize:6291456,retryBackoffPower:2,maxRetryBackoffSecs:300,progressIntervalMS:500,cloudfront:!1,encodeFilename:!0,computeContentMd5:!1,allowS3ExistenceOptimization:!1,timeUrl:null,cryptoMd5Method:null,s3FileCacheHoursAgo:null,testUnsupported:!1,simulateStalling:!1,simulateErrors:!1},n);if(console&&console.log&&(M=console,M.d=M.log,M.w=console.warn?M.warn:M.d,M.e=console.error?M.error:M.d),this.supported=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice)||n.testUnsupported),!this.supported)return void M.e("The browser does not support the necessary features of File and Blob [webkitSlice || mozSlice || slice]");if(_.computeContentMd5){if(this.supported="undefined"!=typeof FileReader.prototype.readAsArrayBuffer,!this.supported)return void M.e("The browser's FileReader object does not support readAsArrayBuffer");if("function"!=typeof _.cryptoMd5Method)return void M.e("Option computeContentMd5 has been set but cryptoMd5Method is not defined.")}_.logging||(M=o());var B={supported:function(){var e=!1;if("undefined"==typeof window)return e;if(!("localStorage"in window))return e;try{localStorage.setItem("___test","OK");var t=localStorage.getItem("___test");localStorage.removeItem("___test"),e="OK"===t}catch(t){return e}return e}(),getItem:function(e){if(this.supported)return localStorage.getItem(e)},setItem:function(e,t){if(this.supported)return localStorage.setItem(e,t)},clear:function(){if(this.supported)return localStorage.clear()},key:function(e){if(this.supported)return localStorage.key(e)},removeItem:function(e){if(this.supported)return localStorage.removeItem(e)}},x=new Date,A=new Date(x.setHours(x.getHours()-(_.s3FileCacheHoursAgo||-100)));P.add=function(e){M.d("add");var t;if("undefined"==typeof e)return"Missing file";if("undefined"==typeof e.name?t="Missing attribute: name  ":_.encodeFilename&&(e.name=encodeURIComponent(e.name)),t)return t;var r=a(e);return i(),r},P.cancel=function(e){return M.d("cancel ",e),!!z[e]&&(z[e].stop(),!0)},P.pause=function(e){},P.resume=function(e){},P.forceRetry=function(){}};"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof window&&(window.Evaporate=n)}();
//# sourceMappingURL=evaporate.min.js.map