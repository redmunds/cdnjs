var THREE=THREE||{};THREE.Color=function(t){this.autoUpdate=!0,this.setHex(t)},THREE.Color.prototype={setRGB:function(t,e,i){this.r=t,this.g=e,this.b=i,this.autoUpdate&&(this.updateHex(),this.updateStyleString())},setHex:function(t){this.hex=16777215&~~t,this.autoUpdate&&(this.updateRGBA(),this.updateStyleString())},updateHex:function(){this.hex=~~(255*this.r)<<16^~~(255*this.g)<<8^~~(255*this.b)},updateRGBA:function(){this.r=(this.hex>>16&255)/255,this.g=(this.hex>>8&255)/255,this.b=(255&this.hex)/255},updateStyleString:function(){this.__styleString="rgb("+~~(255*this.r)+","+~~(255*this.g)+","+~~(255*this.b)+")"},toString:function(){return"THREE.Color ( r: "+this.r+", g: "+this.g+", b: "+this.b+", hex: "+this.hex+" )"}},THREE.Vector2=function(t,e){this.x=t||0,this.y=e||0},THREE.Vector2.prototype={set:function(t,e){return this.x=t,this.y=e,this},copy:function(t){return this.x=t.x,this.y=t.y,this},addSelf:function(t){return this.x+=t.x,this.y+=t.y,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},subSelf:function(t){return this.x-=t.x,this.y-=t.y,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},unit:function(){return this.multiplyScalar(1/this.length()),this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},negate:function(){return this.x=-this.x,this.y=-this.y,this},clone:function(){return new THREE.Vector2(this.x,this.y)},toString:function(){return"THREE.Vector2 ("+this.x+", "+this.y+")"}},THREE.Vector3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},THREE.Vector3.prototype={set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addSelf:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},subSelf:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},cross:function(t,e){return this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this},crossSelf:function(t){var e=this.x,i=this.y,n=this.z;return this.x=i*t.z-n*t.y,this.y=n*t.x-e*t.z,this.z=e*t.y-i*t.x,this},multiplySelf:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},divideScalar:function(t){return this.x/=t,this.y/=t,this.z/=t,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},distanceTo:function(t){var e=this.x-t.x,i=this.y-t.y;return t=this.z-t.z,Math.sqrt(e*e+i*i+t*t)},distanceToSquared:function(t){var e=this.x-t.x,i=this.y-t.y;return t=this.z-t.z,e*e+i*i+t*t},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},normalize:function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return t>0?this.multiplyScalar(1/t):this.set(0,0,0),this},setLength:function(t){return this.normalize().multiplyScalar(t)},isZero:function(){return Math.abs(this.x)<1e-4&&Math.abs(this.y)<1e-4&&Math.abs(this.z)<1e-4},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)},toString:function(){return"THREE.Vector3 ( "+this.x+", "+this.y+", "+this.z+" )"}},THREE.Vector4=function(t,e,i,n){this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||1},THREE.Vector4.prototype={set:function(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w||1,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},addSelf:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},subSelf:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},divideScalar:function(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this},lerpSelf:function(t,e){this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)},toString:function(){return"THREE.Vector4 ("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}},THREE.Ray=function(t,e){this.origin=t||new THREE.Vector3,this.direction=e||new THREE.Vector3},THREE.Ray.prototype={intersectScene:function(t){var e,i,n=t.objects,r=[];for(t=0,e=n.length;t<e;t++)i=n[t],i instanceof THREE.Mesh&&(r=r.concat(this.intersectObject(i)));return r.sort(function(t,e){return t.distance-e.distance}),r},intersectObject:function(t){function e(t,e,i,n){n=n.clone().subSelf(e),i=i.clone().subSelf(e);var r=t.clone().subSelf(e);t=n.dot(n),e=n.dot(i),n=n.dot(r);var o=i.dot(i);return i=i.dot(r),r=1/(t*o-e*e),o=(o*n-e*i)*r,t=(t*i-e*n)*r,o>0&&t>0&&o+t<1}var i,n,r,o,a,s,h,c,l,u,f,E=t.geometry,m=E.vertices,p=[];for(i=0,n=E.faces.length;i<n;i++)r=E.faces[i],u=this.origin.clone(),f=this.direction.clone(),o=t.matrix.transformVector3(m[r.a].position.clone()),a=t.matrix.transformVector3(m[r.b].position.clone()),s=t.matrix.transformVector3(m[r.c].position.clone()),h=r instanceof THREE.Face4?t.matrix.transformVector3(m[r.d].position.clone()):null,c=t.rotationMatrix.transformVector3(r.normal.clone()),l=f.dot(c),l<0&&(c=c.dot((new THREE.Vector3).sub(o,u))/l,u=u.addSelf(f.multiplyScalar(c)),r instanceof THREE.Face3?e(u,o,a,s)&&(r={distance:this.origin.distanceTo(u),point:u,face:r,object:t},p.push(r)):r instanceof THREE.Face4&&(e(u,o,a,h)||e(u,a,s,h))&&(r={distance:this.origin.distanceTo(u),point:u,face:r,object:t},p.push(r)));return p}},THREE.Rectangle=function(){function t(){o=n-e,a=r-i}var e,i,n,r,o,a,s=!0;this.getX=function(){return e},this.getY=function(){return i},this.getWidth=function(){return o},this.getHeight=function(){return a},this.getLeft=function(){return e},this.getTop=function(){return i},this.getRight=function(){return n},this.getBottom=function(){return r},this.set=function(o,a,h,c){s=!1,e=o,i=a,n=h,r=c,t()},this.addPoint=function(o,a){s?(s=!1,e=o,i=a,n=o,r=a):(e=Math.min(e,o),i=Math.min(i,a),n=Math.max(n,o),r=Math.max(r,a)),t()},this.addRectangle=function(o){s?(s=!1,e=o.getLeft(),i=o.getTop(),n=o.getRight(),r=o.getBottom()):(e=Math.min(e,o.getLeft()),i=Math.min(i,o.getTop()),n=Math.max(n,o.getRight()),r=Math.max(r,o.getBottom())),t()},this.inflate=function(o){e-=o,i-=o,n+=o,r+=o,t()},this.minSelf=function(o){e=Math.max(e,o.getLeft()),i=Math.max(i,o.getTop()),n=Math.min(n,o.getRight()),r=Math.min(r,o.getBottom()),t()},this.instersects=function(t){return Math.min(n,t.getRight())-Math.max(e,t.getLeft())>=0&&Math.min(r,t.getBottom())-Math.max(i,t.getTop())>=0},this.empty=function(){s=!0,r=n=i=e=0,t()},this.isEmpty=function(){return s},this.toString=function(){return"THREE.Rectangle ( left: "+e+", right: "+n+", top: "+i+", bottom: "+r+", width: "+o+", height: "+a+" )"}},THREE.Matrix3=function(){this.m=[]},THREE.Matrix3.prototype={transpose:function(){var t;return t=this.m[1],this.m[1]=this.m[3],this.m[3]=t,t=this.m[2],this.m[2]=this.m[6],this.m[6]=t,t=this.m[5],this.m[5]=this.m[7],this.m[7]=t,this}},THREE.Matrix4=function(){},THREE.Matrix4.prototype={n11:1,n12:0,n13:0,n14:0,n21:0,n22:1,n23:0,n24:0,n31:0,n32:0,n33:1,n34:0,n41:0,n42:0,n43:0,n44:1,identity:function(){this.n11=1,this.n21=this.n14=this.n13=this.n12=0,this.n22=1,this.n32=this.n31=this.n24=this.n23=0,this.n33=1,this.n43=this.n42=this.n41=this.n34=0,this.n44=1},copy:function(t){this.n11=t.n11,this.n12=t.n12,this.n13=t.n13,this.n14=t.n14,this.n21=t.n21,this.n22=t.n22,this.n23=t.n23,this.n24=t.n24,this.n31=t.n31,this.n32=t.n32,this.n33=t.n33,this.n34=t.n34,this.n41=t.n41,this.n42=t.n42,this.n43=t.n43,this.n44=t.n44},lookAt:function(t,e,i){var n=new THREE.Vector3,r=new THREE.Vector3,o=new THREE.Vector3;o.sub(t,e).normalize(),n.cross(i,o).normalize(),r.cross(o,n).normalize(),this.n11=n.x,this.n12=n.y,this.n13=n.z,this.n14=-n.dot(t),this.n21=r.x,this.n22=r.y,this.n23=r.z,this.n24=-r.dot(t),this.n31=o.x,this.n32=o.y,this.n33=o.z,this.n34=-o.dot(t),this.n43=this.n42=this.n41=0,this.n44=1},transformVector3:function(t){var e=t.x,i=t.y,n=t.z;return t.x=this.n11*e+this.n12*i+this.n13*n+this.n14,t.y=this.n21*e+this.n22*i+this.n23*n+this.n24,t.z=this.n31*e+this.n32*i+this.n33*n+this.n34,t.multiplyScalar(1/(this.n41*e+this.n42*i+this.n43*n+this.n44)),t},transformVector4:function(t){var e=t.x,i=t.y,n=t.z,r=t.w;return t.x=this.n11*e+this.n12*i+this.n13*n+this.n14*r,t.y=this.n21*e+this.n22*i+this.n23*n+this.n24*r,t.z=this.n31*e+this.n32*i+this.n33*n+this.n34*r,t.w=this.n41*e+this.n42*i+this.n43*n+this.n44*r,t},crossVector:function(t){var e=new THREE.Vector4;return e.x=this.n11*t.x+this.n12*t.y+this.n13*t.z+this.n14*t.w,e.y=this.n21*t.x+this.n22*t.y+this.n23*t.z+this.n24*t.w,e.z=this.n31*t.x+this.n32*t.y+this.n33*t.z+this.n34*t.w,e.w=t.w?this.n41*t.x+this.n42*t.y+this.n43*t.z+this.n44*t.w:1,e},multiply:function(t,e){var i=t.n11,n=t.n12,r=t.n13,o=t.n14,a=t.n21,s=t.n22,h=t.n23,c=t.n24,l=t.n31,u=t.n32,f=t.n33,E=t.n34,m=t.n41,p=t.n42,d=t.n43,v=t.n44,g=e.n11,b=e.n12,_=e.n13,R=e.n14,y=e.n21,T=e.n22,x=e.n23,w=e.n24,H=e.n31,M=e.n32,S=e.n33,L=e.n34,C=e.n41,z=e.n42,P=e.n43,A=e.n44;this.n11=i*g+n*y+r*H+o*C,this.n12=i*b+n*T+r*M+o*z,this.n13=i*_+n*x+r*S+o*P,this.n14=i*R+n*w+r*L+o*A,this.n21=a*g+s*y+h*H+c*C,this.n22=a*b+s*T+h*M+c*z,this.n23=a*_+s*x+h*S+c*P,this.n24=a*R+s*w+h*L+c*A,this.n31=l*g+u*y+f*H+E*C,this.n32=l*b+u*T+f*M+E*z,this.n33=l*_+u*x+f*S+E*P,this.n34=l*R+u*w+f*L+E*A,this.n41=m*g+p*y+d*H+v*C,this.n42=m*b+p*T+d*M+v*z,this.n43=m*_+p*x+d*S+v*P,this.n44=m*R+p*w+d*L+v*A},multiplySelf:function(t){var e=this.n11,i=this.n12,n=this.n13,r=this.n14,o=this.n21,a=this.n22,s=this.n23,h=this.n24,c=this.n31,l=this.n32,u=this.n33,f=this.n34,E=this.n41,m=this.n42,p=this.n43,d=this.n44;this.n11=e*t.n11+i*t.n21+n*t.n31+r*t.n41,this.n12=e*t.n12+i*t.n22+n*t.n32+r*t.n42,this.n13=e*t.n13+i*t.n23+n*t.n33+r*t.n43,this.n14=e*t.n14+i*t.n24+n*t.n34+r*t.n44,this.n21=o*t.n11+a*t.n21+s*t.n31+h*t.n41,this.n22=o*t.n12+a*t.n22+s*t.n32+h*t.n42,this.n23=o*t.n13+a*t.n23+s*t.n33+h*t.n43,this.n24=o*t.n14+a*t.n24+s*t.n34+h*t.n44,this.n31=c*t.n11+l*t.n21+u*t.n31+f*t.n41,this.n32=c*t.n12+l*t.n22+u*t.n32+f*t.n42,this.n33=c*t.n13+l*t.n23+u*t.n33+f*t.n43,this.n34=c*t.n14+l*t.n24+u*t.n34+f*t.n44,this.n41=E*t.n11+m*t.n21+p*t.n31+d*t.n41,this.n42=E*t.n12+m*t.n22+p*t.n32+d*t.n42,this.n43=E*t.n13+m*t.n23+p*t.n33+d*t.n43,this.n44=E*t.n14+m*t.n24+p*t.n34+d*t.n44},multiplyScalar:function(t){this.n11*=t,this.n12*=t,this.n13*=t,this.n14*=t,this.n21*=t,this.n22*=t,this.n23*=t,this.n24*=t,this.n31*=t,this.n32*=t,this.n33*=t,this.n34*=t,this.n41*=t,this.n42*=t,this.n43*=t,this.n44*=t},determinant:function(){return this.n14*this.n23*this.n32*this.n41-this.n13*this.n24*this.n32*this.n41-this.n14*this.n22*this.n33*this.n41+this.n12*this.n24*this.n33*this.n41+this.n13*this.n22*this.n34*this.n41-this.n12*this.n23*this.n34*this.n41-this.n14*this.n23*this.n31*this.n42+this.n13*this.n24*this.n31*this.n42+this.n14*this.n21*this.n33*this.n42-this.n11*this.n24*this.n33*this.n42-this.n13*this.n21*this.n34*this.n42+this.n11*this.n23*this.n34*this.n42+this.n14*this.n22*this.n31*this.n43-this.n12*this.n24*this.n31*this.n43-this.n14*this.n21*this.n32*this.n43+this.n11*this.n24*this.n32*this.n43+this.n12*this.n21*this.n34*this.n43-this.n11*this.n22*this.n34*this.n43-this.n13*this.n22*this.n31*this.n44+this.n12*this.n23*this.n31*this.n44+this.n13*this.n21*this.n32*this.n44-this.n11*this.n23*this.n32*this.n44-this.n12*this.n21*this.n33*this.n44+this.n11*this.n22*this.n33*this.n44},transpose:function(){function t(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}return t(this,"n21","n12"),t(this,"n31","n13"),t(this,"n32","n23"),t(this,"n41","n14"),t(this,"n42","n24"),t(this,"n43","n34"),this},clone:function(){var t=new THREE.Matrix4;return t.n11=this.n11,t.n12=this.n12,t.n13=this.n13,t.n14=this.n14,t.n21=this.n21,t.n22=this.n22,t.n23=this.n23,t.n24=this.n24,t.n31=this.n31,t.n32=this.n32,t.n33=this.n33,t.n34=this.n34,t.n41=this.n41,t.n42=this.n42,t.n43=this.n43,t.n44=this.n44,t},flatten:function(){return[this.n11,this.n21,this.n31,this.n41,this.n12,this.n22,this.n32,this.n42,this.n13,this.n23,this.n33,this.n43,this.n14,this.n24,this.n34,this.n44]},toString:function(){return"| "+this.n11+" "+this.n12+" "+this.n13+" "+this.n14+" |\n| "+this.n21+" "+this.n22+" "+this.n23+" "+this.n24+" |\n| "+this.n31+" "+this.n32+" "+this.n33+" "+this.n34+" |\n| "+this.n41+" "+this.n42+" "+this.n43+" "+this.n44+" |"}},THREE.Matrix4.translationMatrix=function(t,e,i){var n=new THREE.Matrix4;return n.n14=t,n.n24=e,n.n34=i,n},THREE.Matrix4.scaleMatrix=function(t,e,i){var n=new THREE.Matrix4;return n.n11=t,n.n22=e,n.n33=i,n},THREE.Matrix4.rotationXMatrix=function(t){var e=new THREE.Matrix4;return e.n22=e.n33=Math.cos(t),e.n32=Math.sin(t),e.n23=-e.n32,e},THREE.Matrix4.rotationYMatrix=function(t){var e=new THREE.Matrix4;return e.n11=e.n33=Math.cos(t),e.n13=Math.sin(t),e.n31=-e.n13,e},THREE.Matrix4.rotationZMatrix=function(t){var e=new THREE.Matrix4;return e.n11=e.n22=Math.cos(t),e.n21=Math.sin(t),e.n12=-e.n21,e},THREE.Matrix4.rotationAxisAngleMatrix=function(t,e){var i=new THREE.Matrix4,n=Math.cos(e),r=Math.sin(e),o=1-n,a=t.x,s=t.y,h=t.z;return i.n11=o*a*a+n,i.n12=o*a*s-r*h,i.n13=o*a*h+r*s,i.n21=o*a*s+r*h,i.n22=o*s*s+n,i.n23=o*s*h-r*a,i.n31=o*a*h-r*s,i.n32=o*s*h+r*a,i.n33=o*h*h+n,i},THREE.Matrix4.makeInvert=function(t){var e=new THREE.Matrix4;return e.n11=t.n23*t.n34*t.n42-t.n24*t.n33*t.n42+t.n24*t.n32*t.n43-t.n22*t.n34*t.n43-t.n23*t.n32*t.n44+t.n22*t.n33*t.n44,e.n12=t.n14*t.n33*t.n42-t.n13*t.n34*t.n42-t.n14*t.n32*t.n43+t.n12*t.n34*t.n43+t.n13*t.n32*t.n44-t.n12*t.n33*t.n44,e.n13=t.n13*t.n24*t.n42-t.n14*t.n23*t.n42+t.n14*t.n22*t.n43-t.n12*t.n24*t.n43-t.n13*t.n22*t.n44+t.n12*t.n23*t.n44,e.n14=t.n14*t.n23*t.n32-t.n13*t.n24*t.n32-t.n14*t.n22*t.n33+t.n12*t.n24*t.n33+t.n13*t.n22*t.n34-t.n12*t.n23*t.n34,e.n21=t.n24*t.n33*t.n41-t.n23*t.n34*t.n41-t.n24*t.n31*t.n43+t.n21*t.n34*t.n43+t.n23*t.n31*t.n44-t.n21*t.n33*t.n44,e.n22=t.n13*t.n34*t.n41-t.n14*t.n33*t.n41+t.n14*t.n31*t.n43-t.n11*t.n34*t.n43-t.n13*t.n31*t.n44+t.n11*t.n33*t.n44,e.n23=t.n14*t.n23*t.n41-t.n13*t.n24*t.n41-t.n14*t.n21*t.n43+t.n11*t.n24*t.n43+t.n13*t.n21*t.n44-t.n11*t.n23*t.n44,e.n24=t.n13*t.n24*t.n31-t.n14*t.n23*t.n31+t.n14*t.n21*t.n33-t.n11*t.n24*t.n33-t.n13*t.n21*t.n34+t.n11*t.n23*t.n34,e.n31=t.n22*t.n34*t.n41-t.n24*t.n32*t.n41+t.n24*t.n31*t.n42-t.n21*t.n34*t.n42-t.n22*t.n31*t.n44+t.n21*t.n32*t.n44,e.n32=t.n14*t.n32*t.n41-t.n12*t.n34*t.n41-t.n14*t.n31*t.n42+t.n11*t.n34*t.n42+t.n12*t.n31*t.n44-t.n11*t.n32*t.n44,e.n33=t.n13*t.n24*t.n41-t.n14*t.n22*t.n41+t.n14*t.n21*t.n42-t.n11*t.n24*t.n42-t.n12*t.n21*t.n44+t.n11*t.n22*t.n44,e.n34=t.n14*t.n22*t.n31-t.n12*t.n24*t.n31-t.n14*t.n21*t.n32+t.n11*t.n24*t.n32+t.n12*t.n21*t.n34-t.n11*t.n22*t.n34,e.n41=t.n23*t.n32*t.n41-t.n22*t.n33*t.n41-t.n23*t.n31*t.n42+t.n21*t.n33*t.n42+t.n22*t.n31*t.n43-t.n21*t.n32*t.n43,e.n42=t.n12*t.n33*t.n41-t.n13*t.n32*t.n41+t.n13*t.n31*t.n42-t.n11*t.n33*t.n42-t.n12*t.n31*t.n43+t.n11*t.n32*t.n43,e.n43=t.n13*t.n22*t.n41-t.n12*t.n23*t.n41-t.n13*t.n21*t.n42+t.n11*t.n23*t.n42+t.n12*t.n21*t.n43-t.n11*t.n22*t.n43,e.n44=t.n12*t.n23*t.n31-t.n13*t.n22*t.n31+t.n13*t.n21*t.n32-t.n11*t.n23*t.n32-t.n12*t.n21*t.n33+t.n11*t.n22*t.n33,e.multiplyScalar(1/t.determinant()),e},THREE.Matrix4.makeInvert3x3=function(t){var e=t.flatten();t=new THREE.Matrix3;var i=e[10]*e[5]-e[6]*e[9],n=-e[10]*e[1]+e[2]*e[9],r=e[6]*e[1]-e[2]*e[5],o=-e[10]*e[4]+e[6]*e[8],a=e[10]*e[0]-e[2]*e[8],s=-e[6]*e[0]+e[2]*e[4],h=e[9]*e[4]-e[5]*e[8],c=-e[9]*e[0]+e[1]*e[8],l=e[5]*e[0]-e[1]*e[4];if(e=e[0]*i+e[1]*o+e[2]*h,0==e)throw"matrix not invertible";return e=1/e,t.m[0]=e*i,t.m[1]=e*n,t.m[2]=e*r,t.m[3]=e*o,t.m[4]=e*a,t.m[5]=e*s,t.m[6]=e*h,t.m[7]=e*c,t.m[8]=e*l,t},THREE.Matrix4.makeFrustum=function(t,e,i,n,r,o){var a,s,h;return a=new THREE.Matrix4,s=2*r/(e-t),h=2*r/(n-i),t=(e+t)/(e-t),i=(n+i)/(n-i),n=-(o+r)/(o-r),r=-2*o*r/(o-r),a.n11=s,a.n12=0,a.n13=t,a.n14=0,a.n21=0,a.n22=h,a.n23=i,a.n24=0,a.n31=0,a.n32=0,a.n33=n,a.n34=r,a.n41=0,a.n42=0,a.n43=-1,a.n44=0,a},THREE.Matrix4.makePerspective=function(t,e,i,n){var r;return t=i*Math.tan(t*Math.PI/360),r=-t,THREE.Matrix4.makeFrustum(r*e,t*e,r,t,i,n)},THREE.Matrix4.makeOrtho=function(t,e,i,n,r,o){var a,s,h,c;return a=new THREE.Matrix4,s=e-t,h=i-n,c=o-r,t=(e+t)/s,i=(i+n)/h,r=(o+r)/c,a.n11=2/s,a.n12=0,a.n13=0,a.n14=-t,a.n21=0,a.n22=2/h,a.n23=0,a.n24=-i,a.n31=0,a.n32=0,a.n33=-2/c,a.n34=-r,a.n41=0,a.n42=0,a.n43=0,a.n44=1,a},THREE.Vertex=function(t,e){this.position=t||new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.normal=e||new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.normalScreen=new THREE.Vector3,this.__visible=!0},THREE.Vertex.prototype={toString:function(){return"THREE.Vertex ( position: "+this.position+", normal: "+this.normal+" )"}},THREE.Face3=function(t,e,i,n,r){this.a=t,this.b=e,this.c=i,this.centroid=new THREE.Vector3,this.normal=n instanceof THREE.Vector3?n:new THREE.Vector3,this.vertexNormals=n instanceof Array?n:[],this.material=r instanceof Array?r:[r]},THREE.Face3.prototype={toString:function(){return"THREE.Face3 ( "+this.a+", "+this.b+", "+this.c+" )"}},THREE.Face4=function(t,e,i,n,r,o){this.a=t,this.b=e,this.c=i,this.d=n,this.centroid=new THREE.Vector3,this.normal=r instanceof THREE.Vector3?r:new THREE.Vector3,this.vertexNormals=r instanceof Array?r:[],this.material=o instanceof Array?o:[o]},THREE.Face4.prototype={toString:function(){return"THREE.Face4 ( "+this.a+", "+this.b+", "+this.c+" "+this.d+" )"}},THREE.UV=function(t,e){this.u=t||0,this.v=e||0},THREE.UV.prototype={copy:function(t){this.u=t.u,this.v=t.v},toString:function(){return"THREE.UV ("+this.u+", "+this.v+")"}},THREE.Geometry=function(){this.vertices=[],this.faces=[],this.uvs=[]},THREE.Geometry.prototype={computeCentroids:function(){var t,e,i;for(t=0,e=this.faces.length;t<e;t++)i=this.faces[t],i.centroid.set(0,0,0),i.centroid.addSelf(this.vertices[i.a].position),i.centroid.addSelf(this.vertices[i.b].position),i.centroid.addSelf(this.vertices[i.c].position),i instanceof THREE.Face3?i.centroid.divideScalar(3):i instanceof THREE.Face4&&(i.centroid.addSelf(this.vertices[i.d].position),i.centroid.divideScalar(4))},computeNormals:function(t){var e,i,n,r,o,a,s=new THREE.Vector3,h=new THREE.Vector3;for(n=0,r=this.vertices.length;n<r;n++)o=this.vertices[n],o.normal.set(0,0,0);for(n=0,r=this.faces.length;n<r;n++){if(o=this.faces[n],t&&o.vertexNormals.length){for(s.set(0,0,0),e=0,i=o.normal.length;e<i;e++)s.addSelf(o.vertexNormals[e]);s.divideScalar(3)}else e=this.vertices[o.a],i=this.vertices[o.b],a=this.vertices[o.c],s.sub(a.position,i.position),h.sub(e.position,i.position),s.crossSelf(h);s.isZero()||s.normalize(),o.normal.copy(s)}},computeBoundingBox:function(){if(this.vertices.length>0){this.bbox={x:[this.vertices[0].position.x,this.vertices[0].position.x],y:[this.vertices[0].position.y,this.vertices[0].position.y],z:[this.vertices[0].position.z,this.vertices[0].position.z]};for(var t=1,e=this.vertices.length;t<e;t++)vertex=this.vertices[t],vertex.position.x<this.bbox.x[0]?this.bbox.x[0]=vertex.position.x:vertex.position.x>this.bbox.x[1]&&(this.bbox.x[1]=vertex.position.x),vertex.position.y<this.bbox.y[0]?this.bbox.y[0]=vertex.position.y:vertex.position.y>this.bbox.y[1]&&(this.bbox.y[1]=vertex.position.y),vertex.position.z<this.bbox.z[0]?this.bbox.z[0]=vertex.position.z:vertex.position.z>this.bbox.z[1]&&(this.bbox.z[1]=vertex.position.z)}},toString:function(){return"THREE.Geometry ( vertices: "+this.vertices+", faces: "+this.faces+" )"}},THREE.Camera=function(t,e,i,n){this.position=new THREE.Vector3(0,0,0),this.target={position:new THREE.Vector3(0,0,0)},this.up=new THREE.Vector3(0,1,0),this.matrix=new THREE.Matrix4,this.projectionMatrix=THREE.Matrix4.makePerspective(t,e,i,n),this.autoUpdateMatrix=!0,this.updateMatrix=function(){this.matrix.lookAt(this.position,this.target.position,this.up)},this.toString=function(){return"THREE.Camera ( "+this.position+", "+this.target.position+" )"}},THREE.Light=function(t){this.color=new THREE.Color(t)},THREE.AmbientLight=function(t){THREE.Light.call(this,t)},THREE.AmbientLight.prototype=new THREE.Light,THREE.AmbientLight.prototype.constructor=THREE.AmbientLight,THREE.DirectionalLight=function(t,e){THREE.Light.call(this,t),this.position=new THREE.Vector3(0,1,0),this.intensity=e||1},THREE.DirectionalLight.prototype=new THREE.Light,THREE.DirectionalLight.prototype.constructor=THREE.DirectionalLight,THREE.PointLight=function(t,e){THREE.Light.call(this,t),this.position=new THREE.Vector3,this.intensity=e||1},THREE.DirectionalLight.prototype=new THREE.Light,THREE.DirectionalLight.prototype.constructor=THREE.PointLight,THREE.Object3D=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Vector3,this.scale=new THREE.Vector3(1,1,1),this.matrix=new THREE.Matrix4,this.translationMatrix=new THREE.Matrix4,this.rotationMatrix=new THREE.Matrix4,this.scaleMatrix=new THREE.Matrix4,this.screen=new THREE.Vector3,this.autoUpdateMatrix=this.visible=!0,this.updateMatrix=function(){this.matrixPosition=THREE.Matrix4.translationMatrix(this.position.x,this.position.y,this.position.z),this.rotationMatrix=THREE.Matrix4.rotationXMatrix(this.rotation.x),this.rotationMatrix.multiplySelf(THREE.Matrix4.rotationYMatrix(this.rotation.y)),this.rotationMatrix.multiplySelf(THREE.Matrix4.rotationZMatrix(this.rotation.z)),this.scaleMatrix=THREE.Matrix4.scaleMatrix(this.scale.x,this.scale.y,this.scale.z),this.matrix.copy(this.matrixPosition),this.matrix.multiplySelf(this.rotationMatrix),this.matrix.multiplySelf(this.scaleMatrix)}},THREE.Particle=function(t){THREE.Object3D.call(this),this.material=t instanceof Array?t:[t],this.autoUpdateMatrix=!1},THREE.Particle.prototype=new THREE.Object3D,THREE.Particle.prototype.constructor=THREE.Particle,THREE.Line=function(t,e){THREE.Object3D.call(this),this.geometry=t,this.material=e instanceof Array?e:[e]},THREE.Line.prototype=new THREE.Object3D,THREE.Line.prototype.constructor=THREE.Line,THREE.Mesh=function(t,e,i){THREE.Object3D.call(this),this.geometry=t,this.material=e instanceof Array?e:[e],this.overdraw=this.doubleSided=this.flipSided=!1,this.materialFaceGroup={},this.sortFacesByMaterial(),i&&this.normalizeUVs(),this.geometry.computeBoundingBox()},THREE.Mesh.prototype=new THREE.Object3D,THREE.Mesh.prototype.constructor=THREE.Mesh,THREE.Mesh.prototype.sortFacesByMaterial=function(){function t(t){var n=[];for(e=0,i=t.length;e<i;e++)void 0==t[e]?n.push("undefined"):n.push(t[e].toString());return n.join("_")}var e,i,n,r,o,a,s,h,c={};for(n=0,r=this.geometry.faces.length;n<r;n++)o=this.geometry.faces[n],a=o.material,s=t(a),void 0==c[s]&&(c[s]={hash:s,counter:0}),h=c[s].hash+"_"+c[s].counter,void 0==this.materialFaceGroup[h]&&(this.materialFaceGroup[h]={faces:[],material:a,vertices:0}),o=o instanceof THREE.Face3?3:4,this.materialFaceGroup[h].vertices+o>65535&&(c[s].counter+=1,h=c[s].hash+"_"+c[s].counter,void 0==this.materialFaceGroup[h]&&(this.materialFaceGroup[h]={faces:[],material:a,vertices:0})),this.materialFaceGroup[h].faces.push(n),this.materialFaceGroup[h].vertices+=o},THREE.Mesh.prototype.normalizeUVs=function(){var t,e,i,n,r;for(t=0,e=this.geometry.uvs.length;t<e;t++)for(r=this.geometry.uvs[t],i=0,n=r.length;i<n;i++)1!=r[i].u&&(r[i].u-=Math.floor(r[i].u)),1!=r[i].v&&(r[i].v-=Math.floor(r[i].v))},THREE.FlatShading=0,THREE.SmoothShading=1,THREE.NormalBlending=0,THREE.AdditiveBlending=1,THREE.SubtractiveBlending=2,THREE.LineBasicMaterial=function(t){this.color=new THREE.Color(16711680),this.opacity=1,this.blending=THREE.NormalBlending,this.linewidth=1,this.linejoin=this.linecap="round",t&&(void 0!==t.color&&this.color.setHex(t.color),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.blending&&(this.blending=t.blending),void 0!==t.linewidth&&(this.linewidth=t.linewidth),void 0!==t.linecap&&(this.linecap=t.linecap),void 0!==t.linejoin&&(this.linejoin=t.linejoin)),this.toString=function(){return"THREE.LineBasicMaterial (<br/>color: "+this.color+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>linewidth: "+this.linewidth+"<br/>linecap: "+this.linecap+"<br/>linejoin: "+this.linejoin+"<br/>)"}},THREE.MeshBasicMaterial=function(t){this.id=THREE.MeshBasicMaterialCounter.value++,this.color=new THREE.Color(15658734),this.env_map=this.map=null,this.combine=THREE.Multiply,this.reflectivity=1,this.refraction_ratio=.98,this.opacity=1,this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",t&&(void 0!==t.color&&this.color.setHex(t.color),void 0!==t.map&&(this.map=t.map),void 0!==t.env_map&&(this.env_map=t.env_map),void 0!==t.combine&&(this.combine=t.combine),void 0!==t.reflectivity&&(this.reflectivity=t.reflectivity),void 0!==t.refraction_ratio&&(this.refraction_ratio=t.refraction_ratio),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.shading&&(this.shading=t.shading),void 0!==t.blending&&(this.blending=t.blending),void 0!==t.wireframe&&(this.wireframe=t.wireframe),void 0!==t.wireframe_linewidth&&(this.wireframe_linewidth=t.wireframe_linewidth),void 0!==t.wireframe_linecap&&(this.wireframe_linecap=t.wireframe_linecap),void 0!==t.wireframe_linejoin&&(this.wireframe_linejoin=t.wireframe_linejoin)),this.toString=function(){return"THREE.MeshBasicMaterial (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>map: "+this.map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>reflectivity: "+this.reflectivity+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/>)"}},THREE.MeshBasicMaterialCounter={value:0},THREE.MeshLambertMaterial=function(t){this.id=THREE.MeshLambertMaterialCounter.value++,this.color=new THREE.Color(15658734),this.env_map=this.map=null,this.combine=THREE.Multiply,this.reflectivity=1,this.refraction_ratio=.98,this.opacity=1,this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",t&&(void 0!==t.color&&this.color.setHex(t.color),void 0!==t.map&&(this.map=t.map),void 0!==t.env_map&&(this.env_map=t.env_map),void 0!==t.combine&&(this.combine=t.combine),void 0!==t.reflectivity&&(this.reflectivity=t.reflectivity),void 0!==t.refraction_ratio&&(this.refraction_ratio=t.refraction_ratio),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.shading&&(this.shading=t.shading),void 0!==t.blending&&(this.blending=t.blending),void 0!==t.wireframe&&(this.wireframe=t.wireframe),void 0!==t.wireframe_linewidth&&(this.wireframe_linewidth=t.wireframe_linewidth),void 0!==t.wireframe_linecap&&(this.wireframe_linecap=t.wireframe_linecap),void 0!==t.wireframe_linejoin&&(this.wireframe_linejoin=t.wireframe_linejoin)),this.toString=function(){return"THREE.MeshLambertMaterial (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>map: "+this.map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>reflectivity: "+this.reflectivity+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>opacity: "+this.opacity+"<br/>shading: "+this.shading+"<br/>blending: "+this.blending+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/> )"}},THREE.MeshLambertMaterialCounter={value:0},THREE.MeshPhongMaterial=function(t){this.id=THREE.MeshPhongMaterialCounter.value++,this.color=new THREE.Color(15658734),this.ambient=new THREE.Color(328965),this.specular=new THREE.Color(1118481),this.shininess=30,this.env_map=this.specular_map=this.map=null,this.combine=THREE.Multiply,this.reflectivity=1,this.refraction_ratio=.98,this.opacity=1,this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",t&&(void 0!==t.color&&(this.color=new THREE.Color(t.color)),void 0!==t.ambient&&(this.ambient=new THREE.Color(t.ambient)),void 0!==t.specular&&(this.specular=new THREE.Color(t.specular)),void 0!==t.shininess&&(this.shininess=t.shininess),void 0!==t.map&&(this.map=t.map),void 0!==t.specular_map&&(this.specular_map=t.specular_map),void 0!==t.env_map&&(this.env_map=t.env_map),void 0!==t.combine&&(this.combine=t.combine),void 0!==t.reflectivity&&(this.reflectivity=t.reflectivity),void 0!==t.refraction_ratio&&(this.refraction_ratio=t.refraction_ratio),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.shading&&(this.shading=t.shading),void 0!==t.blending&&(this.blending=t.blending),void 0!==t.wireframe&&(this.wireframe=t.wireframe),void 0!==t.wireframe_linewidth&&(this.wireframe_linewidth=t.wireframe_linewidth),void 0!==t.wireframe_linecap&&(this.wireframe_linecap=t.wireframe_linecap),void 0!==t.wireframe_linejoin&&(this.wireframe_linejoin=t.wireframe_linejoin)),this.toString=function(){return"THREE.MeshPhongMaterial (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>ambient: "+this.ambient+"<br/>specular: "+this.specular+"<br/>shininess: "+this.shininess+"<br/>map: "+this.map+"<br/>specular_map: "+this.specular_map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>reflectivity: "+this.reflectivity+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>opacity: "+this.opacity+"<br/>shading: "+this.shading+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/>NaN"}},THREE.MeshPhongMaterialCounter={value:0},THREE.MeshDepthMaterial=function(t){this.near=1,this.far=1e3,this.opacity=1,this.blending=THREE.NormalBlending,t&&(void 0!==t.near&&(this.near=t.near),void 0!==t.far&&(this.far=t.far),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.blending&&(this.blending=t.blending)),this.__2near=2*this.near,this.__farPlusNear=this.far+this.near,this.__farMinusNear=this.far-this.near,this.toString=function(){return"THREE.MeshDepthMaterial"}},THREE.MeshNormalMaterial=function(t){this.opacity=1,this.shading=THREE.FlatShading,this.blending=THREE.NormalBlending,t&&(void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.shading&&(this.shading=t.shading),void 0!==t.blending&&(this.blending=t.blending)),this.toString=function(){return"THREE.MeshNormalMaterial"}},THREE.MeshFaceMaterial=function(){this.toString=function(){return"THREE.MeshFaceMaterial"}},THREE.MeshCubeMaterial=function(t){this.id=THREE.MeshCubeMaterial.value++,this.env_map=null,this.blending=THREE.NormalBlending,t&&void 0!==t.env_map&&(this.env_map=t.env_map),this.toString=function(){return"THREE.MeshCubeMaterial( id: "+this.id+"<br/>env_map: "+this.env_map+" )"}},THREE.MeshCubeMaterialCounter={value:0},THREE.MeshShaderMaterial=function(t){this.id=THREE.MeshShaderMaterialCounter.value++,this.vertex_shader=this.fragment_shader="void main() {}",this.uniforms={},this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",t&&(void 0!==t.fragment_shader&&(this.fragment_shader=t.fragment_shader),void 0!==t.vertex_shader&&(this.vertex_shader=t.vertex_shader),void 0!==t.uniforms&&(this.uniforms=t.uniforms),void 0!==t.shading&&(this.shading=t.shading),void 0!==t.blending&&(this.blending=t.blending),void 0!==t.wireframe&&(this.wireframe=t.wireframe),void 0!==t.wireframe_linewidth&&(this.wireframe_linewidth=t.wireframe_linewidth),
void 0!==t.wireframe_linecap&&(this.wireframe_linecap=t.wireframe_linecap),void 0!==t.wireframe_linejoin&&(this.wireframe_linejoin=t.wireframe_linejoin)),this.toString=function(){return"THREE.MeshShaderMaterial (<br/>id: "+this.id+"<br/>blending: "+this.blending+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/>)"}},THREE.MeshShaderMaterialCounter={value:0},THREE.ParticleBasicMaterial=function(t){this.color=new THREE.Color(16711680),this.map=null,this.opacity=1,this.blending=THREE.NormalBlending,this.offset=new THREE.Vector2,t&&(void 0!==t.color&&this.color.setHex(t.color),void 0!==t.map&&(this.map=t.map),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.blending&&(this.blending=t.blending)),this.toString=function(){return"THREE.ParticleBasicMaterial (<br/>color: "+this.color+"<br/>map: "+this.map+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>)"}},THREE.ParticleCircleMaterial=function(t){this.color=new THREE.Color(16711680),this.opacity=1,this.blending=THREE.NormalBlending,t&&(void 0!==t.color&&this.color.setHex(t.color),void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.blending&&(this.blending=t.blending)),this.toString=function(){return"THREE.ParticleCircleMaterial (<br/>color: "+this.color+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>)"}},THREE.ParticleDOMMaterial=function(t){this.domElement=t,this.toString=function(){return"THREE.ParticleDOMMaterial ( domElement: "+this.domElement+" )"}},THREE.Texture=function(t,e,i,n){this.image=t,this.loaded=!1,this.mapping=void 0!==e?e:THREE.UVMapping,this.wrap_s=void 0!==i?i:THREE.ClampToEdge,this.wrap_t=void 0!==n?n:THREE.ClampToEdge,this.toString=function(){return"THREE.Texture (<br/>image: "+this.image+"<br/>wrap_s: "+this.wrap_s+"<br/>wrap_t: "+this.wrap_t+"<br/>)"}},THREE.UVMapping=0,THREE.ReflectionMapping=1,THREE.RefractionMapping=2,THREE.Multiply=0,THREE.Mix=1,THREE.Repeat=0,THREE.ClampToEdge=1,THREE.MirroredRepeat=2,THREE.TextureCube=function(t,e){this.image=t,this.mapping=e?e:THREE.ReflectionMap,this.toString=function(){return"THREE.TextureCube (<br/>image: "+this.image+"<br/>mapping: "+this.mapping+"<br/>)"}},THREE.Scene=function(){this.objects=[],this.lights=[],this.addObject=function(t){this.objects.push(t)},this.removeObject=function(t){t=this.objects.indexOf(t),t!==-1&&this.objects.splice(t,1)},this.addLight=function(t){this.lights.push(t)},this.removeLight=function(t){t=this.lights.indexOf(t),t!==-1&&this.lights.splice(t,1)},this.toString=function(){return"THREE.Scene ( "+this.objects+" )"}},THREE.Projector=function(){function t(t,e){var i=0,n=1,r=t.z+t.w,o=e.z+e.w,a=-t.z+t.w,s=-e.z+e.w;return r>=0&&o>=0&&a>=0&&s>=0||!(r<0&&o<0||a<0&&s<0)&&(r<0?i=Math.max(i,r/(r-o)):o<0&&(n=Math.min(n,r/(r-o))),a<0?i=Math.max(i,a/(a-s)):s<0&&(n=Math.min(n,a/(a-s))),!(n<i)&&(t.lerpSelf(e,i),e.lerpSelf(t,1-n),!0))}var e,i,n,r,o,a,s,h,c=null,l=[],u=[],f=[],E=new THREE.Vector4,m=new THREE.Matrix4,p=new THREE.Matrix4,d=new THREE.Vector4,v=new THREE.Vector4;this.projectScene=function(g,b){var _,R,y,T,x,w,H,M,S,L,C,z,P,A,V,B,F;for(c=[],n=o=s=0,b.autoUpdateMatrix&&b.updateMatrix(),m.multiply(b.projectionMatrix,b.matrix),H=g.objects,_=0,R=H.length;_<R;_++)if(M=H[_],M.autoUpdateMatrix&&M.updateMatrix(),S=M.matrix,L=M.rotationMatrix,C=M.material,z=M.overdraw,M instanceof THREE.Mesh){for(P=M.geometry.vertices,y=0,T=P.length;y<T;y++)A=P[y],A.positionWorld.copy(A.position),S.transformVector3(A.positionWorld),V=A.positionScreen,V.copy(A.positionWorld),m.transformVector4(V),V.multiplyScalar(1/V.w),A.__visible=V.z>0&&V.z<1;for(A=M.geometry.faces,y=0,T=A.length;y<T;y++)if(V=A[y],V instanceof THREE.Face3){if(x=P[V.a],w=P[V.b],B=P[V.c],x.__visible&&w.__visible&&B.__visible&&(M.doubleSided||M.flipSided!=(B.positionScreen.x-x.positionScreen.x)*(w.positionScreen.y-x.positionScreen.y)-(B.positionScreen.y-x.positionScreen.y)*(w.positionScreen.x-x.positionScreen.x)<0)){for(e=l[n]=l[n]||new THREE.RenderableFace3,e.v1.positionWorld.copy(x.positionWorld),e.v2.positionWorld.copy(w.positionWorld),e.v3.positionWorld.copy(B.positionWorld),e.v1.positionScreen.copy(x.positionScreen),e.v2.positionScreen.copy(w.positionScreen),e.v3.positionScreen.copy(B.positionScreen),e.normalWorld.copy(V.normal),L.transformVector3(e.normalWorld),e.centroidWorld.copy(V.centroid),S.transformVector3(e.centroidWorld),e.centroidScreen.copy(e.centroidWorld),m.transformVector3(e.centroidScreen),B=V.vertexNormals,h=e.vertexNormalsWorld,x=0,w=B.length;x<w;x++)F=h[x]=h[x]||new THREE.Vector3,F.copy(B[x]),L.transformVector3(F);e.z=e.centroidScreen.z,e.meshMaterial=C,e.faceMaterial=V.material,e.overdraw=z,M.geometry.uvs[y]&&(e.uvs[0]=M.geometry.uvs[y][0],e.uvs[1]=M.geometry.uvs[y][1],e.uvs[2]=M.geometry.uvs[y][2]),c.push(e),n++}}else V instanceof THREE.Face4&&(x=P[V.a],w=P[V.b],B=P[V.c],F=P[V.d],x.__visible&&w.__visible&&B.__visible&&F.__visible&&(M.doubleSided||M.flipSided!=((F.positionScreen.x-x.positionScreen.x)*(w.positionScreen.y-x.positionScreen.y)-(F.positionScreen.y-x.positionScreen.y)*(w.positionScreen.x-x.positionScreen.x)<0||(w.positionScreen.x-B.positionScreen.x)*(F.positionScreen.y-B.positionScreen.y)-(w.positionScreen.y-B.positionScreen.y)*(F.positionScreen.x-B.positionScreen.x)<0))&&(e=l[n]=l[n]||new THREE.RenderableFace3,e.v1.positionWorld.copy(x.positionWorld),e.v2.positionWorld.copy(w.positionWorld),e.v3.positionWorld.copy(F.positionWorld),e.v1.positionScreen.copy(x.positionScreen),e.v2.positionScreen.copy(w.positionScreen),e.v3.positionScreen.copy(F.positionScreen),e.normalWorld.copy(V.normal),L.transformVector3(e.normalWorld),e.centroidWorld.copy(V.centroid),S.transformVector3(e.centroidWorld),e.centroidScreen.copy(e.centroidWorld),m.transformVector3(e.centroidScreen),e.z=e.centroidScreen.z,e.meshMaterial=C,e.faceMaterial=V.material,e.overdraw=z,M.geometry.uvs[y]&&(e.uvs[0]=M.geometry.uvs[y][0],e.uvs[1]=M.geometry.uvs[y][1],e.uvs[2]=M.geometry.uvs[y][3]),c.push(e),n++,i=l[n]=l[n]||new THREE.RenderableFace3,i.v1.positionWorld.copy(w.positionWorld),i.v2.positionWorld.copy(B.positionWorld),i.v3.positionWorld.copy(F.positionWorld),i.v1.positionScreen.copy(w.positionScreen),i.v2.positionScreen.copy(B.positionScreen),i.v3.positionScreen.copy(F.positionScreen),i.normalWorld.copy(e.normalWorld),i.centroidWorld.copy(e.centroidWorld),i.centroidScreen.copy(e.centroidScreen),i.z=i.centroidScreen.z,i.meshMaterial=C,i.faceMaterial=V.material,i.overdraw=z,M.geometry.uvs[y]&&(i.uvs[0]=M.geometry.uvs[y][1],i.uvs[1]=M.geometry.uvs[y][2],i.uvs[2]=M.geometry.uvs[y][3]),c.push(i),n++))}else if(M instanceof THREE.Line)for(p.multiply(m,S),P=M.geometry.vertices,A=P[0],A.positionScreen.copy(A.position),p.transformVector4(A.positionScreen),y=1,T=P.length;y<T;y++)x=P[y],x.positionScreen.copy(x.position),p.transformVector4(x.positionScreen),w=P[y-1],d.copy(x.positionScreen),v.copy(w.positionScreen),t(d,v)&&(d.multiplyScalar(1/d.w),v.multiplyScalar(1/v.w),r=u[o]=u[o]||new THREE.RenderableLine,r.v1.positionScreen.copy(d),r.v2.positionScreen.copy(v),r.z=Math.max(d.z,v.z),r.material=M.material,c.push(r),o++);else M instanceof THREE.Particle&&(E.set(M.position.x,M.position.y,M.position.z,1),m.transformVector4(E),E.z/=E.w,E.z>0&&E.z<1&&(a=f[s]=f[s]||new THREE.RenderableParticle,a.x=E.x/E.w,a.y=E.y/E.w,a.z=E.z,a.rotation=M.rotation.z,a.scale.x=M.scale.x*Math.abs(a.x-(E.x+b.projectionMatrix.n11)/(E.w+b.projectionMatrix.n14)),a.scale.y=M.scale.y*Math.abs(a.y-(E.y+b.projectionMatrix.n22)/(E.w+b.projectionMatrix.n24)),a.material=M.material,c.push(a),s++));return c.sort(function(t,e){return e.z-t.z}),c},this.unprojectVector=function(t,e){var i=new THREE.Matrix4;return i.multiply(THREE.Matrix4.makeInvert(e.matrix),THREE.Matrix4.makeInvert(e.projectionMatrix)),i.transformVector3(t),t}},THREE.DOMRenderer=function(){THREE.Renderer.call(this);var t,e,i,n,r=null,o=new THREE.Projector;this.domElement=document.createElement("div"),this.setSize=function(r,o){t=r,e=o,i=t/2,n=e/2},this.render=function(t,e){var a,s,h,c,l,u,f,E;for(r=o.projectScene(t,e),a=0,s=r.length;a<s;a++)if(l=r[a],l instanceof THREE.RenderableParticle)for(f=l.x*i+i,E=l.y*n+n,h=0,c=l.material.length;h<c;h++)u=l.material[h],u instanceof THREE.ParticleDOMMaterial&&(u=u.domElement,u.style.left=f+"px",u.style.top=E+"px")}},THREE.CanvasRenderer=function(){function t(t,e,i,n){var r,o,a,s,h=t.lights;for(t=0,r=h.length;t<r;t++)o=h[t],a=o.color,s=o.intensity,o instanceof THREE.DirectionalLight?(o=i.dot(o.position)*s,o>0&&(n.r+=a.r*o,n.g+=a.g*o,n.b+=a.b*o)):o instanceof THREE.PointLight&&(rt.sub(o.position,e),rt.normalize(),o=i.dot(rt)*s,o>0&&(n.r+=a.r*o,n.g+=a.g*o,n.b+=a.b*o))}function e(e,c,l,u,f,E){if(0!=f.opacity){o(f.opacity),a(f.blending),v=e.positionScreen.x,g=e.positionScreen.y,b=c.positionScreen.x,_=c.positionScreen.y,R=l.positionScreen.x,y=l.positionScreen.y;var m=v,p=g,d=b,M=_,S=R,L=y;F.beginPath(),F.moveTo(m,p),F.lineTo(d,M),F.lineTo(S,L),F.lineTo(m,p),F.closePath(),f instanceof THREE.MeshBasicMaterial?f.map?r(v,g,b,_,R,y,f.map.image,u.uvs[0].u,u.uvs[0].v,u.uvs[1].u,u.uvs[1].v,u.uvs[2].u,u.uvs[2].v):f.wireframe?i(f.color.__styleString,f.wireframe_linewidth):n(f.color.__styleString):f instanceof THREE.MeshLambertMaterial?(f.map&&!f.wireframe&&(r(v,g,b,_,R,y,f.map.image,u.uvs[0].u,u.uvs[0].v,u.uvs[1].u,u.uvs[1].v,u.uvs[2].u,u.uvs[2].v),a(THREE.SubtractiveBlending)),J?f.wireframe||f.shading!=THREE.SmoothShading||3!=u.vertexNormalsWorld.length?($.r=tt.r,$.g=tt.g,$.b=tt.b,t(E,u.centroidWorld,u.normalWorld,$),O.r=f.color.r*$.r,O.g=f.color.g*$.g,O.b=f.color.b*$.b,O.updateStyleString(),f.wireframe?i(O.__styleString,f.wireframe_linewidth):n(O.__styleString)):(X.r=k.r=q.r=tt.r,X.g=k.g=q.g=tt.g,X.b=k.b=q.b=tt.b,t(E,u.v1.positionWorld,u.vertexNormalsWorld[0],X),t(E,u.v2.positionWorld,u.vertexNormalsWorld[1],k),t(E,u.v3.positionWorld,u.vertexNormalsWorld[2],q),Y.r=.5*(k.r+q.r),Y.g=.5*(k.g+q.g),Y.b=.5*(k.b+q.b),H=s(X,k,q,Y),r(v,g,b,_,R,y,H,0,0,1,0,0,1)):f.wireframe?i(f.color.__styleString,f.wireframe_linewidth):n(f.color.__styleString)):f instanceof THREE.MeshDepthMaterial?(T=f.__2near,x=f.__farPlusNear,w=f.__farMinusNear,X.r=X.g=X.b=1-T/(x-e.positionScreen.z*w),k.r=k.g=k.b=1-T/(x-c.positionScreen.z*w),q.r=q.g=q.b=1-T/(x-l.positionScreen.z*w),Y.r=.5*(k.r+q.r),Y.g=.5*(k.g+q.g),Y.b=.5*(k.b+q.b),H=s(X,k,q,Y),r(v,g,b,_,R,y,H,0,0,1,0,0,1)):f instanceof THREE.MeshNormalMaterial&&(O.r=h(u.normalWorld.x),O.g=h(u.normalWorld.y),O.b=h(u.normalWorld.z),O.updateStyleString(),f.wireframe?i(O.__styleString,f.wireframe_linewidth):n(O.__styleString))}}function i(t,e){j!=t&&(F.strokeStyle=j=t),D!=e&&(F.lineWidth=D=e),F.stroke(),Q.inflate(2*e)}function n(t){G!=t&&(F.fillStyle=G=t),F.fill()}function r(t,e,i,n,r,o,a,s,h,c,l,u,f){var E,m;E=a.width-1,m=a.height-1,s*=E,h*=m,c*=E,l*=m,u*=E,f*=m,i-=t,n-=e,r-=t,o-=e,c-=s,l-=h,u-=s,f-=h,m=1/(c*f-u*l),E=(f*i-l*r)*m,l=(f*n-l*o)*m,i=(c*r-u*i)*m,n=(c*o-u*n)*m,t=t-E*s-i*h,e=e-l*s-n*h,F.save(),F.transform(E,l,i,n,t,e),F.clip(),F.drawImage(a,0,0),F.restore()}function o(t){N!=t&&(F.globalAlpha=N=t)}function a(t){if(U!=t){switch(t){case THREE.NormalBlending:F.globalCompositeOperation="source-over";break;case THREE.AdditiveBlending:F.globalCompositeOperation="lighter";break;case THREE.SubtractiveBlending:F.globalCompositeOperation="darker"}U=t}}function s(t,e,i,n){return C[0]=I(0,W(255,~~(255*t.r))),C[1]=I(0,W(255,~~(255*t.g))),C[2]=I(0,W(255,~~(255*t.b))),C[4]=I(0,W(255,~~(255*e.r))),C[5]=I(0,W(255,~~(255*e.g))),C[6]=I(0,W(255,~~(255*e.b))),C[8]=I(0,W(255,~~(255*i.r))),C[9]=I(0,W(255,~~(255*i.g))),C[10]=I(0,W(255,~~(255*i.b))),C[12]=I(0,W(255,~~(255*n.r))),C[13]=I(0,W(255,~~(255*n.g))),C[14]=I(0,W(255,~~(255*n.b))),S.putImageData(L,0,0),P.drawImage(M,0,0),z}function h(t){return t<0?W(.5*(1+t),.5):.5+W(.5*t,.5)}function c(t,e){var i=e.x-t.x,n=e.y-t.y,r=1/Math.sqrt(i*i+n*n);i*=r,n*=r,e.x+=i,e.y+=n,t.x-=i,t.y-=n}var l,u,f,E,m,p,d,v,g,b,_,R,y,T,x,w,H,M,S,L,C,z,P,A=null,V=new THREE.Projector,B=document.createElement("canvas"),F=B.getContext("2d"),N=1,U=0,j=null,G=null,D=1,W=Math.min,I=Math.max,O=new THREE.Color,X=new THREE.Color,k=new THREE.Color,q=new THREE.Color,Y=new THREE.Color,K=new THREE.Rectangle,Z=new THREE.Rectangle,Q=new THREE.Rectangle,J=!1,$=new THREE.Color,tt=new THREE.Color,et=new THREE.Color,it=new THREE.Color,nt=2*Math.PI,rt=new THREE.Vector3,ot=16;M=document.createElement("canvas"),M.width=M.height=2,S=M.getContext("2d"),S.fillStyle="rgba(0,0,0,1)",S.fillRect(0,0,2,2),L=S.getImageData(0,0,2,2),C=L.data,z=document.createElement("canvas"),z.width=z.height=ot,P=z.getContext("2d"),P.translate(-ot/2,-ot/2),P.scale(ot,ot),ot--,this.domElement=B,this.autoClear=!0,this.setSize=function(t,e){l=t,u=e,f=l/2,E=u/2,B.width=l,B.height=u,K.set(-f,-E,f,E)},this.clear=function(){Z.isEmpty()||(Z.inflate(1),Z.minSelf(K),F.clearRect(Z.getX(),Z.getY(),Z.getWidth(),Z.getHeight()),Z.empty())},this.render=function(t,i){var n,r,s,h,l,u,v,g;if(F.setTransform(1,0,0,-1,f,E),this.autoClear&&this.clear(),A=V.projectScene(t,i),J=t.lights.length>0)for(l=t.lights,tt.setRGB(0,0,0),et.setRGB(0,0,0),it.setRGB(0,0,0),n=0,r=l.length;n<r;n++)s=l[n],h=s.color,s instanceof THREE.AmbientLight?(tt.r+=h.r,tt.g+=h.g,tt.b+=h.b):s instanceof THREE.DirectionalLight?(et.r+=h.r,et.g+=h.g,et.b+=h.b):s instanceof THREE.PointLight&&(it.r+=h.r,it.g+=h.g,it.b+=h.b);for(n=0,r=A.length;n<r;n++){if(s=A[n],Q.empty(),s instanceof THREE.RenderableParticle)for(m=s,m.x*=f,m.y*=E,h=0,l=s.material.length;h<l;h++){u=m,v=s;var b=s.material[h];if(0!=b.opacity){o(b.opacity),a(b.blending),g=void 0;var _=void 0,R=void 0,y=void 0,T=void 0,x=void 0,w=void 0;b instanceof THREE.ParticleBasicMaterial?b.map&&(T=b.map,x=T.width>>1,w=T.height>>1,R=v.scale.x*f,y=v.scale.y*E,g=R*x,_=y*w,Q.set(u.x-g,u.y-_,u.x+g,u.y+_),K.instersects(Q)&&(F.save(),F.translate(u.x,u.y),F.rotate(-v.rotation),F.scale(R,-y),F.translate(-x,-w),F.drawImage(T,0,0),F.restore())):b instanceof THREE.ParticleCircleMaterial&&(J?($.r=tt.r+et.r+it.r,$.g=tt.g+et.g+it.g,$.b=tt.b+et.b+it.b,O.r=b.color.r*$.r,O.g=b.color.g*$.g,O.b=b.color.b*$.b,O.updateStyleString()):O.__styleString=b.color.__styleString,g=v.scale.x*f,_=v.scale.y*E,Q.set(u.x-g,u.y-_,u.x+g,u.y+_),K.instersects(Q)&&(b=O.__styleString,G!=b&&(F.fillStyle=G=b),F.save(),F.translate(u.x,u.y),F.rotate(-v.rotation),F.scale(g,_),F.beginPath(),F.arc(0,0,1,0,nt,!0),F.closePath(),F.fill(),F.restore()))}}else if(s instanceof THREE.RenderableLine){if(m=s.v1,p=s.v2,m.positionScreen.x*=f,m.positionScreen.y*=E,p.positionScreen.x*=f,p.positionScreen.y*=E,Q.addPoint(m.positionScreen.x,m.positionScreen.y),Q.addPoint(p.positionScreen.x,p.positionScreen.y),K.instersects(Q))for(h=0,l=s.material.length;h<l;)v=m,g=p,u=s.material[h++],0!=u.opacity&&(o(u.opacity),a(u.blending),F.beginPath(),F.moveTo(v.positionScreen.x,v.positionScreen.y),F.lineTo(g.positionScreen.x,g.positionScreen.y),F.closePath(),u instanceof THREE.LineBasicMaterial&&(O.__styleString=u.color.__styleString,v=u.linewidth,D!=v&&(F.lineWidth=D=v),v=O.__styleString,j!=v&&(F.strokeStyle=j=v),F.stroke(),Q.inflate(2*u.linewidth)))}else if(s instanceof THREE.RenderableFace3&&(m=s.v1,p=s.v2,d=s.v3,m.positionScreen.x*=f,m.positionScreen.y*=E,p.positionScreen.x*=f,p.positionScreen.y*=E,d.positionScreen.x*=f,d.positionScreen.y*=E,s.overdraw&&(c(m.positionScreen,p.positionScreen),c(p.positionScreen,d.positionScreen),c(d.positionScreen,m.positionScreen)),Q.addPoint(m.positionScreen.x,m.positionScreen.y),Q.addPoint(p.positionScreen.x,p.positionScreen.y),Q.addPoint(d.positionScreen.x,d.positionScreen.y),K.instersects(Q)))for(h=0,l=s.meshMaterial.length;h<l;)if(g=s.meshMaterial[h++],g instanceof THREE.MeshFaceMaterial)for(u=0,v=s.faceMaterial.length;u<v;)(g=s.faceMaterial[u++])&&e(m,p,d,s,g,t);else e(m,p,d,s,g,t);Z.addRectangle(Q)}F.setTransform(1,0,0,1,0,0)}},THREE.SVGRenderer=function(){function t(t,e,i){var n,r,o,a;for(n=0,r=t.lights.length;n<r;n++)o=t.lights[n],o instanceof THREE.DirectionalLight?(a=e.normalWorld.dot(o.position)*o.intensity,a>0&&(i.r+=o.color.r*a,i.g+=o.color.g*a,i.b+=o.color.b*a)):o instanceof THREE.PointLight&&(L.sub(o.position,e.centroidWorld),L.normalize(),a=e.normalWorld.dot(L)*o.intensity,a>0&&(i.r+=o.color.r*a,i.g+=o.color.g*a,i.b+=o.color.b*a))}function e(e,i,o,a,s,h){m=n(p++),m.setAttribute("d","M "+e.positionScreen.x+" "+e.positionScreen.y+" L "+i.positionScreen.x+" "+i.positionScreen.y+" L "+o.positionScreen.x+","+o.positionScreen.y+"z"),s instanceof THREE.MeshBasicMaterial?x.__styleString=s.color.__styleString:s instanceof THREE.MeshLambertMaterial?T?(w.r=H.r,w.g=H.g,w.b=H.b,t(h,a,w),x.r=s.color.r*w.r,x.g=s.color.g*w.g,x.b=s.color.b*w.b,x.updateStyleString()):x.__styleString=s.color.__styleString:s instanceof THREE.MeshDepthMaterial?(E=1-s.__2near/(s.__farPlusNear-a.z*s.__farMinusNear),x.setRGB(E,E,E)):s instanceof THREE.MeshNormalMaterial&&x.setRGB(r(a.normalWorld.x),r(a.normalWorld.y),r(a.normalWorld.z)),s.wireframe?m.setAttribute("style","fill: none; stroke: "+x.__styleString+"; stroke-width: "+s.wireframe_linewidth+"; stroke-opacity: "+s.opacity+"; stroke-linecap: "+s.wireframe_linecap+"; stroke-linejoin: "+s.wireframe_linejoin):m.setAttribute("style","fill: "+x.__styleString+"; fill-opacity: "+s.opacity),_.appendChild(m)}function i(e,i,o,a,s,h,c){m=n(p++),m.setAttribute("d","M "+e.positionScreen.x+" "+e.positionScreen.y+" L "+i.positionScreen.x+" "+i.positionScreen.y+" L "+o.positionScreen.x+","+o.positionScreen.y+" L "+a.positionScreen.x+","+a.positionScreen.y+"z"),h instanceof THREE.MeshBasicMaterial?x.__styleString=h.color.__styleString:h instanceof THREE.MeshLambertMaterial?T?(w.r=H.r,w.g=H.g,w.b=H.b,t(c,s,w),x.r=h.color.r*w.r,x.g=h.color.g*w.g,x.b=h.color.b*w.b,x.updateStyleString()):x.__styleString=h.color.__styleString:h instanceof THREE.MeshDepthMaterial?(E=1-h.__2near/(h.__farPlusNear-s.z*h.__farMinusNear),x.setRGB(E,E,E)):h instanceof THREE.MeshNormalMaterial&&x.setRGB(r(s.normalWorld.x),r(s.normalWorld.y),r(s.normalWorld.z)),h.wireframe?m.setAttribute("style","fill: none; stroke: "+x.__styleString+"; stroke-width: "+h.wireframe_linewidth+"; stroke-opacity: "+h.opacity+"; stroke-linecap: "+h.wireframe_linecap+"; stroke-linejoin: "+h.wireframe_linejoin):m.setAttribute("style","fill: "+x.__styleString+"; fill-opacity: "+h.opacity),_.appendChild(m)}function n(t){return null==C[t]?(C[t]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==A&&C[t].setAttribute("shape-rendering","crispEdges"),C[t]):C[t]}function r(t){return t<0?Math.min(.5*(1+t),.5):.5+Math.min(.5*t,.5)}var o,a,s,h,c,l,u,f,E,m,p,d,v,g=null,b=new THREE.Projector,_=document.createElementNS("http://www.w3.org/2000/svg","svg"),R=new THREE.Rectangle,y=new THREE.Rectangle,T=!1,x=new THREE.Color(16777215),w=new THREE.Color(16777215),H=new THREE.Color(0),M=new THREE.Color(0),S=new THREE.Color(0),L=new THREE.Vector3,C=[],z=[],P=[],A=1;this.domElement=_,this.autoClear=!0,this.setQuality=function(t){switch(t){case"high":A=1;break;case"low":A=0}},this.setSize=function(t,e){o=t,a=e,s=o/2,h=a/2,_.setAttribute("viewBox",-s+" "+-h+" "+o+" "+a),_.setAttribute("width",o),_.setAttribute("height",a),R.set(-s,-h,s,h)},this.clear=function(){for(;_.childNodes.length>0;)_.removeChild(_.childNodes[0])},this.render=function(t,n){var r,o,a,E,L,C,V,B;if(this.autoClear&&this.clear(),g=b.projectScene(t,n),v=d=p=0,T=t.lights.length>0)for(V=t.lights,H.setRGB(0,0,0),M.setRGB(0,0,0),S.setRGB(0,0,0),r=0,o=V.length;r<o;r++)a=V[r],E=a.color,a instanceof THREE.AmbientLight?(H.r+=E.r,H.g+=E.g,H.b+=E.b):a instanceof THREE.DirectionalLight?(M.r+=E.r,M.g+=E.g,M.b+=E.b):a instanceof THREE.PointLight&&(S.r+=E.r,S.g+=E.g,S.b+=E.b);for(r=0,o=g.length;r<o;r++)if(V=g[r],y.empty(),V instanceof THREE.RenderableParticle){for(c=V,c.x*=s,c.y*=-h,a=0,E=V.material.length;a<E;a++)if(B=V.material[a]){L=c,C=V,B=B;var F=d++;null==z[F]&&(z[F]=document.createElementNS("http://www.w3.org/2000/svg","circle"),0==A&&z[F].setAttribute("shape-rendering","crispEdges")),m=z[F],m.setAttribute("cx",L.x),m.setAttribute("cy",L.y),m.setAttribute("r",C.scale.x*s),B instanceof THREE.ParticleCircleMaterial&&(T?(w.r=H.r+M.r+S.r,w.g=H.g+M.g+S.g,w.b=H.b+M.b+S.b,x.r=B.color.r*w.r,x.g=B.color.g*w.g,x.b=B.color.b*w.b,x.updateStyleString()):x=B.color,m.setAttribute("style","fill: "+x.__styleString)),_.appendChild(m)}}else if(V instanceof THREE.RenderableLine){if(c=V.v1,l=V.v2,c.positionScreen.x*=s,c.positionScreen.y*=-h,l.positionScreen.x*=s,l.positionScreen.y*=-h,y.addPoint(c.positionScreen.x,c.positionScreen.y),y.addPoint(l.positionScreen.x,l.positionScreen.y),R.instersects(y))for(a=0,E=V.material.length;a<E;)(B=V.material[a++])&&(L=c,C=l,B=B,F=v++,null==P[F]&&(P[F]=document.createElementNS("http://www.w3.org/2000/svg","line"),0==A&&P[F].setAttribute("shape-rendering","crispEdges")),m=P[F],m.setAttribute("x1",L.positionScreen.x),m.setAttribute("y1",L.positionScreen.y),m.setAttribute("x2",C.positionScreen.x),m.setAttribute("y2",C.positionScreen.y),B instanceof THREE.LineBasicMaterial&&(x.__styleString=B.color.__styleString,m.setAttribute("style","fill: none; stroke: "+x.__styleString+"; stroke-width: "+B.linewidth+"; stroke-opacity: "+B.opacity+"; stroke-linecap: "+B.linecap+"; stroke-linejoin: "+B.linejoin),_.appendChild(m)))}else if(V instanceof THREE.RenderableFace3){if(c=V.v1,l=V.v2,u=V.v3,c.positionScreen.x*=s,c.positionScreen.y*=-h,l.positionScreen.x*=s,l.positionScreen.y*=-h,u.positionScreen.x*=s,u.positionScreen.y*=-h,y.addPoint(c.positionScreen.x,c.positionScreen.y),y.addPoint(l.positionScreen.x,l.positionScreen.y),y.addPoint(u.positionScreen.x,u.positionScreen.y),R.instersects(y))for(a=0,E=V.meshMaterial.length;a<E;)if(B=V.meshMaterial[a++],B instanceof THREE.MeshFaceMaterial)for(L=0,C=V.faceMaterial.length;L<C;)(B=V.faceMaterial[L++])&&e(c,l,u,V,B,t);else B&&e(c,l,u,V,B,t)}else if(V instanceof THREE.RenderableFace4&&(c=V.v1,l=V.v2,u=V.v3,f=V.v4,c.positionScreen.x*=s,c.positionScreen.y*=-h,l.positionScreen.x*=s,l.positionScreen.y*=-h,u.positionScreen.x*=s,u.positionScreen.y*=-h,f.positionScreen.x*=s,f.positionScreen.y*=-h,y.addPoint(c.positionScreen.x,c.positionScreen.y),y.addPoint(l.positionScreen.x,l.positionScreen.y),y.addPoint(u.positionScreen.x,u.positionScreen.y),y.addPoint(f.positionScreen.x,f.positionScreen.y),R.instersects(y)))for(a=0,E=V.meshMaterial.length;a<E;)if(B=V.meshMaterial[a++],B instanceof THREE.MeshFaceMaterial)for(L=0,C=V.faceMaterial.length;L<C;)(B=V.faceMaterial[L++])&&i(c,l,u,f,V,B,t);else B&&i(c,l,u,f,V,B,t)}},THREE.WebGLRenderer=function(t){function e(t,e){var i=a.createProgram();return a.attachShader(i,r("fragment","#ifdef GL_ES\nprecision highp float;\n#endif\n"+t)),a.attachShader(i,r("vertex",e)),a.linkProgram(i),a.getProgramParameter(i,a.LINK_STATUS)||(alert("Could not initialise shaders"),alert("VALIDATE_STATUS: "+a.getProgramParameter(i,a.VALIDATE_STATUS)),alert(a.getError())),i.uniforms={},i}function i(t,e){var i,n,r;for(i=0,n=e.length;i<n;i++)r=e[i],t.uniforms[r]=a.getUniformLocation(t,r)}function n(t){t.position=a.getAttribLocation(t,"position"),a.enableVertexAttribArray(t.position),t.normal=a.getAttribLocation(t,"normal"),a.enableVertexAttribArray(t.normal),t.uv=a.getAttribLocation(t,"uv"),a.enableVertexAttribArray(t.uv)}function r(t,e){var i;return"fragment"==t?i=a.createShader(a.FRAGMENT_SHADER):"vertex"==t&&(i=a.createShader(a.VERTEX_SHADER)),a.shaderSource(i,e),a.compileShader(i),a.getShaderParameter(i,a.COMPILE_STATUS)?i:(alert(a.getShaderInfoLog(i)),null)}function o(t){switch(t){case THREE.Repeat:return a.REPEAT;case THREE.ClampToEdge:return a.CLAMP_TO_EDGE;case THREE.MirroredRepeat:return a.MIRRORED_REPEAT}return 0}var a,s,h,c,l=document.createElement("canvas"),u=new THREE.Matrix4,f=new Float32Array(16),E=new Float32Array(16),m=new Float32Array(16),p=new Float32Array(9),d=new Float32Array(16);t=function(t,e){if(t){var i,n,r,o=pointLights=maxDirLights=maxPointLights=0;for(i=0,n=t.lights.length;i<n;i++)r=t.lights[i],r instanceof THREE.DirectionalLight&&o++,r instanceof THREE.PointLight&&pointLights++;return pointLights+o<=e?(maxDirLights=o,maxPointLights=pointLights):(maxDirLights=Math.ceil(e*o/(pointLights+o)),maxPointLights=e-maxDirLights),{directional:maxDirLights,point:maxPointLights}}return{directional:1,point:e-1}}(t,4),this.domElement=l,this.autoClear=!0;try{a=l.getContext("experimental-webgl",{antialias:!0})}catch(t){}if(!a)throw alert("WebGL not supported"),"cannot create webgl context";a.clearColor(0,0,0,1),a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.frontFace(a.CCW),a.cullFace(a.BACK),a.enable(a.CULL_FACE),a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),a.clearColor(0,0,0,0),function(t,r){var o=[t?"#define MAX_DIR_LIGHTS "+t:"",r?"#define MAX_POINT_LIGHTS "+r:"","attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nuniform vec3 cameraPosition;\nuniform bool enableLighting;\nuniform bool useRefract;\nuniform int pointLightNumber;\nuniform int directionalLightNumber;\nuniform vec3 ambientLightColor;",t?"uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];":"",t?"uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];":"",r?"uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];":"",r?"uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];":"","uniform mat4 objMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vLightWeighting;",r?"varying vec3 vPointLightVector[ MAX_POINT_LIGHTS ];":"","varying vec3 vViewPosition;\nvarying vec3 vReflect;\nuniform float mRefractionRatio;\nvoid main(void) {\nvec4 mPosition = objMatrix * vec4( position, 1.0 );\nvViewPosition = cameraPosition - mPosition.xyz;\nvec3 nWorld = mat3( objMatrix[0].xyz, objMatrix[1].xyz, objMatrix[2].xyz ) * normal;\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec3 transformedNormal = normalize( normalMatrix * normal );\nif ( !enableLighting ) {\nvLightWeighting = vec3( 1.0, 1.0, 1.0 );\n} else {\nvLightWeighting = ambientLightColor;",t?"for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {":"",t?"vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );":"",t?"float directionalLightWeighting = max( dot( transformedNormal, normalize(lDirection.xyz ) ), 0.0 );":"",t?"vLightWeighting += directionalLightColor[ i ] * directionalLightWeighting;":"",t?"}":"",r?"for( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {":"",r?"vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );":"",r?"vPointLightVector[ i ] = normalize( lPosition.xyz - mvPosition.xyz );":"",r?"float pointLightWeighting = max( dot( transformedNormal, vPointLightVector[ i ] ), 0.0 );":"",r?"vLightWeighting += pointLightColor[ i ] * pointLightWeighting;":"",r?"}":"","}\nvNormal = transformedNormal;\nvUv = uv;\nif ( useRefract ) {\nvReflect = refract( normalize(mPosition.xyz - cameraPosition), normalize(nWorld.xyz), mRefractionRatio );\n} else {\nvReflect = reflect( normalize(mPosition.xyz - cameraPosition), normalize(nWorld.xyz) );\n}\ngl_Position = projectionMatrix * mvPosition;\n}"].join("\n"),h=[t?"#define MAX_DIR_LIGHTS "+t:"",r?"#define MAX_POINT_LIGHTS "+r:"","uniform int material;\nuniform bool enableMap;\nuniform bool enableCubeMap;\nuniform bool mixEnvMap;\nuniform samplerCube tCube;\nuniform float mReflectivity;\nuniform sampler2D tMap;\nuniform vec4 mColor;\nuniform float mOpacity;\nuniform vec4 mAmbient;\nuniform vec4 mSpecular;\nuniform float mShininess;\nuniform float m2Near;\nuniform float mFarPlusNear;\nuniform float mFarMinusNear;\nuniform int pointLightNumber;\nuniform int directionalLightNumber;",t?"uniform mat4 viewMatrix;":"",t?"uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];":"","varying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vLightWeighting;",r?"varying vec3 vPointLightVector[ MAX_POINT_LIGHTS ];":"","varying vec3 vViewPosition;\nvarying vec3 vReflect;\nuniform vec3 cameraPosition;\nvoid main() {\nvec4 mapColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nvec4 cubeColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nif ( enableMap ) {\nmapColor = texture2D( tMap, vUv );\n}\nif ( enableCubeMap ) {\ncubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\n}\nif ( material == 5 ) { \nvec3 wPos = cameraPosition - vViewPosition;\ngl_FragColor = textureCube( tCube, vec3( -wPos.x, wPos.yz ) );\n} else if ( material == 4 ) { \ngl_FragColor = vec4( 0.5*normalize( vNormal ) + vec3(0.5, 0.5, 0.5), mOpacity );\n} else if ( material == 3 ) { \nfloat w = 0.5;\ngl_FragColor = vec4( w, w, w, mOpacity );\n} else if ( material == 2 ) { \nvec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );",r?"vec4 pointDiffuse  = vec4( 0.0, 0.0, 0.0, 0.0 );":"",r?"vec4 pointSpecular = vec4( 0.0, 0.0, 0.0, 0.0 );":"",r?"for( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {":"",r?"vec3 pointVector = normalize( vPointLightVector[ i ] );":"",r?"vec3 pointHalfVector = normalize( vPointLightVector[ i ] + vViewPosition );":"",r?"float pointDotNormalHalf = dot( normal, pointHalfVector );":"",r?"float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );":"",r?"float pointSpecularWeight = 0.0;":"",r?"if ( pointDotNormalHalf >= 0.0 )":"",r?"pointSpecularWeight = pow( pointDotNormalHalf, mShininess );":"",r?"pointDiffuse  += mColor * pointDiffuseWeight;":"",r?"pointSpecular += mSpecular * pointSpecularWeight;":"",r?"}":"",t?"vec4 dirDiffuse  = vec4( 0.0, 0.0, 0.0, 0.0 );":"",t?"vec4 dirSpecular = vec4( 0.0, 0.0, 0.0, 0.0 );":"",t?"for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {":"",t?"vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );":"",t?"vec3 dirVector = normalize( lDirection.xyz );":"",t?"vec3 dirHalfVector = normalize( lDirection.xyz + vViewPosition );":"",t?"float dirDotNormalHalf = dot( normal, dirHalfVector );":"",t?"float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );":"",t?"float dirSpecularWeight = 0.0;":"",t?"if ( dirDotNormalHalf >= 0.0 )":"",t?"dirSpecularWeight = pow( dirDotNormalHalf, mShininess );":"",t?"dirDiffuse  += mColor * dirDiffuseWeight;":"",t?"dirSpecular += mSpecular * dirSpecularWeight;":"",t?"}":"","vec4 totalLight = mAmbient;",t?"totalLight += dirDiffuse + dirSpecular;":"",r?"totalLight += pointDiffuse + pointSpecular;":"","if ( mixEnvMap ) {\ngl_FragColor = vec4( mix( mapColor.rgb * totalLight.xyz * vLightWeighting, cubeColor.rgb, mReflectivity ), mapColor.a );\n} else {\ngl_FragColor = vec4( mapColor.rgb * cubeColor.rgb * totalLight.xyz * vLightWeighting, mapColor.a );\n}\n} else if ( material == 1 ) {\nif ( mixEnvMap ) {\ngl_FragColor = vec4( mix( mColor.rgb * mapColor.rgb * vLightWeighting, cubeColor.rgb, mReflectivity ), mColor.a * mapColor.a );\n} else {\ngl_FragColor = vec4( mColor.rgb * mapColor.rgb * cubeColor.rgb * vLightWeighting, mColor.a * mapColor.a );\n}\n} else {\nif ( mixEnvMap ) {\ngl_FragColor = mix( mColor * mapColor, cubeColor, mReflectivity );\n} else {\ngl_FragColor = mColor * mapColor * cubeColor;\n}\n}\n}"].join("\n");s=e(h,o),a.useProgram(s),i(s,["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","objMatrix","cameraPosition","enableLighting","ambientLightColor","material","mColor","mAmbient","mSpecular","mShininess","mOpacity","enableMap","tMap","enableCubeMap","tCube","mixEnvMap","mReflectivity","mRefractionRatio","useRefract","m2Near","mFarPlusNear","mFarMinusNear"]),t&&i(s,["directionalLightNumber","directionalLightColor","directionalLightDirection"]),r&&i(s,["pointLightNumber","pointLightColor","pointLightPosition"]),a.uniform1i(s.uniforms.enableMap,0),a.uniform1i(s.uniforms.tMap,0),a.uniform1i(s.uniforms.enableCubeMap,0),a.uniform1i(s.uniforms.tCube,1),a.uniform1i(s.uniforms.mixEnvMap,0),a.uniform1i(s.uniforms.useRefract,0),n(s)}(t.directional,t.point),this.setSize=function(t,e){l.width=t,l.height=e,a.viewport(0,0,l.width,l.height)},this.clear=function(){a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},this.setupLights=function(t,e){var i,n,r,o,s,h=[],c=[],l=[];
for(o=[],s=[],a.uniform1i(t.uniforms.enableLighting,e.lights.length),i=0,n=e.lights.length;i<n;i++)r=e.lights[i],r instanceof THREE.AmbientLight?h.push(r):r instanceof THREE.DirectionalLight?l.push(r):r instanceof THREE.PointLight&&c.push(r);for(i=r=o=s=0,n=h.length;i<n;i++)r+=h[i].color.r,o+=h[i].color.g,s+=h[i].color.b;for(a.uniform3f(t.uniforms.ambientLightColor,r,o,s),o=[],s=[],i=0,n=l.length;i<n;i++)r=l[i],o.push(r.color.r*r.intensity),o.push(r.color.g*r.intensity),o.push(r.color.b*r.intensity),s.push(r.position.x),s.push(r.position.y),s.push(r.position.z);for(l.length&&(a.uniform1i(t.uniforms.directionalLightNumber,l.length),a.uniform3fv(t.uniforms.directionalLightDirection,s),a.uniform3fv(t.uniforms.directionalLightColor,o)),o=[],s=[],i=0,n=c.length;i<n;i++)r=c[i],o.push(r.color.r*r.intensity),o.push(r.color.g*r.intensity),o.push(r.color.b*r.intensity),s.push(r.position.x),s.push(r.position.y),s.push(r.position.z);c.length&&(a.uniform1i(t.uniforms.pointLightNumber,c.length),a.uniform3fv(t.uniforms.pointLightPosition,s),a.uniform3fv(t.uniforms.pointLightColor,o))},this.createBuffers=function(t,e){var i,n,r,o,s,h,c,l,u,f=[],E=[],m=[],p=[],d=[],v=0,g=t.materialFaceGroup[e];for(r=!1,i=0,n=t.material.length;i<n;i++){if(meshMaterial=t.material[i],meshMaterial instanceof THREE.MeshFaceMaterial){for(s=0,u=g.material.length;s<u;s++)if(g.material[s]&&void 0!=g.material[s].shading&&g.material[s].shading==THREE.SmoothShading){r=!0;break}}else if(meshMaterial&&void 0!=meshMaterial.shading&&meshMaterial.shading==THREE.SmoothShading){r=!0;break}if(r)break}for(u=r,i=0,n=g.faces.length;i<n;i++)if(r=g.faces[i],o=t.geometry.faces[r],s=o.vertexNormals,faceNormal=o.normal,r=t.geometry.uvs[r],o instanceof THREE.Face3){if(h=t.geometry.vertices[o.a].position,c=t.geometry.vertices[o.b].position,l=t.geometry.vertices[o.c].position,m.push(h.x,h.y,h.z),m.push(c.x,c.y,c.z),m.push(l.x,l.y,l.z),3==s.length&&u)for(o=0;o<3;o++)p.push(s[o].x,s[o].y,s[o].z);else for(o=0;o<3;o++)p.push(faceNormal.x,faceNormal.y,faceNormal.z);if(r)for(o=0;o<3;o++)d.push(r[o].u,r[o].v);f.push(v,v+1,v+2),E.push(v,v+1),E.push(v,v+2),E.push(v+1,v+2),v+=3}else if(o instanceof THREE.Face4){if(h=t.geometry.vertices[o.a].position,c=t.geometry.vertices[o.b].position,l=t.geometry.vertices[o.c].position,o=t.geometry.vertices[o.d].position,m.push(h.x,h.y,h.z),m.push(c.x,c.y,c.z),m.push(l.x,l.y,l.z),m.push(o.x,o.y,o.z),4==s.length&&u)for(o=0;o<4;o++)p.push(s[o].x,s[o].y,s[o].z);else for(o=0;o<4;o++)p.push(faceNormal.x,faceNormal.y,faceNormal.z);if(r)for(o=0;o<4;o++)d.push(r[o].u,r[o].v);f.push(v,v+1,v+2),f.push(v,v+2,v+3),E.push(v,v+1),E.push(v,v+2),E.push(v,v+3),E.push(v+1,v+2),E.push(v+2,v+3),v+=4}m.length&&(g.__webGLVertexBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,g.__webGLVertexBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(m),a.STATIC_DRAW),g.__webGLNormalBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,g.__webGLNormalBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(p),a.STATIC_DRAW),g.__webGLUVBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,g.__webGLUVBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array(d),a.STATIC_DRAW),g.__webGLFaceBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g.__webGLFaceBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),a.STATIC_DRAW),g.__webGLLineBuffer=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,g.__webGLLineBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,new Uint16Array(E),a.STATIC_DRAW),g.__webGLFaceCount=f.length,g.__webGLLineCount=E.length)},this.renderBuffer=function(t,r,c){var l,u,f,E,m,p,d,v,g,b;if(r instanceof THREE.MeshShaderMaterial){if(!r.program){r.program=e(r.fragment_shader,r.vertex_shader),m=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","objMatrix","cameraPosition"];for(b in r.uniforms)m.push(b);i(r.program,m),n(r.program)}b=r.program}else b=s;if(b!=h&&(a.useProgram(b),h=b),r instanceof THREE.MeshShaderMaterial){m=b,v=r.uniforms;var _,R;for(u in v)if(_=v[u].type,g=v[u].value,R=m.uniforms[u],"i"==_)a.uniform1i(R,g);else if("f"==_)a.uniform1f(R,g);else if("t"==_&&(a.uniform1i(R,g),g=v[u].texture,g instanceof THREE.TextureCube&&6==g.image.length)){if(!g.image.__webGLTextureCube&&!g.image.__cubeMapInitialized&&6==g.image.loadCount){for(g.image.__webGLTextureCube=a.createTexture(),a.bindTexture(a.TEXTURE_CUBE_MAP,g.image.__webGLTextureCube),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),_=0;_<6;++_)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,g.image[_]);a.generateMipmap(a.TEXTURE_CUBE_MAP),a.bindTexture(a.TEXTURE_CUBE_MAP,null),g.image.__cubeMapInitialized=!0}a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_CUBE_MAP,g.image.__webGLTextureCube)}this.loadCamera(b,t),this.loadMatrices(b)}else(r instanceof THREE.MeshPhongMaterial||r instanceof THREE.MeshLambertMaterial||r instanceof THREE.MeshBasicMaterial)&&(t=r.color,l=r.opacity,f=r.wireframe,E=r.wireframe_linewidth,p=r.map,d=r.env_map,m=r.combine==THREE.Mix,u=r.reflectivity,g=r.env_map&&r.env_map.mapping==THREE.RefractionMapping,v=r.refraction_ratio,a.uniform4f(b.uniforms.mColor,t.r*l,t.g*l,t.b*l,l),a.uniform1i(b.uniforms.mixEnvMap,m),a.uniform1f(b.uniforms.mReflectivity,u),a.uniform1i(b.uniforms.useRefract,g),a.uniform1f(b.uniforms.mRefractionRatio,v));if(r instanceof THREE.MeshNormalMaterial?(l=r.opacity,a.uniform1f(b.uniforms.mOpacity,l),a.uniform1i(b.uniforms.material,4)):r instanceof THREE.MeshDepthMaterial?(l=r.opacity,f=r.wireframe,E=r.wireframe_linewidth,a.uniform1f(b.uniforms.mOpacity,l),a.uniform1f(b.uniforms.m2Near,r.__2near),a.uniform1f(b.uniforms.mFarPlusNear,r.__farPlusNear),a.uniform1f(b.uniforms.mFarMinusNear,r.__farMinusNear),a.uniform1i(b.uniforms.material,3)):r instanceof THREE.MeshPhongMaterial?(t=r.ambient,u=r.specular,m=r.shininess,a.uniform4f(b.uniforms.mAmbient,t.r,t.g,t.b,l),a.uniform4f(b.uniforms.mSpecular,u.r,u.g,u.b,l),a.uniform1f(b.uniforms.mShininess,m),a.uniform1i(b.uniforms.material,2)):r instanceof THREE.MeshLambertMaterial?a.uniform1i(b.uniforms.material,1):r instanceof THREE.MeshBasicMaterial?a.uniform1i(b.uniforms.material,0):r instanceof THREE.MeshCubeMaterial&&(a.uniform1i(b.uniforms.material,5),d=r.env_map),p?(!r.map.__webGLTexture&&r.map.image.loaded&&(r.map.__webGLTexture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,r.map.__webGLTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,r.map.image),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,o(r.map.wrap_s)),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,o(r.map.wrap_t)),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null)),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,r.map.__webGLTexture),a.uniform1i(b.uniforms.tMap,0),a.uniform1i(b.uniforms.enableMap,1)):a.uniform1i(b.uniforms.enableMap,0),d){if(r.env_map&&r.env_map instanceof THREE.TextureCube&&6==r.env_map.image.length){if(!r.env_map.image.__webGLTextureCube&&!r.env_map.image.__cubeMapInitialized&&6==r.env_map.image.loadCount){for(r.env_map.image.__webGLTextureCube=a.createTexture(),a.bindTexture(a.TEXTURE_CUBE_MAP,r.env_map.image.__webGLTextureCube),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),l=0;l<6;++l)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,r.env_map.image[l]);a.generateMipmap(a.TEXTURE_CUBE_MAP),a.bindTexture(a.TEXTURE_CUBE_MAP,null),r.env_map.image.__cubeMapInitialized=!0}a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_CUBE_MAP,r.env_map.image.__webGLTextureCube),a.uniform1i(b.uniforms.tCube,1)}a.uniform1i(b.uniforms.enableCubeMap,1)}else a.uniform1i(b.uniforms.enableCubeMap,0);a.bindBuffer(a.ARRAY_BUFFER,c.__webGLVertexBuffer),a.vertexAttribPointer(b.position,3,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,c.__webGLNormalBuffer),a.vertexAttribPointer(b.normal,3,a.FLOAT,!1,0,0),p?(a.bindBuffer(a.ARRAY_BUFFER,c.__webGLUVBuffer),a.enableVertexAttribArray(b.uv),a.vertexAttribPointer(b.uv,2,a.FLOAT,!1,0,0)):a.disableVertexAttribArray(b.uv),f?(a.lineWidth(E),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.__webGLLineBuffer),a.drawElements(a.LINES,c.__webGLLineCount,a.UNSIGNED_SHORT,0)):(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.__webGLFaceBuffer),a.drawElements(a.TRIANGLES,c.__webGLFaceCount,a.UNSIGNED_SHORT,0))},this.renderPass=function(t,e,i,n,r){var o,a,s,h,c;for(s=0,h=e.material.length;s<h;s++)if(o=e.material[s],o instanceof THREE.MeshFaceMaterial)for(o=0,a=i.material.length;o<a;o++)(c=i.material[o])&&c.blending==n&&c.opacity<1==r&&(this.setBlending(c.blending),this.renderBuffer(t,c,i));else(c=o)&&c.blending==n&&c.opacity<1==r&&(this.setBlending(c.blending),this.renderBuffer(t,c,i))},this.render=function(t,e){var i,n;for(this.initWebGLObjects(t),this.autoClear&&this.clear(),e.autoUpdateMatrix&&e.updateMatrix(),this.loadCamera(s,e),this.setupLights(s,t),i=0,n=t.__webGLObjects.length;i<n;i++)webGLObject=t.__webGLObjects[i],webGLObject.__object.visible&&(this.setupMatrices(webGLObject.__object,e),this.loadMatrices(s),this.renderPass(e,webGLObject.__object,webGLObject,THREE.NormalBlending,!1));for(i=0,n=t.__webGLObjects.length;i<n;i++)webGLObject=t.__webGLObjects[i],webGLObject.__object.visible&&(this.setupMatrices(webGLObject.__object,e),this.loadMatrices(s),this.renderPass(e,webGLObject.__object,webGLObject,THREE.AdditiveBlending,!1),this.renderPass(e,webGLObject.__object,webGLObject,THREE.SubtractiveBlending,!1),this.renderPass(e,webGLObject.__object,webGLObject,THREE.AdditiveBlending,!0),this.renderPass(e,webGLObject.__object,webGLObject,THREE.SubtractiveBlending,!0),this.renderPass(e,webGLObject.__object,webGLObject,THREE.NormalBlending,!0))},this.initWebGLObjects=function(t){var e,i,n,r,o;for(t.__webGLObjects||(t.__webGLObjects=[]),e=0,i=t.objects.length;e<i;e++)if(n=t.objects[e],n instanceof THREE.Mesh)for(r in n.materialFaceGroup)o=n.materialFaceGroup[r],o.__webGLVertexBuffer||(this.createBuffers(n,r),o.__object=n,t.__webGLObjects.push(o))},this.removeObject=function(t,e){var i,n;for(i=t.__webGLObjects.length-1;i>=0;i--)n=t.__webGLObjects[i].__object,e==n&&t.__webGLObjects.splice(i,1)},this.setupMatrices=function(t,e){t.autoUpdateMatrix&&t.updateMatrix(),u.multiply(e.matrix,t.matrix),f.set(e.matrix.flatten()),E.set(u.flatten()),m.set(e.projectionMatrix.flatten()),c=THREE.Matrix4.makeInvert3x3(u).transpose(),p.set(c.m),d.set(t.matrix.flatten())},this.loadMatrices=function(t){a.uniformMatrix4fv(t.uniforms.viewMatrix,!1,f),a.uniformMatrix4fv(t.uniforms.modelViewMatrix,!1,E),a.uniformMatrix4fv(t.uniforms.projectionMatrix,!1,m),a.uniformMatrix3fv(t.uniforms.normalMatrix,!1,p),a.uniformMatrix4fv(t.uniforms.objMatrix,!1,d)},this.loadCamera=function(t,e){a.uniform3f(t.uniforms.cameraPosition,e.position.x,e.position.y,e.position.z)},this.setBlending=function(t){switch(t){case THREE.AdditiveBlending:a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ONE);break;case THREE.SubtractiveBlending:a.blendFunc(a.DST_COLOR,a.ZERO);break;default:a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA)}},this.setFaceCulling=function(t,e){t?(e&&"ccw"!=e?a.frontFace(a.CW):a.frontFace(a.CCW),"back"==t?a.cullFace(a.BACK):"front"==t?a.cullFace(a.FRONT):a.cullFace(a.FRONT_AND_BACK),a.enable(a.CULL_FACE)):a.disable(a.CULL_FACE)}},THREE.RenderableFace3=function(){this.z=null,this.v1=new THREE.Vertex,this.v2=new THREE.Vertex,this.v3=new THREE.Vertex,this.centroidWorld=new THREE.Vector3,this.centroidScreen=new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.vertexNormalsWorld=[],this.faceMaterial=this.meshMaterial=null,this.overdraw=!1,this.uvs=[null,null,null]},THREE.RenderableParticle=function(){this.rotation=this.z=this.y=this.x=null,this.scale=new THREE.Vector2,this.material=null},THREE.RenderableLine=function(){this.z=null,this.v1=new THREE.Vertex,this.v2=new THREE.Vertex,this.material=null};var GeometryUtils={merge:function(t,e){var i=e instanceof THREE.Mesh,n=t.vertices.length,r=i?e.geometry:e,o=t.vertices,a=r.vertices,s=t.faces,h=r.faces,c=t.uvs;r=r.uvs,i&&e.updateMatrix();for(var l=0,u=a.length;l<u;l++){var f=new THREE.Vertex(a[l].position.clone());i&&e.matrix.transformVector3(f.position),o.push(f)}for(l=0,u=h.length;l<u;l++){i=h[l];var E;for(a=i.vertexNormals,i instanceof THREE.Face3?E=new THREE.Face3(i.a+n,i.b+n,i.c+n):i instanceof THREE.Face4&&(E=new THREE.Face4(i.a+n,i.b+n,i.c+n,i.d+n)),i=0,o=a.length;i<o;i++)f=a[i],E.vertexNormals.push(f.clone());s.push(E)}for(l=0,u=r.length;l<u;l++){for(n=r[l],s=[],i=0,o=n.length;i<o;i++)s.push(new THREE.UV(n[i].u,n[i].v));c.push(s)}}},ImageUtils={loadArray:function(t){var e,i,n=[];for(e=n.loadCount=0,i=t.length;e<i;++e)n[e]=new Image,n[e].loaded=0,n[e].onload=function(){n.loadCount+=1,this.loaded=1},n[e].src=t[e];return n}},SceneUtils={addMesh:function(t,e,i,n,r,o,a,s,h,c){return e=new THREE.Mesh(e,c),e.scale.x=e.scale.y=e.scale.z=i,e.position.x=n,e.position.y=r,e.position.z=o,e.rotation.x=a,e.rotation.y=s,e.rotation.z=h,t.addObject(e),e},addPanoramaCubeWebGL:function(t,e,i){return i=new THREE.MeshCubeMaterial({env_map:i}),e=new THREE.Mesh(new Cube(e,e,e,1,1,null,!0),i),t.addObject(e),e},addPanoramaCube:function(t,e,i){var n=[];return n.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(i[0])})),n.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(i[1])})),n.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(i[2])})),n.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(i[3])})),n.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(i[4])})),n.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(i[5])})),mesh=new THREE.Mesh(new Cube(e,e,e,1,1,n,!0),new THREE.MeshFaceMaterial),t.addObject(mesh),mesh},addPanoramaCubePlanes:function(t,e,i){var n=e/2;e=new Plane(e,e);var r=Math.PI/2,o=Math.PI;SceneUtils.addMesh(t,e,1,0,0,-n,0,0,0,new THREE.MeshBasicMaterial({map:new THREE.Texture(i[5])})),SceneUtils.addMesh(t,e,1,-n,0,0,0,r,0,new THREE.MeshBasicMaterial({map:new THREE.Texture(i[0])})),SceneUtils.addMesh(t,e,1,n,0,0,0,-r,0,new THREE.MeshBasicMaterial({map:new THREE.Texture(i[1])})),SceneUtils.addMesh(t,e,1,0,n,0,r,0,o,new THREE.MeshBasicMaterial({map:new THREE.Texture(i[2])})),SceneUtils.addMesh(t,e,1,0,-n,0,-r,0,o,new THREE.MeshBasicMaterial({map:new THREE.Texture(i[3])}))}},ShaderUtils={lib:{fresnel:{uniforms:{mRefractionRatio:{type:"f",value:1.02},mFresnelBias:{type:"f",value:.1},mFresnelPower:{type:"f",value:2},mFresnelScale:{type:"f",value:1},tCube:{type:"t",value:1,texture:null}},fragment_shader:"uniform samplerCube tCube;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main() {\nvec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\nvec4 refractedColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nrefractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;\nrefractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;\nrefractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;\nrefractedColor.a = 1.0;\ngl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );\n}",vertex_shader:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 uv;\nuniform mat4 objMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 cameraPosition;\nuniform float mRefractionRatio;\nuniform float mFresnelBias;\nuniform float mFresnelScale;\nuniform float mFresnelPower;\nvarying vec3 vReflect;\nvarying vec3 vRefract[3];\nvarying float vReflectionFactor;\nvoid main(void) {\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec4 mPosition = objMatrix * vec4( position, 1.0 );\nvec3 nWorld = normalize ( mat3( objMatrix[0].xyz, objMatrix[1].xyz, objMatrix[2].xyz ) * normal );\nvec3 I = mPosition.xyz - cameraPosition;\nvReflect = reflect( I, nWorld );\nvRefract[0] = refract( normalize( I ), nWorld, mRefractionRatio );\nvRefract[1] = refract( normalize( I ), nWorld, mRefractionRatio * 0.99 );\nvRefract[2] = refract( normalize( I ), nWorld, mRefractionRatio * 0.98 );\nvReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), nWorld ), mFresnelPower );\ngl_Position = projectionMatrix * mvPosition;\n}"}}},Cube=function(t,e,i,n,r,o,a){function s(t,e,i,o,a,s,u,f){var E=n||1,m=r||1,p=E+1,d=m+1;a/=E,s/=m;var v,g=h.vertices.length;for("x"==t&&"y"==e||"y"==t&&"x"==e?v="z":"x"==t&&"z"==e||"z"==t&&"x"==e?v="y":("z"==t&&"y"==e||"y"==t&&"z"==e)&&(v="x"),iy=0;iy<d;iy++)for(ix=0;ix<p;ix++){var b=new THREE.Vector3;b[t]=(ix*a-c)*i,b[e]=(iy*s-l)*o,b[v]=u,h.vertices.push(new THREE.Vertex(b))}for(iy=0;iy<m;iy++)for(ix=0;ix<E;ix++)h.faces.push(new THREE.Face4(ix+p*iy+g,ix+p*(iy+1)+g,ix+1+p*(iy+1)+g,ix+1+p*iy+g,null,f)),h.uvs.push([new THREE.UV(ix/E,iy/m),new THREE.UV(ix/E,(iy+1)/m),new THREE.UV((ix+1)/E,(iy+1)/m),new THREE.UV((ix+1)/E,iy/m)])}THREE.Geometry.call(this);var h=this,c=t/2,l=e/2,u=i/2;if(a=a?-1:1,void 0!==o)if(o instanceof Array)this.materials=o;else{this.materials=[];for(var f=0;f<6;f++)this.materials.push([o])}else this.materials=[];s("z","y",1*a,-1,i,e,-c,this.materials[0]),s("z","y",-1*a,-1,i,e,c,this.materials[1]),s("x","z",1*a,1,t,i,l,this.materials[2]),s("x","z",1*a,-1,t,i,-l,this.materials[3]),s("x","y",1*a,-1,t,e,u,this.materials[4]),s("x","y",-1*a,-1,t,e,-u,this.materials[5]),function(){for(var t=[],e=[],i=0,n=h.vertices.length;i<n;i++){for(var r=h.vertices[i],o=!1,a=0,s=t.length;a<s;a++){var c=t[a];if(r.position.x==c.position.x&&r.position.y==c.position.y&&r.position.z==c.position.z){e[i]=a,o=!0;break}}o||(e[i]=t.length,t.push(new THREE.Vertex(r.position.clone())))}for(i=0,n=h.faces.length;i<n;i++)r=h.faces[i],r.a=e[r.a],r.b=e[r.b],r.c=e[r.c],r.d=e[r.d];h.vertices=t}(),this.computeCentroids(),this.computeNormals()};Cube.prototype=new THREE.Geometry,Cube.prototype.constructor=Cube;var Cylinder=function(t,e,i,n,r){function o(t,e,i){s.vertices.push(new THREE.Vertex(new THREE.Vector3(t,e,i)))}THREE.Geometry.call(this);var a,s=this;for(a=0;a<t;a++)o(Math.sin(6.283*a/t)*e,Math.cos(6.283*a/t)*e,0);for(a=0;a<t;a++)o(Math.sin(6.283*a/t)*i,Math.cos(6.283*a/t)*i,n);for(a=0;a<t;a++)s.faces.push(new THREE.Face4(a,a+t,t+(a+1)%t,(a+1)%t));if(0!=i)for(o(0,0,-r),a=t;a<t+t/2;a++)s.faces.push(new THREE.Face4(2*t,(2*a-2*t)%t,(2*a-2*t+1)%t,(2*a-2*t+2)%t));if(0!=e)for(o(0,0,n+r),a=t+t/2;a<2*t;a++)s.faces.push(new THREE.Face4((2*a-2*t+2)%t+t,(2*a-2*t+1)%t+t,(2*a-2*t)%t+t,2*t+1));this.computeCentroids(),this.computeNormals()};Cylinder.prototype=new THREE.Geometry,Cylinder.prototype.constructor=Cylinder;var Plane=function(t,e,i,n){THREE.Geometry.call(this);var r,o=t/2,a=e/2;i=i||1,n=n||1;var s=i+1,h=n+1;t/=i;var c=e/n;for(r=0;r<h;r++)for(e=0;e<s;e++)this.vertices.push(new THREE.Vertex(new THREE.Vector3(e*t-o,-(r*c-a),0)));for(r=0;r<n;r++)for(e=0;e<i;e++)this.faces.push(new THREE.Face4(e+s*r,e+s*(r+1),e+1+s*(r+1),e+1+s*r)),this.uvs.push([new THREE.UV(e/i,r/n),new THREE.UV(e/i,(r+1)/n),new THREE.UV((e+1)/i,(r+1)/n),new THREE.UV((e+1)/i,r/n)]);this.computeCentroids(),this.computeNormals()};Plane.prototype=new THREE.Geometry,Plane.prototype.constructor=Plane;var Sphere=function(t,e,i){THREE.Geometry.call(this);var n,r=Math.max(3,e||8),o=Math.max(2,i||6);for(e=[],i=0;i<o+1;i++){n=i/o;var a=t*Math.cos(n*Math.PI),s=t*Math.sin(n*Math.PI),h=[],c=0;for(n=0;n<r;n++){var l=2*n/r,u=s*Math.sin(l*Math.PI);l=s*Math.cos(l*Math.PI),(0==i||i==o)&&n>0||(c=this.vertices.push(new THREE.Vertex(new THREE.Vector3(l,a,u)))-1),h.push(c)}e.push(h)}var f,E,m;for(t=e.length,i=0;i<t;i++)if(r=e[i].length,i>0)for(n=0;n<r;n++){h=n==r-1,o=e[i][h?0:n+1],a=e[i][h?r-1:n],s=e[i-1][h?r-1:n],h=e[i-1][h?0:n+1],u=i/(t-1),f=(i-1)/(t-1),E=(n+1)/r,l=n/r,c=new THREE.UV(1-E,u),u=new THREE.UV(1-l,u),l=new THREE.UV(1-l,f);var p=new THREE.UV(1-E,f);i<e.length-1&&(f=this.vertices[o].position.clone(),E=this.vertices[a].position.clone(),m=this.vertices[s].position.clone(),f.normalize(),E.normalize(),m.normalize(),this.faces.push(new THREE.Face3(o,a,s,[new THREE.Vector3(f.x,f.y,f.z),new THREE.Vector3(E.x,E.y,E.z),new THREE.Vector3(m.x,m.y,m.z)])),this.uvs.push([c,u,l])),i>1&&(f=this.vertices[o].position.clone(),E=this.vertices[s].position.clone(),m=this.vertices[h].position.clone(),f.normalize(),E.normalize(),m.normalize(),this.faces.push(new THREE.Face3(o,s,h,[new THREE.Vector3(f.x,f.y,f.z),new THREE.Vector3(E.x,E.y,E.z),new THREE.Vector3(m.x,m.y,m.z)])),this.uvs.push([c,l,p]))}this.computeCentroids(),this.computeNormals()};Sphere.prototype=new THREE.Geometry,Sphere.prototype.constructor=Sphere,THREE.Loader=function(t){this.statusDomElement=(this.showStatus=t)?this.addStatusElement():null},THREE.Loader.prototype={addStatusElement:function(){var t=document.createElement("div");return t.style.fontSize="0.8em",t.style.textAlign="left",t.style.background="#b00",t.style.color="#fff",t.style.width="140px",t.style.padding="0.25em 0.25em 0.25em 0.5em",t.style.position="absolute",t.style.right="0px",t.style.top="0px",t.style.zIndex=1e3,t.innerHTML="Loading ...",t},updateProgress:function(t){var e="Loaded ";e+=t.total?(100*t.loaded/t.total).toFixed(0)+"%":(t.loaded/1e3).toFixed(2)+" KB",this.statusDomElement.innerHTML=e},loadAsciiOld:function(t,e){var i=document.createElement("script");i.type="text/javascript",i.onload=e,i.src=t,document.getElementsByTagName("head")[0].appendChild(i)},loadAscii:function(t,e,i){var n=(new Date).getTime();t=new Worker(t),t.onmessage=function(t){THREE.Loader.prototype.createModel(t.data,e,i)},t.postMessage(n)},loadBinary:function(t,e,i){var n=(new Date).getTime();t=new Worker(t);var r=this.showProgress?THREE.Loader.prototype.updateProgress:null;t.onmessage=function(t){THREE.Loader.prototype.loadAjaxBuffers(t.data.buffers,t.data.materials,e,i,r)},t.onerror=function(t){alert("worker.onerror: "+t.message+"\n"+t.data),t.preventDefault()},t.postMessage(n)},loadAjaxBuffers:function(t,e,i,n,r){var o=new XMLHttpRequest,a=n+"/"+t,s=0;o.onreadystatechange=function(){4==o.readyState?200==o.status||0==o.status?THREE.Loader.prototype.createBinModel(o.responseText,i,n,e):alert("Couldn't load ["+a+"] ["+o.status+"]"):3==o.readyState?r&&(0==s&&(s=o.getResponseHeader("Content-Length")),r({total:s,loaded:o.responseText.length})):2==o.readyState&&(s=o.getResponseHeader("Content-Length"))},o.open("GET",a,!0),o.overrideMimeType("text/plain; charset=x-user-defined"),o.setRequestHeader("Content-Type","text/plain"),o.send(null)},createBinModel:function(t,e,i,n){var r=function(e){function i(t,e){var i=s(t,e),n=s(t,e+1),r=s(t,e+2),o=s(t,e+3),a=(o<<1&255|r>>7)-127;return i|=(127&r)<<16|n<<8,0==i&&a==-127?0:(1-2*(o>>7))*(1+i*Math.pow(2,-23))*Math.pow(2,a)}function r(t,e){var i=s(t,e),n=s(t,e+1),r=s(t,e+2);return(s(t,e+3)<<24)+(r<<16)+(n<<8)+i}function o(t,e){var i=s(t,e);return(s(t,e+1)<<8)+i}function a(t,e){var i=s(t,e);return i>127?i-256:i}function s(t,e){return 255&t.charCodeAt(e)}function h(e){var i,n,a;i=r(t,e),n=r(t,e+p),a=r(t,e+d),e=o(t,e+v),THREE.Loader.prototype.f3(V,i,n,a,e)}function c(e){var i,n,a,s,h,c;i=r(t,e),n=r(t,e+p),a=r(t,e+d),s=o(t,e+v),h=r(t,e+g),c=r(t,e+b),e=r(t,e+_),THREE.Loader.prototype.f3n(V,F,i,n,a,s,h,c,e)}function l(e){var i,n,a,s;i=r(t,e),n=r(t,e+R),a=r(t,e+y),s=r(t,e+T),e=o(t,e+x),THREE.Loader.prototype.f4(V,i,n,a,s,e)}function u(e){var i,n,a,s,h,c,l,u;i=r(t,e),n=r(t,e+R),a=r(t,e+y),s=r(t,e+T),h=o(t,e+x),c=r(t,e+w),l=r(t,e+H),u=r(t,e+M),e=r(t,e+S),THREE.Loader.prototype.f4n(V,F,i,n,a,s,h,c,l,u,e)}function f(e){var i,n;i=r(t,e),n=r(t,e+L),e=r(t,e+C),THREE.Loader.prototype.uv3(V,N[2*i],N[2*i+1],N[2*n],N[2*n+1],N[2*e],N[2*e+1])}function E(e){var i,n,o;i=r(t,e),n=r(t,e+z),o=r(t,e+P),e=r(t,e+A),THREE.Loader.prototype.uv4(V,N[2*i],N[2*i+1],N[2*n],N[2*n+1],N[2*o],N[2*o+1],N[2*e],N[2*e+1])}var m,p,d,v,g,b,_,R,y,T,x,w,H,M,S,L,C,z,P,A,V=this,B=0,F=[],N=[];THREE.Geometry.call(this),THREE.Loader.prototype.init_materials(V,n,e),m={signature:t.substr(B,8),header_bytes:s(t,B+8),vertex_coordinate_bytes:s(t,B+9),normal_coordinate_bytes:s(t,B+10),uv_coordinate_bytes:s(t,B+11),vertex_index_bytes:s(t,B+12),normal_index_bytes:s(t,B+13),uv_index_bytes:s(t,B+14),material_index_bytes:s(t,B+15),nvertices:r(t,B+16),nnormals:r(t,B+16+4),nuvs:r(t,B+16+8),ntri_flat:r(t,B+16+12),ntri_smooth:r(t,B+16+16),ntri_flat_uv:r(t,B+16+20),ntri_smooth_uv:r(t,B+16+24),nquad_flat:r(t,B+16+28),nquad_smooth:r(t,B+16+32),nquad_flat_uv:r(t,B+16+36),nquad_smooth_uv:r(t,B+16+40)},B+=m.header_bytes,p=m.vertex_index_bytes,d=2*m.vertex_index_bytes,v=3*m.vertex_index_bytes,g=3*m.vertex_index_bytes+m.material_index_bytes,b=3*m.vertex_index_bytes+m.material_index_bytes+m.normal_index_bytes,_=3*m.vertex_index_bytes+m.material_index_bytes+2*m.normal_index_bytes,R=m.vertex_index_bytes,y=2*m.vertex_index_bytes,T=3*m.vertex_index_bytes,x=4*m.vertex_index_bytes,w=4*m.vertex_index_bytes+m.material_index_bytes,H=4*m.vertex_index_bytes+m.material_index_bytes+m.normal_index_bytes,M=4*m.vertex_index_bytes+m.material_index_bytes+2*m.normal_index_bytes,S=4*m.vertex_index_bytes+m.material_index_bytes+3*m.normal_index_bytes,L=m.uv_index_bytes,C=2*m.uv_index_bytes,z=m.uv_index_bytes,P=2*m.uv_index_bytes,A=3*m.uv_index_bytes,B+=function(e){var n,r,o,a=3*m.vertex_coordinate_bytes,s=e+m.nvertices*a;for(e=e;e<s;e+=a)n=i(t,e),r=i(t,e+m.vertex_coordinate_bytes),o=i(t,e+2*m.vertex_coordinate_bytes),THREE.Loader.prototype.v(V,n,r,o);return m.nvertices*a}(B),B+=function(e){var i,n,r,o=3*m.normal_coordinate_bytes,s=e+m.nnormals*o;for(e=e;e<s;e+=o)i=a(t,e),n=a(t,e+m.normal_coordinate_bytes),r=a(t,e+2*m.normal_coordinate_bytes),F.push(i/127,n/127,r/127);return m.nnormals*o}(B),B+=function(e){var n,r,o=2*m.uv_coordinate_bytes,a=e+m.nuvs*o;for(e=e;e<a;e+=o)n=i(t,e),r=i(t,e+m.uv_coordinate_bytes),N.push(n,r);return m.nuvs*o}(B),B+=function(t){var e,i=3*m.vertex_index_bytes+m.material_index_bytes,n=t+m.ntri_flat*i;for(e=t;e<n;e+=i)h(e);return n-t}(B),B+=function(t){var e,i=3*m.vertex_index_bytes+m.material_index_bytes+3*m.normal_index_bytes,n=t+m.ntri_smooth*i;for(e=t;e<n;e+=i)c(e);return n-t}(B),B+=function(t){var e,i=3*m.vertex_index_bytes+m.material_index_bytes,n=i+3*m.uv_index_bytes,r=t+m.ntri_flat_uv*n;for(e=t;e<r;e+=n)h(e),f(e+i);return r-t}(B),B+=function(t){var e,i=3*m.vertex_index_bytes+m.material_index_bytes+3*m.normal_index_bytes,n=i+3*m.uv_index_bytes,r=t+m.ntri_smooth_uv*n;for(e=t;e<r;e+=n)c(e),f(e+i);return r-t}(B),B+=function(t){var e,i=4*m.vertex_index_bytes+m.material_index_bytes,n=t+m.nquad_flat*i;for(e=t;e<n;e+=i)l(e);return n-t}(B),B+=function(t){var e,i=4*m.vertex_index_bytes+m.material_index_bytes+4*m.normal_index_bytes,n=t+m.nquad_smooth*i;for(e=t;e<n;e+=i)u(e);return n-t}(B),B+=function(t){var e,i=4*m.vertex_index_bytes+m.material_index_bytes,n=i+4*m.uv_index_bytes,r=t+m.nquad_flat_uv*n;for(e=t;e<r;e+=n)l(e),E(e+i);return r-t}(B),B+=function(t){var e,i=4*m.vertex_index_bytes+m.material_index_bytes+4*m.normal_index_bytes,n=i+4*m.uv_index_bytes,r=t+m.nquad_smooth_uv*n;for(e=t;e<r;e+=n)u(e),E(e+i);return r-t}(B),this.computeCentroids(),this.computeNormals()};r.prototype=new THREE.Geometry,r.prototype.constructor=r,e(new r(i))},createModel:function(t,e,i){var n=function(e){var i=this;THREE.Geometry.call(this),THREE.Loader.prototype.init_materials(i,t.materials,e),function(){var e,n,r,o,a;for(e=0,n=t.vertices.length;e<n;e+=3)r=t.vertices[e],o=t.vertices[e+1],a=t.vertices[e+2],THREE.Loader.prototype.v(i,r,o,a)}(),function(){function e(t,e){THREE.Loader.prototype.f3(i,t[e],t[e+1],t[e+2],t[e+3])}function n(e,n){THREE.Loader.prototype.f3n(i,t.normals,e[n],e[n+1],e[n+2],e[n+3],e[n+4],e[n+5],e[n+6])}function r(t,e){THREE.Loader.prototype.f4(i,t[e],t[e+1],t[e+2],t[e+3],t[e+4])}function o(e,n){THREE.Loader.prototype.f4n(i,t.normals,e[n],e[n+1],e[n+2],e[n+3],e[n+4],e[n+5],e[n+6],e[n+7],e[n+8])}function a(e,n){var r,o,a;r=e[n],o=e[n+1],a=e[n+2],THREE.Loader.prototype.uv3(i,t.uvs[2*r],t.uvs[2*r+1],t.uvs[2*o],t.uvs[2*o+1],t.uvs[2*a],t.uvs[2*a+1])}function s(e,n){var r,o,a,s;r=e[n],o=e[n+1],a=e[n+2],s=e[n+3],THREE.Loader.prototype.uv4(i,t.uvs[2*r],t.uvs[2*r+1],t.uvs[2*o],t.uvs[2*o+1],t.uvs[2*a],t.uvs[2*a+1],t.uvs[2*s],t.uvs[2*s+1])}var h,c;for(h=0,c=t.triangles.length;h<c;h+=4)e(t.triangles,h);for(h=0,c=t.triangles_uv.length;h<c;h+=7)e(t.triangles_uv,h),a(t.triangles_uv,h+4);for(h=0,c=t.triangles_n.length;h<c;h+=7)n(t.triangles_n,h);for(h=0,c=t.triangles_n_uv.length;h<c;h+=10)n(t.triangles_n_uv,h),a(t.triangles_n_uv,h+7);for(h=0,c=t.quads.length;h<c;h+=5)r(t.quads,h);for(h=0,c=t.quads_uv.length;h<c;h+=9)r(t.quads_uv,h),s(t.quads_uv,h+5);for(h=0,c=t.quads_n.length;h<c;h+=9)o(t.quads_n,h);for(h=0,c=t.quads_n_uv.length;h<c;h+=13)o(t.quads_n_uv,h),s(t.quads_n_uv,h+9)}(),this.computeCentroids(),this.computeNormals()};n.prototype=new THREE.Geometry,n.prototype.constructor=n,e(new n(i))},v:function(t,e,i,n){t.vertices.push(new THREE.Vertex(new THREE.Vector3(e,i,n)))},f3:function(t,e,i,n,r){t.faces.push(new THREE.Face3(e,i,n,null,t.materials[r]))},f4:function(t,e,i,n,r,o){t.faces.push(new THREE.Face4(e,i,n,r,null,t.materials[o]))},f3n:function(t,e,i,n,r,o,a,s,h){o=t.materials[o];var c=e[3*s],l=e[3*s+1];s=e[3*s+2];var u=e[3*h],f=e[3*h+1];h=e[3*h+2],t.faces.push(new THREE.Face3(i,n,r,[new THREE.Vector3(e[3*a],e[3*a+1],e[3*a+2]),new THREE.Vector3(c,l,s),new THREE.Vector3(u,f,h)],o))},f4n:function(t,e,i,n,r,o,a,s,h,c,l){a=t.materials[a];var u=e[3*h],f=e[3*h+1];h=e[3*h+2];var E=e[3*c],m=e[3*c+1];c=e[3*c+2];var p=e[3*l],d=e[3*l+1];l=e[3*l+2],t.faces.push(new THREE.Face4(i,n,r,o,[new THREE.Vector3(e[3*s],e[3*s+1],e[3*s+2]),new THREE.Vector3(u,f,h),new THREE.Vector3(E,m,c),new THREE.Vector3(p,d,l)],a))},uv3:function(t,e,i,n,r,o,a){var s=[];s.push(new THREE.UV(e,i)),s.push(new THREE.UV(n,r)),s.push(new THREE.UV(o,a)),t.uvs.push(s)},uv4:function(t,e,i,n,r,o,a,s,h){var c=[];c.push(new THREE.UV(e,i)),c.push(new THREE.UV(n,r)),c.push(new THREE.UV(o,a)),c.push(new THREE.UV(s,h)),t.uvs.push(c)},init_materials:function(t,e,i){t.materials=[];for(var n=0;n<e.length;++n)t.materials[n]=[THREE.Loader.prototype.createMaterial(e[n],i)]},createMaterial:function(t,e){function i(t){return t=Math.log(t)/Math.LN2,Math.floor(t)==t}var n,r;return t.map_diffuse&&e?(r=document.createElement("canvas"),n=new THREE.MeshLambertMaterial({map:new THREE.Texture(r)}),r=new Image,r.onload=function(){if(i(this.width)&&i(this.height))n.map.image=this;else{var t=Math.pow(2,Math.round(Math.log(this.width)/Math.LN2)),e=Math.pow(2,Math.round(Math.log(this.height)/Math.LN2));n.map.image.width=t,n.map.image.height=e,n.map.image.getContext("2d").drawImage(this,0,0,t,e)}n.map.image.loaded=1},r.src=e+"/"+t.map_diffuse):t.col_diffuse?(r=(255*t.col_diffuse[0]<<16)+(255*t.col_diffuse[1]<<8)+255*t.col_diffuse[2],n=new THREE.MeshLambertMaterial({color:r,opacity:t.transparency})):n=t.a_dbg_color?new THREE.MeshLambertMaterial({color:t.a_dbg_color}):new THREE.MeshLambertMaterial({color:15658734}),n}};