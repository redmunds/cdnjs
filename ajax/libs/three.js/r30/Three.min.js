var THREE=THREE||{};THREE.Color=function(i){this.autoUpdate=!0,this.setHex(i)},THREE.Color.prototype={setRGB:function(i,t,e){this.r=i,this.g=t,this.b=e,this.autoUpdate&&(this.updateHex(),this.updateStyleString())},setHex:function(i){this.hex=16777215&~~i,this.autoUpdate&&(this.updateRGBA(),this.updateStyleString())},updateHex:function(){this.hex=~~(255*this.r)<<16^~~(255*this.g)<<8^~~(255*this.b)},updateRGBA:function(){this.r=(this.hex>>16&255)/255,this.g=(this.hex>>8&255)/255,this.b=(255&this.hex)/255},updateStyleString:function(){this.__styleString="rgb("+~~(255*this.r)+","+~~(255*this.g)+","+~~(255*this.b)+")"},toString:function(){return"THREE.Color ( r: "+this.r+", g: "+this.g+", b: "+this.b+", hex: "+this.hex+" )"}},THREE.Vector2=function(i,t){this.x=i||0,this.y=t||0},THREE.Vector2.prototype={set:function(i,t){return this.x=i,this.y=t,this},copy:function(i){return this.x=i.x,this.y=i.y,this},addSelf:function(i){return this.x+=i.x,this.y+=i.y,this},add:function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this},subSelf:function(i){return this.x-=i.x,this.y-=i.y,this},sub:function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this},multiplyScalar:function(i){return this.x*=i,this.y*=i,this},unit:function(){return this.multiplyScalar(1/this.length()),this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},negate:function(){return this.x=-this.x,this.y=-this.y,this},clone:function(){return new THREE.Vector2(this.x,this.y)},toString:function(){return"THREE.Vector2 ("+this.x+", "+this.y+")"}},THREE.Vector3=function(i,t,e){this.x=i||0,this.y=t||0,this.z=e||0},THREE.Vector3.prototype={set:function(i,t,e){return this.x=i,this.y=t,this.z=e,this},copy:function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this},add:function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this},addSelf:function(i){return this.x+=i.x,this.y+=i.y,this.z+=i.z,this},addScalar:function(i){return this.x+=i,this.y+=i,this.z+=i,this},sub:function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this},subSelf:function(i){return this.x-=i.x,this.y-=i.y,this.z-=i.z,this},cross:function(i,t){return this.x=i.y*t.z-i.z*t.y,this.y=i.z*t.x-i.x*t.z,this.z=i.x*t.y-i.y*t.x,this},crossSelf:function(i){var t=this.x,e=this.y,n=this.z;return this.x=e*i.z-n*i.y,this.y=n*i.x-t*i.z,this.z=t*i.y-e*i.x,this},multiplySelf:function(i){return this.x*=i.x,this.y*=i.y,this.z*=i.z,this},multiplyScalar:function(i){return this.x*=i,this.y*=i,this.z*=i,this},divideScalar:function(i){return this.x/=i,this.y/=i,this.z/=i,this},dot:function(i){return this.x*i.x+this.y*i.y+this.z*i.z},distanceTo:function(i){var t=this.x-i.x,e=this.y-i.y;return i=this.z-i.z,Math.sqrt(t*t+e*e+i*i)},distanceToSquared:function(i){var t=this.x-i.x,e=this.y-i.y;return i=this.z-i.z,t*t+e*e+i*i},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},normalize:function(){var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return i>0?this.multiplyScalar(1/i):this.set(0,0,0),this},setLength:function(i){return this.normalize().multiplyScalar(i)},isZero:function(){return Math.abs(this.x)<1e-4&&Math.abs(this.y)<1e-4&&Math.abs(this.z)<1e-4},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)},toString:function(){return"THREE.Vector3 ( "+this.x+", "+this.y+", "+this.z+" )"}},THREE.Vector4=function(i,t,e,n){this.x=i||0,this.y=t||0,this.z=e||0,this.w=n||1},THREE.Vector4.prototype={set:function(i,t,e,n){return this.x=i,this.y=t,this.z=e,this.w=n,this},copy:function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w||1,this},add:function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this.w=i.w+t.w,this},addSelf:function(i){return this.x+=i.x,this.y+=i.y,this.z+=i.z,this.w+=i.w,this},sub:function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this.w=i.w-t.w,this},subSelf:function(i){return this.x-=i.x,this.y-=i.y,this.z-=i.z,this.w-=i.w,this},multiplyScalar:function(i){return this.x*=i,this.y*=i,this.z*=i,this.w*=i,this},divideScalar:function(i){return this.x/=i,this.y/=i,this.z/=i,this.w/=i,this},lerpSelf:function(i,t){this.x+=(i.x-this.x)*t,this.y+=(i.y-this.y)*t,this.z+=(i.z-this.z)*t,this.w+=(i.w-this.w)*t},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)},toString:function(){return"THREE.Vector4 ("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}},THREE.Ray=function(i,t){this.origin=i||new THREE.Vector3,this.direction=t||new THREE.Vector3},THREE.Ray.prototype={intersectScene:function(i){var t,e,n=i.objects,r=[];for(i=0,t=n.length;i<t;i++)e=n[i],e instanceof THREE.Mesh&&(r=r.concat(this.intersectObject(e)));return r.sort(function(i,t){return i.distance-t.distance}),r},intersectObject:function(i){function t(i,t,e,n){n=n.clone().subSelf(t),e=e.clone().subSelf(t);var r=i.clone().subSelf(t);i=n.dot(n),t=n.dot(e),n=n.dot(r);var o=e.dot(e);return e=e.dot(r),r=1/(i*o-t*t),o=(o*n-t*e)*r,i=(i*e-t*n)*r,o>0&&i>0&&o+i<1}var e,n,r,o,s,a,h,c,l,f,m,u=i.geometry,E=u.vertices,p=[];for(e=0,n=u.faces.length;e<n;e++)r=u.faces[e],f=this.origin.clone(),m=this.direction.clone(),o=i.matrix.transformVector3(E[r.a].position.clone()),s=i.matrix.transformVector3(E[r.b].position.clone()),a=i.matrix.transformVector3(E[r.c].position.clone()),h=r instanceof THREE.Face4?i.matrix.transformVector3(E[r.d].position.clone()):null,c=i.rotationMatrix.transformVector3(r.normal.clone()),l=m.dot(c),l<0&&(c=c.dot((new THREE.Vector3).sub(o,f))/l,f=f.addSelf(m.multiplyScalar(c)),r instanceof THREE.Face3?t(f,o,s,a)&&(r={distance:this.origin.distanceTo(f),point:f,face:r,object:i},p.push(r)):r instanceof THREE.Face4&&(t(f,o,s,h)||t(f,s,a,h))&&(r={distance:this.origin.distanceTo(f),point:f,face:r,object:i},p.push(r)));return p}},THREE.Rectangle=function(){function i(){o=n-t,s=r-e}var t,e,n,r,o,s,a=!0;this.getX=function(){return t},this.getY=function(){return e},this.getWidth=function(){return o},this.getHeight=function(){return s},this.getLeft=function(){return t},this.getTop=function(){return e},this.getRight=function(){return n},this.getBottom=function(){return r},this.set=function(o,s,h,c){a=!1,t=o,e=s,n=h,r=c,i()},this.addPoint=function(o,s){a?(a=!1,t=o,e=s,n=o,r=s):(t=Math.min(t,o),e=Math.min(e,s),n=Math.max(n,o),r=Math.max(r,s)),i()},this.addRectangle=function(o){a?(a=!1,t=o.getLeft(),e=o.getTop(),n=o.getRight(),r=o.getBottom()):(t=Math.min(t,o.getLeft()),e=Math.min(e,o.getTop()),n=Math.max(n,o.getRight()),r=Math.max(r,o.getBottom())),i()},this.inflate=function(o){t-=o,e-=o,n+=o,r+=o,i()},this.minSelf=function(o){t=Math.max(t,o.getLeft()),e=Math.max(e,o.getTop()),n=Math.min(n,o.getRight()),r=Math.min(r,o.getBottom()),i()},this.instersects=function(i){return Math.min(n,i.getRight())-Math.max(t,i.getLeft())>=0&&Math.min(r,i.getBottom())-Math.max(e,i.getTop())>=0},this.empty=function(){a=!0,r=n=e=t=0,i()},this.isEmpty=function(){return a},this.toString=function(){return"THREE.Rectangle ( left: "+t+", right: "+n+", top: "+e+", bottom: "+r+", width: "+o+", height: "+s+" )"}},THREE.Matrix3=function(){this.m=[]},THREE.Matrix3.prototype={transpose:function(){var i;return i=this.m[1],this.m[1]=this.m[3],this.m[3]=i,i=this.m[2],this.m[2]=this.m[6],this.m[6]=i,i=this.m[5],this.m[5]=this.m[7],this.m[7]=i,this}},THREE.Matrix4=function(){},THREE.Matrix4.prototype={n11:1,n12:0,n13:0,n14:0,n21:0,n22:1,n23:0,n24:0,n31:0,n32:0,n33:1,n34:0,n41:0,n42:0,n43:0,n44:1,identity:function(){this.n11=1,this.n21=this.n14=this.n13=this.n12=0,this.n22=1,this.n32=this.n31=this.n24=this.n23=0,this.n33=1,this.n43=this.n42=this.n41=this.n34=0,this.n44=1},copy:function(i){this.n11=i.n11,this.n12=i.n12,this.n13=i.n13,this.n14=i.n14,this.n21=i.n21,this.n22=i.n22,this.n23=i.n23,this.n24=i.n24,this.n31=i.n31,this.n32=i.n32,this.n33=i.n33,this.n34=i.n34,this.n41=i.n41,this.n42=i.n42,this.n43=i.n43,this.n44=i.n44},lookAt:function(i,t,e){var n=new THREE.Vector3,r=new THREE.Vector3,o=new THREE.Vector3;o.sub(i,t).normalize(),n.cross(e,o).normalize(),r.cross(o,n).normalize(),this.n11=n.x,this.n12=n.y,this.n13=n.z,this.n14=-n.dot(i),this.n21=r.x,this.n22=r.y,this.n23=r.z,this.n24=-r.dot(i),this.n31=o.x,this.n32=o.y,this.n33=o.z,this.n34=-o.dot(i),this.n43=this.n42=this.n41=0,this.n44=1},transformVector3:function(i){var t=i.x,e=i.y,n=i.z;return i.x=this.n11*t+this.n12*e+this.n13*n+this.n14,i.y=this.n21*t+this.n22*e+this.n23*n+this.n24,i.z=this.n31*t+this.n32*e+this.n33*n+this.n34,i.multiplyScalar(1/(this.n41*t+this.n42*e+this.n43*n+this.n44)),i},transformVector4:function(i){var t=i.x,e=i.y,n=i.z,r=i.w;return i.x=this.n11*t+this.n12*e+this.n13*n+this.n14*r,i.y=this.n21*t+this.n22*e+this.n23*n+this.n24*r,i.z=this.n31*t+this.n32*e+this.n33*n+this.n34*r,i.w=this.n41*t+this.n42*e+this.n43*n+this.n44*r,i},crossVector:function(i){var t=new THREE.Vector4;return t.x=this.n11*i.x+this.n12*i.y+this.n13*i.z+this.n14*i.w,t.y=this.n21*i.x+this.n22*i.y+this.n23*i.z+this.n24*i.w,t.z=this.n31*i.x+this.n32*i.y+this.n33*i.z+this.n34*i.w,t.w=i.w?this.n41*i.x+this.n42*i.y+this.n43*i.z+this.n44*i.w:1,t},multiply:function(i,t){var e=i.n11,n=i.n12,r=i.n13,o=i.n14,s=i.n21,a=i.n22,h=i.n23,c=i.n24,l=i.n31,f=i.n32,m=i.n33,u=i.n34,E=i.n41,p=i.n42,d=i.n43,g=i.n44,b=t.n11,v=t.n12,R=t.n13,T=t.n14,_=t.n21,y=t.n22,x=t.n23,w=t.n24,M=t.n31,H=t.n32,S=t.n33,L=t.n34,C=t.n41,A=t.n42,P=t.n43,z=t.n44;this.n11=e*b+n*_+r*M+o*C,this.n12=e*v+n*y+r*H+o*A,this.n13=e*R+n*x+r*S+o*P,this.n14=e*T+n*w+r*L+o*z,this.n21=s*b+a*_+h*M+c*C,this.n22=s*v+a*y+h*H+c*A,this.n23=s*R+a*x+h*S+c*P,this.n24=s*T+a*w+h*L+c*z,this.n31=l*b+f*_+m*M+u*C,this.n32=l*v+f*y+m*H+u*A,this.n33=l*R+f*x+m*S+u*P,this.n34=l*T+f*w+m*L+u*z,this.n41=E*b+p*_+d*M+g*C,this.n42=E*v+p*y+d*H+g*A,this.n43=E*R+p*x+d*S+g*P,this.n44=E*T+p*w+d*L+g*z},multiplySelf:function(i){var t=this.n11,e=this.n12,n=this.n13,r=this.n14,o=this.n21,s=this.n22,a=this.n23,h=this.n24,c=this.n31,l=this.n32,f=this.n33,m=this.n34,u=this.n41,E=this.n42,p=this.n43,d=this.n44;this.n11=t*i.n11+e*i.n21+n*i.n31+r*i.n41,this.n12=t*i.n12+e*i.n22+n*i.n32+r*i.n42,this.n13=t*i.n13+e*i.n23+n*i.n33+r*i.n43,this.n14=t*i.n14+e*i.n24+n*i.n34+r*i.n44,this.n21=o*i.n11+s*i.n21+a*i.n31+h*i.n41,this.n22=o*i.n12+s*i.n22+a*i.n32+h*i.n42,this.n23=o*i.n13+s*i.n23+a*i.n33+h*i.n43,this.n24=o*i.n14+s*i.n24+a*i.n34+h*i.n44,this.n31=c*i.n11+l*i.n21+f*i.n31+m*i.n41,this.n32=c*i.n12+l*i.n22+f*i.n32+m*i.n42,this.n33=c*i.n13+l*i.n23+f*i.n33+m*i.n43,this.n34=c*i.n14+l*i.n24+f*i.n34+m*i.n44,this.n41=u*i.n11+E*i.n21+p*i.n31+d*i.n41,this.n42=u*i.n12+E*i.n22+p*i.n32+d*i.n42,this.n43=u*i.n13+E*i.n23+p*i.n33+d*i.n43,this.n44=u*i.n14+E*i.n24+p*i.n34+d*i.n44},multiplyScalar:function(i){this.n11*=i,this.n12*=i,this.n13*=i,this.n14*=i,this.n21*=i,this.n22*=i,this.n23*=i,this.n24*=i,this.n31*=i,this.n32*=i,this.n33*=i,this.n34*=i,this.n41*=i,this.n42*=i,this.n43*=i,this.n44*=i},determinant:function(){return this.n14*this.n23*this.n32*this.n41-this.n13*this.n24*this.n32*this.n41-this.n14*this.n22*this.n33*this.n41+this.n12*this.n24*this.n33*this.n41+this.n13*this.n22*this.n34*this.n41-this.n12*this.n23*this.n34*this.n41-this.n14*this.n23*this.n31*this.n42+this.n13*this.n24*this.n31*this.n42+this.n14*this.n21*this.n33*this.n42-this.n11*this.n24*this.n33*this.n42-this.n13*this.n21*this.n34*this.n42+this.n11*this.n23*this.n34*this.n42+this.n14*this.n22*this.n31*this.n43-this.n12*this.n24*this.n31*this.n43-this.n14*this.n21*this.n32*this.n43+this.n11*this.n24*this.n32*this.n43+this.n12*this.n21*this.n34*this.n43-this.n11*this.n22*this.n34*this.n43-this.n13*this.n22*this.n31*this.n44+this.n12*this.n23*this.n31*this.n44+this.n13*this.n21*this.n32*this.n44-this.n11*this.n23*this.n32*this.n44-this.n12*this.n21*this.n33*this.n44+this.n11*this.n22*this.n33*this.n44},transpose:function(){function i(i,t,e){var n=i[t];i[t]=i[e],i[e]=n}return i(this,"n21","n12"),i(this,"n31","n13"),i(this,"n32","n23"),i(this,"n41","n14"),i(this,"n42","n24"),i(this,"n43","n34"),this},clone:function(){var i=new THREE.Matrix4;return i.n11=this.n11,i.n12=this.n12,i.n13=this.n13,i.n14=this.n14,i.n21=this.n21,i.n22=this.n22,i.n23=this.n23,i.n24=this.n24,i.n31=this.n31,i.n32=this.n32,i.n33=this.n33,i.n34=this.n34,i.n41=this.n41,i.n42=this.n42,i.n43=this.n43,i.n44=this.n44,i},flatten:function(){return[this.n11,this.n21,this.n31,this.n41,this.n12,this.n22,this.n32,this.n42,this.n13,this.n23,this.n33,this.n43,this.n14,this.n24,this.n34,this.n44]},toString:function(){return"| "+this.n11+" "+this.n12+" "+this.n13+" "+this.n14+" |\n| "+this.n21+" "+this.n22+" "+this.n23+" "+this.n24+" |\n| "+this.n31+" "+this.n32+" "+this.n33+" "+this.n34+" |\n| "+this.n41+" "+this.n42+" "+this.n43+" "+this.n44+" |"}},THREE.Matrix4.translationMatrix=function(i,t,e){var n=new THREE.Matrix4;return n.n14=i,n.n24=t,n.n34=e,n},THREE.Matrix4.scaleMatrix=function(i,t,e){var n=new THREE.Matrix4;return n.n11=i,n.n22=t,n.n33=e,n},THREE.Matrix4.rotationXMatrix=function(i){var t=new THREE.Matrix4;return t.n22=t.n33=Math.cos(i),t.n32=Math.sin(i),t.n23=-t.n32,t},THREE.Matrix4.rotationYMatrix=function(i){var t=new THREE.Matrix4;return t.n11=t.n33=Math.cos(i),t.n13=Math.sin(i),t.n31=-t.n13,t},THREE.Matrix4.rotationZMatrix=function(i){var t=new THREE.Matrix4;return t.n11=t.n22=Math.cos(i),t.n21=Math.sin(i),t.n12=-t.n21,t},THREE.Matrix4.rotationAxisAngleMatrix=function(i,t){var e=new THREE.Matrix4,n=Math.cos(t),r=Math.sin(t),o=1-n,s=i.x,a=i.y,h=i.z;return e.n11=o*s*s+n,e.n12=o*s*a-r*h,e.n13=o*s*h+r*a,e.n21=o*s*a+r*h,e.n22=o*a*a+n,e.n23=o*a*h-r*s,e.n31=o*s*h-r*a,e.n32=o*a*h+r*s,e.n33=o*h*h+n,e},THREE.Matrix4.makeInvert=function(i){var t=new THREE.Matrix4;return t.n11=i.n23*i.n34*i.n42-i.n24*i.n33*i.n42+i.n24*i.n32*i.n43-i.n22*i.n34*i.n43-i.n23*i.n32*i.n44+i.n22*i.n33*i.n44,t.n12=i.n14*i.n33*i.n42-i.n13*i.n34*i.n42-i.n14*i.n32*i.n43+i.n12*i.n34*i.n43+i.n13*i.n32*i.n44-i.n12*i.n33*i.n44,t.n13=i.n13*i.n24*i.n42-i.n14*i.n23*i.n42+i.n14*i.n22*i.n43-i.n12*i.n24*i.n43-i.n13*i.n22*i.n44+i.n12*i.n23*i.n44,t.n14=i.n14*i.n23*i.n32-i.n13*i.n24*i.n32-i.n14*i.n22*i.n33+i.n12*i.n24*i.n33+i.n13*i.n22*i.n34-i.n12*i.n23*i.n34,t.n21=i.n24*i.n33*i.n41-i.n23*i.n34*i.n41-i.n24*i.n31*i.n43+i.n21*i.n34*i.n43+i.n23*i.n31*i.n44-i.n21*i.n33*i.n44,t.n22=i.n13*i.n34*i.n41-i.n14*i.n33*i.n41+i.n14*i.n31*i.n43-i.n11*i.n34*i.n43-i.n13*i.n31*i.n44+i.n11*i.n33*i.n44,t.n23=i.n14*i.n23*i.n41-i.n13*i.n24*i.n41-i.n14*i.n21*i.n43+i.n11*i.n24*i.n43+i.n13*i.n21*i.n44-i.n11*i.n23*i.n44,t.n24=i.n13*i.n24*i.n31-i.n14*i.n23*i.n31+i.n14*i.n21*i.n33-i.n11*i.n24*i.n33-i.n13*i.n21*i.n34+i.n11*i.n23*i.n34,t.n31=i.n22*i.n34*i.n41-i.n24*i.n32*i.n41+i.n24*i.n31*i.n42-i.n21*i.n34*i.n42-i.n22*i.n31*i.n44+i.n21*i.n32*i.n44,t.n32=i.n14*i.n32*i.n41-i.n12*i.n34*i.n41-i.n14*i.n31*i.n42+i.n11*i.n34*i.n42+i.n12*i.n31*i.n44-i.n11*i.n32*i.n44,t.n33=i.n13*i.n24*i.n41-i.n14*i.n22*i.n41+i.n14*i.n21*i.n42-i.n11*i.n24*i.n42-i.n12*i.n21*i.n44+i.n11*i.n22*i.n44,t.n34=i.n14*i.n22*i.n31-i.n12*i.n24*i.n31-i.n14*i.n21*i.n32+i.n11*i.n24*i.n32+i.n12*i.n21*i.n34-i.n11*i.n22*i.n34,t.n41=i.n23*i.n32*i.n41-i.n22*i.n33*i.n41-i.n23*i.n31*i.n42+i.n21*i.n33*i.n42+i.n22*i.n31*i.n43-i.n21*i.n32*i.n43,t.n42=i.n12*i.n33*i.n41-i.n13*i.n32*i.n41+i.n13*i.n31*i.n42-i.n11*i.n33*i.n42-i.n12*i.n31*i.n43+i.n11*i.n32*i.n43,t.n43=i.n13*i.n22*i.n41-i.n12*i.n23*i.n41-i.n13*i.n21*i.n42+i.n11*i.n23*i.n42+i.n12*i.n21*i.n43-i.n11*i.n22*i.n43,t.n44=i.n12*i.n23*i.n31-i.n13*i.n22*i.n31+i.n13*i.n21*i.n32-i.n11*i.n23*i.n32-i.n12*i.n21*i.n33+i.n11*i.n22*i.n33,t.multiplyScalar(1/i.determinant()),t},THREE.Matrix4.makeInvert3x3=function(i){var t=i.flatten();i=new THREE.Matrix3;var e=t[10]*t[5]-t[6]*t[9],n=-t[10]*t[1]+t[2]*t[9],r=t[6]*t[1]-t[2]*t[5],o=-t[10]*t[4]+t[6]*t[8],s=t[10]*t[0]-t[2]*t[8],a=-t[6]*t[0]+t[2]*t[4],h=t[9]*t[4]-t[5]*t[8],c=-t[9]*t[0]+t[1]*t[8],l=t[5]*t[0]-t[1]*t[4];if(t=t[0]*e+t[1]*o+t[2]*h,0==t)throw"matrix not invertible";return t=1/t,i.m[0]=t*e,i.m[1]=t*n,i.m[2]=t*r,i.m[3]=t*o,i.m[4]=t*s,i.m[5]=t*a,i.m[6]=t*h,i.m[7]=t*c,i.m[8]=t*l,i},THREE.Matrix4.makeFrustum=function(i,t,e,n,r,o){var s,a,h;return s=new THREE.Matrix4,a=2*r/(t-i),h=2*r/(n-e),i=(t+i)/(t-i),e=(n+e)/(n-e),n=-(o+r)/(o-r),r=-2*o*r/(o-r),s.n11=a,s.n12=0,s.n13=i,s.n14=0,s.n21=0,s.n22=h,s.n23=e,s.n24=0,s.n31=0,s.n32=0,s.n33=n,s.n34=r,s.n41=0,s.n42=0,s.n43=-1,s.n44=0,s},THREE.Matrix4.makePerspective=function(i,t,e,n){var r;return i=e*Math.tan(i*Math.PI/360),r=-i,THREE.Matrix4.makeFrustum(r*t,i*t,r,i,e,n)},THREE.Matrix4.makeOrtho=function(i,t,e,n,r,o){var s,a,h,c;return s=new THREE.Matrix4,a=t-i,h=e-n,c=o-r,i=(t+i)/a,e=(e+n)/h,r=(o+r)/c,s.n11=2/a,s.n12=0,s.n13=0,s.n14=-i,s.n21=0,s.n22=2/h,s.n23=0,s.n24=-e,s.n31=0,s.n32=0,s.n33=-2/c,s.n34=-r,s.n41=0,s.n42=0,s.n43=0,s.n44=1,s},THREE.Vertex=function(i,t){this.position=i||new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.normal=t||new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.normalScreen=new THREE.Vector3,this.__visible=!0},THREE.Vertex.prototype={toString:function(){return"THREE.Vertex ( position: "+this.position+", normal: "+this.normal+" )"}},THREE.Face3=function(i,t,e,n,r){this.a=i,this.b=t,this.c=e,this.centroid=new THREE.Vector3,this.normal=n instanceof THREE.Vector3?n:new THREE.Vector3,this.vertexNormals=n instanceof Array?n:[],this.material=r instanceof Array?r:[r]},THREE.Face3.prototype={toString:function(){return"THREE.Face3 ( "+this.a+", "+this.b+", "+this.c+" )"}},THREE.Face4=function(i,t,e,n,r,o){this.a=i,this.b=t,this.c=e,this.d=n,this.centroid=new THREE.Vector3,this.normal=r instanceof THREE.Vector3?r:new THREE.Vector3,this.vertexNormals=r instanceof Array?r:[],this.material=o instanceof Array?o:[o]},THREE.Face4.prototype={toString:function(){return"THREE.Face4 ( "+this.a+", "+this.b+", "+this.c+" "+this.d+" )"}},THREE.UV=function(i,t){this.u=i||0,this.v=t||0},THREE.UV.prototype={copy:function(i){this.u=i.u,this.v=i.v},toString:function(){return"THREE.UV ("+this.u+", "+this.v+")"}},THREE.Geometry=function(){this.vertices=[],this.faces=[],this.uvs=[]},THREE.Geometry.prototype={computeCentroids:function(){var i,t,e;for(i=0,t=this.faces.length;i<t;i++)e=this.faces[i],e.centroid.set(0,0,0),e.centroid.addSelf(this.vertices[e.a].position),e.centroid.addSelf(this.vertices[e.b].position),e.centroid.addSelf(this.vertices[e.c].position),e instanceof THREE.Face3?e.centroid.divideScalar(3):e instanceof THREE.Face4&&(e.centroid.addSelf(this.vertices[e.d].position),e.centroid.divideScalar(4))},computeNormals:function(i){var t,e,n,r,o,s,a=new THREE.Vector3,h=new THREE.Vector3;for(n=0,r=this.vertices.length;n<r;n++)o=this.vertices[n],o.normal.set(0,0,0);for(n=0,r=this.faces.length;n<r;n++){if(o=this.faces[n],i&&o.vertexNormals.length){for(a.set(0,0,0),t=0,e=o.normal.length;t<e;t++)a.addSelf(o.vertexNormals[t]);a.divideScalar(3)}else t=this.vertices[o.a],e=this.vertices[o.b],s=this.vertices[o.c],a.sub(s.position,e.position),h.sub(t.position,e.position),a.crossSelf(h);a.isZero()||a.normalize(),o.normal.copy(a)}},computeBoundingBox:function(){if(this.vertices.length>0){this.bbox={x:[this.vertices[0].position.x,this.vertices[0].position.x],y:[this.vertices[0].position.y,this.vertices[0].position.y],z:[this.vertices[0].position.z,this.vertices[0].position.z]};for(var i=1,t=this.vertices.length;i<t;i++)vertex=this.vertices[i],vertex.position.x<this.bbox.x[0]?this.bbox.x[0]=vertex.position.x:vertex.position.x>this.bbox.x[1]&&(this.bbox.x[1]=vertex.position.x),vertex.position.y<this.bbox.y[0]?this.bbox.y[0]=vertex.position.y:vertex.position.y>this.bbox.y[1]&&(this.bbox.y[1]=vertex.position.y),vertex.position.z<this.bbox.z[0]?this.bbox.z[0]=vertex.position.z:vertex.position.z>this.bbox.z[1]&&(this.bbox.z[1]=vertex.position.z)}},toString:function(){return"THREE.Geometry ( vertices: "+this.vertices+", faces: "+this.faces+" )"}},THREE.Camera=function(i,t,e,n){this.position=new THREE.Vector3(0,0,0),this.target={position:new THREE.Vector3(0,0,0)},this.up=new THREE.Vector3(0,1,0),this.matrix=new THREE.Matrix4,this.projectionMatrix=THREE.Matrix4.makePerspective(i,t,e,n),this.autoUpdateMatrix=!0,this.updateMatrix=function(){this.matrix.lookAt(this.position,this.target.position,this.up)},this.toString=function(){return"THREE.Camera ( "+this.position+", "+this.target.position+" )"}},THREE.Light=function(i){this.color=new THREE.Color(i)},THREE.AmbientLight=function(i){THREE.Light.call(this,i)},THREE.AmbientLight.prototype=new THREE.Light,THREE.AmbientLight.prototype.constructor=THREE.AmbientLight,THREE.DirectionalLight=function(i,t){THREE.Light.call(this,i),this.position=new THREE.Vector3(0,1,0),this.intensity=t||1},THREE.DirectionalLight.prototype=new THREE.Light,THREE.DirectionalLight.prototype.constructor=THREE.DirectionalLight,THREE.PointLight=function(i,t){THREE.Light.call(this,i),this.position=new THREE.Vector3,this.intensity=t||1},THREE.DirectionalLight.prototype=new THREE.Light,THREE.DirectionalLight.prototype.constructor=THREE.PointLight,THREE.Object3D=function(){this.position=new THREE.Vector3,this.rotation=new THREE.Vector3,this.scale=new THREE.Vector3(1,1,1),this.matrix=new THREE.Matrix4,this.translationMatrix=new THREE.Matrix4,this.rotationMatrix=new THREE.Matrix4,this.scaleMatrix=new THREE.Matrix4,this.screen=new THREE.Vector3,this.autoUpdateMatrix=this.visible=!0,this.updateMatrix=function(){this.matrixPosition=THREE.Matrix4.translationMatrix(this.position.x,this.position.y,this.position.z),this.rotationMatrix=THREE.Matrix4.rotationXMatrix(this.rotation.x),this.rotationMatrix.multiplySelf(THREE.Matrix4.rotationYMatrix(this.rotation.y)),this.rotationMatrix.multiplySelf(THREE.Matrix4.rotationZMatrix(this.rotation.z)),this.scaleMatrix=THREE.Matrix4.scaleMatrix(this.scale.x,this.scale.y,this.scale.z),this.matrix.copy(this.matrixPosition),this.matrix.multiplySelf(this.rotationMatrix),this.matrix.multiplySelf(this.scaleMatrix)}},THREE.Particle=function(i){THREE.Object3D.call(this),this.material=i instanceof Array?i:[i],this.autoUpdateMatrix=!1},THREE.Particle.prototype=new THREE.Object3D,THREE.Particle.prototype.constructor=THREE.Particle,THREE.Line=function(i,t){THREE.Object3D.call(this),this.geometry=i,this.material=t instanceof Array?t:[t]},THREE.Line.prototype=new THREE.Object3D,THREE.Line.prototype.constructor=THREE.Line,THREE.Mesh=function(i,t,e){THREE.Object3D.call(this),this.geometry=i,this.material=t instanceof Array?t:[t],this.overdraw=this.doubleSided=this.flipSided=!1,this.materialFaceGroup={},this.sortFacesByMaterial(),e&&this.normalizeUVs(),this.geometry.computeBoundingBox()},THREE.Mesh.prototype=new THREE.Object3D,THREE.Mesh.prototype.constructor=THREE.Mesh,THREE.Mesh.prototype.sortFacesByMaterial=function(){function i(i){var n=[];for(t=0,e=i.length;t<e;t++)void 0==i[t]?n.push("undefined"):n.push(i[t].toString());return n.join("_")}var t,e,n,r,o,s,a,h,c={};for(n=0,r=this.geometry.faces.length;n<r;n++)o=this.geometry.faces[n],s=o.material,a=i(s),void 0==c[a]&&(c[a]={hash:a,counter:0}),h=c[a].hash+"_"+c[a].counter,void 0==this.materialFaceGroup[h]&&(this.materialFaceGroup[h]={faces:[],material:s,vertices:0}),o=o instanceof THREE.Face3?3:4,this.materialFaceGroup[h].vertices+o>65535&&(c[a].counter+=1,h=c[a].hash+"_"+c[a].counter,void 0==this.materialFaceGroup[h]&&(this.materialFaceGroup[h]={faces:[],material:s,vertices:0})),this.materialFaceGroup[h].faces.push(n),this.materialFaceGroup[h].vertices+=o},THREE.Mesh.prototype.normalizeUVs=function(){var i,t,e,n,r;for(i=0,t=this.geometry.uvs.length;i<t;i++)for(r=this.geometry.uvs[i],e=0,n=r.length;e<n;e++)1!=r[e].u&&(r[e].u-=Math.floor(r[e].u)),1!=r[e].v&&(r[e].v-=Math.floor(r[e].v))},THREE.FlatShading=0,THREE.SmoothShading=1,THREE.NormalBlending=0,THREE.AdditiveBlending=1,THREE.SubtractiveBlending=2,THREE.LineBasicMaterial=function(i){this.color=new THREE.Color(16711680),this.opacity=1,this.blending=THREE.NormalBlending,this.linewidth=1,this.linejoin=this.linecap="round",i&&(void 0!==i.color&&this.color.setHex(i.color),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.blending&&(this.blending=i.blending),void 0!==i.linewidth&&(this.linewidth=i.linewidth),void 0!==i.linecap&&(this.linecap=i.linecap),void 0!==i.linejoin&&(this.linejoin=i.linejoin)),this.toString=function(){return"THREE.LineBasicMaterial (<br/>color: "+this.color+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>linewidth: "+this.linewidth+"<br/>linecap: "+this.linecap+"<br/>linejoin: "+this.linejoin+"<br/>)"}},THREE.MeshBasicMaterial=function(i){this.id=THREE.MeshBasicMaterialCounter.value++,this.color=new THREE.Color(15658734),this.env_map=this.map=null,this.combine=THREE.Multiply,this.reflectivity=1,this.refraction_ratio=.98,this.opacity=1,this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",i&&(void 0!==i.color&&this.color.setHex(i.color),void 0!==i.map&&(this.map=i.map),void 0!==i.env_map&&(this.env_map=i.env_map),void 0!==i.combine&&(this.combine=i.combine),void 0!==i.reflectivity&&(this.reflectivity=i.reflectivity),void 0!==i.refraction_ratio&&(this.refraction_ratio=i.refraction_ratio),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.shading&&(this.shading=i.shading),void 0!==i.blending&&(this.blending=i.blending),void 0!==i.wireframe&&(this.wireframe=i.wireframe),void 0!==i.wireframe_linewidth&&(this.wireframe_linewidth=i.wireframe_linewidth),void 0!==i.wireframe_linecap&&(this.wireframe_linecap=i.wireframe_linecap),void 0!==i.wireframe_linejoin&&(this.wireframe_linejoin=i.wireframe_linejoin)),this.toString=function(){return"THREE.MeshBasicMaterial (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>map: "+this.map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>reflectivity: "+this.reflectivity+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/>)"}},THREE.MeshBasicMaterialCounter={value:0},THREE.MeshLambertMaterial=function(i){this.id=THREE.MeshLambertMaterialCounter.value++,this.color=new THREE.Color(15658734),this.env_map=this.map=null,this.combine=THREE.Multiply,this.reflectivity=1,this.refraction_ratio=.98,this.opacity=1,this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",i&&(void 0!==i.color&&this.color.setHex(i.color),void 0!==i.map&&(this.map=i.map),void 0!==i.env_map&&(this.env_map=i.env_map),void 0!==i.combine&&(this.combine=i.combine),void 0!==i.reflectivity&&(this.reflectivity=i.reflectivity),void 0!==i.refraction_ratio&&(this.refraction_ratio=i.refraction_ratio),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.shading&&(this.shading=i.shading),void 0!==i.blending&&(this.blending=i.blending),void 0!==i.wireframe&&(this.wireframe=i.wireframe),void 0!==i.wireframe_linewidth&&(this.wireframe_linewidth=i.wireframe_linewidth),void 0!==i.wireframe_linecap&&(this.wireframe_linecap=i.wireframe_linecap),void 0!==i.wireframe_linejoin&&(this.wireframe_linejoin=i.wireframe_linejoin)),this.toString=function(){return"THREE.MeshLambertMaterial (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>map: "+this.map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>reflectivity: "+this.reflectivity+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>opacity: "+this.opacity+"<br/>shading: "+this.shading+"<br/>blending: "+this.blending+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/> )"}},THREE.MeshLambertMaterialCounter={value:0},THREE.MeshPhongMaterial=function(i){this.id=THREE.MeshPhongMaterialCounter.value++,this.color=new THREE.Color(15658734),this.ambient=new THREE.Color(328965),this.specular=new THREE.Color(1118481),this.shininess=30,this.env_map=this.specular_map=this.map=null,this.combine=THREE.Multiply,this.reflectivity=1,this.refraction_ratio=.98,this.opacity=1,this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",i&&(void 0!==i.color&&(this.color=new THREE.Color(i.color)),void 0!==i.ambient&&(this.ambient=new THREE.Color(i.ambient)),void 0!==i.specular&&(this.specular=new THREE.Color(i.specular)),void 0!==i.shininess&&(this.shininess=i.shininess),void 0!==i.map&&(this.map=i.map),void 0!==i.specular_map&&(this.specular_map=i.specular_map),void 0!==i.env_map&&(this.env_map=i.env_map),void 0!==i.combine&&(this.combine=i.combine),void 0!==i.reflectivity&&(this.reflectivity=i.reflectivity),void 0!==i.refraction_ratio&&(this.refraction_ratio=i.refraction_ratio),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.shading&&(this.shading=i.shading),void 0!==i.blending&&(this.blending=i.blending),void 0!==i.wireframe&&(this.wireframe=i.wireframe),void 0!==i.wireframe_linewidth&&(this.wireframe_linewidth=i.wireframe_linewidth),void 0!==i.wireframe_linecap&&(this.wireframe_linecap=i.wireframe_linecap),void 0!==i.wireframe_linejoin&&(this.wireframe_linejoin=i.wireframe_linejoin)),this.toString=function(){return"THREE.MeshPhongMaterial (<br/>id: "+this.id+"<br/>color: "+this.color+"<br/>ambient: "+this.ambient+"<br/>specular: "+this.specular+"<br/>shininess: "+this.shininess+"<br/>map: "+this.map+"<br/>specular_map: "+this.specular_map+"<br/>env_map: "+this.env_map+"<br/>combine: "+this.combine+"<br/>reflectivity: "+this.reflectivity+"<br/>refraction_ratio: "+this.refraction_ratio+"<br/>opacity: "+this.opacity+"<br/>shading: "+this.shading+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/>NaN"}},THREE.MeshPhongMaterialCounter={value:0},THREE.MeshDepthMaterial=function(i){this.near=1,this.far=1e3,this.opacity=1,this.blending=THREE.NormalBlending,i&&(void 0!==i.near&&(this.near=i.near),void 0!==i.far&&(this.far=i.far),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.blending&&(this.blending=i.blending)),this.__2near=2*this.near,this.__farPlusNear=this.far+this.near,this.__farMinusNear=this.far-this.near,this.toString=function(){return"THREE.MeshDepthMaterial"}},THREE.MeshNormalMaterial=function(i){this.opacity=1,this.shading=THREE.FlatShading,this.blending=THREE.NormalBlending,i&&(void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.shading&&(this.shading=i.shading),void 0!==i.blending&&(this.blending=i.blending)),this.toString=function(){return"THREE.MeshNormalMaterial"}},THREE.MeshFaceMaterial=function(){this.toString=function(){return"THREE.MeshFaceMaterial"}},THREE.MeshCubeMaterial=function(i){this.id=THREE.MeshCubeMaterial.value++,this.env_map=null,this.blending=THREE.NormalBlending,i&&void 0!==i.env_map&&(this.env_map=i.env_map),this.toString=function(){return"THREE.MeshCubeMaterial( id: "+this.id+"<br/>env_map: "+this.env_map+" )"}},THREE.MeshCubeMaterialCounter={value:0},THREE.MeshShaderMaterial=function(i){this.id=THREE.MeshShaderMaterialCounter.value++,this.vertex_shader=this.fragment_shader="void main() {}",this.uniforms={},this.shading=THREE.SmoothShading,this.blending=THREE.NormalBlending,this.wireframe=!1,this.wireframe_linewidth=1,this.wireframe_linejoin=this.wireframe_linecap="round",i&&(void 0!==i.fragment_shader&&(this.fragment_shader=i.fragment_shader),void 0!==i.vertex_shader&&(this.vertex_shader=i.vertex_shader),void 0!==i.uniforms&&(this.uniforms=i.uniforms),void 0!==i.shading&&(this.shading=i.shading),void 0!==i.blending&&(this.blending=i.blending),void 0!==i.wireframe&&(this.wireframe=i.wireframe),void 0!==i.wireframe_linewidth&&(this.wireframe_linewidth=i.wireframe_linewidth),
void 0!==i.wireframe_linecap&&(this.wireframe_linecap=i.wireframe_linecap),void 0!==i.wireframe_linejoin&&(this.wireframe_linejoin=i.wireframe_linejoin)),this.toString=function(){return"THREE.MeshShaderMaterial (<br/>id: "+this.id+"<br/>blending: "+this.blending+"<br/>wireframe: "+this.wireframe+"<br/>wireframe_linewidth: "+this.wireframe_linewidth+"<br/>wireframe_linecap: "+this.wireframe_linecap+"<br/>wireframe_linejoin: "+this.wireframe_linejoin+"<br/>)"}},THREE.MeshShaderMaterialCounter={value:0},THREE.ParticleBasicMaterial=function(i){this.color=new THREE.Color(16711680),this.map=null,this.opacity=1,this.blending=THREE.NormalBlending,this.offset=new THREE.Vector2,i&&(void 0!==i.color&&this.color.setHex(i.color),void 0!==i.map&&(this.map=i.map),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.blending&&(this.blending=i.blending)),this.toString=function(){return"THREE.ParticleBasicMaterial (<br/>color: "+this.color+"<br/>map: "+this.map+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>)"}},THREE.ParticleCircleMaterial=function(i){this.color=new THREE.Color(16711680),this.opacity=1,this.blending=THREE.NormalBlending,i&&(void 0!==i.color&&this.color.setHex(i.color),void 0!==i.opacity&&(this.opacity=i.opacity),void 0!==i.blending&&(this.blending=i.blending)),this.toString=function(){return"THREE.ParticleCircleMaterial (<br/>color: "+this.color+"<br/>opacity: "+this.opacity+"<br/>blending: "+this.blending+"<br/>)"}},THREE.ParticleDOMMaterial=function(i){this.domElement=i,this.toString=function(){return"THREE.ParticleDOMMaterial ( domElement: "+this.domElement+" )"}},THREE.Texture=function(i,t,e,n){this.image=i,this.loaded=!1,this.mapping=void 0!==t?t:THREE.UVMapping,this.wrap_s=void 0!==e?e:THREE.ClampToEdge,this.wrap_t=void 0!==n?n:THREE.ClampToEdge,this.toString=function(){return"THREE.Texture (<br/>image: "+this.image+"<br/>wrap_s: "+this.wrap_s+"<br/>wrap_t: "+this.wrap_t+"<br/>)"}},THREE.UVMapping=0,THREE.ReflectionMapping=1,THREE.RefractionMapping=2,THREE.Multiply=0,THREE.Mix=1,THREE.Repeat=0,THREE.ClampToEdge=1,THREE.MirroredRepeat=2,THREE.TextureCube=function(i,t){this.image=i,this.mapping=t?t:THREE.ReflectionMap,this.toString=function(){return"THREE.TextureCube (<br/>image: "+this.image+"<br/>mapping: "+this.mapping+"<br/>)"}},THREE.Scene=function(){this.objects=[],this.lights=[],this.addObject=function(i){this.objects.push(i)},this.removeObject=function(i){i=this.objects.indexOf(i),i!==-1&&this.objects.splice(i,1)},this.addLight=function(i){this.lights.push(i)},this.removeLight=function(i){i=this.lights.indexOf(i),i!==-1&&this.lights.splice(i,1)},this.toString=function(){return"THREE.Scene ( "+this.objects+" )"}},THREE.Projector=function(){function i(i,t){var e=0,n=1,r=i.z+i.w,o=t.z+t.w,s=-i.z+i.w,a=-t.z+t.w;return r>=0&&o>=0&&s>=0&&a>=0||!(r<0&&o<0||s<0&&a<0)&&(r<0?e=Math.max(e,r/(r-o)):o<0&&(n=Math.min(n,r/(r-o))),s<0?e=Math.max(e,s/(s-a)):a<0&&(n=Math.min(n,s/(s-a))),!(n<e)&&(i.lerpSelf(t,e),t.lerpSelf(i,1-n),!0))}var t,e,n,r,o,s,a,h,c=null,l=[],f=[],m=[],u=new THREE.Vector4,E=new THREE.Matrix4,p=new THREE.Matrix4,d=new THREE.Vector4,g=new THREE.Vector4;this.projectScene=function(b,v){var R,T,_,y,x,w,M,H,S,L,C,A,P,z,B,N,F;for(c=[],n=o=a=0,v.autoUpdateMatrix&&v.updateMatrix(),E.multiply(v.projectionMatrix,v.matrix),M=b.objects,R=0,T=M.length;R<T;R++)if(H=M[R],H.autoUpdateMatrix&&H.updateMatrix(),S=H.matrix,L=H.rotationMatrix,C=H.material,A=H.overdraw,H instanceof THREE.Mesh){for(P=H.geometry.vertices,_=0,y=P.length;_<y;_++)z=P[_],z.positionWorld.copy(z.position),S.transformVector3(z.positionWorld),B=z.positionScreen,B.copy(z.positionWorld),E.transformVector4(B),B.multiplyScalar(1/B.w),z.__visible=B.z>0&&B.z<1;for(z=H.geometry.faces,_=0,y=z.length;_<y;_++)if(B=z[_],B instanceof THREE.Face3){if(x=P[B.a],w=P[B.b],N=P[B.c],x.__visible&&w.__visible&&N.__visible&&(H.doubleSided||H.flipSided!=(N.positionScreen.x-x.positionScreen.x)*(w.positionScreen.y-x.positionScreen.y)-(N.positionScreen.y-x.positionScreen.y)*(w.positionScreen.x-x.positionScreen.x)<0)){for(t=l[n]=l[n]||new THREE.RenderableFace3,t.v1.positionWorld.copy(x.positionWorld),t.v2.positionWorld.copy(w.positionWorld),t.v3.positionWorld.copy(N.positionWorld),t.v1.positionScreen.copy(x.positionScreen),t.v2.positionScreen.copy(w.positionScreen),t.v3.positionScreen.copy(N.positionScreen),t.normalWorld.copy(B.normal),L.transformVector3(t.normalWorld),t.centroidWorld.copy(B.centroid),S.transformVector3(t.centroidWorld),t.centroidScreen.copy(t.centroidWorld),E.transformVector3(t.centroidScreen),N=B.vertexNormals,h=t.vertexNormalsWorld,x=0,w=N.length;x<w;x++)F=h[x]=h[x]||new THREE.Vector3,F.copy(N[x]),L.transformVector3(F);t.z=t.centroidScreen.z,t.meshMaterial=C,t.faceMaterial=B.material,t.overdraw=A,H.geometry.uvs[_]&&(t.uvs[0]=H.geometry.uvs[_][0],t.uvs[1]=H.geometry.uvs[_][1],t.uvs[2]=H.geometry.uvs[_][2]),c.push(t),n++}}else B instanceof THREE.Face4&&(x=P[B.a],w=P[B.b],N=P[B.c],F=P[B.d],x.__visible&&w.__visible&&N.__visible&&F.__visible&&(H.doubleSided||H.flipSided!=((F.positionScreen.x-x.positionScreen.x)*(w.positionScreen.y-x.positionScreen.y)-(F.positionScreen.y-x.positionScreen.y)*(w.positionScreen.x-x.positionScreen.x)<0||(w.positionScreen.x-N.positionScreen.x)*(F.positionScreen.y-N.positionScreen.y)-(w.positionScreen.y-N.positionScreen.y)*(F.positionScreen.x-N.positionScreen.x)<0))&&(t=l[n]=l[n]||new THREE.RenderableFace3,t.v1.positionWorld.copy(x.positionWorld),t.v2.positionWorld.copy(w.positionWorld),t.v3.positionWorld.copy(F.positionWorld),t.v1.positionScreen.copy(x.positionScreen),t.v2.positionScreen.copy(w.positionScreen),t.v3.positionScreen.copy(F.positionScreen),t.normalWorld.copy(B.normal),L.transformVector3(t.normalWorld),t.centroidWorld.copy(B.centroid),S.transformVector3(t.centroidWorld),t.centroidScreen.copy(t.centroidWorld),E.transformVector3(t.centroidScreen),t.z=t.centroidScreen.z,t.meshMaterial=C,t.faceMaterial=B.material,t.overdraw=A,H.geometry.uvs[_]&&(t.uvs[0]=H.geometry.uvs[_][0],t.uvs[1]=H.geometry.uvs[_][1],t.uvs[2]=H.geometry.uvs[_][3]),c.push(t),n++,e=l[n]=l[n]||new THREE.RenderableFace3,e.v1.positionWorld.copy(w.positionWorld),e.v2.positionWorld.copy(N.positionWorld),e.v3.positionWorld.copy(F.positionWorld),e.v1.positionScreen.copy(w.positionScreen),e.v2.positionScreen.copy(N.positionScreen),e.v3.positionScreen.copy(F.positionScreen),e.normalWorld.copy(t.normalWorld),e.centroidWorld.copy(t.centroidWorld),e.centroidScreen.copy(t.centroidScreen),e.z=e.centroidScreen.z,e.meshMaterial=C,e.faceMaterial=B.material,e.overdraw=A,H.geometry.uvs[_]&&(e.uvs[0]=H.geometry.uvs[_][1],e.uvs[1]=H.geometry.uvs[_][2],e.uvs[2]=H.geometry.uvs[_][3]),c.push(e),n++))}else if(H instanceof THREE.Line)for(p.multiply(E,S),P=H.geometry.vertices,z=P[0],z.positionScreen.copy(z.position),p.transformVector4(z.positionScreen),_=1,y=P.length;_<y;_++)x=P[_],x.positionScreen.copy(x.position),p.transformVector4(x.positionScreen),w=P[_-1],d.copy(x.positionScreen),g.copy(w.positionScreen),i(d,g)&&(d.multiplyScalar(1/d.w),g.multiplyScalar(1/g.w),r=f[o]=f[o]||new THREE.RenderableLine,r.v1.positionScreen.copy(d),r.v2.positionScreen.copy(g),r.z=Math.max(d.z,g.z),r.material=H.material,c.push(r),o++);else H instanceof THREE.Particle&&(u.set(H.position.x,H.position.y,H.position.z,1),E.transformVector4(u),u.z/=u.w,u.z>0&&u.z<1&&(s=m[a]=m[a]||new THREE.RenderableParticle,s.x=u.x/u.w,s.y=u.y/u.w,s.z=u.z,s.rotation=H.rotation.z,s.scale.x=H.scale.x*Math.abs(s.x-(u.x+v.projectionMatrix.n11)/(u.w+v.projectionMatrix.n14)),s.scale.y=H.scale.y*Math.abs(s.y-(u.y+v.projectionMatrix.n22)/(u.w+v.projectionMatrix.n24)),s.material=H.material,c.push(s),a++));return c.sort(function(i,t){return t.z-i.z}),c},this.unprojectVector=function(i,t){var e=new THREE.Matrix4;return e.multiply(THREE.Matrix4.makeInvert(t.matrix),THREE.Matrix4.makeInvert(t.projectionMatrix)),e.transformVector3(i),i}},THREE.DOMRenderer=function(){THREE.Renderer.call(this);var i,t,e,n,r=null,o=new THREE.Projector;this.domElement=document.createElement("div"),this.setSize=function(r,o){i=r,t=o,e=i/2,n=t/2},this.render=function(i,t){var s,a,h,c,l,f,m,u;for(r=o.projectScene(i,t),s=0,a=r.length;s<a;s++)if(l=r[s],l instanceof THREE.RenderableParticle)for(m=l.x*e+e,u=l.y*n+n,h=0,c=l.material.length;h<c;h++)f=l.material[h],f instanceof THREE.ParticleDOMMaterial&&(f=f.domElement,f.style.left=m+"px",f.style.top=u+"px")}},THREE.CanvasRenderer=function(){function i(i,t,e,n){var r,o,s,a,h=i.lights;for(i=0,r=h.length;i<r;i++)o=h[i],s=o.color,a=o.intensity,o instanceof THREE.DirectionalLight?(o=e.dot(o.position)*a,o>0&&(n.r+=s.r*o,n.g+=s.g*o,n.b+=s.b*o)):o instanceof THREE.PointLight&&(ri.sub(o.position,t),ri.normalize(),o=e.dot(ri)*a,o>0&&(n.r+=s.r*o,n.g+=s.g*o,n.b+=s.b*o))}function t(t,c,l,f,m,u){if(0!=m.opacity){o(m.opacity),s(m.blending),g=t.positionScreen.x,b=t.positionScreen.y,v=c.positionScreen.x,R=c.positionScreen.y,T=l.positionScreen.x,_=l.positionScreen.y;var E=g,p=b,d=v,H=R,S=T,L=_;F.beginPath(),F.moveTo(E,p),F.lineTo(d,H),F.lineTo(S,L),F.lineTo(E,p),F.closePath(),m instanceof THREE.MeshBasicMaterial?m.map?r(g,b,v,R,T,_,m.map.image,f.uvs[0].u,f.uvs[0].v,f.uvs[1].u,f.uvs[1].v,f.uvs[2].u,f.uvs[2].v):m.wireframe?e(m.color.__styleString,m.wireframe_linewidth):n(m.color.__styleString):m instanceof THREE.MeshLambertMaterial?(m.map&&!m.wireframe&&(r(g,b,v,R,T,_,m.map.image,f.uvs[0].u,f.uvs[0].v,f.uvs[1].u,f.uvs[1].v,f.uvs[2].u,f.uvs[2].v),s(THREE.SubtractiveBlending)),J?m.wireframe||m.shading!=THREE.SmoothShading||3!=f.vertexNormalsWorld.length?($.r=ii.r,$.g=ii.g,$.b=ii.b,i(u,f.centroidWorld,f.normalWorld,$),O.r=m.color.r*$.r,O.g=m.color.g*$.g,O.b=m.color.b*$.b,O.updateStyleString(),m.wireframe?e(O.__styleString,m.wireframe_linewidth):n(O.__styleString)):(X.r=k.r=Y.r=ii.r,X.g=k.g=Y.g=ii.g,X.b=k.b=Y.b=ii.b,i(u,f.v1.positionWorld,f.vertexNormalsWorld[0],X),i(u,f.v2.positionWorld,f.vertexNormalsWorld[1],k),i(u,f.v3.positionWorld,f.vertexNormalsWorld[2],Y),q.r=.5*(k.r+Y.r),q.g=.5*(k.g+Y.g),q.b=.5*(k.b+Y.b),M=a(X,k,Y,q),r(g,b,v,R,T,_,M,0,0,1,0,0,1)):m.wireframe?e(m.color.__styleString,m.wireframe_linewidth):n(m.color.__styleString)):m instanceof THREE.MeshDepthMaterial?(y=m.__2near,x=m.__farPlusNear,w=m.__farMinusNear,X.r=X.g=X.b=1-y/(x-t.positionScreen.z*w),k.r=k.g=k.b=1-y/(x-c.positionScreen.z*w),Y.r=Y.g=Y.b=1-y/(x-l.positionScreen.z*w),q.r=.5*(k.r+Y.r),q.g=.5*(k.g+Y.g),q.b=.5*(k.b+Y.b),M=a(X,k,Y,q),r(g,b,v,R,T,_,M,0,0,1,0,0,1)):m instanceof THREE.MeshNormalMaterial&&(O.r=h(f.normalWorld.x),O.g=h(f.normalWorld.y),O.b=h(f.normalWorld.z),O.updateStyleString(),m.wireframe?e(O.__styleString,m.wireframe_linewidth):n(O.__styleString))}}function e(i,t){G!=i&&(F.strokeStyle=G=i),D!=t&&(F.lineWidth=D=t),F.stroke(),Q.inflate(2*t)}function n(i){U!=i&&(F.fillStyle=U=i),F.fill()}function r(i,t,e,n,r,o,s,a,h,c,l,f,m){var u,E;u=s.width-1,E=s.height-1,a*=u,h*=E,c*=u,l*=E,f*=u,m*=E,e-=i,n-=t,r-=i,o-=t,c-=a,l-=h,f-=a,m-=h,E=1/(c*m-f*l),u=(m*e-l*r)*E,l=(m*n-l*o)*E,e=(c*r-f*e)*E,n=(c*o-f*n)*E,i=i-u*a-e*h,t=t-l*a-n*h,F.save(),F.transform(u,l,e,n,i,t),F.clip(),F.drawImage(s,0,0),F.restore()}function o(i){j!=i&&(F.globalAlpha=j=i)}function s(i){if(V!=i){switch(i){case THREE.NormalBlending:F.globalCompositeOperation="source-over";break;case THREE.AdditiveBlending:F.globalCompositeOperation="lighter";break;case THREE.SubtractiveBlending:F.globalCompositeOperation="darker"}V=i}}function a(i,t,e,n){return C[0]=I(0,W(255,~~(255*i.r))),C[1]=I(0,W(255,~~(255*i.g))),C[2]=I(0,W(255,~~(255*i.b))),C[4]=I(0,W(255,~~(255*t.r))),C[5]=I(0,W(255,~~(255*t.g))),C[6]=I(0,W(255,~~(255*t.b))),C[8]=I(0,W(255,~~(255*e.r))),C[9]=I(0,W(255,~~(255*e.g))),C[10]=I(0,W(255,~~(255*e.b))),C[12]=I(0,W(255,~~(255*n.r))),C[13]=I(0,W(255,~~(255*n.g))),C[14]=I(0,W(255,~~(255*n.b))),S.putImageData(L,0,0),P.drawImage(H,0,0),A}function h(i){return i<0?W(.5*(1+i),.5):.5+W(.5*i,.5)}function c(i,t){var e=t.x-i.x,n=t.y-i.y,r=1/Math.sqrt(e*e+n*n);e*=r,n*=r,t.x+=e,t.y+=n,i.x-=e,i.y-=n}var l,f,m,u,E,p,d,g,b,v,R,T,_,y,x,w,M,H,S,L,C,A,P,z=null,B=new THREE.Projector,N=document.createElement("canvas"),F=N.getContext("2d"),j=1,V=0,G=null,U=null,D=1,W=Math.min,I=Math.max,O=new THREE.Color,X=new THREE.Color,k=new THREE.Color,Y=new THREE.Color,q=new THREE.Color,Z=new THREE.Rectangle,K=new THREE.Rectangle,Q=new THREE.Rectangle,J=!1,$=new THREE.Color,ii=new THREE.Color,ti=new THREE.Color,ei=new THREE.Color,ni=2*Math.PI,ri=new THREE.Vector3,oi=16;H=document.createElement("canvas"),H.width=H.height=2,S=H.getContext("2d"),S.fillStyle="rgba(0,0,0,1)",S.fillRect(0,0,2,2),L=S.getImageData(0,0,2,2),C=L.data,A=document.createElement("canvas"),A.width=A.height=oi,P=A.getContext("2d"),P.translate(-oi/2,-oi/2),P.scale(oi,oi),oi--,this.domElement=N,this.autoClear=!0,this.setSize=function(i,t){l=i,f=t,m=l/2,u=f/2,N.width=l,N.height=f,Z.set(-m,-u,m,u)},this.clear=function(){K.isEmpty()||(K.inflate(1),K.minSelf(Z),F.clearRect(K.getX(),K.getY(),K.getWidth(),K.getHeight()),K.empty())},this.render=function(i,e){var n,r,a,h,l,f,g,b;if(F.setTransform(1,0,0,-1,m,u),this.autoClear&&this.clear(),z=B.projectScene(i,e),J=i.lights.length>0)for(l=i.lights,ii.setRGB(0,0,0),ti.setRGB(0,0,0),ei.setRGB(0,0,0),n=0,r=l.length;n<r;n++)a=l[n],h=a.color,a instanceof THREE.AmbientLight?(ii.r+=h.r,ii.g+=h.g,ii.b+=h.b):a instanceof THREE.DirectionalLight?(ti.r+=h.r,ti.g+=h.g,ti.b+=h.b):a instanceof THREE.PointLight&&(ei.r+=h.r,ei.g+=h.g,ei.b+=h.b);for(n=0,r=z.length;n<r;n++){if(a=z[n],Q.empty(),a instanceof THREE.RenderableParticle)for(E=a,E.x*=m,E.y*=u,h=0,l=a.material.length;h<l;h++){f=E,g=a;var v=a.material[h];if(0!=v.opacity){o(v.opacity),s(v.blending),b=void 0;var R=void 0,T=void 0,_=void 0,y=void 0,x=void 0,w=void 0;v instanceof THREE.ParticleBasicMaterial?v.map&&(y=v.map,x=y.width>>1,w=y.height>>1,T=g.scale.x*m,_=g.scale.y*u,b=T*x,R=_*w,Q.set(f.x-b,f.y-R,f.x+b,f.y+R),Z.instersects(Q)&&(F.save(),F.translate(f.x,f.y),F.rotate(-g.rotation),F.scale(T,-_),F.translate(-x,-w),F.drawImage(y,0,0),F.restore())):v instanceof THREE.ParticleCircleMaterial&&(J?($.r=ii.r+ti.r+ei.r,$.g=ii.g+ti.g+ei.g,$.b=ii.b+ti.b+ei.b,O.r=v.color.r*$.r,O.g=v.color.g*$.g,O.b=v.color.b*$.b,O.updateStyleString()):O.__styleString=v.color.__styleString,b=g.scale.x*m,R=g.scale.y*u,Q.set(f.x-b,f.y-R,f.x+b,f.y+R),Z.instersects(Q)&&(v=O.__styleString,U!=v&&(F.fillStyle=U=v),F.save(),F.translate(f.x,f.y),F.rotate(-g.rotation),F.scale(b,R),F.beginPath(),F.arc(0,0,1,0,ni,!0),F.closePath(),F.fill(),F.restore()))}}else if(a instanceof THREE.RenderableLine){if(E=a.v1,p=a.v2,E.positionScreen.x*=m,E.positionScreen.y*=u,p.positionScreen.x*=m,p.positionScreen.y*=u,Q.addPoint(E.positionScreen.x,E.positionScreen.y),Q.addPoint(p.positionScreen.x,p.positionScreen.y),Z.instersects(Q))for(h=0,l=a.material.length;h<l;)g=E,b=p,f=a.material[h++],0!=f.opacity&&(o(f.opacity),s(f.blending),F.beginPath(),F.moveTo(g.positionScreen.x,g.positionScreen.y),F.lineTo(b.positionScreen.x,b.positionScreen.y),F.closePath(),f instanceof THREE.LineBasicMaterial&&(O.__styleString=f.color.__styleString,g=f.linewidth,D!=g&&(F.lineWidth=D=g),g=O.__styleString,G!=g&&(F.strokeStyle=G=g),F.stroke(),Q.inflate(2*f.linewidth)))}else if(a instanceof THREE.RenderableFace3&&(E=a.v1,p=a.v2,d=a.v3,E.positionScreen.x*=m,E.positionScreen.y*=u,p.positionScreen.x*=m,p.positionScreen.y*=u,d.positionScreen.x*=m,d.positionScreen.y*=u,a.overdraw&&(c(E.positionScreen,p.positionScreen),c(p.positionScreen,d.positionScreen),c(d.positionScreen,E.positionScreen)),Q.addPoint(E.positionScreen.x,E.positionScreen.y),Q.addPoint(p.positionScreen.x,p.positionScreen.y),Q.addPoint(d.positionScreen.x,d.positionScreen.y),Z.instersects(Q)))for(h=0,l=a.meshMaterial.length;h<l;)if(b=a.meshMaterial[h++],b instanceof THREE.MeshFaceMaterial)for(f=0,g=a.faceMaterial.length;f<g;)(b=a.faceMaterial[f++])&&t(E,p,d,a,b,i);else t(E,p,d,a,b,i);K.addRectangle(Q)}F.setTransform(1,0,0,1,0,0)}},THREE.SVGRenderer=function(){function i(i,t,e){var n,r,o,s;for(n=0,r=i.lights.length;n<r;n++)o=i.lights[n],o instanceof THREE.DirectionalLight?(s=t.normalWorld.dot(o.position)*o.intensity,s>0&&(e.r+=o.color.r*s,e.g+=o.color.g*s,e.b+=o.color.b*s)):o instanceof THREE.PointLight&&(L.sub(o.position,t.centroidWorld),L.normalize(),s=t.normalWorld.dot(L)*o.intensity,s>0&&(e.r+=o.color.r*s,e.g+=o.color.g*s,e.b+=o.color.b*s))}function t(t,e,o,s,a,h){E=n(p++),E.setAttribute("d","M "+t.positionScreen.x+" "+t.positionScreen.y+" L "+e.positionScreen.x+" "+e.positionScreen.y+" L "+o.positionScreen.x+","+o.positionScreen.y+"z"),a instanceof THREE.MeshBasicMaterial?x.__styleString=a.color.__styleString:a instanceof THREE.MeshLambertMaterial?y?(w.r=M.r,w.g=M.g,w.b=M.b,i(h,s,w),x.r=a.color.r*w.r,x.g=a.color.g*w.g,x.b=a.color.b*w.b,x.updateStyleString()):x.__styleString=a.color.__styleString:a instanceof THREE.MeshDepthMaterial?(u=1-a.__2near/(a.__farPlusNear-s.z*a.__farMinusNear),x.setRGB(u,u,u)):a instanceof THREE.MeshNormalMaterial&&x.setRGB(r(s.normalWorld.x),r(s.normalWorld.y),r(s.normalWorld.z)),a.wireframe?E.setAttribute("style","fill: none; stroke: "+x.__styleString+"; stroke-width: "+a.wireframe_linewidth+"; stroke-opacity: "+a.opacity+"; stroke-linecap: "+a.wireframe_linecap+"; stroke-linejoin: "+a.wireframe_linejoin):E.setAttribute("style","fill: "+x.__styleString+"; fill-opacity: "+a.opacity),R.appendChild(E)}function e(t,e,o,s,a,h,c){E=n(p++),E.setAttribute("d","M "+t.positionScreen.x+" "+t.positionScreen.y+" L "+e.positionScreen.x+" "+e.positionScreen.y+" L "+o.positionScreen.x+","+o.positionScreen.y+" L "+s.positionScreen.x+","+s.positionScreen.y+"z"),h instanceof THREE.MeshBasicMaterial?x.__styleString=h.color.__styleString:h instanceof THREE.MeshLambertMaterial?y?(w.r=M.r,w.g=M.g,w.b=M.b,i(c,a,w),x.r=h.color.r*w.r,x.g=h.color.g*w.g,x.b=h.color.b*w.b,x.updateStyleString()):x.__styleString=h.color.__styleString:h instanceof THREE.MeshDepthMaterial?(u=1-h.__2near/(h.__farPlusNear-a.z*h.__farMinusNear),x.setRGB(u,u,u)):h instanceof THREE.MeshNormalMaterial&&x.setRGB(r(a.normalWorld.x),r(a.normalWorld.y),r(a.normalWorld.z)),h.wireframe?E.setAttribute("style","fill: none; stroke: "+x.__styleString+"; stroke-width: "+h.wireframe_linewidth+"; stroke-opacity: "+h.opacity+"; stroke-linecap: "+h.wireframe_linecap+"; stroke-linejoin: "+h.wireframe_linejoin):E.setAttribute("style","fill: "+x.__styleString+"; fill-opacity: "+h.opacity),R.appendChild(E)}function n(i){return null==C[i]?(C[i]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==z&&C[i].setAttribute("shape-rendering","crispEdges"),C[i]):C[i]}function r(i){return i<0?Math.min(.5*(1+i),.5):.5+Math.min(.5*i,.5)}var o,s,a,h,c,l,f,m,u,E,p,d,g,b=null,v=new THREE.Projector,R=document.createElementNS("http://www.w3.org/2000/svg","svg"),T=new THREE.Rectangle,_=new THREE.Rectangle,y=!1,x=new THREE.Color(16777215),w=new THREE.Color(16777215),M=new THREE.Color(0),H=new THREE.Color(0),S=new THREE.Color(0),L=new THREE.Vector3,C=[],A=[],P=[],z=1;this.domElement=R,this.autoClear=!0,this.setQuality=function(i){switch(i){case"high":z=1;break;case"low":z=0}},this.setSize=function(i,t){o=i,s=t,a=o/2,h=s/2,R.setAttribute("viewBox",-a+" "+-h+" "+o+" "+s),R.setAttribute("width",o),R.setAttribute("height",s),T.set(-a,-h,a,h)},this.clear=function(){for(;R.childNodes.length>0;)R.removeChild(R.childNodes[0])},this.render=function(i,n){var r,o,s,u,L,C,B,N;if(this.autoClear&&this.clear(),b=v.projectScene(i,n),g=d=p=0,y=i.lights.length>0)for(B=i.lights,M.setRGB(0,0,0),H.setRGB(0,0,0),S.setRGB(0,0,0),r=0,o=B.length;r<o;r++)s=B[r],u=s.color,s instanceof THREE.AmbientLight?(M.r+=u.r,M.g+=u.g,M.b+=u.b):s instanceof THREE.DirectionalLight?(H.r+=u.r,H.g+=u.g,H.b+=u.b):s instanceof THREE.PointLight&&(S.r+=u.r,S.g+=u.g,S.b+=u.b);for(r=0,o=b.length;r<o;r++)if(B=b[r],_.empty(),B instanceof THREE.RenderableParticle){for(c=B,c.x*=a,c.y*=-h,s=0,u=B.material.length;s<u;s++)if(N=B.material[s]){L=c,C=B,N=N;var F=d++;null==A[F]&&(A[F]=document.createElementNS("http://www.w3.org/2000/svg","circle"),0==z&&A[F].setAttribute("shape-rendering","crispEdges")),E=A[F],E.setAttribute("cx",L.x),E.setAttribute("cy",L.y),E.setAttribute("r",C.scale.x*a),N instanceof THREE.ParticleCircleMaterial&&(y?(w.r=M.r+H.r+S.r,w.g=M.g+H.g+S.g,w.b=M.b+H.b+S.b,x.r=N.color.r*w.r,x.g=N.color.g*w.g,x.b=N.color.b*w.b,x.updateStyleString()):x=N.color,E.setAttribute("style","fill: "+x.__styleString)),R.appendChild(E)}}else if(B instanceof THREE.RenderableLine){if(c=B.v1,l=B.v2,c.positionScreen.x*=a,c.positionScreen.y*=-h,l.positionScreen.x*=a,l.positionScreen.y*=-h,_.addPoint(c.positionScreen.x,c.positionScreen.y),_.addPoint(l.positionScreen.x,l.positionScreen.y),T.instersects(_))for(s=0,u=B.material.length;s<u;)(N=B.material[s++])&&(L=c,C=l,N=N,F=g++,null==P[F]&&(P[F]=document.createElementNS("http://www.w3.org/2000/svg","line"),0==z&&P[F].setAttribute("shape-rendering","crispEdges")),E=P[F],E.setAttribute("x1",L.positionScreen.x),E.setAttribute("y1",L.positionScreen.y),E.setAttribute("x2",C.positionScreen.x),E.setAttribute("y2",C.positionScreen.y),N instanceof THREE.LineBasicMaterial&&(x.__styleString=N.color.__styleString,E.setAttribute("style","fill: none; stroke: "+x.__styleString+"; stroke-width: "+N.linewidth+"; stroke-opacity: "+N.opacity+"; stroke-linecap: "+N.linecap+"; stroke-linejoin: "+N.linejoin),R.appendChild(E)))}else if(B instanceof THREE.RenderableFace3){if(c=B.v1,l=B.v2,f=B.v3,c.positionScreen.x*=a,c.positionScreen.y*=-h,l.positionScreen.x*=a,l.positionScreen.y*=-h,f.positionScreen.x*=a,f.positionScreen.y*=-h,_.addPoint(c.positionScreen.x,c.positionScreen.y),_.addPoint(l.positionScreen.x,l.positionScreen.y),_.addPoint(f.positionScreen.x,f.positionScreen.y),T.instersects(_))for(s=0,u=B.meshMaterial.length;s<u;)if(N=B.meshMaterial[s++],N instanceof THREE.MeshFaceMaterial)for(L=0,C=B.faceMaterial.length;L<C;)(N=B.faceMaterial[L++])&&t(c,l,f,B,N,i);else N&&t(c,l,f,B,N,i)}else if(B instanceof THREE.RenderableFace4&&(c=B.v1,l=B.v2,f=B.v3,m=B.v4,c.positionScreen.x*=a,c.positionScreen.y*=-h,l.positionScreen.x*=a,l.positionScreen.y*=-h,f.positionScreen.x*=a,f.positionScreen.y*=-h,m.positionScreen.x*=a,m.positionScreen.y*=-h,_.addPoint(c.positionScreen.x,c.positionScreen.y),_.addPoint(l.positionScreen.x,l.positionScreen.y),_.addPoint(f.positionScreen.x,f.positionScreen.y),_.addPoint(m.positionScreen.x,m.positionScreen.y),T.instersects(_)))for(s=0,u=B.meshMaterial.length;s<u;)if(N=B.meshMaterial[s++],N instanceof THREE.MeshFaceMaterial)for(L=0,C=B.faceMaterial.length;L<C;)(N=B.faceMaterial[L++])&&e(c,l,f,m,B,N,i);else N&&e(c,l,f,m,B,N,i)}},THREE.WebGLRenderer=function(i){function t(i,t){var e=s.createProgram();return s.attachShader(e,r("fragment","#ifdef GL_ES\nprecision highp float;\n#endif\n"+i)),s.attachShader(e,r("vertex",t)),s.linkProgram(e),s.getProgramParameter(e,s.LINK_STATUS)||(alert("Could not initialise shaders"),alert("VALIDATE_STATUS: "+s.getProgramParameter(e,s.VALIDATE_STATUS)),alert(s.getError())),e.uniforms={},e}function e(i,t){var e,n,r;for(e=0,n=t.length;e<n;e++)r=t[e],i.uniforms[r]=s.getUniformLocation(i,r)}function n(i){i.position=s.getAttribLocation(i,"position"),s.enableVertexAttribArray(i.position),i.normal=s.getAttribLocation(i,"normal"),s.enableVertexAttribArray(i.normal),i.uv=s.getAttribLocation(i,"uv"),s.enableVertexAttribArray(i.uv)}function r(i,t){var e;return"fragment"==i?e=s.createShader(s.FRAGMENT_SHADER):"vertex"==i&&(e=s.createShader(s.VERTEX_SHADER)),s.shaderSource(e,t),s.compileShader(e),s.getShaderParameter(e,s.COMPILE_STATUS)?e:(alert(s.getShaderInfoLog(e)),null)}function o(i){switch(i){case THREE.Repeat:return s.REPEAT;case THREE.ClampToEdge:return s.CLAMP_TO_EDGE;case THREE.MirroredRepeat:return s.MIRRORED_REPEAT}return 0}var s,a,h,c,l=document.createElement("canvas"),f=new THREE.Matrix4,m=new Float32Array(16),u=new Float32Array(16),E=new Float32Array(16),p=new Float32Array(9),d=new Float32Array(16);i=function(i,t){if(i){var e,n,r,o=pointLights=maxDirLights=maxPointLights=0;for(e=0,n=i.lights.length;e<n;e++)r=i.lights[e],r instanceof THREE.DirectionalLight&&o++,r instanceof THREE.PointLight&&pointLights++;return pointLights+o<=t?(maxDirLights=o,maxPointLights=pointLights):(maxDirLights=Math.ceil(t*o/(pointLights+o)),maxPointLights=t-maxDirLights),{directional:maxDirLights,point:maxPointLights}}return{directional:1,point:t-1}}(i,4),this.domElement=l,this.autoClear=!0;try{s=l.getContext("experimental-webgl",{antialias:!0})}catch(i){}if(!s)throw alert("WebGL not supported"),"cannot create webgl context";s.clearColor(0,0,0,1),s.clearDepth(1),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.frontFace(s.CCW),s.cullFace(s.BACK),s.enable(s.CULL_FACE),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.clearColor(0,0,0,0),function(i,r){var o=[i?"#define MAX_DIR_LIGHTS "+i:"",r?"#define MAX_POINT_LIGHTS "+r:"","attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nuniform vec3 cameraPosition;\nuniform bool enableLighting;\nuniform bool useRefract;\nuniform int pointLightNumber;\nuniform int directionalLightNumber;\nuniform vec3 ambientLightColor;",i?"uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];":"",i?"uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];":"",r?"uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];":"",r?"uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];":"","uniform mat4 objMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vLightWeighting;",r?"varying vec3 vPointLightVector[ MAX_POINT_LIGHTS ];":"","varying vec3 vViewPosition;\nvarying vec3 vReflect;\nuniform float mRefractionRatio;\nvoid main(void) {\nvec4 mPosition = objMatrix * vec4( position, 1.0 );\nvViewPosition = cameraPosition - mPosition.xyz;\nvec3 nWorld = mat3( objMatrix[0].xyz, objMatrix[1].xyz, objMatrix[2].xyz ) * normal;\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\nvec3 transformedNormal = normalize( normalMatrix * normal );\nif ( !enableLighting ) {\nvLightWeighting = vec3( 1.0, 1.0, 1.0 );\n} else {\nvLightWeighting = ambientLightColor;",i?"for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {":"",i?"vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );":"",i?"float directionalLightWeighting = max( dot( transformedNormal, normalize(lDirection.xyz ) ), 0.0 );":"",i?"vLightWeighting += directionalLightColor[ i ] * directionalLightWeighting;":"",i?"}":"",r?"for( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {":"",r?"vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );":"",r?"vPointLightVector[ i ] = normalize( lPosition.xyz - mvPosition.xyz );":"",r?"float pointLightWeighting = max( dot( transformedNormal, vPointLightVector[ i ] ), 0.0 );":"",r?"vLightWeighting += pointLightColor[ i ] * pointLightWeighting;":"",r?"}":"","}\nvNormal = transformedNormal;\nvUv = uv;\nif ( useRefract ) {\nvReflect = refract( normalize(mPosition.xyz - cameraPosition), normalize(nWorld.xyz), mRefractionRatio );\n} else {\nvReflect = reflect( normalize(mPosition.xyz - cameraPosition), normalize(nWorld.xyz) );\n}\ngl_Position = projectionMatrix * mvPosition;\n}"].join("\n"),h=[i?"#define MAX_DIR_LIGHTS "+i:"",r?"#define MAX_POINT_LIGHTS "+r:"","uniform int material;\nuniform bool enableMap;\nuniform bool enableCubeMap;\nuniform bool mixEnvMap;\nuniform samplerCube tCube;\nuniform float mReflectivity;\nuniform sampler2D tMap;\nuniform vec4 mColor;\nuniform float mOpacity;\nuniform vec4 mAmbient;\nuniform vec4 mSpecular;\nuniform float mShininess;\nuniform float m2Near;\nuniform float mFarPlusNear;\nuniform float mFarMinusNear;\nuniform int pointLightNumber;\nuniform int directionalLightNumber;",i?"uniform mat4 viewMatrix;":"",i?"uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];":"","varying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vLightWeighting;",r?"varying vec3 vPointLightVector[ MAX_POINT_LIGHTS ];":"","varying vec3 vViewPosition;\nvarying vec3 vReflect;\nuniform vec3 cameraPosition;\nvoid main() {\nvec4 mapColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nvec4 cubeColor = vec4( 1.0, 1.0, 1.0, 1.0 );\nif ( enableMap ) {\nmapColor = texture2D( tMap, vUv );\n}\nif ( enableCubeMap ) {\ncubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\n}\nif ( material == 5 ) { \nvec3 wPos = cameraPosition - vViewPosition;\ngl_FragColor = textureCube( tCube, vec3( -wPos.x, wPos.yz ) );\n} else if ( material == 4 ) { \ngl_FragColor = vec4( 0.5*normalize( vNormal ) + vec3(0.5, 0.5, 0.5), mOpacity );\n} else if ( material == 3 ) { \nfloat w = 0.5;\ngl_FragColor = vec4( w, w, w, mOpacity );\n} else if ( material == 2 ) { \nvec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );",r?"vec4 pointDiffuse  = vec4( 0.0, 0.0, 0.0, 0.0 );":"",r?"vec4 pointSpecular = vec4( 0.0, 0.0, 0.0, 0.0 );":"",r?"for( int i = 0; i < MAX_POINT_LIGHTS; i++ ) {":"",r?"vec3 pointVector = normalize( vPointLightVector[ i ] );":"",r?"vec3 pointHalfVector = normalize( vPointLightVector[ i ] + vViewPosition );":"",r?"float pointDotNormalHalf = dot( normal, pointHalfVector );":"",r?"float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );":"",r?"float pointSpecularWeight = 0.0;":"",r?"if ( pointDotNormalHalf >= 0.0 )":"",r?"pointSpecularWeight = pow( pointDotNormalHalf, mShininess );":"",r?"pointDiffuse  += mColor * pointDiffuseWeight;":"",r?"pointSpecular += mSpecular * pointSpecularWeight;":"",r?"}":"",i?"vec4 dirDiffuse  = vec4( 0.0, 0.0, 0.0, 0.0 );":"",i?"vec4 dirSpecular = vec4( 0.0, 0.0, 0.0, 0.0 );":"",i?"for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {":"",i?"vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );":"",i?"vec3 dirVector = normalize( lDirection.xyz );":"",i?"vec3 dirHalfVector = normalize( lDirection.xyz + vViewPosition );":"",i?"float dirDotNormalHalf = dot( normal, dirHalfVector );":"",i?"float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );":"",i?"float dirSpecularWeight = 0.0;":"",i?"if ( dirDotNormalHalf >= 0.0 )":"",i?"dirSpecularWeight = pow( dirDotNormalHalf, mShininess );":"",i?"dirDiffuse  += mColor * dirDiffuseWeight;":"",i?"dirSpecular += mSpecular * dirSpecularWeight;":"",i?"}":"","vec4 totalLight = mAmbient;",i?"totalLight += dirDiffuse + dirSpecular;":"",r?"totalLight += pointDiffuse + pointSpecular;":"","if ( mixEnvMap ) {\ngl_FragColor = vec4( mix( mapColor.rgb * totalLight.xyz * vLightWeighting, cubeColor.rgb, mReflectivity ), mapColor.a );\n} else {\ngl_FragColor = vec4( mapColor.rgb * cubeColor.rgb * totalLight.xyz * vLightWeighting, mapColor.a );\n}\n} else if ( material == 1 ) {\nif ( mixEnvMap ) {\ngl_FragColor = vec4( mix( mColor.rgb * mapColor.rgb * vLightWeighting, cubeColor.rgb, mReflectivity ), mColor.a * mapColor.a );\n} else {\ngl_FragColor = vec4( mColor.rgb * mapColor.rgb * cubeColor.rgb * vLightWeighting, mColor.a * mapColor.a );\n}\n} else {\nif ( mixEnvMap ) {\ngl_FragColor = mix( mColor * mapColor, cubeColor, mReflectivity );\n} else {\ngl_FragColor = mColor * mapColor * cubeColor;\n}\n}\n}"].join("\n");a=t(h,o),s.useProgram(a),e(a,["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","objMatrix","cameraPosition","enableLighting","ambientLightColor","material","mColor","mAmbient","mSpecular","mShininess","mOpacity","enableMap","tMap","enableCubeMap","tCube","mixEnvMap","mReflectivity","mRefractionRatio","useRefract","m2Near","mFarPlusNear","mFarMinusNear"]),i&&e(a,["directionalLightNumber","directionalLightColor","directionalLightDirection"]),r&&e(a,["pointLightNumber","pointLightColor","pointLightPosition"]),s.uniform1i(a.uniforms.enableMap,0),s.uniform1i(a.uniforms.tMap,0),s.uniform1i(a.uniforms.enableCubeMap,0),s.uniform1i(a.uniforms.tCube,1),s.uniform1i(a.uniforms.mixEnvMap,0),s.uniform1i(a.uniforms.useRefract,0),n(a)}(i.directional,i.point),this.setSize=function(i,t){l.width=i,l.height=t,s.viewport(0,0,l.width,l.height)},this.clear=function(){s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},this.setupLights=function(i,t){var e,n,r,o,a,h=[],c=[],l=[];
for(o=[],a=[],s.uniform1i(i.uniforms.enableLighting,t.lights.length),e=0,n=t.lights.length;e<n;e++)r=t.lights[e],r instanceof THREE.AmbientLight?h.push(r):r instanceof THREE.DirectionalLight?l.push(r):r instanceof THREE.PointLight&&c.push(r);for(e=r=o=a=0,n=h.length;e<n;e++)r+=h[e].color.r,o+=h[e].color.g,a+=h[e].color.b;for(s.uniform3f(i.uniforms.ambientLightColor,r,o,a),o=[],a=[],e=0,n=l.length;e<n;e++)r=l[e],o.push(r.color.r*r.intensity),o.push(r.color.g*r.intensity),o.push(r.color.b*r.intensity),a.push(r.position.x),a.push(r.position.y),a.push(r.position.z);for(l.length&&(s.uniform1i(i.uniforms.directionalLightNumber,l.length),s.uniform3fv(i.uniforms.directionalLightDirection,a),s.uniform3fv(i.uniforms.directionalLightColor,o)),o=[],a=[],e=0,n=c.length;e<n;e++)r=c[e],o.push(r.color.r*r.intensity),o.push(r.color.g*r.intensity),o.push(r.color.b*r.intensity),a.push(r.position.x),a.push(r.position.y),a.push(r.position.z);c.length&&(s.uniform1i(i.uniforms.pointLightNumber,c.length),s.uniform3fv(i.uniforms.pointLightPosition,a),s.uniform3fv(i.uniforms.pointLightColor,o))},this.createBuffers=function(i,t){var e,n,r,o,a,h,c,l,f,m=[],u=[],E=[],p=[],d=[],g=0,b=i.materialFaceGroup[t];for(r=!1,e=0,n=i.material.length;e<n;e++){if(meshMaterial=i.material[e],meshMaterial instanceof THREE.MeshFaceMaterial){for(a=0,f=b.material.length;a<f;a++)if(b.material[a]&&void 0!=b.material[a].shading&&b.material[a].shading==THREE.SmoothShading){r=!0;break}}else if(meshMaterial&&void 0!=meshMaterial.shading&&meshMaterial.shading==THREE.SmoothShading){r=!0;break}if(r)break}for(f=r,e=0,n=b.faces.length;e<n;e++)if(r=b.faces[e],o=i.geometry.faces[r],a=o.vertexNormals,faceNormal=o.normal,r=i.geometry.uvs[r],o instanceof THREE.Face3){if(h=i.geometry.vertices[o.a].position,c=i.geometry.vertices[o.b].position,l=i.geometry.vertices[o.c].position,E.push(h.x,h.y,h.z),E.push(c.x,c.y,c.z),E.push(l.x,l.y,l.z),3==a.length&&f)for(o=0;o<3;o++)p.push(a[o].x,a[o].y,a[o].z);else for(o=0;o<3;o++)p.push(faceNormal.x,faceNormal.y,faceNormal.z);if(r)for(o=0;o<3;o++)d.push(r[o].u,r[o].v);m.push(g,g+1,g+2),u.push(g,g+1),u.push(g,g+2),u.push(g+1,g+2),g+=3}else if(o instanceof THREE.Face4){if(h=i.geometry.vertices[o.a].position,c=i.geometry.vertices[o.b].position,l=i.geometry.vertices[o.c].position,o=i.geometry.vertices[o.d].position,E.push(h.x,h.y,h.z),E.push(c.x,c.y,c.z),E.push(l.x,l.y,l.z),E.push(o.x,o.y,o.z),4==a.length&&f)for(o=0;o<4;o++)p.push(a[o].x,a[o].y,a[o].z);else for(o=0;o<4;o++)p.push(faceNormal.x,faceNormal.y,faceNormal.z);if(r)for(o=0;o<4;o++)d.push(r[o].u,r[o].v);m.push(g,g+1,g+2),m.push(g,g+2,g+3),u.push(g,g+1),u.push(g,g+2),u.push(g,g+3),u.push(g+1,g+2),u.push(g+2,g+3),g+=4}E.length&&(b.__webGLVertexBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,b.__webGLVertexBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array(E),s.STATIC_DRAW),b.__webGLNormalBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,b.__webGLNormalBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array(p),s.STATIC_DRAW),b.__webGLUVBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,b.__webGLUVBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array(d),s.STATIC_DRAW),b.__webGLFaceBuffer=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,b.__webGLFaceBuffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(m),s.STATIC_DRAW),b.__webGLLineBuffer=s.createBuffer(),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,b.__webGLLineBuffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(u),s.STATIC_DRAW),b.__webGLFaceCount=m.length,b.__webGLLineCount=u.length)},this.renderBuffer=function(i,r,c){var l,f,m,u,E,p,d,g,b,v;if(r instanceof THREE.MeshShaderMaterial){if(!r.program){r.program=t(r.fragment_shader,r.vertex_shader),E=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","objMatrix","cameraPosition"];for(v in r.uniforms)E.push(v);e(r.program,E),n(r.program)}v=r.program}else v=a;if(v!=h&&(s.useProgram(v),h=v),r instanceof THREE.MeshShaderMaterial){E=v,g=r.uniforms;var R,T;for(f in g)if(R=g[f].type,b=g[f].value,T=E.uniforms[f],"i"==R)s.uniform1i(T,b);else if("f"==R)s.uniform1f(T,b);else if("t"==R&&(s.uniform1i(T,b),b=g[f].texture,b instanceof THREE.TextureCube&&6==b.image.length)){if(!b.image.__webGLTextureCube&&!b.image.__cubeMapInitialized&&6==b.image.loadCount){for(b.image.__webGLTextureCube=s.createTexture(),s.bindTexture(s.TEXTURE_CUBE_MAP,b.image.__webGLTextureCube),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),R=0;R<6;++R)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+R,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,b.image[R]);s.generateMipmap(s.TEXTURE_CUBE_MAP),s.bindTexture(s.TEXTURE_CUBE_MAP,null),b.image.__cubeMapInitialized=!0}s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_CUBE_MAP,b.image.__webGLTextureCube)}this.loadCamera(v,i),this.loadMatrices(v)}else(r instanceof THREE.MeshPhongMaterial||r instanceof THREE.MeshLambertMaterial||r instanceof THREE.MeshBasicMaterial)&&(i=r.color,l=r.opacity,m=r.wireframe,u=r.wireframe_linewidth,p=r.map,d=r.env_map,E=r.combine==THREE.Mix,f=r.reflectivity,b=r.env_map&&r.env_map.mapping==THREE.RefractionMapping,g=r.refraction_ratio,s.uniform4f(v.uniforms.mColor,i.r*l,i.g*l,i.b*l,l),s.uniform1i(v.uniforms.mixEnvMap,E),s.uniform1f(v.uniforms.mReflectivity,f),s.uniform1i(v.uniforms.useRefract,b),s.uniform1f(v.uniforms.mRefractionRatio,g));if(r instanceof THREE.MeshNormalMaterial?(l=r.opacity,s.uniform1f(v.uniforms.mOpacity,l),s.uniform1i(v.uniforms.material,4)):r instanceof THREE.MeshDepthMaterial?(l=r.opacity,m=r.wireframe,u=r.wireframe_linewidth,s.uniform1f(v.uniforms.mOpacity,l),s.uniform1f(v.uniforms.m2Near,r.__2near),s.uniform1f(v.uniforms.mFarPlusNear,r.__farPlusNear),s.uniform1f(v.uniforms.mFarMinusNear,r.__farMinusNear),s.uniform1i(v.uniforms.material,3)):r instanceof THREE.MeshPhongMaterial?(i=r.ambient,f=r.specular,E=r.shininess,s.uniform4f(v.uniforms.mAmbient,i.r,i.g,i.b,l),s.uniform4f(v.uniforms.mSpecular,f.r,f.g,f.b,l),s.uniform1f(v.uniforms.mShininess,E),s.uniform1i(v.uniforms.material,2)):r instanceof THREE.MeshLambertMaterial?s.uniform1i(v.uniforms.material,1):r instanceof THREE.MeshBasicMaterial?s.uniform1i(v.uniforms.material,0):r instanceof THREE.MeshCubeMaterial&&(s.uniform1i(v.uniforms.material,5),d=r.env_map),p?(!r.map.__webGLTexture&&r.map.image.loaded&&(r.map.__webGLTexture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,r.map.__webGLTexture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,r.map.image),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,o(r.map.wrap_s)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,o(r.map.wrap_t)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.generateMipmap(s.TEXTURE_2D),s.bindTexture(s.TEXTURE_2D,null)),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,r.map.__webGLTexture),s.uniform1i(v.uniforms.tMap,0),s.uniform1i(v.uniforms.enableMap,1)):s.uniform1i(v.uniforms.enableMap,0),d){if(r.env_map&&r.env_map instanceof THREE.TextureCube&&6==r.env_map.image.length){if(!r.env_map.image.__webGLTextureCube&&!r.env_map.image.__cubeMapInitialized&&6==r.env_map.image.loadCount){for(r.env_map.image.__webGLTextureCube=s.createTexture(),s.bindTexture(s.TEXTURE_CUBE_MAP,r.env_map.image.__webGLTextureCube),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),l=0;l<6;++l)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,r.env_map.image[l]);s.generateMipmap(s.TEXTURE_CUBE_MAP),s.bindTexture(s.TEXTURE_CUBE_MAP,null),r.env_map.image.__cubeMapInitialized=!0}s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_CUBE_MAP,r.env_map.image.__webGLTextureCube),s.uniform1i(v.uniforms.tCube,1)}s.uniform1i(v.uniforms.enableCubeMap,1)}else s.uniform1i(v.uniforms.enableCubeMap,0);s.bindBuffer(s.ARRAY_BUFFER,c.__webGLVertexBuffer),s.vertexAttribPointer(v.position,3,s.FLOAT,!1,0,0),s.bindBuffer(s.ARRAY_BUFFER,c.__webGLNormalBuffer),s.vertexAttribPointer(v.normal,3,s.FLOAT,!1,0,0),p?(s.bindBuffer(s.ARRAY_BUFFER,c.__webGLUVBuffer),s.enableVertexAttribArray(v.uv),s.vertexAttribPointer(v.uv,2,s.FLOAT,!1,0,0)):s.disableVertexAttribArray(v.uv),m?(s.lineWidth(u),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,c.__webGLLineBuffer),s.drawElements(s.LINES,c.__webGLLineCount,s.UNSIGNED_SHORT,0)):(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,c.__webGLFaceBuffer),s.drawElements(s.TRIANGLES,c.__webGLFaceCount,s.UNSIGNED_SHORT,0))},this.renderPass=function(i,t,e,n,r){var o,s,a,h,c;for(a=0,h=t.material.length;a<h;a++)if(o=t.material[a],o instanceof THREE.MeshFaceMaterial)for(o=0,s=e.material.length;o<s;o++)(c=e.material[o])&&c.blending==n&&c.opacity<1==r&&(this.setBlending(c.blending),this.renderBuffer(i,c,e));else(c=o)&&c.blending==n&&c.opacity<1==r&&(this.setBlending(c.blending),this.renderBuffer(i,c,e))},this.render=function(i,t){var e,n;for(this.initWebGLObjects(i),this.autoClear&&this.clear(),t.autoUpdateMatrix&&t.updateMatrix(),this.loadCamera(a,t),this.setupLights(a,i),e=0,n=i.__webGLObjects.length;e<n;e++)webGLObject=i.__webGLObjects[e],webGLObject.__object.visible&&(this.setupMatrices(webGLObject.__object,t),this.loadMatrices(a),this.renderPass(t,webGLObject.__object,webGLObject,THREE.NormalBlending,!1));for(e=0,n=i.__webGLObjects.length;e<n;e++)webGLObject=i.__webGLObjects[e],webGLObject.__object.visible&&(this.setupMatrices(webGLObject.__object,t),this.loadMatrices(a),this.renderPass(t,webGLObject.__object,webGLObject,THREE.AdditiveBlending,!1),this.renderPass(t,webGLObject.__object,webGLObject,THREE.SubtractiveBlending,!1),this.renderPass(t,webGLObject.__object,webGLObject,THREE.AdditiveBlending,!0),this.renderPass(t,webGLObject.__object,webGLObject,THREE.SubtractiveBlending,!0),this.renderPass(t,webGLObject.__object,webGLObject,THREE.NormalBlending,!0))},this.initWebGLObjects=function(i){var t,e,n,r,o;for(i.__webGLObjects||(i.__webGLObjects=[]),t=0,e=i.objects.length;t<e;t++)if(n=i.objects[t],n instanceof THREE.Mesh)for(r in n.materialFaceGroup)o=n.materialFaceGroup[r],o.__webGLVertexBuffer||(this.createBuffers(n,r),o.__object=n,i.__webGLObjects.push(o))},this.removeObject=function(i,t){var e,n;for(e=i.__webGLObjects.length-1;e>=0;e--)n=i.__webGLObjects[e].__object,t==n&&i.__webGLObjects.splice(e,1)},this.setupMatrices=function(i,t){i.autoUpdateMatrix&&i.updateMatrix(),f.multiply(t.matrix,i.matrix),m.set(t.matrix.flatten()),u.set(f.flatten()),E.set(t.projectionMatrix.flatten()),c=THREE.Matrix4.makeInvert3x3(f).transpose(),p.set(c.m),d.set(i.matrix.flatten())},this.loadMatrices=function(i){s.uniformMatrix4fv(i.uniforms.viewMatrix,!1,m),s.uniformMatrix4fv(i.uniforms.modelViewMatrix,!1,u),s.uniformMatrix4fv(i.uniforms.projectionMatrix,!1,E),s.uniformMatrix3fv(i.uniforms.normalMatrix,!1,p),s.uniformMatrix4fv(i.uniforms.objMatrix,!1,d)},this.loadCamera=function(i,t){s.uniform3f(i.uniforms.cameraPosition,t.position.x,t.position.y,t.position.z)},this.setBlending=function(i){switch(i){case THREE.AdditiveBlending:s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ONE);break;case THREE.SubtractiveBlending:s.blendFunc(s.DST_COLOR,s.ZERO);break;default:s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA)}},this.setFaceCulling=function(i,t){i?(t&&"ccw"!=t?s.frontFace(s.CW):s.frontFace(s.CCW),"back"==i?s.cullFace(s.BACK):"front"==i?s.cullFace(s.FRONT):s.cullFace(s.FRONT_AND_BACK),s.enable(s.CULL_FACE)):s.disable(s.CULL_FACE)}},THREE.RenderableFace3=function(){this.z=null,this.v1=new THREE.Vertex,this.v2=new THREE.Vertex,this.v3=new THREE.Vertex,this.centroidWorld=new THREE.Vector3,this.centroidScreen=new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.vertexNormalsWorld=[],this.faceMaterial=this.meshMaterial=null,this.overdraw=!1,this.uvs=[null,null,null]},THREE.RenderableParticle=function(){this.rotation=this.z=this.y=this.x=null,this.scale=new THREE.Vector2,this.material=null},THREE.RenderableLine=function(){this.z=null,this.v1=new THREE.Vertex,this.v2=new THREE.Vertex,this.material=null};