/*! asynquence-contrib
    v0.5.1-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e){"undefined"!=typeof module&&module.exports?(module.exports=function t(n){if("string"==typeof n)try{n=require(n)}catch(r){return t}return e(n)},"string"==typeof n&&(module.exports=module.exports(require("path").join("..",n)))):"function"==typeof define&&define.amd?define([n],e):e(n)}(this.ASQ||"asynquence",function(n){"use strict";function e(e,a,u,c,i){a=a.map(function(e,a){var o;return n.isSequence(e)?(o={fn:e},l(o),function(n){o.fn.val(function(){u(n,a,t.call(arguments))}).or(function(){c(n,a,t.call(arguments))})}):function(n){var l=t.call(arguments);l[0]=function(){u(n,a,t.call(arguments))},l[0].fail=function(){c(n,a,t.call(arguments))},l[0].abort=function(){i()},l[0].errfcb=function(e){e?c(n,a,[e]):u(n,a,t.call(arguments,1))},e.apply(r,l)}}),e.then(function(){var n=t.call(arguments);a.forEach(function(e){e.apply(r,n)})})}var t=Array.prototype.slice,r=Object.create(null),a="__ASQ__",u=n.__schedule,l=n.__tapSequence;return n.extend("after",function(n){return function(e){var a=arguments.length>1?t.call(arguments,1):void 0;return e=+e||0,n.then(function(n){a=a||t.call(arguments,1),setTimeout(function(){n.apply(r,a)},e)}),n}}),n.after=function(){return n().after.apply(r,arguments)},n.extend("any",function(a,u){return function(){function l(){g=!0,p.length=0,h.length=0}function c(n){h.length>0?(h.length=s.length,n.apply(r,h)):(p.length=s.length,n.fail.apply(r,p)),l()}function i(e,t,a){g||(f++,h[t]=a.length>1?n.messages.apply(r,a):a[0],f===s.length&&(g=!0,c(e)))}function o(e,t,a){g||t in p||(f++,p[t]=a.length>1?n.messages.apply(r,a):a[0]),g||f!==s.length||(g=!0,c(e))}if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var s,f=0,p=[],g=!1,h=[];return s=t.call(arguments),e(a,s,i,o,l),a}}),n.extend("errfcb",function(n){return function(){var e={val:function(n){return e.val_cb=n,e},or:function(n){return e.or_cb=n,e}};return e[a]=!0,n.seq(e),function(n){n?e.or_cb(n):e.val_cb.apply(r,t.call(arguments,1))}}}),n.extend("failAfter",function(n){return function(e){var a=arguments.length>1?t.call(arguments,1):void 0;return e=+e||0,n.then(function(n){setTimeout(function(){n.fail.apply(r,a)},e)}),n}}),n.failAfter=function(){return n().failAfter.apply(r,arguments)},n.extend("first",function(a,u){return function(){function l(){f.length=0}function c(e,t,a){p||(p=!0,e(a.length>1?n.messages.apply(r,a):a[0]),l())}function i(e,t,a){p||t in f||(s++,f[t]=a.length>1?n.messages.apply(r,a):a[0],s===o.length&&(p=!0,f.length=o.length,e.fail.apply(r,f),l()))}if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var o,s=0,f=[],p=!1;return o=t.call(arguments),e(a,o,c,i,l),a}}),function(){var e;n.iterable=function(){function l(){throw 1===w.length?w[0]:w}function c(){var n;if(d=null,_)for(0!==S.length||b||(b=!0,l());S.length>0;){b=!0,n=S.shift();try{n.apply(r,w)}catch(e){checkBranding(e)?w=w.concat(e):(w.push(e),e.stack&&w.push(e.stack)),0===S.length&&l()}}}function i(){return _||q||0===arguments.length?v:(x.push.apply(x,arguments),v)}function o(){return q||0===arguments.length?v:(S.push.apply(S,arguments),d||(d=u(c)),v)}function s(){return q||0===arguments.length?v:(t.call(arguments).forEach(function(n){i(n).or(n.fail)}),v)}function f(){if(_||q||0===x.length)return x.length>0&&p("Sequence cannot be iterated"),{done:!0};try{return{value:x.shift().apply(r,arguments)}}catch(e){return n.isMessageWrapper(e)?p.apply(r,e):e.stack?p(e,e.stack):p(e),{}}}function p(){return _||q?v:(w.push.apply(w,arguments),_=!0,d||(d=u(c)),v)}function g(){_||q||(q=!0,clearTimeout(d),d=null,x.length=S.length=w.length=0)}function h(){var t;return e={val_queue:x.slice(),or_queue:S.slice()},t=n.iterable(),e=null,t}function m(){return S.push(function(){}),v}function y(n){return Object.defineProperty(n,a,{enumerable:!1,value:!0}),n}var v,d,_=!1,b=!1,q=!1,x=[],S=[],w=[];return v=y({val:i,then:i,or:o,pipe:s,next:f,"throw":p,abort:g,duplicate:h,defer:m}),v["object"==typeof Symbol&&null!=Symbol&&Symbol.iterator||"@@iterator"]=function(){return v},e&&(x=e.val_queue.slice(0),S=e.or_queue.slice(0)),v.val.apply(r,arguments),v}}(),n.extend("last",function(a,u){return function(){function l(){h=!0,g.length=0,f=null}function c(e){null!=f?e(f.length>1?n.messages.apply(r,f):f[0]):(g.length=s.length,e.fail.apply(r,g)),l()}function i(n,e,t){h||(p++,f=t,p===s.length&&(h=!0,c(n)))}function o(e,t,a){h||t in g||(p++,g[t]=a.length>1?n.messages.apply(r,a):a[0]),h||p!==s.length||(h=!0,c(e))}if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var s,f,p=0,g=[],h=!1;return s=t.call(arguments),e(a,s,i,o,l),a}}),n.extend("map",function(e,a){return function(u,l){return a("seq_error")||a("seq_aborted")?e:(e.seq(function(){var e,a=t.call(arguments);return l||(l=a.shift()),u||(u=a.shift()),"function"==typeof u&&Array.isArray(l)&&(e=u,u=l,l=e),n.apply(r,a).gate.apply(r,u.map(function(n){return function(){l.apply(r,[n].concat(t.call(arguments)))}}))}).val(function(){return t.call(arguments)}),e)}}),n.extend("none",function(a,u){return function(){function l(){g=!0,p.length=0,h.length=0}function c(n){h.length>0?(h.length=s.length,n.fail.apply(r,h)):(p.length=s.length,n.apply(r,p)),l()}function i(e,t,a){g||(f++,h[t]=a.length>1?n.messages.apply(r,a):a[0],f===s.length&&(g=!0,c(e)))}function o(e,t,a){g||t in p||(f++,p[t]=a.length>1?n.messages.apply(r,a):a[0]),g||f!==s.length||(g=!0,c(e))}if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var s,f=0,p=[],g=!1,h=[];return s=t.call(arguments),e(a,s,i,o,l),a}}),n.extend("pThen",function(e,a){return function(u,l){if(a("seq_aborted"))return e;var c=!1,i=!1;return"function"==typeof u&&e.then(function(e){if(c)e.apply(r,t.call(arguments,1));else{var a,l=n.messages.apply(r,arguments);l.shift(),1===l.length&&(l=l[0]),i=!0;try{a=u(l)}catch(o){return n.isMessageWrapper(o)||(o=[o]),void e.fail.apply(r,o)}n.isSequence(a)?a.pipe(e):n.isMessageWrapper(a)?e.apply(r,a):("object"==typeof a||"function"==typeof a)&&"then"in a?a.then(e,e.fail):e(a)}}),"function"==typeof l&&e.or(function(){if(!i){var u,o,s=n.messages.apply(r,arguments),f=t.call(a("or_queue"));1===s.length&&(s=s[0]),c=!0,u=l(s),o=a("sequence_messages"),o.length=0,"undefined"!=typeof u&&(n.isMessageWrapper(u)||(u=[u]),o.push.apply(o,u)),a("sequence_errors").length=0,a("seq_error",!1),a("then_ready",!0),a("or_queue").length=0,e.val(function(){return n.messages.apply(r,arguments)}),f.length>0&&n.__schedule(function(){e.or.apply(r,f)})}}),e}}),n.extend("pCatch",function(n,e){return function(t){return e("seq_aborted")?n:(n.pThen(void 0,t),n)}}),n.extend("race",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments).map(function(e){var t;return n.isSequence(e)?(t={fn:e},l(t),function(n){t.fn.pipe(n)}):e});return e.then(function(){var n=t.call(arguments);u.forEach(function(e){e.apply(r,n)})}),e}}),n.react=function(e){function a(){if(c){var e=c.duplicate();return e.unpause.apply(r,arguments),e}return n().val(function(){throw"Disabled Sequence"})}function u(){c&&(c=null,i.forEach(function(n){n()}),i.length=0)}function l(n){c&&"function"==typeof n&&i.push(n)}var c,i=[];return a.onStream=function(){t.call(arguments).forEach(function(n){n.on("data",a),n.on("error",a)})},a.unStream=function(){t.call(arguments).forEach(function(n){n.removeListener("data",a),n.removeListener("error",a)})},n(function(){e.call(c,a,l)}),c=n().duplicate(),c.stop=u,c},n.extend("runner",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments),l={};return e.then(function(e){var a,c,i,o=l;l.messages=t.call(arguments,1),a=u.map(function(t){var a=t;return"function"==typeof t&&t.constructor&&"GeneratorFunction"===t.constructor.name?a=t.call(r,o):n.isSequence(t)&&"next"in t||(a=n.iterable().val(t)),n.isSequence(a)&&a.or(function(){e.fail.apply(r,arguments)}),a}),u=null,function s(){var t;c=a.shift();try{i=n.isMessageWrapper(o)&&n.isSequence(c)?c.next.apply(r,o):c.next(o)}catch(u){return e.fail(u)}i.value===l?(a.push(c),o=l,n(s)):(n.isSequence(i.value)||(t=typeof i.value,i.value=null!==i.value&&("object"===t||"function"===t)&&"then"in i.value?n().promise(i.value):n.isMessageWrapper(i.value)?n.apply(r,i.value):"undefined"!=typeof i.value?n(i.value):n()),i.value.val(function(){arguments.length>0&&(o=arguments.length>1?n.messages.apply(r,arguments):arguments[0]),i.done||(o===l?a.push(c):a.unshift(c)),a.length>0?s():"undefined"!=typeof o?n.isMessageWrapper(o)?e.apply(r,o):e(o):e()}).or(function(){c["throw"].apply(r,arguments)}))}()}),e}}),n.extend("toPromise",function(e){return function(){return new Promise(function(a,u){e.val(function(){var e=t.call(arguments);return a.call(r,e.length>1?e:e[0]),n.messages.apply(r,e)}).or(function(){var n=t.call(arguments);u.call(r,n.length>1?n:n[0])})})}}),n.extend("try",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments).map(function(e){return function(a){var u=t.call(arguments),l=n.apply(r,u.slice(1));l.then(function(){e.apply(r,arguments)}).val(function(){a.apply(r,arguments)}).or(function(){var e=n.messages.apply(r,arguments);a({"catch":e.length>1?e:e[0]})})}});return e.then.apply(r,u),e}}),n.extend("until",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments).map(function(e){return function a(u){var l=t.call(arguments),c=n.apply(r,l.slice(1));c.then(function(){var n=t.call(arguments);n[0]["break"]=function(){u.fail.apply(r,arguments),c.abort()},e.apply(r,n)}).val(function(){u.apply(r,arguments)}).or(function(){a.apply(r,l)})}});return e.then.apply(r,u),e}}),n.extend("waterfall",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=n.messages();return t.call(arguments).forEach(function(t){e.then(t).val(function(){var e=n.messages.apply(r,arguments);return u.push(e.length>1?e:e[0]),u})}),e}}),n.wrap=function(e,a){var u,l,c;if(a=a&&"object"==typeof a?a:{},a.errfcb&&a.splitcb||a.errfcb&&a.simplecb||a.splitcb&&a.simplecb||"errfcb"in a&&!a.errfcb&&!a.splitcb&&!a.simplecb||a.params_first&&a.params_last)throw Error("Invalid options");return u=a.errfcb||!(a.splitcb||a.simplecb),l=!!a.params_first||!a.params_last&&!("params_first"in a||a.params_first)||"params_last"in a&&!a.params_first&&!a.params_last,c=l?"push":"unshift",u?function(){var a=t.call(arguments);return n(function(n){a[c](n.errfcb),e.apply(r,a)})}:a.splitcb?function(){var a=t.call(arguments);return n(function(n){a[c](n,n.fail),e.apply(r,a)})}:a.simplecb?function(){var a=t.call(arguments);return n(function(n){a[c](n),e.apply(r,a)})}:void 0},n});
