/*! asynquence-contrib
    v0.2.3-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e){"undefined"!=typeof module&&module.exports?(module.exports=function t(n){try{n=require(n)}catch(r){return t}return e(n)},module.exports=module.exports(require("path").join("..",n))):"function"==typeof define&&define.amd?define([n],e):e(n)}(this.ASQ||"asynquence",function(n){"use strict";var e=Array.prototype.slice,t=Object.create(null),r="__ASQ__";return n.extend("all",function(n){return n.gate}),n.extend("any",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments);return r.then(function(r){function a(){var n;o===u.length&&(n=[],l?(u.forEach(function(e,t){n.push(s["s"+t])}),r.apply(t,n)):(u.forEach(function(e,t){n.push(c["s"+t])}),r.fail.apply(t,n)))}var l=!1,o=0,s={},c={},i=n.apply(t,e.call(arguments,1));u=u.map(function(u,i){return function(f){var p=e.call(arguments);p[0]=function(){l=!0,o++,s["s"+i]=arguments.length>1?n.messages.apply(t,arguments):arguments[0],a()},p[0].fail=function(){o++,c["s"+i]=arguments.length>1?n.messages.apply(t,arguments):arguments[0],a()},p[0].abort=function(){l||(f.abort(),r.abort())},u.apply(t,p)}}),i.gate.apply(t,u)}),r}}),n.extend("errfcb",function(n){return function(){var a={then:function(n){return a.then_cb=n,a},or:function(n){return a.or_cb=n,a},next:!0,defer:function(){}};return a[r]=!0,n.seq(a),function(n){n?a.or_cb(n):a.then_cb.apply(t,e.call(arguments,1))}}}),n.extend("first",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments);return r.then(function(r){var a=0,l={},o=!1,s=n.apply(t,e.call(arguments,1));u=u.map(function(c,i){return function(f){var p=e.call(arguments);p[0]=function(){o||(o=!0,a++,r(arguments.length>1?n.messages.apply(t,arguments):arguments[0]),s.abort())},p[0].fail=function(){var e=[];a++,l["s"+i]=arguments.length>1?n.messages.apply(t,arguments):arguments[0],o||a!==u.length||(u.forEach(function(n,t){e.push(l["s"+t])}),r.fail.apply(t,e))},p[0].abort=function(){o||(f.abort(),r.abort())},c.apply(t,p)}}),s.gate.apply(t,u)}),r}}),function(){var a;n.iterable=function(){function u(n){return"undefined"!=typeof setImmediate?setImmediate(n):setTimeout(n,0)}function l(){throw 1===E.length?E[0]:E}function o(){var n;if(d=null,b)for(0!==S.length||q||(q=!0,l());S.length>0;){q=!0,n=S.shift();try{n.apply(t,E)}catch(e){checkBranding(e)?E=E.concat(e):(E.push(e),e.stack&&E.push(e.stack)),0===S.length&&l()}}}function s(){return b||_||0===arguments.length?v:(x.push.apply(x,arguments),v)}function c(){return _||0===arguments.length?v:(S.push.apply(S,arguments),d||(d=u(o)),v)}function i(){return _||0===arguments.length?v:(e.call(arguments).forEach(function(n){s(n).or(n.fail)}),v)}function f(){if(b||_||0===x.length)return x.length>0&&p("Sequence cannot be iterated"),{done:!0};try{return{value:x.shift().apply(t,arguments)}}catch(e){return n.isMessageWrapper(e)?p.apply(t,e):e.stack?p(e,e.stack):p(e),{}}}function p(){return b||_?v:(E.push.apply(E,arguments),b=!0,d||(d=u(o)),v)}function g(){b||_||(_=!0,clearTimeout(d),d=null,x.length=S.length=E.length=0)}function m(){var e;return a={val_queue:x.slice(),or_queue:S.slice()},e=n.iterable(),a=null,e}function h(){return S.push(function(){}),v}function y(n){return Object.defineProperty(n,r,{enumerable:!1,value:!0}),n}var v,d,b=!1,q=!1,_=!1,x=[],S=[],E=[];return v=y({val:s,then:s,or:c,pipe:i,next:f,"throw":p,abort:g,duplicate:m,defer:h}),v["object"==typeof Symbol&&null!=Symbol&&Symbol.iterator||"@@iterator"]=function(){return v},a&&(x=a.val_queue.slice(0),S=a.or_queue.slice(0)),v.val.apply(t,arguments),v}}(),n.extend("last",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments);return r.then(function(r){function a(){var n;o===u.length&&(n=[],l?r(s):(u.forEach(function(e,t){n.push(c["s"+t])}),r.fail.apply(t,n)))}var l=!1,o=0,s={},c={},i=n.apply(t,e.call(arguments,1));u=u.map(function(u,i){return function(f){var p=e.call(arguments);p[0]=function(){l=!0,o++,s=arguments.length>1?n.messages.apply(t,arguments):arguments[0],a()},p[0].fail=function(){o++,c["s"+i]=arguments.length>1?n.messages.apply(t,arguments):arguments[0],a()},p[0].abort=function(){l||(f.abort(),r.abort())},u.apply(t,p)}}),i.gate.apply(t,u)}),r}}),n.extend("map",function(r,a){return function(u,l){return a("seq_error")||a("seq_aborted")?r:(r.seq(function(){var r,a=e.call(arguments);return l||(l=a.shift()),u||(u=a.shift()),"function"==typeof u&&Array.isArray(l)&&(r=u,u=l,l=r),n.apply(t,a).gate.apply(t,u.map(function(n){return function(){l.apply(t,[n].concat(e.call(arguments)))}}))}).val(function(){return e.call(arguments)}),r)}}),n.extend("none",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments);return r.then(function(r){function a(){var n;o===u.length&&(n=[],l?(u.forEach(function(e,t){n.push(s["s"+t])}),r.fail.apply(t,n)):(u.forEach(function(e,t){n.push(c["s"+t])}),r.apply(t,n)))}var l=!1,o=0,s={},c={},i=n.apply(t,e.call(arguments,1));u=u.map(function(u,i){return function(f){var p=e.call(arguments);p[0]=function(){l=!0,o++,s["s"+i]=arguments.length>1?n.messages.apply(t,arguments):arguments[0],a()},p[0].fail=function(){o++,c["s"+i]=arguments.length>1?n.messages.apply(t,arguments):arguments[0],a()},p[0].abort=function(){l||(f.abort(),r.abort())},u.apply(t,p)}}),i.gate.apply(t,u)}),r}}),n.react=function(r){function a(){if(o){var e=o.duplicate();return e.unpause.apply(t,arguments),e}return n().val(function(){throw"Disabled Sequence"})}function u(){o&&(o=null,s.forEach(function(n){n()}),s.length=0)}function l(n){o&&"function"==typeof n&&s.push(n)}var o,s=[];return a.onStream=function(){e.call(arguments).forEach(function(n){n.on("data",a),n.on("error",a)})},a.unStream=function(){e.call(arguments).forEach(function(n){n.removeListener("data",a),n.removeListener("error",a)})},n(function(){r.call(o,a,l)}),o=n().duplicate(),o.stop=u,o},n.extend("runner",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments),l={};return r.then(function(r){var a,o,s,c=l;l.messages=e.call(arguments,1),a=u.map(function(e){var a=e;return"function"==typeof e&&e.constructor&&"GeneratorFunction"===e.constructor.name?a=e.call(t,c):n.isSequence(e)&&"next"in e||(a=n.iterable().val(e)),n.isSequence(a)&&a.or(function(){r.fail.apply(t,arguments)}),a}),u=null,function i(){var e;o=a.shift();try{s=n.isMessageWrapper(c)&&n.isSequence(o)?o.next.apply(t,c):o.next(c)}catch(u){return r.fail(u)}s.value===l?(a.push(o),c=l,n(i)):(n.isSequence(s.value)||(e=typeof s.value,s.value=null!==s.value&&("object"===e||"function"===e)&&"then"in s.value?n().promise(s.value):n.isMessageWrapper(s.value)?n.apply(t,s.value):"undefined"!=typeof s.value?n(s.value):n()),s.value.val(function(){arguments.length>0&&(c=arguments.length>1?n.messages.apply(t,arguments):arguments[0]),s.done||(c===l?a.push(o):a.unshift(o)),a.length>0?i():"undefined"!=typeof c?n.isMessageWrapper(c)?r.apply(t,c):r(c):r()}).or(function(){o["throw"].apply(t,arguments)}))}()}),r}}),n.extend("toPromise",function(r){return function(){return new Promise(function(a,u){r.val(function(){var r=e.call(arguments);return a.call(t,r.length>1?r:r[0]),n.messages.apply(t,r)}).or(function(){var n=e.call(arguments);u.call(t,n.length>1?n:n[0])})})}}),n.extend("try",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments).map(function(r){return function(a){var u=e.call(arguments),l=n.apply(t,u.slice(1));l.then(function(){r.apply(t,arguments)}).val(function(){a.apply(t,arguments)}).or(function(){var e=n.messages.apply(t,arguments);a({"catch":e.length>1?e:e[0]})})}});return r.then.apply(t,u),r}}),n.extend("until",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=e.call(arguments).map(function(r){return function a(u){var l=e.call(arguments),o=n.apply(t,l.slice(1));o.then(function(){var n=e.call(arguments);n[0]["break"]=function(){u.fail.apply(t,arguments),o.abort()},r.apply(t,n)}).val(function(){u.apply(t,arguments)}).or(function(){a.apply(t,l)})}});return r.then.apply(t,u),r}}),n.extend("waterfall",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=n.messages();return e.call(arguments).forEach(function(e){r.then(e).val(function(){var e=n.messages.apply(t,arguments);return u.push(e.length>1?e:e[0]),u})}),r}}),n});
