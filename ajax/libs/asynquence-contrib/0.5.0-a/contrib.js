/*! asynquence-contrib
    v0.5.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e){"undefined"!=typeof module&&module.exports?(module.exports=function t(n){if("string"==typeof n)try{n=require(n)}catch(r){return t}return e(n)},"string"==typeof n&&(module.exports=module.exports(require("path").join("..",n)))):"function"==typeof define&&define.amd?define([n],e):e(n)}(this.ASQ||"asynquence",function(n){"use strict";function e(e,u,a,o,c){u=u.map(function(e,u){var i;return n.isSequence(e)?(i={fn:e},l(i),function(n){i.fn.val(function(){a(n,u,t.call(arguments))}).or(function(){o(n,u,t.call(arguments))})}):function(n){var l=t.call(arguments);l[0]=function(){a(n,u,t.call(arguments))},l[0].fail=function(){o(n,u,t.call(arguments))},l[0].abort=function(){c()},l[0].errfcb=function(e){e?o(n,u,[e]):a(n,u,t.call(arguments,1))},e.apply(r,l)}}),e.then(function(){var n=t.call(arguments);u.forEach(function(e){e.apply(r,n)})})}var t=Array.prototype.slice,r=Object.create(null),u="__ASQ__",a=n.__schedule,l=n.__tapSequence;return n.extend("after",function(n){return function(e){var u=arguments.length>1?t.call(arguments,1):void 0;return e=+e||0,n.then(function(n){u=u||t.call(arguments,1),setTimeout(function(){n.apply(r,u)},e)}),n}}),n.after=function(){return n().after.apply(r,arguments)},n.extend("any",function(u,a){return function(){function l(){g=!0,p.length=0,h.length=0}function o(n){h.length>0?(h.length=s.length,n.apply(r,h)):(p.length=s.length,n.fail.apply(r,p)),l()}function c(e,t,u){g||(f++,h[t]=u.length>1?n.messages.apply(r,u):u[0],f===s.length&&(g=!0,o(e)))}function i(e,t,u){g||t in p||(f++,p[t]=u.length>1?n.messages.apply(r,u):u[0]),g||f!==s.length||(g=!0,o(e))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var s,f=0,p=[],g=!1,h=[];return s=t.call(arguments),e(u,s,c,i,l),u}}),n.extend("errfcb",function(n){return function(){var e={val:function(n){return e.val_cb=n,e},or:function(n){return e.or_cb=n,e}};return e[u]=!0,n.seq(e),function(n){n?e.or_cb(n):e.val_cb.apply(r,t.call(arguments,1))}}}),n.extend("failAfter",function(n){return function(e){var u=arguments.length>1?t.call(arguments,1):void 0;return e=+e||0,n.then(function(n){setTimeout(function(){n.fail.apply(r,u)},e)}),n}}),n.failAfter=function(){return n().failAfter.apply(r,arguments)},n.extend("first",function(u,a){return function(){function l(){f.length=0}function o(e,t,u){p||(p=!0,e(u.length>1?n.messages.apply(r,u):u[0]),l())}function c(e,t,u){p||t in f||(s++,f[t]=u.length>1?n.messages.apply(r,u):u[0],s===i.length&&(p=!0,f.length=i.length,e.fail.apply(r,f),l()))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var i,s=0,f=[],p=!1;return i=t.call(arguments),e(u,i,o,c,l),u}}),function(){var e;n.iterable=function(){function l(){throw 1===A.length?A[0]:A}function o(){var n;if(d=null,q)for(0!==S.length||_||(_=!0,l());S.length>0;){_=!0,n=S.shift();try{n.apply(r,A)}catch(e){checkBranding(e)?A=A.concat(e):(A.push(e),e.stack&&A.push(e.stack)),0===S.length&&l()}}}function c(){return q||b||0===arguments.length?v:(x.push.apply(x,arguments),v)}function i(){return b||0===arguments.length?v:(S.push.apply(S,arguments),d||(d=a(o)),v)}function s(){return b||0===arguments.length?v:(t.call(arguments).forEach(function(n){c(n).or(n.fail)}),v)}function f(){if(q||b||0===x.length)return x.length>0&&p("Sequence cannot be iterated"),{done:!0};try{return{value:x.shift().apply(r,arguments)}}catch(e){return n.isMessageWrapper(e)?p.apply(r,e):e.stack?p(e,e.stack):p(e),{}}}function p(){return q||b?v:(A.push.apply(A,arguments),q=!0,d||(d=a(o)),v)}function g(){q||b||(b=!0,clearTimeout(d),d=null,x.length=S.length=A.length=0)}function h(){var t;return e={val_queue:x.slice(),or_queue:S.slice()},t=n.iterable(),e=null,t}function m(){return S.push(function(){}),v}function y(n){return Object.defineProperty(n,u,{enumerable:!1,value:!0}),n}var v,d,q=!1,_=!1,b=!1,x=[],S=[],A=[];return v=y({val:c,then:c,or:i,pipe:s,next:f,"throw":p,abort:g,duplicate:h,defer:m}),v["object"==typeof Symbol&&null!=Symbol&&Symbol.iterator||"@@iterator"]=function(){return v},e&&(x=e.val_queue.slice(0),S=e.or_queue.slice(0)),v.val.apply(r,arguments),v}}(),n.extend("last",function(u,a){return function(){function l(){h=!0,g.length=0,f=null}function o(e){null!=f?e(f.length>1?n.messages.apply(r,f):f[0]):(g.length=s.length,e.fail.apply(r,g)),l()}function c(n,e,t){h||(p++,f=t,p===s.length&&(h=!0,o(n)))}function i(e,t,u){h||t in g||(p++,g[t]=u.length>1?n.messages.apply(r,u):u[0]),h||p!==s.length||(h=!0,o(e))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var s,f,p=0,g=[],h=!1;return s=t.call(arguments),e(u,s,c,i,l),u}}),n.extend("map",function(e,u){return function(a,l){return u("seq_error")||u("seq_aborted")?e:(e.seq(function(){var e,u=t.call(arguments);return l||(l=u.shift()),a||(a=u.shift()),"function"==typeof a&&Array.isArray(l)&&(e=a,a=l,l=e),n.apply(r,u).gate.apply(r,a.map(function(n){return function(){l.apply(r,[n].concat(t.call(arguments)))}}))}).val(function(){return t.call(arguments)}),e)}}),n.extend("none",function(u,a){return function(){function l(){g=!0,p.length=0,h.length=0}function o(n){h.length>0?(h.length=s.length,n.fail.apply(r,h)):(p.length=s.length,n.apply(r,p)),l()}function c(e,t,u){g||(f++,h[t]=u.length>1?n.messages.apply(r,u):u[0],f===s.length&&(g=!0,o(e)))}function i(e,t,u){g||t in p||(f++,p[t]=u.length>1?n.messages.apply(r,u):u[0]),g||f!==s.length||(g=!0,o(e))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var s,f=0,p=[],g=!1,h=[];return s=t.call(arguments),e(u,s,c,i,l),u}}),n.extend("pThen",function(e,u){return function(a,l){if(u("seq_aborted"))return e;var o=!1,c=!1;return"function"==typeof a&&e.then(function(e){if(o)e.apply(r,t.call(arguments,1));else{var u,l=n.messages.apply(r,arguments);l.shift(),1===l.length&&(l=l[0]),c=!0;try{u=a(l)}catch(i){return n.isMessageWrapper(i)||(i=[i]),void e.fail.apply(r,i)}n.isSequence(u)?u.pipe(e):n.isMessageWrapper(u)?e.apply(r,u):("object"==typeof u||"function"==typeof u)&&"then"in u?u.then(e,e.fail):e(u)}}),"function"==typeof l&&e.or(function(){if(!c){var a,i,s=n.messages.apply(r,arguments),f=t.call(u("or_queue"));1===s.length&&(s=s[0]),o=!0,a=l(s),i=u("sequence_messages"),i.length=0,"undefined"!=typeof a&&(n.isMessageWrapper(a)||(a=[a]),i.push.apply(i,a)),u("sequence_errors").length=0,u("seq_error",!1),u("then_ready",!0),u("or_queue").length=0,e.val(function(){return n.messages.apply(r,arguments)}),f.length>0&&n.__schedule(function(){e.or.apply(r,f)})}}),e}}),n.extend("pCatch",function(n,e){return function(t){return e("seq_aborted")?n:(n.pThen(void 0,t),n)}}),n.extend("race",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments).map(function(e){var t;return n.isSequence(e)?(t={fn:e},l(t),function(n){t.fn.pipe(n)}):e});return e.then(function(){var n=t.call(arguments);a.forEach(function(e){e.apply(r,n)})}),e}}),n.react=function(e){function u(){if(o){var e=o.duplicate();return e.unpause.apply(r,arguments),e}return n().val(function(){throw"Disabled Sequence"})}function a(){o&&(o=null,c.forEach(function(n){n()}),c.length=0)}function l(n){o&&"function"==typeof n&&c.push(n)}var o,c=[];return u.onStream=function(){t.call(arguments).forEach(function(n){n.on("data",u),n.on("error",u)})},u.unStream=function(){t.call(arguments).forEach(function(n){n.removeListener("data",u),n.removeListener("error",u)})},n(function(){e.call(o,u,l)}),o=n().duplicate(),o.stop=a,o},n.extend("runner",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments),l={};return e.then(function(e){var u,o,c,i=l;l.messages=t.call(arguments,1),u=a.map(function(t){var u=t;return"function"==typeof t&&t.constructor&&"GeneratorFunction"===t.constructor.name?u=t.call(r,i):n.isSequence(t)&&"next"in t||(u=n.iterable().val(t)),n.isSequence(u)&&u.or(function(){e.fail.apply(r,arguments)}),u}),a=null,function s(){var t;o=u.shift();try{c=n.isMessageWrapper(i)&&n.isSequence(o)?o.next.apply(r,i):o.next(i)}catch(a){return e.fail(a)}c.value===l?(u.push(o),i=l,n(s)):(n.isSequence(c.value)||(t=typeof c.value,c.value=null!==c.value&&("object"===t||"function"===t)&&"then"in c.value?n().promise(c.value):n.isMessageWrapper(c.value)?n.apply(r,c.value):"undefined"!=typeof c.value?n(c.value):n()),c.value.val(function(){arguments.length>0&&(i=arguments.length>1?n.messages.apply(r,arguments):arguments[0]),c.done||(i===l?u.push(o):u.unshift(o)),u.length>0?s():"undefined"!=typeof i?n.isMessageWrapper(i)?e.apply(r,i):e(i):e()}).or(function(){o["throw"].apply(r,arguments)}))}()}),e}}),n.extend("toPromise",function(e){return function(){return new Promise(function(u,a){e.val(function(){var e=t.call(arguments);return u.call(r,e.length>1?e:e[0]),n.messages.apply(r,e)}).or(function(){var n=t.call(arguments);a.call(r,n.length>1?n:n[0])})})}}),n.extend("try",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments).map(function(e){return function(u){var a=t.call(arguments),l=n.apply(r,a.slice(1));l.then(function(){e.apply(r,arguments)}).val(function(){u.apply(r,arguments)}).or(function(){var e=n.messages.apply(r,arguments);u({"catch":e.length>1?e:e[0]})})}});return e.then.apply(r,a),e}}),n.extend("until",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments).map(function(e){return function u(a){var l=t.call(arguments),o=n.apply(r,l.slice(1));o.then(function(){var n=t.call(arguments);n[0]["break"]=function(){a.fail.apply(r,arguments),o.abort()},e.apply(r,n)}).val(function(){a.apply(r,arguments)}).or(function(){u.apply(r,l)})}});return e.then.apply(r,a),e}}),n.extend("waterfall",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=n.messages();return t.call(arguments).forEach(function(t){e.then(t).val(function(){var e=n.messages.apply(r,arguments);return a.push(e.length>1?e:e[0]),a})}),e}}),n});
