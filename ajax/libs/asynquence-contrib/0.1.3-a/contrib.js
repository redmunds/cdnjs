/*! asynquence-contrib
    v0.1.2-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,t){"undefined"!=typeof module&&module.exports?module.exports=t(require(n)):"function"==typeof define&&define.amd?define([n],t):t(n)}(this.ASQ||"asynquence",function(n){"use strict";var t=Array.prototype.slice,e=Object.create(null);return n.extend("all",function(n){return n.gate}),n.extend("any",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=t.call(arguments);return r.then(function(r){function a(){var n;s===u.length&&(n=[],l?(u.forEach(function(t,e){n.push(o["s"+e])}),r.apply(e,n)):(u.forEach(function(t,e){n.push(c["s"+e])}),r.fail.apply(e,n)))}var l=!1,s=0,o={},c={},i=n.apply(e,t.call(arguments,1));u=u.map(function(u,i){return function(p){var f=t.call(arguments);f[0]=function(){l=!0,s++,o["s"+i]=arguments.length>1?n.messages.apply(e,arguments):arguments[0],a()},f[0].fail=function(){s++,c["s"+i]=arguments.length>1?n.messages.apply(e,arguments):arguments[0],a()},f[0].abort=function(){l||(p.abort(),r.abort())},u.apply(e,f)}}),i.gate.apply(e,u)}),r}}),n.extend("errfcb",function(n){return function(){var r={then:function(n){return r.then_cb=n,r},or:function(n){return r.or_cb=n,r},__ASQ__:!0,next:!0};return n.seq(r),function(n){n?r.or_cb(n):r.then_cb.apply(e,t.call(arguments,1))}}}),n.extend("first",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=t.call(arguments);return r.then(function(r){var a=0,l={},s=!1,o=n.apply(e,t.call(arguments,1));u=u.map(function(c,i){return function(p){var f=t.call(arguments);f[0]=function(){s||(s=!0,a++,r(arguments.length>1?n.messages.apply(e,arguments):arguments[0]),o.abort())},f[0].fail=function(){var t=[];a++,l["s"+i]=arguments.length>1?n.messages.apply(e,arguments):arguments[0],s||a!==u.length||(u.forEach(function(n,e){t.push(l["s"+e])}),r.fail.apply(e,t))},f[0].abort=function(){s||(p.abort(),r.abort())},c.apply(e,f)}}),o.gate.apply(e,u)}),r}}),n.iterable=function(){function t(n){return"undefined"!=typeof setImmediate?setImmediate(n):setTimeout(n,0)}function e(){var n;if(p=null,b.length>0)for(;d.length>0;){n=d.shift();try{n.apply(m,b)}catch(t){checkBranding(t)?b=b.concat(t):(b.push(t),t.stack&&b.push(t.stack)),0===d.length&&console.error.apply(console,b)}}}function r(){return h||y||0===arguments.length?i:(v.push.apply(v,arguments),i)}function a(){return y||0===arguments.length?i:(d.push.apply(d,arguments),p||(p=t(e)),i)}function u(){return y||0===arguments.length?i:(f.call(arguments).forEach(function(n){r(n).or(n.fail)}),i)}function l(){var t={value:void 0,done:!0};if(h||y||0===v.length)return s("Sequence cannot be iterated"),t;try{t.value=v.shift().apply(m,arguments)}catch(e){n.isMessageWrapper(e)?s.apply(m,e):e.stack?s(e,e.stack):s(e)}return t.done=0===v.length,t}function s(){return h||y?i:(b.push.apply(b,arguments),h=!0,p||(p=t(e)),i)}function o(){h||y||(y=!0,clearTimeout(p),p=null,v.length=0,d.length=0,b.length=0)}function c(n){return Object.defineProperty(n,g,{enumerable:!1,value:!0}),n}var i,p,f=Array.prototype.slice,g="__ASQ__",m=Object.create(null),h=!1,y=!1,v=[],d=[],b=[];return i=c({val:r,then:r,or:a,pipe:u,next:l,"throw":s,abort:o}),i.val.apply(m,arguments),i},n.extend("last",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=t.call(arguments);return r.then(function(r){function a(){var n;s===u.length&&(n=[],l?r(o):(u.forEach(function(t,e){n.push(c["s"+e])}),r.fail.apply(e,n)))}var l=!1,s=0,o={},c={},i=n.apply(e,t.call(arguments,1));u=u.map(function(u,i){return function(p){var f=t.call(arguments);f[0]=function(){l=!0,s++,o=arguments.length>1?n.messages.apply(e,arguments):arguments[0],a()},f[0].fail=function(){s++,c["s"+i]=arguments.length>1?n.messages.apply(e,arguments):arguments[0],a()},f[0].abort=function(){l||(p.abort(),r.abort())},u.apply(e,f)}}),i.gate.apply(e,u)}),r}}),n.extend("none",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=t.call(arguments);return r.then(function(r){function a(){var n;s===u.length&&(n=[],l?(u.forEach(function(t,e){n.push(o["s"+e])}),r.fail.apply(e,n)):(u.forEach(function(t,e){n.push(c["s"+e])}),r.apply(e,n)))}var l=!1,s=0,o={},c={},i=n.apply(e,t.call(arguments,1));u=u.map(function(u,i){return function(p){var f=t.call(arguments);f[0]=function(){l=!0,s++,o["s"+i]=arguments.length>1?n.messages.apply(e,arguments):arguments[0],a()},f[0].fail=function(){s++,c["s"+i]=arguments.length>1?n.messages.apply(e,arguments):arguments[0],a()},f[0].abort=function(){l||(p.abort(),r.abort())},u.apply(e,f)}}),i.gate.apply(e,u)}),r}}),n.extend("try",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=t.call(arguments).map(function(r){return function(a){var u=t.call(arguments),l=n.apply(e,u.slice(1));l.then(function(){r.apply(e,arguments)}).val(function(){a.apply(e,arguments)}).or(function(){var t=n.messages.apply(e,arguments);a({"catch":t.length>1?t:t[0]})})}});return r.then.apply(e,u),r}}),n.extend("until",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=t.call(arguments).map(function(r){return function a(u){var l=t.call(arguments),s=n.apply(e,l.slice(1));s.then(function(){var n=t.call(arguments);n[0].break=function(){u.fail.apply(e,arguments),s.abort()},r.apply(e,n)}).val(function(){u.apply(e,arguments)}).or(function(){a.apply(e,l)})}});return r.then.apply(e,u),r}}),n.extend("waterfall",function(r,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return r;var u=n.messages();return t.call(arguments).forEach(function(t){r.then(t).val(function(){var t=n.messages.apply(e,arguments);return u.push(t.length>1?t:t[0]),u})}),r}}),{}});
