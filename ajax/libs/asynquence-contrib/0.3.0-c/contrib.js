/*! asynquence-contrib
    v0.3.0-c (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e){"undefined"!=typeof module&&module.exports?(module.exports=function t(n){try{n=require(n)}catch(r){return t}return e(n)},module.exports=module.exports(require("path").join("..",n))):"function"==typeof define&&define.amd?define([n],e):e(n)}(this.ASQ||"asynquence",function(n){"use strict";function e(e,u,a,c,o){u=u.map(function(e,u){var i;return n.isSequence(e)?(i={fn:e},l(i),function(n){i.fn.val(function(){a(n,u,t.call(arguments))}).or(function(){c(n,u,t.call(arguments))})}):function(n){var l=t.call(arguments);l[0]=function(){a(n,u,t.call(arguments))},l[0].fail=function(){c(n,u,t.call(arguments))},l[0].abort=function(){o()},l[0].errfcb=function(e){e?c(n,u,[e]):a(n,u,t.call(arguments,1))},e.apply(r,l)}}),e.then(function(){var n=t.call(arguments);u.forEach(function(e){e.apply(r,n)})})}var t=Array.prototype.slice,r=Object.create(null),u="__ASQ__",a=n.__schedule,l=n.__tapSequence;return n.extend("any",function(u,a){return function(){function l(){g=!0,p.length=0,h.length=0}function c(n){h.length>0?(h.length=s.length,n.apply(r,h)):(p.length=s.length,n.fail.apply(r,p)),l()}function o(e,t,u){g||(f++,h[t]=u.length>1?n.messages.apply(r,u):u[0],f===s.length&&(g=!0,c(e)))}function i(e,t,u){g||t in p||(f++,p[t]=u.length>1?n.messages.apply(r,u):u[0]),g||f!==s.length||(g=!0,c(e))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var s,f=0,p=[],g=!1,h=[];return s=t.call(arguments),e(u,s,o,i,l),u}}),n.extend("errfcb",function(n){return function(){var e={val:function(n){return e.val_cb=n,e},or:function(n){return e.or_cb=n,e}};return e[u]=!0,n.seq(e),function(n){n?e.or_cb(n):e.val_cb.apply(r,t.call(arguments,1))}}}),n.failAfter=function(e){var u=t.call(arguments,1);return e=+e||0,n(function(n){setTimeout(function(){n.fail.apply(r,u)},e)})},n.extend("first",function(u,a){return function(){function l(){f.length=0}function c(e,t,u){p||(p=!0,e(u.length>1?n.messages.apply(r,u):u[0]),l())}function o(e,t,u){p||t in f||(s++,f[t]=u.length>1?n.messages.apply(r,u):u[0],s===i.length&&(p=!0,f.length=i.length,e.fail.apply(r,f),l()))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var i,s=0,f=[],p=!1;return i=t.call(arguments),e(u,i,c,o,l),u}}),function(){var e;n.iterable=function(){function l(){throw 1===E.length?E[0]:E}function c(){var n;if(d=null,q)for(0!==S.length||_||(_=!0,l());S.length>0;){_=!0,n=S.shift();try{n.apply(r,E)}catch(e){checkBranding(e)?E=E.concat(e):(E.push(e),e.stack&&E.push(e.stack)),0===S.length&&l()}}}function o(){return q||b||0===arguments.length?v:(x.push.apply(x,arguments),v)}function i(){return b||0===arguments.length?v:(S.push.apply(S,arguments),d||(d=a(c)),v)}function s(){return b||0===arguments.length?v:(t.call(arguments).forEach(function(n){o(n).or(n.fail)}),v)}function f(){if(q||b||0===x.length)return x.length>0&&p("Sequence cannot be iterated"),{done:!0};try{return{value:x.shift().apply(r,arguments)}}catch(e){return n.isMessageWrapper(e)?p.apply(r,e):e.stack?p(e,e.stack):p(e),{}}}function p(){return q||b?v:(E.push.apply(E,arguments),q=!0,d||(d=a(c)),v)}function g(){q||b||(b=!0,clearTimeout(d),d=null,x.length=S.length=E.length=0)}function h(){var t;return e={val_queue:x.slice(),or_queue:S.slice()},t=n.iterable(),e=null,t}function m(){return S.push(function(){}),v}function y(n){return Object.defineProperty(n,u,{enumerable:!1,value:!0}),n}var v,d,q=!1,_=!1,b=!1,x=[],S=[],E=[];return v=y({val:o,then:o,or:i,pipe:s,next:f,"throw":p,abort:g,duplicate:h,defer:m}),v["object"==typeof Symbol&&null!=Symbol&&Symbol.iterator||"@@iterator"]=function(){return v},e&&(x=e.val_queue.slice(0),S=e.or_queue.slice(0)),v.val.apply(r,arguments),v}}(),n.extend("last",function(u,a){return function(){function l(){h=!0,g.length=0,f=null}function c(e){null!=f?e(f.length>1?n.messages.apply(r,f):f[0]):(g.length=s.length,e.fail.apply(r,g)),l()}function o(n,e,t){h||(p++,f=t,p===s.length&&(h=!0,c(n)))}function i(e,t,u){h||t in g||(p++,g[t]=u.length>1?n.messages.apply(r,u):u[0]),h||p!==s.length||(h=!0,c(e))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var s,f,p=0,g=[],h=!1;return s=t.call(arguments),e(u,s,o,i,l),u}}),n.extend("map",function(e,u){return function(a,l){return u("seq_error")||u("seq_aborted")?e:(e.seq(function(){var e,u=t.call(arguments);return l||(l=u.shift()),a||(a=u.shift()),"function"==typeof a&&Array.isArray(l)&&(e=a,a=l,l=e),n.apply(r,u).gate.apply(r,a.map(function(n){return function(){l.apply(r,[n].concat(t.call(arguments)))}}))}).val(function(){return t.call(arguments)}),e)}}),n.extend("none",function(u,a){return function(){function l(){g=!0,p.length=0,h.length=0}function c(n){h.length>0?(h.length=s.length,n.fail.apply(r,h)):(p.length=s.length,n.apply(r,p)),l()}function o(e,t,u){g||(f++,h[t]=u.length>1?n.messages.apply(r,u):u[0],f===s.length&&(g=!0,c(e)))}function i(e,t,u){g||t in p||(f++,p[t]=u.length>1?n.messages.apply(r,u):u[0]),g||f!==s.length||(g=!0,c(e))}if(a("seq_error")||a("seq_aborted")||0===arguments.length)return u;var s,f=0,p=[],g=!1,h=[];return s=t.call(arguments),e(u,s,o,i,l),u}}),n.extend("race",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments).map(function(e){var t;return n.isSequence(e)?(t={fn:e},l(t),function(n){t.fn.pipe(n)}):e});return e.then(function(){var n=t.call(arguments);a.forEach(function(e){e.apply(r,n)})}),e}}),n.react=function(e){function u(){if(c){var e=c.duplicate();return e.unpause.apply(r,arguments),e}return n().val(function(){throw"Disabled Sequence"})}function a(){c&&(c=null,o.forEach(function(n){n()}),o.length=0)}function l(n){c&&"function"==typeof n&&o.push(n)}var c,o=[];return u.onStream=function(){t.call(arguments).forEach(function(n){n.on("data",u),n.on("error",u)})},u.unStream=function(){t.call(arguments).forEach(function(n){n.removeListener("data",u),n.removeListener("error",u)})},n(function(){e.call(c,u,l)}),c=n().duplicate(),c.stop=a,c},n.extend("runner",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments),l={};return e.then(function(e){var u,c,o,i=l;l.messages=t.call(arguments,1),u=a.map(function(t){var u=t;return"function"==typeof t&&t.constructor&&"GeneratorFunction"===t.constructor.name?u=t.call(r,i):n.isSequence(t)&&"next"in t||(u=n.iterable().val(t)),n.isSequence(u)&&u.or(function(){e.fail.apply(r,arguments)}),u}),a=null,function s(){var t;c=u.shift();try{o=n.isMessageWrapper(i)&&n.isSequence(c)?c.next.apply(r,i):c.next(i)}catch(a){return e.fail(a)}o.value===l?(u.push(c),i=l,n(s)):(n.isSequence(o.value)||(t=typeof o.value,o.value=null!==o.value&&("object"===t||"function"===t)&&"then"in o.value?n().promise(o.value):n.isMessageWrapper(o.value)?n.apply(r,o.value):"undefined"!=typeof o.value?n(o.value):n()),o.value.val(function(){arguments.length>0&&(i=arguments.length>1?n.messages.apply(r,arguments):arguments[0]),o.done||(i===l?u.push(c):u.unshift(c)),u.length>0?s():"undefined"!=typeof i?n.isMessageWrapper(i)?e.apply(r,i):e(i):e()}).or(function(){c["throw"].apply(r,arguments)}))}()}),e}}),n.extend("toPromise",function(e){return function(){return new Promise(function(u,a){e.val(function(){var e=t.call(arguments);return u.call(r,e.length>1?e:e[0]),n.messages.apply(r,e)}).or(function(){var n=t.call(arguments);a.call(r,n.length>1?n:n[0])})})}}),n.extend("try",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments).map(function(e){return function(u){var a=t.call(arguments),l=n.apply(r,a.slice(1));l.then(function(){e.apply(r,arguments)}).val(function(){u.apply(r,arguments)}).or(function(){var e=n.messages.apply(r,arguments);u({"catch":e.length>1?e:e[0]})})}});return e.then.apply(r,a),e}}),n.extend("until",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=t.call(arguments).map(function(e){return function u(a){var l=t.call(arguments),c=n.apply(r,l.slice(1));c.then(function(){var n=t.call(arguments);n[0]["break"]=function(){a.fail.apply(r,arguments),c.abort()},e.apply(r,n)}).val(function(){a.apply(r,arguments)}).or(function(){u.apply(r,l)})}});return e.then.apply(r,a),e}}),n.extend("waterfall",function(e,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return e;var a=n.messages();return t.call(arguments).forEach(function(t){e.then(t).val(function(){var e=n.messages.apply(r,arguments);return a.push(e.length>1?e:e[0]),a})}),e}}),n});
