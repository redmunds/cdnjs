/*! asynquence-contrib
    v0.10.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e){"undefined"!=typeof module&&module.exports?(module.exports=function t(n){if("string"==typeof n)try{n=require(n)}catch(r){return t}return e(n)},"string"==typeof n&&(module.exports=module.exports(require("path").join("..",n)))):"function"==typeof define&&define.amd?define([n],e):e(n)}(this.ASQ||"asynquence",function(n){"use strict";function e(e,a,u,i,c){a=a.map(function(e,a){var o;return n.isSequence(e)?(o={fn:e},l(o),function(n){o.fn.val(function(){u(n,a,t.call(arguments))}).or(function(){i(n,a,t.call(arguments))})}):function(n){var l=t.call(arguments);l[0]=function(){u(n,a,t.call(arguments))},l[0].fail=function(){i(n,a,t.call(arguments))},l[0].abort=function(){c()},l[0].errfcb=function(e){e?i(n,a,[e]):u(n,a,t.call(arguments,1))},e.apply(r,l)}}),e.then(function(){var n=t.call(arguments);a.forEach(function(e){e.apply(r,n)})})}var t=Array.prototype.slice,r=Object.create(null),a="__ASQ__",u=n.__schedule,l=n.__tapSequence;return n.extend("after",function(n){return function(e){var a=arguments.length>1?t.call(arguments,1):void 0;return e=+e||0,n.then(function(n){var u=a||t.call(arguments,1);setTimeout(function(){n.apply(r,u)},e)}),n}}),n.after=function(){return n().after.apply(r,arguments)},n.extend("any",function(a,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var l=t.call(arguments);return a.then(function(a){function u(){p=!0,f.length=0,g.length=0}function i(n){g.length>0?(g.length=l.length,n.apply(r,g)):(f.length=l.length,n.fail.apply(r,f)),u()}function c(e,t,a){p||(s++,g[t]=a.length>1?n.messages.apply(r,a):a[0],s===l.length&&(p=!0,i(e)))}function o(e,t,a){p||t in f||(s++,f[t]=a.length>1?n.messages.apply(r,a):a[0]),p||s!==l.length||(p=!0,i(e))}var s=0,f=[],p=!1,g=[],h=n.apply(r,t.call(arguments,1));e(h,l,c,o,u),h.pipe(a)}),a}}),n.extend("errfcb",function(n){return function(){var e={val:function(n){return e.val_cb=n,e},or:function(n){return e.or_cb=n,e}};return e[a]=!0,n.seq(e),function(n){n?e.or_cb(n):e.val_cb.apply(r,t.call(arguments,1))}}}),n.extend("failAfter",function(n){return function(e){var a=arguments.length>1?t.call(arguments,1):void 0;return e=+e||0,n.then(function(n){setTimeout(function(){n.fail.apply(r,a)},e)}),n}}),n.failAfter=function(){return n().failAfter.apply(r,arguments)},n.extend("first",function(a,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var l=t.call(arguments);return a.then(function(a){function u(){s.length=0}function i(e,t,a){f||(f=!0,e(a.length>1?n.messages.apply(r,a):a[0]),u())}function c(e,t,a){f||t in s||(o++,s[t]=a.length>1?n.messages.apply(r,a):a[0],o===l.length&&(f=!0,s.length=l.length,e.fail.apply(r,s),u()))}var o=0,s=[],f=!1,p=n.apply(r,t.call(arguments,1));e(p,l,i,c,u),p.pipe(a)}),a}}),function(){var e;n.iterable=function(){function l(){throw 1===A.length?A[0]:A}function i(){var n;if(b=null,_)for(0!==w.length||q||(q=!0,l());w.length>0;){q=!0,n=w.shift();try{n.apply(r,A)}catch(e){checkBranding(e)?A=A.concat(e):A.push(e),0===w.length&&l()}}}function c(){return _||x||0===arguments.length?d:(S.push.apply(S,arguments),d)}function o(){return x||0===arguments.length?d:(w.push.apply(w,arguments),b||(b=u(i)),d)}function s(){return x||0===arguments.length?d:(t.call(arguments).forEach(function(n){c(n).or(n.fail)}),d)}function f(){if(_||x||0===S.length)return S.length>0&&p("Sequence cannot be iterated"),{done:!0};try{return{value:S.shift().apply(r,arguments)}}catch(e){return n.isMessageWrapper(e)?p.apply(r,e):p(e),{}}}function p(){return _||x?d:(A.push.apply(A,arguments),_=!0,b||(b=u(i)),d)}function g(n){return(_||x)&&(n=void 0),h(),{done:!0,value:n}}function h(){_||x||(x=!0,clearTimeout(b),b=null,S.length=w.length=A.length=0)}function m(){var t;return e={val_queue:S.slice(),or_queue:w.slice()},t=n.iterable(),e=null,t}function y(){return w.push(function(){}),d}function v(n){return Object.defineProperty(n,a,{enumerable:!1,value:!0}),n}var d,b,_=!1,q=!1,x=!1,S=[],w=[],A=[];return d=v({val:c,then:c,or:o,pipe:s,next:f,"throw":p,"return":g,abort:h,duplicate:m,defer:y}),d["function"==typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return d},e&&(S=e.val_queue.slice(0),w=e.or_queue.slice(0)),d.val.apply(r,arguments),d}}(),n.extend("last",function(a,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var l=t.call(arguments);return a.then(function(a){function u(){g=!0,p.length=0,s=null}function i(e){null!=s?e(s.length>1?n.messages.apply(r,s):s[0]):(p.length=l.length,e.fail.apply(r,p)),u()}function c(n,e,t){g||(f++,s=t,f===l.length&&(g=!0,i(n)))}function o(e,t,a){g||t in p||(f++,p[t]=a.length>1?n.messages.apply(r,a):a[0]),g||f!==l.length||(g=!0,i(e))}var s,f=0,p=[],g=!1,h=n.apply(r,t.call(arguments,1));e(h,l,c,o,u),h.pipe(a)}),a}}),n.extend("map",function(e,a){return function(u,l){return a("seq_error")||a("seq_aborted")?e:(e.seq(function(){var e,a=t.call(arguments),i=u,c=l;return c||(c=a.shift()),i||(i=a.shift()),"function"==typeof i&&Array.isArray(c)&&(e=i,i=c,c=e),n.apply(r,a).gate.apply(r,i.map(function(n){return function(){c.apply(r,[n].concat(t.call(arguments)))}}))}).val(function(){return t.call(arguments)}),e)}}),n.extend("none",function(a,u){return function(){if(u("seq_error")||u("seq_aborted")||0===arguments.length)return a;var l=t.call(arguments);return a.then(function(a){function u(){p=!0,f.length=0,h.length=0}function i(n){h.length>0?(h.length=l.length,n.fail.apply(r,h)):(f.length=l.length,n.apply(r,f)),u()}function c(e,t,a){p||(s++,h[t]=a.length>1?n.messages.apply(r,a):a[0],s===l.length&&(p=!0,i(e)))}function o(e,t,a){p||t in f||(s++,f[t]=a.length>1?n.messages.apply(r,a):a[0]),p||s!==l.length||(p=!0,i(e))}var s=0,f=[],p=!1,g=n.apply(r,t.call(arguments,1)),h=[];e(g,l,c,o,u),g.pipe(a)}),a}}),n.extend("pThen",function(e,a){return function(l,i){if(a("seq_aborted"))return e;var c=!1,o=!1;return"function"==typeof l&&e.then(function(e){if(c)e.apply(r,t.call(arguments,1));else{var a,u=n.messages.apply(r,arguments);u.shift(),1===u.length&&(u=u[0]),o=!0;try{a=l(u)}catch(i){return n.isMessageWrapper(i)||(i=[i]),void e.fail.apply(r,i)}n.isSequence(a)?a.pipe(e):n.isMessageWrapper(a)?e.apply(r,a):"object"!=typeof a&&"function"!=typeof a||"function"!=typeof a.then?e(a):a.then(e,e.fail)}}),"function"==typeof i&&e.or(function(){if(!o){var l,s,f=n.messages.apply(r,arguments),p=t.call(a("or_queue"));1===f.length&&(f=f[0]),c=!0,l=i(f),s=a("sequence_messages"),s.length=0,"undefined"!=typeof l&&(n.isMessageWrapper(l)||(l=[l]),s.push.apply(s,l)),a("sequence_errors").length=0,a("seq_error",!1),a("then_ready",!0),a("or_queue").length=0,e.val(function(){return n.messages.apply(r,arguments)}),p.length>0&&u(function(){e.or.apply(r,p)})}}),e}}),n.extend("pCatch",function(n,e){return function(t){return e("seq_aborted")?n:(n.pThen(void 0,t),n)}}),n.extend("race",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments).map(function(e){var t;return n.isSequence(e)?(t={fn:e},l(t),function(n){t.fn.pipe(n)}):e});return e.then(function(){var n=t.call(arguments);u.forEach(function(e){e.apply(r,n)})}),e}}),n.react=function(e){function a(){if(i){var e=i.duplicate();return e.unpause.apply(r,arguments),e}return n().val(function(){throw"Disabled Sequence"})}function u(){i&&(i=null,c.forEach(function(n){n()}),c.length=0)}function l(n){i&&"function"==typeof n&&c.push(n)}var i,c=[];return a.onStream=function(){t.call(arguments).forEach(function(n){n.on("data",a),n.on("error",a)})},a.unStream=function(){t.call(arguments).forEach(function(n){n.removeListener("data",a),n.removeListener("error",a)})},n(function(){e.call(i,a,l)}),i=n().duplicate(),i.stop=u,i},n.extend("runner",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var l=t.call(arguments);return e.then(function(e){function a(t){var a=t;return a="function"==typeof t?t.call(r,p):n.isSequence(t)&&"next"in t?t.duplicate():n.iterable().val(t),n.isSequence(a)&&a.or(function(){e.fail.apply(r,arguments)}),a}function i(){s.push.apply(s,t.call(arguments).map(a))}var c,o,s=l,f={messages:t.call(arguments,1),add:i},p=f;s=s.map(a),function g(){var t,a;c=s.shift();try{o=n.isMessageWrapper(p)&&n.isSequence(c)?c.next.apply(c,p):c.next(p)}catch(l){return e.fail(l)}o.value===f?(s.push(c),p=f,u(g)):(n.isSequence(o.value)||(t=typeof o.value,null===o.value||"object"!==t&&"function"!==t||"function"!=typeof o.value.then?"function"===t?(a=o.value,o.value=n(function(n){a(n.errfcb)})):o.value=n.isMessageWrapper(o.value)?n.apply(r,o.value.length>0?o.value:n.messages(void 0)):"undefined"!=typeof o.value?n(o.value):n():o.value=n().promise(o.value)),o.value.val(function(){arguments.length>0&&(p=arguments.length>1?n.messages.apply(r,arguments):arguments[0]),o.done||(p===f?s.push(c):s.unshift(c)),s.length>0?g():"undefined"!=typeof p?n.isMessageWrapper(p)?e.apply(r,p):e(p):e()}).or(function(){try{c["throw"].apply(c,arguments)}catch(n){e.fail(n)}}))}()}),e}}),n.extend("toPromise",function(e){return function(){return new Promise(function(a,u){e.val(function(){var e=t.call(arguments);return a.call(r,e.length>1?e:e[0]),n.messages.apply(r,e)}).or(function(){var n=t.call(arguments);u.call(r,n.length>1?n:n[0])})})}}),n.extend("try",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments).map(function(e){return function(a){var u=t.call(arguments),l=n.apply(r,u.slice(1));l.then(function(){e.apply(r,arguments)}).val(function(){a.apply(r,arguments)}).or(function(){var e=n.messages.apply(r,arguments);a({"catch":e.length>1?e:e[0]})})}});return e.then.apply(r,u),e}}),n.extend("until",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments).map(function(e){return function a(u){var l=t.call(arguments),i=n.apply(r,l.slice(1));i.then(function(){var n=t.call(arguments);n[0]["break"]=function(){u.fail.apply(r,arguments),i.abort()},e.apply(r,n)}).val(function(){u.apply(r,arguments)}).or(function(){a.apply(r,l)})}});return e.then.apply(r,u),e}}),n.extend("waterfall",function(e,a){return function(){if(a("seq_error")||a("seq_aborted")||0===arguments.length)return e;var u=t.call(arguments);return e.then(function(e){var a=n.messages(),l=n.apply(r,t.call(arguments,1));u.forEach(function(e){l.then(e).val(function(){var e=n.messages.apply(r,arguments);return a.push(e.length>1?e:e[0]),a})}),l.pipe(e)}),e}}),n.wrap=function(e,a){function u(n,e){return!n||"undefined"!=typeof window&&n===window||"undefined"!=typeof global&&n===global?e:n}var l,i,c,o;if(a=a&&"object"==typeof a?a:{},a.errfcb&&a.splitcb||a.errfcb&&a.simplecb||a.splitcb&&a.simplecb||"errfcb"in a&&!a.errfcb&&!a.splitcb&&!a.simplecb||a.params_first&&a.params_last)throw Error("Invalid options");return o=a["this"]&&"object"==typeof a["this"]?a["this"]:r,l=a.errfcb||!(a.splitcb||a.simplecb),i=!!a.params_first||!a.params_last&&!("params_first"in a||a.params_first)||"params_last"in a&&!a.params_first&&!a.params_last,c=i?"push":"unshift",a.gen?function(){return n.apply(r,arguments).runner(e)}:l?function(){var r=t.call(arguments),a=u(this,o);return n(function(n){r[c](n.errfcb),e.apply(a,r)})}:a.splitcb?function(){var r=t.call(arguments),a=u(this,o);return n(function(n){r[c](n,n.fail),e.apply(a,r)})}:a.simplecb?function(){var r=t.call(arguments),a=u(this,o);return n(function(n){r[c](n),e.apply(a,r)})}:void 0},n});
