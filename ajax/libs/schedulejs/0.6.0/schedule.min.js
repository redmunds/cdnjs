"undefined"!=typeof module&&module.exports&&(this.later=require("later")),schedule=function(e){"use strict";function r(e){return e.id}function n(e){return e.available}function t(e){return e.isNotReservable||!1}function a(e){return e.id}function i(e){return e.duration}function u(e){return e.available}function s(e){return e.resources}function o(e){return e.dependsOn}function l(e){return e.minSchedule}function c(e){return e.priority}var d={version:"0.6.0"};if(!e)throw new Error("Laterjs must be included before Schedulejs.");return Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null==this)throw new TypeError;var r=Object(this),n=r.length>>>0;if(0===n)return-1;var t=0;if(arguments.length>1&&(t=Number(arguments[1]),t!=t?t=0:0!=t&&1/0!=t&&t!=-1/0&&(t=(t>0||-1)*Math.floor(Math.abs(t)))),t>=n)return-1;for(var a=t>=0?t:Math.max(n-Math.abs(t),0);n>a;a++)if(a in r&&r[a]===e)return a;return-1}),d.date={},d.date.UTC=function(){e.date.UTC()},d.date.localTime=function(){e.date.localTime()},d.functor=function(e){return"function"==typeof e?e:function(){return e}},d.memoizedRangeFn=function(e){var r={};return function(n){if(!r[n]){var t=e(1,n);r[n]=[t[0]?t[0].getTime():41024448e5,t[1]?t[1].getTime():41024448e5]}return r[n]}},d.sort={},d.sort.tasks=function(e,r){r.sort(function(r,n){var t=e.tasks[r],a=e.tasks[n];return a.priority&&(!t.priority||a.priority>t.priority)?-1:t.priority&&(!a.priority||t.priority>a.priority)?1:e.tasks[n].floatAmt>e.tasks[r].floatAmt})},d.resources=function(){function e(e){for(var r=[],n=d.functor(a),t=d.functor(i),s=d.functor(u),o=0,l=e.length;l>o;o++){var c=e[o],f=n.call(this,c,o),h=t.call(this,c,o),v=s.call(this,c,o);r.push({id:f,available:h,isNotReservable:v})}return r}var a=r,i=n,u=t;return e.id=function(r){return arguments.length?(a=r,e):a},e.available=function(r){return arguments.length?(i=r,e):i},e.isNotReservable=function(r){return arguments.length?(u=r,e):u},e},d.tasks=function(){function e(e){for(var a=[],i=d.functor(r),u=d.functor(n),s=d.functor(t),o=d.functor(f),l=d.functor(h),c=d.functor(v),p=d.functor(g),y=0,m=e.length;m>y;y++){var b=e[y],x={id:i.call(this,b,y),duration:u.call(this,b,y),available:s.call(this,b,y),resources:o.call(this,b,y),dependsOn:l.call(this,b,y),minSchedule:c.call(this,b,y),priority:p.call(this,b,y)};a.push(x)}return a}var r=a,n=i,t=u,f=s,h=o,v=l,g=c;return e.id=function(n){return arguments.length?(r=n,e):r},e.duration=function(r){return arguments.length?(n=r,e):n},e.available=function(r){return arguments.length?(t=r,e):t},e.resources=function(r){return arguments.length?(f=r,e):f},e.dependsOn=function(r){return arguments.length?(h=r,e):h},e.minSchedule=function(r){return arguments.length?(v=r,e):v},e.priority=function(r){return arguments.length?(g=r,e):g},e},d.dependencyGraph=function(e){function r(e){for(var r={tasks:{},roots:[],leaves:[],resources:[],depth:0,end:0},l=0,c=e.length;c>l;l++){var d=e[l];r.tasks[d.id]={id:d.id,duration:d.duration,priority:d.priority,schedule:d.schedule,minSchedule:d.minSchedule,dependsOn:d.dependsOn,resources:d.resources}}return n(r),t(r.tasks),a(r),i(r,r.leaves,0),r.depth+=1,u(r,{},r.roots,0),s(r,r.leaves),o(r,{},r.leaves,r.end),r}function n(e){for(var r in e.tasks){var n=e.tasks[r];if(!c(n.resources))for(var t=0,a=n.resources.length;a>t;t++){var i=n.resources[t];-1===e.resources.indexOf(i)&&e.resources.push(i)}}}function t(e){for(var r in e){var n=e[r],t=n.dependsOn;if(!c(t))for(var a=0,i=t.length;i>a;a++){var u=e[t[a]];(u.requiredBy||(u.requiredBy=[])).push(n.id)}}}function a(e){for(var r in e.tasks){var n=e.tasks[r];c(n.dependsOn)&&e.roots.push(n.id),c(n.requiredBy)&&e.leaves.push(n.id)}}function i(e,r,n){for(var t=0,a=r.length;a>t;t++){var u=e.tasks[r[t]],s=u.dependsOn;u.depth=!u.depth||n>u.depth?n:u.depth,e.depth=n>e.depth?n:e.depth,c(s)||i(e,s,u.depth+1)}}function u(e,r,n,t){l(r,n,t);for(var a=0,i=n.length;i>a;a++){var s=n[a],o=e.tasks[s],d=o.dependsOn,f=r[s];!o.earlyFinish&&(c(d)||f&&f[0]===d.length)&&(o.earlyStart=f[1],o.earlyFinish=f[1]+o.duration,c(o.requiredBy)||u(e,r,o.requiredBy,o.earlyFinish))}}function s(e,r){for(var n=0,t=r.length;t>n;n++){var a=e.tasks[r[n]].earlyFinish;e.end=a>e.end?a:e.end}}function o(e,r,n,t){l(r,n,t,!0);for(var a=0,i=n.length;i>a;a++){var u=n[a],s=e.tasks[u],d=s.requiredBy,f=r[u];(c(d)||f&&f[0]===d.length)&&(s.lateStart=f[1]-s.duration,s.lateFinish=f[1],s.floatAmt=s.lateFinish-s.earlyFinish,c(s.dependsOn)||o(e,r,s.dependsOn,s.lateStart))}}function l(e,r,n,t){for(var a=t?function(e,r){return r>e}:function(e,r){return e>r},i=0,u=r.length;u>i;i++){var s=r[i];e[s]?(e[s][0]=e[s][0]+1,e[s][1]=a(n,e[s][1])?n:e[s][1]):e[s]=[1,n]}}function c(e){return!e||0===e.length}return r(e)},d.resourceManager=function(r,n){function t(e,r){var n={};if(e)for(var t=0,i=e.length;i>t;t++)a(n,e[t],r);return n}function a(r,n,t){var a=JSON.parse(JSON.stringify(n.available||p)),i=d.memoizedRangeFn(e.schedule(a).nextRange);r[n.id]={schedule:a,next:i,nextAvail:i(t)}}function i(e,r,n,t){var a,i=[],o={},c=50;for(u(e,r,i,o);!(a=s(i,n,t)).success&&--c;)l(i,f(i),o);return a.delays=o,a}function u(e,r,n,t){for(var a=0,i=e.length;i>a;a++){var s=e[a];if(Array.isArray(s)){var o=[],l={};u(s,r,o,l);var c=v(l);c&&(t[c]=l[c]);var d={subRanges:o};h(d),n.push(d)}else{var f=y[s],g=f.nextAvail[0]>=r?f.nextAvail:f.next(r);g[0]>r&&"_proj"!==s&&(t[s]={needed:r,available:g[0]}),n.push({id:s,range:g})}}}function s(r,n,t){for(var a,i,u={success:!1},s=[],l=0,c=r.length;c>l;l++){var d=r[l],f=d.range;g(d)||s.push(d.id),a=!a||f[0]>a?f[0]:a,i=!i||f[1]<i?f[1]:i}var h=(i-a)/e.MIN;return(h>=n||h>=t)&&(h=t&&h>t?t:h,u=o(s,a,h)),u}function o(r,n,t){var a=n+t*e.MIN,i={resources:r,start:n,end:a,duration:t,success:!0};return c(r,n,a),i}function l(e,r,n){for(var t=0,a=e.length;a>t;t++){var i=e[t];i.range[1]>r||(i.subRanges?(l(i.subRanges,r,{}),h(i)):(i.range=y[i.id].next(r),"_proj"===i.id||n[i.id]||(n[i.id]={needed:r,available:i.range[0]})))}}function c(r,n,t){for(var a=0,i=r.length;i>a;a++){var u=y[r[a]];u.isNotReservable||(n!==u.nextAvail[0]&&(u.schedule.exceptions||(u.schedule.exceptions=[]),u.schedule.exceptions.push({fd_a:[n],fd_b:[t]}),u.next=d.memoizedRangeFn(e.schedule(u.schedule).nextRange),t=u.nextAvail[0]),u.nextAvail=u.next(t))}}function f(e){for(var r,n=0,t=e.length;t>n;n++){var a=e[n].range[1];r=!r||r>a?a:r}return r}function h(e){for(var r,n,t=0,a=e.subRanges.length;a>t;t++){var i=e.subRanges[t];(!r||i.range[0]<n[0])&&(r=i.id,n=i.range)}e.id=r,e.range=n}function v(e){var r,n;for(var t in e){var a=e[t].available;(!r||r>a)&&(r=a,n=t)}return n}function g(e){return"_"===e.id[0]}var p={schedules:[{fd_a:[n.getTime()]}]},y=t(r,n);return{getResource:function(e){return y[e]},addResource:function(e,r,n){for(var t=0,i=e.length;i>t;t++){var u="object"!=typeof e[t]?{id:r+e[t]}:{id:r+e[t].id,available:e[t].available,isNotReservable:e[t].isNotReservable};y[u.id]||a(y,u,n)}},makeReservation:function(e,r,n,t){return r=r?new Date(r):new Date,i(e,r.getTime(),n||1,t)},optimize:function(r){for(var n in y){var t=y[n];if(t.schedule.exceptions){var a=t.schedule.exceptions;t.schedule.exceptions=[];for(var i=0,u=a.length;u>i;i++)(!a[i].fd_b||a[i].fd_b>r)&&t.schedule.exceptions.push(a[i]);t.next=d.memoizedRangeFn(e.schedule(t.schedule).nextRange)}t.nextAvail[0]<r&&(t.nextAvail=t.next(r))}}}},d.create=function(r,n,t,a){function i(){var e,n=[];return v.addResource(h.resources,"",a),v.addResource([{id:"_proj",available:t}],"",a),v.addResource(r,"_task",a),u(h.roots),e=o(r,n),f(h.leaves,e[1]),{scheduledTasks:g,failedTasks:n.length?n:null,success:0===n.length,start:e[0],end:e[1]}}function u(e){for(var r=e.slice(0),n={},t=0,i=e.length;i>t;t++)n[e[t]]=[0,a.getTime()];for(;r.length;){d.sort.tasks(h,r);var u=h.tasks[r.pop()],o=n[u.id][1],f=s(u,o);f&&u.requiredBy&&(l(r,n,u.requiredBy,f),v.optimize(c(n)))}}function s(e,r){for(var n=["_proj","_task"+e.id],t=e.resources?n.concat(e.resources):n,a=e.duration,i=r,u={schedule:[],duration:e.duration};a;){var s=v.makeReservation(t,i,e.minSchedule||1,a);if(!s.success)return void 0;u.earlyStart=u.earlyStart||s.start,u.schedule.push(s),a-=s.duration,i=s.end}return u.earlyFinish=i,g[e.id]=u,i}function o(e,r){for(var n,t,a=0,i=e.length;i>a;a++){var u=g[e[a].id];u?(n=!n||u.earlyStart<n?u.earlyStart:n,t=!t||u.earlyFinish>t?u.earlyFinish:t):r.push(e[a].id)}return[n,t]}function l(e,r,n,t){for(var a=0,i=n.length;i>a;a++){var u=n[a],s=h.tasks[u].dependsOn,o=r[u]||(r[u]=[0,0]);o[0]+=1,o[1]=t>o[1]?t:o[1],(!s||o[0]>=s.length)&&e.push(u)}}function c(e){var r;for(var n in e)(!r||r>e[n][1])&&(r=e[n][1]);return r}function f(r,n){for(var t=0,a=r.length;a>t;t++){var i=g[r[t]],u=h.tasks[r[t]].dependsOn;i&&(i.lateFinish=n,i.floatAmt=(i.lateFinish-i.earlyFinish)/e.MIN,u&&f(u,i.earlyStart))}}var h=d.dependencyGraph(r),v=d.resourceManager(n,a),g={};return i()},d}(this.later);