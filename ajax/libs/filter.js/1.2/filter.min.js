!function(window){var _filterJS=function(t,e,i,n){this.dataModel=t,this.view=i,this.parentNode=e,this.settings=n||{},this.settings.and_filter_on=n.and_filter_on||!0,this.dataModel.constructor==Object&&(this.dataModel=[this.dataModel]);for(name in this.dataModel[0])this.settings.root=name;this.render(),this.buildCategoryMap(),this.bindEvents(),this.settings.exec_callbacks_on_init&&this.settings.callbacks&&this.execCallBacks(this.settings.all_objects)},FilterJS=function(t,e,i,n){return new _filterJS(t,e,i,n)};FilterJS.VERSION=1.2,FilterJS.registerHtmlElement=function(t){_filterJS.prototype[t]=function(e,i){return _filterJS.prototype.content_tag(t,e,i)}},_filterJS.prototype={content_tag:function(t,e,i){var n=document.createElement(t);return e&&$(n).attr(e),i&&(i.constructor==Array?i.forEach(function(t){t&&$(n).append(t.constructor==String?t:$(t))}):$(n).html(i)),n},link:function(t,e,i){return e=e||{},e.href=t,this.content_tag("a",e,i)},image:function(t,e){return e=e||{},e.src=t,this.content_tag("img",e)},render:function(t){var e=this,i=$(this.parentNode);this.parentNode&&this.view&&this.dataModel.forEach(function(t){t=t[e.settings.root];var n=$(e.view(t));n.attr({id:e.settings.root+"_"+t.id,"data-fjs":!0}),i.append(n)})},bindEvents:function(){var t=this;t.settings.selector.forEach(function(e,i){$(e.element).live(e.events,function(e){t.filter()})})},unbindEvents:function(){var t=this;t.settings.selector.forEach(function(t,e){$(t.element).die(t.events)})},filter:function(){var t=this,e=t.settings.all_objects.slice(),i=0,n=!1;t.settings.selector.forEach(function(r){var s=$(r.element).filter(r.select).map(function(){return $(this).val()});i+=s.length,s.length?e=t.grep(e,t.findObjects(r.name,s,r.type)):n=!0}),n&&t.settings.and_filter_on&&(i=0),e=i?e:[],t.hideShow(e),t.execCallBacks(e)},findObjects:function(t,e,i){var n=this,r=[];return $.each(e,function(e,s){var o;if("range"==i){var a=s.split("-");2==a.length&&("below"==a[0]&&(a[0]=-(1/0)),"above"==a[1]&&(a[1]=1/0),o=$.map(n.settings.object_map[t],function(e,i){if(Number(i)>=a[0]&&Number(i)<=a[1])return n.settings.object_map[t][i]}))}else o=n.settings.object_map[t][s];o&&(r=r.concat(o))}),r},grep:function(t,e){return jQuery.grep(t,function(t,i){return jQuery.inArray(t,e)!=-1})},makeEvalString:function(t,e){var n=t.split(".ARRAY."),r=e+"."+n[0];for(i=1;i<n.length;i++)r+=".filter_collect('"+n[i]+"')";return r},buildObjectMap:function(){var t=this,e=this.settings.filter_criteria,i={};t.settings.selector=[];for(name in e){var n={};n.element=e[name][0].split(/.EVENT.|.SELECT.|.TYPE./)[0],n.events=(e[name][0].match(/.EVENT.(\S*)/)||[])[1],n.select=(e[name][0].match(/.SELECT.(\S*)/)||[])[1],n.type=(e[name][0].match(/.TYPE.(\S*)/)||[])[1],n.name=name,t.settings.selector.push(n),e[name].push(t.makeEvalString(e[name][1],t.settings.root)),i[name]={}}return i},buildCategoryMap:function(){var filter_criteria=this.settings.filter_criteria,object_map=this.buildObjectMap(),settings=this.settings;return settings.all_objects=[],this.dataModel.forEach(function(dm){settings.all_objects.push(dm[settings.root].id);for(name in filter_criteria){var eval_out=eval("dm."+filter_criteria[name][2]),obj=object_map[name];eval_out&&eval_out.constructor==Array?eval_out.forEach(function(t){obj[t]?obj[t].push(dm[settings.root].id):obj[t]=[dm[settings.root].id]}):obj[eval_out]?obj[eval_out].push(dm[settings.root].id):obj[eval_out]=[dm[settings.root].id]}}),settings.object_map=object_map,object_map},hideShow:function(t){var e="#"+this.settings.root+"_";$(this.parentNode+" > *[data-fjs]").hide(),t.forEach(function(t){$(e+t).show()})},execCallBacks:function(t){var e=this;e.settings.callbacks&&(filtered_objects=[],$.each(e.dataModel,function(i,n){t.indexOf(n[e.settings.root].id)!=-1&&filtered_objects.push(n[e.settings.root])}),$.each(e.settings.callbacks,function(t,i){i.call(e,filtered_objects)}))}},window.FilterJS=FilterJS,FilterJS.registerHtmlElement("div"),FilterJS.registerHtmlElement("span"),FilterJS.registerHtmlElement("li"),FilterJS.registerHtmlElement("ul"),FilterJS.registerHtmlElement("p")}(this),Array.prototype.filter_collect=function(t,e){var e=e||[];return this.forEach(function(i){i.constructor==Array?i.filter_collect(t,e):e.push(i[t])}),e},"forEach"in Array.prototype||(Array.prototype.forEach=function(t,e){for(var i=0,n=this.length;i<n;i++)i in this&&t.call(e,this[i],i,this)});