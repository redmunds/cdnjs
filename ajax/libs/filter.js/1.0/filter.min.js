var filterJS=function(t,e,n,i){if(this.dataModel=t,this.tags={},this.view=n,this.parentNode=e,this.settings=i||{},0!=t.length){for(name in this.dataModel[0])this.settings.root=name;this.parentNode&&this.render(),this.category_map(t,this.settings),this.filter_event(this.settings)}};filterJS.prototype={content_tag:function(t,e,n){var i=document.createElement(t);return e&&$(i).attr(e),n&&(n.constructor==Array?n.forEach(function(t){t&&$(i).append($(t))}):$(i).html(n)),i},link:function(t,e,n){return e=e||{},e.href=t,this.content_tag("a",e,n)},image:function(t,e){return e=e||{},e.src=t,this.content_tag("img",e)},div:function(t,e){return this.content_tag("div",t,e)},span:function(t,e){return this.content_tag("span",t,e)},li:function(t,e){return this.content_tag("li",t,e)},ul:function(t,e){return this.content_tag("ul",t,e)},render:function(t){var e=this;if(!this.view)return!1;if(!t&&!this.parentNode)return!1;var n=$(t||this.parentNode);this.dataModel.constructor==Array?this.dataModel.forEach(function(t){t=t[e.settings.root];var i=e.view(t);i.id=e.settings.root+"_"+t.id,i.setAttribute("tagjs","yes"),n.append(i)}):n.append(e.view(this.dataModel))},filter_event:function(t){var e=this;e.settings.selector.forEach(function(t,n){$(t.element).bind(t.events,function(t){e.filter()})})},filter:function(){var t=this,e=t.settings.all_object.slice(),n=0;t.settings.selector.forEach(function(i){var r=$(i.element).filter(i.select).map(function(){return $(this).val()});n+=r.length,r.length&&(e=t.grep(e,t.find_objects(i.name,r,i.type)))}),t.hideShow(n?e:[])},find_objects:function(t,e,n){var i=this,r=[];return $.each(e,function(e,o){var a;if("range"==n){var s=o.split("-");2==s.length&&("below"==s[0]&&(s[0]=-(1/0)),"above"==s[1]&&(s[1]=1/0),a=$.map(i.settings.object_map[t],function(e,n){if(Number(n)>=s[0]&&Number(n)<=s[1])return i.settings.object_map[t][n]}))}else a=i.settings.object_map[t][o];a&&(r=r.concat(a))}),r},grep:function(t,e){return jQuery.grep(t,function(t,n){return jQuery.inArray(t,e)!=-1})},parse_map:function(t,e){var n=t.split(".ARRAY."),r=e+"."+n[0];for(i=1;i<n.length;i++)r+=".filter_collect('"+n[i]+"')";return r},map_objects:function(t){var e=this,n=t.filter_criteria,i={};t.selector=[];for(name in n){var r={};r.element=n[name][0].split(/.EVENT.|.SELECT.|.TYPE./)[0],r.events=(n[name][0].match(/.EVENT.(\S*)/)||[])[1],r.select=(n[name][0].match(/.SELECT.(\S*)/)||[])[1],r.type=(n[name][0].match(/.TYPE.(\S*)/)||[])[1],r.name=name,t.selector.push(r),n[name].push(e.parse_map(n[name][1],t.root)),i[name]={}}return i},category_map:function(data,settings){var filter_criteria=settings.filter_criteria,object_map=this.map_objects(settings);return settings.all_object=[],data.forEach(function(dm){settings.all_object.push(dm[settings.root].id);for(name in filter_criteria){var eval_out=eval("dm."+filter_criteria[name][2]),obj=object_map[name];eval_out.constructor==Array?eval_out.forEach(function(t){obj[t]?obj[t].push(dm[settings.root].id):obj[t]=[dm[settings.root].id]}):obj[eval_out]?obj[eval_out].push(dm[settings.root].id):obj[eval_out]=[dm[settings.root].id]}}),settings.object_map=object_map,object_map},hideShow:function(t){var e="#"+this.settings.root+"_";$(this.parentNode+" > *[tagjs]").hide(),t.forEach(function(t){$(e+t).show()})}},Array.prototype.filter_collect=function(t,e){var e=e||[];return this.forEach(function(n){n.constructor==Array?n.filter_collect(t,e):e.push(n[t])}),e},"forEach"in Array.prototype||(Array.prototype.forEach=function(t,e){for(var n=0,i=this.length;n<i;n++)n in this&&t.call(e,this[n],n,this)});