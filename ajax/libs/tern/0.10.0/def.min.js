!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,t,r){return e.call?e(t,r):e}function a(e,r){if("!ret"==r){if(e.retval)return e.retval;var n=new t.AVal;return e.propagate(new t.IsCallee(t.ANull,[],null,n)),n}return e.getProp(r)}function i(e,r){return function(a,i){for(var s=[],o=0;o<e.length;o++)s.push(n(e[o],a,i));return new t.Fn(name,t.ANull,s,n(r,a,i))}}function s(e){return function(r,a){for(var i=new t.AVal,s=0;s<e.length;s++)n(e[s],r,a).propagate(i);return i}}function o(e){return function(r,n){return new t.Arr(e(r,n))}}function l(e,r,n,a){var i=new d(e,null,n,a).parseType(!1,r,!0);if(/^fn\(/.test(e))for(var s=0;s<i.args.length;++s)(function(e){var r=i.args[e];r instanceof t.Fn&&r.args&&r.args.length&&p(i,function(n,a){var i=a[e];i&&i.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(s);return i}function p(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,i,s){var o=t(e,i,s),l=n?n(e,i,s):a;return r?o:l}}function f(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function u(e){if(!e["!type"]||/^(fn\(|\[)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function c(e,n,a){if(!e){var i=n["!type"];if(i)if(/^fn\(/.test(i))e=f(t.Fn);else{if("["!=i.charAt(0))throw new Error("Invalid !type spec: "+i);e=f(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:f(t.Obj);e.name=a}for(var s in n)if(r(n,s)&&33!=s.charCodeAt(0)){var o=n[s];if("string"==typeof o||u(o))continue;var l=e.defProp(s);c(l.getObjType(),o,a?a+"."+s:s).propagate(l)}return e}function h(e,n,a){if(e.isShell){delete e.isShell;var i=n["!type"];if(i)l(i,a,e);else{var s=n["!proto"]&&l(n["!proto"]);t.Obj.call(e,!(s instanceof t.Obj)||s,a)}}var o=n["!effects"];if(o&&e instanceof t.Fn)for(var p=0;p<o.length;++p)A(o[p],e);g(n,e);for(var f in n)if(r(n,f)&&33!=f.charCodeAt(0)){var c=n[f],v=e.defProp(f),y=a?a+"."+f:f;if("string"==typeof c)v.isEmpty()&&l(c,y).propagate(v);else{if(u(c)){if(!v.isEmpty())continue;l(c["!type"],y,null,!0).propagate(v)}else h(v.getObjType(),c,y);c["!doc"]&&(v.doc=c["!doc"]),c["!url"]&&(v.url=c["!url"]),c["!span"]&&(v.span=c["!span"])}}return e}function g(e,t){e["!doc"]&&(t.doc=e["!doc"]),e["!url"]&&(t.url=e["!url"]),e["!span"]&&(t.span=e["!span"]),e["!data"]&&(t.metaData=e["!data"])}function v(e,r){var n=t.cx().parent,a=n&&n.passes&&n.passes[e];if(a)for(var i=0;i<a.length;i++)a[i](r)}function y(e,r){var n=t.cx();t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.localDefs=n.definitions[n.curOrigin]=Object.create(null),v("preLoadDef",e),c(r,e);var a=e["!define"];if(a){for(var i in a){var s=a[i];n.localDefs[i]="string"==typeof s?b(s):c(null,s,i)}for(var i in a){var s=a[i];"string"!=typeof s&&h(n.localDefs[i],a[i],i)}}h(r,e),v("postLoadDef",e),n.curOrigin=n.localDefs=null}var d=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};d.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r,n){var a=[],s=[],o=!1;if(!this.eat(")"))for(var l=0;;++l){var p,f=this.spec.indexOf(": ",this.pos);f!=-1&&(p=this.spec.slice(this.pos,f),/^[$\w?]+$/.test(p)?this.pos=f+2:p=null),s.push(p);var u=this.parseType(e);if(u.call&&(o=!0),a.push(u),!this.eat(", ")){this.eat(")")||this.error();break}}var c,h,g,v;if(this.eat(" -> ")){var y=this.pos;c=this.parseType(!0),c.call&&(n?(h=c,c=t.ANull,g=y):o=!0)}else c=t.ANull;return o?i(a,c):(n&&(v=this.base)?t.Fn.call(this.base,r,t.ANull,a,s,c):v=new t.Fn(r,t.ANull,a,s,c),h&&(v.computeRet=h),null!=g&&(v.computeRetSource=this.spec.slice(g,this.pos)),v)},parseType:function(e,r,n){var a=this.parseTypeMaybeProp(e,r,n);if(!this.eat("|"))return a;for(var i=[a],o=a.call;;){var l=this.parseTypeMaybeProp(e,r,n);if(i.push(l),l.call&&(o=!0),!this.eat("|"))break}if(o)return s(i);for(var p=new t.AVal,f=0;f<i.length;f++)i[f].propagate(p);return p},parseTypeMaybeProp:function(e,t,r){for(var n=this.parseTypeInner(e,t,r);e&&this.eat(".");)n=this.extendWithProp(n);return n},extendWithProp:function(e){var t=this.word(/[\w<>$!]/)||this.error();return e.apply?function(r,n){return a(e(r,n),t)}:a(e,t)},parseTypeInner:function(e,r,n){if(this.eat("fn("))return this.parseFnType(e,r,n);if(this.eat("[")){var a=this.parseType(e);return this.eat("]")||this.error(),a.call?o(a):n&&this.base?(t.Arr.call(this.base,a),this.base):new t.Arr(a)}if(this.eat("+")){var i=this.word(/[\w$<>\.!]/),s=b(i+".prototype");return s instanceof t.Obj||(s=b(i)),s instanceof t.Obj?e&&this.eat("[")?this.parsePoly(s):n&&this.forceNew?new t.Obj(s):t.getInstance(s):s}if(e&&this.eat("!")){var l=this.word(/\d/);if(l)return l=Number(l),function(e,r){return r[l]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var p=this.word(/[\w$]/);return O[p]||function(){return t.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!]/))}return this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!`]/))},fromWord:function(e){var r=t.cx();switch(e){case"number":return r.num;case"string":return r.str;case"bool":return r.bool;case"<top>":return r.topScope}return r.localDefs&&e in r.localDefs?r.localDefs[e]:b(e)},parsePoly:function(e){var r,n="<i>";(r=this.spec.slice(this.pos).match(/^\s*(\w+)\s*=\s*/))&&(n=r[1],this.pos+=r[0].length);var a=this.parseType(!0);if(this.eat("]")||this.error(),a.call)return function(r,i){var s=t.getInstance(e);return a(r,i).propagate(s.defProp(n)),s};var i=t.getInstance(e);return a.propagate(i.defProp(n)),i}};var w,A=e.parseEffect=function(e,r){var a;if(0==e.indexOf("propagate ")){var i=new d(e,10),s=i.parseType(!0);i.eat(" ")||i.error();var o=i.parseType(!0);p(r,function(e,t){n(s,e,t).propagate(n(o,e,t))})}else if(0==e.indexOf("call ")){var l=5==e.indexOf("and return ",5),i=new d(e,l?16:5),f=i.parseType(!0),u=null,c=[];for(i.eat(" this=")&&(u=i.parseType(!0));i.eat(" ");)c.push(i.parseType(!0));p(r,function(e,r){for(var a=n(f,e,r),i=u?n(u,e,r):t.ANull,s=[],o=0;o<c.length;++o)s.push(n(c[o],e,r));var p=l?new t.AVal:t.ANull;return a.propagate(new t.IsCallee(i,s,null,p)),p},l)}else if(a=e.match(/^custom (\S+)\s*(.*)/)){var h=O[a[1]];h&&p(r,a[2]?h(a[2]):h)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var i=new d(e,5),g=i.parseType(!0);i.eat(" ");var v=i.parseType(!0);p(r,function(e,r){var a=n(g,e,r),i=n(v,e,r);a.forAllProps(function(e,r,n){n&&"<i>"!=e&&i.propagate(new t.PropHasSubset(e,r))})})}},b=e.parsePath=function(e,r){var n=t.cx(),a=n.paths[e],i=e;if(null!=a)return a;n.paths[e]=t.ANull;var s=r||w||n.topScope;if(n.localDefs)for(var o in n.localDefs)if(0==e.indexOf(o)){if(e==o)return n.paths[e]=n.localDefs[e];if("."==e.charAt(o.length)){s=n.localDefs[o],e=e.slice(o.length+1);break}}for(var l=e.split("."),p=0;p<l.length&&s!=t.ANull;++p){var f=l[p];if("!"==f.charAt(0))if("!proto"==f)s=s instanceof t.Obj&&s.proto||t.ANull;else{var u=s.getFunctionType();if(u)if("!ret"==f)s=u.retval&&u.retval.getType(!1)||t.ANull;else{var c=u.args&&u.args[Number(f.slice(1))];s=c&&c.getType(!1)||t.ANull}else s=t.ANull}else if(s instanceof t.Obj){var h="prototype"==f&&s instanceof t.Fn?s.getProp(f):s.props[f];s=!h||h.isEmpty()?t.ANull:h.types[0]}}return n.paths[i]=s==t.ANull?null:s,s};e.load=function(e,r){r||(r=t.cx().topScope);var n=w;w=r;try{y(e,r)}finally{w=n}},e.parse=function(e,r,n){var a=t.cx();r&&(a.origin=r,a.localDefs=a.definitions[r]);try{return"string"==typeof e?l(e,n):h(c(null,e,n),e,n)}finally{r&&(a.origin=a.localDefs=null)}};var O=Object.create(null);t.registerFunction=function(e,t){O[e]=t};var T=t.constraint("created, target, spec",{addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getObjType(!1)),n instanceof t.Obj)for(var a in n.props){var i=n.props[a].types[0],s=r.defProp(a);if(i&&i instanceof t.Obj&&i.props.value){var o=i.props.value.getType(!1);o&&s.addType(o)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new T(0,a,r[1])),a});var m=t.constraint("target",{addType:function(e){e instanceof t.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new t.IsCallee(t.ANull,[],null,this.target)))}});t.registerFunction("Object_defineProperty",function(e,r,n){if(n&&n.length>=3&&"Literal"==n[1].type&&"string"==typeof n[1].value){var a=r[0],i=new t.AVal;a.propagate(new t.PropHasSubset(n[1].value,i,n[1])),r[2].propagate(new m(i))}return t.ANull});var N=t.constraint("self, args, target",{addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,e.self,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});return t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new N(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),i=0;i<r.length;++i)r[i].propagate(a);return n}),t.registerFunction("Promise_ctor",function(e,r,n){if(r.length<1)return t.ANull;var a=new t.Obj(t.cx().definitions.ecma6["Promise.prototype"]),i=a.defProp("value",n&&n[0]),s=new t.AVal;s.propagate(i);var o=new t.Fn("execute",t.ANull,[s],["value"],t.ANull),l=t.cx().definitions.ecma6.promiseReject;return r[0].propagate(new t.IsCallee(t.ANull,[o,l],null,t.ANull)),a}),e});
//# sourceMappingURL=def.min.js.map