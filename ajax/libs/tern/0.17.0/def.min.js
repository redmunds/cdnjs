!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,t,r){return e.call?e(t,r):e}function a(e,r){if("!ret"==r){if(e.retval)return e.retval;var n=new t.AVal;return e.propagate(new t.IsCallee(t.ANull,[],null,n)),n}return e.getProp(r)}function i(e,r,a,i){return function(o,s){for(var l=[],p=0;p<r.length;p++)l.push(n(r[p],o,s));return new t.Fn(e,t.ANull,l,n(a,o,s),i)}}function o(e){return function(r,a){for(var i=new t.AVal,o=0;o<e.length;o++)n(e[o],r,a).propagate(i);return i.maxWeight=1e5,i}}function s(e){return function(r,n){return new t.Arr(e(r,n))}}function l(e){return function(r,a){return new t.Arr(e.map(function(e){return n(e,r,a)}))}}function p(e,r,n,a){var i=new w(e,null,n,a).parseType(!1,r,!0);if(/^fn\(/.test(e))for(var o=0;o<i.args.length;++o)(function(e){var r=i.args[e];r instanceof t.Fn&&r.args&&r.args.length&&u(i,function(n,a){var i=a[e];i&&i.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(o);return i}function u(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,i,o){var s=t(e,i,o),l=n?n(e,i,o):a;return r?s:l}}function f(e,r){for(var n=0;n<r.length&&e!=t.ANull;++n){var a=r[n];if("!"==a.charAt(0))if("!proto"==a)e=e instanceof t.Obj&&e.proto||t.ANull;else{var i=e.getFunctionType();if(i)if("!ret"==a)e=i.retval&&i.retval.getType(!1)||t.ANull;else{var o=i.args&&i.args[Number(a.slice(1))];e=o&&o.getType(!1)||t.ANull}else e=t.ANull}else if(e instanceof t.Obj&&("prototype"==a&&e instanceof t.Fn||e.hasProp(a))){var s=e.getProp(a);e=!s||s.isEmpty()?t.ANull:s.types[0]}else e=t.ANull}return e}function c(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function h(e){if(!e["!type"]||/^(fn\(|\[)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function g(e,n,a){if(!e){var i=n["!type"];if(i)if(/^fn\(/.test(i))e=c(t.Fn);else{if("["!=i.charAt(0))throw new Error("Invalid !type spec: "+i);e=c(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:c(t.Obj);e.name=a}for(var o in n)if(r(n,o)&&33!=o.charCodeAt(0)){var s=n[o];if("string"==typeof s||h(s))continue;var l=e.defProp(o);g(l.getObjType(),s,a?a+"."+o:o).propagate(l)}return e}function v(e,n,a){if(e.isShell){delete e.isShell;var i=n["!type"];if(i)p(i,a,e);else{var o=n["!proto"]&&p(n["!proto"]);t.Obj.call(e,!(o instanceof t.Obj)||o,a)}}var s=n["!effects"];if(s&&e instanceof t.Fn)for(var l=0;l<s.length;++l)b(s[l],e);y(n,e);for(var u in n)if(r(n,u)&&33!=u.charCodeAt(0)){var f=n[u],c=e.defProp(u),g=a?a+"."+u:u;if("string"==typeof f)c.isEmpty()&&p(f,g).propagate(c);else{if(h(f)){if(!c.isEmpty())continue;p(f["!type"],g,null,!0).propagate(c)}else v(c.getObjType(),f,g);f["!doc"]&&(c.doc=f["!doc"]),f["!url"]&&(c.url=f["!url"]),f["!span"]&&(c.span=f["!span"])}}return e}function y(e,t){e["!doc"]&&(t.doc=e["!doc"]),e["!url"]&&(t.url=e["!url"]),e["!span"]&&(t.span=e["!span"]),e["!data"]&&(t.metaData=e["!data"])}function d(e,r){var n=t.cx(),a=n.parent;t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.localDefs=n.definitions[n.curOrigin]=Object.create(null),a&&a.signal("preLoadDef",e),g(r,e);var i=e["!define"];if(i){for(var o in i){var s=i[o];n.localDefs[o]="string"==typeof s?P(s):g(null,s,o)}for(var o in i){var s=i[o];"string"!=typeof s&&v(n.localDefs[o],i[o],o)}}v(r,e),a&&a.signal("postLoadDef",e),n.curOrigin=n.localDefs=null}var w=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};w.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r,n,a){var o=[],s=[],l=!1;if(!this.eat(")"))for(var p=0;;++p){var u,f=this.spec.indexOf(": ",this.pos);f!=-1&&(u=this.spec.slice(this.pos,f),/^[$\w?]+$/.test(u)?this.pos=f+2:u=null),s.push(u);var c=this.parseType(e);if(c.call&&(l=!0),o.push(c),!this.eat(", ")){this.eat(")")||this.error();break}}var h,g,v,y;if(this.eat(" -> ")){var d=this.pos;h=this.parseType(!0),h.call&&!l&&(g=h,h=t.ANull,v=d)}else h=t.ANull;return l?i(r,o,h,a):(n&&(y=this.base)?t.Fn.call(this.base,r,t.ANull,o,s,h,a):y=new t.Fn(r,t.ANull,o,s,h,a),g&&(y.computeRet=g),null!=v&&(y.computeRetSource=this.spec.slice(v,this.pos)),y)},parseType:function(e,r,n){var a=this.parseTypeMaybeProp(e,r,n);if(!this.eat("|"))return a;for(var i=[a],s=a.call;;){var l=this.parseTypeMaybeProp(e,r,n);if(i.push(l),l.call&&(s=!0),!this.eat("|"))break}if(s)return o(i);for(var p=new t.AVal,u=0;u<i.length;u++)i[u].propagate(p);return p.maxWeight=1e5,p},parseTypeMaybeProp:function(e,t,r){for(var n=this.parseTypeInner(e,t,r);e&&this.eat(".");)n=this.extendWithProp(n);return n},extendWithProp:function(e){var t=this.word(/[\w<>$!:]/)||this.error();return e.apply?function(r,n){return a(e(r,n),t)}:a(e,t)},parseTypeInner:function(e,r,n){var a;if(this.eat("fn(")||(a=this.eat("fn*(")))return this.parseFnType(e,r,n,a);if(this.eat("[")){for(var i,o=this.parseType(e),p=o.call;this.eat(", ");){i||(i=[o]);var u=this.parseType(e);i.push(u),p=p||u.call}return this.eat("]")||this.error(),p?i?l(i):s(o):n&&this.base?(t.Arr.call(this.base,i||o),this.base):new t.Arr(i||o)}if(this.eat("+")){var c=this.word(/[\w$<>\.:!]/),h=t.cx().localDefs[c+".prototype"];if(!h){var h=P(c);if(!(h instanceof t.Obj))return h;var g=f(h,["prototype"]);g&&(g=g.getObjType())&&(h=g)}return e&&this.eat("[")?this.parsePoly(h):n&&this.forceNew?new t.Obj(h):t.getInstance(h)}if(this.eat(":")){var r=this.word(/[\w$\.]/);return t.getSymbol(r)}if(e&&this.eat("!")){var v=this.word(/\d/);if(v)return v=Number(v),function(e,r){return r[v]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var y=this.word(/[\w$]/);return m[y]||function(){return t.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!:]/))}return this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!:`]/))},fromWord:function(e){var r=t.cx();switch(e){case"number":return r.num;case"string":return r.str;case"bool":return r.bool;case"<top>":return r.topScope}return r.localDefs&&e in r.localDefs?r.localDefs[e]:P(e)},parsePoly:function(e){var r,n="<i>";(r=this.spec.slice(this.pos).match(/^\s*([\w$:]+)\s*=\s*/))&&(n=r[1],this.pos+=r[0].length);var a=this.parseType(!0);if(this.eat("]")||this.error(),a.call)return function(r,i){var o=new t.Obj(e);return a(r,i).propagate(o.defProp(n)),o};var i=new t.Obj(e);return a.propagate(i.defProp(n)),i}};var A,b=e.parseEffect=function(e,r){var a;if(0==e.indexOf("propagate ")){var i=new w(e,10),o=i.parseType(!0);i.eat(" ")||i.error();var s=i.parseType(!0);u(r,function(e,t){n(o,e,t).propagate(n(s,e,t))})}else if(0==e.indexOf("call ")){var l=5==e.indexOf("and return ",5),i=new w(e,l?16:5),p=i.parseType(!0),f=null,c=[];for(i.eat(" this=")&&(f=i.parseType(!0));i.eat(" ");)c.push(i.parseType(!0));u(r,function(e,r){for(var a=n(p,e,r),i=f?n(f,e,r):t.ANull,o=[],s=0;s<c.length;++s)o.push(n(c[s],e,r));var u=l?new t.AVal:t.ANull;return a.propagate(new t.IsCallee(i,o,null,u)),u},l)}else if(a=e.match(/^custom (\S+)\s*(.*)/)){var h=m[a[1]];h&&u(r,a[2]?h(a[2]):h)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var i=new w(e,5),g=i.parseType(!0);i.eat(" ");var v=i.parseType(!0);u(r,function(e,r){var a=n(g,e,r),i=n(v,e,r);a.forAllProps(function(e,r,n){n&&"<i>"!=e&&i.propagate(new t.DefProp(e,r))})})}},P=e.parsePath=function(e,r){var n=t.cx(),a=n.paths[e],i=e;if(null!=a)return a;n.paths[e]=t.ANull;var o=r||A||n.topScope;if(n.localDefs)for(var s in n.localDefs)if(0==e.indexOf(s)){if(e==s)return n.paths[e]=n.localDefs[e];if("."==e.charAt(s.length)){o=n.localDefs[s],e=e.slice(s.length+1);break}}var l=f(o,e.split("."));return n.paths[i]=l==t.ANull?null:l,l};e.load=function(e,r){r||(r=t.cx().topScope);var n=A;A=r;try{d(e,r)}finally{A=n}},e.parse=function(e,r,n){var a=t.cx();r&&(a.origin=r,a.localDefs=a.definitions[r]);try{return"string"==typeof e?p(e,n):v(g(null,e,n),e,n)}finally{r&&(a.origin=a.localDefs=null)}};var m=Object.create(null);t.registerFunction=function(e,t){m[e]=t};var O=t.constraint({construct:function(e,t,r){this.created=e,this.target=t,this.spec=r},addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getObjType(!1)),n instanceof t.Obj)for(var a in n.props){var i=n.props[a].types[0],o=r.defProp(a);if(i&&i instanceof t.Obj&&i.props.value){var s=i.props.value.getType(!1);s&&o.addType(s)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new O(0,a,r[1])),a});var T=t.constraint({construct:function(e){this.target=e},addType:function(e){e instanceof t.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new t.IsCallee(t.ANull,[],null,this.target)))}});t.registerFunction("Object_defineProperty",function(e,r,n){if(n&&n.length>=3&&"Literal"==n[1].type&&"string"==typeof n[1].value){var a=r[0],i=new t.AVal;a.propagate(new t.DefProp(n[1].value,i,n[1])),r[2].propagate(new T(i))}return t.ANull}),t.registerFunction("Object_defineProperties",function(e,r,n){if(r.length>=2){var a=r[0];r[1].forAllProps(function(e,r,i){if(i){var o=new t.AVal;a.propagate(new t.DefProp(e,o,n&&n[1])),r.propagate(new T(o))}})}return t.ANull});var N=t.constraint({construct:function(e,t,r){this.self=e,this.args=t,this.target=r},addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,t.ANull,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval,e.generator)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new N(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),i=0;i<r.length;++i)r[i].propagate(a);return n}),t.registerFunction("Promise_ctor",function(e,r,n){var a=t.cx().definitions.ecma6;if(!a||r.length<1)return t.ANull;var i=new t.Obj(a["Promise.prototype"]),o=i.defProp(":t",n&&n[0]),s=new t.AVal;s.propagate(o);var l=new t.Fn("execute",t.ANull,[s],["value"],t.ANull),p=a.Promise_reject;return r[0].propagate(new t.IsCallee(t.ANull,[l,p],null,t.ANull)),i});var j=t.constraint({construct:function(e){this.output=e},addType:function(e){e.constructor==t.Obj&&"Promise"==e.name&&e.hasProp(":t")?e.getProp(":t").propagate(this.output):e.propagate(this.output)}}),x=50;return t.registerFunction("Promise_then",function(e,r,n){var a=r.length&&r[0].getFunctionType(),i=t.cx().definitions.ecma6;if(!a||!i)return e;var o,s=new t.Obj(i["Promise.prototype"]),l=s.defProp(":t",n&&n[0]);return a.retval.isEmpty()&&(o=e.getType())instanceof t.Obj&&o.hasProp(":t")&&o.getProp(":t").propagate(l,x),a.retval.propagate(new j(l)),s}),t.registerFunction("getOwnPropertySymbols",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return r[0].forAllProps(function(e,r,a){a&&":"==e.charAt(0)&&n.addType(t.getSymbol(e.slice(1)))}),n}),t.registerFunction("getSymbol",function(e,r,n){return n.length&&"Literal"==n[0].type&&"string"==typeof n[0].value?t.getSymbol(n[0].value):t.ANull}),e});
//# sourceMappingURL=def.min.js.map