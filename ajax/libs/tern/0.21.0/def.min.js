!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,t,r){return e.call?e(t,r):e}function a(e,r){if("!ret"==r){if(e.retval)return e.retval;var n=new t.AVal;return e.propagate(new t.IsCallee(t.ANull,[],null,n)),n}return e.getProp(r)}function i(e,r,a,i){return function(o,s){for(var p=[],l=0;l<r.length;l++)p.push(n(r[l],o,s));return new t.Fn(e,t.ANull,p,n(a,o,s),i)}}function o(e){return function(r,a){for(var i=new t.AVal,o=0;o<e.length;o++)n(e[o],r,a).propagate(i);return i.maxWeight=1e5,i}}function s(e){return function(r,n){return new t.Arr(e(r,n))}}function p(e){return function(r,a){return new t.Arr(e.map(function(e){return n(e,r,a)}))}}function l(e,r){return function(a,i){var o=new t.Obj;return e.forEach(function(e,t){o.defProp(e).addType(n(r[t],a,i))}),o}}function u(e){if(e instanceof t.Fn&&e.args)for(var r=0;r<e.args.length;++r){var n=e.args[r];n instanceof t.Fn&&n.args&&n.args.length&&f(e,r)}}function f(e,r){h(e,function(n,a){a[r]&&a[r].propagate(new t.IsCallee(t.cx().topScope,e.args[r].args,null,t.ANull))})}function c(e,r,n,a){var i=new P(e,null,n,a).parseType(!1,r,!0);return i instanceof t.AVal?i.types.forEach(u):u(i),i}function h(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,i,o){var s=t(e,i,o),p=n?n(e,i,o):a;return r?s:p}}function g(e,r){for(var n=0;n<r.length&&e!=t.ANull;++n){var a=r[n];if("!"==a.charAt(0))if("!proto"==a)e=e instanceof t.Obj&&e.proto||t.ANull;else{var i=e.getFunctionType();if(i)if("!ret"==a)e=i.retval&&i.retval.getType(!1)||t.ANull;else{var o=i.args&&i.args[Number(a.slice(1))];e=o&&o.getType(!1)||t.ANull}else e=t.ANull}else if(e instanceof t.Obj&&("prototype"==a&&e instanceof t.Fn||e.hasProp(a))){var s=e.getProp(a);e=!s||s.isEmpty()?t.ANull:s.types[0]}else e=t.ANull}return e}function v(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function y(e){if(!e["!type"]||/^(fn\(|\[|\+)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function d(e,n,a){if(!e){var i=n["!type"];if(i)if(/^fn\(/.test(i))e=v(t.Fn);else if("["==i.charAt(0))e=v(t.Arr);else{if("+"!=i.charAt(0))throw new Error("Invalid !type spec: "+i);e=v(t.Obj)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:v(t.Obj);e.name=a}for(var o in n)if(r(n,o)&&33!=o.charCodeAt(0)){var s=n[o];if("string"==typeof s||y(s))continue;var p=e.defProp(o);d(p.getObjType(),s,a?a+"."+o:o).propagate(p)}return e}function w(e,n,a){if(e.isShell){delete e.isShell;var i=n["!type"];if(i)c(i,a,e);else{var o=n["!proto"]&&c(n["!proto"]);t.Obj.call(e,!(o instanceof t.Obj)||o,a)}}var s=n["!effects"];if(s&&e instanceof t.Fn)for(var p=0;p<s.length;++p)T(s[p],e);A(n,e);for(var l in n)if(r(n,l)&&33!=l.charCodeAt(0)){var u=n[l],f=e.defProp(l),h=a?a+"."+l:l;if("string"==typeof u)f.isEmpty()&&c(u,h).propagate(f);else{if(y(u)){if(!f.isEmpty())continue;c(u["!type"],h,null,!0).propagate(f)}else w(f.getObjType(),u,h);u["!doc"]&&(f.doc=u["!doc"]),u["!url"]&&(f.url=u["!url"]),u["!span"]&&(f.span=u["!span"])}}return e}function A(e,t){e["!doc"]&&(t.doc=e["!doc"]),e["!url"]&&(t.url=e["!url"]),e["!span"]&&(t.span=e["!span"]),e["!data"]&&(t.metaData=e["!data"])}function b(e,r){var n=t.cx(),a=n.parent;t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.localDefs=n.definitions[n.curOrigin]=Object.create(null),a&&a.signal("preLoadDef",e),d(r,e);var i=e["!define"];if(i){for(var o in i){var s=i[o];n.localDefs[o]="string"==typeof s?N(s):d(null,s,o)}for(var o in i){var s=i[o];"string"!=typeof s&&w(n.localDefs[o],i[o],o)}}w(r,e),a&&a.signal("postLoadDef",e),n.curOrigin=n.localDefs=null}function m(){var e=t.cx().definitions.ecmascript;return e&&new t.Obj(e["Promise.prototype"])}var P=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};P.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r,n,a){var o=[],s=[],p=!1;if(!this.eat(")"))for(var l=0;;++l){var u,f=this.spec.indexOf(": ",this.pos);f!=-1&&(u=this.spec.slice(this.pos,f),/^(\.\.\.)?[$\w?]+$/.test(u)?this.pos=f+2:u=null),s.push(u);var c=this.parseType(e);if(c.call&&(p=!0),o.push(c),!this.eat(", ")){this.eat(")")||this.error();break}}var h,g,v,y;if(this.eat(" -> ")){var d=this.pos;h=this.parseType(!0),h.call&&!p&&(g=h,h=t.ANull,v=d)}else h=t.ANull;return p?i(r,o,h,a):(n&&(y=this.base)?t.Fn.call(this.base,r,t.ANull,o,s,h,a):y=new t.Fn(r,t.ANull,o,s,h,a),g&&(y.computeRet=g),null!=v&&(y.computeRetSource=this.spec.slice(v,this.pos)),y)},parseType:function(e,r,n){var a=this.parseTypeMaybeProp(e,r,n);if(!this.eat("|"))return a;for(var i=[a],s=a.call;;){var p=this.parseTypeMaybeProp(e,r,n);if(i.push(p),p.call&&(s=!0),!this.eat("|"))break}if(s)return o(i);for(var l=new t.AVal,u=0;u<i.length;u++)i[u].propagate(l);return l.maxWeight=1e5,l},parseTypeMaybeProp:function(e,t,r){for(var n=this.parseTypeInner(e,t,r);e&&this.eat(".");)n=this.extendWithProp(n);return n},extendWithProp:function(e){var t=this.word(/[\w<>$!:]/)||this.error();return e.apply?function(r,n){return a(e(r,n),t)}:a(e,t)},parseTypeInner:function(e,r,n){var a;if(this.eat("fn(")||(a=this.eat("fn*(")))return this.parseFnType(e,r,n,a);if(this.eat("[")){for(var i,o=this.parseType(e),u=o.call;this.eat(", ");){i||(i=[o]);var f=this.parseType(e);i.push(f),u=u||f.call}return this.eat("]")||this.error(),u?i?p(i):s(o):n&&this.base?(t.Arr.call(this.base,i||o),this.base):new t.Arr(i||o)}if(this.eat("{")){var i=[],c=[],u=!1;if(!this.eat("}"))for(var h=0;;++h){var v,y=this.spec.indexOf(": ",this.pos);y!=-1&&(v=this.spec.slice(this.pos,y),/^[$\w?]+$/.test(v)?this.pos=y+2:v=null);var d=this.parseType(e);if(d.call&&(u=!0),c.push(v),i.push(d),!this.eat(", ")){this.eat("}")||this.error();break}}if(u)return l(c,i);var w=new t.Obj;return c.forEach(function(e,t){w.defProp(e).addType(i[t])}),w}if(this.eat("+")){var A=this.word(/[\w$<>\.:!]/),b=t.cx().localDefs[A+".prototype"];if(!b){var b=N(A);if(!(b instanceof t.Obj))return b;var m=g(b,["prototype"]);m&&(m=m.getObjType())&&(b=m)}if(e&&this.eat("["))return this.parsePoly(b);if(n&&this.base){this.base.proto=b;var r=b.hasCtor&&b.hasCtor.name||b.name;return r&&(this.base.name=r),this.base}return n&&this.forceNew?new t.Obj(b):t.getInstance(b)}if(this.eat(":")){var r=this.word(/[\w$\.]/);return t.getSymbol(r)}if(e&&this.eat("!")){var P=this.word(/\d/);if(P)return P=Number(P),function(e,r){return r[P]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var O=this.word(/[\w$]/);return j[O]||function(){return t.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!:]/))}return this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!:`]/))},fromWord:function(e){var r=t.cx();switch(e){case"number":return r.num;case"string":return r.str;case"bool":return r.bool;case"<top>":return r.topScope}return r.localDefs&&e in r.localDefs?r.localDefs[e]:N(e)},parsePoly:function(e){var r,n="<i>";(r=this.spec.slice(this.pos).match(/^\s*([\w$:]+)\s*=\s*/))&&(n=r[1],this.pos+=r[0].length);var a=this.parseType(!0);if(this.eat("]")||this.error(),a.call)return function(r,i){var o=new t.Obj(e);return a(r,i).propagate(o.defProp(n)),o};var i=new t.Obj(e);return a.propagate(i.defProp(n)),i}};var O,T=e.parseEffect=function(e,r){var a;if(0==e.indexOf("propagate ")){var i=new P(e,10),o=i.parseType(!0);i.eat(" ")||i.error();var s=i.parseType(!0);h(r,function(e,t){n(o,e,t).propagate(n(s,e,t))})}else if(0==e.indexOf("call ")){var p=5==e.indexOf("and return ",5),i=new P(e,p?16:5),l=i.parseType(!0),u=null,f=[];for(i.eat(" this=")&&(u=i.parseType(!0));i.eat(" ");)f.push(i.parseType(!0));h(r,function(e,r){for(var a=n(l,e,r),i=u?n(u,e,r):t.ANull,o=[],s=0;s<f.length;++s)o.push(n(f[s],e,r));var c=p?new t.AVal:t.ANull;return a.propagate(new t.IsCallee(i,o,null,c)),c},p)}else if(a=e.match(/^custom (\S+)\s*(.*)/)){var c=j[a[1]];c&&h(r,a[2]?c(a[2]):c)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var i=new P(e,5),g=i.parseType(!0);i.eat(" ");var v=i.parseType(!0);h(r,function(e,r){var a=n(g,e,r),i=n(v,e,r);a.forAllProps(function(e,r,n){n&&"<i>"!=e&&i.propagate(new t.DefProp(e,r))})})}},N=e.parsePath=function(e,r){var n=t.cx(),a=n.paths[e],i=e;if(null!=a)return a;n.paths[e]=t.ANull;var o=r||O||n.topScope;if(n.localDefs)for(var s in n.localDefs)if(0==e.indexOf(s)){if(e==s)return n.paths[e]=n.localDefs[e];if("."==e.charAt(s.length)){o=n.localDefs[s],e=e.slice(s.length+1);break}}var p=g(o,e.split("."));return n.paths[i]=p==t.ANull?null:p,p};e.load=function(e,r){r||(r=t.cx().topScope);var n=O;O=r;try{b(e,r)}finally{O=n}},e.parse=function(e,r,n){var a=t.cx();r&&(a.origin=r,a.localDefs=a.definitions[r]);try{return"string"==typeof e?c(e,n):w(d(null,e,n),e,n)}finally{r&&(a.origin=a.localDefs=null)}};var j=Object.create(null);t.registerFunction=function(e,t){j[e]=t};var x=t.constraint({construct:function(e,t,r){this.created=e,this.target=t,this.spec=r},addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getObjType(!1)),n instanceof t.Obj)for(var a in n.props){var i=n.props[a].types[0],o=r.defProp(a);if(i&&i instanceof t.Obj&&i.props.value){var s=i.props.value.getType(!1);s&&o.addType(s)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new x(0,a,r[1])),a});var F=t.constraint({construct:function(e){this.target=e},addType:function(e){e instanceof t.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new t.IsCallee(t.ANull,[],null,this.target)))}});t.registerFunction("Object_defineProperty",function(e,r,n){if(n&&n.length>=3&&"Literal"==n[1].type&&"string"==typeof n[1].value){var a=r[0],i=new t.AVal;a.propagate(new t.DefProp(n[1].value,i,n[1])),r[2].propagate(new F(i))}return t.ANull}),t.registerFunction("Object_defineProperties",function(e,r,n){if(r.length>=2){var a=r[0];r[1].forAllProps(function(e,r,i){if(i){var o=new t.AVal;a.propagate(new t.DefProp(e,o,n&&n[1])),r.propagate(new F(o))}})}return t.ANull});var D=t.constraint({construct:function(e,t,r){this.self=e,this.args=t,this.target=r},addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,t.ANull,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval,e.generator)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new D(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),i=0;i<r.length;++i)r[i].propagate(a);return n}),t.registerFunction("Promise_ctor",function(e,r,n){var a=m();if(!a||r.length<1)return t.ANull;var i=a.defProp(":t",n&&n[0]),o=new t.AVal;o.propagate(i);var s=new t.Fn("execute",t.ANull,[o],["value"],t.ANull),p=t.cx().definitions.ecmascript.Promise_reject;return r[0].propagate(new t.IsCallee(t.ANull,[s,p],null,t.ANull)),a}),t.registerFunction("Promise_resolve",function(e,r,n){var a=m();if(!a)return t.ANull;if(r.length){var i=a.defProp(":t",n&&n[0]),o=new t.AVal;o.propagate(i),r[0].propagate(new S(o))}return a});var S=t.constraint({construct:function(e){this.output=e},addType:function(e){e.constructor==t.Obj&&"Promise"==e.name&&e.hasProp(":t")?e.getProp(":t").propagate(this.output):e.propagate(this.output)}}),V=50;return t.registerFunction("Promise_then",function(e,r,n){var a=r.length&&r[0].getFunctionType(),i=t.cx().definitions.ecmascript;if(!a||!i)return e;var o,s=new t.Obj(i["Promise.prototype"]),p=s.defProp(":t",n&&n[0]);return a.retval.isEmpty()&&(o=e.getType())instanceof t.Obj&&o.hasProp(":t")&&o.getProp(":t").propagate(p,V),a.retval.propagate(new S(p)),s}),t.registerFunction("getOwnPropertySymbols",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return r[0].forAllProps(function(e,r,a){a&&":"==e.charAt(0)&&n.addType(t.getSymbol(e.slice(1)))}),n}),t.registerFunction("getSymbol",function(e,r,n){return n&&n.length&&"Literal"==n[0].type&&"string"==typeof n[0].value?t.getSymbol(n[0].value):t.ANull}),e});
//# sourceMappingURL=def.min.js.map