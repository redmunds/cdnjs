!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,r,n,a){var s=new c(e,null,n,a).parseType(r,!0);if(/^fn\(/.test(e))for(var o=0;o<s.args.length;++o)(function(e){var r=s.args[e];r instanceof t.Fn&&r.args.length&&i(s,function(n,i){var a=i[e];a&&a.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(o);return s}function i(e,t,r){var n=e.computeRet,i=e.retval;e.computeRet=function(e,a){var s=t(e,a),o=n?n(e,a):i;return r?s:o}}function a(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function s(e){if(!e["!type"])return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t)return!1;return!0}function o(e,n,i){if(!e){var p=n["!type"];if(p)if(/^fn\(/.test(p))e=a(t.Fn);else{if("["!=p.charAt(0))throw new Error("Invalid !type spec: "+p);e=a(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:a(t.Obj);e.name=i}for(var l in n)if(r(n,l)&&33!=l.charCodeAt(0)){var f=n[l];if("string"==typeof f||s(f))continue;var c=e.defProp(l);o(c.getType(),f,i?i+"."+l:l).propagate(c)}return e}function p(e,i,a){if(e.isShell){delete e.isShell;var o=i["!type"];if(o)n(o,a,e);else{var l=i["!proto"]&&n(i["!proto"]);t.Obj.call(e,!(l instanceof t.Obj)||l,a)}}var f=i["!effects"];if(f&&e instanceof t.Fn)for(var c=0;c<f.length;++c)h(f[c],e);for(var u in i)if(r(i,u)&&33!=u.charCodeAt(0)){var v=i[u],y=e.defProp(u),d=a?a+"."+u:u,g=y.getType();if("string"==typeof v){if(g)continue;n(v,d).propagate(y)}else{if(s(v)){if(g)continue;v["!type"]||console.log(d),n(v["!type"],d,null,!0).propagate(y),g=y.getType()}else p(g,v,d);var w=v["!doc"],b=v["!url"];w&&(g&&g instanceof t.Obj&&(g.doc=w),y.doc=w),b&&(g&&g instanceof t.Obj&&(g.url=b),y.url=b)}}}function l(e,r){var n=t.cx();t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.loading=e,n.localDefs=Object.create(null),o(r,e);var i=e["!define"];if(i){for(var a in i){var s=i[a];n.localDefs[a]="string"==typeof s?v(s):o(null,s,a)}for(var a in i){var s=i[a];"string"!=typeof s&&p(n.localDefs[a],i[a])}}p(r,e),n.curOrigin=n.loading=n.localDefs=null}function f(){return d||(d=t.constraint("created, target, spec",{addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getType()),n instanceof t.Obj)for(var i in n.props){var a=n.props[i].types[0],s=r.defProp(i);if(a&&a instanceof t.Obj&&a.props.value){var o=a.props.value.getType();o&&s.addType(o)}}this.target.addType(r)}}}))}var c=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};c.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r){var n=[],i=[];if(!this.eat(")"))for(var a=0;;++a){var s,o=this.spec.indexOf(": ",this.pos);if(o!=-1&&(s=this.spec.slice(this.pos,o),/^[$\w?]+$/.test(s)?this.pos=o+2:s=null),i.push(s),n.push(this.parseType()),!this.eat(", ")){this.eat(")")||this.error();break}}var p,l,f;return this.eat(" -> ")?r&&this.spec.indexOf("!",this.pos)>-1?(p=t.ANull,l=this.parseRetType()):p=this.parseType():p=t.ANull,r&&(f=this.base)?t.Fn.call(this.base,e,t.ANull,n,i,p):f=new t.Fn(e,t.ANull,n,i,p),l&&(f.computeRet=l),f},parseType:function(e,r){if(this.eat("fn("))return this.parseFnType(e,r);if(this.eat("[")){var n=this.parseType();return this.eat("]")||this.error(),r&&this.base?(t.Arr.call(this.base,n),this.base):new t.Arr(n)}if(this.eat("+")){var i=this.word(/[\w$<>\.!]/),a=v(i+".prototype");return a instanceof t.Obj||(a=v(i)),a instanceof t.Obj?r&&this.forceNew?new t.Obj(a):t.getInstance(a):a}if(this.eat("?"))return t.ANull;var s=this.word(/[\w$<>\.!]/),o=t.cx();switch(s){case"number":return o.num;case"string":return o.str;case"bool":return o.bool;case"<top>":return o.topScope}return o.localDefs&&s in o.localDefs?o.localDefs[s]:v(s)},parseBaseRetType:function(){if(this.eat("[")){var e=this.parseRetType();return this.eat("]")||this.error(),function(r,n){return new t.Arr(e(r,n))}}if(this.eat("!")){var r=this.word(/\d/);if(r)return r=Number(r),function(e,n){return n[r]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var n=this.word(/[\w$]/);return y[n]||function(){return t.ANull}}this.error()}var i=this.parseType();return function(){return i}},extendRetType:function(e){var r=this.word(/[\w<>$!]/)||this.error();return"!ret"==r?function(r,n){var i=e(r,n);if(i.retval)return i.retval;var a=new t.AVal;return i.propagate(new t.IsCallee(t.ANull,[],null,a)),a}:function(t,n){return e(t,n).getProp(r)}},parseRetType:function(){for(var e=this.parseBaseRetType();this.eat(".");)e=this.extendRetType(e);return e}};var u,h=e.parseEffect=function(e,r){if(0==e.indexOf("propagate ")){var n=new c(e,10),a=n.parseRetType();n.eat(" ")||n.error();var s=n.parseRetType();i(r,function(e,t){a(e,t).propagate(s(e,t))})}else if(0==e.indexOf("call ")){var o=5==e.indexOf("and return ",5),n=new c(e,o?16:5),p=n.parseRetType(),l=null,f=[];for(n.eat(" this=")&&(l=n.parseRetType());n.eat(" ");)f.push(n.parseRetType());i(r,function(e,r){for(var n=p(e,r),i=l?l(e,r):t.ANull,a=[],s=0;s<f.length;++s)a.push(f[s](e,r));var c=o?new t.AVal:t.ANull;return n.propagate(new t.IsCallee(i,a,null,c)),c},o)}else if(0==e.indexOf("custom ")){var u=y[e.slice(7).trim()];u&&i(r,u)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var n=new c(e,5),h=n.parseRetType();n.eat(" ");var v=n.parseRetType();i(r,function(e,r){var n=h(e,r),i=v(e,r);n.forAllProps(function(e,r,n){n&&"<i>"!=e&&i.propagate(new t.PropHasSubset(e,r))})})}},v=e.parsePath=function(e){var r=t.cx(),n=r.paths[e];if(null!=n)return n;r.paths[e]=t.ANull;var i=u||r.topScope;if(r.localDefs)for(var a in r.localDefs)if(0==e.indexOf(a)){if(e==a)return r.paths[e]=r.localDefs[e];"."==e.charAt(a.length)&&(i=r.localDefs[a],e=e.slice(a.length+1))}for(var s=(/^Date.prototype/.test(e),e.split(".")),o=0;o<s.length&&i!=t.ANull;++o){var p=s[o];if("!"==p.charAt(0))if("!proto"==p)i=i instanceof t.Obj&&i.proto||t.ANull;else{var l=i.getFunctionType();if(l)if("!ret"==p)i=l.retval.getType()||t.ANull;else{var f=l.args[Number(p.slice(1))];i=f&&f.getType()||t.ANull}else i=t.ANull}else if(i instanceof t.Obj){var c=i.props[p];i=!c||c.isEmpty()?t.ANull:c.types[0]}}return r.paths[e]=i==t.ANull?null:i,i};e.load=function(e,r){r||(r=t.cx().topScope);var n=u;u=r;try{l(e,r)}finally{u=n}};var y=Object.create(null);t.registerFunction=function(e,t){y[e]=t};var d;return t.registerFunction("Object_create",function(e,r,n){if(n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var i=new t.AVal;return r[0]&&r[0].propagate(new(f())(0,i,r[1])),i}),e});
//# sourceMappingURL=def.min.js.map