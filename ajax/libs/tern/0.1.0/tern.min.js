!function(e){return"object"==typeof exports&&"object"==typeof module?e(exports,require("./infer"),require("acorn/acorn"),require("acorn/util/walk")):"function"==typeof define&&define.amd?define(["exports","./infer","acorn/acorn","acorn/util/walk"],e):void e(self.tern||(self.tern={}),tern,acorn,acorn.walk)}(function(e,t,n,r){"use strict";function i(e){this.name=e,this.scope=this.text=this.ast=this.lineOffsets=null}function o(e,n){e.text=n,e.ast=t.parse(n),e.lineOffsets=null}function s(e,n,r){if(n.query&&!B.hasOwnProperty(n.query.type))return r("No query type '"+n.query.type+"' defined");var i=n.query;i||r(null,{});for(var o=n.files||[],s=0;s<o.length;++s){var f=o[s];a(e,f.name,"full"==f.type?f.text:null)}if(!i)return void p(e,function(){});var u=B[i.type];if(u.takesFile){if("string"!=typeof i.file)return r(".query.file must be a string");/^#/.test(i.file)||a(e,i.file)}p(e,function(n){if(n)return r(n);var s=u.takesFile&&v(e,o,i.file);return u.fullFile&&"part"==s.type?r("Can't run a "+i.type+" query on a file fragment"):void t.withContext(e.cx,function(){var t;try{t=u.run(e,i,s)}catch(t){return e.options.debug&&console.log(t.stack),r(t)}r(null,t)})})}function f(e,n){return++e.analyses,t.withContext(e.cx,function(){n.scope=e.cx.topScope,e.signal("beforeLoad",n),t.markVariablesDefinedBy(n.scope,n.name),t.analyze(n.ast,n.name,n.scope),t.purgeMarkedVariables(n.scope),e.signal("afterLoad",n)}),n}function a(e,t,n){var r=c(e.files,t);if(r)return void(n&&u(e,r,n));var s=new i(t);e.files.push(s),n?o(s,n):e.options.async?(e.startAsyncAction(),e.options.getFile(t,function(t,n){t||o(s,n||""),e.finishAsyncAction(t)})):o(s,e.options.getFile(t)||"")}function u(e,n,r){n.scope&&(t.withContext(e.cx,function(){t.purgeTypes(n.name)}),n.scope=null),null!=r&&o(n,r)}function l(e,t){var n=function(){e.off("everythingFetched",n),clearTimeout(r),p(e,t)};e.on("everythingFetched",n);var r=setTimeout(n,e.options.fetchTimeout)}function p(e,t){if(e.pending)return l(e,t);var n=e.fetchError;if(n)return e.fetchError=null,t(n);for(var r=!0,i=0;i<e.files.length;++i){var o=e.files[i];null==o.text?r=!1:null==o.scope&&f(e,o)}r?t():l(e,t)}function c(e,t){for(var n=0;n<e.length;++n){var r=e[n];if(r.name==t&&"part"!=r.type)return r}}function d(e){var t=e.indexOf("\n");return t<0?e:e.slice(0,t)}function h(e,t,n){var r=Math.max(0,n-500),i=null;if(!/^\s*$/.test(e))for(;;){var o=t.indexOf(e,r);if(o<0||o>n+500)break;(null==i||Math.abs(i-n)>Math.abs(o-n))&&(i=o),r=o+e.length}return i}function y(e){for(var t=0;e;++t,e=e.prev);return t}function v(e,n,r){var i=r.match(/^#(\d+)$/);if(!i)return c(e.files,r);var o=n[i[1]];if(!o)throw new Error("Reference to unknown file "+r);if("full"==o.type)return c(e.files,o.name);var s=o.backing=c(e.files,o.name),f=o.offset;null==f&&(f=o.offset=x(s,o.offsetLines)||0);var a=d(o.text),u=h(a,s.text,f),l=null==u?Math.max(0,s.text.lastIndexOf("\n",f)):u;return t.withContext(e.cx,function(){t.purgeTypes(o.name,l,l+o.text.length);var e,n=o.text;if(u&&(e=a.match(/^(.*?)\bfunction\b/))){for(var r=e[1].length,i="",f=0;f<r;++f)i+=" ";n=i+n.slice(r)}var p=t.scopeAt(s.ast,l,s.scope),c=t.scopeAt(s.ast,l+n.length,s.scope),d=o.scope=y(p)<y(c)?c:p;t.markVariablesDefinedBy(p,o.name,l,l+o.text.length),o.ast=t.parse(o.text),t.analyze(o.ast,o.name,d),t.purgeMarkedVariables(p);var h=t.scopeAt(s.ast,l+a.length,s.scope);if(e&&h!=d&&h.fnType){var v=t.scopeAt(o.ast,a.length,d),g=h.fnType,m=v.fnType;if(m&&(m.name==g.name||!g.name)){for(var f=0,x=Math.min(g.args.length,m.args.length);f<x;++f)g.args[f].propagate(m.args[f]);g.self.propagate(m.self),m.retval.propagate(g.retval)}}}),o}function g(e){return"number"==typeof e||"object"==typeof e&&"number"==typeof e.line&&"number"==typeof e.ch}function m(e){if(e.query){if("string"!=typeof e.query.type)return".query.type must be a string";if(e.query.start&&!g(e.query.start))return".query.start must be a number";if(e.query.end&&!g(e.query.end))return".query.end must be a number"}if(e.files){if(!Array.isArray(e.files))return"Files property must be an array";for(var t=0;t<e.files.length;++t){var n=e.files[t];if("object"!=typeof n)return".files[n] must be objects";if("string"!=typeof n.text)return".files[n].text must be a string";if("string"!=typeof n.name)return".files[n].name must be a string";if("part"==n.type){if("number"!=typeof n.offset&&"number"!=typeof n.offsetLines)return".files[n].offset or .files[n].offsetLines must be a number"}else if("full"!=n.type)return'.files[n].type must be "full" or "part"'}}}function x(e,t){for(var n=e.text,r=e.lineOffsets||(e.lineOffsets=[0]),i=0,o=0,s=Math.min(Math.floor(t/Q),r.length-1),i=r[s],o=s*Q;o<t;){if(++o,i=n.indexOf("\n",i)+1,0==i)return null;o%Q==0&&r.push(i)}return i}function b(e,t){if("number"!=typeof t){var n=x(e,t.line);if(null==n)throw new Error("File doesn't contain a line "+t.line);t=n+t.ch}if(t>e.text.length)throw new Error("Position "+t+" is outside of file.");return t}function w(e,t){if(!e)return{line:0,ch:0};for(var n,r,i=e.lineOffsets||(e.lineOffsets=[0]),o=e.text,s=i.length-1;s>=0;--s)i[s]<=t&&(n=s*Q,r=i[s]);for(;;){var f=o.indexOf("\n",r);if(f>=t||f<0)break;r=f+1,++n}return{line:n,ch:t-r}}function A(e,t,n){if(e.lineCharPositions){var r=w(t,n);return"part"==t.type&&(r.line+=null!=t.offsetLines?t.offsetLines:w(t.backing,t.offset).line),r}return n+("part"==t.type?t.offset:0)}function F(e){for(var t in e)null==e[t]&&delete e[t];return e}function E(e,t,n){null!=n&&(e[t]=n)}function k(e,t){"string"!=typeof e&&(e=e.name,t=t.name);var n=/^[A-Z]/.test(e),r=/^[A-Z]/.test(t);return n==r?e<t?-1:e==t?0:1:n?1:-1}function q(e,t,n){return"Literal"==e.type&&"string"==typeof e.value&&e.start==t-1&&e.end<=n+1}function O(e,r,i){function o(n,i,o){if((r.omitObjectPrototype===!1||i!=e.cx.protos.Object||u)&&(r.filter===!1||!u||0==n.indexOf(u))){for(var s=0;s<l.length;++s){var f=l[s];if((p?f.name:f)==n)return}var a=p?{name:n}:n;if(l.push(a),r.types||r.docs||r.urls||r.origins){var c=i?i.props[n]:t.ANull;t.resetGuessing();var d=c.getType();a.guess=t.didGuess(),r.types&&(a.type=t.toString(d)),r.docs&&E(a,"doc",c.doc||d&&d.doc),r.urls&&E(a,"url",c.url||d&&d.url),r.origins&&E(a,"origin",c.origin||d&&d.origin)}r.depths&&(a.depth=o)}}if(null==r.end)throw new Error("missing .query.end field");for(var s=b(i,r.end),f=s,a=i.text;s&&n.isIdentifierChar(a.charCodeAt(s-1));)--s;if(r.expandWordForward!==!1)for(;f<a.length&&n.isIdentifierChar(a.charCodeAt(f));)++f;var u=a.slice(s,f),l=[],p=r.types||r.depths||r.docs||r.urls||r.origins,c=t.findExpressionAround(i.ast,null,s,i.scope,"MemberExpression");if(c&&(c.node.computed?q(c.node.property,s,f):c.node.object.end<s)){var d=c.node.property;d="Literal"==d.type?d.value.slice(1):d.name,c.node=c.node.object;var h=t.expressionType(c);if(h&&t.forAllPropertiesOf(h,o),!l.length&&r.guess!==!1&&h&&h.guessProperties&&h.guessProperties(function(e,t,n){e!=d&&"âœ–"!=e&&o(e,t,n)}),!l.length&&u.length>=2&&r.guess!==!1)for(var d in e.cx.props)o(d,e.cx.props[d][0],0)}else t.forAllLocalsAt(i.ast,s,i.scope,o);return r.sort!==!1&&l.sort(k),{start:A(r,i,s),end:A(r,i,f),completions:l}}function T(e,t){var n=t.prefix,r=[];for(var i in e.cx.props)"<i>"==i||n&&0!=i.indexOf(n)||r.push(i);return t.sort!==!1&&r.sort(k),{completions:r}}function C(e,n,r){var i=Z(r,n);t.resetGuessing();var o=t.expressionType(i);if(o=n.preferFunction?o.getFunctionType()||o.getType():o.getType(),"Identifier"==i.node.type)var s=i.node.name;else if("MemberExpression"==i.node.type&&!i.node.computed)var s=i.node.property.name;if(null!=n.depth&&"number"!=typeof n.depth)throw new Error(".query.depth must be a number");var f={guess:t.didGuess(),type:t.toString(o,n.depth),name:o&&o.name,exprName:s};return o&&M(o,f),F(f)}function j(e,n,r){var i=Z(r,n),o=t.expressionType(i),s={url:o.url,doc:o.doc},f=o.getType();return f&&M(f,s),F(s)}function N(e,n){var i=r.findNodeAt(n,e.start,e.end,e.type,t.fullVisitor);return i&&i.node==e}function M(e,n){n.url||(n.url=e.url),n.doc||(n.doc=e.doc),n.origin||(n.origin=e.origin);var r,i=t.cx().protos;!n.url&&!n.doc&&e.proto&&(r=e.proto.hasCtor)&&e.proto!=i.Object&&e.proto!=i.Function&&e.proto!=i.Array&&(n.url=r.url,n.doc=r.doc)}function P(e,n,r){var i,o=Z(r,n);t.resetGuessing();var s=t.expressionType(o),f=s.originNode,i=s.origin,a={url:s.url,doc:s.doc,origin:s.origin};if(s.types)for(var u=s.types.length-1;u>=0;--u){var l=s.types[u];if(M(l,a),!f&&l.originNode){f=l.originNode,i=l.origin;break}}if(f&&/^Function/.test(f.type)&&f.id&&(f=f.id),a.guess=t.didGuess(),f){var p=c(e.files,i);"part"==r.type&&r.name==i&&N(f,r.ast)&&(p=r);var d=A(n,p,f.start),h=A(n,p,f.end);a.start=d,a.end=h,a.file=i;var y=Math.max(0,f.start-50);a.contextOffset=f.start-y,a.context=p.text.slice(y,y+50)}return F(a)}function L(e,n,r,i,o){function s(e){return function(t,r){if(o)for(var i=r;i!=a;i=i.prev){var s=i.hasProp(o);if(s)throw new Error("Renaming `"+f+"` to `"+o+"` would make a variable at line "+(w(e,t.start).line+1)+" point to the definition at line "+(w(e,s.name.start).line+1))}l.push({file:e.name,start:A(n,e,t.start),end:A(n,e,t.end)})}}for(var f=i.node.name,a=i.state;a&&!(f in a.props);a=a.prev);if(!a)throw new Error("Could not find a definition for "+f+" "+!!e.cx.topScope.props.x);var u,l=[];if(a.node){if(u="local",o){for(var p=a.prev;p&&!(o in p.props);p=p.prev);p&&t.findRefs(a.node,a,o,p,function(e){throw new Error("Renaming `"+f+"` to `"+o+"` would shadow the definition used at line "+(w(r,e.start).line+1))})}t.findRefs(a.node,a,f,a,s(r))}else{u="global";for(var c=0;c<e.files.length;++c){var d=e.files[c];t.findRefs(d.ast,d.scope,f,a,s(d))}}return{refs:l,type:u,name:f}}function I(e,n,r,i){function o(e){return function(t){f.push({file:e.name,start:A(n,e,t.start),end:A(n,e,t.end)})}}var s=t.expressionType(r).getType();if(!s)throw new Error("Couldn't determine type of base object.");for(var f=[],a=0;a<e.files.length;++a){var u=e.files[a];t.findPropRefs(u.ast,u.scope,s,i.name,o(u))}return{refs:f,name:i.name}}function R(e,t,n){var r=Z(n,t,!0);if(r&&"Identifier"==r.node.type)return L(e,t,n,r);if(r&&"MemberExpression"==r.node.type&&!r.node.computed){var i=r.node.property;return r.node=r.node.object,I(e,t,r,i)}if(r&&"ObjectExpression"==r.node.type)for(var o=b(n,t.end),s=0;s<r.node.properties.length;++s){var f=r.node.properties[s].key;if(f.start<=o&&f.end>=o)return I(e,t,r,f)}throw new Error("Not at a variable or property name.")}function G(e,t,n){if("string"!=typeof t.newName)throw new Error(".query.newName should be a string");var r=Z(n,t);if(!r||"Identifier"!=r.node.type)throw new Error("Not at a variable.");var i=L(e,t,n,r,t.newName),o=i.refs;delete i.refs,i.files=e.files.map(function(e){return e.name});for(var s=i.changes=[],f=0;f<o.length;++f){var a=o[f];a.text=t.newName,s.push(a)}return i}function S(e,t){return{files:e.files.map(function(e){return e.name})}}var V=Object.create(null);e.registerPlugin=function(e,t){V[e]=t};var z={debug:!1,async:!1,getFile:function(e,t){this.async&&t(null,null)},defs:[],plugins:{},fetchTimeout:1e3},B={completions:{takesFile:!0,run:O},properties:{run:T},type:{takesFile:!0,run:C},documentation:{takesFile:!0,run:j},definition:{takesFile:!0,run:P},refs:{takesFile:!0,fullFile:!0,run:R},rename:{takesFile:!0,fullFile:!0,run:G},files:{run:S}};e.defineQueryType=function(e,t){B[e]=t};var D=e.Server=function(e){this.cx=null,this.options=e||{};for(var t in z)e.hasOwnProperty(t)||(e[t]=z[t]);this.handlers={},this.files=[],this.analyses=0,this.pending=0,this.asyncError=null,this.defs=e.defs.slice(0);for(var n in e.plugins)if(e.plugins.hasOwnProperty(n)&&n in V){var r=V[n](this,e.plugins[n]);r&&r.defs&&this.defs.push(r.defs)}this.reset()};D.prototype={addFile:function(e,t){a(this,e,t)},delFile:function(e){for(var t,n=0;n<this.files.length;++n)if((t=this.files[n]).name==e)return u(this,t),void this.files.splice(n--,1)},reset:function(){this.cx=new t.Context(this.defs,this),this.analyses=0;for(var e=0;e<this.files.length;++e)u(this,this.files[e]);this.signal("reset")},request:function(e,t){var n=m(e);if(n)return t(n);var r=this;e.files||[];s(this,e,function(e,n){t(e,n),r.analyses>40&&(r.reset(),p(r,function(){}))})},findFile:function(e){return c(this.files,e)},flush:function(e){var n=this.cx;p(this,function(r){return r?e(r):void t.withContext(n,e)})},on:function(e,t){(this.handlers[e]||(this.handlers[e]=[])).push(t)},off:function(e,t){var n=this.handlers[e];if(n)for(var r=0;r<n.length;++r)if(n[r]==t){n.splice(r,1);break}},signal:function(e,t,n,r,i){var o=this.handlers[e];if(o)for(var s=0;s<o.length;++s)o[s].call(this,t,n,r,i)},startAsyncAction:function(){++this.pending},finishAsyncAction:function(e){e&&(this.asyncError=e),0==--this.pending&&this.signal("everythingFetched")}};var Q=25,Z=e.findQueryExpr=function(e,n,r){if(null==n.end)throw new Error("missing .query.end field");if(n.variable){var i=t.scopeAt(e.ast,b(e,n.end),e.scope);return{node:{type:"Identifier",name:n.variable,start:n.end,end:n.end+1},state:i}}var o=n.start&&b(e,n.start),s=b(e,n.end),f=t.findExpressionAt(e.ast,o,s,e.scope);if(f)return f;if(f=t.findExpressionAround(e.ast,o,s,e.scope),f&&(r||(null==o?s:o)-f.node.start<20||f.node.end-s<20))return f;throw new Error("No expression at the given position.")};e.version="0.1.0"});
//# sourceMappingURL=tern.min.js.map