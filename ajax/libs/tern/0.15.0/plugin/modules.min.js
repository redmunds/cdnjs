!function(e){return"object"==typeof exports&&"object"==typeof module?e(require("../lib/infer"),require("../lib/tern"),require("../lib/signal"),require):"function"==typeof define&&define.amd?define(["../lib/infer","../lib/tern","../lib/signal"],e):void e(tern,tern,tern.signal)}(function(e,t,n,i){"use strict";function o(e,t){this.server=e,this.options=t||{},this.modules=Object.create(null),this.nonRelative=Object.create(null),this.resolvers=[],this.modNameTests=[],this.importTests=[],this.completables=[]}function r(e,t){if(/^https?:|^\//.test(t))return t;e&&!/\/$/.test(e)&&(e+="/");for(var n;n=/^\.(\.)?\//.exec(t);){if(n[1]&&e.length>1){var i=e.lastIndexOf("/",e.length-2);e=i==-1?"":e.slice(0,i+1)}t=t.slice(n[0].length)}return e+t}function s(e){var t=e.lastIndexOf("/");return t==-1?"":e.slice(0,t+1)}function a(e){var t=e.lastIndexOf("/");return t==-1?e:e.slice(t+1)}function l(t,n){if(/^\.\.?\//.test(t)){var i=r(s(n),t),o=e.cx().parent;return o.findFile(i)?i:o.findFile(i+".js")?i+".js":void 0}}function u(e){return/^\.\.?\//.test(e)}function d(e,t,n){return n.filter===!1||!e||0==(n.caseInsensitive?t.toLowerCase():t).indexOf(e)}function p(t){var n=e.cx().parent.mod.modules.modules,i=t.roots["!modules"]=new e.Obj(null);for(var o in n){var r=n[o],s=r.origin||o,a=i.defProp(s.replace(/\./g,"`"));r.propagate(a),a.origin=r.origin}}function c(t){var n=e.cx(),i=n.definitions[t["!name"]]["!modules"],o=n.parent.mod.modules;if(i)for(var r in i.props){var s=r.replace(/`/g,"."),a=o.get(s);a.origin=s,i.props[r].propagate(a)}}function f(t,n,i,o){if(!i)return o;var r=e.cx().parent.mod.modules,s=r.getModType(i.node);return s?(o=Object.create(o),o.origin=s.origin,o.originNode=s.originNode,s.doc&&(o.doc=s.doc),s.url&&(o.url=s.url),o):o}function m(n,i){var o=t.resolvePos(n,i.end),r=e.cx().parent.mod.modules,s=e.findExpressionAround(n.ast,null,o,n.scope,"Literal"),a=s&&r.isModName(s.node);if(null!=a){var l=s.node;if(!("Literal"!=l.type||"string"!=typeof l.value||l.start>o||l.end<o)){var d=l.raw.slice(1,o-l.start),p=l.raw.charAt(0);d&&d.charAt(d.length-1)==p&&(d=d.slice(0,d.length-1)),i.caseInsensitive&&(d=d.toLowerCase());var c=[];return u(d)?r.completeFileName(c,i,n.name,d):r.completeModuleName(c,i,d),l.end==o+1&&n.text.charAt(o)==p&&++o,{start:t.outputPos(i,n,l.start),end:t.outputPos(i,n,o),isProperty:!1,completions:c.map(function(e){var t="string"==typeof e?e:e.name,n=JSON.stringify(t);return"'"==p&&(n=p+n.slice(1,n.length-1).replace(/'/g,"\\'")+p),"string"==typeof e?n:(e.displayName=t,e.name=n,e)})}}}}o.prototype=n.mixin({buildWrappingScope:function(t,n,i){var o=new e.Scope(t,i);return o.origin=n,this.signal("wrapScope",o),o},maybeOverride:function(t){if(!this.options.modules||!this.options.modules.hasOwnProperty(t))return!1;if(this.modules[t])return this.modules[t];var n=this.options.modules[t];if("string"==typeof n&&"="==n.charAt(0))return e.def.parsePath(n.slice(1));var i=this.buildWrappingScope(e.cx().topScope,t);return e.def.load(n,i),this.modules[t]=i.exports},resolveModule:function(t,n){var i=this.maybeOverride(t);if(i)return i;if(1==this.options.dontLoad||this.options.dontLoad&&new RegExp(this.options.dontLoad).test(t)||this.options.load&&!new RegExp(this.options.load).test(t))return e.ANull;for(var o,r=u(t),s=0;!o&&s<this.resolvers.length;s++)o=this.resolvers[s](t,n);if(o||(o=l(t,n)),!o)return e.ANull;if("string"!=typeof o)return r||(this.nonRelative[t]=!0),o;var a=this.modules[o];return a?a:(/\.js$|(?:^\/)[^\.]+$/.test(o)&&this.server.addFile(o,null,n),r||(this.nonRelative[t]=o),this.modules[o]=new e.AVal)},findIn:function(e,t){for(var n=0;n<e.length;n++){var i=e[n](t);if(null!=i)return i}},isModName:function(e){return this.findIn(this.modNameTests,e)},isImport:function(e){return this.findIn(this.importTests,e)},get:function(t){return this.modules[t]||(this.modules[t]=new e.AVal)},completeModuleName:function(e,n,i){function o(o,r){for(var s in o)d(i,s,n)&&t.addCompletion(n,e,s,r&&o[s])}for(var r=0;r<this.completables.length;r++)o(this.completables[r](this.server),!0);this.options.modules&&o(this.options.modules,!1);var s=Object.create(null);for(var a in this.nonRelative){var l=this.nonRelative[a];if(1==l||a.indexOf("/")==-1)d(i,a,n)&&t.addCompletion(n,e,a);else if(0==a.indexOf(i)&&i.indexOf("/")>-1){var u=/.*?\/(.*)/.exec(a)[1],p=l.indexOf(u);if(p>-1){var c=l.slice(0,p)+(/.*?\/(.*\/)?/.exec(i)[1]||"");if(c in s)continue;s[c]=!0,this.completeFileName(e,n,null,i,c)}}}},completeFileName:function(e,n,i,o,l){var u=i?r(s(i),o):a(o);for(var p in this.modules)if(p!=i&&d(u,p,n)){/\.js$/.test(p)&&(p=p.slice(0,p.length-3));var c=p.slice(u.length);t.addCompletion(n,e,o+c,this.modules[p])}},getModType:function(e){var t,n,i=this.isModName(e);if(null==i&&(t=this.isImport(e))&&(i=t.name,n=t.prop),null!=i){var o=this.resolveModule(i,e.sourceFile.name);return(n?o.getProp(n):o).getType()}}}),i&&function(){var e=i("fs"),n=i("path");o.prototype.completeFileName=function(i,o,r,s,a){var l=this.server.projectDir,u=/\/$/.test(s);if(r){var p=n.resolve(l,n.dirname(r),s);a=u?p:n.dirname(p)}var c=u?s:n.dirname(s)+"/",f=u?"":n.basename(s),m=this;e.readdirSync(a).forEach(function(e){if(!/^\./.test(e)&&d(f,e,o)){var s=n.relative(l,n.resolve(a,e));if(s==r)return;var u=m.modules[s];/\.js$/.test(e)&&(e=e.slice(0,e.length-3)),t.addCompletion(o,i,c+e,u)}})}}(),t.registerPlugin("modules",function(e,t){e.mod.modules=new o(e,t),e.on("beforeLoad",function(e){e.scope=this.mod.modules.buildWrappingScope(e.scope,e.name,e.ast)}),e.on("afterLoad",function(e){var t=this.mod.modules.get(e.name);t.origin=e.name,this.mod.modules.signal("getExports",e,t)}),e.on("reset",function(){this.mod.modules.modules=Object.create(null)}),e.on("preCondenseReach",p),e.on("postLoadDef",c),e.on("typeAt",f),e.on("completion",m)}),t.defineQueryType("exports",{takesFile:!0,run:function(n,i,o){function r(o){var r={},s=o.getType(!1);r.type=e.toString(s,3);var a=o.doc||s&&s.doc,l=o.url||s&&s.url;a&&(r.doc=a),l&&(r.url=l);var u=t.getSpan(o)||s&&t.getSpan(s);return u&&t.storeSpan(n,i,u,r),r}var s=n.mod.modules,a=s&&s.modules[o.name];if(!a)return{};var l=r(a),u=a.getType(!1);if(u instanceof e.Obj){var d=l.props={};for(var p in u.props)d[p]=r(u.props[p])}return l}})});
//# sourceMappingURL=modules.min.js.map