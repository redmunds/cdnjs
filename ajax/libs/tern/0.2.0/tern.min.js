!function(e){return"object"==typeof exports&&"object"==typeof module?e(exports,require("./infer"),require("./signal"),require("acorn/acorn"),require("acorn/util/walk")):"function"==typeof define&&define.amd?define(["exports","./infer","./signal","acorn/acorn","acorn/util/walk"],e):void e(self.tern||(self.tern={}),tern,tern.signal,acorn,acorn.walk)}(function(e,t,n,r,i){"use strict";function s(e){this.name=e,this.scope=this.text=this.ast=this.lineOffsets=null}function o(e,n,r){e.text=n,e.ast=t.parse(n,r.passes),e.lineOffsets=null}function a(e,n,r){if(n.query&&!D.hasOwnProperty(n.query.type))return r("No query type '"+n.query.type+"' defined");var i=n.query;i||r(null,{});var s=n.files||[];s.length&&++e.uses;for(var o=0;o<s.length;++o){var a=s[o];u(e,a.name,"full"==a.type?a.text:null)}if(!i)return void c(e,function(){});var f=D[i.type];if(f.takesFile){if("string"!=typeof i.file)return r(".query.file must be a string");/^#/.test(i.file)||u(e,i.file)}c(e,function(n){if(n)return r(n);var o=f.takesFile&&g(e,s,i.file);return f.fullFile&&"part"==o.type?r("Can't run a "+i.type+" query on a file fragment"):void t.withContext(e.cx,function(){var t;try{t=f.run(e,i,o)}catch(t){return e.options.debug&&console.log(t.stack),r(t)}r(null,t)})})}function f(e,n){return t.withContext(e.cx,function(){n.scope=e.cx.topScope,e.signal("beforeLoad",n),t.markVariablesDefinedBy(n.scope,n.name),t.analyze(n.ast,n.name,n.scope,e.passes),t.purgeMarkedVariables(n.scope),e.signal("afterLoad",n)}),n}function u(e,t,n){var r=d(e.files,t);if(r)return void(n&&l(e,r,n));var i=new s(t);e.files.push(i),n?o(i,n,e):e.options.async?(e.startAsyncAction(),e.options.getFile(t,function(t,n){o(i,n||"",e),e.finishAsyncAction(t)})):o(i,e.options.getFile(t)||"",e)}function l(e,n,r){n.scope&&(t.withContext(e.cx,function(){t.purgeTypes(n.name)}),n.scope=null),null!=r&&o(n,r,e)}function p(e,t){var n=function(){e.off("everythingFetched",n),clearTimeout(r),c(e,t)};e.on("everythingFetched",n);var r=setTimeout(n,e.options.fetchTimeout)}function c(e,t){if(e.pending)return p(e,t);var n=e.fetchError;if(n)return e.fetchError=null,t(n);for(var r=!0,i=0;i<e.files.length;++i){var s=e.files[i];null==s.text?r=!1:null==s.scope&&f(e,s)}r?t():p(e,t)}function d(e,t){for(var n=0;n<e.length;++n){var r=e[n];if(r.name==t&&"part"!=r.type)return r}}function h(e){var t=e.indexOf("\n");return t<0?e:e.slice(0,t)}function v(e,t,n){var r=Math.max(0,n-500),i=null;if(!/^\s*$/.test(e))for(;;){var s=t.indexOf(e,r);if(s<0||s>n+500)break;(null==i||Math.abs(i-n)>Math.abs(s-n))&&(i=s),r=s+e.length}return i}function y(e){for(var t=0;e;++t,e=e.prev);return t}function g(e,n,r){var i=r.match(/^#(\d+)$/);if(!i)return d(e.files,r);var s=n[i[1]];if(!s)throw new Error("Reference to unknown file "+r);if("full"==s.type)return d(e.files,s.name);var o=s.backing=d(e.files,s.name),a=s.offset;s.offsetLines&&(a={line:s.offsetLines,ch:0}),s.offset=a=w(o,null==s.offsetLines?s.offset:{line:s.offsetLines,ch:0},!0);var f=h(s.text),u=v(f,o.text,a),l=null==u?Math.max(0,o.text.lastIndexOf("\n",a)):u;return t.withContext(e.cx,function(){t.purgeTypes(s.name,l,l+s.text.length);var n,r=s.text;if(u&&(n=f.match(/^(.*?)\bfunction\b/))){for(var i=n[1].length,a="",p=0;p<i;++p)a+=" ";r=a+r.slice(i)}var c=t.scopeAt(o.ast,l,o.scope),d=t.scopeAt(o.ast,l+r.length,o.scope),h=s.scope=y(c)<y(d)?d:c;t.markVariablesDefinedBy(c,s.name,l,l+s.text.length),s.ast=t.parse(s.text,e.passes),t.analyze(s.ast,s.name,h,e.passes),t.purgeMarkedVariables(c);var v=t.scopeAt(o.ast,l+f.length,o.scope);if(n&&v!=h&&v.fnType){var g=t.scopeAt(s.ast,f.length,h),m=v.fnType,x=g.fnType;if(x&&(x.name==m.name||!m.name)){for(var p=0,b=Math.min(m.args.length,x.args.length);p<b;++p)m.args[p].propagate(x.args[p]);m.self.propagate(x.self),x.retval.propagate(m.retval)}}}),s}function m(e){return"number"==typeof e||"object"==typeof e&&"number"==typeof e.line&&"number"==typeof e.ch}function x(e){if(e.query){if("string"!=typeof e.query.type)return".query.type must be a string";if(e.query.start&&!m(e.query.start))return".query.start must be a position";if(e.query.end&&!m(e.query.end))return".query.end must be a position"}if(e.files){if(!Array.isArray(e.files))return"Files property must be an array";for(var t=0;t<e.files.length;++t){var n=e.files[t];if("object"!=typeof n)return".files[n] must be objects";if("string"!=typeof n.text)return".files[n].text must be a string";if("string"!=typeof n.name)return".files[n].name must be a string";if("part"==n.type){if(!m(n.offset)&&"number"!=typeof n.offsetLines)return".files[n].offset must be a position"}else if("full"!=n.type)return'.files[n].type must be "full" or "part"'}}}function b(e,t){for(var n=e.text,r=e.lineOffsets||(e.lineOffsets=[0]),i=0,s=0,o=Math.min(Math.floor(t/Z),r.length-1),i=r[o],s=o*Z;s<t;){if(++s,i=n.indexOf("\n",i)+1,0==i)return null;s%Z==0&&r.push(i)}return i}function w(e,t,n){if("number"!=typeof t){var r=b(e,t.line);if(null==r){if(!n)throw new Error("File doesn't contain a line "+t.line);t=e.text.length}else t=r+t.ch}if(t>e.text.length){if(!n)throw new Error("Position "+t+" is outside of file.");t=e.text.length}return t}function A(e,t){if(!e)return{line:0,ch:0};for(var n,r,i=e.lineOffsets||(e.lineOffsets=[0]),s=e.text,o=i.length-1;o>=0;--o)i[o]<=t&&(n=o*Z,r=i[o]);for(;;){var a=s.indexOf("\n",r);if(a>=t||a<0)break;r=a+1,++n}return{line:n,ch:t-r}}function F(e,t,n){if(e.lineCharPositions){var r=A(t,n);return"part"==t.type&&(r.line+=null!=t.offsetLines?t.offsetLines:A(t.backing,t.offset).line),r}return n+("part"==t.type?t.offset:0)}function E(e){for(var t in e)null==e[t]&&delete e[t];return e}function O(e,t,n){null!=n&&(e[t]=n)}function q(e,t){"string"!=typeof e&&(e=e.name,t=t.name);var n=/^[A-Z]/.test(e),r=/^[A-Z]/.test(t);return n==r?e<t?-1:e==t?0:1:n?1:-1}function k(e,t,n){return"Literal"==e.type&&"string"==typeof e.value&&e.start==t-1&&e.end<=n+1}function T(e,n,i){function s(r,i,s){if((n.omitObjectPrototype===!1||i!=e.cx.protos.Object||u)&&(n.filter===!1||!u||0==(n.caseInsensitive?r.toLowerCase():r).indexOf(u))){for(var o=0;o<l.length;++o){var a=l[o];if((p?a.name:a)==r)return}var f=p?{name:r}:r;if(l.push(f),n.types||n.docs||n.urls||n.origins){var c=i?i.props[r]:t.ANull;t.resetGuessing();var d=c.getType();f.guess=t.didGuess(),n.types&&(f.type=t.toString(d)),n.docs&&O(f,"doc",c.doc||d&&d.doc),n.urls&&O(f,"url",c.url||d&&d.url),n.origins&&O(f,"origin",c.origin||d&&d.origin)}n.depths&&(f.depth=s)}}if(null==n.end)throw new Error("missing .query.end field");for(var o=w(i,n.end),a=o,f=i.text;o&&r.isIdentifierChar(f.charCodeAt(o-1));)--o;if(n.expandWordForward!==!1)for(;a<f.length&&r.isIdentifierChar(f.charCodeAt(a));)++a;var u=f.slice(o,a),l=[];n.caseInsensitive&&(u=u.toLowerCase());var p=n.types||n.depths||n.docs||n.urls||n.origins,c=t.findExpressionAround(i.ast,null,o,i.scope,"MemberExpression");if(c&&(c.node.computed?k(c.node.property,o,a):c.node.object.end<o)){var d=c.node.property;d="Literal"==d.type?d.value.slice(1):d.name,c.node=c.node.object;var h=t.expressionType(c);if(h&&t.forAllPropertiesOf(h,s),!l.length&&n.guess!==!1&&h&&h.guessProperties&&h.guessProperties(function(e,t,n){e!=d&&"âœ–"!=e&&s(e,t,n)}),!l.length&&u.length>=2&&n.guess!==!1)for(var d in e.cx.props)s(d,e.cx.props[d][0],0)}else t.forAllLocalsAt(i.ast,o,i.scope,s);return n.sort!==!1&&l.sort(q),{start:F(n,i,o),end:F(n,i,a),completions:l}}function C(e,t){var n=t.prefix,r=[];for(var i in e.cx.props)"<i>"==i||n&&0!=i.indexOf(n)||r.push(i);return t.sort!==!1&&r.sort(q),{completions:r}}function N(e,n,r){var i=W(r,n);t.resetGuessing();var s=t.expressionType(i);if(s=n.preferFunction?s.getFunctionType()||s.getType():s.getType(),"Identifier"==i.node.type)var o=i.node.name;else if("MemberExpression"==i.node.type&&!i.node.computed)var o=i.node.property.name;if(null!=n.depth&&"number"!=typeof n.depth)throw new Error(".query.depth must be a number");var a={guess:t.didGuess(),type:t.toString(s,n.depth),name:s&&s.name,exprName:o};return s&&P(s,a),E(a)}function j(e,n,r){var i=W(r,n),s=t.expressionType(i),o={url:s.url,doc:s.doc},a=s.getType();return a&&P(a,o),E(o)}function L(e,n){var r=i.findNodeAt(n,e.start,e.end,e.type,t.fullVisitor);return r&&r.node==e}function P(e,n){n.url||(n.url=e.url),n.doc||(n.doc=e.doc),n.origin||(n.origin=e.origin);var r,i=t.cx().protos;!n.url&&!n.doc&&e.proto&&(r=e.proto.hasCtor)&&e.proto!=i.Object&&e.proto!=i.Function&&e.proto!=i.Array&&(n.url=r.url,n.doc=r.doc)}function M(e){if(e.origin){if(e.originNode){var t=e.originNode;return/^Function/.test(t.type)&&t.id&&(t=t.id),{origin:e.origin,node:t}}return e.span?{origin:e.origin,span:e.span}:void 0}}function I(e,n,r){var i=W(r,n);t.resetGuessing();var s=t.expressionType(i);if(t.didGuess())return{};var o=M(s),a={url:s.url,doc:s.doc,origin:s.origin};if(s.types)for(var f=s.types.length-1;f>=0;--f){var u=s.types[f];P(u,a),o||(o=M(u))}if(o&&o.node){var l=d(e.files,o.origin);"part"==r.type&&r.name==o.origin&&o.node&&L(o.node,r.ast)&&(l=r);var p=F(n,l,o.node.start),c=F(n,l,o.node.end);a.start=p,a.end=c,a.file=o.origin;var h=Math.max(0,o.node.start-50);a.contextOffset=o.node.start-h,a.context=l.text.slice(h,h+50)}else if(o){a.file=o.origin;var v=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(o.span);a.start=n.lineCharPositions?{line:Number(v[2]),ch:Number(v[3])}:Number(v[1]),a.end=n.lineCharPositions?{line:Number(v[5]),ch:Number(v[6])}:Number(v[4])}return E(a)}function R(e,n,r,i,s){function o(e){return function(t,r){if(s)for(var i=r;i!=f;i=i.prev){var o=i.hasProp(s);if(o)throw new Error("Renaming `"+a+"` to `"+s+"` would make a variable at line "+(A(e,t.start).line+1)+" point to the definition at line "+(A(e,o.name.start).line+1))}l.push({file:e.name,start:F(n,e,t.start),end:F(n,e,t.end)})}}for(var a=i.node.name,f=i.state;f&&!(a in f.props);f=f.prev);if(!f)throw new Error("Could not find a definition for "+a+" "+!!e.cx.topScope.props.x);var u,l=[];if(f.node){if(u="local",s){for(var p=f.prev;p&&!(s in p.props);p=p.prev);p&&t.findRefs(f.node,f,s,p,function(e){throw new Error("Renaming `"+a+"` to `"+s+"` would shadow the definition used at line "+(A(r,e.start).line+1))})}t.findRefs(f.node,f,a,f,o(r))}else{u="global";for(var c=0;c<e.files.length;++c){var d=e.files[c];t.findRefs(d.ast,d.scope,a,f,o(d))}}return{refs:l,type:u,name:a}}function G(e,n,r,i){function s(e){return function(t){a.push({file:e.name,start:F(n,e,t.start),end:F(n,e,t.end)})}}var o=t.expressionType(r).getType();if(!o)throw new Error("Couldn't determine type of base object.");for(var a=[],f=0;f<e.files.length;++f){var u=e.files[f];t.findPropRefs(u.ast,u.scope,o,i.name,s(u))}return{refs:a,name:i.name}}function S(e,t,n){var r=W(n,t,!0);if(r&&"Identifier"==r.node.type)return R(e,t,n,r);if(r&&"MemberExpression"==r.node.type&&!r.node.computed){var i=r.node.property;return r.node=r.node.object,G(e,t,r,i)}if(r&&"ObjectExpression"==r.node.type)for(var s=w(n,t.end),o=0;o<r.node.properties.length;++o){var a=r.node.properties[o].key;if(a.start<=s&&a.end>=s)return G(e,t,r,a)}throw new Error("Not at a variable or property name.")}function V(e,t,n){if("string"!=typeof t.newName)throw new Error(".query.newName should be a string");var r=W(n,t);if(!r||"Identifier"!=r.node.type)throw new Error("Not at a variable.");var i=R(e,t,n,r,t.newName),s=i.refs;delete i.refs,i.files=e.files.map(function(e){return e.name});for(var o=i.changes=[],a=0;a<s.length;++a){var f=s[a];f.text=t.newName,o.push(f)}return i}function $(e){return{files:e.files.map(function(e){return e.name})}}var z=Object.create(null);e.registerPlugin=function(e,t){z[e]=t};var B={debug:!1,async:!1,getFile:function(e,t){this.async&&t(null,null)},defs:[],plugins:{},fetchTimeout:1e3},D={completions:{takesFile:!0,run:T},properties:{run:C},type:{takesFile:!0,run:N},documentation:{takesFile:!0,run:j},definition:{takesFile:!0,run:I},refs:{takesFile:!0,fullFile:!0,run:S},rename:{takesFile:!0,fullFile:!0,run:V},files:{run:$}};e.defineQueryType=function(e,t){D[e]=t},s.prototype.asLineChar=function(e){return A(this,e)};var Q=e.Server=function(e){this.cx=null,this.options=e||{};for(var t in B)e.hasOwnProperty(t)||(e[t]=B[t]);this.handlers=Object.create(null),this.files=[],this.uses=0,this.pending=0,this.asyncError=null,this.passes=Object.create(null),this.defs=e.defs.slice(0);for(var n in e.plugins)if(e.plugins.hasOwnProperty(n)&&n in z){var r=z[n](this,e.plugins[n]);if(r&&r.defs&&this.defs.push(r.defs),r&&r.passes)for(var i in r.passes)r.passes.hasOwnProperty(i)&&(this.passes[i]||(this.passes[i]=[])).push(r.passes[i])}this.reset()};Q.prototype=n.mixin({addFile:function(e,t){u(this,e,t)},delFile:function(e){for(var t,n=0;n<this.files.length;++n)if((t=this.files[n]).name==e)return l(this,t),void this.files.splice(n--,1)},reset:function(){this.cx=new t.Context(this.defs,this),this.uses=0;for(var e=0;e<this.files.length;++e)l(this,this.files[e]);this.signal("reset")},request:function(e,t){var n=x(e);if(n)return t(n);var r=this;a(this,e,function(e,n){t(e,n),r.uses>40&&(r.reset(),c(r,function(){}))})},findFile:function(e){return d(this.files,e)},flush:function(e){var n=this.cx;c(this,function(r){return r?e(r):void t.withContext(n,e)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(e){e&&(this.asyncError=e),0==--this.pending&&this.signal("everythingFetched")}});var Z=25,W=e.findQueryExpr=function(e,n,r){if(null==n.end)throw new Error("missing .query.end field");if(n.variable){var i=t.scopeAt(e.ast,w(e,n.end),e.scope);return{node:{type:"Identifier",name:n.variable,start:n.end,end:n.end+1},state:i}}var s=n.start&&w(e,n.start),o=w(e,n.end),a=t.findExpressionAt(e.ast,s,o,e.scope);if(a)return a;if(a=t.findExpressionAround(e.ast,s,o,e.scope),a&&(r||(null==s?o:s)-a.node.start<20||a.node.end-o<20))return a;throw new Error("No expression at the given position.")};e.version="0.2.0"});
//# sourceMappingURL=tern.min.js.map