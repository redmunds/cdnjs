!function(t,r){return"object"==typeof exports&&"object"==typeof module?r(exports,require("acorn"),require("acorn/dist/acorn_loose"),require("acorn/dist/walk"),require("./def"),require("./signal")):"function"==typeof define&&define.amd?define(["exports","acorn/dist/acorn","acorn/dist/acorn_loose","acorn/dist/walk","./def","./signal"],r):void r(t.tern||(t.tern={}),acorn,acorn,acorn.walk,tern.def,tern.signal)}(this,function(t,r,e,n,o,i){"use strict";function s(t,r){var e=Object.create(t);if(r)for(var n in r)e[n]=r[n];return e}function p(t,r,e){var n=t.getType(!1),o=r.getType(!1);return!n||!o||a(n,o,e)}function a(t,r,e){if(!t||e>=5)return r;if(!t||t==r)return t;if(!r)return t;if(t.constructor!=r.constructor)return!1;if(t.constructor!=at){if(t.constructor==st){var n=0,o=0,i=0;for(var s in t.props)n++,s in r.props&&p(t.props[s],r.props[s],e+1)&&i++;for(var s in r.props)o++;return!(n&&o&&i<Math.max(n,o)/2)&&(n>o?t:r)}return t.constructor==pt&&(!!(t.args.length==r.args.length&&t.args.every(function(t,n){return p(t,r.args[n],e+1)})&&p(t.retval,r.retval,e+1)&&p(t.self,r.self,e+1))&&t)}var u=t.getProp("<i>").getType(!1);if(!u)return r;var f=r.getProp("<i>").getType(!1);return!f||a(u,f,e+1)?r:void 0}function u(t){for(var r=0,e=0,n=0,o=null,i=0;i<t.length;++i){var s=t[i];if(s instanceof at)++r;else if(s instanceof pt)++e;else if(s instanceof st)++n;else if(s instanceof it){if(o&&s.name!=o.name)return null;o=s}}var p=(r&&1)+(e&&1)+(n&&1)+(o&&1);if(p>1)return null;if(o)return o;for(var a=0,u=null,i=0;i<t.length;++i){var s=t[i],f=0;if(r)f=s.getProp("<i>").isEmpty()?1:2;else if(e){f=1;for(var c=0;c<s.args.length;++c)s.args[c].isEmpty()||++f;s.retval.isEmpty()||++f}else n&&(f=s.name?100:2);f>=a&&(a=f,u=s)}return u}function f(t,r){ut.disabledComputing={fn:t,prev:ut.disabledComputing};var e=r();return ut.disabledComputing=ut.disabledComputing.prev,e}function c(t,r){var e=ut.props[t]||(ut.props[t]=[]);e.push(r)}function h(t){return ut.props[t]}function l(r){if(ut.workList)return r(ut.workList);for(var e=[],n=0,o=ut.workList=function(t,r,o){n<ct-ht*e.length&&e.push(t,r,o,n)},i=r(o),s=0;s<e.length;s+=4){if(ft&&+new Date>=ft)throw new t.TimedOut;n=e[s+3]+1,e[s+1].addType(e[s],e[s+2])}return ut.workList=null,i}function g(t,r){t.fnType&&(t.fnType.instantiateScore=(t.fnType.instantiateScore||0)+r)}function y(t,r){try{return n.simple(t,{Expression:function(){if(--r<=0)throw gt}}),!0}catch(t){if(t==gt)return!1;throw t}}function d(t,r){var e=r.fnType.instantiateScore;return!ut.disabledComputing&&e&&r.fnType.args.length&&y(t,5*e)?(g(r.prev,e/2),v(t,r),!0):void(r.fnType.instantiateScore=null)}function v(t,r){for(var e=r.fnType,o=0;o<e.args.length;++o)e.args[o]=new U;e.self=new U,e.computeRet=function(o,i){return f(e,function(){var s=ut.curOrigin;ut.curOrigin=e.origin;var p=new lt(r.prev);p.originNode=r.originNode;for(var a in r.props)for(var u=p.defProp(a,r.props[a].originNode),f=0;f<i.length;++f)e.argNames[f]==a&&f<i.length&&i[f].propagate(u);for(var c=e.argNames.length!=i.length?e.argNames.slice(0,i.length):e.argNames;c.length<i.length;)c.push("?");if(p.fnType=new pt(e.name,o,i,c,I),p.fnType.originNode=e.originNode,e.arguments){var h=p.fnType.arguments=new U;p.defProp("arguments").addType(new at(h));for(var f=0;f<i.length;++f)i[f].propagate(h)}return t.body.scope=p,n.recursive(t.body,p,null,yt),n.recursive(t.body,p,null,vt),ut.curOrigin=s,p.fnType.retval})}}function m(t){function r(t,e,o){if(!(o>3)&&t.forward)for(var i=0;i<t.forward.length;++i){var s=t.forward[i].propagatesTo();if(s){var p,a=e;if(s instanceof U)p=s;else{if(!(s.target instanceof U))continue;a+=s.pathExt,p=s.target}if(p==n)return a;var u=r(p,a,o+1);if(u)return u}}}var e=t.fnType,n=e.retval;if(n!=I){var i,s;!n.isEmpty()&&(i=n.getType())instanceof at&&(n=s=i.getProp("<i>"));for(var p=r(e.self,"!this",0),a=0;!p&&a<e.args.length;++a)p=r(e.args[a],"!"+a,0);if(p){s&&(p="["+p+"]");var u=new o.TypeParser(p),f=u.parseType(!0);return e.computeRet=f.apply?f:function(){return f},e.computeRetSource=p,!0}}}function P(t,r){return t.defProp(r.name,r)}function T(t){return"Identifier"==t.type?t.name:"AssignmentPattern"==t.type?T(t.left):"__"}function b(t,r,e){var n=t.property;return t.computed?"Literal"==n.type&&"string"==typeof n.value?n.value:(e&&S(n,r,e,I),"<i>"):n.name}function w(t){switch(t){case"+":case"-":case"~":return ut.num;case"!":return ut.bool;case"typeof":return ut.str;case"void":case"delete":return I}}function x(t){switch(t){case"==":case"!=":case"===":case"!==":case"<":case">":case">=":case"<=":case"in":case"instanceof":return!0}}function E(t){if(t.regex)return X(ut.protos.RegExp);switch(typeof t.value){case"boolean":return ut.bool;case"number":return ut.num;case"string":return ut.str;case"object":case"function":return t.value?X(ut.protos.RegExp):I}}function O(t){return function(r,e,n,o,i){var s=t(r,e,n,i);return o&&s.propagate(o),s}}function N(t){return function(r,e,n,o,i){return o||(o=new U),t(r,e,n,o,i),o}}function S(t,r,e,n,o){var i=dt[t.type];return i?i(t,r,e,n,o):I}function j(t,r){var e=t&&t[r],n=Array.prototype.slice.call(arguments,2);if(e)for(var o=0;o<e.length;++o)e[o].apply(null,n)}function A(t,r,e){var n=Array.isArray(t);return n&&1==t.length&&(t=t[0],n=!1),n?null==e?function(r){return t.indexOf(r.origin)>-1}:function(n,o){return o&&o.start>=r&&o.end<=e&&t.indexOf(n.origin)>-1}:null==e?function(r){return r.origin==t}:function(n,o){return o&&o.start>=r&&o.end<=e&&n.origin==t}}function k(t){wt=!0;var r=h(t);if(r)for(var e=0;e<r.length;++e){var n=r[e].getProp(t);if(!n.isEmpty())return n}return I}function C(t,r){var e=Pt[t.type];return e?e(t,r):I}var F=t.toString=function(t,r,e){return!t||t==e||r&&r<-3?"?":t.toString(r,e)},I=t.ANull=i.mixin({addType:function(){},propagate:function(){},getProp:function(){return I},forAllProps:function(){},hasType:function(){return!1},isEmpty:function(){return!0},getFunctionType:function(){},getObjType:function(){},getType:function(){},gatherProperties:function(){},propagatesTo:function(){},typeHint:function(){},propHint:function(){},toString:function(){return"?"}}),H=100,_=90,R=10,M=6,B=6,L=90,G=2,q=4,U=t.AVal=function(){this.types=[],this.forward=null,this.maxWeight=0};U.prototype=s(I,{addType:function(t,r){if(r=r||H,this.maxWeight<r){if(this.maxWeight=r,1==this.types.length&&this.types[0]==t)return;this.types.length=0}else if(this.maxWeight>r||this.types.indexOf(t)>-1)return;this.signal("addType",t),this.types.push(t);var e=this.forward;e&&l(function(n){for(var o=0;o<e.length;++o)n(t,e[o],r)})},propagate:function(t,r){if(!(t==I||t instanceof ot&&this.forward&&this.forward.length>2)){r&&r!=H&&(t=new nt(t,r)),(this.forward||(this.forward=[])).push(t);var e=this.types;e.length&&l(function(n){for(var o=0;o<e.length;++o)n(e[o],t,r)})}},getProp:function(t){if("__proto__"==t||"✖"==t)return I;var r=(this.props||(this.props=Object.create(null)))[t];return r||(r=this.props[t]=new U,this.propagate(new W(t,r))),r},forAllProps:function(t){this.propagate(new $(t))},hasType:function(t){return this.types.indexOf(t)>-1},isEmpty:function(){return 0===this.types.length},getFunctionType:function(){for(var t=this.types.length-1;t>=0;--t)if(this.types[t]instanceof pt)return this.types[t]},getObjType:function(){for(var t=null,r=this.types.length-1;r>=0;--r){var e=this.types[r];if(e instanceof st){if(e.name)return e;t||(t=e)}}return t},getType:function(t){return 0===this.types.length&&t!==!1?this.makeupType():1===this.types.length?this.types[0]:u(this.types)},toString:function(t,r){if(0==this.types.length)return F(this.makeupType(),t,r);if(1==this.types.length)return F(this.types[0],t,r);var e=V(this.types);return e.length>2?"?":e.map(function(e){return F(e,t,r)}).join("|")},makeupPropType:function(t){var r=this.propertyName,e=t.proto&&t.proto.hasProp(r);if(e){var n=e.getType();if(n)return n}if("<i>"!=r){var o=t.hasProp("<i>");if(o)return o.getType()}else if(t.props["<i>"]!=this)for(var i in t.props){var s=t.props[i];if(!s.isEmpty())return s.getType()}},makeupType:function(){var t=this.propertyOf&&this.makeupPropType(this.propertyOf);if(t)return t;if(!this.forward)return null;for(var r=this.forward.length-1;r>=0;--r){var e=this.forward[r].typeHint();if(e&&!e.isEmpty())return wt=!0,e}for(var n=Object.create(null),o=null,r=0;r<this.forward.length;++r){var i=this.forward[r].propHint();i&&"length"!=i&&"<i>"!=i&&"✖"!=i&&i!=ut.completingProperty&&(n[i]=!0,o=i)}if(!o)return null;var s=h(o);if(s){var p=[];t:for(var r=0;r<s.length;++r){var a=s[r];for(var i in n)if(!a.hasProp(i))continue t;a.hasCtor&&(a=X(a)),p.push(a)}var f=u(p);if(f)return wt=!0,f}},typeHint:function(){return this.types.length?this.getType():null},propagatesTo:function(){return this},gatherProperties:function(t,r){for(var e=0;e<this.types.length;++e)this.types[e].gatherProperties(t,r)},guessProperties:function(t){if(this.forward)for(var r=0;r<this.forward.length;++r){var e=this.forward[r].propHint();e&&t(e,null,0)}var n=this.makeupType();n&&n.gatherProperties(t)}});var V=t.simplifyTypes=function(t){var r=[];t:for(var e=0;e<t.length;++e){for(var n=t[e],o=0;o<r.length;o++){var i=a(n,r[o],0);if(i){r[o]=i;continue t}}r.push(n)}return r},D=t.constraint=function(t){var r=function(){this.origin=ut.curOrigin,this.construct.apply(this,arguments)};r.prototype=Object.create(I);for(var e in t)t.hasOwnProperty(e)&&(r.prototype[e]=t[e]);return r},W=D({construct:function(t,r){this.prop=t,this.target=r},addType:function(t,r){t.getProp&&t.getProp(this.prop).propagate(this.target,r)},propHint:function(){return this.prop},propagatesTo:function(){if("<i>"==this.prop||!/[^\w_]/.test(this.prop))return{target:this.target,pathExt:"."+this.prop}}}),z=t.PropHasSubset=D({construct:function(t,r,e){this.prop=t,this.type=r,this.originNode=e},addType:function(t,r){if(t instanceof st){var e=t.defProp(this.prop,this.originNode);e.origin||(e.origin=this.origin),this.type.propagate(e,r)}},propHint:function(){return this.prop}}),$=D({construct:function(t){this.c=t},addType:function(t){t instanceof st&&t.forAllProps(this.c)}}),J=t.IsCallee=D({construct:function(t,r,e,n){this.self=t,this.args=r,this.argNodes=e,this.retval=n,this.disabled=ut.disabledComputing},addType:function(t,r){if(t instanceof pt){for(var e=0;e<this.args.length;++e)e<t.args.length&&this.args[e].propagate(t.args[e],r),t.arguments&&this.args[e].propagate(t.arguments,r);this.self.propagate(t.self,this.self==ut.topScope?L:r);var n=t.computeRet;if(n)for(var o=this.disabled;o;o=o.prev)(o.fn==t||t.originNode&&o.fn.originNode==t.originNode)&&(n=null);if(n){var i=ut.disabledComputing;ut.disabledComputing=this.disabled,n(this.self,this.args,this.argNodes).propagate(this.retval,r),ut.disabledComputing=i}else t.retval.propagate(this.retval,r)}},typeHint:function(){for(var t=[],r=0;r<this.args.length;++r)t.push("?");return new pt(null,this.self,this.args,t,I)},propagatesTo:function(){return{target:this.retval,pathExt:".!ret"}}}),K=D({construct:function(t,r,e,n){this.propName=t,this.args=r,this.argNodes=e,this.retval=n,this.disabled=ut.disabledComputing},addType:function(t,r){var e=new J(t,this.args,this.argNodes,this.retval);e.disabled=this.disabled,t.getProp(this.propName).propagate(e,r)},propHint:function(){return this.propName}}),Q=t.IsCtor=D({construct:function(t,r){this.target=t,this.noReuse=r},addType:function(t,r){t instanceof pt&&(ut.parent&&!ut.parent.options.reuseInstances&&(this.noReuse=!0),t.getProp("prototype").propagate(new Y(!this.noReuse&&t,this.target),r))}}),X=t.getInstance=function(t,r){if(r===!1)return new st(t);r||(r=t.hasCtor),t.instances||(t.instances=[]);for(var e=0;e<t.instances.length;++e){var n=t.instances[e];if(n.ctor==r)return n.instance}var o=new st(t,r&&r.name);return o.origin=t.origin,t.instances.push({ctor:r,instance:o}),o},Y=t.IsProto=D({construct:function(t,r){this.ctor=t,this.target=r},addType:function(t,r){t instanceof st&&((this.count=(this.count||0)+1)>8||(t==ut.protos.Array?this.target.addType(new at):this.target.addType(X(t,this.ctor))))}}),Z=D({construct:function(t){this.fn=t},addType:function(t,r){if(t instanceof st&&!t.hasCtor){t.hasCtor=this.fn;var e=new et(t,this.fn);e.addType(this.fn),t.forAllProps(function(t,r,n){n&&r.propagate(e)})}}}),tt=D({construct:function(t,r){this.other=t,this.target=r},addType:function(t,r){t==ut.str?this.target.addType(ut.str,r):t==ut.num&&this.other.hasType(ut.num)&&this.target.addType(ut.num,r)},typeHint:function(){return this.other}}),rt=t.IfObj=D({construct:function(t){this.target=t},addType:function(t,r){t instanceof st&&this.target.addType(t,r)},propagatesTo:function(){return this.target}}),et=D({construct:function(t,r){this.obj=t,this.ctor=r},addType:function(t){t instanceof pt&&t.self&&t.self.addType(X(this.obj,this.ctor),q)}}),nt=D({construct:function(t,r){this.inner=t,this.weight=r},addType:function(t,r){this.inner.addType(t,Math.min(r,this.weight))},propagatesTo:function(){return this.inner.propagatesTo()},typeHint:function(){return this.inner.typeHint()},propHint:function(){return this.inner.propHint()}}),ot=t.Type=function(){};ot.prototype=s(I,{constructor:ot,propagate:function(t,r){t.addType(this,r)},hasType:function(t){return t==this},isEmpty:function(){return!1},typeHint:function(){return this},getType:function(){return this}});var it=t.Prim=function(t,r){this.name=r,this.proto=t};it.prototype=s(ot.prototype,{constructor:it,toString:function(){return this.name},getProp:function(t){return this.proto.hasProp(t)||I},gatherProperties:function(t,r){this.proto&&this.proto.gatherProperties(t,r)}});var st=t.Obj=function(t,r){if(this.props||(this.props=Object.create(null)),this.proto=t===!0?ut.protos.Object:t,t&&!r&&t.name&&!(this instanceof pt)){var e=/^(.*)\.prototype$/.exec(this.proto.name);e&&(r=e[1])}this.name=r,this.maybeProps=null,this.origin=ut.curOrigin};st.prototype=s(ot.prototype,{constructor:st,toString:function(t){if(null==t&&(t=0),t<=0&&this.name)return this.name;var r=[],e=!1;for(var n in this.props)if("<i>"!=n){if(r.length>5){e=!0;break}t?r.push(n+": "+F(this.props[n],t-1,this)):r.push(n)}return r.sort(),e&&r.push("..."),"{"+r.join(", ")+"}"},hasProp:function(t,r){var e=this.props[t];if(r!==!1)for(var n=this.proto;n&&!e;n=n.proto)e=n.props[t];return e},defProp:function(t,r){var e=this.hasProp(t,!1);if(e)return r&&!e.originNode&&(e.originNode=r),e;if("__proto__"==t||"✖"==t)return I;var n=this.maybeProps&&this.maybeProps[t];return n?(delete this.maybeProps[t],this.maybeUnregProtoPropHandler()):(n=new U,n.propertyOf=this,n.propertyName=t),this.props[t]=n,n.originNode=r,n.origin=ut.curOrigin,this.broadcastProp(t,n,!0),n},getProp:function(t){var r=this.hasProp(t,!0)||this.maybeProps&&this.maybeProps[t];if(r)return r;if("__proto__"==t||"✖"==t)return I;var e=this.ensureMaybeProps()[t]=new U;return e.propertyOf=this,e.propertyName=t,e},broadcastProp:function(t,r,e){if(e&&(this.signal("addProp",t,r),this instanceof lt||c(t,this)),this.onNewProp)for(var n=0;n<this.onNewProp.length;++n){var o=this.onNewProp[n];o.onProtoProp?o.onProtoProp(t,r,e):o(t,r,e)}},onProtoProp:function(t,r,e){var n=this.maybeProps&&this.maybeProps[t];n&&(delete this.maybeProps[t],this.maybeUnregProtoPropHandler(),this.proto.getProp(t).propagate(n)),this.broadcastProp(t,r,!1)},ensureMaybeProps:function(){return this.maybeProps||(this.proto&&this.proto.forAllProps(this),this.maybeProps=Object.create(null)),this.maybeProps},removeProp:function(t){var r=this.props[t];delete this.props[t],this.ensureMaybeProps()[t]=r,r.types.length=0},forAllProps:function(t){this.onNewProp||(this.onNewProp=[],this.proto&&this.proto.forAllProps(this)),this.onNewProp.push(t);for(var r=this;r;r=r.proto)for(var e in r.props)t.onProtoProp?t.onProtoProp(e,r.props[e],r==this):t(e,r.props[e],r==this)},maybeUnregProtoPropHandler:function(){if(this.maybeProps){for(var t in this.maybeProps)return;this.maybeProps=null}!this.proto||this.onNewProp&&this.onNewProp.length||this.proto.unregPropHandler(this)},unregPropHandler:function(t){for(var r=0;r<this.onNewProp.length;++r)if(this.onNewProp[r]==t){this.onNewProp.splice(r,1);break}this.maybeUnregProtoPropHandler()},gatherProperties:function(t,r){for(var e in this.props)"<i>"!=e&&t(e,this,r);this.proto&&this.proto.gatherProperties(t,r+1)},getObjType:function(){return this}});var pt=t.Fn=function(t,r,e,n,o){st.call(this,ut.protos.Function,t),this.self=r,this.args=e,this.argNames=n,this.retval=o};pt.prototype=s(st.prototype,{constructor:pt,toString:function(t){null==t&&(t=0);for(var r="fn(",e=0;e<this.args.length;++e){e&&(r+=", ");var n=this.argNames[e];n&&"?"!=n&&(r+=n+": "),r+=t>-3?F(this.args[e],t-1,this):"?"}return r+=")",this.retval.isEmpty()||(r+=" -> "+(t>-3?F(this.retval,t-1,this):"?")),r},getProp:function(t){if("prototype"==t){var r=this.hasProp(t,!1);if(!r){r=this.defProp(t);var e=new st(!0,this.name&&this.name+".prototype");e.origin=this.origin,r.addType(e,R)}return r}return st.prototype.getProp.call(this,t)},defProp:function(t,r){if("prototype"==t){var e=this.hasProp(t,!1);return e?e:(e=st.prototype.defProp.call(this,t,r),e.origin=this.origin,e.propagate(new Z(this)),e)}return st.prototype.defProp.call(this,t,r)},getFunctionType:function(){return this}});var at=t.Arr=function(t){st.call(this,ut.protos.Array);var r=this.defProp("<i>");t&&t.propagate(r)};at.prototype=s(st.prototype,{constructor:at,toString:function(t){return null==t&&(t=0),"["+(t>-3?F(this.getProp("<i>"),t-1,this):"?")+"]"}}),t.Context=function(r,e){this.parent=e,this.props=Object.create(null),this.protos=Object.create(null),this.origins=[],this.curOrigin="ecma5",this.paths=Object.create(null),this.definitions=Object.create(null),this.purgeGen=0,this.workList=null,this.disabledComputing=null,t.withContext(this,function(){if(ut.protos.Object=new st(null,"Object.prototype"),ut.topScope=new lt,ut.topScope.name="<top>",ut.protos.Array=new st(!0,"Array.prototype"),ut.protos.Function=new pt("Function.prototype",I,[],[],I),ut.protos.Function.proto=ut.protos.Object,ut.protos.RegExp=new st(!0,"RegExp.prototype"),ut.protos.String=new st(!0,"String.prototype"),ut.protos.Number=new st(!0,"Number.prototype"),ut.protos.Boolean=new st(!0,"Boolean.prototype"),ut.str=new it(ut.protos.String,"string"),ut.bool=new it(ut.protos.Boolean,"bool"),ut.num=new it(ut.protos.Number,"number"),ut.curOrigin=null,r)for(var t=0;t<r.length;++t)o.load(r[t])})},t.Context.prototype.startAnalysis=function(){this.disabledComputing=this.workList=null};var ut=null;t.cx=function(){return ut},t.withContext=function(t,r){var e=ut;ut=t;try{return r()}finally{ut=e}},t.TimedOut=function(){this.message="Timed out",this.stack=(new Error).stack},t.TimedOut.prototype=Object.create(Error.prototype),t.TimedOut.prototype.name="infer.TimedOut";var ft;t.withTimeout=function(t,r){var e=+new Date+t,n=ft;if(n&&n<e)return r();ft=e;try{return r()}finally{ft=n}},t.addOrigin=function(t){ut.origins.indexOf(t)<0&&ut.origins.push(t)};var ct=20,ht=1e-4,lt=t.Scope=function(t){st.call(this,t||!0),this.prev=t};lt.prototype=s(st.prototype,{constructor:lt,defVar:function(t,r){for(var e=this;;e=e.proto){var n=e.props[t];if(n)return n;if(!e.prev)return e.defProp(t,r)}}});var gt={},yt=n.make({Function:function(t,r,e){var n=t.body.scope=new lt(r);n.originNode=t;for(var o=[],i=[],s=0;s<t.params.length;++s){var p=t.params[s];i.push(T(p)),o.push(P(n,p))}if(n.fnType=new pt(t.id&&t.id.name,new U,o,i,I),n.fnType.originNode=t,t.id){var a="FunctionDeclaration"==t.type;P(a?r:n,t.id)}e(t.body,n,"ScopeBody")},TryStatement:function(t,r,e){if(e(t.block,r,"Statement"),t.handler){var n=P(r,t.handler.param);e(t.handler.body,r,"ScopeBody");var o=ut.definitions.ecma5;o&&n.isEmpty()&&X(o["Error.prototype"]).propagate(n,B)}t.finalizer&&e(t.finalizer,r,"Statement")},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;++n){var o=t.declarations[n];"Identifier"==o.id.type&&P(r,o.id),o.init&&e(o.init,r,"Expression")}}}),dt={ArrayExpression:O(function(t,r,e){for(var n=new U,o=0;o<t.elements.length;++o){var i=t.elements[o];i&&S(i,r,e,n)}return new at(n)}),ObjectExpression:O(function(t,r,e,n){var o=t.objType=new st(!0,n);o.originNode=t;for(var i=0;i<t.properties.length;++i){var n,s=t.properties[i],p=s.key;if("✖"!=s.value.name){"Identifier"==p.type?n=p.name:"string"==typeof p.value&&(n=p.value);var a;if(n&&"set"!=s.kind){var u=a=o.defProp(n,p);u.initializer=!0,"get"==s.kind&&(a=new J(o,[],null,u))}else a=I;S(s.value,r,e,a,n),"FunctionExpression"==s.value.type&&s.value.body.scope.fnType.self.addType(o,G)}}return o}),FunctionExpression:O(function(t,r,e,n){var o=t.body.scope,i=o.fnType;return n&&!i.name&&(i.name=n),e(t.body,r,"ScopeBody"),d(t,o)||m(o),t.id&&o.getProp(t.id.name).addType(i),i}),SequenceExpression:O(function(t,r,e){for(var n=0,o=t.expressions.length-1;n<o;++n)S(t.expressions[n],r,e,I);return S(t.expressions[o],r,e)}),UnaryExpression:O(function(t,r,e){return S(t.argument,r,e,I),w(t.operator)}),UpdateExpression:O(function(t,r,e){return S(t.argument,r,e,I),ut.num}),BinaryExpression:O(function(t,r,e){if("+"==t.operator){var n=S(t.left,r,e),o=S(t.right,r,e);if(n.hasType(ut.str)||o.hasType(ut.str))return ut.str;if(n.hasType(ut.num)&&o.hasType(ut.num))return ut.num;var i=new U;return n.propagate(new tt(o,i)),o.propagate(new tt(n,i)),i}return S(t.left,r,e,I),S(t.right,r,e,I),x(t.operator)?ut.bool:ut.num}),AssignmentExpression:O(function(t,r,e){var n,o,i;if("MemberExpression"==t.left.type?(i=b(t.left,r,e),"Identifier"==t.left.object.type&&(o=t.left.object.name+"."+i)):o=T(t.left),"="!=t.operator&&"+="!=t.operator?(S(t.right,r,e,I),n=ut.num):n=S(t.right,r,e,null,o),"MemberExpression"==t.left.type){var s=S(t.left.object,r,e);if("prototype"==i&&g(r,20),"<i>"==i){var p=t.left.property.name,a=r.props[p],u=a&&a.iteratesOver;if(u){g(r,20);var f="MemberExpression"==t.right.type&&t.right.computed&&t.right.property.name==p;return u.forAllProps(function(t,r,e){e&&"prototype"!=t&&"<i>"!=t&&s.propagate(new z(t,f?r:I))}),n}}s.propagate(new z(i,n,t.left.property)),"FunctionExpression"==t.right.type&&s.propagate(t.right.body.scope.fnType.self,G)}else"Identifier"==t.left.type&&n.propagate(r.defVar(t.left.name,t.left));return n}),LogicalExpression:N(function(t,r,e,n){S(t.left,r,e,n),S(t.right,r,e,n)}),ConditionalExpression:N(function(t,r,e,n){S(t.test,r,e,I),S(t.consequent,r,e,n),S(t.alternate,r,e,n)}),NewExpression:N(function(t,r,e,n,o){"Identifier"==t.callee.type&&t.callee.name in r.props&&g(r,20);for(var i=0,s=[];i<t.arguments.length;++i)s.push(S(t.arguments[i],r,e));var p=S(t.callee,r,e),a=new U;p.propagate(new Q(a,o&&/\.prototype$/.test(o))),a.propagate(n,_),p.propagate(new J(a,s,t.arguments,new rt(n)))}),CallExpression:N(function(t,r,e,n){for(var o=0,i=[];o<t.arguments.length;++o)i.push(S(t.arguments[o],r,e));if("MemberExpression"==t.callee.type){var s=S(t.callee.object,r,e),p=b(t.callee,r,e);("call"==p||"apply"==p)&&r.fnType&&r.fnType.args.indexOf(s)>-1&&g(r,30),s.propagate(new K(p,i,t.arguments,n))}else{var a=S(t.callee,r,e);r.fnType&&r.fnType.args.indexOf(a)>-1&&g(r,30);var u=a.getFunctionType();u&&u.instantiateScore&&r.fnType&&g(r,u.instantiateScore/5),a.propagate(new J(ut.topScope,i,t.arguments,n))}}),MemberExpression:N(function(t,r,e,n){var o=b(t,r),i=S(t.object,r,e),s=i.getProp(o);if("<i>"==o){var p=S(t.property,r,e);if(!p.hasType(ut.num))return s.propagate(n,M)}s.propagate(n)}),Identifier:O(function(t,r){return"arguments"!=t.name||!r.fnType||t.name in r.props||r.defProp(t.name,r.fnType.originNode).addType(new at(r.fnType.arguments=new U)),r.getProp(t.name)}),ThisExpression:O(function(t,r){return r.fnType?r.fnType.self:ut.topScope}),Literal:O(function(t){return E(t)})},vt=n.make({Expression:function(t,r,e){S(t,r,e,I)},FunctionDeclaration:function(t,r,e){var n=t.body.scope,o=n.fnType;e(t.body,r,"ScopeBody"),d(t,n)||m(n);var i=r.getProp(t.id.name);i.addType(o)},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;++n){var o=t.declarations[n];if("Identifier"==o.id.type){var i=r.getProp(o.id.name);o.init&&S(o.init,r,e,i,o.id.name)}else o.init&&S(o.init,r,e,I)}},ReturnStatement:function(t,r,e){if(t.argument){var n=I;r.fnType&&(r.fnType.retval==I&&(r.fnType.retval=new U),n=r.fnType.retval),S(t.argument,r,e,n)}},ForInStatement:function(t,r,e){var n=S(t.right,r,e);if("Identifier"==t.right.type&&t.right.name in r.props||"MemberExpression"==t.right.type&&"prototype"==t.right.property.name){g(r,5);var o;"Identifier"==t.left.type?o=t.left.name:"VariableDeclaration"==t.left.type&&"Identifier"==t.left.declarations[0].id.type&&(o=t.left.declarations[0].id.name),o&&o in r.props&&(r.getProp(o).iteratesOver=n)}e(t.body,r,"Statement")},ScopeBody:function(t,r,e){e(t,t.scope||r)}}),mt=t.parse=function(t,n,o){var i;if(n&&n.preParse)for(var s=0;s<n.preParse.length;s++){var p=n.preParse[s](t,o);"string"==typeof p&&(t=p)}try{i=r.parse(t,o)}catch(r){i=e.parse_dammit(t,o)}return j(n,"postParse",i,t),i};t.analyze=function(r,e,o,i){"string"==typeof r&&(r=mt(r)),e||(e="file#"+ut.origins.length),t.addOrigin(ut.curOrigin=e),o||(o=ut.topScope),ut.startAnalysis(),n.recursive(r,o,null,yt),j(i,"preInfer",r,o),n.recursive(r,o,null,vt),j(i,"postInfer",r,o),ut.curOrigin=null},t.purge=function(t,r,e){var n=A(t,r,e);++ut.purgeGen,ut.topScope.purge(n);for(var o in ut.props){for(var i=ut.props[o],s=0;s<i.length;++s){var p=i[s],a=p.props[o];a&&!n(a,a.originNode)||i.splice(s--,1)}i.length||delete ut.props[o]}},U.prototype.purge=function(t){if(this.purgeGen!=ut.purgeGen){this.purgeGen=ut.purgeGen;for(var r=0;r<this.types.length;++r){var e=this.types[r];t(e,e.originNode)?this.types.splice(r--,1):e.purge(t)}if(this.types.length||(this.maxWeight=0),this.forward)for(var r=0;r<this.forward.length;++r){var n=this.forward[r];t(n)?(this.forward.splice(r--,1),this.props&&(this.props=null)):n.purge&&n.purge(t)}}},I.purge=function(){},st.prototype.purge=function(t){if(this.purgeGen==ut.purgeGen)return!0;this.purgeGen=ut.purgeGen;for(var r in this.props){var e=this.props[r];t(e,e.originNode)&&this.removeProp(r),e.purge(t)}},pt.prototype.purge=function(t){if(!st.prototype.purge.call(this,t)){this.self.purge(t),this.retval.purge(t);for(var r=0;r<this.args.length;++r)this.args[r].purge(t)}};var Pt={ArrayExpression:function(t,r){for(var e=new U,n=0;n<t.elements.length;++n){var o=t.elements[n];o&&C(o,r).propagate(e)}return new at(e)},ObjectExpression:function(t){return t.objType},FunctionExpression:function(t){return t.body.scope.fnType},SequenceExpression:function(t,r){return C(t.expressions[t.expressions.length-1],r)},UnaryExpression:function(t){return w(t.operator)},UpdateExpression:function(){return ut.num},BinaryExpression:function(t,r){if(x(t.operator))return ut.bool;if("+"==t.operator){var e=C(t.left,r),n=C(t.right,r);if(e.hasType(ut.str)||n.hasType(ut.str))return ut.str}return ut.num},AssignmentExpression:function(t,r){return C(t.right,r)},LogicalExpression:function(t,r){var e=C(t.left,r);return e.isEmpty()?C(t.right,r):e},ConditionalExpression:function(t,r){var e=C(t.consequent,r);return e.isEmpty()?C(t.alternate,r):e},NewExpression:function(t,r){var e=C(t.callee,r).getFunctionType(),n=e&&e.getProp("prototype").getObjType();return n?X(n,e):I},CallExpression:function(t,r){var e=C(t.callee,r).getFunctionType();if(!e)return I;if(e.computeRet){for(var n=0,o=[];n<t.arguments.length;++n)o.push(C(t.arguments[n],r));var i=I;return"MemberExpression"==t.callee.type&&(i=C(t.callee.object,r)),e.computeRet(i,o,t.arguments)}return e.retval},MemberExpression:function(t,r){var e=b(t,r),n=C(t.object,r).getType();return n?n.getProp(e):"<i>"==e?I:k(e)},Identifier:function(t,r){return r.hasProp(t.name)||I},ThisExpression:function(t,r){return r.fnType?r.fnType.self:ut.topScope},Literal:function(t){return E(t)}},Tt=t.searchVisitor=n.make({Function:function(t,r,e){var n=t.body.scope;t.id&&e(t.id,n);for(var o=0;o<t.params.length;++o)e(t.params[o],n);e(t.body,n,"ScopeBody")},TryStatement:function(t,r,e){t.handler&&e(t.handler.param,r),n.base.TryStatement(t,r,e)},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;++n){var o=t.declarations[n];e(o.id,r),o.init&&e(o.init,r,"Expression")}},Property:function(t,r,e){t.computed&&e(t.key,r,"Expression"),t.key!=t.value&&e(t.value,r,"Expression")}});t.fullVisitor=n.make({MemberExpression:function(t,r,e){e(t.object,r,"Expression"),e(t.property,r,t.computed?"Expression":null)},ObjectExpression:function(t,r,e){for(var n=0;n<t.properties.length;++n)e(t.properties[n].value,r,"Expression"),e(t.properties[n].key,r)}},Tt),t.findExpressionAt=function(t,r,e,o,i){var s=i||function(t,r){return("Identifier"!=r.type||"✖"!=r.name)&&Pt.hasOwnProperty(r.type)};return n.findNodeAt(t,r,e,s,Tt,o||ut.topScope)},t.findExpressionAround=function(t,r,e,o,i){var s=i||function(t,e){return!(null!=r&&e.start>r)&&(("Identifier"!=e.type||"✖"!=e.name)&&Pt.hasOwnProperty(e.type))};return n.findNodeAround(t,e,s,Tt,o||ut.topScope)},t.expressionType=function(t){return C(t.node,t.state)},t.parentNode=function(t,r){function e(r,i,s){if(r.start<=t.start&&r.end>=t.end){var p=o[o.length-1];if(r==t)throw{found:p};p!=r&&o.push(r),n.base[s||r.type](r,i,e),p!=r&&o.pop()}}var o=[];try{e(r,null)}catch(t){if(t.found)return t.found;throw t}};var bt={ArrayExpression:function(t,r,e){return e(t,!0).getProp("<i>")},ObjectExpression:function(t,r,e){for(var n=0;n<t.properties.length;++n){var o=r.properties[n];if(o.value==r)return e(t,!0).getProp(o.key.name)}},UnaryExpression:function(t){return w(t.operator)},UpdateExpression:function(){return ut.num},BinaryExpression:function(t){return x(t.operator)?ut.bool:ut.num},AssignmentExpression:function(t,r,e){return e(t.left)},LogicalExpression:function(t,r,e){return e(t,!0)},ConditionalExpression:function(t,r,e){if(t.consequent==r||t.alternate==r)return e(t,!0)},NewExpression:function(t,r,e){return this.CallExpression(t,r,e)},CallExpression:function(t,r,e){for(var n=0;n<t.arguments.length;n++){var o=t.arguments[n];if(o==r){var i=e(t.callee).getFunctionType();if(i instanceof pt)return i.args[n];break}}},ReturnStatement:function(t,r,e){var o=n.findNodeAround(r.sourceFile.ast,r.start,"Function");if(o){var i="FunctionExpression"==o.node.type?e(o.node,!0).getFunctionType():o.node.body.scope.fnType;if(i)return i.retval.getType()}},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;n++){var o=t.declarations[n];if(o.init==r)return e(o.id)}}};t.typeFromContext=function(r,e){var n=t.parentNode(e.node,r),o=null;if(bt.hasOwnProperty(n.type)){var i=bt[n.type];o=i&&i(n,e.node,function(n,o){var i={node:n,state:e.state},s=o?t.typeFromContext(r,i):t.expressionType(i);return s||I})}return o||t.expressionType(e)};var wt=!1;t.resetGuessing=function(t){wt=t},t.didGuess=function(){return wt},t.forAllPropertiesOf=function(t,r){t.gatherProperties(r,0)};var xt=n.make({},Tt);t.findRefs=function(t,r,e,o,i){xt.Identifier=function(t,r){if(t.name==e)for(var n=r;n;n=n.prev)if(n==o&&i(t,r),e in n.props)return},n.recursive(t,r,null,xt)};var Et=n.make({Function:function(t,r,e){e(t.body,t.body.scope,"ScopeBody")}});t.findPropRefs=function(t,r,e,o,i){n.simple(t,{MemberExpression:function(t,r){t.computed||t.property.name!=o||C(t.object,r).getType()==e&&i(t.property)},ObjectExpression:function(t,r){if(C(t,r).getType()==e)for(var n=0;n<t.properties.length;++n)t.properties[n].key.name==o&&i(t.properties[n].key)}},Et,r)};var Ot=t.scopeAt=function(t,r,e){var o=n.findNodeAround(t,r,function(t,r){return"ScopeBody"==t&&r.scope});return o?o.node.scope:e||ut.topScope};t.forAllLocalsAt=function(t,r,e,n){var o=Ot(t,r,e);o.gatherProperties(n,0)},o=t.def=o.init({},t)});
//# sourceMappingURL=infer.min.js.map