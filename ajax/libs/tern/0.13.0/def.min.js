!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,t,r){return e.call?e(t,r):e}function a(e,r){if("!ret"==r){if(e.retval)return e.retval;var n=new t.AVal;return e.propagate(new t.IsCallee(t.ANull,[],null,n)),n}return e.getProp(r)}function i(e,r,a){return function(i,o){for(var s=[],p=0;p<r.length;p++)s.push(n(r[p],i,o));return new t.Fn(e,t.ANull,s,n(a,i,o))}}function o(e){return function(r,a){for(var i=new t.AVal,o=0;o<e.length;o++)n(e[o],r,a).propagate(i);return i.maxWeight=1e5,i}}function s(e){return function(r,n){return new t.Arr(e(r,n))}}function p(e,r,n,a){var i=new d(e,null,n,a).parseType(!1,r,!0);if(/^fn\(/.test(e))for(var o=0;o<i.args.length;++o)(function(e){var r=i.args[e];r instanceof t.Fn&&r.args&&r.args.length&&l(i,function(n,a){var i=a[e];i&&i.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(o);return i}function l(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,i,o){var s=t(e,i,o),p=n?n(e,i,o):a;return r?s:p}}function u(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function f(e){if(!e["!type"]||/^(fn\(|\[)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function c(e,n,a){if(!e){var i=n["!type"];if(i)if(/^fn\(/.test(i))e=u(t.Fn);else{if("["!=i.charAt(0))throw new Error("Invalid !type spec: "+i);e=u(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:u(t.Obj);e.name=a}for(var o in n)if(r(n,o)&&33!=o.charCodeAt(0)){var s=n[o];if("string"==typeof s||f(s))continue;var p=e.defProp(o);c(p.getObjType(),s,a?a+"."+o:o).propagate(p)}return e}function h(e,n,a){if(e.isShell){delete e.isShell;var i=n["!type"];if(i)p(i,a,e);else{var o=n["!proto"]&&p(n["!proto"]);t.Obj.call(e,!(o instanceof t.Obj)||o,a)}}var s=n["!effects"];if(s&&e instanceof t.Fn)for(var l=0;l<s.length;++l)A(s[l],e);g(n,e);for(var u in n)if(r(n,u)&&33!=u.charCodeAt(0)){var c=n[u],v=e.defProp(u),y=a?a+"."+u:u;if("string"==typeof c)v.isEmpty()&&p(c,y).propagate(v);else{if(f(c)){if(!v.isEmpty())continue;p(c["!type"],y,null,!0).propagate(v)}else h(v.getObjType(),c,y);c["!doc"]&&(v.doc=c["!doc"]),c["!url"]&&(v.url=c["!url"]),c["!span"]&&(v.span=c["!span"])}}return e}function g(e,t){e["!doc"]&&(t.doc=e["!doc"]),e["!url"]&&(t.url=e["!url"]),e["!span"]&&(t.span=e["!span"]),e["!data"]&&(t.metaData=e["!data"])}function v(e,r){var n=t.cx().parent,a=n&&n.passes&&n.passes[e];if(a)for(var i=0;i<a.length;i++)a[i](r)}function y(e,r){var n=t.cx();t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.localDefs=n.definitions[n.curOrigin]=Object.create(null),v("preLoadDef",e),c(r,e);var a=e["!define"];if(a){for(var i in a){var o=a[i];n.localDefs[i]="string"==typeof o?b(o):c(null,o,i)}for(var i in a){var o=a[i];"string"!=typeof o&&h(n.localDefs[i],a[i],i)}}h(r,e),v("postLoadDef",e),n.curOrigin=n.localDefs=null}var d=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};d.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r,n){var a=[],o=[],s=!1;if(!this.eat(")"))for(var p=0;;++p){var l,u=this.spec.indexOf(": ",this.pos);u!=-1&&(l=this.spec.slice(this.pos,u),/^[$\w?]+$/.test(l)?this.pos=u+2:l=null),o.push(l);var f=this.parseType(e);if(f.call&&(s=!0),a.push(f),!this.eat(", ")){this.eat(")")||this.error();break}}var c,h,g,v;if(this.eat(" -> ")){var y=this.pos;c=this.parseType(!0),c.call&&!s&&(h=c,c=t.ANull,g=y)}else c=t.ANull;return s?i(r,a,c):(n&&(v=this.base)?t.Fn.call(this.base,r,t.ANull,a,o,c):v=new t.Fn(r,t.ANull,a,o,c),h&&(v.computeRet=h),null!=g&&(v.computeRetSource=this.spec.slice(g,this.pos)),v)},parseType:function(e,r,n){var a=this.parseTypeMaybeProp(e,r,n);if(!this.eat("|"))return a;for(var i=[a],s=a.call;;){var p=this.parseTypeMaybeProp(e,r,n);if(i.push(p),p.call&&(s=!0),!this.eat("|"))break}if(s)return o(i);for(var l=new t.AVal,u=0;u<i.length;u++)i[u].propagate(l);return l.maxWeight=1e5,l},parseTypeMaybeProp:function(e,t,r){for(var n=this.parseTypeInner(e,t,r);e&&this.eat(".");)n=this.extendWithProp(n);return n},extendWithProp:function(e){var t=this.word(/[\w<>$!]/)||this.error();return e.apply?function(r,n){return a(e(r,n),t)}:a(e,t)},parseTypeInner:function(e,r,n){if(this.eat("fn("))return this.parseFnType(e,r,n);if(this.eat("[")){var a=this.parseType(e);return this.eat("]")||this.error(),a.call?s(a):n&&this.base?(t.Arr.call(this.base,a),this.base):new t.Arr(a)}if(this.eat("+")){var i=this.word(/[\w$<>\.!]/),o=b(i+".prototype");return o instanceof t.Obj||(o=b(i)),o instanceof t.Obj?e&&this.eat("[")?this.parsePoly(o):n&&this.forceNew?new t.Obj(o):t.getInstance(o):o}if(e&&this.eat("!")){var p=this.word(/\d/);if(p)return p=Number(p),function(e,r){return r[p]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var l=this.word(/[\w$]/);return O[l]||function(){return t.ANull}}return this.fromWord("!"+this.word(/[\w$<>\.!]/))}return this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!`]/))},fromWord:function(e){var r=t.cx();switch(e){case"number":return r.num;case"string":return r.str;case"bool":return r.bool;case"<top>":return r.topScope}return r.localDefs&&e in r.localDefs?r.localDefs[e]:b(e)},parsePoly:function(e){var r,n="<i>";(r=this.spec.slice(this.pos).match(/^\s*(\w+)\s*=\s*/))&&(n=r[1],this.pos+=r[0].length);var a=this.parseType(!0);if(this.eat("]")||this.error(),a.call)return function(r,i){var o=new t.Obj(e);return a(r,i).propagate(o.defProp(n)),o};var i=new t.Obj(e);return a.propagate(i.defProp(n)),i}};var w,A=e.parseEffect=function(e,r){var a;if(0==e.indexOf("propagate ")){var i=new d(e,10),o=i.parseType(!0);i.eat(" ")||i.error();var s=i.parseType(!0);l(r,function(e,t){n(o,e,t).propagate(n(s,e,t))})}else if(0==e.indexOf("call ")){var p=5==e.indexOf("and return ",5),i=new d(e,p?16:5),u=i.parseType(!0),f=null,c=[];for(i.eat(" this=")&&(f=i.parseType(!0));i.eat(" ");)c.push(i.parseType(!0));l(r,function(e,r){for(var a=n(u,e,r),i=f?n(f,e,r):t.ANull,o=[],s=0;s<c.length;++s)o.push(n(c[s],e,r));var l=p?new t.AVal:t.ANull;return a.propagate(new t.IsCallee(i,o,null,l)),l},p)}else if(a=e.match(/^custom (\S+)\s*(.*)/)){var h=O[a[1]];h&&l(r,a[2]?h(a[2]):h)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var i=new d(e,5),g=i.parseType(!0);i.eat(" ");var v=i.parseType(!0);l(r,function(e,r){var a=n(g,e,r),i=n(v,e,r);a.forAllProps(function(e,r,n){n&&"<i>"!=e&&i.propagate(new t.PropHasSubset(e,r))})})}},b=e.parsePath=function(e,r){var n=t.cx(),a=n.paths[e],i=e;if(null!=a)return a;n.paths[e]=t.ANull;var o=r||w||n.topScope;if(n.localDefs)for(var s in n.localDefs)if(0==e.indexOf(s)){if(e==s)return n.paths[e]=n.localDefs[e];if("."==e.charAt(s.length)){o=n.localDefs[s],e=e.slice(s.length+1);break}}for(var p=e.split("."),l=0;l<p.length&&o!=t.ANull;++l){var u=p[l];if("!"==u.charAt(0))if("!proto"==u)o=o instanceof t.Obj&&o.proto||t.ANull;else{var f=o.getFunctionType();if(f)if("!ret"==u)o=f.retval&&f.retval.getType(!1)||t.ANull;else{var c=f.args&&f.args[Number(u.slice(1))];o=c&&c.getType(!1)||t.ANull}else o=t.ANull}else if(o instanceof t.Obj){var h="prototype"==u&&o instanceof t.Fn?o.getProp(u):o.props[u];o=!h||h.isEmpty()?t.ANull:h.types[0]}}return n.paths[i]=o==t.ANull?null:o,o};e.load=function(e,r){r||(r=t.cx().topScope);var n=w;w=r;try{y(e,r)}finally{w=n}},e.parse=function(e,r,n){var a=t.cx();r&&(a.origin=r,a.localDefs=a.definitions[r]);try{return"string"==typeof e?p(e,n):h(c(null,e,n),e,n)}finally{r&&(a.origin=a.localDefs=null)}};var O=Object.create(null);t.registerFunction=function(e,t){O[e]=t};var P=t.constraint({construct:function(e,t,r){this.created=e,this.target=t,this.spec=r},addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getObjType(!1)),n instanceof t.Obj)for(var a in n.props){var i=n.props[a].types[0],o=r.defProp(a);if(i&&i instanceof t.Obj&&i.props.value){var s=i.props.value.getType(!1);s&&o.addType(s)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new P(0,a,r[1])),a});var m=t.constraint({construct:function(e){this.target=e},addType:function(e){e instanceof t.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new t.IsCallee(t.ANull,[],null,this.target)))}});t.registerFunction("Object_defineProperty",function(e,r,n){if(n&&n.length>=3&&"Literal"==n[1].type&&"string"==typeof n[1].value){var a=r[0],i=new t.AVal;a.propagate(new t.PropHasSubset(n[1].value,i,n[1])),r[2].propagate(new m(i))}return t.ANull}),t.registerFunction("Object_defineProperties",function(e,r,n){if(r.length>=2){var a=r[0];r[1].forAllProps(function(e,r,i){if(i){var o=new t.AVal;a.propagate(new t.PropHasSubset(e,o,n&&n[1])),r.propagate(new m(o))}})}return t.ANull});var T=t.constraint({construct:function(e,t,r){this.self=e,this.args=t,this.target=r},addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,t.ANull,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new T(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),i=0;i<r.length;++i)r[i].propagate(a);return n}),t.registerFunction("Promise_ctor",function(e,r,n){if(r.length<1)return t.ANull;var a=new t.Obj(t.cx().definitions.ecma6["Promise.prototype"]),i=a.defProp("value",n&&n[0]),o=new t.AVal;o.propagate(i);var s=new t.Fn("execute",t.ANull,[o],["value"],t.ANull),p=t.cx().definitions.ecma6.promiseReject;return r[0].propagate(new t.IsCallee(t.ANull,[s,p],null,t.ANull)),a});var N=t.constraint({construct:function(e){this.output=e},addType:function(e){e.constructor==t.Obj&&"Promise"==e.name&&e.hasProp("value")?e.getProp("value").propagate(this.output):e.propagate(this.output)}}),j=50;return t.registerFunction("Promise_then",function(e,r,n){var a=r.length&&r[0].getFunctionType();if(!a)return e;var i=new t.Obj(t.cx().definitions.ecma6["Promise.prototype"]),o=i.defProp("value",n&&n[0]);return a.retval.isEmpty()&&e.hasProp("value")&&e.getProp("value").propagate(o,j),a.retval.propagate(new N(o)),i}),e});
//# sourceMappingURL=def.min.js.map