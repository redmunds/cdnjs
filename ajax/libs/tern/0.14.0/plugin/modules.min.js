!function(e){return"object"==typeof exports&&"object"==typeof module?e(require("../lib/infer"),require("../lib/tern"),require("../lib/signal"),require):"function"==typeof define&&define.amd?define(["../lib/infer","../lib/tern","../lib/signal"],e):void e(tern,tern,tern.signal)}(function(e,t,n,o){"use strict";function i(e,t){this.server=e,this.options=t||{},this.modules=Object.create(null),this.nonRelative=Object.create(null),this.resolvers=[],this.modNameTests=[],this.importTests=[],this.completables=[]}function r(e,t){if(/^https?:|^\//.test(t))return t;e&&!/\/$/.test(e)&&(e+="/");for(var n;n=/^\.(\.)?\//.exec(t);){if(n[1]&&e.length>1){var o=e.lastIndexOf("/",e.length-2);e=o==-1?"":e.slice(0,o+1)}t=t.slice(n[0].length)}return e+t}function s(e){var t=e.lastIndexOf("/");return t==-1?"":e.slice(0,t+1)}function a(e){var t=e.lastIndexOf("/");return t==-1?e:e.slice(t+1)}function l(t,n){if(/^\.\.?\//.test(t)){var o=r(s(n),t),i=e.cx().parent;return i.findFile(o)?o:i.findFile(o+".js")?o+".js":void 0}}function u(e){return/^\.\.?\//.test(e)}function d(e,t,n){return n.filter===!1||!e||0==(n.caseInsensitive?t.toLowerCase():t).indexOf(e)}function p(t){var n=e.cx().parent.mod.modules.modules,o=t.roots["!modules"]=new e.Obj(null);for(var i in n){var r=n[i],s=r.origin||i,a=o.defProp(s.replace(/\./g,"`"));r.propagate(a),a.origin=r.origin}}function c(t){var n=e.cx(),o=n.definitions[t["!name"]]["!modules"],i=n.parent.mod.modules;if(o)for(var r in o.props){var s=r.replace(/`/g,"."),a=i.get(s);a.origin=s,o.props[r].propagate(a)}}function f(t,n,o,i){if(!o)return i;var r,s,a=e.cx().parent.mod.modules,l=a.isModName(o.node);if((r=a.isImport(o.node))&&(l=r.name,s=r.prop),!l)return i;var u=a.resolveModule(l,o.node.sourceFile.name);return(u=(s?u.getProp(s):u).getType())?(i=Object.create(i),i.origin=u.origin,i.originNode=u.originNode,u.doc&&(i.doc=u.doc),u.url&&(i.url=u.url),i):i}function m(n,o){var i=t.resolvePos(n,o.end),r=e.cx().parent.mod.modules,s=e.findExpressionAround(n.ast,null,i,n.scope,"Literal"),a=s&&r.isModName(s.node);if(null!=a){var l=s.node;if(!("Literal"!=l.type||"string"!=typeof l.value||l.start>i||l.end<i)){var d=l.raw.slice(1,i-l.start),p=l.raw.charAt(0);d&&d.charAt(d.length-1)==p&&(d=d.slice(0,d.length-1)),o.caseInsensitive&&(d=d.toLowerCase());var c=[];return u(d)?r.completeFileName(c,o,n.name,d):r.completeModuleName(c,o,d),l.end==i+1&&n.text.charAt(i)==p&&++i,{start:t.outputPos(o,n,l.start),end:t.outputPos(o,n,i),isProperty:!1,completions:c.map(function(e){var t="string"==typeof e?e:e.name,n=JSON.stringify(t);return"'"==p&&(n=p+n.slice(1,n.length-1).replace(/'/g,"\\'")+p),"string"==typeof e?n:(e.displayName=t,e.name=n,e)})}}}}i.prototype=n.mixin({buildWrappingScope:function(t,n,o){var i=new e.Scope(t,o);return i.origin=n,this.signal("wrapScope",i),i},maybeOverride:function(t){if(!this.options.modules||!this.options.modules.hasOwnProperty(t))return!1;if(this.modules[t])return this.modules[t];var n=this.options.modules[t];if("string"==typeof n&&"="==n.charAt(0))return e.def.parsePath(n.slice(1));var o=this.buildWrappingScope(e.cx().topScope,t);return e.def.load(n,o),this.modules[t]=o.exports},resolveModule:function(t,n){var o=this.maybeOverride(t);if(o)return o;if(1==this.options.dontLoad||this.options.dontLoad&&new RegExp(this.options.dontLoad).test(t)||this.options.load&&!new RegExp(this.options.load).test(t))return e.ANull;for(var i,r=u(t),s=0;!i&&s<this.resolvers.length;s++)i=this.resolvers[s](t,n);if(i||(i=l(t,n)),!i)return e.ANull;if("string"!=typeof i)return r||(this.nonRelative[t]=!0),i;var a=this.modules[i];return a?a:(/\.js$|(?:^\/)[^\.]+$/.test(i)&&this.server.addFile(i,null,n),r||(this.nonRelative[t]=i),this.modules[i]=new e.AVal)},findIn:function(e,t){for(var n=0;n<e.length;n++){var o=e[n](t);if(null!=o)return o}},isModName:function(e){return this.findIn(this.modNameTests,e)},isImport:function(e){return this.findIn(this.importTests,e)},get:function(t){return this.modules[t]||(this.modules[t]=new e.AVal)},completeModuleName:function(e,n,o){function i(i,r){for(var s in i)d(o,s,n)&&t.addCompletion(n,e,s,r&&i[s])}for(var r=0;r<this.completables.length;r++)i(this.completables[r](this.server),!0);this.options.modules&&i(this.options.modules,!1);var s=Object.create(null);for(var a in this.nonRelative){var l=this.nonRelative[a];if(1==l||a.indexOf("/")==-1)d(o,a,n)&&t.addCompletion(n,e,a);else if(0==a.indexOf(o)&&o.indexOf("/")>-1){var u=/.*?\/(.*)/.exec(a)[1],p=l.indexOf(u);if(p>-1){var c=l.slice(0,p)+(/.*?\/(.*\/)?/.exec(o)[1]||"");if(c in s)continue;s[c]=!0,this.completeFileName(e,n,null,o,c)}}}},completeFileName:function(e,n,o,i,l){var u=o?r(s(o),i):a(i);for(var p in this.modules)if(d(u,p,n)){/\.js$/.test(p)&&(p=p.slice(0,p.length-3));var c=p.slice(u.length);t.addCompletion(n,e,i+c,this.modules[p])}}}),o&&function(){var e=o("fs"),n=o("path");i.prototype.completeFileName=function(o,i,r,s,a){var l=this.server.projectDir,u=/\/$/.test(s);if(r){var p=n.resolve(l,n.dirname(r),s);a=u?p:n.dirname(p)}var c=u?s:n.dirname(s)+"/",f=u?"":n.basename(s),m=this;e.readdirSync(a).forEach(function(e){if(!/^\./.test(e)&&d(f,e,i)){var r=m.modules[n.relative(l,n.resolve(a,e))];/\.js$/.test(e)&&(e=e.slice(0,e.length-3)),t.addCompletion(i,o,c+e,r)}})}}(),t.registerPlugin("modules",function(e,t){e.mod.modules=new i(e,t),e.on("beforeLoad",function(e){e.scope=this.mod.modules.buildWrappingScope(e.scope,e.name,e.ast)}),e.on("afterLoad",function(e){var t=this.mod.modules.get(e.name);t.origin=e.name,this.mod.modules.signal("getExports",e,t)}),e.on("reset",function(){this.mod.modules.modules=Object.create(null)}),e.on("preCondenseReach",p),e.on("postLoadDef",c),e.on("typeAt",f),e.on("completion",m)}),t.defineQueryType("exports",{takesFile:!0,run:function(n,o,i){function r(i){var r={},s=i.getType(!1);r.type=e.toString(s,3);var a=i.doc||s&&s.doc,l=i.url||s&&s.url;a&&(r.doc=a),l&&(r.url=l);var u=t.getSpan(i)||s&&t.getSpan(s);return u&&t.storeSpan(n,o,u,r),r}var s=n.mod.modules,a=s&&s.modules[i.name];if(!a)return{};var l=r(a),u=a.getType(!1);if(u instanceof e.Obj){var d=l.props={};for(var p in u.props)d[p]=r(u.props[p])}return l}})});
//# sourceMappingURL=modules.min.js.map