!function(e,n){return"object"==typeof exports&&"object"==typeof module?n(exports,require("./infer"),require("./signal"),require("acorn/acorn"),require("acorn/util/walk")):"function"==typeof define&&define.amd?define(["exports","./infer","./signal","acorn/acorn","acorn/util/walk"],n):void n(e.tern||(e.tern={}),tern,tern.signal,acorn,acorn.walk)}(this,function(e,n,t,r,i){"use strict";function s(e,n){this.name=e,this.parent=n,this.scope=this.text=this.ast=this.lineOffsets=null}function o(e,t,r){e.text=t,e.ast=n.parse(t,r.passes,{directSourceFile:e,allowReturnOutsideFunction:!0}),e.lineOffsets=null}function a(e,t,r){if(t.query&&!Q.hasOwnProperty(t.query.type))return r("No query type '"+t.query.type+"' defined");var i=t.query;i||r(null,{});var s=t.files||[];s.length&&++e.uses;for(var o=0;o<s.length;++o){var a=s[o];u(e,a.name,null,"full"==a.type?a.text:null)}var f="number"==typeof t.timeout?[t.timeout]:null;if(!i)return void c(e,f,function(){});var l=Q[i.type];if(l.takesFile){if("string"!=typeof i.file)return r(".query.file must be a string");/^#/.test(i.file)||u(e,i.file,null)}c(e,f,function(t){function o(){var n;try{n=l.run(e,i,a)}catch(n){return e.options.debug&&"TernError"!=n.name&&console.error(n.stack),r(n)}r(null,n)}if(t)return r(t);var a=l.takesFile&&y(e,s,i.file);return l.fullFile&&"part"==a.type?r("Can't run a "+i.type+" query on a file fragment"):void n.withContext(e.cx,f?function(){n.withTimeout(f[0],o)}:o)})}function f(e,t){return n.withContext(e.cx,function(){t.scope=e.cx.topScope,e.signal("beforeLoad",t),n.markVariablesDefinedBy(t.scope,t.name),n.analyze(t.ast,t.name,t.scope,e.passes),n.purgeMarkedVariables(t.scope),e.signal("afterLoad",t)}),t}function u(e,n,t,r){var i=e.findFile(n);if(i)return null!=r&&l(e,i,r),void(b(e,i.parent)>b(e,t)&&(i.parent=t,i.excluded&&(i.excluded=null)));var a=new s(n,t);e.files.push(a),e.fileMap[n]=a,null!=r?o(a,r,e):e.options.async?(e.startAsyncAction(),e.options.getFile(n,function(n,t){o(a,t||"",e),e.finishAsyncAction(n)})):o(a,e.options.getFile(n)||"",e)}function l(e,t,r,i){t.scope&&(n.withContext(e.cx,function(){n.purgeTypes(t.name),i&&(n.markVariablesDefinedBy(t.scope,t.name),n.purgeMarkedVariables(t.scope))}),t.scope=null),null!=r&&o(t,r,e)}function p(e,n,t){var r=function(){e.off("everythingFetched",r),clearTimeout(i),c(e,n,t)};e.on("everythingFetched",r);var i=setTimeout(r,e.options.fetchTimeout)}function c(e,t,r){if(e.pending)return p(e,t,r);var i=e.fetchError;if(i)return e.fetchError=null,r(i);for(var s=!0,o=0;o<e.files.length;){for(var a=[];o<e.files.length;++o){var u=e.files[o];null==u.text?s=!1:null!=u.scope||u.excluded||a.push(u)}a.sort(function(n,t){return b(e,n.parent)-b(e,t.parent)});for(var l=0;l<a.length;l++){var u=a[l];if(u.parent&&!w(e,u))u.excluded=!0;else if(t){var c=+new Date;n.withTimeout(t[0],function(){f(e,u)}),t[0]-=+new Date-c}else f(e,u)}}s?r():p(e,t,r)}function d(e){var n=e.indexOf("\n");return n<0?e:e.slice(0,n)}function h(e,n,t){var r=Math.max(0,t-500),i=null;if(!/^\s*$/.test(e))for(;;){var s=n.indexOf(e,r);if(s<0||s>t+500)break;(null==i||Math.abs(i-t)>Math.abs(s-t))&&(i=s),r=s+e.length}return i}function g(e){for(var n=0;e;++n,e=e.prev);return n}function v(e){var n=new Error(e);return n.name="TernError",n}function y(e,t,r){var s=r.match(/^#(\d+)$/);if(!s)return e.findFile(r);var o=t[s[1]];if(!o)throw v("Reference to unknown file "+r);if("full"==o.type)return e.findFile(o.name);var a=o.backing=e.findFile(o.name),f=o.offset;o.offsetLines&&(f={line:o.offsetLines,ch:0}),o.offset=f=T(a,null==o.offsetLines?o.offset:{line:o.offsetLines,ch:0},!0);var u=d(o.text),l=h(u,a.text,f),p=null==l?Math.max(0,a.text.lastIndexOf("\n",f)):l;return n.withContext(e.cx,function(){n.purgeTypes(o.name,p,p+o.text.length);var t,r=o.text;if(t=r.match(/(?:"([^"]*)"|([\w$]+))\s*:\s*function\b/)){var s=i.findNodeAround(o.backing.ast,p,"ObjectExpression");if(s&&s.node.objType)var f={type:s.node.objType,prop:t[2]||t[1]}}if(l&&(t=u.match(/^(.*?)\bfunction\b/))){for(var c=t[1].length,d="",h=0;h<c;++h)d+=" ";r=d+r.slice(c);var v=!0}var y=n.scopeAt(a.ast,p,a.scope),m=n.scopeAt(a.ast,p+r.length,a.scope),b=o.scope=g(y)<g(m)?m:y;n.markVariablesDefinedBy(y,o.name,p,p+o.text.length),o.ast=n.parse(o.text,e.passes,{directSourceFile:o,allowReturnOutsideFunction:!0}),n.analyze(o.ast,o.name,b,e.passes),n.purgeMarkedVariables(y);e:if(f||v){var x=n.scopeAt(o.ast,u.length,y);if(!x.fnType)break e;if(f){var w=f.type.getProp(f.prop);w.addType(x.fnType)}else if(v){var F=n.scopeAt(a.ast,p+u.length,a.scope);if(F==y||!F.fnType)break e;var O=F.fnType,k=x.fnType;if(!k||k.name!=O.name&&O.name)break e;for(var h=0,T=Math.min(O.args.length,k.args.length);h<T;++h)O.args[h].propagate(k.args[h]);O.self.propagate(k.self),k.retval.propagate(O.retval)}}}),o}function m(e){var n=0;return i.simple(e,{Expression:function(){++n}}),n}function b(e,n){for(var t=0;n;)n=e.findFile(n).parent,++t;return t}function x(e,n){for(;;){var t=e.findFile(n.parent);if(!t.parent)break;n=t}return n.name}function w(e,n){var t=x(e,n),r=m(n.ast),i=e.budgets[t];return null==i&&(i=e.budgets[t]=e.options.dependencyBudget),!(i<r)&&(e.budgets[t]=i-r,!0)}function F(e){return"number"==typeof e||"object"==typeof e&&"number"==typeof e.line&&"number"==typeof e.ch}function O(e){if(e.query){if("string"!=typeof e.query.type)return".query.type must be a string";if(e.query.start&&!F(e.query.start))return".query.start must be a position";if(e.query.end&&!F(e.query.end))return".query.end must be a position"}if(e.files){if(!Array.isArray(e.files))return"Files property must be an array";for(var n=0;n<e.files.length;++n){var t=e.files[n];if("object"!=typeof t)return".files[n] must be objects";if("string"!=typeof t.text)return".files[n].text must be a string";if("string"!=typeof t.name)return".files[n].name must be a string";if("part"==t.type){if(!F(t.offset)&&"number"!=typeof t.offsetLines)return".files[n].offset must be a position"}else if("full"!=t.type)return'.files[n].type must be "full" or "part"'}}}function k(e,n){for(var t=e.text,r=e.lineOffsets||(e.lineOffsets=[0]),i=0,s=0,o=Math.min(Math.floor(n/W),r.length-1),i=r[o],s=o*W;s<n;){if(++s,i=t.indexOf("\n",i)+1,0==i)return null;s%W==0&&r.push(i)}return i}function T(e,n,t){if("number"!=typeof n){var r=k(e,n.line);if(null==r){if(!t)throw v("File doesn't contain a line "+n.line);n=e.text.length}else n=r+n.ch}if(n>e.text.length){if(!t)throw v("Position "+n+" is outside of file.");n=e.text.length}return n}function A(e,n){if(!e)return{line:0,ch:0};for(var t,r,i=e.lineOffsets||(e.lineOffsets=[0]),s=e.text,o=i.length-1;o>=0;--o)i[o]<=n&&(t=o*W,r=i[o]);for(;;){var a=s.indexOf("\n",r);if(a>=n||a<0)break;r=a+1,++t}return{line:t,ch:n-r}}function q(e,n,t){if(e.lineCharPositions){var r=A(n,t);return"part"==n.type&&(r.line+=null!=n.offsetLines?n.offsetLines:A(n.backing,n.offset).line),r}return t+("part"==n.type?n.offset:0)}function j(e){for(var n in e)null==e[n]&&delete e[n];return e}function C(e,n,t){null!=t&&(e[n]=t)}function N(e,n){"string"!=typeof e&&(e=e.name,n=n.name);var t=/^[A-Z]/.test(e),r=/^[A-Z]/.test(n);return t==r?e<n?-1:e==n?0:1:t?1:-1}function E(e,n,t){return"Literal"==e.type&&"string"==typeof e.value&&e.start==n-1&&e.end<=t+1}function M(e,t,i){function s(r,i,s,o){if((t.omitObjectPrototype===!1||i!=e.cx.protos.Object||u)&&(t.filter===!1||!u||0==(t.caseInsensitive?r.toLowerCase():r).indexOf(u))){for(var a=0;a<l.length;++a){var f=l[a];if((c?f.name:f)==r)return}var p=c?{name:r}:r;if(l.push(p),i&&(t.types||t.docs||t.urls||t.origins)){var d=i.props[r];n.resetGuessing();var h=d.getType();p.guess=n.didGuess(),t.types&&(p.type=n.toString(h)),t.docs&&C(p,"doc",d.doc||h&&h.doc),t.urls&&C(p,"url",d.url||h&&h.url),t.origins&&C(p,"origin",d.origin||h&&h.origin)}t.depths&&(p.depth=s),c&&o&&o(p)}}if(null==t.end)throw v("missing .query.end field");for(var o=T(i,t.end),a=o,f=i.text;o&&r.isIdentifierChar(f.charCodeAt(o-1));)--o;if(t.expandWordForward!==!1)for(;a<f.length&&r.isIdentifierChar(f.charCodeAt(a));)++a;var u=f.slice(o,a),l=[];t.caseInsensitive&&(u=u.toLowerCase());var p,c=t.types||t.depths||t.docs||t.urls||t.origins,d=n.findExpressionAround(i.ast,null,o,i.scope,"MemberExpression");if(d&&(d.node.computed?E(d.node.property,o,a):d.node.object.end<o)){var h=d.node.property;h="Literal"==h.type?h.value.slice(1):h.name,e.cx.completingProperty=h,d.node=d.node.object;var g=n.expressionType(d);if(g&&n.forAllPropertiesOf(g,s),!l.length&&t.guess!==!1&&g&&g.guessProperties&&g.guessProperties(function(e,n,t){e!=h&&"âœ–"!=e&&s(e,n,t)}),!l.length&&u.length>=2&&t.guess!==!1)for(var h in e.cx.props)s(h,e.cx.props[h][0],0);p="memberCompletion"}else n.forAllLocalsAt(i.ast,o,i.scope,s),t.includeKeywords&&H.forEach(function(e){s(e,null,0,function(e){e.isKeyword=!0})}),p="completion";return e.passes[p]&&e.passes[p].forEach(function(e){e(i,o,a,s)}),t.sort!==!1&&l.sort(N),e.cx.completingProperty=null,{start:q(t,i,o),end:q(t,i,a),isProperty:"memberCompletion"==p,completions:l}}function P(e,n){var t=n.prefix,r=[];for(var i in e.cx.props)"<i>"==i||t&&0!=i.indexOf(t)||r.push(i);return n.sort!==!1&&r.sort(N),{completions:r}}function L(e,t,r){var i=J(r,t);n.resetGuessing();var s=n.expressionType(i);if(s=t.preferFunction?s.getFunctionType()||s.getType():s.getType(),"Identifier"==i.node.type)var o=i.node.name;else if("MemberExpression"==i.node.type&&!i.node.computed)var o=i.node.property.name;if(null!=t.depth&&"number"!=typeof t.depth)throw v(".query.depth must be a number");var a={guess:n.didGuess(),type:n.toString(s,t.depth),name:s&&s.name,exprName:o};return s&&R(s,a),j(a)}function I(e,t,r){var i=J(r,t),s=n.expressionType(i),o={url:s.url,doc:s.doc},a=s.getType();return a&&R(a,o),j(o)}function R(e,t){t.url||(t.url=e.url),t.doc||(t.doc=e.doc),t.origin||(t.origin=e.origin);var r,i=n.cx().protos;!t.url&&!t.doc&&e.proto&&(r=e.proto.hasCtor)&&e.proto!=i.Object&&e.proto!=i.Function&&e.proto!=i.Array&&(t.url=r.url,t.doc=r.doc)}function S(e,t,r){var i=J(r,t);n.resetGuessing();var s=n.expressionType(i);if(n.didGuess())return{};var o=U(s),a={url:s.url,doc:s.doc,origin:s.origin};if(s.types)for(var f=s.types.length-1;f>=0;--f){var u=s.types[f];R(u,a),o||(o=U(u))}if(o&&o.node){var l=o.node.sourceFile||e.findFile(o.origin),p=q(t,l,o.node.start),c=q(t,l,o.node.end);a.start=p,a.end=c,a.file=o.origin;var d=Math.max(0,o.node.start-50);a.contextOffset=o.node.start-d,a.context=l.text.slice(d,d+50)}else o&&(a.file=o.origin,X(e,t,o,a));return j(a)}function G(e,t,r,i,s){function o(e){return function(n,r){if(s)for(var i=r;i!=f;i=i.prev){var o=i.hasProp(s);if(o)throw v("Renaming `"+a+"` to `"+s+"` would make a variable at line "+(A(e,n.start).line+1)+" point to the definition at line "+(A(e,o.name.start).line+1))}l.push({file:e.name,start:q(t,e,n.start),end:q(t,e,n.end)})}}for(var a=i.node.name,f=i.state;f&&!(a in f.props);f=f.prev);if(!f)throw v("Could not find a definition for "+a+" "+!!e.cx.topScope.props.x);var u,l=[];if(f.originNode){if(u="local",s){for(var p=f.prev;p&&!(s in p.props);p=p.prev);p&&n.findRefs(f.originNode,f,s,p,function(e){throw v("Renaming `"+a+"` to `"+s+"` would shadow the definition used at line "+(A(r,e.start).line+1))})}n.findRefs(f.originNode,f,a,f,o(r))}else{u="global";for(var c=0;c<e.files.length;++c){var d=e.files[c];n.findRefs(d.ast,d.scope,a,f,o(d))}}return{refs:l,type:u,name:a}}function V(e,t,r,i){function s(e){return function(n){a.push({file:e.name,start:q(t,e,n.start),end:q(t,e,n.end)})}}var o=n.expressionType(r).getType();if(!o)throw v("Couldn't determine type of base object.");for(var a=[],f=0;f<e.files.length;++f){var u=e.files[f];n.findPropRefs(u.ast,u.scope,o,i.name,s(u))}return{refs:a,name:i.name}}function B(e,n,t){var r=J(t,n,!0);if(r&&"Identifier"==r.node.type)return G(e,n,t,r);if(r&&"MemberExpression"==r.node.type&&!r.node.computed){var i=r.node.property;return r.node=r.node.object,V(e,n,r,i)}if(r&&"ObjectExpression"==r.node.type)for(var s=T(t,n.end),o=0;o<r.node.properties.length;++o){var a=r.node.properties[o].key;if(a.start<=s&&a.end>=s)return V(e,n,r,a)}throw v("Not at a variable or property name.")}function D(e,n,t){if("string"!=typeof n.newName)throw v(".query.newName should be a string");var r=J(t,n);if(!r||"Identifier"!=r.node.type)throw v("Not at a variable.");var i=G(e,n,t,r,n.newName),s=i.refs;delete i.refs,i.files=e.files.map(function(e){return e.name});for(var o=i.changes=[],a=0;a<s.length;++a){var f=s[a];f.text=n.newName,o.push(f)}return i}function $(e){return{files:e.files.map(function(e){return e.name})}}var z=Object.create(null);e.registerPlugin=function(e,n){z[e]=n};var K=e.defaultOptions={debug:!1,async:!1,getFile:function(e,n){this.async&&n(null,null)},defs:[],plugins:{},fetchTimeout:1e3,dependencyBudget:2e4},Q={completions:{takesFile:!0,run:M},properties:{run:P},type:{takesFile:!0,run:L},documentation:{takesFile:!0,run:I},definition:{takesFile:!0,run:S},refs:{takesFile:!0,fullFile:!0,run:B},rename:{takesFile:!0,fullFile:!0,run:D},files:{run:$}};e.defineQueryType=function(e,n){Q[e]=n},s.prototype.asLineChar=function(e){return A(this,e)};var Z=e.Server=function(e){this.cx=null,this.options=e||{};for(var n in K)e.hasOwnProperty(n)||(e[n]=K[n]);this.handlers=Object.create(null),this.files=[],this.fileMap=Object.create(null),this.budgets=Object.create(null),this.uses=0,this.pending=0,this.asyncError=null,this.passes=Object.create(null),this.defs=e.defs.slice(0);for(var t in e.plugins)if(e.plugins.hasOwnProperty(t)&&t in z){var r=z[t](this,e.plugins[t]);if(r&&r.defs&&(r.loadFirst?this.defs.unshift(r.defs):this.defs.push(r.defs)),r&&r.passes)for(var i in r.passes)r.passes.hasOwnProperty(i)&&(this.passes[i]||(this.passes[i]=[])).push(r.passes[i])}this.reset()};Z.prototype=t.mixin({addFile:function(e,n,t){t&&!t in this.fileMap&&(t=null),u(this,e,t,n)},delFile:function(e){for(var n,t=0;t<this.files.length;++t)if((n=this.files[t]).name==e)return l(this,n,null,!0),this.files.splice(t--,1),void delete this.fileMap[e]},reset:function(){this.signal("reset"),this.cx=new n.Context(this.defs,this),this.uses=0,this.budgets=Object.create(null);for(var e=0;e<this.files.length;++e){var t=this.files[e];t.scope=null}},request:function(e,n){var t=O(e);if(t)return n(t);var r=this;a(this,e,function(e,t){n(e,t),r.uses>40&&(r.reset(),c(r,null,function(){}))})},findFile:function(e){return this.fileMap[e]},flush:function(e){var t=this.cx;c(this,null,function(r){return r?e(r):void n.withContext(t,e)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(e){e&&(this.asyncError=e),0==--this.pending&&this.signal("everythingFetched")}});var W=25,H="break do instanceof typeof case else new var catch finally return void continue for switch while debugger function this with default if throw delete in try".split(" "),J=e.findQueryExpr=function(e,t,r){if(null==t.end)throw v("missing .query.end field");if(t.variable){var i=n.scopeAt(e.ast,T(e,t.end),e.scope);return{node:{type:"Identifier",name:t.variable,start:t.end,end:t.end+1},state:i}}var s=t.start&&T(e,t.start),o=T(e,t.end),a=n.findExpressionAt(e.ast,s,o,e.scope);if(a)return a;if(a=n.findExpressionAround(e.ast,s,o,e.scope),a&&(r||(null==s?o:s)-a.node.start<20||a.node.end-o<20))return a;throw v("No expression at the given position.")},U=e.getSpan=function(e){if(e.origin){if(e.originNode){var n=e.originNode;return/^Function/.test(n.type)&&n.id&&(n=n.id),{origin:e.origin,node:n}}return e.span?{origin:e.origin,span:e.span}:void 0}},X=e.storeSpan=function(e,n,t,r){if(r.origin=t.origin,t.span){var i=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(t.span);r.start=n.lineCharPositions?{line:Number(i[2]),ch:Number(i[3])}:Number(i[1]),r.end=n.lineCharPositions?{line:Number(i[5]),ch:Number(i[6])}:Number(i[4])}else{var s=e.findFile(t.origin);r.start=q(n,s,t.node.start),r.end=q(n,s,t.node.end)}};e.version="0.7.0"});
//# sourceMappingURL=tern.min.js.map