!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,r,n,s){var i=new u(e,null,n,s).parseType(r,!0);if(/^fn\(/.test(e))for(var o=0;o<i.args.length;++o)(function(e){var r=i.args[e];r instanceof t.Fn&&r.args&&r.args.length&&a(i,function(n,a){var s=a[e];s&&s.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(o);return i}function a(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,s,i){var o=t(e,s,i),p=n?n(e,s,i):a;return r?o:p}}function s(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function i(e){if(!e["!type"]||/^(fn\(|\[)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function o(e,n,a){if(!e){var p=n["!type"];if(p)if(/^fn\(/.test(p))e=s(t.Fn);else{if("["!=p.charAt(0))throw new Error("Invalid !type spec: "+p);e=s(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:s(t.Obj);e.name=a}for(var l in n)if(r(n,l)&&33!=l.charCodeAt(0)){var f=n[l];if("string"==typeof f||i(f))continue;var c=e.defProp(l);o(c.getType(!1),f,a?a+"."+l:l).propagate(c)}return e}function p(e,a,s){if(e.isShell){delete e.isShell;var o=a["!type"];if(o)n(o,s,e);else{var f=a["!proto"]&&n(a["!proto"]);t.Obj.call(e,!(f instanceof t.Obj)||f,s)}}var c=a["!effects"];if(c&&e instanceof t.Fn)for(var u=0;u<c.length;++u)v(c[u],e);l(a,e);for(var h in a)if(r(a,h)&&33!=h.charCodeAt(0)){var g=a[h],d=e.defProp(h),y=s?s+"."+h:h,w=d.getType(!1);if("string"==typeof g){if(w)continue;n(g,y).propagate(d)}else{if(i(g)){if(w)continue;n(g["!type"],y,null,!0).propagate(d),w=d.getType(!1),w instanceof t.Obj&&l(g,w)}else p(w,g,y);g["!doc"]&&(d.doc=g["!doc"]),g["!url"]&&(d.url=g["!url"]),g["!span"]&&(d.span=g["!span"])}}}function l(e,t){e["!doc"]&&(t.doc=e["!doc"]),e["!url"]&&(t.url=e["!url"]),e["!span"]&&(t.span=e["!span"]),e["!data"]&&(t.metaData=e["!data"])}function f(e,r){var n=t.cx().parent,a=n&&n.passes&&n.passes[e];if(a)for(var s=0;s<a.length;s++)a[s](r)}function c(e,r){var n=t.cx();t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.localDefs=n.definitions[n.curOrigin]=Object.create(null),f("preLoadDef",e),o(r,e);var a=e["!define"];if(a){for(var s in a){var i=a[s];n.localDefs[s]="string"==typeof i?g(i):o(null,i,s)}for(var s in a){var i=a[s];"string"!=typeof i&&p(n.localDefs[s],a[s],s)}}p(r,e),f("postLoadDef",e),n.curOrigin=n.localDefs=null}var u=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};u.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r){var n=[],a=[];if(!this.eat(")"))for(var s=0;;++s){var i,o=this.spec.indexOf(": ",this.pos);if(o!=-1&&(i=this.spec.slice(this.pos,o),/^[$\w?]+$/.test(i)?this.pos=o+2:i=null),a.push(i),n.push(this.parseType()),!this.eat(", ")){this.eat(")")||this.error();break}}var p,l,f,c;return this.eat(" -> ")?r&&this.spec.indexOf("!",this.pos)>-1?(p=t.ANull,f=this.pos,l=this.parseRetType()):p=this.parseType():p=t.ANull,r&&(c=this.base)?t.Fn.call(this.base,e,t.ANull,n,a,p):c=new t.Fn(e,t.ANull,n,a,p),l&&(c.computeRet=l),null!=f&&(c.computeRetSource=this.spec.slice(f,this.pos)),c},parseType:function(e,r){if(this.eat("fn("))return this.parseFnType(e,r);if(this.eat("[")){var n=this.parseType();if(n==t.ANull&&"[b.<i>]"==this.spec){var a=g("b");console.log(a.props["<i>"].types.length)}return this.eat("]")||this.error(),r&&this.base?(t.Arr.call(this.base,n),this.base):new t.Arr(n)}if(this.eat("+")){var s=this.word(/[\w$<>\.!]/),i=g(s+".prototype");return i instanceof t.Obj||(i=g(s)),i instanceof t.Obj?r&&this.forceNew?new t.Obj(i):t.getInstance(i):i}return this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!`]/))},fromWord:function(e){var r=t.cx();switch(e){case"number":return r.num;case"string":return r.str;case"bool":return r.bool;case"<top>":return r.topScope}return r.localDefs&&e in r.localDefs?r.localDefs[e]:g(e)},parseBaseRetType:function(){if(this.eat("[")){var e=this.parseRetType();return this.eat("]")||this.error(),function(r,n){return new t.Arr(e(r,n))}}if(this.eat("+")){var r=this.parseRetType();return function(e,n){return t.getInstance(r(e,n))}}if(this.eat("!")){var n=this.word(/\d/);if(n)return n=Number(n),function(e,r){return r[n]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var a=this.word(/[\w$]/);return d[a]||function(){return t.ANull}}return this.fromWord("!"+n+this.word(/[\w$<>\.!]/))}var s=this.parseType();return function(){return s}},extendRetType:function(e){var r=this.word(/[\w<>$!]/)||this.error();return"!ret"==r?function(r,n){var a=e(r,n);if(a.retval)return a.retval;var s=new t.AVal;return a.propagate(new t.IsCallee(t.ANull,[],null,s)),s}:function(t,n){return e(t,n).getProp(r)}},parseRetType:function(){for(var e=this.parseBaseRetType();this.eat(".");)e=this.extendRetType(e);return e}};var h,v=e.parseEffect=function(e,r){var n;if(0==e.indexOf("propagate ")){var s=new u(e,10),i=s.parseRetType();s.eat(" ")||s.error();var o=s.parseRetType();a(r,function(e,t){i(e,t).propagate(o(e,t))})}else if(0==e.indexOf("call ")){var p=5==e.indexOf("and return ",5),s=new u(e,p?16:5),l=s.parseRetType(),f=null,c=[];for(s.eat(" this=")&&(f=s.parseRetType());s.eat(" ");)c.push(s.parseRetType());a(r,function(e,r){for(var n=l(e,r),a=f?f(e,r):t.ANull,s=[],i=0;i<c.length;++i)s.push(c[i](e,r));var o=p?new t.AVal:t.ANull;return n.propagate(new t.IsCallee(a,s,null,o)),o},p)}else if(n=e.match(/^custom (\S+)\s*(.*)/)){var h=d[n[1]];h&&a(r,n[2]?h(n[2]):h)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var s=new u(e,5),v=s.parseRetType();s.eat(" ");var g=s.parseRetType();a(r,function(e,r){var n=v(e,r),a=g(e,r);n.forAllProps(function(e,r,n){n&&"<i>"!=e&&a.propagate(new t.PropHasSubset(e,r))})})}},g=e.parsePath=function(e){var r=t.cx(),n=r.paths[e],a=e;if(null!=n)return n;r.paths[e]=t.ANull;var s=h||r.topScope;if(r.localDefs)for(var i in r.localDefs)if(0==e.indexOf(i)){if(e==i)return r.paths[e]=r.localDefs[e];if("."==e.charAt(i.length)){s=r.localDefs[i],e=e.slice(i.length+1);break}}for(var o=e.split("."),p=0;p<o.length&&s!=t.ANull;++p){var l=o[p];if("!"==l.charAt(0))if("!proto"==l)s=s instanceof t.Obj&&s.proto||t.ANull;else{var f=s.getFunctionType();if(f)if("!ret"==l)s=f.retval&&f.retval.getType(!1)||t.ANull;else{var c=f.args&&f.args[Number(l.slice(1))];s=c&&c.getType(!1)||t.ANull}else s=t.ANull}else if(s instanceof t.Obj){var u="prototype"==l&&s instanceof t.Fn?s.getProp(l):s.props[l];s=!u||u.isEmpty()?t.ANull:u.types[0]}}return r.paths[a]=s==t.ANull?null:s,s};e.load=function(e,r){r||(r=t.cx().topScope);var n=h;h=r;try{c(e,r)}finally{h=n}};var d=Object.create(null);t.registerFunction=function(e,t){d[e]=t};var y=t.constraint("created, target, spec",{addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getType(!1)),n instanceof t.Obj)for(var a in n.props){var s=n.props[a].types[0],i=r.defProp(a);if(s&&s instanceof t.Obj&&s.props.value){var o=s.props.value.getType(!1);o&&i.addType(o)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new y(0,a,r[1])),a});var w=t.constraint("self, args, target",{addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,e.self,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});return t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new w(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),s=0;s<r.length;++s)r[s].propagate(a);return n}),e});
//# sourceMappingURL=def.min.js.map