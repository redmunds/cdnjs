!function(e,t){return"object"==typeof exports&&"object"==typeof module?t(exports,require("./infer"),require("./signal"),require("acorn"),require("acorn/dist/walk")):"function"==typeof define&&define.amd?define(["exports","./infer","./signal","acorn/dist/acorn","acorn/dist/walk"],t):void t(e.tern||(e.tern={}),tern,tern.signal,acorn,acorn.walk)}(this,function(e,t,n,r,i){"use strict";function o(e,t){this.name=e,this.parent=t,this.scope=this.text=this.ast=this.lineOffsets=null}function s(e,n){var r={directSourceFile:n,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,ecmaVersion:e.options.ecmaVersion},i=e.signalReturnFirst("preParse",n.text,r)||n.text,o=t.parse(i,r);return e.signal("postParse",o,i),o}function a(e,n,r){e.text=r.options.stripCRs?n.replace(/\r\n/g,"\n"):n,t.withContext(r.cx,function(){e.ast=s(r,e)}),e.lineOffsets=null}function f(e,n,r){if(n.query&&!W.hasOwnProperty(n.query.type))return r("No query type '"+n.query.type+"' defined");var i=n.query;i||r(null,{});var o=n.files||[];o.length&&++e.uses;for(var s=0;s<o.length;++s){var a=o[s];"delete"==a.type?e.delFile(a.name):l(e,a.name,null,"full"==a.type?a.text:null)}var f="number"==typeof n.timeout?[n.timeout]:null;if(!i)return void c(e,f,function(){});var u=W[i.type];if(u.takesFile){if("string"!=typeof i.file)return r(".query.file must be a string");/^#/.test(i.file)||l(e,i.file,null)}c(e,f,function(n){function s(){var t;try{t=u.run(e,i,a)}catch(t){return e.options.debug&&"TernError"!=t.name&&console.error(t.stack),r(t)}r(null,t)}if(n)return r(n);var a=u.takesFile&&y(e,o,i.file);return u.fullFile&&"part"==a.type?r("Can't run a "+i.type+" query on a file fragment"):(t.resetGuessing(),void t.withContext(e.cx,f?function(){t.withTimeout(f[0],s)}:s))})}function u(e,n){return t.withContext(e.cx,function(){n.scope=e.cx.topScope,e.signal("beforeLoad",n),t.analyze(n.ast,n.name,n.scope),e.signal("afterLoad",n)}),n}function l(e,t,n,r){var i=e.findFile(t);if(i)return null!=r&&(i.scope&&(e.needsPurge.push(t),i.scope=null),a(i,r,e)),void(x(e,i.parent)>x(e,n)&&(i.parent=n,i.excluded&&(i.excluded=null)));var s=new o(t,n);e.files.push(s),e.fileMap[t]=s,null!=r?a(s,r,e):e.options.async?(e.startAsyncAction(),e.options.getFile(t,function(t,n){a(s,n||"",e),e.finishAsyncAction(t)})):a(s,e.options.getFile(t)||"",e)}function p(e,t,n){var r=function(){e.off("everythingFetched",r),clearTimeout(i),c(e,t,n)};e.on("everythingFetched",r);var i=setTimeout(r,e.options.fetchTimeout)}function c(e,n,r){if(e.pending)return p(e,n,r);var i=e.fetchError;if(i)return e.fetchError=null,r(i);e.needsPurge.length>0&&t.withContext(e.cx,function(){t.purge(e.needsPurge),e.needsPurge.length=0});for(var o=!0,s=0;s<e.files.length;){for(var a=[];s<e.files.length;++s){var f=e.files[s];null==f.text?o=!1:null!=f.scope||f.excluded||a.push(f)}a.sort(function(t,n){return x(e,t.parent)-x(e,n.parent)});for(var l=0;l<a.length;l++){var f=a[l];if(f.parent&&!w(e,f))f.excluded=!0;else if(n){var c=+new Date;t.withTimeout(n[0],function(){u(e,f)}),n[0]-=+new Date-c}else u(e,f)}}o?r():p(e,n,r)}function d(e){var t=e.indexOf("\n");return t<0?e:e.slice(0,t)}function h(e,t,n){var r=Math.max(0,n-500),i=null;if(!/^\s*$/.test(e))for(;;){var o=t.indexOf(e,r);if(o<0||o>n+500)break;(null==i||Math.abs(i-n)>Math.abs(o-n))&&(i=o),r=o+e.length}return i}function g(e){for(var t=0;e;++t,e=e.prev);return t}function v(e){var t=new Error(e);return t.name="TernError",t}function y(e,n,r){var o=r.match(/^#(\d+)$/);if(!o)return e.findFile(r);var a=n[o[1]];if(!a||"delete"==a.type)throw v("Reference to unknown file "+r);if("full"==a.type)return e.findFile(a.name);var f=a.backing=e.findFile(a.name),u=a.offset;a.offsetLines&&(u={line:a.offsetLines,ch:0}),a.offset=u=X(f,null==a.offsetLines?a.offset:{line:a.offsetLines,ch:0},!0);var l,p,c=d(a.text),y=h(c,f.text,u),m=null==y?Math.max(0,f.text.lastIndexOf("\n",u)):y;return t.withContext(e.cx,function(){t.purge(a.name,m,m+a.text.length);var n,r=a.text;if(n=r.match(/(?:"([^"]*)"|([\w$]+))\s*:\s*function\b/)){var o=i.findNodeAround(a.backing.ast,m,"ObjectExpression");o&&o.node.objType&&(l={type:o.node.objType,prop:n[2]||n[1]})}if(y&&(n=c.match(/^(.*?)\bfunction\b/))){for(var u=n[1].length,d="",h=0;h<u;++h)d+=" ";a.text=d+r.slice(u),p=!0}var v=t.scopeAt(f.ast,m,f.scope),x=t.scopeAt(f.ast,m+r.length,f.scope),b=a.scope=g(v)<g(x)?x:v;a.ast=s(e,a),t.analyze(a.ast,a.name,b);e:if(l||p){var w=t.scopeAt(a.ast,c.length,v);if(!w.fnType)break e;if(l){var F=l.type.getProp(l.prop);F.addType(w.fnType)}else if(p){var O=t.scopeAt(f.ast,m+c.length,f.scope);if(O==v||!O.fnType)break e;var j=O.fnType,P=w.fnType;if(!P||P.name!=j.name&&j.name)break e;for(var h=0,A=Math.min(j.args.length,P.args.length);h<A;++h)j.args[h].propagate(P.args[h]);j.self.propagate(P.self),P.retval.propagate(j.retval)}}}),a}function m(e){var t=0;return i.simple(e,{Expression:function(){++t}}),t}function x(e,t){for(var n=0;t;)t=e.findFile(t).parent,++n;return n}function b(e,t){for(;;){var n=e.findFile(t.parent);if(!n.parent)break;t=n}return t.name}function w(e,t){var n=b(e,t),r=m(t.ast),i=e.budgets[n];return null==i&&(i=e.budgets[n]=e.options.dependencyBudget),!(i<r)&&(e.budgets[n]=i-r,!0)}function F(e){return"number"==typeof e||"object"==typeof e&&"number"==typeof e.line&&"number"==typeof e.ch}function O(e){if(e.query){if("string"!=typeof e.query.type)return".query.type must be a string";if(e.query.start&&!F(e.query.start))return".query.start must be a position";if(e.query.end&&!F(e.query.end))return".query.end must be a position"}if(e.files){if(!Array.isArray(e.files))return"Files property must be an array";for(var t=0;t<e.files.length;++t){var n=e.files[t];if("object"!=typeof n)return".files[n] must be objects";if("string"!=typeof n.name)return".files[n].name must be a string";if("delete"!=n.type){if("string"!=typeof n.text)return".files[n].text must be a string";if("part"==n.type){if(!F(n.offset)&&"number"!=typeof n.offsetLines)return".files[n].offset must be a position"}else if("full"!=n.type)return'.files[n].type must be "full" or "part"'}}}}function j(e,t){for(var n=e.text,r=e.lineOffsets||(e.lineOffsets=[0]),i=0,o=0,s=Math.min(Math.floor(t/U),r.length-1),i=r[s],o=s*U;o<t;){if(++o,i=n.indexOf("\n",i)+1,0===i)return null;o%U===0&&r.push(i)}return i}function P(e,t){if(!e)return{line:0,ch:0};for(var n,r,i=e.lineOffsets||(e.lineOffsets=[0]),o=e.text,s=i.length-1;s>=0;--s)i[s]<=t&&(n=s*U,r=i[s]);for(;;){var a=o.indexOf("\n",r);if(a>=t||a<0)break;r=a+1,++n}return{line:n,ch:t-r}}function A(e){for(var t in e)null==e[t]&&delete e[t];return e}function C(e,t,n){null!=n&&(e[t]=n)}function k(e,t){"string"!=typeof e&&(e=e.name,t=t.name);var n=/^[A-Z]/.test(e),r=/^[A-Z]/.test(t);return n==r?e<t?-1:e==t?0:1:n?1:-1}function T(e,t,n){return"Literal"==e.type&&"string"==typeof e.value&&e.start==t-1&&e.end<=n+1}function q(e,t){for(var n=0;n<e.properties.length;n++){var r=e.properties[n];if(r.key.start<=t&&r.key.end>=t)return r}}function E(e,n,i){function o(t,r,i,o){if((!x&&n.omitObjectPrototype===!1||r!=e.cx.protos.Object||p)&&!(n.filter!==!1&&p&&0!==(n.caseInsensitive?t.toLowerCase():t).indexOf(p)||l&&l.props[t])){var s=ee(n,c,t,r&&r.props[t],i);o&&s&&"string"!=typeof s&&o(s)}}if(null==n.end)throw v("missing .query.end field");var s=e.signalReturnFirst("completion",i,n);if(s)return s;for(var a=X(i,n.end),f=a,u=i.text;a&&r.isIdentifierChar(u.charCodeAt(a-1));)--a;if(n.expandWordForward!==!1)for(;f<u.length&&r.isIdentifierChar(u.charCodeAt(f));)++f;var l,p=u.slice(a,f),c=[];n.caseInsensitive&&(p=p.toLowerCase());var d,h,g,y,m,x,b=t.findExpressionAround(i.ast,null,a,i.scope);if(b){var w=b.node;if("MemberExpression"==w.type&&w.object.end<a)m=b;else if(T(w,a,f)){var F=t.parentNode(w,i.ast);"MemberExpression"==F.type&&F.property==w&&(m={node:F,state:b.state})}else if("ObjectExpression"==w.type){var O=q(w,f);O?(x=b,h=y=O.key.name):p||/:\s*$/.test(i.text.slice(0,a))||(x=b,h=y=!0)}}if(x)g=t.typeFromContext(i.ast,x),l=x.node.objType;else if(m)h=m.node.property,h="Literal"==h.type?h.value.slice(1):h.name,m.node=m.node.object,g=t.expressionType(m);else if("."==u.charAt(a-1)){for(var j=a-1;j&&("."==u.charAt(j-1)||r.isIdentifierChar(u.charCodeAt(j-1)));)j--;var P=u.slice(j,a-1);P&&(g=t.def.parsePath(P,i.scope).getObjType(),h=p)}if(null!=h){if(e.cx.completingProperty=h,g&&t.forAllPropertiesOf(g,o),!c.length&&n.guess!==!1&&g&&g.guessProperties&&g.guessProperties(function(e,t,n){e!=h&&"âœ–"!=e&&o(e,t,n)}),!c.length&&p.length>=2&&n.guess!==!1)for(var h in e.cx.props)o(h,e.cx.props[h][0],0);d="memberCompletion"}else t.forAllLocalsAt(i.ast,a,i.scope,o),n.includeKeywords&&_.forEach(function(e){o(e,null,0,function(e){e.isKeyword=!0})}),d="variableCompletion";return e.signal(d,i,a,f,o),n.sort!==!1&&c.sort(k),e.cx.completingProperty=null,{start:Y(n,i,a),end:Y(n,i,f),isProperty:!!h,isObjectKey:!!y,completions:c}}function N(e,t){var n=t.prefix,r=[];for(var i in e.cx.props)"<i>"==i||n&&0!==i.indexOf(n)||r.push(i);return t.sort!==!1&&r.sort(k),{completions:r}}function M(e,t,n){var r=te(e,t,n);if(r)return r;throw v("No expression at the given position.")}function L(e){return e&&(e=e.getType())&&e instanceof t.Obj?e:null}function I(e,n,r,i){var o;i&&(t.resetGuessing(),o=t.expressionType(i));var s=e.hasHandler("typeAt");if(s)for(var a=X(r,n.end),f=0;f<s.length;f++)o=s[f](r,a,i,o);if(!o)throw v("No type found at the given position.");var u;if("ObjectExpression"==i.node.type&&null!=n.end&&(u=q(i.node,X(r,n.end)))){var l=u.key.name,p=L(t.typeFromContext(r.ast,i));if(p&&p.hasProp(l))o=p.hasProp(l);else{var c=L(o);c&&c.hasProp(l)&&(o=c.hasProp(l))}}return o}function R(e,n,r){var i,o=te(r,n),s=I(e,n,r,o),a=s;if(s=n.preferFunction?s.getFunctionType()||s.getType():s.getType(),o&&("Identifier"==o.node.type?i=o.node.name:"MemberExpression"!=o.node.type||o.node.computed||(i=o.node.property.name)),null!=n.depth&&"number"!=typeof n.depth)throw v(".query.depth must be a number");var f={guess:t.didGuess(),type:t.toString(a,n.depth),name:s&&s.name,exprName:i,doc:a.doc,url:a.url};return s&&z(n,s,f),A(f)}function D(e,t){if(!t)return null;if("full"==e.docFormat)return t;var n=/.\n[\s@\n]/.exec(t);if(n&&(t=t.slice(0,n.index+1)),t=t.replace(/\n\s*/g," "),t.length<100)return t;var r=/[\.!?] [A-Z]/g;r.lastIndex=80;var i=r.exec(t);return i&&(t=t.slice(0,i.index+1)),t}function S(e,n,r){var i=te(r,n),o=I(e,n,r,i),s={url:o.url,doc:D(n,o.doc),type:t.toString(o)},a=o.getType();return a&&z(n,a,s),A(s)}function z(e,n,r){r.url||(r.url=n.url),r.doc||(r.doc=D(e,n.doc)),r.origin||(r.origin=n.origin);var i,o=t.cx().protos;!r.url&&!r.doc&&n.proto&&(i=n.proto.hasCtor)&&n.proto!=o.Object&&n.proto!=o.Function&&n.proto!=o.Array&&(r.url=i.url,r.doc=D(e,i.doc))}function G(e,n,r){var i=te(r,n),o=I(e,n,r,i);if(t.didGuess())return{};var s=ne(o),a={url:o.url,doc:D(n,o.doc),origin:o.origin};if(o.types)for(var f=o.types.length-1;f>=0;--f){var u=o.types[f];z(n,u,a),s||(s=ne(u))}if(s&&s.node){var l=s.node.sourceFile||e.findFile(s.origin),p=Y(n,l,s.node.start),c=Y(n,l,s.node.end);a.start=p,a.end=c,a.file=s.origin;var d=Math.max(0,s.node.start-50);a.contextOffset=s.node.start-d,a.context=l.text.slice(d,d+50)}else s&&(a.file=s.origin,re(e,n,s,a));return A(a)}function $(e,n,r,i,o){function s(e){return function(t,r){if(o)for(var i=r;i!=f;i=i.prev){var s=i.hasProp(o);if(s)throw v("Renaming `"+a+"` to `"+o+"` would make a variable at line "+(P(e,t.start).line+1)+" point to the definition at line "+(P(e,s.name.start).line+1))}l.push({file:e.name,start:Y(n,e,t.start),end:Y(n,e,t.end)})}}for(var a=i.node.name,f=i.state;f&&!(a in f.props);f=f.prev);if(!f)throw v("Could not find a definition for "+a);var u,l=[];if(f.originNode){if(u="local",o){for(var p=f.prev;p&&!(o in p.props);p=p.prev);p&&t.findRefs(f.originNode,f,o,p,function(e){throw v("Renaming `"+a+"` to `"+o+"` would shadow the definition used at line "+(P(r,e.start).line+1))})}t.findRefs(f.originNode,f,a,f,s(r))}else{u="global";for(var c=0;c<e.files.length;++c){var d=e.files[c];t.findRefs(d.ast,d.scope,a,f,s(d))}}return{refs:l,type:u,name:a}}function K(e,n,r,i){function o(e){return function(t){a.push({file:e.name,start:Y(n,e,t.start),end:Y(n,e,t.end)})}}var s=t.expressionType(r).getObjType();if(!s)throw v("Couldn't determine type of base object.");for(var a=[],f=0;f<e.files.length;++f){var u=e.files[f];t.findPropRefs(u.ast,u.scope,s,i.name,o(u))}return{refs:a,name:i.name}}function V(e,t,n){var r=M(n,t,!0);if(r&&"Identifier"==r.node.type)return $(e,t,n,r);if(r&&"MemberExpression"==r.node.type&&!r.node.computed){var i=r.node.property;return r.node=r.node.object,K(e,t,r,i)}if(r&&"ObjectExpression"==r.node.type)for(var o=X(n,t.end),s=0;s<r.node.properties.length;++s){var a=r.node.properties[s].key;if(a.start<=o&&a.end>=o)return K(e,t,r,a)}throw v("Not at a variable or property name.")}function Z(e,t,n){if("string"!=typeof t.newName)throw v(".query.newName should be a string");var r=M(n,t);if(!r||"Identifier"!=r.node.type)throw v("Not at a variable.");var i=$(e,t,n,r,t.newName),o=i.refs;delete i.refs,i.files=e.files.map(function(e){return e.name});for(var s=i.changes=[],a=0;a<o.length;++a){var f=o[a];f.text=t.newName,s.push(f)}return i}function B(e){return{files:e.files.map(function(e){return e.name})}}var Q=Object.create(null);e.registerPlugin=function(e,t){Q[e]=t};var H=e.defaultOptions={debug:!1,async:!1,getFile:function(e,t){this.async&&t(null,null)},normalizeFilename:function(e){return e},defs:[],plugins:{},fetchTimeout:1e3,dependencyBudget:2e4,reuseInstances:!0,stripCRs:!1,ecmaVersion:6,projectDir:"/"},W={completions:{takesFile:!0,run:E},properties:{run:N},type:{takesFile:!0,run:R},documentation:{takesFile:!0,run:S},definition:{takesFile:!0,run:G},refs:{takesFile:!0,fullFile:!0,run:V},rename:{takesFile:!0,fullFile:!0,run:Z},files:{run:B}};e.defineQueryType=function(e,t){W[e]=t},o.prototype.asLineChar=function(e){return P(this,e)};var J=e.Server=function(e){this.cx=null,this.options=e||{};for(var t in H)e.hasOwnProperty(t)||(e[t]=H[t]);this.projectDir=e.projectDir.replace(/\\/g,"/"),/\/$/.test(this.projectDir)||(this.projectDir+="/"),this.handlers=Object.create(null),this.files=[],this.fileMap=Object.create(null),this.needsPurge=[],this.budgets=Object.create(null),this.uses=0,this.pending=0,this.asyncError=null,this.mod={},this.defs=e.defs.slice(0),this.plugins=Object.create(null);for(var n in e.plugins)e.plugins.hasOwnProperty(n)&&this.loadPlugin(n,e.plugins[n]);this.reset()};J.prototype=n.mixin({addFile:function(e,t,n){!n||n in this.fileMap||(n=null),e in this.fileMap||(e=this.normalizeFilename(e)),l(this,e,n,t)},delFile:function(e){var t=this.findFile(e);t&&(this.needsPurge.push(t.name),this.files.splice(this.files.indexOf(t),1),delete this.fileMap[e])},reset:function(){this.signal("reset"),this.cx=new t.Context(this.defs,this),this.uses=0,this.budgets=Object.create(null);for(var e=0;e<this.files.length;++e){var n=this.files[e];n.scope=null}this.signal("postReset")},request:function(e,t){var n=O(e);if(n)return t(n);var r=this;f(this,e,function(e,n){t(e,n),r.uses>40&&(r.reset(),c(r,null,function(){}))})},findFile:function(e){return this.fileMap[e]},flush:function(e){var n=this.cx;c(this,null,function(r){return r?e(r):void t.withContext(n,e)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(e){e&&(this.asyncError=e),0===--this.pending&&this.signal("everythingFetched")},addDefs:function(e,t){t?this.defs.unshift(e):this.defs.push(e),this.cx&&this.reset()},loadPlugin:function(e,t){if(1==arguments.length&&(t=this.options.plugins[e]||!0),!(e in this.plugins)&&e in Q&&t){this.plugins[e]=!0;var n=Q[e](this,t);if(n&&(n.defs&&this.addDefs(n.defs,n.loadFirst),n.passes))for(var r in n.passes)n.passes.hasOwnProperty(r)&&this.on(r,n.passes[r])}},normalizeFilename:function(e){var t=this.options.normalizeFilename(e).replace(/\\/g,"/");return 0==t.indexOf(this.projectDir)&&(t=t.slice(this.projectDir.length)),t}});var U=25,X=e.resolvePos=function(e,t,n){if("number"!=typeof t){var r=j(e,t.line);if(null==r){if(!n)throw v("File doesn't contain a line "+t.line);t=e.text.length}else t=r+t.ch}if(t>e.text.length){if(!n)throw v("Position "+t+" is outside of file.");t=e.text.length}return t},Y=e.outputPos=function(e,t,n){if(e.lineCharPositions){var r=P(t,n);return"part"==t.type&&(r.line+=null!=t.offsetLines?t.offsetLines:P(t.backing,t.offset).line),r}return n+("part"==t.type?t.offset:0)},_="break do instanceof typeof case else new var catch finally return void continue for switch while debugger function this with default if throw delete in try".split(" "),ee=e.addCompletion=function(e,n,r,i,o){for(var s=e.types||e.docs||e.urls||e.origins,a=s||e.depths,f=0;f<n.length;++f){var u=n[f];if((a?u.name:u)==r)return}var l=a?{name:r}:r;if(n.push(l),i&&s){t.resetGuessing();var p=i.getType();l.guess=t.didGuess(),e.types&&(l.type=t.toString(i)),e.docs&&C(l,"doc",D(e,i.doc||p&&p.doc)),e.urls&&C(l,"url",i.url||p&&p.url),e.origins&&C(l,"origin",i.origin||p&&p.origin)}return e.depths&&(l.depth=o||0),l},te=e.findQueryExpr=function(e,n,r){if(null==n.end)throw v("missing .query.end field");if(n.variable){var i=t.scopeAt(e.ast,X(e,n.end),e.scope);return{node:{type:"Identifier",name:n.variable,start:n.end,end:n.end+1},state:i}}var o=n.start&&X(e,n.start),s=X(e,n.end),a=t.findExpressionAt(e.ast,o,s,e.scope);return a?a:(a=t.findExpressionAround(e.ast,o,s,e.scope),a&&("ObjectExpression"==a.node.type||r||(null==o?s:o)-a.node.start<20||a.node.end-s<20)?a:null)},ne=e.getSpan=function(e){if(e.origin){if(e.originNode){var t=e.originNode;return/^Function/.test(t.type)&&t.id&&(t=t.id),{origin:e.origin,node:t}}return e.span?{origin:e.origin,span:e.span}:void 0}},re=e.storeSpan=function(e,t,n,r){if(r.origin=n.origin,n.span){var i=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(n.span);r.start=t.lineCharPositions?{line:Number(i[2]),ch:Number(i[3])}:Number(i[1]),r.end=t.lineCharPositions?{line:Number(i[5]),ch:Number(i[6])}:Number(i[4])}else{var o=e.findFile(n.origin);r.start=Y(t,o,n.node.start),r.end=Y(t,o,n.node.end)}};e.version="0.16.0"});
//# sourceMappingURL=tern.min.js.map