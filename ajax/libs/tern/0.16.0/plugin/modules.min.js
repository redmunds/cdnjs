!function(e){return"object"==typeof exports&&"object"==typeof module?e(require("../lib/infer"),require("../lib/tern"),require("../lib/signal"),require):"function"==typeof define&&define.amd?define(["../lib/infer","../lib/tern","../lib/signal"],e):void e(tern,tern,tern.signal)}(function(e,t,n,o){"use strict";function r(e,t){this.server=e,this.options=t||{},this.modules=Object.create(null),this.nonRelative=Object.create(null),this.knownModules=Object.create(null),this.resolvers=[],this.modNameTests=[],this.importTests=[]}function i(e,t){if(/^https?:|^\//.test(t))return t;e&&!/\/$/.test(e)&&(e+="/");for(var n;n=/^\.(\.)?\//.exec(t);){if(n[1]&&e.length>1){var o=e.lastIndexOf("/",e.length-2);e=o==-1?"":e.slice(0,o+1)}t=t.slice(n[0].length)}return e+t}function s(e){var t=e.lastIndexOf("/");return t==-1?"":e.slice(0,t+1)}function a(e){var t=e.lastIndexOf("/");return t==-1?e:e.slice(t+1)}function l(t,n){if(/^\.\.?\//.test(t)){var o=i(s(n),t),r=e.cx().parent;return r.findFile(o)?o:r.findFile(o+".js")?o+".js":void 0}}function u(e){return/^\.\.?\//.test(e)}function d(e,t,n){return n.filter===!1||!e||0==(n.caseInsensitive?t.toLowerCase():t).indexOf(e)}function p(t){var n=e.cx().parent.mod.modules.modules,o=t.roots["!modules"]=new e.Obj(null);for(var r in n){var i=n[r],s=i.origin||r,a=o.defProp(s.replace(/\./g,"`"));a.origin=i.origin,i.propagate(a)}}function f(t){var n=e.cx(),o=n.parent.mod.modules,r=n.definitions[t["!name"]]["!modules"];if(r)for(var i in r.props){var s=i.replace(/`/g,"."),a=o.get(s);a.origin=s,r.props[i].propagate(a)}var l=n.definitions[t["!name"]]["!known_modules"];if(l)for(var i in l.props)o.knownModules[i.replace(/`/g,".")]=l.props[i]}function c(t,n,o,r){if(!o)return r;var i=e.cx().parent.mod.modules,s=i.getModType(o.node);return s?(r=Object.create(r),r.origin=s.origin,r.originNode=s.originNode,s.doc&&(r.doc=s.doc),s.url&&(r.url=s.url),r):r}function m(n,o){var r=t.resolvePos(n,o.end),i=e.findExpressionAround(n.ast,null,r,n.scope);if(!i)return null;var s=e.cx().parent.mod.modules;if(null!=s.isModName(i.node))return h(s,n,o,i.node,r);var a=s.isImport(i.node);return a&&a.name&&null!=a.prop?v(s,n,o,i.node,a,r):void 0}function v(n,o,r,i,s,a){var l=[],u=i.name.slice(0,a-i.start);r.caseInsensitive&&(u=u.toLowerCase());var d=n.resolveModule(s.name,i.sourceFile.name).getType();return d?(e.forAllPropertiesOf(d,function(n,o,i){o!=e.cx().protos.Object&&(r.filter!==!1&&u&&0!==(r.caseInsensitive?n.toLowerCase():n).indexOf(u)||t.addCompletion(r,l,n,o&&o.props[n],i))}),{start:t.outputPos(r,o,i.start),end:t.outputPos(r,o,a),completions:l,isSpecifier:!0}):null}function h(e,n,o,r,i){if(!("Literal"!=r.type||"string"!=typeof r.value||r.start>i||r.end<i)){var s=r.raw.slice(1,i-r.start),a=r.raw.charAt(0);s&&s.charAt(s.length-1)==a&&(s=s.slice(0,s.length-1)),o.caseInsensitive&&(s=s.toLowerCase());var l=[];return u(s)?e.completeFileName(l,o,n.name,s):e.completeModuleName(l,o,s),r.end==i+1&&n.text.charAt(i)==a&&++i,{start:t.outputPos(o,n,r.start),end:t.outputPos(o,n,i),isProperty:!1,completions:l.map(function(e){var t="string"==typeof e?e:e.name,n=JSON.stringify(t);return"'"==a&&(n=a+n.slice(1,n.length-1).replace(/'/g,"\\'")+a),"string"==typeof e?n:(e.displayName=t,e.name=n,e)})}}}r.prototype=n.mixin({buildWrappingScope:function(t,n,o){var r=new e.Scope(t,o);return r.origin=n,this.signal("wrapScope",r),r},maybeOverride:function(t){if(!this.options.modules||!this.options.modules.hasOwnProperty(t))return!1;if(this.modules[t])return this.modules[t];var n=this.options.modules[t];if("string"==typeof n&&"="==n.charAt(0))return e.def.parsePath(n.slice(1));var o=this.buildWrappingScope(e.cx().topScope,t);return e.def.load(n,o),this.modules[t]=o.exports},resolveModule:function(t,n){var o=this.maybeOverride(t);if(o)return o;var r=this.knownModules[t];if(r)return r;if(1==this.options.dontLoad||this.options.dontLoad&&new RegExp(this.options.dontLoad).test(t)||this.options.load&&!new RegExp(this.options.load).test(t))return e.ANull;for(var i,s=u(t),a=0;!i&&a<this.resolvers.length;a++)i=this.resolvers[a](t,n);if(i||(i=l(t,n)),!i)return e.ANull;if("string"!=typeof i)return s||(this.nonRelative[t]=!0),i;var r=this.modules[i];return r?r:(/\.js$|(?:^\/)[^\.]+$/.test(i)&&this.server.addFile(i,null,n),s||(this.nonRelative[t]=i),this.modules[i]=new e.AVal)},findIn:function(e,t){for(var n=0;n<e.length;n++){var o=e[n](t);if(null!=o)return o}},isModName:function(e){return this.findIn(this.modNameTests,e)},isImport:function(e){return this.findIn(this.importTests,e)},get:function(t){return this.modules[t]||(this.modules[t]=new e.AVal)},completeModuleName:function(e,n,o){function r(r,i){for(var s in r)d(o,s,n)&&t.addCompletion(n,e,s,i&&r[s])}r(this.knownModules,!0),this.options.modules&&r(this.options.modules,!1);var i=Object.create(null);for(var s in this.nonRelative){var a=this.nonRelative[s];if(1==a||s.indexOf("/")==-1)d(o,s,n)&&t.addCompletion(n,e,s);else if(0==s.indexOf(o)&&o.indexOf("/")>-1){var l=/.*?\/(.*)/.exec(s)[1],u=a.indexOf(l);if(u>-1){var p=a.slice(0,u)+(/.*?\/(.*\/)?/.exec(o)[1]||"");if(p in i)continue;i[p]=!0,this.completeFileName(e,n,null,o,p)}}}},completeFileName:function(e,n,o,r,l){var u=o?i(s(o),r):a(r);for(var p in this.modules)if(p!=o&&d(u,p,n)){/\.js$/.test(p)&&(p=p.slice(0,p.length-3));var f=p.slice(u.length);t.addCompletion(n,e,r+f,this.modules[p])}},getModType:function(e){var t,n,o=this.isModName(e);if(null==o&&(t=this.isImport(e))&&(o=t.name,n=t.prop),null!=o){var r=this.resolveModule(o,e.sourceFile.name);return(n?r.getProp(n):r).getType()}}}),o&&function(){var e=o("fs"),n=o("path");r.prototype.completeFileName=function(o,r,i,s,a){var l=this.server.projectDir,u=/\/$/.test(s);if(i){var p=n.resolve(l,n.dirname(i),s);a=u?p:n.dirname(p)}var f=u?s:n.dirname(s)+"/",c=u?"":n.basename(s),m=this;e.readdirSync(a).forEach(function(e){if(!/^\./.test(e)&&d(c,e,r)){var s=m.server.normalizeFilename(n.relative(l,n.resolve(a,e)));if(s==i)return;var u=m.modules[s];/\.js$/.test(e)&&(e=e.slice(0,e.length-3)),t.addCompletion(r,o,f+e,u)}})}}(),t.registerPlugin("modules",function(e,t){e.mod.modules=new r(e,t),e.on("beforeLoad",function(e){e.scope=this.mod.modules.buildWrappingScope(e.scope,e.name,e.ast)}),e.on("afterLoad",function(e){var t=this.mod.modules.get(e.name);t.origin=e.name,this.mod.modules.signal("getExports",e,t)}),e.on("reset",function(){this.mod.modules.modules=Object.create(null)}),e.on("preCondenseReach",p),e.on("postLoadDef",f),e.on("typeAt",c),e.on("completion",m)}),t.defineQueryType("exports",{takesFile:!0,run:function(n,o,r){function i(r){var i={},s=r.getType(!1);i.type=e.toString(s,3);var a=r.doc||s&&s.doc,l=r.url||s&&s.url;a&&(i.doc=a),l&&(i.url=l);var u=t.getSpan(r)||s&&t.getSpan(s);return u&&t.storeSpan(n,o,u,i),i}var s=n.mod.modules,a=s&&s.modules[r.name];if(!a)return{};var l=i(a),u=a.getType(!1);if(u instanceof e.Obj){var d=l.props={};for(var p in u.props)d[p]=i(u.props[p])}return l}})});
//# sourceMappingURL=modules.min.js.map