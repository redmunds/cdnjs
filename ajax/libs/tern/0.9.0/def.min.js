!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,r,n,s){var i=new c(e,null,n,s).parseType(r,!0);if(/^fn\(/.test(e))for(var o=0;o<i.args.length;++o)(function(e){var r=i.args[e];r instanceof t.Fn&&r.args&&r.args.length&&a(i,function(n,a){var s=a[e];s&&s.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(o);return i}function a(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,s,i){var o=t(e,s,i),p=n?n(e,s,i):a;return r?o:p}}function s(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function i(e){if(!e["!type"]||/^(fn\(|\[)/.test(e["!type"]))return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function o(e,n,a){if(!e){var p=n["!type"];if(p)if(/^fn\(/.test(p))e=s(t.Fn);else{if("["!=p.charAt(0))throw new Error("Invalid !type spec: "+p);e=s(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:s(t.Obj);e.name=a}for(var l in n)if(r(n,l)&&33!=l.charCodeAt(0)){var f=n[l];if("string"==typeof f||i(f))continue;var u=e.defProp(l);o(u.getObjType(),f,a?a+"."+l:l).propagate(u)}return e}function p(e,a,s){if(e.isShell){delete e.isShell;var o=a["!type"];if(o)n(o,s,e);else{var f=a["!proto"]&&n(a["!proto"]);t.Obj.call(e,!(f instanceof t.Obj)||f,s)}}var u=a["!effects"];if(u&&e instanceof t.Fn)for(var c=0;c<u.length;++c)g(u[c],e);l(a,e);for(var h in a)if(r(a,h)&&33!=h.charCodeAt(0)){var v=a[h],y=e.defProp(h),d=s?s+"."+h:h;if("string"==typeof v)y.isEmpty()&&n(v,d).propagate(y);else{if(i(v)){if(!y.isEmpty())continue;n(v["!type"],d,null,!0).propagate(y)}else p(y.getObjType(),v,d);v["!doc"]&&(y.doc=v["!doc"]),v["!url"]&&(y.url=v["!url"]),v["!span"]&&(y.span=v["!span"])}}return e}function l(e,t){e["!doc"]&&(t.doc=e["!doc"]),e["!url"]&&(t.url=e["!url"]),e["!span"]&&(t.span=e["!span"]),e["!data"]&&(t.metaData=e["!data"])}function f(e,r){var n=t.cx().parent,a=n&&n.passes&&n.passes[e];if(a)for(var s=0;s<a.length;s++)a[s](r)}function u(e,r){var n=t.cx();t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.localDefs=n.definitions[n.curOrigin]=Object.create(null),f("preLoadDef",e),o(r,e);var a=e["!define"];if(a){for(var s in a){var i=a[s];n.localDefs[s]="string"==typeof i?v(i):o(null,i,s)}for(var s in a){var i=a[s];"string"!=typeof i&&p(n.localDefs[s],a[s],s)}}p(r,e),f("postLoadDef",e),n.curOrigin=n.localDefs=null}var c=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};c.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r){var n=[],a=[];if(!this.eat(")"))for(var s=0;;++s){var i,o=this.spec.indexOf(": ",this.pos);if(o!=-1&&(i=this.spec.slice(this.pos,o),/^[$\w?]+$/.test(i)?this.pos=o+2:i=null),a.push(i),n.push(this.parseType()),!this.eat(", ")){this.eat(")")||this.error();break}}var p,l,f,u;return this.eat(" -> ")?r&&this.spec.indexOf("!",this.pos)>-1?(p=t.ANull,f=this.pos,l=this.parseRetType()):p=this.parseType():p=t.ANull,r&&(u=this.base)?t.Fn.call(this.base,e,t.ANull,n,a,p):u=new t.Fn(e,t.ANull,n,a,p),l&&(u.computeRet=l),null!=f&&(u.computeRetSource=this.spec.slice(f,this.pos)),u},parseType:function(e,r){for(var n,a=!1;;){var s=this.parseTypeInner(e,r);if(a?s.propagate(a):n=s,!this.eat("|"))break;a||(a=new t.AVal,n.propagate(a),n=a)}return n},parseTypeInner:function(e,r){if(this.eat("fn("))return this.parseFnType(e,r);if(this.eat("[")){var n=this.parseType();return this.eat("]")||this.error(),r&&this.base?(t.Arr.call(this.base,n),this.base):new t.Arr(n)}if(this.eat("+")){var a=this.word(/[\w$<>\.!]/),s=v(a+".prototype");return s instanceof t.Obj||(s=v(a)),s instanceof t.Obj?r&&this.forceNew?new t.Obj(s):t.getInstance(s):s}return this.eat("?")?t.ANull:this.fromWord(this.word(/[\w$<>\.!`]/))},fromWord:function(e){var r=t.cx();switch(e){case"number":return r.num;case"string":return r.str;case"bool":return r.bool;case"<top>":return r.topScope}return r.localDefs&&e in r.localDefs?r.localDefs[e]:v(e)},parseBaseRetType:function(){if(this.eat("[")){var e=this.parseRetType();return this.eat("]")||this.error(),function(r,n){return new t.Arr(e(r,n))}}if(this.eat("+")){var r=this.parseRetType(),n=function(e,n){var a=r(e,n);return a instanceof t.Fn&&a.hasProp("prototype")&&(a=a.getProp("prototype").getObjType()),a instanceof t.Obj?new t.Obj(a):a};return this.eat("[")?this.parsePoly(n):n}if(this.eat("!")){var a=this.word(/\d/);if(a)return a=Number(a),function(e,r){return r[a]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var s=this.word(/[\w$]/);return y[s]||function(){return t.ANull}}return this.fromWord("!"+a+this.word(/[\w$<>\.!]/))}var i=this.parseType();return function(){return i}},extendRetType:function(e){var r=this.word(/[\w<>$!]/)||this.error();return"!ret"==r?function(r,n){var a=e(r,n);if(a.retval)return a.retval;var s=new t.AVal;return a.propagate(new t.IsCallee(t.ANull,[],null,s)),s}:function(t,n){return e(t,n).getProp(r)}},parsePoly:function(e){var r,n="<i>";(r=this.spec.slice(this.pos).match(/^\s*(\w+)\s*=\s*/))&&(n=r[1],this.pos+=r[0].length);var a=this.parseRetType();return this.eat("]")||this.error(),function(r,s){var i=e(r,s);return i instanceof t.Obj&&a(r,s).propagate(i.defProp(n)),i}},parseRetType:function(){for(var e=this.parseBaseRetType();this.eat(".");)e=this.extendRetType(e);return e}};var h,g=e.parseEffect=function(e,r){var n;if(0==e.indexOf("propagate ")){var s=new c(e,10),i=s.parseRetType();s.eat(" ")||s.error();var o=s.parseRetType();a(r,function(e,t){i(e,t).propagate(o(e,t))})}else if(0==e.indexOf("call ")){var p=5==e.indexOf("and return ",5),s=new c(e,p?16:5),l=s.parseRetType(),f=null,u=[];for(s.eat(" this=")&&(f=s.parseRetType());s.eat(" ");)u.push(s.parseRetType());a(r,function(e,r){for(var n=l(e,r),a=f?f(e,r):t.ANull,s=[],i=0;i<u.length;++i)s.push(u[i](e,r));var o=p?new t.AVal:t.ANull;return n.propagate(new t.IsCallee(a,s,null,o)),o},p)}else if(n=e.match(/^custom (\S+)\s*(.*)/)){var h=y[n[1]];h&&a(r,n[2]?h(n[2]):h)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var s=new c(e,5),g=s.parseRetType();s.eat(" ");var v=s.parseRetType();a(r,function(e,r){var n=g(e,r),a=v(e,r);n.forAllProps(function(e,r,n){n&&"<i>"!=e&&a.propagate(new t.PropHasSubset(e,r))})})}},v=e.parsePath=function(e,r){var n=t.cx(),a=n.paths[e],s=e;if(null!=a)return a;n.paths[e]=t.ANull;var i=r||h||n.topScope;if(n.localDefs)for(var o in n.localDefs)if(0==e.indexOf(o)){if(e==o)return n.paths[e]=n.localDefs[e];if("."==e.charAt(o.length)){i=n.localDefs[o],e=e.slice(o.length+1);break}}for(var p=e.split("."),l=0;l<p.length&&i!=t.ANull;++l){var f=p[l];if("!"==f.charAt(0))if("!proto"==f)i=i instanceof t.Obj&&i.proto||t.ANull;else{var u=i.getFunctionType();if(u)if("!ret"==f)i=u.retval&&u.retval.getType(!1)||t.ANull;else{var c=u.args&&u.args[Number(f.slice(1))];i=c&&c.getType(!1)||t.ANull}else i=t.ANull}else if(i instanceof t.Obj){var g="prototype"==f&&i instanceof t.Fn?i.getProp(f):i.props[f];i=!g||g.isEmpty()?t.ANull:g.types[0]}}return n.paths[s]=i==t.ANull?null:i,i};e.load=function(e,r){r||(r=t.cx().topScope);var n=h;h=r;try{u(e,r)}finally{h=n}},e.parse=function(e,r,a){var s=t.cx();r&&(s.origin=r,s.localDefs=s.definitions[r]);try{return"string"==typeof e?n(e,a):p(o(null,e,a),e,a)}finally{r&&(s.origin=s.localDefs=null)}};var y=Object.create(null);t.registerFunction=function(e,t){y[e]=t};var d=t.constraint("created, target, spec",{addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getObjType(!1)),n instanceof t.Obj)for(var a in n.props){var s=n.props[a].types[0],i=r.defProp(a);if(s&&s instanceof t.Obj&&s.props.value){var o=s.props.value.getType(!1);o&&i.addType(o)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new d(0,a,r[1])),a});var w=t.constraint("target",{addType:function(e){e instanceof t.Obj&&(e.hasProp("value")?e.getProp("value").propagate(this.target):e.hasProp("get")&&e.getProp("get").propagate(new t.IsCallee(t.ANull,[],null,this.target)))}});t.registerFunction("Object_defineProperty",function(e,r,n){if(n&&n.length>=3&&"Literal"==n[1].type&&"string"==typeof n[1].value){var a=r[0],s=new t.AVal;a.propagate(new t.PropHasSubset(n[1].value,s,n[1])),r[2].propagate(new w(s))}return t.ANull});var A=t.constraint("self, args, target",{addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,e.self,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});return t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new A(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),s=0;s<r.length;++s)r[s].propagate(a);return n}),t.registerFunction("Promise_ctor",function(e,r,n){if(r.length<1)return t.ANull;var a=new t.Obj(t.cx().definitions.ecma6["Promise.prototype"]),s=a.defProp("value",n&&n[0]),i=new t.AVal;i.propagate(s);var o=new t.Fn("execute",t.ANull,[i],["value"],t.ANull),p=t.cx().definitions.ecma6.promiseReject;return r[0].propagate(new t.IsCallee(t.ANull,[o,p],null,t.ANull)),a}),e});
//# sourceMappingURL=def.min.js.map