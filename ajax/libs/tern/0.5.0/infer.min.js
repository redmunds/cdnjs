!function(t){return"object"==typeof exports&&"object"==typeof module?t(exports,require("acorn/acorn"),require("acorn/acorn_loose"),require("acorn/util/walk"),require("./def"),require("./signal")):"function"==typeof define&&define.amd?define(["exports","acorn/acorn","acorn/acorn_loose","acorn/util/walk","./def","./signal"],t):void t(self.tern||(self.tern={}),acorn,acorn,acorn.walk,tern.def,tern.signal)}(function(t,r,e,n,o,i){"use strict";function p(t,r){var e=Object.create(t);if(r)for(var n in r)e[n]=r[n];return e}function a(t){for(var r=0,e=0,n=0,o=null,i=0;i<t.length;++i){var p=t[i];if(p instanceof ot)++r;else if(p instanceof nt)++e;else if(p instanceof et)++n;else if(p instanceof rt){if(o&&p.name!=o.name)return null;o=p}}var a=(r&&1)+(e&&1)+(n&&1)+(o&&1);if(a>1)return null;if(o)return o;for(var s=0,u=null,i=0;i<t.length;++i){var p=t[i],f=0;if(r)f=p.getProp("<i>").isEmpty()?1:2;else if(e){f=1;for(var c=0;c<p.args.length;++c)p.args[c].isEmpty()||++f;p.retval.isEmpty()||++f}else n?f=p.name?100:2:prims&&(f=1);f>=s&&(s=f,u=p)}return u}function s(){}function u(t,r){it.disabledComputing={fn:t,prev:it.disabledComputing};try{return r()}finally{it.disabledComputing=it.disabledComputing.prev}}function f(t,r){var e=it.props[t]||(it.props[t]=[]);e.push(r)}function c(t){return it.props[t]}function l(t){if(it.workList)return t(it.workList);var r=[],e=0,n=it.workList=function(t,n,o){e<pt-at*r.length&&r.push(t,n,o,e)};try{for(var o=t(n),i=0;i<r.length;i+=4)e=r[i+3]+1,r[i+1].addType(r[i],r[i+2]);return o}finally{it.workList=null}}function h(t,r){t.fnType&&(t.fnType.instantiateScore=(t.fnType.instantiateScore||0)+r)}function g(t,r){try{return n.simple(t,{Expression:function(){if(--r<=0)throw ut}}),!0}catch(t){if(t==ut)return!1;throw t}}function y(t,r){var e=r.fnType.instantiateScore;return!it.disabledComputing&&e&&r.fnType.args.length&&g(t,5*e)?(h(r.prev,e/2),d(t,r),!0):void(r.fnType.instantiateScore=null)}function d(t,r){for(var e=r.fnType,o=0;o<e.args.length;++o)e.args[o]=new G;e.self=new G,e.computeRet=function(o,i){return u(e,function(){var p=it.curOrigin;it.curOrigin=e.origin;var a=new st(r.prev);for(var s in r.props)for(var u=a.defProp(s),f=0;f<i.length;++f)e.argNames[f]==s&&f<i.length&&i[f].propagate(u);for(var c=e.argNames.length!=i.length?e.argNames.slice(0,i.length):e.argNames;c.length<i.length;)c.push("?");if(a.fnType=new nt(e.name,o,i,c,H),e.arguments){var l=a.fnType.arguments=new G;a.defProp("arguments").addType(new ot(l));for(var f=0;f<i.length;++f)i[f].propagate(l)}return t.body.scope=a,n.recursive(t.body,a,null,ft),n.recursive(t.body,a,null,lt),it.curOrigin=p,a.fnType.retval})}}function v(t){function r(t,e,o){if(!(o>3)&&t.forward)for(var i=0;i<t.forward.length;++i){var p=t.forward[i].propagatesTo();if(p){var a,s=e;if(p instanceof G)a=p;else{if(!(p.target instanceof G))continue;s+=p.pathExt,a=p.target}if(a==n)return s;var u=r(a,s,o+1);if(u)return u}}}var e=t.fnType,n=e.retval;if(n!=H){var i,p;!n.isEmpty()&&(i=n.getType())instanceof ot&&(n=p=i.getProp("<i>"));for(var a=r(e.self,"!this",0),s=0;!a&&s<e.args.length;++s)a=r(e.args[s],"!"+s,0);if(a){p&&(a="["+a+"]");var u=new o.TypeParser(a);return e.computeRet=u.parseRetType(),e.computeRetSource=a,!0}}}function m(t,r){var e=t.defProp(r.name,r);return e.maybePurge&&(e.maybePurge=!1),e}function P(t,r,e){var n=t.property;return t.computed?"Literal"==n.type&&"string"==typeof n.value?n.value:(e&&S(n,r,e,H),"<i>"):n.name}function b(t){switch(t){case"+":case"-":case"~":return it.num;case"!":return it.bool;case"typeof":return it.str;case"void":case"delete":return H}}function T(t){switch(t){case"==":case"!=":case"===":case"!==":case"<":case">":case">=":case"<=":case"in":case"instanceof":return!0}}function w(t){switch(typeof t){case"boolean":return it.bool;case"number":return it.num;case"string":return it.str;case"object":return t?$(it.protos.RegExp):H}}function x(t){return function(r,e,n,o,i){var p=t(r,e,n,i);return o&&p.propagate(o),p}}function E(t){return function(r,e,n,o,i){return o||(o=new G),t(r,e,n,o,i),o}}function S(t,r,e,n,o){return ct[t.type](t,r,e,n,o)}function N(t,r){var e=t&&t[r],n=Array.prototype.slice.call(arguments,2);if(e)for(var o=0;o<e.length;++o)e[o].apply(null,n)}function O(t,r,e){var n=Array.isArray(t);return n&&1==t.length&&(t=t[0],n=!1),n?null==e?function(r){return t.indexOf(r.origin)>-1}:function(n,o){return o&&o.start>=r&&o.end<=e&&t.indexOf(n.origin)>-1}:null==e?function(r){return r.origin==t}:function(n,o){return o&&o.start>=r&&o.end<=e&&n.origin==t}}function j(t){dt=!0;var r=c(t);if(r)for(var e=0;e<r.length;++e){var n=r[e].getProp(t);if(!n.isEmpty())return n}return H}function A(t,r){var e=gt[t.type](t,r);return e}var k=t.toString=function(t,r,e){return t&&t!=e?t.toString(r):"?"},H=t.ANull=i.mixin({addType:function(){},propagate:function(){},getProp:function(){return H},forAllProps:function(){},hasType:function(){return!1},isEmpty:function(){return!0},getFunctionType:function(){},getType:function(){},gatherProperties:function(){},propagatesTo:function(){},typeHint:function(){},propHint:function(){}}),C=100,F=90,I=10,R=5,_=5,B=90,L=2,G=t.AVal=function(){this.types=[],this.forward=null,this.maxWeight=0};G.prototype=p(H,{addType:function(t,r){if(r=r||C,this.maxWeight<r){if(this.maxWeight=r,1==this.types.length&&this.types[0]==t)return;this.types.length=0}else if(this.maxWeight>r||this.types.indexOf(t)>-1)return;this.signal("addType",t),this.types.push(t);var e=this.forward;e&&l(function(n){for(var o=0;o<e.length;++o)n(t,e[o],r)})},propagate:function(t,r){if(!(t==H||t instanceof tt)){r&&r<C&&(t=new Z(t,r)),(this.forward||(this.forward=[])).push(t);var e=this.types;e.length&&l(function(n){for(var o=0;o<e.length;++o)n(e[o],t,r)})}},getProp:function(t){if("__proto__"==t||"✖"==t)return H;var r=(this.props||(this.props=Object.create(null)))[t];return r||(r=this.props[t]=new G,this.propagate(new V(t,r))),r},forAllProps:function(t){this.propagate(new D(t))},hasType:function(t){return this.types.indexOf(t)>-1},isEmpty:function(){return 0==this.types.length},getFunctionType:function(){for(var t=this.types.length-1;t>=0;--t)if(this.types[t]instanceof nt)return this.types[t]},getType:function(t){return 0==this.types.length&&t!==!1?this.makeupType():1==this.types.length?this.types[0]:a(this.types)},makeupType:function(){if(!this.forward)return null;for(var t=this.forward.length-1;t>=0;--t){var r=this.forward[t].typeHint();if(r&&!r.isEmpty())return dt=!0,r}for(var e=Object.create(null),n=null,t=0;t<this.forward.length;++t){var o=this.forward[t].propHint();o&&"length"!=o&&"<i>"!=o&&"✖"!=o&&(e[o]=!0,n=o)}if(!n)return null;var i=c(n);if(i){var p=[];t:for(var t=0;t<i.length;++t){var s=i[t];for(var o in e)if(!s.hasProp(o))continue t;s.hasCtor&&(s=$(s)),p.push(s)}var u=a(p);if(u)return dt=!0,u}},typeHint:function(){return this.types.length?this.getType():null},propagatesTo:function(){return this},gatherProperties:function(t,r){for(var e=0;e<this.types.length;++e)this.types[e].gatherProperties(t,r)},guessProperties:function(t){if(this.forward)for(var r=0;r<this.forward.length;++r){var e=this.forward[r].propHint();e&&t(e,null,0)}}}),s.prototype=p(H,{init:function(){this.origin=it.curOrigin}});var M=t.constraint=function(t,r){var e="this.init();";t=t?t.split(", "):[];for(var n=0;n<t.length;++n)e+="this."+t[n]+" = "+t[n]+";";var o=Function.apply(null,t.concat([e]));o.prototype=Object.create(s.prototype);for(var i in r)r.hasOwnProperty(i)&&(o.prototype[i]=r[i]);return o},V=M("prop, target",{addType:function(t,r){t.getProp&&t.getProp(this.prop).propagate(this.target,r)},propHint:function(){return this.prop},propagatesTo:function(){return{target:this.target,pathExt:"."+this.prop}}}),q=t.PropHasSubset=M("prop, type, originNode",{addType:function(t,r){if(t instanceof et){var e=t.defProp(this.prop,this.originNode);e.origin=this.origin,this.type.propagate(e,r)}},propHint:function(){return this.prop}}),D=M("c",{addType:function(t){t instanceof et&&t.forAllProps(this.c)}}),U=t.IsCallee=M("self, args, argNodes, retval",{init:function(){s.prototype.init(),this.disabled=it.disabledComputing},addType:function(t,r){if(t instanceof nt){for(var e=0;e<this.args.length;++e)e<t.args.length&&this.args[e].propagate(t.args[e],r),t.arguments&&this.args[e].propagate(t.arguments,r);this.self.propagate(t.self,this.self==it.topScope?B:r);var n=t.computeRet;if(n)for(var o=this.disabled;o;o=o.prev)(o.fn==t||t.name&&o.fn.name==t.name)&&(n=null);n?n(this.self,this.args,this.argNodes).propagate(this.retval,r):t.retval.propagate(this.retval,r)}},typeHint:function(){for(var t=[],r=0;r<this.args.length;++r)t.push("?");return new nt(null,this.self,this.args,t,H)},propagatesTo:function(){return{target:this.retval,pathExt:".!ret"}}}),z=M("propName, args, argNodes, retval",{init:function(){s.prototype.init(),this.disabled=it.disabledComputing},addType:function(t,r){var e=new U(t,this.args,this.argNodes,this.retval);e.disabled=this.disabled,t.getProp(this.propName).propagate(e,r)},propHint:function(){return this.propName}}),W=t.IsCtor=M("target, noReuse",{addType:function(t,r){t instanceof nt&&t.getProp("prototype").propagate(new J(!this.noReuse&&t,this.target),r)}}),$=t.getInstance=function(t,r){if(r===!1)return new et(t);r||(r=t.hasCtor),t.instances||(t.instances=[]);for(var e=0;e<t.instances.length;++e){var n=t.instances[e];if(n.ctor==r)return n.instance}var o=new et(t,r&&r.name);return o.origin=t.origin,t.instances.push({ctor:r,instance:o}),o},J=t.IsProto=M("ctor, target",{addType:function(t,r){t instanceof et&&((this.count=(this.count||0)+1)>8||(t==it.protos.Array?this.target.addType(new ot):this.target.addType($(t,this.ctor))))}}),K=M("fn",{addType:function(t,r){if(t instanceof et&&!t.hasCtor){t.hasCtor=this.fn;var e=new Y(t,this.fn);e.addType(this.fn),t.forAllProps(function(t,r,n){n&&r.propagate(e)})}}}),Q=M("other, target",{addType:function(t,r){t==it.str?this.target.addType(it.str,r):t==it.num&&this.other.hasType(it.num)&&this.target.addType(it.num,r)},typeHint:function(){return this.other}}),X=M("target",{addType:function(t,r){t instanceof et&&this.target.addType(t,r)},propagatesTo:function(){return this.target}}),Y=M("obj, ctor",{addType:function(t){t instanceof nt&&t.self&&t.self.isEmpty()&&t.self.addType($(this.obj,this.ctor),L)}}),Z=M("inner, weight",{addType:function(t,r){this.inner.addType(t,Math.min(r,this.weight))},propagatesTo:function(){return this.inner.propagatesTo()},typeHint:function(){return this.inner.typeHint()},propHint:function(){return this.inner.propHint()}}),tt=t.Type=function(){};tt.prototype=p(H,{propagate:function(t,r){t.addType(this,r)},hasType:function(t){return t==this},isEmpty:function(){return!1},typeHint:function(){return this},getType:function(){return this}});var rt=t.Prim=function(t,r){this.name=r,this.proto=t};rt.prototype=p(tt.prototype,{toString:function(){return this.name},getProp:function(t){return this.proto.hasProp(t)||H},gatherProperties:function(t,r){this.proto&&this.proto.gatherProperties(t,r)}});var et=t.Obj=function(t,r){if(this.props||(this.props=Object.create(null)),this.proto=t===!0?it.protos.Object:t,t&&!r&&t.name&&!(this instanceof nt)){var e=/^(.*)\.prototype$/.exec(this.proto.name);e&&(r=e[1])}this.name=r,this.maybeProps=null,this.origin=it.curOrigin};et.prototype=p(tt.prototype,{toString:function(t){if(!t&&this.name)return this.name;var r=[],e=!1;for(var n in this.props)if("<i>"!=n){if(r.length>5){e=!0;break}t?r.push(n+": "+k(this.props[n].getType(),t-1)):r.push(n)}return r.sort(),e&&r.push("..."),"{"+r.join(", ")+"}"},hasProp:function(t,r){var e=this.props[t];if(r!==!1)for(var n=this.proto;n&&!e;n=n.proto)e=n.props[t];return e},defProp:function(t,r){var e=this.hasProp(t,!1);if(e)return r&&!e.originNode&&(e.originNode=r),e;if("__proto__"==t||"✖"==t)return H;var n=this.maybeProps&&this.maybeProps[t];return n?(delete this.maybeProps[t],this.maybeUnregProtoPropHandler()):n=new G,this.props[t]=n,n.originNode=r,n.origin=it.curOrigin,this.broadcastProp(t,n,!0),n},getProp:function(t){var r=this.hasProp(t,!0)||this.maybeProps&&this.maybeProps[t];return r?r:"__proto__"==t||"✖"==t?H:(this.maybeProps||(this.proto&&this.proto.forAllProps(this),this.maybeProps=Object.create(null)),this.maybeProps[t]=new G)},broadcastProp:function(t,r,e){if(e&&(this.signal("addProp",t,r),this instanceof st||f(t,this)),this.onNewProp)for(var n=0;n<this.onNewProp.length;++n){var o=this.onNewProp[n];o.onProtoProp?o.onProtoProp(t,r,e):o(t,r,e)}},onProtoProp:function(t,r,e){var n=this.maybeProps&&this.maybeProps[t];n&&(delete this.maybeProps[t],this.maybeUnregProtoPropHandler(),this.proto.getProp(t).propagate(n)),this.broadcastProp(t,r,!1)},forAllProps:function(t){this.onNewProp||(this.onNewProp=[],this.proto&&this.proto.forAllProps(this)),this.onNewProp.push(t);for(var r=this;r;r=r.proto)for(var e in r.props)t.onProtoProp?t.onProtoProp(e,r.props[e],r==this):t(e,r.props[e],r==this)},maybeUnregProtoPropHandler:function(){if(this.maybeProps){for(var t in this.maybeProps)return;this.maybeProps=null}!this.proto||this.onNewProp&&this.onNewProp.length||this.proto.unregPropHandler(this)},unregPropHandler:function(t){for(var r=0;r<this.onNewProp.length;++r)if(this.onNewProp[r]==t){this.onNewProp.splice(r,1);break}this.maybeUnregProtoPropHandler()},gatherProperties:function(t,r){for(var e in this.props)"<i>"!=e&&t(e,this,r);this.proto&&this.proto.gatherProperties(t,r+1)}});var nt=t.Fn=function(t,r,e,n,o){et.call(this,it.protos.Function,t),this.self=r,this.args=e,this.argNames=n,this.retval=o};nt.prototype=p(et.prototype,{toString:function(t){t&&t--;for(var r="fn(",e=0;e<this.args.length;++e){e&&(r+=", ");var n=this.argNames[e];n&&"?"!=n&&(r+=n+": "),r+=k(this.args[e].getType(),t,this)}return r+=")",this.retval.isEmpty()||(r+=" -> "+k(this.retval.getType(),t,this)),r},getProp:function(t){if("prototype"==t){var r=this.hasProp(t,!1);if(!r){r=this.defProp(t);var e=new et(!0,this.name&&this.name+".prototype");e.origin=this.origin,r.addType(e,I)}return r}return et.prototype.getProp.call(this,t)},defProp:function(t,r){if("prototype"==t){var e=this.hasProp(t,!1);return e?e:(e=et.prototype.defProp.call(this,t,r),e.origin=this.origin,e.propagate(new K(this)),e)}return et.prototype.defProp.call(this,t,r)},getFunctionType:function(){return this}});var ot=t.Arr=function(t){et.call(this,it.protos.Array);var r=this.defProp("<i>");t&&t.propagate(r)};ot.prototype=p(et.prototype,{toString:function(t){return"["+k(this.getProp("<i>").getType(),t,this)+"]"}}),t.Context=function(r,e){this.parent=e,this.props=Object.create(null),this.protos=Object.create(null),this.prim=Object.create(null),this.origins=[],this.curOrigin="ecma5",this.paths=Object.create(null),this.definitions=Object.create(null),this.purgeGen=0,this.workList=null,this.disabledComputing=null,t.withContext(this,function(){it.protos.Object=new et(null,"Object.prototype"),it.topScope=new st,it.topScope.name="<top>",it.protos.Array=new et(!0,"Array.prototype"),it.protos.Function=new et(!0,"Function.prototype"),it.protos.RegExp=new et(!0,"RegExp.prototype"),it.protos.String=new et(!0,"String.prototype"),it.protos.Number=new et(!0,"Number.prototype"),it.protos.Boolean=new et(!0,"Boolean.prototype"),it.str=new rt(it.protos.String,"string"),it.bool=new rt(it.protos.Boolean,"bool"),it.num=new rt(it.protos.Number,"number"),it.curOrigin=null;var t=e&&e.passes;if(r)for(var n=0;n<r.length;++n)N(t,"preLoadDef",r[n]),o.load(r[n]),N(t,"postLoadDef",r[n])})};var it=null;t.cx=function(){return it},t.withContext=function(t,r){var e=it;it=t;try{return r()}finally{it=e}},t.addOrigin=function(t){it.origins.indexOf(t)<0&&it.origins.push(t)};var pt=20,at=1e-4,st=t.Scope=function(t){et.call(this,t||!0),this.prev=t};st.prototype=p(et.prototype,{defVar:function(t,r){for(var e=this;;e=e.proto){var n=e.props[t];if(n)return n;if(!e.prev)return e.defProp(t,r)}}});var ut={},ft=n.make({Function:function(t,r,e){var n=t.body.scope=new st(r);n.node=t;for(var o=[],i=[],p=0;p<t.params.length;++p){var a=t.params[p];i.push(a.name),o.push(m(n,a))}if(n.fnType=new nt(t.id&&t.id.name,new G,o,i,H),n.fnType.originNode=t,t.id){var s="FunctionDeclaration"==t.type;m(s?r:n,t.id)}e(t.body,n,"ScopeBody")},TryStatement:function(t,r,e){if(e(t.block,r,"Statement"),t.handler){var n=m(r,t.handler.param);e(t.handler.body,r,"ScopeBody");var o=it.definitions.ecma5;o&&n.isEmpty()&&$(o["Error.prototype"]).propagate(n,_)}t.finalizer&&e(t.finalizer,r,"Statement")},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;++n){var o=t.declarations[n];m(r,o.id),o.init&&e(o.init,r,"Expression")}}}),ct={ArrayExpression:x(function(t,r,e){for(var n=new G,o=0;o<t.elements.length;++o){var i=t.elements[o];i&&S(i,r,e,n)}return new ot(n)}),ObjectExpression:x(function(t,r,e,n){var o=t.objType=new et(!0,n);o.originNode=t;for(var i=0;i<t.properties.length;++i){var n,p=t.properties[i],a=p.key;if("Identifier"==a.type)n=a.name;else{if("string"!=typeof a.value){S(p.value,r,e,H);continue}n=a.value}var s=o.defProp(n,a);s.initializer=!0,S(p.value,r,e,s,n)}return o}),FunctionExpression:x(function(t,r,e,n){var o=t.body.scope,i=o.fnType;return n&&!i.name&&(i.name=n),e(t.body,r,"ScopeBody"),y(t,o)||v(o),t.id&&o.getProp(t.id.name).addType(i),i}),SequenceExpression:x(function(t,r,e){for(var n=0,o=t.expressions.length-1;n<o;++n)S(t.expressions[n],r,e,H);return S(t.expressions[o],r,e)}),UnaryExpression:x(function(t,r,e){return S(t.argument,r,e,H),b(t.operator)}),UpdateExpression:x(function(t,r,e){return S(t.argument,r,e,H),it.num}),BinaryExpression:x(function(t,r,e){if("+"==t.operator){var n=S(t.left,r,e),o=S(t.right,r,e);if(n.hasType(it.str)||o.hasType(it.str))return it.str;if(n.hasType(it.num)&&o.hasType(it.num))return it.num;var i=new G;return n.propagate(new Q(o,i)),o.propagate(new Q(n,i)),i}return S(t.left,r,e,H),S(t.right,r,e,H),T(t.operator)?it.bool:it.num}),AssignmentExpression:x(function(t,r,e){var n,o,i;if("MemberExpression"==t.left.type?(i=P(t.left,r,e),"Identifier"==t.left.object.type&&(o=t.left.object.name+"."+i)):o=t.left.name,"="!=t.operator&&"+="!=t.operator?(S(t.right,r,e,H),n=it.num):n=S(t.right,r,e,null,o),"MemberExpression"==t.left.type){var p=S(t.left.object,r,e);if("prototype"==i&&h(r,20),"<i>"==i){var a=t.left.property.name,s=r.props[a],u=s&&s.iteratesOver;if(u){h(r,20);var f="MemberExpression"==t.right.type&&t.right.computed&&t.right.property.name==a;return u.forAllProps(function(t,r,e){e&&"prototype"!=t&&"<i>"!=t&&p.propagate(new q(t,f?r:H))}),n}}p.propagate(new q(i,n,t.left.property))}else{var a=r.defVar(t.left.name,t.left);a.maybePurge&&(a.maybePurge=!1),n.propagate(a)}return n}),LogicalExpression:E(function(t,r,e,n){S(t.left,r,e,n),S(t.right,r,e,n)}),ConditionalExpression:E(function(t,r,e,n){S(t.test,r,e,H),S(t.consequent,r,e,n),S(t.alternate,r,e,n)}),NewExpression:E(function(t,r,e,n,o){"Identifier"==t.callee.type&&t.callee.name in r.props&&h(r,20);for(var i=0,p=[];i<t.arguments.length;++i)p.push(S(t.arguments[i],r,e));var a=S(t.callee,r,e),s=new G;a.propagate(new W(s,o&&/\.prototype$/.test(o))),s.propagate(n,F),a.propagate(new U(s,p,t.arguments,new X(n)))}),CallExpression:E(function(t,r,e,n){for(var o=0,i=[];o<t.arguments.length;++o)i.push(S(t.arguments[o],r,e));if("MemberExpression"==t.callee.type){var p=S(t.callee.object,r,e),a=P(t.callee,r,e);("call"==a||"apply"==a)&&r.fnType&&r.fnType.args.indexOf(p)>-1&&h(r,30),p.propagate(new z(a,i,t.arguments,n))}else{var s=S(t.callee,r,e);r.fnType&&r.fnType.args.indexOf(s)>-1&&h(r,30);var u=s.getFunctionType();u&&u.instantiateScore&&r.fnType&&h(r,u.instantiateScore/5),s.propagate(new U(it.topScope,i,t.arguments,n))}}),MemberExpression:E(function(t,r,e,n){var o=P(t,r),i=S(t.object,r,e),p=i.getProp(o);if("<i>"==o){var a=S(t.property,r,e);if(!a.hasType(it.num))return p.propagate(n,R)}p.propagate(n)}),Identifier:x(function(t,r){return"arguments"!=t.name||!r.fnType||t.name in r.props||r.defProp(t.name,r.fnType.originNode).addType(new ot(r.fnType.arguments=new G)),r.getProp(t.name)}),ThisExpression:x(function(t,r){return r.fnType?r.fnType.self:it.topScope}),Literal:x(function(t){return w(t.value)})},lt=n.make({Expression:function(t,r,e){S(t,r,e,H)},FunctionDeclaration:function(t,r,e){var n=t.body.scope,o=n.fnType;e(t.body,r,"ScopeBody"),y(t,n)||v(n);var i=r.getProp(t.id.name);i.addType(o)},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;++n){var o=t.declarations[n],i=r.getProp(o.id.name);o.init&&S(o.init,r,e,i,o.id.name)}},ReturnStatement:function(t,r,e){t.argument&&r.fnType&&(r.fnType.retval==H&&(r.fnType.retval=new G),S(t.argument,r,e,r.fnType.retval))},ForInStatement:function(t,r,e){var n=S(t.right,r,e);if("Identifier"==t.right.type&&t.right.name in r.props||"MemberExpression"==t.right.type&&"prototype"==t.right.property.name){h(r,5);var o;"Identifier"==t.left.type?o=t.left.name:"VariableDeclaration"==t.left.type&&(o=t.left.declarations[0].id.name),o&&o in r.props&&(r.getProp(o).iteratesOver=n)}e(t.body,r,"Statement")},ScopeBody:function(t,r,e){e(t,t.scope||r)}}),ht=t.parse=function(t,n){var o;try{o=r.parse(t)}catch(r){o=e.parse_dammit(t)}return N(n,"postParse",o,t),o};t.analyze=function(r,e,o,i){"string"==typeof r&&(r=ht(r)),e||(e="file#"+it.origins.length),t.addOrigin(it.curOrigin=e),o||(o=it.topScope),n.recursive(r,o,null,ft),N(i,"preInfer",r,o),n.recursive(r,o,null,lt),N(i,"postInfer",r,o),it.curOrigin=null},t.purgeTypes=function(t,r,e){var n=O(t,r,e);++it.purgeGen,it.topScope.purge(n);for(var o in it.props)for(var i=it.props[o],p=0;p<i.length;++p){var a=i[p];n(a,a.originNode)&&i.splice(p--,1)}},G.prototype.purge=function(t){if(this.purgeGen!=it.purgeGen){this.purgeGen=it.purgeGen;for(var r=0;r<this.types.length;++r){var e=this.types[r];t(e,e.originNode)?this.types.splice(r--,1):e.purge(t)}if(this.forward)for(var r=0;r<this.forward.length;++r){var n=this.forward[r];t(n)?(this.forward.splice(r--,1),this.props&&(this.props=null)):n.purge&&n.purge(t)}}},H.purge=function(){},et.prototype.purge=function(t){if(this.purgeGen==it.purgeGen)return!0;this.purgeGen=it.purgeGen;for(var r in this.props)this.props[r].purge(t)},nt.prototype.purge=function(t){if(!et.prototype.purge.call(this,t)){this.self.purge(t),this.retval.purge(t);for(var r=0;r<this.args.length;++r)this.args[r].purge(t)}},t.markVariablesDefinedBy=function(t,r,e,n){for(var o=O(r,e,n),i=t;i;i=i.prev)for(var p in i.props){var a=i.props[p];o(a,a.originNode)&&(a.maybePurge=!0,null==e&&a.originNode&&(a.originNode=null))}},t.purgeMarkedVariables=function(t){for(var r=t;r;r=r.prev)for(var e in r.props)r.props[e].maybePurge&&delete r.props[e]};var gt={ArrayExpression:function(t,r){for(var e=new G,n=0;n<t.elements.length;++n){var o=t.elements[n];o&&A(o,r).propagate(e)}return new ot(e)},ObjectExpression:function(t){return t.objType},FunctionExpression:function(t){return t.body.scope.fnType},SequenceExpression:function(t,r){return A(t.expressions[t.expressions.length-1],r)},UnaryExpression:function(t){return b(t.operator)},UpdateExpression:function(){return it.num},BinaryExpression:function(t,r){if(T(t.operator))return it.bool;if("+"==t.operator){var e=A(t.left,r),n=A(t.right,r);if(e.hasType(it.str)||n.hasType(it.str))return it.str}return it.num},AssignmentExpression:function(t,r){return A(t.right,r)},LogicalExpression:function(t,r){var e=A(t.left,r);return e.isEmpty()?A(t.right,r):e},ConditionalExpression:function(t,r){var e=A(t.consequent,r);return e.isEmpty()?A(t.alternate,r):e},NewExpression:function(t,r){var e=A(t.callee,r).getFunctionType(),n=e&&e.getProp("prototype").getType();return n?$(n,e):H},CallExpression:function(t,r){var e=A(t.callee,r).getFunctionType();if(!e)return H;if(e.computeRet){for(var n=0,o=[];n<t.arguments.length;++n)o.push(A(t.arguments[n],r));var i=H;return"MemberExpression"==t.callee.type&&(i=A(t.callee.object,r)),e.computeRet(i,o,t.arguments)}return e.retval},MemberExpression:function(t,r){var e=P(t,r),n=A(t.object,r).getType();return n?n.getProp(e):"<i>"==e?H:j(e)},Identifier:function(t,r){return r.hasProp(t.name)||H},ThisExpression:function(t,r){return r.fnType?r.fnType.self:it.topScope},Literal:function(t){return w(t.value)}},yt=t.searchVisitor=n.make({Function:function(t,r,e){var n=t.body.scope;t.id&&e(t.id,n);for(var o=0;o<t.params.length;++o)e(t.params[o],n);e(t.body,n,"ScopeBody")},TryStatement:function(t,r,e){t.handler&&e(t.handler.param,r),n.base.TryStatement(t,r,e)},VariableDeclaration:function(t,r,e){for(var n=0;n<t.declarations.length;++n){var o=t.declarations[n];e(o.id,r),o.init&&e(o.init,r,"Expression")}}});t.fullVisitor=n.make({MemberExpression:function(t,r,e){e(t.object,r,"Expression"),e(t.property,r,t.computed?"Expression":null)},ObjectExpression:function(t,r,e){for(var n=0;n<t.properties.length;++n)e(t.properties[n].value,r,"Expression"),e(t.properties[n].key,r)}},yt),t.findExpressionAt=function(t,r,e,o,i){var p=i||function(t,r){return gt.hasOwnProperty(r.type)};return n.findNodeAt(t,r,e,p,yt,o||it.topScope)},t.findExpressionAround=function(t,r,e,o,i){var p=i||function(t,e){return!(null!=r&&e.start>r)&&gt.hasOwnProperty(e.type)};return n.findNodeAround(t,e,p,yt,o||it.topScope)},t.expressionType=function(t){return A(t.node,t.state)};var dt=!1;t.resetGuessing=function(t){dt=t},t.didGuess=function(){return dt},t.forAllPropertiesOf=function(t,r){t.gatherProperties(r,0)};var vt=n.make({},yt);t.findRefs=function(t,r,e,o,i){vt.Identifier=function(t,r){if(t.name==e)for(var n=r;n;n=n.prev)if(n==o&&i(t,r),e in n.props)return},n.recursive(t,r,null,vt)};var mt=n.make({Function:function(t,r,e){e(t.body,t.body.scope,"ScopeBody")}});t.findPropRefs=function(t,r,e,o,i){n.simple(t,{MemberExpression:function(t,r){t.computed||t.property.name!=o||A(t.object,r).getType()==e&&i(t.property)},ObjectExpression:function(t,r){if(A(t,r).getType()==e)for(var n=0;n<t.properties.length;++n)t.properties[n].key.name==o&&i(t.properties[n].key)}},mt,r)};var Pt=t.scopeAt=function(t,r,e){var o=n.findNodeAround(t,r,function(t,r){return"ScopeBody"==t&&r.scope});return o?o.node.scope:e||it.topScope};t.forAllLocalsAt=function(t,r,e,n){var o=Pt(t,r,e);o.gatherProperties(n,0)},o=t.def=o.init({},t)});
//# sourceMappingURL=infer.min.js.map