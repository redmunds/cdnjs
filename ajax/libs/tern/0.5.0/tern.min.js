!function(e){return"object"==typeof exports&&"object"==typeof module?e(exports,require("./infer"),require("./signal"),require("acorn/acorn"),require("acorn/util/walk")):"function"==typeof define&&define.amd?define(["exports","./infer","./signal","acorn/acorn","acorn/util/walk"],e):void e(self.tern||(self.tern={}),tern,tern.signal,acorn,acorn.walk)}(function(e,n,t,r,i){"use strict";function s(e){this.name=e,this.scope=this.text=this.ast=this.lineOffsets=null}function o(e,t,r){e.text=t,e.ast=n.parse(t,r.passes),e.lineOffsets=null}function a(e,t,r){if(t.query&&!z.hasOwnProperty(t.query.type))return r("No query type '"+t.query.type+"' defined");var i=t.query;i||r(null,{});var s=t.files||[];s.length&&++e.uses;for(var o=0;o<s.length;++o){var a=s[o];u(e,a.name,"full"==a.type?a.text:null)}if(!i)return void c(e,function(){});var f=z[i.type];if(f.takesFile){if("string"!=typeof i.file)return r(".query.file must be a string");/^#/.test(i.file)||u(e,i.file)}c(e,function(t){if(t)return r(t);var o=f.takesFile&&m(e,s,i.file);return f.fullFile&&"part"==o.type?r("Can't run a "+i.type+" query on a file fragment"):void n.withContext(e.cx,function(){var n;try{n=f.run(e,i,o)}catch(n){return e.options.debug&&"TernError"!=n.name&&console.error(n.stack),r(n)}r(null,n)})})}function f(e,t){return n.withContext(e.cx,function(){t.scope=e.cx.topScope,e.signal("beforeLoad",t),n.markVariablesDefinedBy(t.scope,t.name),n.analyze(t.ast,t.name,t.scope,e.passes),n.purgeMarkedVariables(t.scope),e.signal("afterLoad",t)}),t}function u(e,n,t){var r=d(e.files,n);if(r)return void(t&&l(e,r,t));var i=new s(n);e.files.push(i),t?o(i,t,e):e.options.async?(e.startAsyncAction(),e.options.getFile(n,function(n,t){o(i,t||"",e),e.finishAsyncAction(n)})):o(i,e.options.getFile(n)||"",e)}function l(e,t,r){t.scope&&(n.withContext(e.cx,function(){n.purgeTypes(t.name),n.markVariablesDefinedBy(t.scope,t.name),n.purgeMarkedVariables(t.scope)}),t.scope=null),null!=r&&o(t,r,e)}function p(e,n){var t=function(){e.off("everythingFetched",t),clearTimeout(r),c(e,n)};e.on("everythingFetched",t);var r=setTimeout(t,e.options.fetchTimeout)}function c(e,n){if(e.pending)return p(e,n);var t=e.fetchError;if(t)return e.fetchError=null,n(t);for(var r=!0,i=0;i<e.files.length;++i){var s=e.files[i];null==s.text?r=!1:null==s.scope&&f(e,s)}r?n():p(e,n)}function d(e,n){for(var t=0;t<e.length;++t){var r=e[t];if(r.name==n&&"part"!=r.type)return r}}function h(e){var n=e.indexOf("\n");return n<0?e:e.slice(0,n)}function v(e,n,t){var r=Math.max(0,t-500),i=null;if(!/^\s*$/.test(e))for(;;){var s=n.indexOf(e,r);if(s<0||s>t+500)break;(null==i||Math.abs(i-t)>Math.abs(s-t))&&(i=s),r=s+e.length}return i}function y(e){for(var n=0;e;++n,e=e.prev);return n}function g(e){var n=new Error(e);return n.name="TernError",n}function m(e,t,r){var s=r.match(/^#(\d+)$/);if(!s)return d(e.files,r);var o=t[s[1]];if(!o)throw g("Reference to unknown file "+r);if("full"==o.type)return d(e.files,o.name);var a=o.backing=d(e.files,o.name),f=o.offset;o.offsetLines&&(f={line:o.offsetLines,ch:0}),o.offset=f=k(a,null==o.offsetLines?o.offset:{line:o.offsetLines,ch:0},!0);var u=h(o.text),l=v(u,a.text,f),p=null==l?Math.max(0,a.text.lastIndexOf("\n",f)):l;return n.withContext(e.cx,function(){n.purgeTypes(o.name,p,p+o.text.length);var t,r=o.text;if(t=r.match(/(?:"([^"]*)"|([\w$]+))\s*:\s*function\b/)){var s=i.findNodeAround(o.backing.ast,p,"ObjectExpression");if(s&&s.node.objType)var f={type:s.node.objType,prop:t[2]||t[1]}}if(l&&(t=u.match(/^(.*?)\bfunction\b/))){for(var c=t[1].length,d="",h=0;h<c;++h)d+=" ";r=d+r.slice(c);var v=!0}var g=n.scopeAt(a.ast,p,a.scope),m=n.scopeAt(a.ast,p+r.length,a.scope),x=o.scope=y(g)<y(m)?m:g;n.markVariablesDefinedBy(g,o.name,p,p+o.text.length),o.ast=n.parse(o.text,e.passes),n.analyze(o.ast,o.name,x,e.passes),n.purgeMarkedVariables(g);e:if(f||v){var b=n.scopeAt(o.ast,u.length,g);if(!b.fnType)break e;if(f){var w=f.type.getProp(f.prop);w.addType(b.fnType)}else if(v){var k=n.scopeAt(a.ast,p+u.length,a.scope);if(k==g||!k.fnType)break e;var A=k.fnType,T=b.fnType;if(!T||T.name!=A.name&&A.name)break e;for(var h=0,F=Math.min(A.args.length,T.args.length);h<F;++h)A.args[h].propagate(T.args[h]);A.self.propagate(T.self),T.retval.propagate(A.retval)}}}),o}function x(e){return"number"==typeof e||"object"==typeof e&&"number"==typeof e.line&&"number"==typeof e.ch}function b(e){if(e.query){if("string"!=typeof e.query.type)return".query.type must be a string";if(e.query.start&&!x(e.query.start))return".query.start must be a position";if(e.query.end&&!x(e.query.end))return".query.end must be a position"}if(e.files){if(!Array.isArray(e.files))return"Files property must be an array";for(var n=0;n<e.files.length;++n){var t=e.files[n];if("object"!=typeof t)return".files[n] must be objects";if("string"!=typeof t.text)return".files[n].text must be a string";if("string"!=typeof t.name)return".files[n].name must be a string";if("part"==t.type){if(!x(t.offset)&&"number"!=typeof t.offsetLines)return".files[n].offset must be a position"}else if("full"!=t.type)return'.files[n].type must be "full" or "part"'}}}function w(e,n){for(var t=e.text,r=e.lineOffsets||(e.lineOffsets=[0]),i=0,s=0,o=Math.min(Math.floor(n/Z),r.length-1),i=r[o],s=o*Z;s<n;){if(++s,i=t.indexOf("\n",i)+1,0==i)return null;s%Z==0&&r.push(i)}return i}function k(e,n,t){if("number"!=typeof n){var r=w(e,n.line);if(null==r){if(!t)throw g("File doesn't contain a line "+n.line);n=e.text.length}else n=r+n.ch}if(n>e.text.length){if(!t)throw g("Position "+n+" is outside of file.");n=e.text.length}return n}function A(e,n){if(!e)return{line:0,ch:0};for(var t,r,i=e.lineOffsets||(e.lineOffsets=[0]),s=e.text,o=i.length-1;o>=0;--o)i[o]<=n&&(t=o*Z,r=i[o]);for(;;){var a=s.indexOf("\n",r);if(a>=n||a<0)break;r=a+1,++t}return{line:t,ch:n-r}}function T(e,n,t){if(e.lineCharPositions){var r=A(n,t);return"part"==n.type&&(r.line+=null!=n.offsetLines?n.offsetLines:A(n.backing,n.offset).line),r}return t+("part"==n.type?n.offset:0)}function F(e){for(var n in e)null==e[n]&&delete e[n];return e}function O(e,n,t){null!=t&&(e[n]=t)}function q(e,n){"string"!=typeof e&&(e=e.name,n=n.name);var t=/^[A-Z]/.test(e),r=/^[A-Z]/.test(n);return t==r?e<n?-1:e==n?0:1:t?1:-1}function C(e,n,t){return"Literal"==e.type&&"string"==typeof e.value&&e.start==n-1&&e.end<=t+1}function N(e,t,i){function s(r,i,s){if((t.omitObjectPrototype===!1||i!=e.cx.protos.Object||u)&&(t.filter===!1||!u||0==(t.caseInsensitive?r.toLowerCase():r).indexOf(u))){for(var o=0;o<l.length;++o){var a=l[o];if((p?a.name:a)==r)return}var f=p?{name:r}:r;if(l.push(f),t.types||t.docs||t.urls||t.origins){var c=i?i.props[r]:n.ANull;n.resetGuessing();var d=c.getType();f.guess=n.didGuess(),t.types&&(f.type=n.toString(d)),t.docs&&O(f,"doc",c.doc||d&&d.doc),t.urls&&O(f,"url",c.url||d&&d.url),t.origins&&O(f,"origin",c.origin||d&&d.origin)}t.depths&&(f.depth=s)}}if(null==t.end)throw g("missing .query.end field");for(var o=k(i,t.end),a=o,f=i.text;o&&r.isIdentifierChar(f.charCodeAt(o-1));)--o;if(t.expandWordForward!==!1)for(;a<f.length&&r.isIdentifierChar(f.charCodeAt(a));)++a;var u=f.slice(o,a),l=[];t.caseInsensitive&&(u=u.toLowerCase());var p=t.types||t.depths||t.docs||t.urls||t.origins,c=n.findExpressionAround(i.ast,null,o,i.scope,"MemberExpression");if(c&&(c.node.computed?C(c.node.property,o,a):c.node.object.end<o)){var d=c.node.property;d="Literal"==d.type?d.value.slice(1):d.name,c.node=c.node.object;var h=n.expressionType(c);if(h&&n.forAllPropertiesOf(h,s),!l.length&&t.guess!==!1&&h&&h.guessProperties&&h.guessProperties(function(e,n,t){e!=d&&"âœ–"!=e&&s(e,n,t)}),!l.length&&u.length>=2&&t.guess!==!1)for(var d in e.cx.props)s(d,e.cx.props[d][0],0)}else n.forAllLocalsAt(i.ast,o,i.scope,s);return t.sort!==!1&&l.sort(q),{start:T(t,i,o),end:T(t,i,a),completions:l}}function j(e,n){var t=n.prefix,r=[];for(var i in e.cx.props)"<i>"==i||t&&0!=i.indexOf(t)||r.push(i);return n.sort!==!1&&r.sort(q),{completions:r}}function E(e,t,r){var i=W(r,t);n.resetGuessing();var s=n.expressionType(i);if(s=t.preferFunction?s.getFunctionType()||s.getType():s.getType(),"Identifier"==i.node.type)var o=i.node.name;else if("MemberExpression"==i.node.type&&!i.node.computed)var o=i.node.property.name;if(null!=t.depth&&"number"!=typeof t.depth)throw g(".query.depth must be a number");var a={guess:n.didGuess(),type:n.toString(s,t.depth),name:s&&s.name,exprName:o};return s&&M(s,a),F(a)}function P(e,t,r){var i=W(r,t),s=n.expressionType(i),o={url:s.url,doc:s.doc},a=s.getType();return a&&M(a,o),F(o)}function L(e,t){var r=i.findNodeAt(t,e.start,e.end,e.type,n.fullVisitor);return r&&r.node==e}function M(e,t){t.url||(t.url=e.url),t.doc||(t.doc=e.doc),t.origin||(t.origin=e.origin);var r,i=n.cx().protos;!t.url&&!t.doc&&e.proto&&(r=e.proto.hasCtor)&&e.proto!=i.Object&&e.proto!=i.Function&&e.proto!=i.Array&&(t.url=r.url,t.doc=r.doc)}function I(e,t,r){var i=W(r,t);n.resetGuessing();var s=n.expressionType(i);if(n.didGuess())return{};var o=H(s),a={url:s.url,doc:s.doc,origin:s.origin};if(s.types)for(var f=s.types.length-1;f>=0;--f){var u=s.types[f];M(u,a),o||(o=H(u))}if(o&&o.node){var l=d(e.files,o.origin);"part"==r.type&&r.name==o.origin&&o.node&&L(o.node,r.ast)&&(l=r);var p=T(t,l,o.node.start),c=T(t,l,o.node.end);a.start=p,a.end=c,a.file=o.origin;var h=Math.max(0,o.node.start-50);a.contextOffset=o.node.start-h,a.context=l.text.slice(h,h+50)}else o&&(a.file=o.origin,J(e,t,o,a));return F(a)}function R(e,t,r,i,s){function o(e){return function(n,r){if(s)for(var i=r;i!=f;i=i.prev){var o=i.hasProp(s);if(o)throw g("Renaming `"+a+"` to `"+s+"` would make a variable at line "+(A(e,n.start).line+1)+" point to the definition at line "+(A(e,o.name.start).line+1))}l.push({file:e.name,start:T(t,e,n.start),end:T(t,e,n.end)})}}for(var a=i.node.name,f=i.state;f&&!(a in f.props);f=f.prev);if(!f)throw g("Could not find a definition for "+a+" "+!!e.cx.topScope.props.x);var u,l=[];if(f.node){if(u="local",s){for(var p=f.prev;p&&!(s in p.props);p=p.prev);p&&n.findRefs(f.node,f,s,p,function(e){throw g("Renaming `"+a+"` to `"+s+"` would shadow the definition used at line "+(A(r,e.start).line+1))})}n.findRefs(f.node,f,a,f,o(r))}else{u="global";for(var c=0;c<e.files.length;++c){var d=e.files[c];n.findRefs(d.ast,d.scope,a,f,o(d))}}return{refs:l,type:u,name:a}}function S(e,t,r,i){function s(e){return function(n){a.push({file:e.name,start:T(t,e,n.start),end:T(t,e,n.end)})}}var o=n.expressionType(r).getType();if(!o)throw g("Couldn't determine type of base object.");for(var a=[],f=0;f<e.files.length;++f){var u=e.files[f];n.findPropRefs(u.ast,u.scope,o,i.name,s(u))}return{refs:a,name:i.name}}function V(e,n,t){var r=W(t,n,!0);if(r&&"Identifier"==r.node.type)return R(e,n,t,r);if(r&&"MemberExpression"==r.node.type&&!r.node.computed){var i=r.node.property;return r.node=r.node.object,S(e,n,r,i)}if(r&&"ObjectExpression"==r.node.type)for(var s=k(t,n.end),o=0;o<r.node.properties.length;++o){var a=r.node.properties[o].key;if(a.start<=s&&a.end>=s)return S(e,n,r,a)}throw g("Not at a variable or property name.")}function G(e,n,t){if("string"!=typeof n.newName)throw g(".query.newName should be a string");var r=W(t,n);if(!r||"Identifier"!=r.node.type)throw g("Not at a variable.");var i=R(e,n,t,r,n.newName),s=i.refs;delete i.refs,i.files=e.files.map(function(e){return e.name});for(var o=i.changes=[],a=0;a<s.length;++a){var f=s[a];f.text=n.newName,o.push(f)}return i}function $(e){return{files:e.files.map(function(e){return e.name})}}var B=Object.create(null);e.registerPlugin=function(e,n){B[e]=n};var D={debug:!1,async:!1,getFile:function(e,n){this.async&&n(null,null)},defs:[],plugins:{},fetchTimeout:1e3},z={completions:{takesFile:!0,run:N},properties:{run:j},type:{takesFile:!0,run:E},documentation:{takesFile:!0,run:P},definition:{takesFile:!0,run:I},refs:{takesFile:!0,fullFile:!0,run:V},rename:{takesFile:!0,fullFile:!0,run:G},files:{run:$}};e.defineQueryType=function(e,n){z[e]=n},s.prototype.asLineChar=function(e){return A(this,e)};var Q=e.Server=function(e){this.cx=null,this.options=e||{};for(var n in D)e.hasOwnProperty(n)||(e[n]=D[n]);this.handlers=Object.create(null),this.files=[],this.uses=0,this.pending=0,this.asyncError=null,this.passes=Object.create(null),this.defs=e.defs.slice(0);for(var t in e.plugins)if(e.plugins.hasOwnProperty(t)&&t in B){var r=B[t](this,e.plugins[t]);if(r&&r.defs&&this.defs.push(r.defs),r&&r.passes)for(var i in r.passes)r.passes.hasOwnProperty(i)&&(this.passes[i]||(this.passes[i]=[])).push(r.passes[i])}this.reset()};Q.prototype=t.mixin({addFile:function(e,n){u(this,e,n)},delFile:function(e){for(var n,t=0;t<this.files.length;++t)if((n=this.files[t]).name==e)return l(this,n),void this.files.splice(t--,1)},reset:function(){this.signal("reset"),this.cx=new n.Context(this.defs,this),this.uses=0;for(var e=0;e<this.files.length;++e){var t=this.files[e];t.scope=null}},request:function(e,n){var t=b(e);if(t)return n(t);var r=this;a(this,e,function(e,t){n(e,t),r.uses>40&&(r.reset(),c(r,function(){}))})},findFile:function(e){return d(this.files,e)},flush:function(e){var t=this.cx;c(this,function(r){return r?e(r):void n.withContext(t,e)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(e){e&&(this.asyncError=e),0==--this.pending&&this.signal("everythingFetched")}});var Z=25,W=e.findQueryExpr=function(e,t,r){if(null==t.end)throw g("missing .query.end field");if(t.variable){var i=n.scopeAt(e.ast,k(e,t.end),e.scope);return{node:{type:"Identifier",name:t.variable,start:t.end,end:t.end+1},state:i}}var s=t.start&&k(e,t.start),o=k(e,t.end),a=n.findExpressionAt(e.ast,s,o,e.scope);if(a)return a;if(a=n.findExpressionAround(e.ast,s,o,e.scope),a&&(r||(null==s?o:s)-a.node.start<20||a.node.end-o<20))return a;throw g("No expression at the given position.")},H=e.getSpan=function(e){if(e.origin){if(e.originNode){var n=e.originNode;return/^Function/.test(n.type)&&n.id&&(n=n.id),{origin:e.origin,node:n}}return e.span?{origin:e.origin,span:e.span}:void 0}},J=e.storeSpan=function(e,n,t,r){if(r.origin=t.origin,t.span){var i=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(t.span);r.start=n.lineCharPositions?{line:Number(i[2]),ch:Number(i[3])}:Number(i[1]),r.end=n.lineCharPositions?{line:Number(i[5]),ch:Number(i[6])}:Number(i[4])}else{var s=d(e.files,t.origin);r.start=T(n,s,t.node.start),r.end=T(n,s,t.node.end)}};e.version="0.5.0"});
//# sourceMappingURL=tern.min.js.map