!function(e){return"object"==typeof exports&&"object"==typeof module?exports.init=e:"function"==typeof define&&define.amd?define({init:e}):void(tern.def={init:e})}(function(e,t){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function n(e,r,n,i){var s=new f(e,null,n,i).parseType(r,!0);if(/^fn\(/.test(e))for(var o=0;o<s.args.length;++o)(function(e){var r=s.args[e];r instanceof t.Fn&&r.args&&r.args.length&&a(s,function(n,a){var i=a[e];i&&i.propagate(new t.IsCallee(t.cx().topScope,r.args,null,t.ANull))})})(o);return s}function a(e,t,r){var n=e.computeRet,a=e.retval;e.computeRet=function(e,i,s){var o=t(e,i,s),p=n?n(e,i,s):a;return r?o:p}}function i(e){var t=Object.create(e.prototype);return t.props=Object.create(null),t.isShell=!0,t}function s(e){if(!e["!type"])return!1;for(var t in e)if("!type"!=t&&"!doc"!=t&&"!url"!=t&&"!span"!=t&&"!data"!=t)return!1;return!0}function o(e,n,a){if(!e){var p=n["!type"];if(p)if(/^fn\(/.test(p))e=i(t.Fn);else{if("["!=p.charAt(0))throw new Error("Invalid !type spec: "+p);e=i(t.Arr)}else e=n["!stdProto"]?t.cx().protos[n["!stdProto"]]:i(t.Obj);e.name=a}for(var l in n)if(r(n,l)&&33!=l.charCodeAt(0)){var f=n[l];if("string"==typeof f||s(f))continue;var c=e.defProp(l);o(c.getType(),f,a?a+"."+l:l).propagate(c)}return e}function p(e,a,i){if(e.isShell){delete e.isShell;var o=a["!type"];if(o)n(o,i,e);else{var l=a["!proto"]&&n(a["!proto"]);t.Obj.call(e,!(l instanceof t.Obj)||l,i)}}var f=a["!effects"];if(f&&e instanceof t.Fn)for(var c=0;c<f.length;++c)u(f[c],e);for(var h in a)if(r(a,h)&&33!=h.charCodeAt(0)){var v=a[h],g=e.defProp(h),y=i?i+"."+h:h,d=g.getType();if("string"==typeof v){if(d)continue;n(v,y).propagate(g)}else{if(s(v)){if(d)continue;n(v["!type"],y,null,!0).propagate(g),d=g.getType()}else p(d,v,y);var w=v["!doc"],b=v["!url"],A=v["!span"];w&&(d&&d instanceof t.Obj&&(d.doc=w),g.doc=w),b&&(d&&d instanceof t.Obj&&(d.url=b),g.url=b),A&&(d&&d instanceof t.Obj&&(d.span=A),g.span=A),v["!data"]&&d instanceof t.Obj&&(d.metaData=v["!data"])}}}function l(e,r){var n=t.cx();t.addOrigin(n.curOrigin=e["!name"]||"env#"+n.origins.length),n.loading=e,n.localDefs=n.definitions[n.curOrigin]=Object.create(null),o(r,e);var a=e["!define"];if(a){for(var i in a){var s=a[i];n.localDefs[i]="string"==typeof s?h(s):o(null,s,i)}for(var i in a){var s=a[i];"string"!=typeof s&&p(n.localDefs[i],a[i],i)}}p(r,e),n.curOrigin=n.loading=n.localDefs=null}var f=e.TypeParser=function(e,t,r,n){this.pos=t||0,this.spec=e,this.base=r,this.forceNew=n};f.prototype={eat:function(e){if(1==e.length?this.spec.charAt(this.pos)==e:this.spec.indexOf(e,this.pos)==this.pos)return this.pos+=e.length,!0},word:function(e){for(var t,r="",e=e||/[\w$]/;(t=this.spec.charAt(this.pos))&&e.test(t);)r+=t,++this.pos;return r},error:function(){throw new Error("Unrecognized type spec: "+this.spec+" (at "+this.pos+")")},parseFnType:function(e,r){var n=[],a=[];if(!this.eat(")"))for(var i=0;;++i){var s,o=this.spec.indexOf(": ",this.pos);if(o!=-1&&(s=this.spec.slice(this.pos,o),/^[$\w?]+$/.test(s)?this.pos=o+2:s=null),a.push(s),n.push(this.parseType()),!this.eat(", ")){this.eat(")")||this.error();break}}var p,l,f;return this.eat(" -> ")?r&&this.spec.indexOf("!",this.pos)>-1?(p=t.ANull,l=this.parseRetType()):p=this.parseType():p=t.ANull,r&&(f=this.base)?t.Fn.call(this.base,e,t.ANull,n,a,p):f=new t.Fn(e,t.ANull,n,a,p),l&&(f.computeRet=l),f},parseType:function(e,r){if(this.eat("fn("))return this.parseFnType(e,r);if(this.eat("[")){var n=this.parseType();return this.eat("]")||this.error(),r&&this.base?(t.Arr.call(this.base,n),this.base):new t.Arr(n)}if(this.eat("+")){var a=this.word(/[\w$<>\.!]/),i=h(a+".prototype");return i instanceof t.Obj||(i=h(a)),i instanceof t.Obj?r&&this.forceNew?new t.Obj(i):t.getInstance(i):i}if(this.eat("?"))return t.ANull;var s=this.word(/[\w$<>\.!]/),o=t.cx();switch(s){case"number":return o.num;case"string":return o.str;case"bool":return o.bool;case"<top>":return o.topScope}return o.localDefs&&s in o.localDefs?o.localDefs[s]:h(s)},parseBaseRetType:function(){if(this.eat("[")){var e=this.parseRetType();return this.eat("]")||this.error(),function(r,n){return new t.Arr(e(r,n))}}if(this.eat("+")){var r=this.parseRetType();return function(e,n){return t.getInstance(r(e,n))}}if(this.eat("!")){var n=this.word(/\d/);if(n)return n=Number(n),function(e,r){return r[n]||t.ANull};if(this.eat("this"))return function(e){return e};if(this.eat("custom:")){var a=this.word(/[\w$]/);return v[a]||function(){return t.ANull}}this.error()}var i=this.parseType();return function(){return i}},extendRetType:function(e){var r=this.word(/[\w<>$!]/)||this.error();return"!ret"==r?function(r,n){var a=e(r,n);if(a.retval)return a.retval;var i=new t.AVal;return a.propagate(new t.IsCallee(t.ANull,[],null,i)),i}:function(t,n){return e(t,n).getProp(r)}},parseRetType:function(){for(var e=this.parseBaseRetType();this.eat(".");)e=this.extendRetType(e);return e}};var c,u=e.parseEffect=function(e,r){var n;if(0==e.indexOf("propagate ")){var i=new f(e,10),s=i.parseRetType();i.eat(" ")||i.error();var o=i.parseRetType();a(r,function(e,t){s(e,t).propagate(o(e,t))})}else if(0==e.indexOf("call ")){var p=5==e.indexOf("and return ",5),i=new f(e,p?16:5),l=i.parseRetType(),c=null,u=[];for(i.eat(" this=")&&(c=i.parseRetType());i.eat(" ");)u.push(i.parseRetType());a(r,function(e,r){for(var n=l(e,r),a=c?c(e,r):t.ANull,i=[],s=0;s<u.length;++s)i.push(u[s](e,r));var o=p?new t.AVal:t.ANull;return n.propagate(new t.IsCallee(a,i,null,o)),o},p)}else if(n=e.match(/^custom (\S+)\s*(.*)/)){var h=v[n[1]];h&&a(r,n[2]?h(n[2]):h)}else{if(0!=e.indexOf("copy "))throw new Error("Unknown effect type: "+e);var i=new f(e,5),g=i.parseRetType();i.eat(" ");var y=i.parseRetType();a(r,function(e,r){var n=g(e,r),a=y(e,r);n.forAllProps(function(e,r,n){n&&"<i>"!=e&&a.propagate(new t.PropHasSubset(e,r))})})}},h=e.parsePath=function(e){var r=t.cx(),n=r.paths[e],a=e;if(null!=n)return n;r.paths[e]=t.ANull;var i=c||r.topScope;if(r.localDefs)for(var s in r.localDefs)if(0==e.indexOf(s)){if(e==s)return r.paths[e]=r.localDefs[e];if("."==e.charAt(s.length)){i=r.localDefs[s],e=e.slice(s.length+1);break}}for(var o=e.split("."),p=0;p<o.length&&i!=t.ANull;++p){var l=o[p];if("!"==l.charAt(0))if("!proto"==l)i=i instanceof t.Obj&&i.proto||t.ANull;else{var f=i.getFunctionType();if(f)if("!ret"==l)i=f.retval&&f.retval.getType()||t.ANull;else{var u=f.args&&f.args[Number(l.slice(1))];i=u&&u.getType()||t.ANull}else i=t.ANull}else if(i instanceof t.Obj){var h=i.props[l];i=!h||h.isEmpty()?t.ANull:h.types[0]}}return r.paths[a]=i==t.ANull?null:i,i};e.load=function(e,r){r||(r=t.cx().topScope);var n=c;c=r;try{l(e,r)}finally{c=n}};var v=Object.create(null);t.registerFunction=function(e,t){v[e]=t};var g=t.constraint("created, target, spec",{addType:function(e){if(e instanceof t.Obj&&this.created++<5){var r=new t.Obj(e),n=this.spec;if(n instanceof t.AVal&&(n=n.getType()),n instanceof t.Obj)for(var a in n.props){var i=n.props[a].types[0],s=r.defProp(a);if(i&&i instanceof t.Obj&&i.props.value){var o=i.props.value.getType();o&&s.addType(o)}}this.target.addType(r)}}});t.registerFunction("Object_create",function(e,r,n){if(n&&n.length&&"Literal"==n[0].type&&null==n[0].value)return new t.Obj;var a=new t.AVal;return r[0]&&r[0].propagate(new g(0,a,r[1])),a});var y=t.constraint("self, args, target",{addType:function(e){if(e instanceof t.Fn){this.target.addType(new t.Fn(e.name,e.self,e.args.slice(this.args.length),e.argNames.slice(this.args.length),e.retval)),this.self.propagate(e.self);for(var r=0;r<Math.min(e.args.length,this.args.length);++r)this.args[r].propagate(e.args[r])}}});return t.registerFunction("Function_bind",function(e,r){if(!r.length)return t.ANull;var n=new t.AVal;return e.propagate(new y(r[0],r.slice(1),n)),n}),t.registerFunction("Array_ctor",function(e,r){var n=new t.Arr;if(1!=r.length||!r[0].hasType(t.cx().num))for(var a=n.getProp("<i>"),i=0;i<r.length;++i)r[i].propagate(a);return n}),e});
//# sourceMappingURL=def.min.js.map