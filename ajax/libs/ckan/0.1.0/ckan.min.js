var CKAN={},isNodeModule="undefined"!=typeof module&&null!=module&&"undefined"!=typeof require;if(isNodeModule){var _=require("underscore"),request=require("request");module.exports=CKAN}!function(e){e.DataStore=function(e,r){this.endpoint=t(e),this.apiKey=r},e.DataStore.prototype.search=function(e,t){var r=this.endpoint+"/3/action/datastore_search",a={url:r,type:"POST",data:JSON.stringify(e)};this._ajax(a,t)},e.DataStore.prototype.query=function(t,r){var a=e._normalizeQuery(t,dataset);this.search(a,function(e,t){var a={total:t.result.total,hits:t.result.records};r(null,a)})},e.DataStore.prototype.upsert=function(e,t){var r=this.endpoint+"/api/3/datastore_upsert";return this._ajax({url:r,type:"POST",data:JSON.stringify(e)},t)},e.DataStore.prototype.listResources=function(e){var t=this.endpoint+"/3/action/datastore_search?resource_id=_table_metadata";return this._ajax({url:t},e)},e.Catalog=function(e,r){this.endpoint=t(e),this.apiKey=r},e.Catalog.prototype.action=function(e,t,r){"dataset_create"===e&&(e="package_create");var a={url:this.endpoint+"/3/action/"+e,data:t,type:"POST"};return this._ajax(a,r)};var t=function(e){return e=e||"/",e=e.replace(/\/$/,""),e.match(/\/api$/)||(e+="/api"),e};e.Catalog.prototype._ajax=function(e,t){e.headers=e.headers||{},this.apiKey&&(e.headers["X-CKAN-API-KEY"]=this.apiKey);var n=isNodeModule?r:a;return n(e,t)},e.DataStore.prototype._ajax=function(e,t){e.headers=e.headers||{},this.apiKey&&(e.headers["X-CKAN-API-KEY"]=this.apiKey);var n=isNodeModule?r:a;return n(e,t)};var r=function(e,t){var r={url:e.url,headers:e.headers||{},method:e.type||"GET",json:e.data};request(r,function(e,r,a){t(e,a)})},a=function(e,t){return e.data=JSON.stringify(e.data),e.success=function(e){t(null,e)},e.error=function(e,r,a){var n={code:e.status,message:e.responseText};t(n)},e.headers&&(e.beforeSend=function(t){for(key in e.headers)t.setRequestHeader(key,e.headers[key])}),jQuery.ajax(e)};e._normalizeQuery=function(e,t){var r={resource_id:t.id,q:e.q,filters:{},limit:e.size||10,offset:e.from||0};if(e.sort&&e.sort.length>0){var a=_.map(e.sort,function(e){return e.field+" "+(e.order||"")});r.sort=a.join(",")}return e.filters&&e.filters.length>0&&_.each(e.filters,function(e){"term"===e.type&&(r.filters[e.field]=e.term)}),r},e._parseCkanResourceUrl=function(e){parts=e.split("/");var t=parts.length;return{resource_id:parts[t-1],endpoint:parts.slice(0,[t-4]).join("/")+"/api"}}}(CKAN);var recline=recline||{};recline.Backend=recline.Backend||{},recline.Backend.Ckan=recline.Backend.Ckan||{},function(e){e.__type__="ckan";var t=_.isUndefined(this.jQuery)?_.Deferred:jQuery.Deferred;e.fetch=function(r){var a;if(r.endpoint)a=new e.DataStore(r.endpoint);else{var n=CKAN._parseCkanResourceUrl(r.url);r.id=n.resource_id,a=new CKAN.DataStore(n.endpoint)}new t;return e.query({resource_id:r.id,limit:0},r)},e.query=function(e,a){var n,i=new t;if(a.endpoint)n=new CKAN.DataStore(a.endpoint);else{var o=CKAN._parseCkanResourceUrl(a.url);a.id=o.resource_id,n=new CKAN.DataStore(o.endpoint)}return n.search(e,function(e,t){var a=_.map(t.result.fields,function(e){return e.type=e.type in r?r[e.type]:e.type,e}),n={fields:a,useMemoryStore:!1};i.resolve(n)}),i.promise()};var r={int4:"integer",int8:"integer",float8:"float"}}(recline.Backend.Ckan);
//# sourceMappingURL=ckan.min.js.map