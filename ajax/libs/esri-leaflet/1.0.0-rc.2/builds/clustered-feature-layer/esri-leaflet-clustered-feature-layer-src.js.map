{"version":3,"sources":["../../../src/Layers/ClusteredFeatureLayer/ClusteredFeatureLayer.js"],"names":[],"mappings":"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","file":"esri-leaflet-clustered-feature-layer-src.js","sourcesContent":["L.esri.Layers.ClusteredFeatureLayer = L.esri.Layers.FeatureManager.extend({\n\n  statics: {\n    EVENTS: 'click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose',\n    CLUSTEREVENTS: 'clusterclick clusterdblclick clustermouseover clustermouseout clustermousemove clustercontextmenu'\n  },\n\n  /**\n   * Constructor\n   */\n\n  initialize: function (url, options) {\n    L.esri.Layers.FeatureManager.prototype.initialize.call(this, url, options);\n\n    options = L.setOptions(this, options);\n\n    this._layers = {};\n    this._leafletIds = {};\n\n    this.cluster = new window.L.MarkerClusterGroup(options);\n    this._key = 'c'+(Math.random() * 1e9).toString(36).replace('.', '_');\n\n    // @TODO enable at Leaflet 0.8\n    // this.cluster.addEventParent(this);\n\n    // @TODO remove from Leaflet 0.8\n    this.cluster.on(L.esri.ClusteredFeatureLayer.EVENTS, this._propagateEvent, this);\n    this.cluster.on(L.esri.ClusteredFeatureLayer.CLUSTEREVENTS, this._propagateClusterEvent, this);\n  },\n\n  /**\n   * Layer Interface\n   */\n\n  onAdd: function(map){\n    L.esri.Layers.FeatureManager.prototype.onAdd.call(this, map);\n    this._map.addLayer(this.cluster);\n  },\n\n  onRemove: function(map){\n    L.esri.Layers.FeatureManager.prototype.onRemove.call(this, map);\n    this._map.removeLayer(this.cluster);\n  },\n\n  /**\n   * Feature Managment Methods\n   */\n\n  createLayers: function(features){\n    var markers = [];\n\n    for (var i = features.length - 1; i >= 0; i--) {\n      var geojson = features[i];\n      var layer = this._layers[geojson.id];\n\n      if(!layer){\n        // @TODO Leaflet 0.8\n        //newLayer = L.GeoJSON.geometryToLayer(geojson, this.options);\n\n        var newLayer = L.GeoJSON.geometryToLayer(geojson, this.options.pointToLayer, L.GeoJSON.coordsToLatLng, this.options);\n        newLayer.feature = L.GeoJSON.asFeature(geojson);\n        newLayer.defaultOptions = newLayer.options;\n        newLayer._leaflet_id = this._key + '_' + geojson.id;\n\n        this.resetStyle(newLayer.feature.id);\n\n        // bind a popup if we have one\n        if(this._popup && newLayer.bindPopup){\n          newLayer.bindPopup(this._popup(newLayer.feature, newLayer));\n        }\n\n        // cache the layer\n        this._layers[newLayer.feature.id] = newLayer;\n\n        this._leafletIds[newLayer._leaflet_id] = geojson.id;\n\n        if(this.options.onEachFeature){\n          this.options.onEachFeature(newLayer.feature, newLayer);\n        }\n\n        this.fire('createfeature', {\n          feature: newLayer.feature\n        });\n\n        // add the layer if it is within the time bounds or our layer is not time enabled\n        if(!this.options.timeField || (this.options.timeField && this._featureWithinTimeRange(geojson)) ){\n          markers.push(newLayer);\n        }\n      }\n    }\n\n    if(markers.length){\n      this.cluster.addLayers(markers);\n    }\n  },\n\n  addLayers: function(ids){\n    var layersToAdd = [];\n    for (var i = ids.length - 1; i >= 0; i--) {\n      var layer = this._layers[ids[i]];\n      this.fire('addfeature', {\n        feature: layer.feature\n      });\n      layersToAdd.push(layer);\n    }\n    this.cluster.addLayers(layersToAdd);\n  },\n\n  removeLayers: function(ids, permanent){\n    var layersToRemove = [];\n    for (var i = ids.length - 1; i >= 0; i--) {\n      var id = ids[i];\n      var layer = this._layers[id];\n      this.fire('removefeature', {\n        feature: layer.feature,\n        permanent: permanent\n      });\n      layersToRemove.push(layer);\n      if(this._layers[id] && permanent){\n        delete this._layers[id];\n      }\n    }\n    this.cluster.removeLayers(layersToRemove);\n  },\n\n  /**\n   * Styling Methods\n   */\n\n  resetStyle: function (id) {\n    var layer = this._layers[id];\n\n    if(layer){\n      layer.options = layer.defaultOptions;\n      this.setFeatureStyle(layer.feature.id, this.options.style);\n    }\n\n    return this;\n  },\n\n  setStyle: function (style) {\n    this.eachFeature(function (layer) {\n      this.setFeatureStyle(layer.feature.id, style);\n    }, this);\n    return this;\n  },\n\n  setFeatureStyle: function (id, style) {\n    var layer = this._layers[id];\n\n    if (typeof style === 'function') {\n      style = style(layer.feature);\n    }\n    if (layer.setStyle) {\n      layer.setStyle(style);\n    }\n  },\n\n  /**\n   * Popup Methods\n   */\n\n  bindPopup: function (fn, options) {\n    this._popup = fn;\n    for (var i in this._layers) {\n      var layer = this._layers[i];\n      var popupContent = this._popup(layer.feature, layer);\n      layer.bindPopup(popupContent, options);\n    }\n  },\n\n  unbindPopup: function () {\n    this._popup =  false;\n    for (var i in this._layers) {\n      this._layers[i].unbindPopup();\n    }\n  },\n\n  /**\n   * Utility Methods\n   */\n\n  eachFeature: function (fn, context) {\n    for (var i in this._layers) {\n      fn.call(context, this._layers[i]);\n    }\n    return this;\n  },\n\n  getFeature: function (id) {\n    return this._layers[id];\n  },\n\n  // from https://github.com/Leaflet/Leaflet/blob/v0.7.2/src/layer/FeatureGroup.js\n  //  @TODO remove at Leaflet 0.8\n  _propagateEvent: function (e) {\n    e = L.extend({\n      layer: this._layers[this._leafletIds[e.target._leaflet_id]],\n      target: this\n    }, e);\n    this.fire(e.type, e);\n  },\n\n  _propagateClusterEvent: function (e) {\n    e = L.extend({\n      layer: e.target,\n      target: this\n    }, e);\n    this.fire(e.type, e);\n  }\n\n\n});\n\nL.esri.ClusteredFeatureLayer = L.esri.Layers.ClusteredFeatureLayer;\n\nL.esri.Layers.clusteredFeatureLayer = function(url, options){\n  return new L.esri.Layers.ClusteredFeatureLayer(url, options);\n};\n\nL.esri.clusteredFeatureLayer = function(url, options){\n  return new L.esri.Layers.ClusteredFeatureLayer(url, options);\n};\n"]}