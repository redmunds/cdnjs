(function($){"use strict";$.sceditor.XHTMLSerializer=function(){var escapeEntites,trim,serializeNode,handleDoc,handleElement,handleCdata,handleComment,handleText,indent,canIndent,newline,base=this,opts={indentStr:"	"},outputStringBuilder=[],currentIndent=0;escapeEntites=function(str){var entites={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};return str?str.replace(/[&<>"]/g,function(entity){return entites[entity]||entity}):""},trim=function(str){return str.replace(/[\r\n]/,"").replace(/[^\S|\u00A0]+/g," ")},base.serialize=function(node,onlyChildren){if(outputStringBuilder=[],onlyChildren)for(node=node.firstChild;node;)serializeNode(node),node=node.nextSibling;else serializeNode(node);return outputStringBuilder.join("")},serializeNode=function(node){switch(node.nodeType){case 1:var tagName=node.nodeName.toLowerCase();"!"===tagName&&handleComment(node),handleElement(node);break;case 3:handleText(node);break;case 4:handleCdata(node);break;case 8:handleComment(node);break;case 9:case 11:handleDoc(node);break;case 2:case 5:case 6:case 7:case 10:case 12:}},handleDoc=function(node){var child;for(child=node.firstChild;child;)serializeNode(child),child=child.nextSibling},handleElement=function(node){var child,attr,tagName=node.nodeName.toLowerCase(),i=node.attributes.length,selfClosing=!node.firstChild&&/^(?:area|base|br|col|embed|hr|img|input|link|meta|param)$/.test(tagName);for(canIndent(node)&&indent(),outputStringBuilder.push("<"+tagName);i--;)attr=node.attributes[i],outputStringBuilder.push(" ",attr.name.toLowerCase(),'="',escapeEntites(attr.value),'"');for(outputStringBuilder.push(selfClosing?" />":">"),currentIndent++,child=node.firstChild;child;)serializeNode(child),child=child.nextSibling;currentIndent--,selfClosing||(canIndent(node)&&node.firstChild&&indent(),outputStringBuilder.push("</",tagName,">"))},handleCdata=function(node){indent(),outputStringBuilder.push("<![CDATA[",escapeEntites(node.nodeValue),"]]>")},handleComment=function(node){indent(),outputStringBuilder.push("<!-- ",escapeEntites(node.nodeValue)," -->")},handleText=function(node){var text=trim(node.nodeValue);text&&(canIndent(node)&&indent(),outputStringBuilder.push(escapeEntites(text)))},indent=function(){var i=currentIndent;for(newline();i--;)outputStringBuilder.push(opts.indentStr)},canIndent=function(node){if(1!==node.nodeType){if(node.previousSibling&&$.sceditor.dom.isInline(node.previousSibling))return!1;node=node.parentNode}return!$.sceditor.dom.isInline(node)},newline=function(){outputStringBuilder.push("\n")}},$.sceditor.plugins.xhtml=function(){var mergeSourceModeCommands,convertTags,convertNode,removetags,mergeAttribsFilters,removeAttribs,base=this,tagConvertersCache={},attrsCache={};base.init=function(){$.isEmptyObject($.sceditor.plugins.xhtml.converters||{})||$.each($.sceditor.plugins.xhtml.converters,function(idx,converter){$.each(converter.tags,function(tagname){tagConvertersCache[tagname]||(tagConvertersCache[tagname]=[]),tagConvertersCache[tagname].push(converter)})}),mergeSourceModeCommands(this)},mergeSourceModeCommands=function(editor){var merge={bold:{txtExec:["<strong>","</strong>"]},italic:{txtExec:["<em>","</em>"]},underline:{txtExec:['<span style="text-decoration: underline;">',"<span>"]},strike:{txtExec:['<span style="text-decoration: line-through;">',"<span>"]},subscript:{txtExec:["<sub>","</sub>"]},superscript:{txtExec:["<sup>","</sup>"]},left:{txtExec:['<div style="text-align: left;">',"<div>"]},center:{txtExec:['<div style="text-align: center;">',"<div>"]},right:{txtExec:['<div style="text-align: right;">',"<div>"]},justify:{txtExec:['<div style="text-align: justify;">',"<div>"]},font:{txtExec:function(caller){var editor=this;$.sceditor.command.get("font")._dropDown(editor,caller,function(fontName){editor.insertText('<span style="font-family: '+fontName+';">',"</span>")})}},size:{txtExec:function(caller){var editor=this;$.sceditor.command.get("size")._dropDown(editor,caller,function(fontSize){editor.insertText('<span style="font-size: '+fontSize+';">',"</span>")})}},color:{txtExec:function(caller){var editor=this;$.sceditor.command.get("color")._dropDown(editor,caller,function(color){editor.insertText('<span style="color: '+color+';">',"</span>")})}},bulletlist:{txtExec:["<ul><li>","</li></ul>"]},orderedlist:{txtExec:["<ol><li>","</li></ol>"]},table:{txtExec:["<table><tr><td>","</td></tr></table>"]},horizontalrule:{txtExec:["<hr />"]},code:{txtExec:["<code>","</code>"]},image:{txtExec:function(caller,selected){var url=prompt(this._("Enter the image URL:"),selected);url&&this.insertText('<img src="'+url+'" />')}},email:{txtExec:function(caller,selected){var display=selected&&selected.indexOf("@")>-1?null:selected,email=prompt(this._("Enter the e-mail address:"),display?"":selected),text=prompt(this._("Enter the displayed text:"),display||email)||email;email&&this.insertText('<a href="mailto:'+email+'">'+text+"</a>")}},link:{txtExec:function(caller,selected){var display=selected&&selected.indexOf("http://")>-1?null:selected,url=prompt(this._("Enter URL:"),display?"http://":selected),text=prompt(this._("Enter the displayed text:"),display||url)||url;url&&this.insertText('<a href="'+url+'">'+text+"</a>")}},quote:{txtExec:["<blockquote>","</blockquote>"]},youtube:{txtExec:function(caller){var editor=this;$.sceditor.command.get("youtube")._dropDown(editor,caller,function(id){editor.insertText('<iframe width="560" height="315" src="http://www.youtube.com/embed/{id}?wmode=opaque" data-youtube-id="'+id+'" frameborder="0" allowfullscreen></iframe>')})}},rtl:{txtExec:['<div stlye="direction: rtl;">',"</div>"]},ltr:{txtExec:['<div stlye="direction: ltr;">',"</div>"]}};editor.commands=$.extend(!0,{},merge,editor.commands)},base.signalToSource=function(html,domBody){return domBody=domBody.jquery?domBody[0]:domBody,$(domBody).find(".sceditor-selection").remove(),convertTags(domBody),removetags(domBody),removeAttribs(domBody),(new $.sceditor.XHTMLSerializer).serialize(domBody,!0)},base.signalToWysiwyg=function(text){return text},base.convertTagTo=function(elm,newtagName){for(var child,attr,i=elm.attributes.length,newTag=elm.ownerDocument.createElement(newtagName);i--;)attr=elm.attributes[i],newTag.setAttribute(attr.name,attr.value);for(;child=elm.firstChild;)newTag.appendChild(child);return elm.parentNode.replaceChild(newTag,elm),newTag},convertNode=function(tagName,$node){tagConvertersCache[tagName]&&$.each(tagConvertersCache[tagName],function(idx,converter){converter.tags[tagName]?$.each(converter.tags[tagName],function(attr,values){void 0!==$node.attr(attr)&&(values&&0>$.inArray($node.attr(attr),values)||converter.conv.call(base,$node[0]))}):converter.conv&&converter.conv.call(base,$node[0])})},convertTags=function(node){tagConvertersCache&&$.sceditor.dom.traverse(node,function(node){var $node=$(node),tagName=node.nodeName.toLowerCase();tagConvertersCache&&(convertNode("*",$node),convertNode(tagName,$node))},!0)},removetags=function(node){$.sceditor.dom.traverse(node,function(node){var tagName=node.nodeName.toLowerCase(),allowedtags=$.sceditor.plugins.xhtml.allowedTags,disallowedTags=$.sceditor.plugins.xhtml.disallowedTags;4===node.nodeType?tagName="!cdata":("!"===tagName||8===node.nodeType)&&(tagName="!comment"),allowedtags&&allowedtags.length&&3!==node.nodeType?0>$.inArray(tagName,allowedtags)&&node.parentNode&&node.parentNode.removeChild(node):disallowedTags&&disallowedTags.length&&3!==node.nodeType&&$.inArray(tagName,disallowedTags)>-1&&node.parentNode&&node.parentNode.removeChild(node)})},mergeAttribsFilters=function(filtersA,filtersB){var ret={};return filtersA&&$.extend(ret,filtersA),filtersB?($.each(filtersB,function(attrName,values){$.isArray(ret[attrName])?$.isArray(values)&&(ret[attrName]=$.merge(ret[attrName],values)):ret[attrName]=values}),ret):ret},removeAttribs=function(node){attrsCache={},$.sceditor.dom.traverse(node,function(node){if(node.attributes){var attr,removeAttr,tagName=node.nodeName.toLowerCase(),allowedAttribs=$.sceditor.plugins.xhtml.allowedAttribs,disallowedAttribs=$.sceditor.plugins.xhtml.disallowedAttribs,attrsLength=node.attributes.length;if(allowedAttribs&&!$.isEmptyObject(allowedAttribs)&&attrsLength)for(attrsCache[tagName]||(attrsCache[tagName]=mergeAttribsFilters(allowedAttribs["*"],allowedAttribs[tagName]));attrsLength--;)attr=node.attributes[attrsLength],removeAttr=attrsCache[tagName][attr.name]===void 0,$.isArray(attrsCache[tagName][attr.name])&&0>$.inArray(attr.value,attrsCache[tagName][attr.name])&&(removeAttr=!0),removeAttr&&node.removeAttribute(attr.name);else if(disallowedAttribs&&!$.isEmptyObject(disallowedAttribs)&&attrsLength)for(attrsCache[tagName]||(attrsCache[tagName]=mergeAttribsFilters(disallowedAttribs["*"],disallowedAttribs[tagName]));attrsLength--;)attr=node.attributes[attrsLength],removeAttr=attrsCache[tagName][attr.name]!==void 0,$.isArray(attrsCache[tagName][attr.name])&&$.inArray(attr.value,attrsCache[tagName][attr.name])>-1&&(removeAttr=!0),removeAttr&&node.removeAttribute(attr.name)}})}},$.sceditor.plugins.xhtml.converters=[{tags:{"*":{width:null}},conv:function(node){var $node=$(node);$node.css("width",$node.attr("width")).removeAttr("width")}},{tags:{"*":{height:null}},conv:function(node){var $node=$(node);$node.css("height",$node.attr("height")).removeAttr("height")}},{tags:{li:{value:null}},conv:function(node){$(node).removeAttr("value")}},{tags:{"*":{text:null}},conv:function(node){var $node=$(node);$node.css("color",$node.attr("text")).removeAttr("text")}},{tags:{"*":{size:null}},conv:function(node){var $node=$(node);$node.css("font-size",$node.css("font-size")).removeAttr("size")}},{tags:{"*":{color:null}},conv:function(node){var $node=$(node);$node.css("color",$node.attr("color")).removeAttr("color")}},{tags:{"*":{face:null}},conv:function(node){var $node=$(node);$node.css("font-family",$node.attr("face")).removeAttr("face")}},{tags:{"*":{language:null}},conv:function(node){var $node=$(node),lang=$node.attr("language");/jscript|javascript|js/i.test(lang)?$node.attr("type","text/javascript"):/vb/i.test(lang)&&$node.attr("type","text/vbscript"),$node.removeAttr("language")}},{tags:{"*":{align:null}},conv:function(node){var $node=$(node);$node.css("text-align",$node.attr("align")).removeAttr("align")}},{tags:{"*":{border:null}},conv:function(node){var $node=$(node);$node.css("border-size",$node.attr("border")).removeAttr("border")}},{tags:{applet:{name:null},img:{name:null},layer:{name:null},map:{name:null},object:{name:null},param:{name:null}},conv:function(node){$(node).removeAttr("name")}},{tags:{hr:{noshade:null}},conv:function(node){var $node=$(node);$node.css("border-style","solid").removeAttr("noshade")}},{tags:{"*":{nowrap:null}},conv:function(node){var $node=$(node);$node.css("white-space","nowrap").removeAttr("nowrap")}},{tags:{big:null},conv:function(node){$(this.convertTagTo(node,"span")).css("font-size","larger")}},{tags:{small:null},conv:function(node){$(this.convertTagTo(node,"span")).css("font-size","smaller")}},{tags:{b:null},conv:function(node){$(this.convertTagTo(node,"strong"))}},{tags:{u:null},conv:function(node){$(this.convertTagTo(node,"span")).css("text-decoration","underline")}},{tags:{i:null},conv:function(node){$(this.convertTagTo(node,"em"))}},{tags:{s:null,strike:null},conv:function(node){$(this.convertTagTo(node,"span")).css("text-decoration","line-through")}},{tags:{dir:null},conv:function(node){this.convertTagTo(node,"ul")}},{tags:{center:null},conv:function(node){$(this.convertTagTo(node,"div")).css("text-align","center")}},{tags:{font:null},conv:function(node){this.convertTagTo(node,"span")}}],$.sceditor.plugins.xhtml.allowedAttribs={},$.sceditor.plugins.xhtml.disallowedAttribs={},$.sceditor.plugins.xhtml.allowedTags=[],$.sceditor.plugins.xhtml.disallowedTags=[]})(jQuery);